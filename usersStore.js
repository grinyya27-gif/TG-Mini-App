const UsersStore=(function(){const KEY='ml_users_store_v1';function read(){try{const s=localStorage.getItem(KEY);if(!s)return{users:{},currentUserId:null};const o=JSON.parse(s);if(!o.users||typeof o.users!=='object')o.users={};return o}catch(e){return{users:{},currentUserId:null}}}function write(state){try{localStorage.setItem(KEY,JSON.stringify(state))}catch(e){}}function clone(d){return JSON.parse(JSON.stringify(d||{}))}function migrateLegacy(state){try{for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k==='medieval_rpg_save_v5'){const cur=JSON.parse(localStorage.getItem(k)||'{}');if(cur){state.users['current_player']=cur}}else if(k&&k.startsWith('player_')){const id=k.replace('player_','');const data=JSON.parse(localStorage.getItem(k)||'{}');if(data){state.users[id]=data}}}}catch(e){}return state}return{init:function(){let s=read();if(Object.keys(s.users).length===0){s=migrateLegacy(s);write(s)}},listUsers:function(){const s=read();return Object.entries(s.users).map(([id,data])=>{const u=clone(data);u.telegramId=id;return u})},getUser:function(id){const s=read();const d=s.users[id];if(!d)return null;return clone(d)},saveUser:function(id,data){const s=read();s.users[id]=clone(data);write(s)},deleteUser:function(id){const s=read();delete s.users[id];if(s.currentUserId===id)s.currentUserId=null;write(s)},setCurrentUser:function(id){const s=read();s.currentUserId=id;write(s)},getCurrentUserId:function(){const s=read();return s.currentUserId||null},getCurrentUserData:function(){const id=this.getCurrentUserId();if(!id)return null;return this.getUser(id)},saveCurrent:function(data){const id=this.getCurrentUserId();if(!id)return;this.saveUser(id,data)}}})();window.UsersStore=UsersStore;
