<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WAR SAGA: REBORN</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò --- */
        :root {
            --bg: #0a0a0a;
            --card-bg: #141414;
            --gold: #ffcc00;
            --text-main: #e0e0e0;
            --text-dim: #888;
            --accent: #b8860b;
            --green: #4caf50;
            --red: #f44336;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- –ó–ê–ì–†–£–ó–ß–ò–ö --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #333;
            border-top: 4px solid var(--gold); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- –®–ê–ü–ö–ê --- */
        header {
            padding: 15px; background: var(--card-bg);
            border-bottom: 1px solid #333; display: flex; flex-direction: column; gap: 10px;
        }
        .stats-row { display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1em; }
        .gold-text { color: var(--gold); }
        
        .xp-container { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .xp-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }

        /* --- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ --- */
        main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }
        .screen { display: none; animation: fade 0.3s; }
        .screen.active { display: block; }
        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }

        /* --- –ö–ê–†–¢–û–ß–ö–ò --- */
        .card {
            background: var(--card-bg); border: 1px solid #333; border-radius: 8px;
            padding: 15px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px;
        }
        .icon { font-size: 2em; min-width: 50px; text-align: center; }
        .info { flex: 1; }
        .info h3 { font-size: 1em; margin-bottom: 4px; }
        .info p { font-size: 0.85em; color: var(--text-dim); }
        
        button.btn {
            background: var(--accent); color: #fff; border: none;
            padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer;
        }
        button.btn:active { transform: scale(0.95); opacity: 0.8; }
        button.btn:disabled { background: #333; color: #555; cursor: not-allowed; }

        /* --- –ù–ê–í–ò–ì–ê–¶–ò–Ø --- */
        nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--card-bg); border-top: 1px solid #333;
            display: flex; justify-content: space-around; padding: 10px 0;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        .nav-item {
            text-align: center; color: var(--text-dim); font-size: 0.75em;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .nav-item.active { color: var(--gold); }
        .nav-icon { font-size: 1.4em; }

        /* --- –ê–ù–ò–ú–ê–¶–ò–ò --- */
        .float-text {
            position: fixed; color: var(--gold); font-weight: bold; font-size: 1.2em;
            pointer-events: none; animation: floatUp 0.8s forwards; z-index: 1000;
        }
        @keyframes floatUp { to { transform: translateY(-50px); opacity: 0; } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∏—Ä–∞...</p>
    </div>

    <header>
        <div class="stats-row">
            <span>ü™ô <span id="ui-gold">0</span></span>
            <span>–£—Ä. <span id="ui-lvl">1</span></span>
        </div>
        <div class="xp-container"><div id="ui-xp" class="xp-bar"></div></div>
        <div style="font-size: 0.8em; color: #666; text-align: center;">
            –°–∏–ª–∞ –∫–ª–∏–∫–∞: <span id="ui-power">1</span> | –î–æ—Ö–æ–¥: <span id="ui-auto">0</span>/—Å–µ–∫
        </div>
    </header>

    <main>
        <section id="tab-battle" class="screen active">
            <h2 style="margin-bottom: 15px; color: var(--gold);">–ó–æ–Ω—ã –æ—Ö–æ—Ç—ã</h2>
            
            <div class="card" onclick="game.click('forest', event)">
                <div class="icon">üå≤</div>
                <div class="info">
                    <h3>–¢–µ–º–Ω—ã–π –õ–µ—Å</h3>
                    <p>–ö–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –∑–æ–ª–æ—Ç–æ</p>
                </div>
            </div>

            <div class="card" onclick="game.click('cave', event)">
                <div class="icon">ü¶á</div>
                <div class="info">
                    <h3>–ü–µ—â–µ—Ä–∞ (–£—Ä. 5)</h3>
                    <p>–ë–æ–ª—å—à–µ –æ–ø—ã—Ç–∞ –∏ –∑–æ–ª–æ—Ç–∞</p>
                </div>
            </div>
        </section>

        <section id="tab-gear" class="screen">
            <h2 style="margin-bottom: 15px; color: var(--gold);">–û—Ä—É–∂–µ–π–Ω–∞—è</h2>
            <div id="gear-list">
                </div>
        </section>

        <section id="tab-shop" class="screen">
            <h2 style="margin-bottom: 15px; color: var(--gold);">–ù–∞–µ–º–Ω–∏–∫–∏</h2>
            <div id="shop-list">
                </div>
        </section>
    </main>

    <nav>
        <div class="nav-item active" onclick="game.switchTab('battle', this)">
            <span class="nav-icon">‚öîÔ∏è</span>
            <span>–ë–∏—Ç–≤–∞</span>
        </div>
        <div class="nav-item" onclick="game.switchTab('gear', this)">
            <span class="nav-icon">üõ°Ô∏è</span>
            <span>–ì–µ—Ä–æ–π</span>
        </div>
        <div class="nav-item" onclick="game.switchTab('shop', this)">
            <span class="nav-icon">üí∞</span>
            <span>–õ–∞–≤–∫–∞</span>
        </div>
    </nav>

    <script>
        // === –ë–ê–ó–ê –î–ê–ù–ù–´–• –ò–ì–†–´ ===
        const DB = {
            gear: [
                { id: 'sword1', name: '–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π –º–µ—á', type: 'weapon', power: 2, price: 50, icon: 'üó°Ô∏è' },
                { id: 'sword2', name: '–ñ–µ–ª–µ–∑–Ω—ã–π –º–µ—á', type: 'weapon', power: 5, price: 250, icon: '‚öîÔ∏è' },
                { id: 'armor1', name: '–ö–æ–∂–∞–Ω–∞—è –±—Ä–æ–Ω—è', type: 'armor', power: 3, price: 500, icon: 'üëï' },
                { id: 'ring1', name: '–ö–æ–ª—å—Ü–æ —Å–∏–ª—ã', type: 'acc', power: 10, price: 1500, icon: 'üíç' },
                { id: 'sword3', name: '–ú–µ—á –ì–µ—Ä–æ—è', type: 'weapon', power: 25, price: 5000, icon: 'üî•' }
            ],
            workers: [
                { id: 'peasant', name: '–ö—Ä–µ—Å—Ç—å—è–Ω–∏–Ω', income: 1, price: 100, icon: 'üë®‚Äçüåæ' },
                { id: 'miner', name: '–®–∞—Ö—Ç–µ—Ä', income: 5, price: 600, icon: '‚õèÔ∏è' },
                { id: 'merchant', name: '–¢–æ—Ä–≥–æ–≤–µ—Ü', income: 15, price: 2000, icon: '‚öñÔ∏è' }
            ]
        };

        // === –î–í–ò–ñ–û–ö –ò–ì–†–´ ===
        const game = {
            state: {
                gold: 0,
                lvl: 1,
                xp: 0,
                xpNeed: 100,
                inventory: [], // –∫—É–ø–ª–µ–Ω–Ω—ã–µ ID –ø—Ä–µ–¥–º–µ—Ç–æ–≤
                workers: {}    // id: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            },

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            init() {
                try {
                    // –ó–∞–≥—Ä—É–∑–∫–∞
                    const saved = localStorage.getItem('WAR_SAGA_V5');
                    if (saved) {
                        this.state = JSON.parse(saved);
                        // –§–∏–∫—Å —Å—Ç–∞—Ä—ã—Ö —Å–µ–π–≤–æ–≤, –µ—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–º–µ–Ω—è–ª–∞—Å—å
                        if (!this.state.workers) this.state.workers = {}; 
                        if (!this.state.inventory) this.state.inventory = [];
                    }

                    // Telegram API
                    if (window.Telegram && window.Telegram.WebApp) {
                        window.Telegram.WebApp.ready();
                        window.Telegram.WebApp.expand();
                    }

                    this.renderShop();
                    this.renderGear();
                    this.updateUI();

                    // –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞ –¥–æ—Ö–æ–¥–∞
                    setInterval(() => this.tick(), 1000);

                    // –£–±–∏—Ä–∞–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫
                    setTimeout(() => {
                        document.getElementById('loader').style.opacity = '0';
                        setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
                    }, 800);

                } catch (e) {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ' + e);
                    document.getElementById('loader').style.display = 'none';
                }
            },

            // –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∏–∫
            click(loc, e) {
                if (loc === 'cave' && this.state.lvl < 5) {
                    this.showFloat(e, "–ù—É–∂–µ–Ω 5 —É—Ä–æ–≤–µ–Ω—å!", "red");
                    return;
                }

                const basePower = 1 + this.getGearPower();
                const gain = loc === 'cave' ? basePower * 2 : basePower;
                const xpGain = loc === 'cave' ? 10 : 5;

                this.state.gold += gain;
                this.addXp(xpGain);
                
                this.showFloat(e, `+${gain}ü™ô`);
                this.updateUI();
                
                // –í–∏–±—Ä–∞—Ü–∏—è
                if (window.Telegram?.WebApp?.HapticFeedback) {
                    window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                }
            },

            // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–ø—ã—Ç–∞
            addXp(amount) {
                this.state.xp += amount;
                if (this.state.xp >= this.state.xpNeed) {
                    this.state.lvl++;
                    this.state.xp -= this.state.xpNeed;
                    this.state.xpNeed = Math.floor(this.state.xpNeed * 1.5);
                    alert(`–£–†–û–í–ï–ù–¨ –ü–û–í–´–®–ï–ù! –¢–µ–ø–µ—Ä—å –≤—ã ${this.state.lvl} —É—Ä–æ–≤–Ω—è.`);
                }
            },

            // –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥
            tick() {
                let income = 0;
                for (let id in this.state.workers) {
                    const count = this.state.workers[id];
                    const worker = DB.workers.find(w => w.id === id);
                    if (worker) income += worker.income * count;
                }

                if (income > 0) {
                    this.state.gold += income;
                    this.updateUI();
                    this.save();
                }
            },

            // –ü–æ–∫—É–ø–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–∞
            buyGear(id) {
                const item = DB.gear.find(i => i.id === id);
                if (this.state.inventory.includes(id)) return;
                
                if (this.state.gold >= item.price) {
                    this.state.gold -= item.price;
                    this.state.inventory.push(id);
                    this.renderGear();
                    this.updateUI();
                    this.save();
                } else {
                    alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∑–æ–ª–æ—Ç–∞!");
                }
            },

            // –ù–∞–π–º —Ä–∞–±–æ—á–µ–≥–æ
            hireWorker(id) {
                const worker = DB.workers.find(w => w.id === id);
                const currentCount = this.state.workers[id] || 0;
                // –¶–µ–Ω–∞ —Ä–∞—Å—Ç–µ—Ç –Ω–∞ 15% –∑–∞ –∫–∞–∂–¥–æ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ
                const cost = Math.floor(worker.price * Math.pow(1.15, currentCount));

                if (this.state.gold >= cost) {
                    this.state.gold -= cost;
                    this.state.workers[id] = currentCount + 1;
                    this.renderShop();
                    this.updateUI();
                    this.save();
                } else {
                    alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∑–æ–ª–æ—Ç–∞!");
                }
            },

            // –†–∞—Å—á–µ—Ç —Å–∏–ª—ã –æ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤
            getGearPower() {
                let p = 0;
                this.state.inventory.forEach(itemId => {
                    const item = DB.gear.find(i => i.id === itemId);
                    if (item) p += item.power;
                });
                return p;
            },

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞ —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è
            renderGear() {
                const container = document.getElementById('gear-list');
                container.innerHTML = DB.gear.map(item => {
                    const owned = this.state.inventory.includes(item.id);
                    return `
                    <div class="card" style="opacity: ${owned ? 0.6 : 1}">
                        <div class="icon">${item.icon}</div>
                        <div class="info">
                            <h3>${item.name}</h3>
                            <p>–°–∏–ª–∞ –∫–ª–∏–∫–∞: +${item.power}</p>
                        </div>
                        <button class="btn" ${owned ? 'disabled' : ''} onclick="game.buyGear('${item.id}')">
                            ${owned ? '–ö–£–ü–õ–ï–ù–û' : item.price + ' ü™ô'}
                        </button>
                    </div>`;
                }).join('');
            },

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞ —Ä–∞–±–æ—á–∏—Ö
            renderShop() {
                const container = document.getElementById('shop-list');
                container.innerHTML = DB.workers.map(w => {
                    const count = this.state.workers[w.id] || 0;
                    const cost = Math.floor(w.price * Math.pow(1.15, count));
                    return `
                    <div class="card">
                        <div class="icon">${w.icon}</div>
                        <div class="info">
                            <h3>${w.name}</h3>
                            <p>–î–æ—Ö–æ–¥: ${w.income}/—Å–µ–∫ (–£ –≤–∞—Å: ${count})</p>
                        </div>
                        <button class="btn" onclick="game.hireWorker('${w.id}')">
                            ${cost} ü™ô
                        </button>
                    </div>`;
                }).join('');
            },

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–∏—Ñ—Ä
            updateUI() {
                document.getElementById('ui-gold').innerText = Math.floor(this.state.gold);
                document.getElementById('ui-lvl').innerText = this.state.lvl;
                
                const pct = (this.state.xp / this.state.xpNeed) * 100;
                document.getElementById('ui-xp').style.width = pct + "%";
                
                document.getElementById('ui-power').innerText = 1 + this.getGearPower();
                
                let income = 0;
                for (let id in this.state.workers) {
                    const w = DB.workers.find(x => x.id === id);
                    if(w) income += w.income * (this.state.workers[id] || 0);
                }
                document.getElementById('ui-auto').innerText = income;
            },

            save() {
                localStorage.setItem('WAR_SAGA_V5', JSON.stringify(this.state));
            },

            switchTab(id, el) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('tab-' + id).classList.add('active');
                
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
            },

            showFloat(e, text, color = null) {
                const el = document.createElement('div');
                el.className = 'float-text';
                el.innerText = text;
                if(color) el.style.color = color;
                
                const x = e.clientX || (e.touches ? e.touches[0].clientX : window.innerWidth / 2);
                const y = e.clientY || (e.touches ? e.touches[0].clientY : window.innerHeight / 2);
                
                el.style.left = x + 'px';
                el.style.top = y + 'px';
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 800);
            }
        };

        // –°–¢–ê–†–¢
        window.onload = () => game.init();
    </script>
</body>
</html>
