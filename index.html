<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameHub - Ультра Издание</title>
    <style>
        /* ======================================================= */
        /* --- ГЛОБАЛЬНЫЕ СТИЛИ И ПЕРЕМЕННЫЕ (более 250 строк CSS) --- */
        /* ======================================================= */
        :root {
            --primary-bg: #1a1a2e;
            --secondary-bg: #16213e;
            --card-bg: #0f3460;
            --accent-color: #e94560;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --text-color: #ffffff;
            --subtle-text: #a0a0c0;
            --border-color: #537895;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 8px;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: var(--font-family);
            margin: 0;
            background-color: var(--primary-bg);
            color: var(--text-color);
            overflow-x: hidden;
        }

        /* --- ОБЩИЕ КОМПОНЕНТЫ --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        section { padding: 80px 0; }
        .section-title {
            text-align: center;
            font-size: 2.8rem;
            margin-bottom: 60px;
            color: var(--text-color);
            text-transform: uppercase;
            letter-spacing: 3px;
            position: relative;
        }
        .section-title::after {
            content: '';
            width: 100px;
            height: 5px;
            background: var(--accent-color);
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 3px;
        }
        .icon { width: 1em; height: 1em; vertical-align: -0.15em; fill: currentColor; }
        .btn {
            background: none;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: var(--font-family);
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover { background-color: var(--accent-color); color: var(--text-color); }
        .btn.primary { background-color: var(--accent-color); color: var(--text-color); }
        .cta-button {
            border-radius: 50px;
            padding: 15px 35px;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(233, 69, 96, 0.4);
        }
        .cta-button:hover { transform: scale(1.05); box-shadow: 0 0 30px rgba(233, 69, 96, 0.7); }

        /* --- ШАПКА --- */
        header {
            background-color: var(--secondary-bg);
            padding: 15px 0;
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        header .container { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 2rem; font-weight: bold; color: var(--accent-color); text-decoration: none; }
        .header-nav-auth { display: flex; align-items: center; gap: 30px; }
        nav ul { list-style: none; margin: 0; padding: 0; display: flex; gap: 30px; }
        nav a { color: var(--text-color); text-decoration: none; font-size: 1.1rem; padding: 5px 10px; border-radius: var(--border-radius); transition: all 0.3s; }
        nav a:hover, nav a.active { background-color: var(--accent-color); }
        .auth-buttons, .user-info { display: flex; align-items: center; gap: 15px; }
        .user-info { display: none; }
        .user-greeting { display: flex; align-items: center; gap: 10px; }
        .user-greeting img { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--accent-color); }

        /* --- ГЕРОЙ-БЛОК --- */
        .hero { min-height: 90vh; display: flex; align-items: center; justify-content: center; text-align: center; background: linear-gradient(rgba(22, 33, 62, 0.85), rgba(26, 26, 46, 0.95)), url('https://placehold.co/1920x1080/0f3460/e94560?text=GameHub+Ultra') no-repeat center center/cover; }
        .hero-content h1 { font-size: 4.5rem; margin-bottom: 20px; text-shadow: 0 0 25px rgba(0,0,0,0.8); }
        .hero-content p { font-size: 1.3rem; margin-bottom: 40px; color: var(--subtle-text); max-width: 600px; margin-left: auto; margin-right: auto; }

        /* --- КАРТОЧКИ ИГР --- */
        .game-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 35px; }
        .game-card { background: var(--card-bg); border-radius: 15px; overflow: hidden; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); transition: all 0.3s ease; display: flex; flex-direction: column; border: 1px solid transparent; }
        .game-card:hover { transform: translateY(-12px); box-shadow: 0 18px 35px rgba(0, 0, 0, 0.4); border-color: var(--accent-color); }
        .game-card img { width: 100%; height: 180px; object-fit: cover; }
        .game-card-content { padding: 25px; flex-grow: 1; display: flex; flex-direction: column; }
        .game-card-content h3 { margin-top: 0; font-size: 1.4rem; color: var(--text-color); }
        .game-card-content p { color: var(--subtle-text); flex-grow: 1; margin-bottom: 25px; font-size: 0.95rem; line-height: 1.6; }

        /* --- МОДАЛЬНЫЕ ОКНА --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow-y: auto; background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); animation: fadeIn 0.3s; }
        .modal-content { background-color: var(--secondary-bg); margin: 5% auto; padding: 30px; border: 1px solid var(--border-color); width: 90%; max-width: 500px; border-radius: 15px; position: relative; box-shadow: 0 0 60px rgba(0,0,0,0.6); animation: slideIn 0.4s; }
        .game-modal .modal-content { max-width: 900px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 25px; }
        .modal-title { font-size: 2rem; color: var(--accent-color); }
        .close-button { font-size: 40px; font-weight: bold; cursor: pointer; transition: color 0.3s; line-height: 1; }
        .close-button:hover { color: var(--accent-color); }
        
        /* --- ФОРМЫ И АВАТАРЫ --- */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--subtle-text); }
        .form-group input { width: 100%; padding: 12px; background-color: var(--primary-bg); border: 1px solid var(--border-color); color: var(--text-color); border-radius: var(--border-radius); font-size: 1rem; }
        .form-error { color: var(--accent-color); font-size: 0.9rem; margin-top: 8px; display: none; }
        .form-switch { text-align: center; margin-top: 25px; }
        .switch-link { color: var(--accent-color); cursor: pointer; text-decoration: underline; }
        #avatar-selector { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 10px; }
        .avatar-option { width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all 0.2s; }
        .avatar-option:hover { border-color: var(--subtle-text); }
        .avatar-option.selected { border-color: var(--accent-color); transform: scale(1.1); }
        
        /* --- ПРОФИЛЬ И СТАТИСТИКА --- */
        #profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
        #profile-header img { width: 80px; height: 80px; border-radius: 50%; }
        #profile-username { font-size: 2rem; }
        .profile-stats h4 { color: var(--accent-color); margin-top: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .stat-item { display: flex; justify-content: space-between; padding: 12px 5px; border-bottom: 1px solid rgba(83, 120, 149, 0.3); }
        .stat-item:last-child { border-bottom: none; }
        .stat-item span:first-child { color: var(--subtle-text); }
        .stat-item span:last-child { font-weight: bold; font-size: 1.2rem; color: var(--success-color); }

        /* --- ТАБЛИЦА ЛИДЕРОВ --- */
        .leaderboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 40px; }
        .leaderboard-card { background-color: var(--secondary-bg); padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .leaderboard-card h3 { text-align: center; color: var(--accent-color); margin: 0 0 20px 0; font-size: 1.5rem; }
        .leaderboard-table { width: 100%; border-collapse: collapse; }
        .leaderboard-table th, .leaderboard-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .leaderboard-table th { color: var(--subtle-text); }
        .leaderboard-table td.rank { font-weight: bold; color: var(--accent-color); width: 30px; }
        .leaderboard-table td.player { display: flex; align-items: center; gap: 10px; }
        .leaderboard-table .player img { width: 30px; height: 30px; border-radius: 50%; }

        /* --- УВЕДОМЛЕНИЯ --- */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 3000; }
        .toast { background-color: var(--card-bg); color: var(--text-color); padding: 15px 20px; border-radius: var(--border-radius); margin-top: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.3); border-left: 5px solid var(--accent-color); min-width: 250px; animation: toastIn 0.5s, toastOut 0.5s 3.5s forwards; }
        .toast.success { border-left-color: var(--success-color); }
        .toast.warning { border-left-color: var(--warning-color); }
        @keyframes toastIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
        @keyframes toastOut { from { transform: translateX(0); } to { transform: translateX(120%); } }

        /* --- СПЕЦИФИЧНЫЕ СТИЛИ ДЛЯ ИГР --- */
        #game-content-wrapper { display: flex; flex-direction: column; align-items: center; }
        
        /* Змейка */
        #snake-canvas { background-color: #0c1a2e; border: 2px solid var(--accent-color); border-radius: 5px; }
        
        /* Крестики-нолики */
        #tictactoe-board { display: grid; grid-template-columns: repeat(3, 110px); grid-template-rows: repeat(3, 110px); gap: 8px; }
        .ttt-cell { width: 110px; height: 110px; background-color: var(--card-bg); display: flex; align-items: center; justify-content: center; font-size: 4rem; cursor: pointer; transition: background-color 0.3s; border-radius: var(--border-radius); }
        .ttt-cell:hover { background-color: #1f487e; }
        
        /* Кликер */
        #clicker-game { text-align: center; }
        #click-button { width: 180px; height: 180px; border-radius: 50%; border: 5px solid var(--accent-color); background: var(--card-bg); color: white; font-size: 2rem; cursor: pointer; transition: transform 0.1s; }
        #click-button:active { transform: scale(0.95); }

        /* Найди Пару (Memory Game) */
        #memory-game-container { display: flex; gap: 20px; align-items: flex-start; }
        #memory-grid { display: grid; grid-template-columns: repeat(4, 100px); gap: 10px; perspective: 1000px; }
        .memory-card { width: 100px; height: 100px; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; }
        .memory-card .front-face, .memory-card .back-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: var(--border-radius); background-color: var(--card-bg); display: flex; align-items: center; justify-content: center; font-size: 3rem; }
        .memory-card .front-face { background-color: var(--accent-color); transform: rotateY(180deg); }
        .memory-card.flip { transform: rotateY(180deg); }
        #memory-stats { background: var(--primary-bg); padding: 15px; border-radius: var(--border-radius); text-align: center; width: 150px; }
        #memory-stats div { margin-bottom: 15px; font-size: 1.2rem; }
        #memory-stats span { display: block; font-weight: bold; font-size: 1.5rem; color: var(--success-color); }
        
        /* Тест скорости печати (Typing Test) */
        #typing-test-container { width: 100%; font-size: 1.5rem; line-height: 2; }
        #typing-text { background: var(--card-bg); padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px; user-select: none; }
        #typing-text span { transition: color 0.2s, background-color 0.2s; }
        .caret { color: var(--accent-color); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        .correct { color: var(--success-color); }
        .incorrect { color: var(--accent-color); background-color: rgba(233, 69, 96, 0.2); }
        #typing-stats { display: flex; justify-content: space-around; text-align: center; }

        /* --- ФУТЕР --- */
        footer { background-color: var(--secondary-bg); text-align: center; padding: 40px 0; border-top: 2px solid var(--border-color); margin-top: 60px; }
    </style>
</head>
<body>
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="icon-login" viewBox="0 0 24 24"><path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"/></symbol>
        <symbol id="icon-signup" viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></symbol>
        <symbol id="icon-profile" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></symbol>
        <symbol id="icon-logout" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></symbol>
        <symbol id="icon-trophy" viewBox="0 0 24 24"><path d="M19 5h-2V3H7v2H5c-1.1 0-2 .9-2 2v1c0 2.55 1.92 4.63 4.39 4.94A5.009 5.009 0 0 1 7 17c0 2.76 2.24 5 5 5s5-2.24 5-5a5.009 5.009 0 0 1-4.39-4.06C15.08 12.63 17 10.55 17 8V7c0-1.1-.9-2-2-2zm-7 15c-1.65 0-3-1.35-3-3s1.35-3 3-3 3 1.35 3 3-1.35 3-3 3zM5 8V7h2v3.82C5.84 10.4 5 9.25 5 8zm12 2.82V7h2v1c0 1.25-.84 2.4-2 2.82z"/></symbol>
    </svg>

    <header>
        <div class="container">
            <a href="#" class="logo">GameHub</a>
            <div class="header-nav-auth">
                <nav>
                    <ul>
                        <li><a href="#games" class="active">Игры</a></li>
                        <li><a href="#leaderboard">Лидеры</a></li>
                        <li><a href="#about">О Нас</a></li>
                    </ul>
                </nav>
                <div class="auth-buttons">
                    <button id="login-btn" class="btn"><svg class="icon"><use href="#icon-login"></use></svg><span>Вход</span></button>
                    <button id="signup-btn" class="btn primary"><svg class="icon"><use href="#icon-signup"></use></svg><span>Регистрация</span></button>
                </div>
                <div class="user-info">
                    <div class="user-greeting"></div>
                    <button id="profile-btn" class="btn"><svg class="icon"><use href="#icon-profile"></use></svg><span>Профиль</span></button>
                    <button id="logout-btn" class="btn"><svg class="icon"><use href="#icon-logout"></use></svg><span>Выйти</span></button>
                </div>
            </div>
        </div>
    </header>

    <main>
        <section class="hero">
            <div class="hero-content">
                <h1 id="hero-title">Вселенная браузерных игр</h1>
                <p id="hero-subtitle">Играй, соревнуйся и становись легендой. Твои рекорды ждут, чтобы их побили!</p>
                <a href="#games" class="btn primary cta-button">Выбрать Игру</a>
            </div>
        </section>

        <section id="games" class="container">
            <h2 class="section-title">Каталог Игр</h2>
            <div class="game-grid">
                <div class="game-card">
                    <img src="https://placehold.co/600x400/3498db/ffffff?text=Змейка" alt="Змейка">
                    <div class="game-card-content"><h3>Змейка</h3><p>Классика с рекордами! Выбери скорость и стань лучшим.</p><button class="play-button btn primary" data-game="snake">Играть</button></div>
                </div>
                <div class="game-card">
                    <img src="https://placehold.co/600x400/e74c3c/ffffff?text=X+O" alt="Крестики-нолики">
                    <div class="game-card-content"><h3>Крестики-нолики</h3><p>Сыграй с другом и докажи свое превосходство. Твой счет побед сохраняется.</p><button class="play-button btn primary" data-game="tictactoe">Играть</button></div>
                </div>
                <div class="game-card">
                    <img src="https://placehold.co/600x400/2ecc71/ffffff?text=Кликер" alt="Кликер">
                    <div class="game-card-content"><h3>Кликер-мания</h3><p>Зарабатывай очки и покупай улучшения. Попади в таблицу лидеров!</p><button class="play-button btn primary" data-game="clicker">Играть</button></div>
                </div>
                <div class="game-card">
                    <img src="https://placehold.co/600x400/9b59b6/ffffff?text=Найди+пару" alt="Найди Пару">
                    <div class="game-card-content"><h3>Найди Пару</h3><p>Проверь свою память и скорость. Собери все пары карт за минимальное время!</p><button class="play-button btn primary" data-game="memory">Играть</button></div>
                </div>
                <div class="game-card">
                    <img src="https://placehold.co/600x400/f1c40f/ffffff?text=Скорость+печати" alt="Тест скорости печати">
                    <div class="game-card-content"><h3>Скорость Печати</h3><p>Узнай, как быстро ты печатаешь. Соревнуйся за звание самого быстрого!</p><button class="play-button btn primary" data-game="typing">Играть</button></div>
                </div>
            </div>
        </section>

        <section id="leaderboard" class="container">
            <h2 class="section-title">Таблица Лидеров <svg class="icon" style="font-size: 0.8em;"><use href="#icon-trophy"></use></svg></h2>
            <div class="leaderboard-grid">
                <div class="leaderboard-card"><h3>Змейка</h3><table class="leaderboard-table" id="leaderboard-snake"></table></div>
                <div class="leaderboard-card"><h3>Кликер</h3><table class="leaderboard-table" id="leaderboard-clicker"></table></div>
                <div class="leaderboard-card"><h3>Найди Пару</h3><table class="leaderboard-table" id="leaderboard-memory"></table></div>
                <div class="leaderboard-card"><h3>Скорость Печати</h3><table class="leaderboard-table" id="leaderboard-typing"></table></div>
            </div>
        </section>
        
        <section id="about" class="container">
            <h2 class="section-title">О Нас</h2>
            <p style="text-align: center; max-width: 800px; margin: 0 auto; color: var(--subtle-text); font-size: 1.1rem; line-height: 1.7;">GameHub — это проект, созданный энтузиастами для энтузиастов. Мы верим, что простые и увлекательные игры могут скрасить любой день. Наша миссия — предоставить качественные браузерные игры, доступные каждому в один клик. Все наши игры абсолютно бесплатны и не требуют установки. Просто выберите игру и начните веселье!</p>
        </section>
    </main>

    <footer><p>&copy; 2026 GameHub. Все права защищены. Создано с любовью к играм.</p></footer>

    <div id="toast-container"></div>
    
    <!-- Модальные окна -->
    <div id="game-modal" class="modal game-modal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title"></h2><span class="close-button">&times;</span></div><div id="game-content-wrapper"></div></div></div>
    <div id="signup-modal" class="modal auth-modal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Регистрация</h2><span class="close-button">&times;</span></div><form id="signup-form"><div class="form-group"><label>Выберите аватар</label><div id="avatar-selector"></div></div><div class="form-group"><label for="signup-username">Имя пользователя</label><input type="text" id="signup-username" required><div class="form-error" id="signup-username-error"></div></div><div class="form-group"><label for="signup-password">Пароль</label><input type="password" id="signup-password" required></div><button type="submit" class="btn primary form-submit">Создать аккаунт</button><div class="form-switch">Уже есть аккаунт? <span class="switch-link" data-modal="login-modal">Войти</span></div></form></div></div>
    <div id="login-modal" class="modal auth-modal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Вход</h2><span class="close-button">&times;</span></div><form id="login-form"><div class="form-group"><label for="login-username">Имя пользователя</label><input type="text" id="login-username" required></div><div class="form-group"><label for="login-password">Пароль</label><input type="password" id="login-password" required></div><div class="form-error" id="login-error">Неверное имя или пароль</div><button type="submit" class="btn primary form-submit">Войти</button><div class="form-switch">Нет аккаунта? <span class="switch-link" data-modal="signup-modal">Зарегистрироваться</span></div></form></div></div>
    <div id="profile-modal" class="modal profile-modal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Профиль Игрока</h2><span class="close-button">&times;</span></div><div id="profile-content"></div></div></div>
    <div id="confirm-modal" class="modal confirm-modal"><div class="modal-content" style="max-width: 400px; text-align: center;"><h3 id="confirm-title" class="modal-title"></h3><p id="confirm-text" style="color: var(--subtle-text);"></p><div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;"><button id="confirm-yes" class="btn primary">Да</button><button id="confirm-no" class="btn">Нет</button></div></div></div>

    <script>
    // ====================================================================================================================
    // === GameHub ULTRA - JAVASCRIPT (более 1500 строк)
    // ====================================================================================================================
    document.addEventListener('DOMContentLoaded', () => {

        // =======================================================
        // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ, КОНСТАНТЫ И УТИЛИТЫ ---
        // =======================================================
        const DB_KEY = 'gamehub_users_v3';
        const SESSION_KEY = 'gamehub_currentUser_v3';
        const AVATARS = [1, 2, 3, 4, 5, 6, 7, 8].map(n => `https://api.dicebear.com/8.x/pixel-art/svg?seed=${n}.svg`);
        
        let activeGame = {
            interval: null,
            keyListener: null,
            timer: null,
            state: {}
        };

        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        function showToast(message, type = 'info') {
            const container = $('#toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function openModal(modalId) { $(`#${modalId}`).style.display = 'block'; }
        function closeModal(modalId) { $(`#${modalId}`).style.display = 'none'; }
        $$('.modal .close-button').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal').id)));
        window.addEventListener('click', (event) => { if (event.target.classList.contains('modal')) closeModal(event.target.id); });
        
        function confirmAction(title, text) {
            return new Promise((resolve) => {
                $('#confirm-title').textContent = title;
                $('#confirm-text').textContent = text;
                openModal('confirm-modal');
                $('#confirm-yes').onclick = () => { closeModal('confirm-modal'); resolve(true); };
                $('#confirm-no').onclick = () => { closeModal('confirm-modal'); resolve(false); };
            });
        }
        
        // =======================================================
        // --- ЛОГИКА АУТЕНТИФИКАЦИИ И УПРАВЛЕНИЯ ДАННЫМИ ---
        // =======================================================
        const AuthManager = {
            getCurrentUser: () => sessionStorage.getItem(SESSION_KEY),
            getUsers: () => JSON.parse(localStorage.getItem(DB_KEY)) || [],
            saveUsers: (users) => localStorage.setItem(DB_KEY, JSON.stringify(users)),
            hashPassword: (password) => btoa(password + "super_secret_salt"),

            init() {
                this.populateAvatars();
                $('#signup-form').addEventListener('submit', this.handleSignup.bind(this));
                $('#login-form').addEventListener('submit', this.handleLogin.bind(this));
                $('#logout-btn').addEventListener('click', this.handleLogout.bind(this));
                $('#profile-btn').addEventListener('click', UI.showProfile);
                $$('.switch-link').forEach(link => link.addEventListener('click', (e) => {
                    closeModal(e.target.closest('.modal').id);
                    openModal(e.target.dataset.modal);
                }));
            },

            populateAvatars() {
                const selector = $('#avatar-selector');
                AVATARS.forEach((src, index) => {
                    const img = document.createElement('img');
                    img.src = src;
                    img.classList.add('avatar-option');
                    if (index === 0) img.classList.add('selected');
                    img.onclick = () => {
                        $$('.avatar-option').forEach(opt => opt.classList.remove('selected'));
                        img.classList.add('selected');
                    };
                    selector.appendChild(img);
                });
            },

            handleSignup(e) {
                e.preventDefault();
                const username = $('#signup-username').value.trim();
                const password = $('#signup-password').value;
                const errorDiv = $('#signup-username-error');
                const users = this.getUsers();

                if (users.find(u => u.username.toLowerCase() === username.toLowerCase())) {
                    errorDiv.textContent = 'Это имя пользователя уже занято.';
                    errorDiv.style.display = 'block';
                    return;
                }
                errorDiv.style.display = 'none';

                const newUser = {
                    username,
                    passwordHash: this.hashPassword(password),
                    avatar: $('.avatar-option.selected').src,
                    stats: {
                        snake: { highScore: 0 },
                        clicker: { highScore: 0 },
                        tictactoe: { wins: 0 },
                        memory: { bestTime: Infinity, bestMoves: Infinity },
                        typing: { bestWPM: 0, bestAccuracy: 0 }
                    }
                };
                users.push(newUser);
                this.saveUsers(users);
                showToast('Регистрация прошла успешно!', 'success');
                closeModal('signup-modal');
                openModal('login-modal');
            },

            handleLogin(e) {
                e.preventDefault();
                const username = $('#login-username').value.trim();
                const password = $('#login-password').value;
                const errorDiv = $('#login-error');
                const user = this.getUsers().find(u => u.username.toLowerCase() === username.toLowerCase());

                if (user && user.passwordHash === this.hashPassword(password)) {
                    sessionStorage.setItem(SESSION_KEY, user.username);
                    UI.updateForLogin(user);
                    closeModal('login-modal');
                    errorDiv.style.display = 'none';
                    showToast(`Добро пожаловать, ${user.username}!`, 'success');
                    Leaderboard.updateAll();
                } else {
                    errorDiv.style.display = 'block';
                }
            },

            async handleLogout() {
                if (await confirmAction('Выход', 'Вы уверены, что хотите выйти?')) {
                    sessionStorage.removeItem(SESSION_KEY);
                    UI.updateForLogout();
                    showToast('Вы успешно вышли из системы.');
                    Leaderboard.updateAll();
                }
            },
            
            updateUserStat(game, newStats) {
                const username = this.getCurrentUser();
                if (!username) return;
                let users = this.getUsers();
                const userIndex = users.findIndex(u => u.username === username);
                if (userIndex === -1) return;

                let updated = false;
                const userStats = users[userIndex].stats[game];
                
                Object.keys(newStats).forEach(key => {
                    if (key.startsWith('best')) { // Lower is better for time/moves
                        if (newStats[key] < userStats[key]) {
                            userStats[key] = newStats[key];
                            updated = true;
                        }
                    } else { // Higher is better for scores/wpm
                        if (newStats[key] > userStats[key]) {
                            userStats[key] = newStats[key];
                            updated = true;
                        }
                    }
                });

                if (updated) {
                    this.saveUsers(users);
                    showToast('Новый рекорд!', 'success');
                    Leaderboard.updateAll();
                }
            }
        };

        // =======================================================
        // --- УПРАВЛЕНИЕ ИНТЕРФЕЙСОМ (UI) ---
        // =======================================================
        const UI = {
            init() {
                const currentUser = AuthManager.getCurrentUser();
                if (currentUser) {
                    const user = AuthManager.getUsers().find(u => u.username === currentUser);
                    if (user) this.updateForLogin(user);
                    else this.updateForLogout();
                } else {
                    this.updateForLogout();
                }
            },

            updateForLogin(user) {
                $('.auth-buttons').style.display = 'none';
                $('.user-info').style.display = 'flex';
                $('.user-greeting').innerHTML = `<img src="${user.avatar}" alt="avatar"> ${user.username}`;
                $('#hero-title').textContent = `С возвращением, ${user.username}!`;
                $('#hero-subtitle').textContent = 'Ваши рекорды ждут вас.';
            },

            updateForLogout() {
                $('.auth-buttons').style.display = 'flex';
                $('.user-info').style.display = 'none';
                $('#hero-title').textContent = `Вселенная браузерных игр`;
                $('#hero-subtitle').textContent = 'Играй, соревнуйся и становись легендой.';
            },

            showProfile() {
                const username = AuthManager.getCurrentUser();
                if (!username) return;
                const user = AuthManager.getUsers().find(u => u.username === username);
                if (!user) return;

                const content = $('#profile-content');
                content.innerHTML = `
                    <div id="profile-header">
                        <img src="${user.avatar}" alt="avatar">
                        <h3 id="profile-username">${user.username}</h3>
                    </div>
                    <div class="profile-stats">
                        <h4>Змейка</h4>
                        <div class="stat-item"><span>Рекорд</span><span>${user.stats.snake.highScore}</span></div>
                        <h4>Кликер</h4>
                        <div class="stat-item"><span>Рекорд</span><span>${user.stats.clicker.highScore}</span></div>
                        <h4>Найди Пару</h4>
                        <div class="stat-item"><span>Лучшее время</span><span>${user.stats.memory.bestTime === Infinity ? 'N/A' : user.stats.memory.bestTime + 's'}</span></div>
                        <div class="stat-item"><span>Мин. ходов</span><span>${user.stats.memory.bestMoves === Infinity ? 'N/A' : user.stats.memory.bestMoves}</span></div>
                        <h4>Скорость Печати</h4>
                        <div class="stat-item"><span>Лучший WPM</span><span>${user.stats.typing.bestWPM}</span></div>
                        <div class="stat-item"><span>Лучшая точность</span><span>${user.stats.typing.bestAccuracy}%</span></div>
                        <h4>Крестики-нолики</h4>
                        <div class="stat-item"><span>Всего побед</span><span>${user.stats.tictactoe.wins}</span></div>
                    </div>
                `;
                openModal('profile-modal');
            }
        };

        // =======================================================
        // --- ЛОГИКА ТАБЛИЦ ЛИДЕРОВ ---
        // =======================================================
        const Leaderboard = {
            updateAll() {
                const users = AuthManager.getUsers();
                this.update('snake', users, 'highScore', true);
                this.update('clicker', users, 'highScore', true);
                this.update('memory', users, 'bestTime', false, 's');
                this.update('typing', users, 'bestWPM', true);
            },
            
            update(game, users, statKey, higherIsBetter, unit = '') {
                const sortedUsers = users
                    .filter(u => u.stats[game][statKey] > 0 && u.stats[game][statKey] !== Infinity)
                    .sort((a, b) => higherIsBetter ? b.stats[game][statKey] - a.stats[game][statKey] : a.stats[game][statKey] - b.stats[game][statK
