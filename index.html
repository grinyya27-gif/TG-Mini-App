<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameHub - Ваш портал в мир игр</title>
    <style>
        /* --- ГЛОБАЛЬНЫЕ СТИЛИ И ПЕРЕМЕННЫЕ --- */
        :root {
            --primary-bg: #1a1a2e;
            --secondary-bg: #16213e;
            --card-bg: #0f3460;
            --accent-color: #e94560;
            --success-color: #2ecc71;
            --text-color: #ffffff;
            --subtle-text: #a0a0c0;
            --border-color: #537895;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            background-color: var(--primary-bg);
            color: var(--text-color);
            overflow-x: hidden;
        }

        /* --- КОНТЕЙНЕРЫ И СЕКЦИИ --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        section {
            padding: 60px 0;
        }

        .section-title {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 50px;
            color: var(--text-color);
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
        }

        .section-title::after {
            content: '';
            width: 80px;
            height: 4px;
            background: var(--accent-color);
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 2px;
        }

        /* --- ШАПКА САЙТА (HEADER) --- */
        header {
            background-color: var(--secondary-bg);
            padding: 15px 0;
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--accent-color);
            text-decoration: none;
        }

        .header-nav-auth {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 25px;
        }

        nav a {
            color: var(--text-color);
            text-decoration: none;
            font-size: 1rem;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
        }

        nav a:hover, nav a.active {
            background-color: var(--accent-color);
            color: var(--text-color);
        }
        
        .auth-buttons, .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auth-buttons button, .user-info button {
            background: none;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            font-family: var(--font-family);
            font-size: 0.9rem;
        }
        .auth-buttons button:hover, .user-info button:hover {
            background-color: var(--accent-color);
            color: var(--text-color);
        }
        .auth-buttons button.primary, .user-info button.primary {
            background-color: var(--accent-color);
            color: var(--text-color);
        }
        .user-info {
            display: none; /* Initially hidden */
        }
        .user-info-greeting {
            font-size: 0.9rem;
        }

        /* --- ГЕРОЙ-БЛОК (HERO) --- */
        .hero {
            height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            background: linear-gradient(rgba(22, 33, 62, 0.8), rgba(26, 26, 46, 0.9)), url('https://placehold.co/1920x1080/0f3460/e94560?text=GameHub+BG') no-repeat center center/cover;
        }

        .hero-content h1 {
            font-size: 4rem;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(0,0,0,0.7);
        }
        .hero-content p {
            font-size: 1.2rem;
            margin-bottom: 30px;
            color: var(--subtle-text);
        }
        .cta-button {
            background-color: var(--accent-color);
            color: var(--text-color);
            padding: 15px 30px;
            font-size: 1.1rem;
            text-decoration: none;
            border-radius: 50px;
            transition: transform 0.3s, box-shadow 0.3s;
            font-weight: bold;
        }
        .cta-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px var(--accent-color);
        }
        
        /* --- СЕТКА ИГР (GAME GRID) --- */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }
        .game-card {
            background: var(--card-bg);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            flex-direction: column;
        }
        .game-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }
        .game-card img { width: 100%; height: 200px; object-fit: cover; }
        .game-card-content { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .game-card-content h3 { margin-top: 0; color: var(--text-color); }
        .game-card-content p { color: var(--subtle-text); flex-grow: 1; margin-bottom: 20px; }
        .play-button {
            background-color: var(--accent-color);
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .play-button:hover { background-color: #d43d51; }
        
        /* --- МОДАЛЬНЫЕ ОКНА --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .modal-content {
            background-color: var(--secondary-bg);
            margin: 5% auto;
            padding: 25px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 800px;
            border-radius: 15px;
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            animation: slideIn 0.4s;
        }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .auth-modal .modal-content, .profile-modal .modal-content { max-width: 450px; }
        .game-modal .modal-content { max-width: fit-content; }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .modal-title { font-size: 1.8rem; color: var(--accent-color); }
        .close-button { color: var(--subtle-text); font-size: 35px; font-weight: bold; cursor: pointer; transition: color 0.3s; }
        .close-button:hover, .close-button:focus { color: var(--text-color); }
        
        /* --- СТИЛИ ФОРМ, ПРОФИЛЯ, НАСТРОЕК --- */
        .auth-form .form-group { margin-bottom: 15px; }
        .auth-form label { display: block; margin-bottom: 5px; color: var(--subtle-text); }
        .auth-form input { width: 100%; padding: 10px; background-color: var(--primary-bg); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 5px; box-sizing: border-box; }
        .auth-form .form-submit { width: 100%; padding: 12px; font-size: 1rem; font-weight: bold; background-color: var(--accent-color); color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; transition: background-color 0.3s; }
        .auth-form .form-submit:hover { background-color: #d43d51; }
        .auth-form .form-error { color: var(--accent-color); font-size: 0.9rem; margin-top: 5px; display: none; }
        .form-switch { text-align: center; margin-top: 20px; font-size: 0.9rem; }
        .form-switch .switch-link { color: var(--accent-color); cursor: pointer; text-decoration: underline; }

        .profile-stats .stat-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .profile-stats .stat-item:last-child { border-bottom: none; }
        .profile-stats .stat-item span:first-child { color: var(--subtle-text); }
        .profile-stats .stat-item span:last-child { font-weight: bold; font-size: 1.1rem; color: var(--success-color); }

        .game-settings { margin-bottom: 20px; text-align: center; }
        .game-settings label { margin: 0 10px; }

        /* --- СТИЛИ ИГР --- */
        #game-content-wrapper { display: flex; flex-direction: column; align-items: center; }
        #snake-canvas { background-color: #0c1a2e; border: 2px solid var(--accent-color); border-radius: 5px; }
        #snake-score { font-size: 1.5rem; margin-top: 10px; }
        #tictactoe-board { display: grid; grid-template-columns: repeat(3, 100px); grid-template-rows: repeat(3, 100px); gap: 5px; }
        .ttt-cell { width: 100px; height: 100px; background-color: var(--card-bg); display: flex; align-items: center; justify-content: center; font-size: 3rem; cursor: pointer; transition: background-color 0.3s; }
        .ttt-cell:hover { background-color: #1f487e; }
        #ttt-status { margin-top: 20px; font-size: 1.5rem; }
        #clicker-game { text-align: center; }
        #clicker-score { font-size: 4rem; margin-bottom: 20px; }
        #click-button { width: 150px; height: 150px; border-radius: 50%; border: 5px solid var(--accent-color); background: var(--card-bg); color: white; font-size: 1.5rem; cursor: pointer; transition: transform 0.1s; }
        #click-button:active { transform: scale(0.95); }
        #upgrade-button { margin-top: 20px; padding: 10px 20px; font-size: 1rem; background-color: #1abc9c; border: none; color: white; border-radius: 5px; cursor: pointer; }

        /* --- ТАБЛИЦА ЛИДЕРОВ --- */
        .leaderboard-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }
        .leaderboard-card {
            background-color: var(--secondary-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .leaderboard-card h3 { text-align: center; color: var(--accent-color); margin-top: 0; }
        .leaderboard-table { width: 100%; border-collapse: collapse; }
        .leaderboard-table th, .leaderboard-table td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .leaderboard-table th { color: var(--subtle-text); }
        .leaderboard-table td.rank { font-weight: bold; color: var(--accent-color); }
        .leaderboard-table tr:last-child td { border-bottom: none; }

        /* --- УВЕДОМЛЕНИЯ (ТОСТЫ) --- */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 3000;
        }
        .toast {
            background-color: var(--card-bg);
            color: var(--text-color);
            padding: 15px 20px;
            border-radius: 5px;
            margin-top: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            border-left: 5px solid var(--accent-color);
            animation: toastIn 0.5s, toastOut 0.5s 2.5s forwards;
        }
        .toast.success { border-left-color: var(--success-color); }
        @keyframes toastIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toastOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }

        /* --- ФУТЕР --- */
        footer { background-color: var(--secondary-bg); text-align: center; padding: 30px 0; border-top: 2px solid var(--border-color); margin-top: 60px; }
        
        /* --- АДАПТИВНОСТЬ --- */
        @media (max-width: 992px) {
            .leaderboard-container { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .hero-content h1 { font-size: 3rem; }
            nav ul { display: none; }
            .header-nav-auth { gap: 10px; }
            .modal-content { width: 95%; margin: 10% auto; }
            #tictactoe-board { grid-template-columns: repeat(3, 80px); grid-template-rows: repeat(3, 80px); }
            .ttt-cell { width: 80px; height: 80px; font-size: 2.5rem; }
        }
        @media (max-width: 480px) {
            .hero-content h1 { font-size: 2.5rem; }
            .section-title { font-size: 2rem; }
        }
    </style>
</head>
<body>

    <!-- Шапка сайта -->
    <header>
        <div class="container">
            <a href="#" class="logo">GameHub</a>
            <div class="header-nav-auth">
                <nav>
                    <ul>
                        <li><a href="#games" class="active">Игры</a></li>
                        <li><a href="#leaderboard">Лидеры</a></li>
                        <li><a href="#about">О нас</a></li>
                    </ul>
                </nav>
                <div class="auth-buttons">
                    <button id="login-btn">Вход</button>
                    <button id="signup-btn" class="primary">Регистрация</button>
                </div>
                <div class="user-info">
                    <span class="user-info-greeting"></span>
                    <button id="profile-btn">Профиль</button>
                    <button id="logout-btn">Выйти</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Основной контент -->
    <main>
        <section class="hero">
            <div class="hero-content">
                <h1 id="hero-title">Мир развлечений ждет тебя</h1>
                <p id="hero-subtitle">Браузерные игры на любой вкус. Соревнуйся с друзьями!</p>
                <a href="#games" class="cta-button">Выбрать игру</a>
            </div>
        </section>

        <section id="games" class="container">
            <h2 class="section-title">Каталог игр</h2>
            <div class="game-grid">
                <!-- Карточки игр (оставлены без изменений) -->
                <div class="game-card">
                    <img src="https://placehold.co/600x400/3498db/ffffff?text=Змейка" alt="Змейка">
                    <div class="game-card-content"><h3>Змейка</h3><p>Классика с рекордами! Выбери скорость и стань лучшим.</p><button class="play-button" data-game="snake">Играть</button></div>
                </div>
                <div class="game-card">
                    <img src="https://placehold.co/600x400/e74c3c/ffffff?text=X+O" alt="Крестики-нолики">
                    <div class="game-card-content"><h3>Крестики-нолики</h3><p>Сыграй с другом и докажи свое превосходство. Твой счет побед сохраняется.</p><button class="play-button" data-game="tictactoe">Играть</button></div>
                </div>
                <div class="game-card">
                    <img src="https://placehold.co/600x400/2ecc71/ffffff?text=Кликер" alt="Кликер">
                    <div class="game-card-content"><h3>Кликер-мания</h3><p>Зарабатывай очки и покупай улучшения. Попади в таблицу лидеров!</p><button class="play-button" data-game="clicker">Играть</button></div>
                </div>
            </div>
        </section>

        <section id="leaderboard" class="container">
            <h2 class="section-title">Таблица лидеров</h2>
            <div class="leaderboard-container">
                <div class="leaderboard-card">
                    <h3>Змейка</h3>
                    <table class="leaderboard-table" id="leaderboard-snake">
                        <thead><tr><th>#</th><th>Игрок</th><th>Счет</th></tr></thead>
                        <tbody><!-- Заполняется JS --></tbody>
                    </table>
                </div>
                <div class="leaderboard-card">
                    <h3>Кликер-мания</h3>
                    <table class="leaderboard-table" id="leaderboard-clicker">
                        <thead><tr><th>#</th><th>Игрок</th><th>Рекорд</th></tr></thead>
                        <tbody><!-- Заполняется JS --></tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <section id="about" class="container">
            <h2 class="section-title">О нас</h2>
            <p style="text-align: center; max-width: 800px; margin: 0 auto; color: var(--subtle-text);">GameHub — это проект, созданный энтузиастами для энтузиастов. Мы верим, что простые и увлекательные игры могут скрасить любой день. Наша миссия — предоставить качественные браузерные игры, доступные каждому в один клик. Все наши игры абсолютно бесплатны и не требуют установки. Просто выберите игру и начните веселье!</p>
        </section>
    </main>

    <!-- Футер -->
    <footer><p>&copy; 2026 GameHub. Все права защищены. Создано с любовью к играм.</p></footer>

    <!-- Контейнер для уведомлений -->
    <div id="toast-container"></div>
    
    <!-- Модальные окна -->
    <div id="game-modal" class="modal game-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Название Игры</h2>
                <span class="close-button">&times;</span>
            </div>
            <div id="game-content-wrapper"></div>
        </div>
    </div>
    <div id="signup-modal" class="modal auth-modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">Регистрация</h2><span class="close-button">&times;</span></div>
            <form id="signup-form" class="auth-form">
                <div class="form-group"><label for="signup-username">Имя пользователя</label><input type="text" id="signup-username" required><div class="form-error" id="signup-username-error"></div></div>
                <div class="form-group"><label for="signup-password">Пароль</label><input type="password" id="signup-password" required></div>
                <button type="submit" class="form-submit">Создать аккаунт</button>
                <div class="form-switch">Уже есть аккаунт? <span class="switch-link" id="switch-to-login">Войти</span></div>
            </form>
        </div>
    </div>
    <div id="login-modal" class="modal auth-modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">Вход</h2><span class="close-button">&times;</span></div>
            <form id="login-form" class="auth-form">
                <div class="form-group"><label for="login-username">Имя пользователя</label><input type="text" id="login-username" required></div>
                <div class="form-group"><label for="login-password">Пароль</label><input type="password" id="login-password" required></div>
                <div class="form-error" id="login-error">Неверное имя пользователя или пароль</div>
                <button type="submit" class="form-submit">Войти</button>
                <div class="form-switch">Нет аккаунта? <span class="switch-link" id="switch-to-signup">Зарегистрироваться</span></div>
            </form>
        </div>
    </div>
    <div id="profile-modal" class="modal profile-modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">Профиль игрока</h2><span class="close-button">&times;</span></div>
            <div class="profile-content">
                <h3 id="profile-username" style="text-align: center; margin-top: 0;"></h3>
                <div class="profile-stats" id="profile-stats-content">
                    <!-- Заполняется JS -->
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // =======================================================
        // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ И УТИЛИТЫ ---
        // =======================================================
        const USERS_DB_KEY = 'gamehub_users_v2';
        const SESSION_KEY = 'gamehub_currentUser_v2';
        let activeGameInterval = null;
        let activeGameKeyListener = null;

        // --- Утилита для уведомлений ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        // --- Утилита для модальных окон ---
        function openModal(modal) { modal.style.display = 'block'; }
        function closeModal(modal) { modal.style.display = 'none'; }
        document.querySelectorAll('.modal .close-button').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal'))));
        window.addEventListener('click', (event) => { if (event.target.classList.contains('modal')) closeModal(event.target); });

        // =======================================================
        // --- ЛОГИКА АУТЕНТИФИКАЦИИ И ПРОФИЛЯ ---
        // =======================================================
        const authUI = {
            loginBtn: document.getElementById('login-btn'),
            signupBtn: document.getElementById('signup-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            profileBtn: document.getElementById('profile-btn'),
            authButtonsDiv: document.querySelector('.auth-buttons'),
            userInfoDiv: document.querySelector('.user-info'),
            greetingMsg: document.querySelector('.user-info-greeting'),
            heroTitle: document.getElementById('hero-title'),
            heroSubtitle: document.getElementById('hero-subtitle'),
            signupModal: document.getElementById('signup-modal'),
            loginModal: document.getElementById('login-modal'),
            profileModal: document.getElementById('profile-modal'),
            switchToLogin: document.getElementById('switch-to-login'),
            switchToSignup: document.getElementById('switch-to-signup'),
            signupForm: document.getElementById('signup-form'),
            loginForm: document.getElementById('login-form'),
        };

        const hashPassword = (password) => btoa(password + "salt"); // Простое "соление"

        function getCurrentUser() { return sessionStorage.getItem(SESSION_KEY); }

        function getUsers() { return JSON.parse(localStorage.getItem(USERS_DB_KEY)) || []; }

        function saveUsers(users) { localStorage.setItem(USERS_DB_KEY, JSON.stringify(users)); }

        function handleSignup(e) {
            e.preventDefault();
            const usernameInput = document.getElementById('signup-username');
            const passwordInput = document.getElementById('signup-password');
            const usernameError = document.getElementById('signup-username-error');
            const users = getUsers();
            if (users.find(user => user.username.toLowerCase() === usernameInput.value.toLowerCase())) {
                usernameError.textContent = 'Это имя пользователя уже занято.';
                usernameError.style.display = 'block';
                return;
            }
            usernameError.style.display = 'none';
            const newUser = {
                username: usernameInput.value,
                passwordHash: hashPassword(passwordInput.value),
                highScores: { snake: 0, clicker: 0, tictactoe_wins: 0 }
            };
            users.push(newUser);
            saveUsers(users);
            showToast('Регистрация прошла успешно!', 'success');
            closeModal(authUI.signupModal);
            openModal(authUI.loginModal);
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            const users = getUsers();
            const user = users.find(u => u.username.toLowerCase() === username.toLowerCase());

            if (user && user.passwordHash === hashPassword(password)) {
                sessionStorage.setItem(SESSION_KEY, user.username);
                updateUIForLogin(user.username);
                closeModal(authUI.loginModal);
                errorDiv.style.display = 'none';
                showToast(`Добро пожаловать, ${user.username}!`, 'success');
                updateLeaderboard();
            } else {
                errorDiv.style.display = 'block';
            }
        }

        function handleLogout() {
            sessionStorage.removeItem(SESSION_KEY);
            updateUIForLogout();
            showToast('Вы успешно вышли из системы.');
            updateLeaderboard();
        }

        function showProfile() {
            const username = getCurrentUser();
            if (!username) return;
            const users = getUsers();
            const user = users.find(u => u.username === username);
            if (!user) return;
            
            document.getElementById('profile-username').textContent = user.username;
            const statsContent = document.getElementById('profile-stats-content');
            statsContent.innerHTML = `
                <div class="stat-item"><span>Рекорд в "Змейке"</span><span>${user.highScores.snake}</span></div>
                <div class="stat-item"><span>Рекорд в "Кликер-мании"</span><span>${user.highScores.clicker}</span></div>
                <div class="stat-item"><span>Побед в "X-O"</span><span>${user.highScores.tictactoe_wins}</span></div>
            `;
            openModal(authUI.profileModal);
        }

        function updateUIForLogin(username) {
            authUI.authButtonsDiv.style.display = 'none';
            authUI.userInfoDiv.style.display = 'flex';
            authUI.greetingMsg.textContent = `Привет, ${username}!`;
            authUI.heroTitle.textContent = `С возвращением, ${username}!`;
            authUI.heroSubtitle.textContent = 'Ваши рекорды ждут вас.';
        }

        function updateUIForLogout() {
            authUI.authButtonsDiv.style.display = 'flex';
            authUI.userInfoDiv.style.display = 'none';
            authUI.heroTitle.textContent = `Мир развлечений ждет тебя`;
            authUI.heroSubtitle.textContent = 'Браузерные игры на любой вкус. Соревнуйся с друзьями!';
        }

        function checkLoginState() {
            const currentUser = getCurrentUser();
            currentUser ? updateUIForLogin(currentUser) : updateUIForLogout();
        }

        // --- Назначение обработчиков для аутентификации ---
        authUI.loginBtn.addEventListener('click', () => openModal(authUI.loginModal));
        authUI.signupBtn.addEventListener('click', () => openModal(authUI.signupModal));
        authUI.logoutBtn.addEventListener('click', handleLogout);
        authUI.profileBtn.addEventListener('click', showProfile);
        authUI.switchToLogin.addEventListener('click', () => { closeModal(authUI.signupModal); openModal(authUI.loginModal); });
        authUI.switchToSignup.addEventListener('click', () => { closeModal(authUI.loginModal); openModal(authUI.signupModal); });
        authUI.signupForm.addEventListener('submit', handleSignup);
        authUI.loginForm.addEventListener('submit', handleLogin);
        
        // =======================================================
        // --- ЛОГИКА ТАБЛИЦЫ ЛИДЕРОВ ---
        // =======================================================
        function updateLeaderboard() {
            const users = getUsers();
            
            // Змейка
            const snakeLeaderboard = users.filter(u => u.highScores.snake > 0).sort((a, b) => b.highScores.snake - a.highScores.snake).slice(0, 5);
            const snakeTbody = document.getElementById('leaderboard-snake').querySelector('tbody');
            snakeTbody.innerHTML = '';
            snakeLeaderboard.forEach((user, index) => {
                snakeTbody.innerHTML += `<tr><td class="rank">${index + 1}</td><td>${user.username}</td><td>${user.highScores.snake}</td></tr>`;
            });

            // Кликер
            const clickerLeaderboard = users.filter(u => u.highScores.clicker > 0).sort((a, b) => b.highScores.clicker - a.highScores.clicker).slice(0, 5);
            const clickerTbody = document.getElementById('leaderboard-clicker').querySelector('tbody');
            clickerTbody.innerHTML = '';
            clickerLeaderboard.forEach((user, index) => {
                clickerTbody.innerHTML += `<tr><td class="rank">${index + 1}</td><td>${user.username}</td><td>${user.highScores.clicker}</td></tr>`;
            });
        }

        // =======================================================
        // --- ЛОГИКА УПРАВЛЕНИЯ ИГРАМИ ---
        // =======================================================
        const gameModal = document.getElementById('game-modal');
        const gameContentWrapper = document.getElementById('game-content-wrapper');

        document.querySelectorAll('.play-button').forEach(button => {
            button.addEventListener('click', () => {
                const gameId = button.getAttribute('data-game');
                prepareGame(gameId);
                openModal(gameModal);
            });
        });

        gameModal.querySelector('.close-button').addEventListener('click', () => {
            if (activeGameInterval) clearInterval(activeGameInterval);
            if (activeGameKeyListener) document.removeEventListener('keydown', activeGameKeyListener);
            activeGameInterval = null;
            activeGameKeyListener = null;
            gameContentWrapper.innerHTML = '';
        });
        
        function prepareGame(gameId) {
            gameContentWrapper.innerHTML = '';
            const modalTitle = gameModal.querySelector('.modal-title');
            modalTitle.textContent = 'Настройки игры';
            
            if (gameId === 'snake') {
                modalTitle.textContent = 'Настройки "Змейки"';
                gameContentWrapper.innerHTML = `
                    <div class="game-settings">
                        <h3>Выберите скорость:</h3>
                        <label><input type="radio" name="snake-speed" value="150" checked> Медленно</label>
                        <label><input type="radio" name="snake-speed" value="100"> Нормально</label>
                        <label><input type="radio" name="snake-speed" value="60"> Быстро</label>
                    </div>
                    <button id="start-game-btn" class="cta-button">Начать игру</button>
                `;
                document.getElementById('start-game-btn').onclick = () => {
                    const speed = document.querySelector('input[name="snake-speed"]:checked').value;
                    initSnakeGame(parseInt(speed));
                };
            } else {
                // Для других игр запускаем сразу
                loadGame(gameId);
            }
        }
        
        function loadGame(gameId) {
            const modalTitle = gameModal.querySelector('.modal-title');
            switch (gameId) {
                case 'tictactoe': modalTitle.textContent = 'Крестики-нолики'; initTicTacToeGame(); break;
                case 'clicker': modalTitle.textContent = 'Кликер-мания'; initClickerGame(); break;
            }
        }
        
        function updateHighScore(game, score) {
            const username = getCurrentUser();
            if (!username) return;

            let users = getUsers();
            let user = users.find(u => u.username === username);
            if (user) {
                if (score > user.highScores[game]) {
                    user.highScores[game] = score;
                    saveUsers(users);
                    showToast('Новый рекорд!', 'success');
                    updateLeaderboard();
                }
            }
        }
        
        function incrementWinCount(game) {
            const username = getCurrentUser();
            if (!username) return;
            let users = getUsers();
            let user = users.find(u => u.username === username);
            if (user) {
                user.highScores[game]++;
                saveUsers(users);
                showToast('Победа засчитана!', 'success');
            }
        }

        // --- ЛОГИКА ИГР ---
        function initSnakeGame(speed) {
            gameModal.querySelector('.modal-title').textContent = 'Змейка';
            gameContentWrapper.innerHTML = `<canvas id="snake-canvas" width="400" height="400"></canvas><div id="snake-score">Счет: 0</div>`;
            const canvas = document.getElementById('snake-canvas'), scoreEl = document.getElementById('snake-score'), ctx = canvas.getContext('2d'), gridSize = 20;
            let snake = [{ x: 10, y: 10 }], food = {}, score = 0, direction = 'right', changingDirection = false;
            function generateFood() { food = { x: Math.floor(Math.random() * (canvas.width / gridSize)), y: Math.floor(Math.random() * (canvas.height / gridSize)) }; if (snake.some(s => s.x === food.x && s.y === food.y)) generateFood(); }
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                snake.forEach(s => { ctx.fillStyle = 'lightgreen'; ctx.fillRect(s.x * gridSize, s.y * gridSize, gridSize, gridSize); });
                ctx.fillStyle = 'red'; ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize, gridSize);
            }
            function update() {
                changingDirection = false;
                const head = { x: snake[0].x, y: snake[0].y };
                if (direction === 'right') head.x++; if (direction === 'left') head.x--; if (direction === 'up') head.y--; if (direction === 'down') head.y++;
                if (head.x < 0 || head.x * gridSize >= canvas.width || head.y < 0 || head.y * gridSize >= canvas.height || snake.slice(1).some(s => s.x === head.x && s.y === head.y)) { updateHighScore('snake', score); resetGame(); return; }
                snake.unshift(head);
                if (head.x === food.x && head.y === food.y) { score++; scoreEl.textContent = 'Счет: ' + score; generateFood(); } else { snake.pop(); }
                draw();
            }
            function resetGame() { score = 0; scoreEl.textContent = 'Счет: 0'; snake = [{ x: 10, y: 10 }]; direction = 'right'; generateFood(); }
            activeGameKeyListener = (e) => {
                if (changingDirection) return;
                changingDirection = true;
                const key = e.key.toLowerCase();
                if ((key === 'arrowleft' || key === 'a') && direction !== 'right') direction = 'left';
                if ((key === 'arrowup' || key === 'w') && direction !== 'down') direction = 'up';
                if ((key === 'arrowright' || key === 'd') && direction !== 'left') direction = 'right';
                if ((key === 'arrowdown' || key === 's') && direction !== 'up') direction = 'down';
            };
            document.addEventListener('keydown', activeGameKeyListener);
            generateFood();
            activeGameInterval = setInterval(update, speed);
        }
        function initTicTacToeGame() {
            gameContentWrapper.innerHTML = `<div id="tictactoe-board"></div><div id="ttt-status">Ход игрока X</div><button id="ttt-restart" style="margin-top: 15px; padding: 10px; font-size: 1rem; cursor: pointer;">Начать заново</button>`;
            const boardEl = document.getElementById('tictactoe-board'), statusEl = document.getElementById('ttt-status'), restartBtn = document.getElementById('ttt-restart');
            let board = Array(9).fill(''), currentPlayer = 'X', gameActive = true;
            const winConditions = [[0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]];
            function handleCellClick(e) {
                const index = parseInt(e.target.getAttribute('data-index'));
                if (board[index] !== '' || !gameActive) return;
                board[index] = currentPlayer; e.target.textContent = currentPlayer;
                checkResult();
            }
            function checkResult() {
                let roundWon = winConditions.some(cond => board[cond[0]] && board[cond[0]] === board[cond[1]] && board[cond[0]] === board[cond[2]]);
                if (roundWon) { 
                    statusEl.textContent = `Игрок ${currentPlayer} победил!`; gameActive = false;
                    if (currentPlayer === 'X' && getCurrentUser()) { incrementWinCount('tictactoe_wins'); } // Засчитываем победу только игроку X, если он залогинен
                    return;
                }
                if (!board.includes('')) { statusEl.textContent = 'Ничья!'; gameActive = false; return; }
                currentPlayer = currentPlayer === 'X' ? 'O' : 'X'; statusEl.textContent = `Ход игрока ${currentPlayer}`;
            }
            function restartGame() { board.fill(''); currentPlayer = 'X'; gameActive = true; statusEl.textContent = `Ход игрока ${currentPlayer}`; document.querySelectorAll('.ttt-cell').forEach(cell => cell.textContent = ''); }
            for (let i = 0; i < 9; i++) { const cell = document.createElement('div'); cell.classList.add('ttt-cell'); cell.setAttribute('data-index', i); cell.addEventListener('click', handleCellClick); boardEl.appendChild(cell); }
            restartBtn.addEventListener('click', restartGame);
        }
        function initClickerGame() {
            gameContentWrapper.innerHTML = `<div id="clicker-game"><div id="clicker-score">0</div><button id="click-button">Кликай!</button><button id="upgrade-button">Купить авто-клик (Стоимость: 10)</button><div id="autoclick-info" style="margin-top: 10px;">Авто-кликов в сек: 0</div></div>`;
            const scoreEl = document.getElementById('clicker-score'), clickBtn = document.getElementById('click-button'), upgradeBtn = document.getElementById('upgrade-button'), autoClickInfo = document.getElementById('autoclick-info');
            let score = 0, upgradeCost = 10, autoClicksPerSecond = 0;
            const updateUI = () => { scoreEl.textContent = score; upgradeBtn.textContent = `Купить авто-клик (Стоимость: ${upgradeCost})`; autoClickInfo.textContent = `Авто-кликов в сек: ${autoClicksPerSecond}`; };
            clickBtn.addEventListener('click', () => { score++; updateHighScore('clicker', score); updateUI(); });
            upgradeBtn.addEventListener('click', () => { if (score >= upgradeCost) { score -= upgradeCost; autoClicksPerSecond++; upgradeCost = Math.ceil(upgradeCost * 1.5); updateUI(); } });
            activeGameInterval = setInterval(() => { if (autoClicksPerSecond > 0) { score += autoClicksPerSecond; updateHighScore('clicker', score); updateUI(); } }, 1000);
            updateUI();
        }

        // =======================================================
        // --- ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ СТРАНИЦЫ ---
        // =======================================================
        checkLoginState();
        updateLeaderboard();

    });
    </script>

</body>
</html>
