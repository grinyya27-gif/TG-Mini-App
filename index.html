<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Средневековая RPG</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Google Fonts: Cinzel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0f0f10;
            --bg-panel: #1a1a1d;
            --accent-gold: #c8aa6e;
            --text-muted: #a0a0a0;
            --text-light: #e0e0e0;
            --border-color: #3e3e42;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-family: 'Lato', sans-serif;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        h1, h2, h3, .medieval-font {
            font-family: 'Cinzel', serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 2px;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* UI Panel Style */
        .panel {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* Button Styles */
        .btn-medieval {
            background: linear-gradient(to bottom, #2c2c30, #1a1a1d);
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            text-transform: uppercase;
            font-family: 'Cinzel', serif;
            letter-spacing: 1px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .btn-medieval:active {
            transform: scale(0.98);
            background: #c8aa6e;
            color: #000;
        }
        
        .btn-medieval:disabled {
            border-color: #555;
            color: #555;
            opacity: 0.7;
            pointer-events: none;
        }

        /* Tab Styles */
        .sub-tab {
            white-space: nowrap;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            color: #777;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .sub-tab.active {
            color: var(--accent-gold);
            border-color: var(--accent-gold);
            background-color: rgba(200, 170, 110, 0.1);
        }

        /* Progress Bar */
        .progress-container {
            background-color: #000;
            border: 1px solid #333;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b733d, #c8aa6e);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Bottom Nav Active State */
        .nav-item.active {
            color: var(--accent-gold);
            border-top: 2px solid var(--accent-gold);
        }

        /* Animations */
        @keyframes floatText {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-30px); opacity: 0; }
        }
        .floating-text {
            position: absolute;
            animation: floatText 1s ease-out forwards;
            pointer-events: none;
            font-weight: bold;
            color: var(--accent-gold);
            text-shadow: 1px 1px 0 #000;
            z-index: 50;
        }
        
        /* Grid background pattern */
        .bg-pattern {
            background-image: radial-gradient(#2a2a2e 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.1;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: var(--bg-panel);
            border: 1px solid var(--accent-gold);
            width: 90%;
            max-width: 320px;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 0 20px rgba(200, 170, 110, 0.2);
        }
        .modal-overlay.open .modal-content {
            transform: scale(1);
        }

        /* Level Up Modal Animations */
        .levelup-card {
            border: 1px solid rgba(200, 170, 110, 0.6);
            background: radial-gradient(circle at top, rgba(200, 170, 110, 0.15), transparent 60%), #1a1a1d;
            box-shadow: 0 0 30px rgba(200, 170, 110, 0.2), inset 0 0 20px rgba(0,0,0,0.6);
            animation: levelPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) both;
        }
        .levelup-glow {
            animation: levelGlow 2.5s ease-in-out infinite;
        }
        @keyframes levelPop {
            0% { transform: scale(0.7); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes levelGlow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }

        /* Wheel Animation */
        .wheel-container {
            transition: transform 3s cubic-bezier(0.1, 0.7, 0.1, 1);
        }
        .spin-anim {
            animation: spin 0.5s linear infinite;
        }
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        /* Witcher-style image filter */
        .witcher-img {
            filter: contrast(1.1) saturate(0.85) sepia(0.15) brightness(0.9);
        }
        .location-bg {
            background-size: cover;
            background-position: center;
            filter: contrast(1.15) saturate(0.7) sepia(0.2) brightness(0.6);
        }

        /* Unconscious State */
        body.unconscious header,
        body.unconscious #app-container,
        body.unconscious nav {
            pointer-events: none;
            filter: grayscale(0.7) brightness(0.6);
        }
    </style>
</head>
<body class="h-screen flex flex-col relative" style="overflow: hidden; -webkit-tap-highlight-color: transparent;">

    <!-- Background Pattern -->
    <div class="absolute inset-0 bg-pattern pointer-events-none"></div>

    <!-- Intro Modal (Arthur) -->
    <div id="modal-intro" class="modal-overlay">
        <div class="modal-content rounded-lg p-6 relative overflow-hidden text-left">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[#c8aa6e] to-transparent"></div>

            <div class="flex items-center gap-4 mb-4">
                <div class="w-14 h-14 rounded-full border-2 border-[#c8aa6e] bg-[#222] flex items-center justify-center overflow-hidden">
                    <i class="fas fa-user-tie text-2xl text-gray-300"></i>
                </div>
                <div>
                    <h2 class="medieval-font text-xl text-[#c8aa6e] leading-tight">Артур</h2>
                    <p class="text-[10px] text-[#777]">Травник</p>
                </div>
            </div>

            <div class="space-y-3 text-sm text-[#e0e0e0] leading-relaxed">
                <p>Очнулся наконец? Я нашёл тебя без сознания под мостом.</p>
                <p>Привёл в дом, обмыл, перевязал… и вылечил. Повезло тебе.</p>
                <p class="text-[#a0a0a0]">Совет на первое время: сходи на <span class="text-[#c8aa6e] font-bold">Городскую площадь</span> и попроси милостыню. Накопишь — купи <span class="text-[#c8aa6e] font-bold">удочку</span> на рынке. С неё и начнёшь вставать на ноги.</p>
            </div>

            <div class="mt-6 grid grid-cols-2 gap-2">
                <button onclick="game.closeIntro(false)" class="btn-medieval w-full py-2 rounded font-bold text-xs">
                    Понял
                </button>
                <button onclick="game.closeIntro(true)" class="btn-medieval w-full py-2 rounded font-bold text-xs">
                    На площадь
                </button>
            </div>
        </div>
    </div>

    <!-- Level Up Modal -->
    <div id="modal-levelup" class="modal-overlay">
        <div class="modal-content levelup-card rounded-lg p-6 text-center relative overflow-hidden">
            <div class="absolute inset-0 bg-[radial-gradient(circle_at_top,rgba(200,170,110,0.15),transparent_55%)]"></div>
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[#c8aa6e] to-transparent"></div>
            <div class="absolute inset-0 opacity-20 pointer-events-none bg-[url('https://www.transparenttextures.com/patterns/black-scales.png')]"></div>

            <div class="relative mb-4">
                <div class="levelup-glow absolute -inset-6 rounded-full bg-[#c8aa6e]/30 blur-3xl"></div>
                <i class="fas fa-crown text-5xl text-[#c8aa6e] drop-shadow-[0_0_15px_rgba(200,170,110,0.8)]"></i>
            </div>

            <h2 class="medieval-font text-2xl text-[#c8aa6e] mb-1 tracking-widest">УРОВЕНЬ ПОВЫШЕН</h2>
            <div id="levelup-new-level" class="text-5xl font-bold text-white mb-5 medieval-font drop-shadow-md">2</div>

            <div class="space-y-3 mb-6">
                <div class="bg-[#111]/80 border border-[#333] rounded p-3 flex items-center justify-between backdrop-blur-sm">
                    <span class="text-xs text-[#a0a0a0] uppercase tracking-wider">Награда</span>
                    <div class="flex items-center gap-2 text-[#ffd700] font-bold text-lg">
                        +<span id="levelup-gold">100</span> <i class="fas fa-coins"></i>
                    </div>
                </div>
                <div class="bg-[#111]/80 border border-[#333] rounded p-3 flex items-center justify-between backdrop-blur-sm">
                    <span class="text-xs text-[#a0a0a0] uppercase tracking-wider">Навыки</span>
                    <div class="text-[#34d399] font-bold text-lg">+1 Жетон</div>
                </div>
                <div class="text-left bg-[#222]/80 border-l-2 border-[#c8aa6e] rounded-r p-3 backdrop-blur-sm">
                    <div class="text-[10px] text-[#c8aa6e] font-bold mb-1 uppercase tracking-widest flex items-center gap-2">
                        <i class="fas fa-scroll"></i> Новые возможности
                    </div>
                    <p id="levelup-message" class="text-xs text-[#e0e0e0] leading-relaxed">...</p>
                </div>
            </div>

            <button onclick="game.closeLevelUp()" class="btn-medieval w-full py-3 rounded font-bold text-sm tracking-wider">ПРИНЯТЬ ДАРЫ</button>
        </div>
    </div>

    <!-- Daily Reward Modal -->
    <div id="modal-daily" class="modal-overlay">
        <div class="modal-content rounded-lg p-6 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[#c8aa6e] to-transparent"></div>
            <h2 class="medieval-font text-2xl text-[#c8aa6e] mb-2">Ежедневная Награда</h2>
            <p class="text-sm text-[#a0a0a0] mb-4">С возвращением, путник!</p>
            
            <div class="flex justify-center gap-2 mb-6">
                <div id="daily-days-container" class="flex gap-1"></div>
            </div>

            <div class="mb-6">
                <i class="far fa-gem text-4xl text-emerald-400 mb-2 drop-shadow-[0_0_10px_rgba(52,211,153,0.5)]"></i>
                <div class="text-xl font-bold text-white">+<span id="daily-amount">0</span> Изумрудов</div>
            </div>

            <button onclick="game.claimDaily()" class="btn-medieval w-full py-2 rounded font-bold">
                Забрать
            </button>
        </div>
    </div>

    <!-- Lost Pouch: Treasury -->
    <div id="modal-treasury-pouch" class="modal-overlay">
        <div class="modal-content rounded-lg p-6 text-center relative overflow-hidden border-yellow-500">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-yellow-400 to-transparent"></div>
            <div class="absolute inset-0 opacity-20 pointer-events-none bg-[radial-gradient(circle_at_top,rgba(250,204,21,0.2),transparent_60%)]"></div>
            <div class="relative">
                <div class="w-16 h-16 rounded-full border border-yellow-400/60 bg-[#111] flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-sack-dollar text-3xl text-yellow-400"></i>
                </div>
                <h2 class="medieval-font text-2xl text-yellow-300 mb-2">Чужой кошель</h2>
                <p class="text-sm text-[#a0a0a0] mb-4">У входа в казну выпал мешочек с <span class="text-yellow-300 font-bold">1000 золота</span>.</p>
                <div class="panel p-3 rounded bg-black/40 border border-[#333] mb-4 text-left">
                    <div class="text-[10px] text-[#c8aa6e] uppercase tracking-widest mb-1">Выбор</div>
                    <p class="text-xs text-[#e0e0e0] leading-relaxed">Ты можешь позвать владельца и вернуть мешок — или забрать себе.</p>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="ui.resolveTreasuryPouch('return')" class="btn-medieval w-full py-2 rounded text-xs border-emerald-500 text-emerald-300">
                        Вернуть (+3 Реп.)
                    </button>
                    <button onclick="ui.resolveTreasuryPouch('keep')" class="btn-medieval w-full py-2 rounded text-xs border-red-500 text-red-300">
                        Забрать (-5 Реп.)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lost Pouch: Bookhouse -->
    <div id="modal-bookhouse-pouch" class="modal-overlay">
        <div class="modal-content rounded-lg p-6 text-center relative overflow-hidden border-emerald-500">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-emerald-400 to-transparent"></div>
            <div class="absolute inset-0 opacity-20 pointer-events-none bg-[radial-gradient(circle_at_top,rgba(52,211,153,0.2),transparent_60%)]"></div>
            <div class="relative">
                <div class="w-16 h-16 rounded-full border border-emerald-500/60 bg-[#111] flex items-center justify-center mx-auto mb-4">
                    <i class="far fa-gem text-3xl text-emerald-400"></i>
                </div>
                <h2 class="medieval-font text-2xl text-emerald-300 mb-2">Забытая шкатулка</h2>
                <p class="text-sm text-[#a0a0a0] mb-4">Между полками лежит шкатулка с <span class="text-emerald-300 font-bold">10 изумрудами</span>.</p>
                <div class="panel p-3 rounded bg-black/40 border border-[#333] mb-4 text-left">
                    <div class="text-[10px] text-[#c8aa6e] uppercase tracking-widest mb-1">Совесть</div>
                    <p class="text-xs text-[#e0e0e0] leading-relaxed">Вернёшь владельцу — заслужишь уважение. Оставишь — легко разбогатеешь.</p>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="ui.resolveBookhousePouch('return')" class="btn-medieval w-full py-2 rounded text-xs border-emerald-500 text-emerald-300">
                        Вернуть (+3 Реп.)
                    </button>
                    <button onclick="ui.resolveBookhousePouch('keep')" class="btn-medieval w-full py-2 rounded text-xs border-red-500 text-red-300">
                        Забрать (-5 Реп.)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Unconscious Modal -->
    <div id="modal-unconscious" class="modal-overlay">
        <div class="modal-content rounded-lg p-6 text-center relative overflow-hidden border-red-500">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-red-500 to-transparent"></div>
            <div class="absolute inset-0 opacity-20 pointer-events-none bg-[radial-gradient(circle_at_top,rgba(239,68,68,0.2),transparent_60%)]"></div>
            <div class="relative">
                <div class="w-16 h-16 rounded-full border border-red-500/60 bg-[#111] flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-skull-crossbones text-3xl text-red-400"></i>
                </div>
                <h2 class="medieval-font text-2xl text-red-400 mb-2">Потеря сознания</h2>
                <p class="text-sm text-[#a0a0a0] mb-4">Вы лишились сил. Мир меркнет...</p>
                <div class="panel p-3 rounded bg-black/40 border border-[#333] mb-4">
                    <div class="text-[10px] text-[#777] uppercase tracking-widest mb-1">До пробуждения</div>
                    <div id="unconscious-timer" class="text-2xl font-bold text-[#c8aa6e] medieval-font">10:00</div>
                </div>
                <p class="text-[10px] text-[#777]">После пробуждения здоровье восстановится до 15 HP.</p>
            </div>
        </div>
    </div>

    <!-- Low HP Warning Modal -->
    <div id="modal-lowhp" class="modal-overlay">
        <div class="modal-content rounded-lg p-6 text-center relative overflow-hidden border-amber-500">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-amber-400 to-transparent"></div>
            <div class="absolute inset-0 opacity-20 pointer-events-none bg-[radial-gradient(circle_at_top,rgba(251,191,36,0.2),transparent_60%)]"></div>
            <div class="relative">
                <div class="w-16 h-16 rounded-full border border-amber-500/60 bg-[#111] flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-triangle-exclamation text-3xl text-amber-400"></i>
                </div>
                <h2 class="medieval-font text-2xl text-amber-300 mb-2">Слишком слаб</h2>
                <p class="text-sm text-[#a0a0a0] mb-4">Ты можешь потерять сознание. Сил осталось совсем мало.</p>
                <div class="panel p-3 rounded bg-black/40 border border-[#333] mb-4 text-left">
                    <div class="text-[10px] text-[#c8aa6e] uppercase tracking-widest mb-1">Совет</div>
                    <p class="text-xs text-[#e0e0e0] leading-relaxed">Посети лекаря в хижине или съешь еду, чтобы восстановить здоровье.</p>
                </div>
                <button onclick="ui.dismissLowHpWarning()" class="btn-medieval w-full py-2 rounded text-xs border-amber-500 text-amber-300">
                    Понял
                </button>
            </div>
        </div>
    </div>

    <!-- Reputation Info Modal -->
    <div id="modal-reputation" class="modal-overlay">
        <div class="modal-content rounded-lg p-6 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[#c8aa6e] to-transparent"></div>
            <h2 class="medieval-font text-2xl text-[#c8aa6e] mb-2">Репутация</h2>
            <p class="text-sm text-[#a0a0a0] mb-4">То, как тебя видят жители города.</p>
            <div class="panel p-3 rounded bg-black/30 border border-[#333] text-left text-xs text-[#e0e0e0] space-y-2">
                <p><span class="text-[#c8aa6e] font-bold">Повышается</span> за добрые поступки, выполнение заданий, покупку хорошей одежды, оружия и приличного дома.</p>
                <p><span class="text-red-400 font-bold">Понижается</span> за грубость, обман и сомнительные дела.</p>
                <p class="text-[10px] text-[#777]">Совет: будь вежливым, носи чистую одежду и обзаведись достойным домом.</p>
            </div>
            <button onclick="ui.closeRepInfo()" class="btn-medieval w-full py-2 rounded font-bold mt-4">Понял</button>
        </div>
    </div>

    <!-- Dialogue Modal -->
    <div id="modal-dialogue" class="modal-overlay">
        <div class="modal-content rounded-lg p-0 relative overflow-hidden text-left flex flex-col max-h-[80vh]">
            <!-- NPC Header -->
            <div class="bg-[#111] p-4 flex items-center gap-4 border-b border-[#333]">
                <div class="w-12 h-12 rounded-full border border-[#c8aa6e] bg-[#222] flex items-center justify-center overflow-hidden shrink-0">
                    <i id="npc-icon" class="fas fa-user text-xl text-gray-300"></i>
                </div>
                <div>
                    <h2 id="npc-name" class="medieval-font text-lg text-[#c8aa6e] leading-tight">Имя</h2>
                    <p id="npc-role" class="text-[10px] text-[#777]">Роль</p>
                </div>
                <button onclick="dialogue.close()" class="ml-auto text-gray-500 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Chat Body -->
            <div class="p-4 overflow-y-auto bg-[#1a1a1d] min-h-[150px]">
                <p id="npc-text" class="text-sm text-[#e0e0e0] leading-relaxed">...</p>
            </div>

            <!-- Options -->
            <div id="npc-options" class="p-2 bg-[#111] border-t border-[#333] flex flex-col gap-2">
                <!-- Options populated by JS -->
            </div>
        </div>
    </div>

    <!-- Header / Currency Bar -->
    <header class="h-14 flex items-center justify-between px-4 bg-opacity-90 bg-[#141417] border-b border-[#333] z-20 backdrop-blur-md shrink-0">
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-1">
                <i class="fas fa-coins text-yellow-500 text-sm"></i>
                <span id="gold-display" class="font-bold tracking-wide text-sm">0</span>
            </div>
            <div class="flex items-center gap-1">
                <i class="far fa-gem text-emerald-400 text-sm"></i>
                <span id="emerald-display" class="font-bold tracking-wide text-sm">0</span>
            </div>
        </div>
        
        <!-- Header Level & XP -->
        <div class="flex flex-col items-end justify-center w-32">
             <div class="flex items-center justify-between w-full mb-0.5">
                <span class="text-[10px] text-[#a0a0a0] flex items-center gap-1"><i class="fas fa-heart text-red-500"></i> <span id="header-hp-text">100</span></span>
                <span class="text-xs text-[#c8aa6e] font-serif font-bold" id="level-display-header">Ур 1</span>
             </div>
             <div class="w-full h-1.5 bg-[#000] rounded-full overflow-hidden border border-[#333] mb-0.5">
                 <div id="header-xp-bar" class="h-full bg-gradient-to-r from-[#8b733d] to-[#c8aa6e] w-0 transition-all duration-300"></div>
             </div>
             <div class="text-[8px] text-[#777] font-mono tracking-tighter" id="header-xp-text">0/100</div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="app-container" class="flex-1 overflow-y-auto p-4 pb-20 relative">
        
        <!-- VIEW: CHARACTER -->
        <section id="view-character" class="space-y-6 hidden">
            <div class="flex flex-col items-center justify-center py-6">
                <div class="w-24 h-24 rounded-full border-2 border-[#c8aa6e] overflow-hidden shadow-[0_0_15px_rgba(200,170,110,0.3)] mb-4 relative bg-[#222]" style="box-shadow: inset 0 0 20px rgba(0,0,0,0.5), 0 0 15px rgba(200,170,110,0.3);">
                    <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=medievalWarrior&backgroundColor=1a1a1d&skinColor=f2d3b1&hair=short01&hairColor=796a45&eyes=variant01&eyebrows=variant10&mouth=variant01" alt="Герой" class="w-full h-full object-cover scale-110">
                    <div class="absolute inset-0 bg-gradient-to-b from-transparent via-transparent to-[#c8aa6e]/30 pointer-events-none"></div>
                    <div class="absolute inset-0 border-4 border-[#c8aa6e]/30 rounded-full pointer-events-none"></div>
                </div>
                <h2 class="text-2xl medieval-font text-[#e0e0e0]">Странник</h2>
                <p class="text-sm text-[#a0a0a0] mb-2">Начинающий искатель приключений</p>
                
                <!-- Level Progress -->
                <div class="w-full max-w-xs space-y-1">
                    <div class="flex justify-between text-xs text-[#a0a0a0]">
                        <span>Уровень <span id="char-level">1</span></span>
                    </div>
                    <div class="progress-container">
                        <div id="xp-bar" class="progress-fill"></div>
                    </div>
                    <div class="flex justify-between items-center mt-1">
                        <div class="text-[10px] text-[#777]">
                             <span id="xp-text">0 / 100 XP</span>
                        </div>
                        <div class="text-[10px] text-[#777]">
                            Осталось <span id="xp-remaining" class="text-[#c8aa6e]">100</span>
                        </div>
                    </div>
                </div>

                <!-- HP Status -->
                <div class="w-full max-w-xs mt-2">
                    <div class="flex justify-between text-xs text-[#a0a0a0] mb-1">
                        <span>Здоровье</span>
                        <span id="hp-text" class="text-red-400">100 / 100</span>
                    </div>
                    <div class="h-2 bg-[#000] border border-[#333] rounded-full overflow-hidden relative">
                        <div id="hp-bar" class="h-full bg-red-600 w-full transition-all duration-300"></div>
                    </div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-3 gap-3">
                <div class="panel p-3 rounded text-center">
                    <div class="text-[10px] text-[#a0a0a0] uppercase tracking-widest">Урон</div>
                    <div id="stat-damage" class="text-lg font-bold text-[#c8aa6e]">0</div>
                </div>
                <div class="panel p-3 rounded text-center">
                    <div class="text-[10px] text-[#a0a0a0] uppercase tracking-widest">Ловкость</div>
                    <div id="stat-agility" class="text-lg font-bold text-[#c8aa6e]">0</div>
                </div>
                <div class="panel p-3 rounded text-center">
                    <div class="text-[10px] text-[#a0a0a0] uppercase tracking-widest">Удача</div>
                    <div id="stat-luck" class="text-lg font-bold text-[#c8aa6e]">0</div>
                </div>
            </div>

            <div class="panel rounded p-3 cursor-pointer" onclick="ui.openRepInfo()">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2 text-xs text-[#a0a0a0] uppercase tracking-widest">
                        <i class="fas fa-scale-balanced text-[#c8aa6e]"></i>
                        Репутация
                    </div>
                    <div class="text-sm font-bold text-[#c8aa6e]"><span id="rep-value">0</span>/100</div>
                </div>
                <div class="h-2 bg-[#000] border border-[#333] rounded-full overflow-hidden">
                    <div id="rep-bar" class="h-full bg-gradient-to-r from-emerald-700 to-[#c8aa6e] w-0 transition-all duration-300"></div>
                </div>
                <div id="rep-rank" class="text-[10px] text-[#777] mt-2">Безымянный странник</div>
            </div>
            
            <!-- Active Effects Display -->
            <div id="active-effects-container" class="grid grid-cols-2 gap-2 hidden">
                <div id="effect-immortality" class="panel p-2 rounded flex items-center gap-2 border-red-500/50 hidden">
                    <i class="fas fa-heart text-red-500 animate-pulse"></i>
                    <div>
                        <div class="text-[10px] text-red-400 font-bold uppercase">Бессмертие</div>
                        <div class="text-[10px] text-gray-400" id="timer-immortality">00:00</div>
                    </div>
                </div>
                <div id="effect-luck" class="panel p-2 rounded flex items-center gap-2 border-green-500/50 hidden">
                    <i class="fas fa-clover text-green-500 animate-pulse"></i>
                    <div>
                        <div class="text-[10px] text-green-400 font-bold uppercase">Удача x2</div>
                        <div class="text-[10px] text-gray-400" id="timer-luck">00:00</div>
                    </div>
                </div>
            </div>

             <!-- Integrated Inventory & Crafting & Skills -->
             <div class="panel rounded p-4">
                <div class="flex gap-2 mb-4">
                    <button onclick="ui.switchCharTab('inventory')" id="btn-tab-inv" class="flex-1 bg-[#2c2c30] border border-[#c8aa6e] text-[#c8aa6e] py-1 rounded text-xs uppercase font-serif transition-colors">Инвентарь</button>
                    <button onclick="ui.switchCharTab('skills')" id="btn-tab-skills" class="flex-1 bg-[#1a1a1d] border border-[#333] text-[#777] py-1 rounded text-xs uppercase font-serif transition-colors">Навыки</button>
                </div>
                
                <!-- Inventory UI -->
                <div id="ui-inventory">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="medieval-font text-sm text-[#c8aa6e]">Рюкзак</h3>
                        <button onclick="crafting.toggleMode()" class="text-[10px] text-[#777] underline">
                            <i class="fas fa-hammer mr-1"></i> <span id="craft-btn-text">Перейти к крафту</span>
                        </button>
                    </div>
                    <!-- Inventory Tabs -->
                    <div class="flex items-center gap-2 overflow-x-auto pb-2 mb-2 no-scrollbar">
                        <button onclick="inventory.switchCategory('tools')" id="tab-inv-tools" class="sub-tab active">Инструменты</button>
                        <button onclick="inventory.switchCategory('weapons')" id="tab-inv-weapons" class="sub-tab">Меч</button>
                        <button onclick="inventory.switchCategory('armor')" id="tab-inv-armor" class="sub-tab">Броня</button>
                        <button onclick="inventory.switchCategory('potions')" id="tab-inv-potions" class="sub-tab">Зелья</button>
                        <button onclick="inventory.switchCategory('other')" id="tab-inv-other" class="sub-tab">Другое</button>
                    </div>

                    <div id="inventory-grid" class="grid grid-cols-4 gap-2">
                        <!-- Slots populated by JS -->
                    </div>
                </div>

                <!-- Crafting UI -->
                <div id="ui-crafting" class="hidden">
                     <!-- Crafting Tabs -->
                     <div class="flex items-center gap-2 overflow-x-auto pb-2 mb-2 no-scrollbar">
                        <button onclick="crafting.switchCategory('potions')" id="tab-craft-potions" class="sub-tab active">Зелья</button>
                        <button onclick="crafting.switchCategory('charms')" id="tab-craft-charms" class="sub-tab">Обереги</button>
                        <button onclick="crafting.switchCategory('tools')" id="tab-craft-tools" class="sub-tab">Материалы</button>
                        <button onclick="crafting.switchCategory('food')" id="tab-craft-food" class="sub-tab">Еда</button>
                    </div>

                    <div id="crafting-list" class="space-y-3">
                        <!-- Recipes populated by JS -->
                        <div class="text-center text-xs text-gray-500 py-4">Нет рецептов</div>
                    </div>
                </div>

                <!-- Skills UI -->
                <div id="ui-skills" class="hidden space-y-3">
                    <div class="flex justify-between items-center p-2 bg-black/20 rounded border border-[#333]">
                        <span class="text-sm text-[#a0a0a0]"><i class="fas fa-star text-yellow-500 mr-1"></i> Жетоны навыков</span>
                        <span class="text-xl font-bold text-[#c8aa6e]" id="skill-points-display">0</span>
                    </div>

                    <!-- Max HP -->
                    <div class="panel p-3 rounded flex justify-between items-center bg-[#151518]">
                        <div>
                            <div class="text-[#e0e0e0] font-bold text-xs"><i class="fas fa-heart text-red-500 mr-1"></i> Живучесть</div>
                            <div class="text-[10px] text-[#777]">+20 Макс. здоровья</div>
                        </div>
                        <button onclick="skills.upgrade('hp')" class="bg-[#222] border border-[#c8aa6e] text-[#c8aa6e] px-3 py-1 text-[10px] rounded hover:bg-[#c8aa6e] hover:text-black transition-colors uppercase">
                            1 Жетон
                        </button>
                    </div>
                    
                    <!-- Luck -->
                    <div class="panel p-3 rounded flex justify-between items-center bg-[#151518]">
                        <div>
                            <div class="text-[#e0e0e0] font-bold text-xs"><i class="fas fa-clover text-green-500 mr-1"></i> Удача (Ур <span id="luck-display">0</span>)</div>
                            <div class="text-[10px] text-[#777]">Больше шансов на добычу</div>
                        </div>
                        <button onclick="skills.upgrade('luck')" class="bg-[#222] border border-[#c8aa6e] text-[#c8aa6e] px-3 py-1 text-[10px] rounded hover:bg-[#c8aa6e] hover:text-black transition-colors uppercase">
                            1 Жетон
                        </button>
                    </div>

                     <!-- Agility -->
                    <div class="panel p-3 rounded flex justify-between items-center bg-[#151518]">
                        <div>
                            <div class="text-[#e0e0e0] font-bold text-xs"><i class="fas fa-person-running text-blue-400 mr-1"></i> Ловкость (Ур <span id="agility-display">0</span>)</div>
                            <div class="text-[10px] text-[#777]">Меньше шанс травмы</div>
                        </div>
                        <button onclick="skills.upgrade('agility')" class="bg-[#222] border border-[#c8aa6e] text-[#c8aa6e] px-3 py-1 text-[10px] rounded hover:bg-[#c8aa6e] hover:text-black transition-colors uppercase">
                            1 Жетон
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: MAP -->
        <section id="view-map" class="space-y-4">
            <h2 class="medieval-font text-2xl text-center mb-6 text-[#c8aa6e]">Карта Мира</h2>
            
            <div class="space-y-4">
                <div class="flex items-center gap-2 text-[11px] text-[#c8aa6e] uppercase tracking-[0.3em]">
                    <i class="fas fa-city"></i>
                    Город
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <!-- Jobs -->
                    <button onclick="router.navigate('jobs')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-gradient-to-br from-[#0b2a55]/80 via-[#1a1a1d] to-[#0f0f10]">
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(30,144,255,0.18),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-[#1E90FF]/20 flex items-center justify-center">
                            <i class="fas fa-chevron-right text-[#7fb7ff]/70 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-[#0e3a6b]/70 to-[#0b2a55] flex items-center justify-center border-2 border-[#1E90FF]/60 shadow-[0_0_20px_rgba(30,144,255,0.35)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-hammer text-[#1E90FF] text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-[#dbeafe] drop-shadow-lg text-center">Работы</h3>
                            <p class="text-[9px] text-[#90c2ff]/70 text-center mt-0.5">Порт, Поле, Шахта</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-[#1E90FF]/50 to-transparent"></div>
                    </button>

                    <!-- Town Square -->
                    <button onclick="router.navigate('town-square')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-gradient-to-br from-[#3b1f0b]/85 via-[#1a1a1d] to-[#0f0f10]">
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(139,69,19,0.2),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-[#8B4513]/20 flex items-center justify-center">
                            <i class="fas fa-chevron-right text-[#d2a679]/70 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-[#5a2d0f]/70 to-[#3b1f0b] flex items-center justify-center border-2 border-[#8B4513]/60 shadow-[0_0_20px_rgba(139,69,19,0.35)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-landmark text-[#c47a2c] text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-[#f5e1c9] drop-shadow-lg text-center">Городская площадь</h3>
                            <p class="text-[9px] text-[#cfa57a]/70 text-center mt-0.5">Милостыня, слухи</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-[#8B4513]/50 to-transparent"></div>
                    </button>

                    <!-- Tavern -->
                    <button onclick="router.navigate('tavern')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-gradient-to-br from-orange-950/80 via-[#1a1a1d] to-[#0f0f10]">
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(249,115,22,0.15),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-orange-600/20 flex items-center justify-center">
                            <i class="fas fa-chevron-right text-orange-500/60 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-orange-900/60 to-orange-950 flex items-center justify-center border-2 border-orange-500/60 shadow-[0_0_20px_rgba(249,115,22,0.3)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-beer-mug-empty text-orange-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-orange-100 drop-shadow-lg text-center">Таверна</h3>
                            <p class="text-[9px] text-orange-300/60 text-center mt-0.5">Отдых и игры</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-orange-500/40 to-transparent"></div>
                    </button>

                    <!-- Treasury -->
                    <button onclick="router.navigate('treasury')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-gradient-to-br from-yellow-950/80 via-[#1a1a1d] to-[#0f0f10]">
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(234,179,8,0.15),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-yellow-600/20 flex items-center justify-center">
                            <i class="fas fa-chevron-right text-yellow-500/60 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-yellow-900/60 to-yellow-950 flex items-center justify-center border-2 border-yellow-500/60 shadow-[0_0_20px_rgba(234,179,8,0.3)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-coins text-yellow-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-yellow-100 drop-shadow-lg text-center">Казна</h3>
                            <p class="text-[9px] text-yellow-300/60 text-center mt-0.5">Обмен, хранилище</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-yellow-500/40 to-transparent"></div>
                    </button>

                    <!-- Healer's Hut -->
                    <button onclick="router.navigate('healer')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-gradient-to-br from-red-950/80 via-[#1a1a1d] to-[#0f0f10]">
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(239,68,68,0.15),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-red-600/20 flex items-center justify-center">
                            <i class="fas fa-chevron-right text-red-500/60 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-red-900/60 to-red-950 flex items-center justify-center border-2 border-red-500/60 shadow-[0_0_20px_rgba(239,68,68,0.3)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-mortar-pestle text-red-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-red-100 drop-shadow-lg text-center">Хижина Лекаря</h3>
                            <p class="text-[9px] text-red-300/60 text-center mt-0.5">Лечение и зелья</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-red-500/40 to-transparent"></div>
                    </button>

                    <!-- Royal Castle -->
                    <button onclick="router.navigate('royal-castle')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-gradient-to-br from-indigo-950/80 via-[#1a1a1d] to-[#0f0f10]">
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(99,102,241,0.15),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-indigo-600/20 flex items-center justify-center">
                            <i class="fas fa-chevron-right text-indigo-500/60 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-indigo-900/60 to-indigo-950 flex items-center justify-center border-2 border-indigo-500/60 shadow-[0_0_20px_rgba(99,102,241,0.3)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-chess-rook text-indigo-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-indigo-100 drop-shadow-lg text-center">Королевский замок</h3>
                            <p class="text-[9px] text-indigo-300/60 text-center mt-0.5">Для знати</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-indigo-500/40 to-transparent"></div>
                    </button>

                    <!-- Noble Quarter -->
                    <button onclick="router.navigate('noble-quarter')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-gradient-to-br from-yellow-900/80 via-[#1a1a1d] to-[#0f0f10]">
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(202,138,4,0.15),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-yellow-600/20 flex items-center justify-center">
                            <i class="fas fa-chevron-right text-yellow-500/60 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-yellow-800/60 to-yellow-950 flex items-center justify-center border-2 border-yellow-500/60 shadow-[0_0_20px_rgba(202,138,4,0.3)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-crown text-yellow-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-yellow-100 drop-shadow-lg text-center">Дворянский квартал</h3>
                            <p class="text-[9px] text-yellow-300/60 text-center mt-0.5">Роскошь и власть</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-yellow-500/40 to-transparent"></div>
                    </button>

                    <!-- Poor District -->
                    <button onclick="router.navigate('poor-district')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-gradient-to-br from-stone-900/80 via-[#1a1a1d] to-[#0f0f10]">
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(120,113,108,0.1),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-stone-600/20 flex items-center justify-center">
                            <i class="fas fa-chevron-right text-stone-500/60 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-stone-800/60 to-stone-950 flex items-center justify-center border-2 border-stone-600/60 shadow-[0_0_20px_rgba(120,113,108,0.2)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-house-crack text-stone-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-stone-200 drop-shadow-lg text-center">Район для бедняков</h3>
                            <p class="text-[9px] text-stone-400/60 text-center mt-0.5">Грязные улицы</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-stone-600/40 to-transparent"></div>
                    </button>
                </div>

                <div class="flex items-center gap-2 text-[11px] text-[#c8aa6e] uppercase tracking-[0.3em] pt-2">
                    <i class="fas fa-mountain"></i>
                    Предместье
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <!-- Village -->
                    <button id="btn-loc-village" onclick="router.navigate('village')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-gradient-to-br from-[#0b2b17]/85 via-[#1a1a1d] to-[#0f0f10]">
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(0,128,0,0.2),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-[#008000]/20 flex items-center justify-center">
                            <i id="village-lock-icon" class="fas fa-chevron-right text-[#7ad37a]/70 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-[#0f4a26]/70 to-[#0b2b17] flex items-center justify-center border-2 border-[#008000]/60 shadow-[0_0_20px_rgba(0,128,0,0.35)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-house-chimney text-[#3ddc84] text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-[#def7de] drop-shadow-lg text-center">Деревня на окраине</h3>
                            <p id="village-desc" class="text-[9px] text-[#9fe0a1]/70 text-center mt-0.5">Дом и хозяйство</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-[#008000]/50 to-transparent"></div>
                    </button>

                    <!-- Refugee Camp -->
                    <button id="btn-loc-refugee" onclick="router.navigate('refugee-camp')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-gradient-to-br from-slate-900/80 via-[#1a1a1d] to-[#0f0f10]">
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(100,116,139,0.1),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-slate-600/20 flex items-center justify-center">
                            <i id="refugee-lock-icon" class="fas fa-lock text-slate-500/60 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-slate-800/60 to-slate-950 flex items-center justify-center border-2 border-slate-600/60 shadow-[0_0_20px_rgba(100,116,139,0.2)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-campground text-slate-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-slate-300 drop-shadow-lg text-center">Лагерь беженцев</h3>
                            <p id="refugee-desc" class="text-[9px] text-slate-500 text-center mt-0.5">Тайное место</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-slate-600/40 to-transparent"></div>
                    </button>

                    <!-- Dark Forest -->
                    <button id="btn-loc-forest" onclick="router.navigate('dark-forest')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-gradient-to-br from-purple-950/80 via-[#1a1a1d] to-[#0f0f10]">
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(168,85,247,0.15),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-purple-600/20 flex items-center justify-center">
                            <i id="forest-lock-icon" class="fas fa-chevron-right text-purple-500/60 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-purple-900/60 to-purple-950 flex items-center justify-center border-2 border-purple-500/60 shadow-[0_0_20px_rgba(168,85,247,0.4)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-tree text-purple-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-purple-100 drop-shadow-lg text-center">Тёмный Лес</h3>
                            <p id="forest-desc" class="text-[9px] text-purple-300/60 text-center mt-0.5">Опасность и травы</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-purple-500/40 to-transparent"></div>
                    </button>

                    <!-- Training Camp -->
                    <button id="btn-loc-camp" onclick="router.navigate('training-camp')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-gradient-to-br from-red-950/80 via-[#1a1a1d] to-[#0f0f10]">
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(220,38,38,0.15),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-red-700/20 flex items-center justify-center">
                            <i id="camp-lock-icon" class="fas fa-chevron-right text-red-600/60 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-red-800/60 to-red-950 flex items-center justify-center border-2 border-red-600/60 shadow-[0_0_20px_rgba(220,38,38,0.3)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-shield-halved text-red-500 text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-red-100 drop-shadow-lg text-center">Учебный Лагерь</h3>
                            <p id="camp-desc" class="text-[9px] text-red-300/60 text-center mt-0.5">Путь воина</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-red-600/40 to-transparent"></div>
                    </button>
                </div>
            </div>
        </section>

        <!-- SUB-VIEW: JOBS -->
        <section id="view-jobs" class="hidden space-y-4">
            <!-- Header with Gradient -->
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-gradient-to-br from-[#0b2a55]/80 via-[#1a1a1d] to-[#0f0f10]">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(30,144,255,0.25),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-[#1E90FF]/60 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-[#1E90FF]/40 bg-black/30 flex items-center justify-center text-[#7fb7ff] hover:bg-[#1E90FF]/20 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-[#0e3a6b]/70 to-[#0b2a55] flex items-center justify-center border-2 border-[#1E90FF]/60 shadow-[0_0_15px_rgba(30,144,255,0.35)]">
                        <i class="fas fa-hammer text-[#1E90FF] text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-[#dbeafe] drop-shadow-md">Работы</h2>
                </div>
            </div>

            <!-- The Port -->
            <div id="job-port" class="panel rounded-lg p-0 relative overflow-hidden h-40 group">
                <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1549140600-78c9b8275ee3?q=80&w=2070')] bg-cover bg-center opacity-30 group-hover:opacity-40 transition-opacity"></div>
                <div class="absolute inset-0 p-4 flex flex-col justify-between">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="medieval-font text-lg text-white drop-shadow-md">Порт</h3>
                            <p class="text-xs text-gray-300 drop-shadow-md">Ловля рыбы для рынка.</p>
                            <p class="text-xs text-[#c8aa6e] mt-1 drop-shadow-md" id="job-info-port">Требуется: Удочка</p>
                        </div>
                        <span class="text-xs bg-green-900/80 text-green-200 px-2 py-0.5 rounded border border-green-800 backdrop-blur-sm">Ур 1</span>
                    </div>
                    <div>
                        <div class="flex items-center gap-4 mb-3">
                            <div class="text-sm text-[#e0e0e0] flex items-center gap-1 drop-shadow-md">
                                <i class="fas fa-fish"></i> <span id="reward-port" class="font-bold">1-2 Рыбы</span>
                            </div>
                            <div class="text-sm text-blue-400 flex items-center gap-1 drop-shadow-md">
                                <i class="fas fa-star"></i> +1 XP
                            </div>
                        </div>
                        <button id="btn-work-port" onclick="game.work('port', event)" class="btn-medieval w-full py-2 rounded font-bold shadow-lg">
                            <i class="fas fa-fish mr-2"></i> Рыбачить
                        </button>
                    </div>
                </div>
            </div>

            <!-- The Loader (Unlocked by Alex) -->
            <div id="job-loader" class="panel rounded-lg p-0 relative overflow-hidden h-40 group hidden">
                <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1578575437130-527eed3abbec?q=80&w=2070')] bg-cover bg-center opacity-30 group-hover:opacity-40 transition-opacity"></div>
                <div class="absolute inset-0 p-4 flex flex-col justify-between">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="medieval-font text-lg text-white drop-shadow-md">Грузчик в порту</h3>
                            <p class="text-xs text-gray-300 drop-shadow-md">Разгрузка мешков с зерном.</p>
                            <p class="text-xs text-[#c8aa6e] mt-1 drop-shadow-md" id="job-info-loader"><span class="text-green-500"><i class="fas fa-check"></i> Работа от Алекса</span></p>
                        </div>
                        <span class="text-xs bg-blue-900/80 text-blue-200 px-2 py-0.5 rounded border border-blue-800 backdrop-blur-sm">Ур 3</span>
                    </div>
                    <div>
                        <div class="flex items-center gap-4 mb-3">
                            <div class="text-sm text-[#e0e0e0] flex items-center gap-1 drop-shadow-md">
                                <i class="fas fa-coins"></i> <span id="reward-loader" class="font-bold">6 Золота</span>
                            </div>
                            <div class="text-sm text-blue-400 flex items-center gap-1 drop-shadow-md">
                                <i class="fas fa-star"></i> +2 XP
                            </div>
                            <div class="text-sm text-green-400 flex items-center gap-1 drop-shadow-md">
                                <i class="fas fa-shield-alt"></i> 1% травма
                            </div>
                        </div>
                        <button id="btn-work-loader" onclick="game.work('loader', event)" class="btn-medieval w-full py-2 rounded font-bold shadow-lg">
                            <i class="fas fa-box mr-2"></i> Разгружать
                        </button>
                    </div>
                </div>
            </div>

            <!-- The Field -->
            <div id="job-field" class="panel rounded-lg p-0 relative overflow-hidden h-40 opacity-50 group">
                <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?q=80&w=2070')] bg-cover bg-center opacity-30 group-hover:opacity-40 transition-opacity"></div>
                 <div class="absolute inset-0 p-4 flex flex-col justify-between">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="medieval-font text-lg text-white drop-shadow-md">Пшеничное поле</h3>
                            <p class="text-xs text-gray-300 drop-shadow-md">Сбор урожая под солнцем.</p>
                            <p class="text-xs text-[#c8aa6e] mt-1 drop-shadow-md" id="job-info-field">Требуется: Серп</p>
                        </div>
                        <span class="text-xs bg-gray-800/80 text-gray-400 px-2 py-0.5 rounded border border-gray-700 backdrop-blur-sm">Ур 5</span>
                    </div>
                    
                    <div>
                        <div class="flex items-center gap-4 mb-3">
                            <div class="text-sm text-[#e0e0e0] flex items-center gap-1 drop-shadow-md">
                                <i class="fas fa-wheat-awn"></i> <span id="reward-field" class="font-bold">1-2 Пшеницы</span>
                            </div>
                            <div class="text-sm text-blue-400 flex items-center gap-1 drop-shadow-md">
                                <i class="fas fa-star"></i> +3 XP
                            </div>
                        </div>
                        <button id="btn-work-field" disabled onclick="game.work('field', event)" class="btn-medieval w-full py-2 rounded font-bold flex items-center justify-center gap-2 shadow-lg">
                            <i class="fas fa-lock text-xs"></i> Закрыто
                        </button>
                    </div>
                </div>
            </div>

            <!-- The Mine -->
            <div id="job-mine" class="panel rounded-lg p-0 relative overflow-hidden h-40 opacity-50 group">
                <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1516937963518-0096035d50ac?q=80&w=2070')] bg-cover bg-center opacity-30 group-hover:opacity-40 transition-opacity"></div>
                 <div class="absolute inset-0 p-4 flex flex-col justify-between">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="medieval-font text-lg text-white drop-shadow-md">Железный рудник</h3>
                            <p class="text-xs text-gray-300 drop-shadow-md">Опасная работа в темноте.</p>
                            <p class="text-xs text-[#c8aa6e] mt-1 drop-shadow-md" id="job-info-mine">Требуется: Кирка</p>
                        </div>
                        <span class="text-xs bg-gray-800/80 text-gray-400 px-2 py-0.5 rounded border border-gray-700 backdrop-blur-sm">Ур 15</span>
                    </div>
                    
                    <div>
                        <div class="flex items-center gap-4 mb-3">
                            <div class="text-sm text-[#e0e0e0] flex items-center gap-1 drop-shadow-md">
                                <i class="fas fa-cube"></i> <span id="reward-mine" class="font-bold">1-2 Руды</span>
                            </div>
                            <div class="text-sm text-blue-400 flex items-center gap-1 drop-shadow-md">
                                <i class="fas fa-star"></i> +8 XP
                            </div>
                        </div>
                        <button id="btn-work-mine" disabled onclick="game.work('mine', event)" class="btn-medieval w-full py-2 rounded font-bold flex items-center justify-center gap-2 shadow-lg">
                            <i class="fas fa-lock text-xs"></i> Закрыто
                        </button>
                    </div>
                </div>
            </div>

            <!-- The Hunter -->
            <div id="job-hunter" class="panel rounded-lg p-0 relative overflow-hidden h-40 opacity-50 group">
                <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1599409385627-c37025816b3f?q=80&w=2070')] bg-cover bg-center opacity-40 group-hover:opacity-50 transition-opacity"></div>
                 <div class="absolute inset-0 p-4 flex flex-col justify-between">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="medieval-font text-lg text-white drop-shadow-md">Охота</h3>
                            <p class="text-xs text-gray-300 drop-shadow-md">Добыча шкур в лесу.</p>
                            <p class="text-xs text-[#c8aa6e] mt-1 drop-shadow-md" id="job-info-hunter">Требуется: Арбалет</p>
                        </div>
                        <span class="text-xs bg-red-900/80 text-red-200 px-2 py-0.5 rounded border border-red-800 backdrop-blur-sm">Ур 30</span>
                    </div>
                    
                    <div>
                        <div class="flex items-center gap-4 mb-3">
                            <div class="text-sm text-[#e0e0e0] flex items-center gap-1 drop-shadow-md">
                                <i class="fas fa-scroll"></i> <span id="reward-hunter" class="font-bold">1 Кожа</span>
                            </div>
                            <div class="text-sm text-blue-400 flex items-center gap-1 drop-shadow-md">
                                <i class="fas fa-star"></i> +15 XP
                            </div>
                        </div>
                        <button id="btn-work-hunter" disabled onclick="game.work('hunter', event)" class="btn-medieval w-full py-2 rounded font-bold flex items-center justify-center gap-2 shadow-lg">
                            <i class="fas fa-lock text-xs"></i> Закрыто
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: DARK FOREST -->
        <section id="view-dark-forest" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-gradient-to-br from-purple-950/80 via-[#1a1a1d] to-[#0f0f10]">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(168,85,247,0.2),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-purple-500/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-purple-900/50 bg-black/30 flex items-center justify-center text-purple-400 hover:bg-purple-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-900/60 to-purple-950 flex items-center justify-center border-2 border-purple-500/60 shadow-[0_0_15px_rgba(168,85,247,0.4)]">
                        <i class="fas fa-tree text-purple-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-purple-300 drop-shadow-md">Тёмный Лес</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-4 space-y-4 bg-gradient-to-b from-[#1a1a1d] to-[#100b14] border-purple-900/30">
                <div class="text-center">
                    <p class="text-sm text-[#e0e0e0]">Мрачные деревья скрывают опасности...</p>
                    <p class="text-xs text-purple-400">И редкие ингредиенты.</p>
                </div>

                <!-- Forest NPC -->
                <div class="panel p-3 rounded flex items-center justify-between border-purple-900/30 bg-purple-900/10">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full border border-purple-500 bg-[#222] flex items-center justify-center">
                            <i class="fas fa-hood-cloak text-purple-400"></i>
                        </div>
                        <div>
                            <div class="text-sm text-[#e0e0e0] font-bold">Элара</div>
                            <div class="text-[10px] text-[#a0a0a0]">Следопыт</div>
                        </div>
                    </div>
                    <button onclick="dialogue.start('elara')" class="btn-medieval px-4 py-1.5 rounded text-xs">
                        Говорить
                    </button>
                </div>

                <!-- Gather Resources -->
                <div class="p-3 border border-[#333] rounded bg-black/20 flex flex-col gap-2">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded bg-[#222] flex items-center justify-center text-emerald-500">
                                <i class="fas fa-leaf"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-sm text-gray-200">Собирательство</h4>
                                <p class="text-[10px] text-gray-500">Палки, камни, травы и грибы.</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="locations.forestGather(event)" class="btn-medieval w-full py-2 rounded text-xs border-emerald-900 text-emerald-500 hover:bg-emerald-900/20">
                        Искать (-5 HP)
                    </button>
                    <div class="flex justify-between text-[10px] text-gray-500 px-1">
                        <span>Награда: Ресурсы</span>
                        <span>+3 XP</span>
                    </div>
                </div>

                <!-- Hunt Monsters -->
                <div class="p-3 border border-purple-900/50 rounded bg-purple-900/10 flex flex-col gap-2 relative overflow-hidden">
                    <div class="absolute -right-2 -top-2 text-6xl text-purple-900 opacity-20 pointer-events-none">
                        <i class="fas fa-dragon"></i>
                    </div>
                    <div class="flex justify-between items-center z-10">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded bg-[#222] flex items-center justify-center text-red-500 border border-purple-900">
                                <i class="fas fa-skull"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-sm text-gray-200">Охота на чудовищ</h4>
                                <p class="text-[10px] text-gray-500">Углубиться в чащу леса.</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="locations.forestHunt(event)" class="btn-medieval w-full py-2 rounded text-xs border-red-900 text-red-500 hover:bg-red-900/20 z-10">
                        Сразиться (-20 HP)
                    </button>
                    <div class="flex justify-between text-[10px] text-gray-500 px-1 z-10">
                        <span>Награда: Золото/Предметы</span>
                        <span>+20 XP</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: TOWN SQUARE -->
        <section id="view-town-square" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-gradient-to-br from-[#3b1f0b]/85 via-[#1a1a1d] to-[#0f0f10]">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(139,69,19,0.25),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-[#8B4513]/60 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-[#8B4513]/40 bg-black/30 flex items-center justify-center text-[#d2a679] hover:bg-[#8B4513]/20 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-[#5a2d0f]/70 to-[#3b1f0b] flex items-center justify-center border-2 border-[#8B4513]/60 shadow-[0_0_15px_rgba(139,69,19,0.35)]">
                        <i class="fas fa-landmark text-[#c47a2c] text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-[#f5e1c9] drop-shadow-md">Городская площадь</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-6 text-center space-y-4">
                <i class="fas fa-hands text-4xl text-gray-500"></i>
                <div>
                    <p class="text-sm text-[#e0e0e0]">Вы стоите посреди людной площади.</p>
                    <p class="text-xs text-[#a0a0a0]">Иногда прохожие кидают монеты бродягам.</p>
                </div>
                <button onclick="locations.beg(event)" class="btn-medieval w-full py-3 rounded font-bold">
                    <i class="fas fa-hand-holding-medical mr-2"></i> Попрошайничать
                </button>
                <p class="text-[10px] text-gray-600 mb-4">+2 Золота за клик</p>

                <div class="grid grid-cols-2 gap-3 border-t border-[#333] pt-4 mt-2">
                    <div class="flex flex-col items-center">
                        <div class="w-10 h-10 rounded-full border border-[#c8aa6e] bg-[#222] flex items-center justify-center mb-1">
                            <i class="fas fa-user-tie text-[#c8aa6e]"></i>
                        </div>
                        <p class="text-xs text-[#e0e0e0] mb-1">Артур</p>
                        <button onclick="dialogue.start('arthur')" class="btn-medieval w-full py-1.5 rounded text-[10px]">
                            Говорить
                        </button>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="w-10 h-10 rounded-full border border-amber-500 bg-[#222] flex items-center justify-center mb-1">
                            <i class="fas fa-clipboard-list text-amber-400"></i>
                        </div>
                        <p class="text-xs text-[#e0e0e0] mb-1">Доска</p>
                        <button onclick="router.navigate('bulletin')" class="btn-medieval w-full py-1.5 rounded text-[10px]">
                            Смотреть
                        </button>
                    </div>
                </div>
                
                <!-- Book House Button -->
                <div class="mt-4">
                     <button onclick="router.navigate('bookhouse')" class="panel w-full p-3 rounded flex items-center justify-between group hover:border-blue-500 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-[#111] border border-blue-500 flex items-center justify-center">
                                <i class="fas fa-book text-blue-400"></i>
                            </div>
                            <div class="text-left">
                                <div class="text-sm font-bold text-[#e0e0e0]">Книжный Дом</div>
                                <div class="text-[10px] text-[#777]">Рецепты и знания</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-500 group-hover:text-blue-500"></i>
                    </button>
                </div>

                <!-- Tailor Button -->
                <div class="mt-3">
                    <button onclick="router.navigate('tailor')" class="panel w-full p-3 rounded flex items-center justify-between group hover:border-pink-500 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-[#111] border border-pink-500 flex items-center justify-center">
                                <i class="fas fa-shirt text-pink-400"></i>
                            </div>
                            <div class="text-left">
                                <div class="text-sm font-bold text-[#e0e0e0]">Мастерская Портного</div>
                                <div class="text-[10px] text-[#777]">Одежда на заказ</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-500 group-hover:text-pink-500"></i>
                    </button>
                </div>

                <!-- Shoemaker Button -->
                <div class="mt-3">
                    <button onclick="router.navigate('shoemaker')" class="panel w-full p-3 rounded flex items-center justify-between group hover:border-amber-500 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-[#111] border border-amber-500 flex items-center justify-center">
                                <i class="fas fa-shoe-prints text-amber-400"></i>
                            </div>
                            <div class="text-left">
                                <div class="text-sm font-bold text-[#e0e0e0]">Мастерская Сапожника</div>
                                <div class="text-[10px] text-[#777]">Обувь и ремонт</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-500 group-hover:text-amber-500"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- VIEW: BULLETIN BOARD -->
        <section id="view-bulletin" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-gradient-to-br from-amber-950/80 via-[#1a1a1d] to-[#0f0f10]">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(217,119,6,0.15),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-amber-500/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('town-square')" class="w-8 h-8 rounded border border-amber-900/50 bg-black/30 flex items-center justify-center text-amber-400 hover:bg-amber-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-900/60 to-amber-950 flex items-center justify-center border-2 border-amber-500/60 shadow-[0_0_15px_rgba(217,119,6,0.3)]">
                        <i class="fas fa-clipboard-list text-amber-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-amber-300 drop-shadow-md">Доска Объявлений</h2>
                </div>
            </div>

            <div class="panel rounded p-4 space-y-4">
                <div class="text-center mb-4">
                    <i class="fas fa-scroll text-3xl text-amber-500 mb-2"></i>
                    <p class="text-sm text-[#a0a0a0]">Здесь вывешивают объявления о работе и просьбы о помощи.</p>
                </div>

                <!-- Active Bounties/Jobs -->
                <div class="space-y-3">
                    <h3 class="text-xs text-[#777] uppercase border-b border-[#333] pb-1">Срочные заказы</h3>
                    
                    <!-- Bounty 1: Fish -->
                    <div class="border border-[#333] rounded p-3 bg-black/20">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex gap-3">
                                <i class="fas fa-fish text-blue-400 text-lg mt-1"></i>
                                <div>
                                    <div class="text-sm font-bold text-[#e0e0e0]">Рыба для таверны</div>
                                    <div class="text-[10px] text-[#777]">Старый Бен ищет свежую рыбу.</div>
                                    <div class="text-[10px] text-gray-500 mt-1">Нужно: 10 Рыб</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-yellow-500 font-bold">100 <i class="fas fa-coins"></i></div>
                                <div class="text-[10px] text-blue-400">+15 XP</div>
                            </div>
                        </div>
                        <button onclick="bulletin.acceptQuest('fish_delivery')" class="btn-medieval w-full py-1.5 rounded text-[10px]">
                            Взять заказ
                        </button>
                    </div>

                    <!-- Bounty 2: Herbs -->
                    <div class="border border-[#333] rounded p-3 bg-black/20">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex gap-3">
                                <i class="fas fa-leaf text-green-400 text-lg mt-1"></i>
                                <div>
                                    <div class="text-sm font-bold text-[#e0e0e0]">Травы для лекаря</div>
                                    <div class="text-[10px] text-[#777]">Мариусу нужны свежие травы.</div>
                                    <div class="text-[10px] text-gray-500 mt-1">Нужно: 8 Трав</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-yellow-500 font-bold">80 <i class="fas fa-coins"></i></div>
                                <div class="text-[10px] text-blue-400">+10 XP</div>
                            </div>
                        </div>
                        <button onclick="bulletin.acceptQuest('herbs_delivery')" class="btn-medieval w-full py-1.5 rounded text-[10px]">
                            Взять заказ
                        </button>
                    </div>

                    <!-- Bounty 3: Ore -->
                    <div class="border border-[#333] rounded p-3 bg-black/20">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex gap-3">
                                <i class="fas fa-cube text-gray-400 text-lg mt-1"></i>
                                <div>
                                    <div class="text-sm font-bold text-[#e0e0e0]">Руда для кузнеца</div>
                                    <div class="text-[10px] text-[#777]">Горну нужна железная руда.</div>
                                    <div class="text-[10px] text-gray-500 mt-1">Нужно: 5 Руды</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-yellow-500 font-bold">200 <i class="fas fa-coins"></i></div>
                                <div class="text-[10px] text-blue-400">+25 XP</div>
                            </div>
                        </div>
                        <button onclick="bulletin.acceptQuest('ore_delivery')" class="btn-medieval w-full py-1.5 rounded text-[10px]">
                            Взять заказ
                        </button>
                    </div>
                </div>

                <!-- Community Notices -->
                <div class="space-y-2 mt-4">
                    <h3 class="text-xs text-[#777] uppercase border-b border-[#333] pb-1">Объявления</h3>
                    
                    <div class="border border-[#333] rounded p-2 bg-black/10 text-[10px] text-gray-400">
                        <i class="fas fa-thumbtack text-red-400 mr-1"></i> "Осторожно! В лесу видели волков." — Стража
                    </div>
                    <div class="border border-[#333] rounded p-2 bg-black/10 text-[10px] text-gray-400">
                        <i class="fas fa-thumbtack text-yellow-400 mr-1"></i> "Куплю кожу. Хорошо плачу." — Бронник
                    </div>
                    <div class="border border-[#333] rounded p-2 bg-black/10 text-[10px] text-gray-400">
                        <i class="fas fa-thumbtack text-blue-400 mr-1"></i> "Ищу помощника на ферму. Обращаться в деревню." — Фермер
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: TAILOR -->
        <section id="view-tailor" class="hidden space-y-4">
            <div class="h-16 w-full relative rounded-lg mb-4 overflow-hidden bg-[#1a1a1d]">
                <div class="absolute inset-0 bg-gradient-to-r from-pink-900/20 to-transparent"></div>
                <div class="absolute top-4 left-4 flex items-center gap-3">
                    <button onclick="router.navigate('town-square')" class="w-8 h-8 rounded border border-[#333] bg-black/50 flex items-center justify-center text-[#a0a0a0] backdrop-blur-sm">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h2 class="medieval-font text-xl text-pink-400 drop-shadow-lg">Мастерская Портного</h2>
                </div>
            </div>

            <!-- Tailor NPC -->
            <div class="panel p-3 mb-4 rounded flex items-center justify-between border-pink-900/30 bg-pink-900/10">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full border border-pink-500 bg-[#222] flex items-center justify-center">
                        <i class="fas fa-scissors text-pink-400"></i>
                    </div>
                    <div>
                        <div class="text-sm text-[#e0e0e0] font-bold">Портной Питер</div>
                        <div class="text-[10px] text-[#a0a0a0]">Портной</div>
                    </div>
                </div>
                <button onclick="dialogue.start('peter')" class="btn-medieval px-4 py-1.5 rounded text-xs">
                    Говорить
                </button>
            </div>

            <div class="panel rounded p-4 space-y-3">
                <h3 class="medieval-font text-sm text-[#c8aa6e]">Одежда на заказ</h3>
                <div class="border border-[#333] rounded p-3 bg-black/20">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-3">
                            <i class="fas fa-shirt text-[#c8aa6e] text-xl mt-1"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">Одежда крестьянина</div>
                                <div class="text-[10px] text-[#777]">Набор простой чистой одежды.</div>
                            </div>
                        </div>
                        <div class="text-sm text-yellow-400 font-bold">5,000 <i class="fas fa-coins"></i></div>
                    </div>
                    <button onclick="game.buyClothes('peasant', 5000)" class="btn-medieval w-full py-1.5 rounded text-[10px]">
                        Купить
                    </button>
                </div>

                <div class="border border-[#333] rounded p-3 bg-black/20">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-3">
                            <i class="fas fa-shirt text-[#c8aa6e] text-xl mt-1"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">Одежда состоятельного</div>
                                <div class="text-[10px] text-[#777]">Для тех, кто любит выглядеть солидно.</div>
                            </div>
                        </div>
                        <div class="text-sm text-yellow-400 font-bold">50,000 <i class="fas fa-coins"></i></div>
                    </div>
                    <button onclick="game.buyClothes('rich', 50000)" class="btn-medieval w-full py-1.5 rounded text-[10px]">
                        Купить
                    </button>
                </div>

                <div class="border border-[#333] rounded p-3 bg-black/20">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-3">
                            <i class="fas fa-crown text-[#c8aa6e] text-xl mt-1"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">Одежда знати</div>
                                <div class="text-[10px] text-[#777]">Высшее качество для истинной элиты.</div>
                            </div>
                        </div>
                        <div class="text-sm text-emerald-400 font-bold">500 <i class="far fa-gem"></i></div>
                    </div>
                    <button onclick="game.buyClothes('noble', 500)" class="btn-medieval w-full py-1.5 rounded text-[10px]">
                        Купить
                    </button>
                </div>
            </div>
        </section>

        <!-- VIEW: SHOEMAKER -->
        <section id="view-shoemaker" class="hidden space-y-4">
            <div class="h-16 w-full relative rounded-lg mb-4 overflow-hidden bg-[#1a1a1d]">
                <div class="absolute inset-0 bg-gradient-to-r from-amber-900/20 to-transparent"></div>
                <div class="absolute top-4 left-4 flex items-center gap-3">
                    <button onclick="router.navigate('town-square')" class="w-8 h-8 rounded border border-[#333] bg-black/50 flex items-center justify-center text-[#a0a0a0] backdrop-blur-sm">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h2 class="medieval-font text-xl text-amber-400 drop-shadow-lg">Мастерская Сапожника</h2>
                </div>
            </div>

            <!-- Shoemaker NPC -->
            <div class="panel p-3 mb-4 rounded flex items-center justify-between border-amber-900/30 bg-amber-900/10">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full border border-amber-500 bg-[#222] flex items-center justify-center">
                        <i class="fas fa-shoe-prints text-amber-400"></i>
                    </div>
                    <div>
                        <div class="text-sm text-[#e0e0e0] font-bold">Сапожник Лорен</div>
                        <div class="text-[10px] text-[#a0a0a0]">Мастер обуви</div>
                    </div>
                </div>
                <button onclick="dialogue.start('shoemaker')" class="btn-medieval px-4 py-1.5 rounded text-xs">
                    Говорить
                </button>
            </div>

            <div class="panel rounded p-4 space-y-3">
                <h3 class="medieval-font text-sm text-[#c8aa6e]">Обувь на заказ</h3>

                <div class="border border-[#333] rounded p-3 bg-black/20">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-3">
                            <i class="fas fa-shoe-prints text-amber-400 text-xl mt-1"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">Ботинки крестьянина</div>
                                <div class="text-[10px] text-[#777]">Простая крепкая обувь для дороги.</div>
                            </div>
                        </div>
                        <div class="text-sm text-yellow-400 font-bold">4,000 <i class="fas fa-coins"></i></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="shoemaker.buyShoes('peasant')" class="btn-medieval w-full py-1.5 rounded text-[10px]">Купить</button>
                        <button onclick="shoemaker.sellShoes('peasant')" class="btn-medieval w-full py-1.5 rounded text-[10px] border-amber-700 text-amber-300">Продать</button>
                    </div>
                </div>

                <div class="border border-[#333] rounded p-3 bg-black/20">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-3">
                            <i class="fas fa-shoe-prints text-emerald-400 text-xl mt-1"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">Качественные ботинки</div>
                                <div class="text-[10px] text-[#777]">Удобные, мягкие и прочные.</div>
                            </div>
                        </div>
                        <div class="text-sm text-emerald-400 font-bold">100 <i class="far fa-gem"></i></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="shoemaker.buyShoes('quality')" class="btn-medieval w-full py-1.5 rounded text-[10px]">Купить</button>
                        <button onclick="shoemaker.sellShoes('quality')" class="btn-medieval w-full py-1.5 rounded text-[10px] border-emerald-700 text-emerald-300">Продать</button>
                    </div>
                </div>

                <div class="border border-[#333] rounded p-3 bg-black/20">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-3">
                            <i class="fas fa-crown text-yellow-400 text-xl mt-1"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">Элитные ботинки</div>
                                <div class="text-[10px] text-[#777]">Для тех, кто ценит роскошь.</div>
                            </div>
                        </div>
                        <div class="text-sm text-emerald-400 font-bold">300 <i class="far fa-gem"></i></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="shoemaker.buyShoes('elite')" class="btn-medieval w-full py-1.5 rounded text-[10px]">Купить</button>
                        <button onclick="shoemaker.sellShoes('elite')" class="btn-medieval w-full py-1.5 rounded text-[10px] border-yellow-700 text-yellow-300">Продать</button>
                    </div>
                </div>

                <div class="panel p-3 rounded bg-black/20 border border-[#333] text-[10px] text-[#a0a0a0]">
                    <i class="fas fa-info-circle text-amber-400 mr-1"></i> Старую обувь можно сдать за половину стоимости.
                </div>
            </div>
        </section>

        <!-- VIEW: BOOK HOUSE -->
        <section id="view-bookhouse" class="hidden space-y-4">
            <div class="h-16 w-full relative rounded-lg mb-4 overflow-hidden bg-[#1a1a1d]">
                <div class="absolute inset-0 bg-gradient-to-r from-blue-900/20 to-transparent"></div>
                <div class="absolute top-4 left-4 flex items-center gap-3">
                    <button onclick="router.navigate('town-square')" class="w-8 h-8 rounded border border-[#333] bg-black/50 flex items-center justify-center text-[#a0a0a0] backdrop-blur-sm">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h2 class="medieval-font text-xl text-blue-400 drop-shadow-lg">Книжный Дом</h2>
                </div>
            </div>

            <!-- Book House NPC -->
            <div class="panel p-3 mb-4 rounded flex items-center justify-between border-blue-900/30 bg-blue-900/10">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full border border-pink-500 bg-[#222] flex items-center justify-center">
                        <i class="fas fa-feather text-pink-400"></i>
                    </div>
                    <div>
                        <div class="text-sm text-[#e0e0e0] font-bold">Лили</div>
                        <div class="text-[10px] text-[#a0a0a0]">Хранительница знаний</div>
                    </div>
                </div>
                <button onclick="dialogue.start('lili')" class="btn-medieval px-4 py-1.5 rounded text-xs">
                    Говорить
                </button>
            </div>

            <div class="panel rounded p-4 space-y-4">
                <h3 class="medieval-font text-sm text-[#c8aa6e] border-b border-[#333] pb-2">Рецепты в продаже</h3>
                
                <!-- Food Recipe -->
                <div class="border border-[#333] rounded p-3 bg-black/20">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-3">
                            <i class="fas fa-drumstick-bite text-amber-400 text-xl mt-1"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">Рецепт: Жаркое</div>
                                <div class="text-[10px] text-[#777]">Готовьте еду из мяса. +30 HP</div>
                                <div class="text-[10px] text-gray-500 mt-1">Требуется: 2 Мяса</div>
                            </div>
                        </div>
                        <div class="text-sm text-emerald-400 font-bold">50 <i class="far fa-gem"></i></div>
                    </div>
                    <button id="btn-buy-recipe-food" onclick="game.buyRecipe('food', 50)" class="btn-medieval w-full py-1.5 rounded text-[10px]">
                        Купить Рецепт
                    </button>
                </div>

                <!-- Sword Recipe -->
                <div class="border border-[#333] rounded p-3 bg-black/20">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-3">
                            <i class="fas fa-gavel text-gray-400 text-xl mt-1"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">Рецепт: Самодельный Меч</div>
                                <div class="text-[10px] text-[#777]">Создайте простое оружие. +5 Урона</div>
                                <div class="text-[10px] text-gray-500 mt-1">Требуется: 3 Руды, 2 Палки</div>
                            </div>
                        </div>
                        <div class="text-sm text-emerald-400 font-bold">100 <i class="far fa-gem"></i></div>
                    </div>
                    <button id="btn-buy-recipe-sword" onclick="game.buyRecipe('sword', 100)" class="btn-medieval w-full py-1.5 rounded text-[10px]">
                        Купить Рецепт
                    </button>
                </div>

                <!-- Leather Armor Recipe -->
                <div class="border border-[#333] rounded p-3 bg-black/20">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-3">
                            <i class="fas fa-vest text-amber-600 text-xl mt-1"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">Рецепт: Кожаная Броня</div>
                                <div class="text-[10px] text-[#777]">Защитная броня из кожи. +10 Защиты</div>
                                <div class="text-[10px] text-gray-500 mt-1">Требуется: 5 Кожи</div>
                            </div>
                        </div>
                        <div class="text-sm text-emerald-400 font-bold">150 <i class="far fa-gem"></i></div>
                    </div>
                    <button id="btn-buy-recipe-armor" onclick="game.buyRecipe('armor', 150)" class="btn-medieval w-full py-1.5 rounded text-[10px]">
                        Купить Рецепт
                    </button>
                </div>

                <!-- Upgraded Bag Recipe -->
                <div class="border border-[#333] rounded p-3 bg-black/20">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-3">
                            <i class="fas fa-suitcase text-yellow-500 text-xl mt-1"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">Рецепт: Улучшенная Сумка</div>
                                <div class="text-[10px] text-[#777]">Больше места в инвентаре. +8 слотов</div>
                                <div class="text-[10px] text-gray-500 mt-1">Требуется: 3 Кожи, 2 Палки</div>
                            </div>
                        </div>
                        <div class="text-sm text-emerald-400 font-bold">200 <i class="far fa-gem"></i></div>
                    </div>
                    <button id="btn-buy-recipe-bag" onclick="game.buyRecipe('bag', 200)" class="btn-medieval w-full py-1.5 rounded text-[10px]">
                        Купить Рецепт
                    </button>
                </div>
            </div>
        </section>

        <!-- VIEW: HEALER -->
        <section id="view-healer" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-gradient-to-br from-red-950/80 via-[#1a1a1d] to-[#0f0f10]">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(239,68,68,0.15),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-red-500/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-red-900/50 bg-black/30 flex items-center justify-center text-red-400 hover:bg-red-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-900/60 to-red-950 flex items-center justify-center border-2 border-red-500/60 shadow-[0_0_15px_rgba(239,68,68,0.3)]">
                        <i class="fas fa-mortar-pestle text-red-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-red-300 drop-shadow-md">Хижина Лекаря</h2>
                </div>
            </div>

            <!-- NPC Marius -->
            <div class="panel p-3 mb-4 rounded flex items-center justify-between border-red-900/30 bg-red-900/10">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full border border-red-500 bg-[#222] overflow-hidden">
                         <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Marius&backgroundColor=1a1a1d&skinColor=ecad80&hair=long02&hairColor=3e3e42" alt="Мариус" class="w-full h-full object-cover">
                    </div>
                    <div>
                        <div class="text-sm text-[#e0e0e0] font-bold">Мариус</div>
                        <div class="text-[10px] text-[#a0a0a0]">Алхимик</div>
                    </div>
                </div>
                <button onclick="dialogue.start('marius')" class="btn-medieval px-4 py-1.5 rounded text-xs">
                    Говорить
                </button>
            </div>

            <!-- Healing Service -->
            <div class="panel rounded p-4 space-y-3">
                <h3 class="medieval-font text-sm text-[#c8aa6e]">Лечение</h3>
                <div class="flex items-center justify-between">
                    <div class="text-xs text-[#a0a0a0]">Восстановить здоровье</div>
                    <div class="text-xs text-yellow-500">50 <i class="fas fa-coins"></i></div>
                </div>
                <button onclick="game.heal(50, 50)" class="btn-medieval w-full py-2 rounded text-xs text-red-400 border-red-900 hover:bg-red-900/20">
                    <i class="fas fa-heart mr-2"></i> +50 HP
                </button>
            </div>

            <!-- Recipes Shop -->
            <div class="panel rounded p-4 space-y-4">
                <h3 class="medieval-font text-sm text-[#c8aa6e]">Тайные Знания (Рецепты)</h3>
                
                <!-- Immortality Recipe -->
                <div class="border border-[#333] rounded p-2 bg-black/20">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-2">
                            <i class="fas fa-scroll text-purple-400 mt-1"></i>
                            <div>
                                <div class="text-xs font-bold text-[#e0e0e0]">Зелье Бессмертия</div>
                                <div class="text-[10px] text-[#777]">Неуязвимость на 2 минуты.</div>
                            </div>
                        </div>
                        <div class="text-xs text-emerald-400 font-bold">100 <i class="far fa-gem"></i></div>
                    </div>
                    <button id="btn-buy-recipe-immortality" onclick="game.buyRecipe('immortality', 100)" class="btn-medieval w-full py-1.5 rounded text-[10px]">
                        Купить Рецепт
                    </button>
                </div>

                <!-- Luck Recipe -->
                <div class="border border-[#333] rounded p-2 bg-black/20">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-2">
                            <i class="fas fa-scroll text-green-400 mt-1"></i>
                            <div>
                                <div class="text-xs font-bold text-[#e0e0e0]">Зелье Удачи</div>
                                <div class="text-[10px] text-[#777]">x2 Добыча на 2 минуты.</div>
                            </div>
                        </div>
                        <div class="text-xs text-emerald-400 font-bold">50 <i class="far fa-gem"></i></div>
                    </div>
                    <button id="btn-buy-recipe-luck" onclick="game.buyRecipe('luck', 50)" class="btn-medieval w-full py-1.5 rounded text-[10px]">
                        Купить Рецепт
                    </button>
                </div>
            </div>

            <!-- Crafting Station (Visible if recipes unlocked) -->
            <div id="healer-crafting-station" class="hidden panel rounded p-4 space-y-3 border-t-2 border-[#c8aa6e]">
                <h3 class="medieval-font text-sm text-[#c8aa6e]">Алхимический Стол</h3>
                
                <div id="craft-action-immortality" class="hidden flex justify-between items-center bg-[#111] p-2 rounded">
                    <div class="text-xs text-purple-400">Зелье Бессмертия</div>
                    <button onclick="game.activateEffect('immortality')" class="bg-[#222] border border-purple-500 text-purple-500 px-3 py-1 rounded text-[10px] hover:bg-purple-900/30">
                        Использовать (10 трав)
                    </button>
                </div>

                <div id="craft-action-luck" class="hidden flex justify-between items-center bg-[#111] p-2 rounded">
                    <div class="text-xs text-green-400">Зелье Удачи</div>
                    <button onclick="game.activateEffect('luck')" class="bg-[#222] border border-green-500 text-green-500 px-3 py-1 rounded text-[10px] hover:bg-green-900/30">
                        Использовать (5 грибов)
                    </button>
                </div>
            </div>
        </section>

        <!-- VIEW: TREASURY -->
        <section id="view-treasury" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-gradient-to-br from-yellow-950/80 via-[#1a1a1d] to-[#0f0f10]">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(234,179,8,0.2),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-yellow-500/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-yellow-900/50 bg-black/30 flex items-center justify-center text-yellow-400 hover:bg-yellow-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-yellow-900/60 to-yellow-950 flex items-center justify-center border-2 border-yellow-500/60 shadow-[0_0_15px_rgba(234,179,8,0.3)]">
                        <i class="fas fa-coins text-yellow-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-yellow-300 drop-shadow-md">Казна</h2>
                </div>
            </div>

            <!-- Bank Info -->
            <div class="panel rounded-lg p-4 flex items-center justify-between bg-[#101012]">
                <div>
                    <div class="text-xs text-[#a0a0a0] uppercase">В сейфе</div>
                    <div class="text-xl font-bold text-[#c8aa6e]">
                        <i class="fas fa-lock text-xs mr-1"></i> <span id="bank-display">0</span>
                    </div>
                </div>
                <i class="fas fa-shield-alt text-2xl text-[#333]"></i>
            </div>

            <!-- Deposit/Withdraw -->
            <div class="panel rounded-lg p-4 space-y-3">
                <h3 class="text-sm font-bold text-[#e0e0e0] border-b border-[#333] pb-2">Хранилище</h3>


                <div class="mt-2 space-y-2">
                    <div class="flex items-center justify-between text-[10px] text-[#777]">
                        <div>На руках: <span id="wallet-display" class="text-[#c8aa6e] font-bold">0</span></div>
                        <div>В сейфе: <span class="text-[#c8aa6e] font-bold" id="bank-display-mini">0</span></div>
                    </div>

                    <div class="flex gap-2">
                        <input id="bank-amount-input" type="number" min="1" step="1" placeholder="Сумма" class="w-full bg-[#111] border border-[#333] text-center text-xs text-white rounded p-2 outline-none focus:border-[#c8aa6e]">
                        <button onclick="locations.treasurySetMax('deposit', event)" class="px-3 bg-[#222] border border-[#444] rounded text-xs text-gray-400 hover:text-white">Max</button>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="locations.treasuryDepositAmount(event)" class="btn-medieval py-2 text-xs rounded">
                            Положить
                        </button>
                        <button onclick="locations.treasuryWithdrawAmount(event)" class="btn-medieval py-2 text-xs rounded">
                            Снять
                        </button>
                    </div>

                    <div class="flex justify-end">
                        <button onclick="locations.treasurySetMax('withdraw', event)" class="text-[10px] text-gray-500 underline underline-offset-2 hover:text-[#c8aa6e]">Max для снятия</button>
                    </div>
                </div>

                <p class="text-[10px] text-center text-[#777]">Деньги в сейфе защищены от краж.</p>
            </div>

            <!-- Exchange -->
            <div class="panel rounded-lg p-4 space-y-3">
                <h3 class="text-sm font-bold text-[#e0e0e0] border-b border-[#333] pb-2">Обмен Валюты</h3>
                <div class="flex justify-between items-center bg-[#000] p-2 rounded border border-[#333]">
                    <div class="flex items-center gap-2">
                        <i class="far fa-gem text-emerald-400"></i>
                        <span class="font-bold">1</span>
                    </div>
                    <i class="fas fa-arrow-right text-gray-600"></i>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-coins text-yellow-500"></i>
                        <span class="font-bold">1000</span>
                    </div>
                </div>
                <button onclick="locations.treasuryExchange(event)" class="btn-medieval w-full py-2 rounded text-sm">
                    Обменять
                </button>
            </div>
        </section>

        <!-- VIEW: TAVERN -->
        <section id="view-tavern" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-gradient-to-br from-orange-950/80 via-[#1a1a1d] to-[#0f0f10]">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(249,115,22,0.2),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-orange-500/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-orange-900/50 bg-black/30 flex items-center justify-center text-orange-400 hover:bg-orange-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-orange-900/60 to-orange-950 flex items-center justify-center border-2 border-orange-500/60 shadow-[0_0_15px_rgba(249,115,22,0.3)]">
                        <i class="fas fa-beer-mug-empty text-orange-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-orange-300 drop-shadow-md">Таверна</h2>
                </div>
            </div>

            <!-- Tavern NPC -->
            <div class="panel p-3 mb-4 rounded flex items-center justify-between border-orange-900/30 bg-orange-900/10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full border border-orange-500 bg-[#222] flex items-center justify-center">
                        <i class="fas fa-wine-glass text-orange-400"></i>
                    </div>
                    <div>
                        <div class="text-sm text-[#e0e0e0] font-bold">Старый Бен</div>
                        <div class="text-[10px] text-[#a0a0a0]">Трактирщик</div>
                    </div>
                </div>
                <button onclick="dialogue.start('ben')" class="btn-medieval px-4 py-1.5 rounded text-xs">
                    Слухи
                </button>
            </div>

            <!-- Rent Room -->
            <div class="panel rounded-lg p-4 relative overflow-hidden">
                <div class="absolute right-0 top-0 p-4 opacity-20">
                    <i class="fas fa-bed text-6xl"></i>
                </div>
                <h3 class="medieval-font text-lg text-[#e0e0e0]">Ночлег</h3>
                <p class="text-xs text-[#a0a0a0] mb-3 w-3/4">Восстанавливает 100% здоровья.</p>
                <div class="flex items-center gap-2 mb-3 text-sm">
                    <span class="text-[#c8aa6e]">Цена: 20</span> <i class="far fa-gem text-emerald-400"></i> / сутки
                </div>
                <button id="btn-rent-room" onclick="locations.tavernRent()" class="btn-medieval w-full py-2 rounded text-sm">
                    Снять комнату
                </button>
                <p id="rent-status" class="text-xs text-green-500 mt-2 hidden">
                    <i class="fas fa-check-circle"></i> Комната оплачена
                </p>
            </div>

            <!-- Brawl Night -->
            <div class="panel rounded-lg p-4 relative overflow-hidden border-orange-900/40 bg-orange-900/10">
                <div class="absolute -right-6 -top-6 text-7xl text-orange-900/30 pointer-events-none">
                    <i class="fas fa-hand-fist"></i>
                </div>
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <h3 class="medieval-font text-lg text-orange-300">Кулачные бои</h3>
                        <p class="text-[10px] text-[#a0a0a0]">Раз в час. Ставки и слава.</p>
                    </div>
                    <div class="text-[10px] text-[#c8aa6e] uppercase tracking-wider">Арена</div>
                </div>
                <div class="panel p-2 rounded bg-black/40 border border-[#333] text-[10px] text-[#a0a0a0] mb-3">
                    Победа даёт золото и репутацию, поражение — травмы. Требуется 20+ HP.
                </div>
                <div class="flex items-center justify-between text-[10px] text-[#777] mb-3">
                    <span>До следующего боя:</span>
                    <span id="brawl-timer" class="text-[#c8aa6e] font-mono">Доступно</span>
                </div>
                <button id="btn-brawl" onclick="locations.tavernBrawl(event)" class="btn-medieval w-full py-2 rounded font-bold border-orange-500 text-orange-300">
                    Выйти на бой
                </button>
            </div>

            <!-- Food & Thomas Event -->
            <div class="panel rounded-lg p-4 space-y-3">
                <h3 class="medieval-font text-lg text-[#c8aa6e]">Горячая еда</h3>
                <p class="text-xs text-[#a0a0a0]">Восстанавливает 100% здоровья.</p>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="locations.tavernEat('stew')" class="panel p-2 rounded flex flex-col items-center bg-[#222] border border-[#333] hover:border-[#c8aa6e] transition-colors group">
                        <i class="fas fa-bowl-food text-orange-400 text-2xl mb-2 group-hover:scale-110 transition-transform"></i>
                        <span class="text-xs text-[#e0e0e0] font-bold">Мясное рагу</span>
                        <span class="text-[10px] text-yellow-500 mt-1">100 <i class="fas fa-coins"></i></span>
                    </button>
                    <button onclick="locations.tavernEat('soup')" class="panel p-2 rounded flex flex-col items-center bg-[#222] border border-[#333] hover:border-[#c8aa6e] transition-colors group">
                        <i class="fas fa-utensils text-yellow-200 text-2xl mb-2 group-hover:scale-110 transition-transform"></i>
                        <span class="text-xs text-[#e0e0e0] font-bold">Куриный суп</span>
                        <span class="text-[10px] text-yellow-500 mt-1">100 <i class="fas fa-coins"></i></span>
                    </button>
                </div>
            </div>

            <!-- Wheel of Fortune -->
            <div class="panel rounded-lg p-4 text-center space-y-4 overflow-hidden relative">
                <h3 class="medieval-font text-lg text-[#c8aa6e]">Колесо Удачи</h3>
                
                <div class="relative w-48 h-48 mx-auto my-4">
                    <div id="wheel" class="w-full h-full rounded-full border-4 border-[#c8aa6e] relative bg-[#222] shadow-[0_0_20px_rgba(0,0,0,0.5)] flex items-center justify-center overflow-hidden wheel-container">
                        <div class="absolute inset-0 opacity-20 bg-[conic-gradient(#444_0deg_36deg,#222_36deg_72deg,#444_72deg_108deg,#222_108deg_144deg,#444_144deg_180deg,#222_180deg_216deg,#444_216deg_252deg,#222_252deg_288deg,#444_288deg_324deg,#222_324deg_360deg)]"></div>
                        <i class="fas fa-dice text-4xl text-[#555]"></i>
                    </div>
                    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-2 text-[#c8aa6e] z-10 text-2xl">
                        <i class="fas fa-caret-down"></i>
                    </div>
                </div>

                <div class="text-sm text-[#a0a0a0]">
                    Цена: <span class="text-emerald-400 font-bold">1 <i class="far fa-gem"></i></span>
                </div>

                <div class="grid grid-cols-2 gap-2 text-[10px] text-gray-500 text-left px-2">
                    <div>10 <i class="far fa-gem text-emerald-400"></i> (10%)</div>
                    <div>100 <i class="far fa-gem text-emerald-400"></i> (1%)</div>
                    <div>10к <i class="fas fa-coins text-yellow-500"></i> (15%)</div>
                    <div>5к <i class="fas fa-coins text-yellow-500"></i> (25%)</div>
                    <div class="col-span-2 text-center">1к <i class="fas fa-coins text-yellow-500"></i> (49%)</div>
                </div>

                <button id="btn-spin" onclick="locations.tavernSpin()" class="btn-medieval w-full py-2 rounded font-bold">
                    Крутить!
                </button>
            </div>
        </section>

        <!-- VIEW: MARKET -->
        <section id="view-market" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-gradient-to-br from-amber-950/80 via-[#1a1a1d] to-[#0f0f10]">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(217,119,6,0.15),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-amber-500/50 to-transparent"></div>
                <div class="absolute top-1/2 left-4 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-900/60 to-amber-950 flex items-center justify-center border-2 border-amber-500/60 shadow-[0_0_15px_rgba(217,119,6,0.3)]">
                        <i class="fas fa-store text-amber-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-amber-300 drop-shadow-md">Торговые ряды</h2>
                </div>
            </div>

            <!-- Market NPC -->
            <div class="panel p-3 mb-4 rounded flex items-center justify-between border-blue-900/30 bg-blue-900/10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full border border-gray-500 bg-[#222] flex items-center justify-center">
                        <i class="fas fa-hammer text-gray-400"></i>
                    </div>
                    <div>
                        <div class="text-sm text-[#e0e0e0] font-bold">Горн</div>
                        <div class="text-[10px] text-[#a0a0a0]">Кузнец</div>
                    </div>
                </div>
                <button onclick="dialogue.start('gorn')" class="btn-medieval px-4 py-1.5 rounded text-xs">
                    Говорить
                </button>
            </div>

            <!-- Market Tabs -->
            <div class="flex items-center gap-2 overflow-x-auto pb-2 mb-2 no-scrollbar">
                <button onclick="market.switchCategory('tools')" id="tab-market-tools" class="sub-tab active">Инструменты</button>
                <button onclick="market.switchCategory('armor')" id="tab-market-armor" class="sub-tab">Бронник</button>
                <button onclick="market.switchCategory('weapons')" id="tab-market-weapons" class="sub-tab">Мечник</button>
                <button onclick="market.switchCategory('horses')" id="tab-market-horses" class="sub-tab">Конюшня</button>
            </div>

            <!-- Content: Tools -->
            <div id="market-tools" class="space-y-3">
                <!-- Rod -->
                <div class="panel p-3 rounded flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-[#222] border border-[#333] rounded flex items-center justify-center text-[#c8aa6e]">
                            <i class="fas fa-wand-magic"></i>
                        </div>
                        <div>
                            <div class="text-[#e0e0e0] font-serif">Удочка</div>
                            <div class="text-xs text-[#a0a0a0]">Позволяет ловить рыбу</div>
                            <div class="text-xs text-blue-400" id="market-lvl-rod">Ур: 0</div>
                        </div>
                    </div>
                    <button id="btn-buy-rod" onclick="market.buyOrUpgradeTool('rod')" class="bg-[#111] border border-[#333] px-3 py-1.5 text-xs text-[#c8aa6e] rounded hover:border-[#c8aa6e]">
                        <span id="price-rod">50</span> <i class="fas fa-coins text-[10px]"></i>
                    </button>
                </div>
                <!-- Sickle -->
                <div class="panel p-3 rounded flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-[#222] border border-[#333] rounded flex items-center justify-center text-[#c8aa6e]">
                            <i class="fas fa-sickle"></i>
                        </div>
                        <div>
                            <div class="text-[#e0e0e0] font-serif">Серп</div>
                            <div class="text-xs text-[#a0a0a0]">Позволяет собирать пшеницу</div>
                            <div class="text-xs text-blue-400" id="market-lvl-sickle">Ур: 0</div>
                        </div>
                    </div>
                    <button id="btn-buy-sickle" onclick="market.buyOrUpgradeTool('sickle')" class="bg-[#111] border border-[#333] px-3 py-1.5 text-xs text-[#c8aa6e] rounded hover:border-[#c8aa6e]">
                        <span id="price-sickle">500</span> <i class="fas fa-coins text-[10px]"></i>
                    </button>
                </div>
                <!-- Pickaxe -->
                <div class="panel p-3 rounded flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-[#222] border border-[#333] rounded flex items-center justify-center text-[#c8aa6e]">
                            <i class="fas fa-hammer"></i>
                        </div>
                        <div>
                            <div class="text-[#e0e0e0] font-serif">Кирка</div>
                            <div class="text-xs text-[#a0a0a0]">Позволяет добывать руду</div>
                            <div class="text-xs text-blue-400" id="market-lvl-pickaxe">Ур: 0</div>
                        </div>
                    </div>
                    <button id="btn-buy-pickaxe" onclick="market.buyOrUpgradeTool('pickaxe')" class="bg-[#111] border border-[#333] px-3 py-1.5 text-xs text-[#c8aa6e] rounded hover:border-[#c8aa6e]">
                        <span id="price-pickaxe">2000</span> <i class="fas fa-coins text-[10px]"></i>
                    </button>
                </div>
                 <!-- Crossbow -->
                 <div class="panel p-3 rounded flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-[#222] border border-[#333] rounded flex items-center justify-center text-[#c8aa6e]">
                            <i class="fas fa-crosshairs"></i>
                        </div>
                        <div>
                            <div class="text-[#e0e0e0] font-serif">Арбалет</div>
                            <div class="text-xs text-[#a0a0a0]">Позволяет добывать шкуры</div>
                            <div class="text-xs text-blue-400" id="market-lvl-crossbow">Ур: 0</div>
                        </div>
                    </div>
                    <button id="btn-buy-crossbow" onclick="market.buyOrUpgradeTool('crossbow')" class="bg-[#111] border border-[#333] px-3 py-1.5 text-xs text-[#c8aa6e] rounded hover:border-[#c8aa6e]">
                        <span id="price-crossbow">5000</span> <i class="fas fa-coins text-[10px]"></i>
                    </button>
                </div>
                <!-- Sword -->
                 <div class="panel p-3 rounded flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-[#222] border border-[#333] rounded flex items-center justify-center text-[#c8aa6e]">
                            <i class="fas fa-khanda"></i>
                        </div>
                        <div>
                            <div class="text-[#e0e0e0] font-serif">Меч</div>
                            <div class="text-xs text-[#a0a0a0]">Оружие для защиты</div>
                            <div class="text-xs text-blue-400" id="market-lvl-sword">Ур: 0</div>
                        </div>
                    </div>
                    <button id="btn-buy-sword" onclick="market.buyOrUpgradeTool('sword')" class="bg-[#111] border border-[#333] px-3 py-1.5 text-xs text-[#c8aa6e] rounded hover:border-[#c8aa6e]">
                        <span id="price-sword">1000</span> <i class="fas fa-coins text-[10px]"></i>
                    </button>
                </div>
            </div>

            <!-- Content: Placeholders -->
            <div id="market-placeholder" class="hidden flex flex-col items-center justify-center py-10 opacity-50">
                <i class="fas fa-dungeon text-4xl mb-3 text-gray-600"></i>
                <p class="text-sm text-gray-500">Этот торговец еще не прибыл в город.</p>
            </div>

            <!-- Resources Trade -->
            <div class="panel rounded-lg p-4 mt-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="medieval-font text-sm text-[#c8aa6e]">Материалы</h3>
                    <div class="flex gap-2">
                        <button onclick="market.switchTradeMode('sell')" id="market-trade-sell" class="sub-tab active">Продажа</button>
                        <button onclick="market.switchTradeMode('buy')" id="market-trade-buy" class="sub-tab">Покупка</button>
                    </div>
                </div>

                <div id="market-trade-grid" class="grid grid-cols-2 gap-3">
                    <div class="panel p-2 rounded flex flex-col items-center text-center border-blue-900/30 bg-blue-900/10">
                        <i class="fas fa-fish text-[#c8aa6e] mb-1"></i>
                        <div class="text-xs text-[#e0e0e0]">Рыба</div>
                        <div class="text-[10px] text-[#a0a0a0] mb-1"><span id="price-fish">5</span> <i class="fas fa-coins"></i></div>
                        <div class="text-[10px] text-blue-300 mb-1">У вас: <span id="market-count-fish">0</span></div>
                        <div class="flex gap-1 w-full mb-1">
                            <input id="trade-input-fish" type="number" min="1" value="1" class="w-full bg-[#111] border border-[#333] text-center text-[10px] text-white rounded p-0 outline-none focus:border-[#c8aa6e]">
                            <button onclick="market.setMax('fish')" class="w-auto px-2 bg-[#222] border border-[#444] rounded text-[10px] text-gray-400 hover:text-white">Max</button>
                        </div>
                        <button onclick="market.sellFromInput('fish')" id="btn-trade-fish" class="w-full bg-[#2c2c30] border border-[#c8aa6e] rounded text-[10px] py-1 text-[#c8aa6e] hover:bg-[#c8aa6e] hover:text-black transition-colors uppercase">Продать</button>
                    </div>
                    <div class="panel p-2 rounded flex flex-col items-center text-center border-yellow-900/30 bg-yellow-900/10">
                        <i class="fas fa-wheat-awn text-[#c8aa6e] mb-1"></i>
                        <div class="text-xs text-[#e0e0e0]">Пшеница</div>
                        <div class="text-[10px] text-[#a0a0a0] mb-1"><span id="price-wheat">15</span> <i class="fas fa-coins"></i></div>
                        <div class="text-[10px] text-blue-300 mb-1">У вас: <span id="market-count-wheat">0</span></div>
                        <div class="flex gap-1 w-full mb-1">
                            <input id="trade-input-wheat" type="number" min="1" value="1" class="w-full bg-[#111] border border-[#333] text-center text-[10px] text-white rounded p-0 outline-none focus:border-[#c8aa6e]">
                            <button onclick="market.setMax('wheat')" class="w-auto px-2 bg-[#222] border border-[#444] rounded text-[10px] text-gray-400 hover:text-white">Max</button>
                        </div>
                        <button onclick="market.sellFromInput('wheat')" id="btn-trade-wheat" class="w-full bg-[#2c2c30] border border-[#c8aa6e] rounded text-[10px] py-1 text-[#c8aa6e] hover:bg-[#c8aa6e] hover:text-black transition-colors uppercase">Продать</button>
                    </div>
                    <div class="panel p-2 rounded flex flex-col items-center text-center border-gray-700/30 bg-gray-700/10">
                        <i class="fas fa-cube text-[#c8aa6e] mb-1"></i>
                        <div class="text-xs text-[#e0e0e0]">Руда</div>
                        <div class="text-[10px] text-[#a0a0a0] mb-1"><span id="price-ore">40</span> <i class="fas fa-coins"></i></div>
                        <div class="text-[10px] text-blue-300 mb-1">У вас: <span id="market-count-ore">0</span></div>
                        <div class="flex gap-1 w-full mb-1">
                            <input id="trade-input-ore" type="number" min="1" value="1" class="w-full bg-[#111] border border-[#333] text-center text-[10px] text-white rounded p-0 outline-none focus:border-[#c8aa6e]">
                            <button onclick="market.setMax('ore')" class="w-auto px-2 bg-[#222] border border-[#444] rounded text-[10px] text-gray-400 hover:text-white">Max</button>
                        </div>
                        <button onclick="market.sellFromInput('ore')" id="btn-trade-ore" class="w-full bg-[#2c2c30] border border-[#c8aa6e] rounded text-[10px] py-1 text-[#c8aa6e] hover:bg-[#c8aa6e] hover:text-black transition-colors uppercase">Продать</button>
                    </div>
                    <div class="panel p-2 rounded flex flex-col items-center text-center border-red-900/30 bg-red-900/10">
                        <i class="fas fa-scroll text-[#c8aa6e] mb-1"></i>
                        <div class="text-xs text-[#e0e0e0]">Кожа</div>
                        <div class="text-[10px] text-[#a0a0a0] mb-1"><span id="price-leather">100</span> <i class="fas fa-coins"></i></div>
                        <div class="text-[10px] text-blue-300 mb-1">У вас: <span id="market-count-leather">0</span></div>
                        <div class="flex gap-1 w-full mb-1">
                            <input id="trade-input-leather" type="number" min="1" value="1" class="w-full bg-[#111] border border-[#333] text-center text-[10px] text-white rounded p-0 outline-none focus:border-[#c8aa6e]">
                            <button onclick="market.setMax('leather')" class="w-auto px-2 bg-[#222] border border-[#444] rounded text-[10px] text-gray-400 hover:text-white">Max</button>
                        </div>
                        <button onclick="market.sellFromInput('leather')" id="btn-trade-leather" class="w-full bg-[#2c2c30] border border-[#c8aa6e] rounded text-[10px] py-1 text-[#c8aa6e] hover:bg-[#c8aa6e] hover:text-black transition-colors uppercase">Продать</button>
                    </div>
                    <div class="panel p-2 rounded flex flex-col items-center text-center border-amber-900/30 bg-amber-900/10">
                        <i class="fas fa-tree text-[#c8aa6e] mb-1"></i>
                        <div class="text-xs text-[#e0e0e0]">Палки</div>
                        <div class="text-[10px] text-[#a0a0a0] mb-1"><span id="price-wood">5</span> <i class="fas fa-coins"></i></div>
                        <div class="text-[10px] text-blue-300 mb-1">У вас: <span id="market-count-wood">0</span></div>
                        <div class="flex gap-1 w-full mb-1">
                            <input id="trade-input-wood" type="number" min="1" value="1" class="w-full bg-[#111] border border-[#333] text-center text-[10px] text-white rounded p-0 outline-none focus:border-[#c8aa6e]">
                            <button onclick="market.setMax('wood')" class="w-auto px-2 bg-[#222] border border-[#444] rounded text-[10px] text-gray-400 hover:text-white">Max</button>
                        </div>
                        <button onclick="market.sellFromInput('wood')" id="btn-trade-wood" class="w-full bg-[#2c2c30] border border-[#c8aa6e] rounded text-[10px] py-1 text-[#c8aa6e] hover:bg-[#c8aa6e] hover:text-black transition-colors uppercase">Продать</button>
                    </div>
                    <div class="panel p-2 rounded flex flex-col items-center text-center border-gray-600/30 bg-gray-600/10">
                        <i class="fas fa-shapes text-gray-400 mb-1"></i>
                        <div class="text-xs text-[#e0e0e0]">Камни</div>
                        <div class="text-[10px] text-[#a0a0a0] mb-1"><span id="price-stone">5</span> <i class="fas fa-coins"></i></div>
                        <div class="text-[10px] text-blue-300 mb-1">У вас: <span id="market-count-stone">0</span></div>
                        <div class="flex gap-1 w-full mb-1">
                            <input id="trade-input-stone" type="number" min="1" value="1" class="w-full bg-[#111] border border-[#333] text-center text-[10px] text-white rounded p-0 outline-none focus:border-[#c8aa6e]">
                            <button onclick="market.setMax('stone')" class="w-auto px-2 bg-[#222] border border-[#444] rounded text-[10px] text-gray-400 hover:text-white">Max</button>
                        </div>
                        <button onclick="market.sellFromInput('stone')" id="btn-trade-stone" class="w-full bg-[#2c2c30] border border-[#c8aa6e] rounded text-[10px] py-1 text-[#c8aa6e] hover:bg-[#c8aa6e] hover:text-black transition-colors uppercase">Продать</button>
                    </div>
                    <div class="panel p-2 rounded flex flex-col items-center text-center border-green-900/30 bg-green-900/10">
                        <i class="fas fa-leaf text-green-400 mb-1"></i>
                        <div class="text-xs text-[#e0e0e0]">Травы</div>
                        <div class="text-[10px] text-[#a0a0a0] mb-1"><span id="price-herbs">10</span> <i class="fas fa-coins"></i></div>
                        <div class="text-[10px] text-blue-300 mb-1">У вас: <span id="market-count-herbs">0</span></div>
                        <div class="flex gap-1 w-full mb-1">
                            <input id="trade-input-herbs" type="number" min="1" value="1" class="w-full bg-[#111] border border-[#333] text-center text-[10px] text-white rounded p-0 outline-none focus:border-[#c8aa6e]">
                            <button onclick="market.setMax('herbs')" class="w-auto px-2 bg-[#222] border border-[#444] rounded text-[10px] text-gray-400 hover:text-white">Max</button>
                        </div>
                        <button onclick="market.sellFromInput('herbs')" id="btn-trade-herbs" class="w-full bg-[#2c2c30] border border-[#c8aa6e] rounded text-[10px] py-1 text-[#c8aa6e] hover:bg-[#c8aa6e] hover:text-black transition-colors uppercase">Продать</button>
                    </div>
                    <div class="panel p-2 rounded flex flex-col items-center text-center border-purple-900/30 bg-purple-900/10">
                        <i class="fas fa-spider text-purple-400 mb-1"></i>
                        <div class="text-xs text-[#e0e0e0]">Грибы</div>
                        <div class="text-[10px] text-[#a0a0a0] mb-1"><span id="price-mushrooms">25</span> <i class="fas fa-coins"></i></div>
                        <div class="text-[10px] text-blue-300 mb-1">У вас: <span id="market-count-mushrooms">0</span></div>
                        <div class="flex gap-1 w-full mb-1">
                            <input id="trade-input-mushrooms" type="number" min="1" value="1" class="w-full bg-[#111] border border-[#333] text-center text-[10px] text-white rounded p-0 outline-none focus:border-[#c8aa6e]">
                            <button onclick="market.setMax('mushrooms')" class="w-auto px-2 bg-[#222] border border-[#444] rounded text-[10px] text-gray-400 hover:text-white">Max</button>
                        </div>
                        <button onclick="market.sellFromInput('mushrooms')" id="btn-trade-mushrooms" class="w-full bg-[#2c2c30] border border-[#c8aa6e] rounded text-[10px] py-1 text-[#c8aa6e] hover:bg-[#c8aa6e] hover:text-black transition-colors uppercase">Продать</button>
                    </div>
                </div>
            </div>

        </section>

        <!-- VIEW: VILLAGE -->
        <section id="view-village" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-gradient-to-br from-[#0b2b17]/85 via-[#1a1a1d] to-[#0f0f10]">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(0,128,0,0.25),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-[#008000]/60 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-[#008000]/40 bg-black/30 flex items-center justify-center text-[#7ad37a] hover:bg-[#008000]/20 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-[#0f4a26]/70 to-[#0b2b17] flex items-center justify-center border-2 border-[#008000]/60 shadow-[0_0_15px_rgba(0,128,0,0.35)]">
                        <i class="fas fa-house-chimney text-[#3ddc84] text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-[#def7de] drop-shadow-md">Деревня на окраине</h2>
                </div>
            </div>

            <!-- Disease Warning -->
            <div id="measles-warning" class="hidden panel p-3 rounded border-red-500 bg-red-900/20 flex items-center gap-3">
                <i class="fas fa-virus text-red-500 text-xl animate-pulse"></i>
                <div>
                    <div class="text-sm text-red-400 font-bold">Корь!</div>
                    <div class="text-[10px] text-gray-400">-1 HP каждые 20 сек. Посетите мудреца.</div>
                </div>
            </div>

            <!-- Your House -->
            <div class="panel rounded-lg p-4 space-y-3">
                <div class="flex items-center justify-between">
                    <h3 class="medieval-font text-lg text-[#c8aa6e]"><i class="fas fa-home mr-2"></i>Ваш Дом</h3>
                    <span id="house-status" class="text-[10px] text-red-400">Не куплен</span>
                </div>
                
                <div id="house-not-owned" class="text-center py-4">
                    <i class="fas fa-house-circle-xmark text-4xl text-gray-600 mb-2"></i>
                    <p class="text-xs text-gray-400 mb-3">Купите дом, чтобы хранить вещи и заниматься хозяйством.</p>
                    <button onclick="village.buyHouse()" class="btn-medieval w-full py-2 rounded text-sm">
                        Купить дом <span class="text-emerald-400">1000 <i class="far fa-gem"></i></span>
                    </button>
                </div>

                <div id="house-owned" class="hidden space-y-3">
                    <!-- Storage -->
                    <div class="border border-[#333] rounded p-2 bg-black/20">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-box text-amber-500"></i>
                            <span class="text-xs text-[#e0e0e0]">Хранилище</span>
                        </div>
                        <p class="text-[10px] text-gray-500">Здесь можно хранить ненужные вещи (в разработке)</p>
                    </div>

                    <!-- Workbench -->
                    <div class="border border-[#333] rounded p-2 bg-black/20">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-gavel text-blue-400"></i>
                            <span class="text-xs text-[#e0e0e0]">Верстак</span>
                        </div>
                        <p class="text-[10px] text-gray-500">Создавайте новые предметы (в разработке)</p>
                    </div>

                    <!-- Pig Pen -->
                    <div class="border border-[#333] rounded p-2 bg-black/20">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-piggy-bank text-pink-400"></i>
                                <span class="text-xs text-[#e0e0e0]">Свинарник (Ур <span id="pig-pen-level">0</span>)</span>
                            </div>
                            <span class="text-[10px] text-gray-400">Мясо: <span id="meat-count">0</span></span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="village.upgradePigPen()" class="flex-1 bg-[#222] border border-pink-500 text-pink-400 py-1 rounded text-[10px] hover:bg-pink-900/30">
                                Улучшить (100 <i class="fas fa-coins"></i>)
                            </button>
                            <button onclick="village.collectMeat()" class="flex-1 bg-[#222] border border-[#c8aa6e] text-[#c8aa6e] py-1 rounded text-[10px] hover:bg-[#c8aa6e]/20">
                                Собрать мясо
                            </button>
                        </div>
                    </div>

                    <!-- Stable -->
                    <div class="border border-[#333] rounded p-2 bg-black/20">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-horse text-amber-600"></i>
                            <span class="text-xs text-[#e0e0e0]">Конюшня</span>
                        </div>
                        <p class="text-[10px] text-gray-500" id="stable-status">Пусто. Купите коня на рынке.</p>
                    </div>
                </div>
            </div>

            <!-- Sage's House -->
            <div class="panel rounded-lg p-4 space-y-3">
                <h3 class="medieval-font text-lg text-indigo-400"><i class="fas fa-hat-wizard mr-2"></i>Дом Мудреца</h3>
                
                <!-- Sage NPC -->
                <div class="flex items-center justify-between p-2 bg-indigo-900/20 rounded border border-indigo-900/30">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full border border-indigo-500 bg-[#222] flex items-center justify-center">
                            <i class="fas fa-hat-wizard text-indigo-400"></i>
                        </div>
                        <div>
                            <div class="text-sm text-[#e0e0e0] font-bold">Мудрец Эльдар</div>
                            <div class="text-[10px] text-[#a0a0a0]">Хранитель знаний</div>
                        </div>
                    </div>
                    <button onclick="dialogue.start('sage')" class="btn-medieval px-4 py-1.5 rounded text-xs">
                        Говорить
                    </button>
                </div>

                <!-- Cure Measles -->
                <div id="cure-measles-section" class="hidden border border-red-900/50 rounded p-3 bg-red-900/10">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-flask text-red-400"></i>
                        <span class="text-sm text-red-400 font-bold">Лечение от Кори</span>
                    </div>
                    <p class="text-[10px] text-gray-400 mb-2">Мудрец может исцелить вас от страшной болезни.</p>
                    <div class="flex items-center gap-2 text-[10px] text-gray-500 mb-2">
                        <span>Требуется:</span>
                        <span class="text-green-400">15 <i class="fas fa-leaf"></i> Трав</span>
                        <span class="text-purple-400">10 <i class="fas fa-spider"></i> Грибов</span>
                    </div>
                    <button onclick="village.cureMeasles()" class="btn-medieval w-full py-2 rounded text-xs border-red-500 text-red-400">
                        Исцелиться
                    </button>
                </div>

                <!-- Sage's Recipes -->
                <div class="space-y-2">
                    <div class="text-xs text-gray-400 border-b border-[#333] pb-1">Рецепты от Мудреца</div>
                    
                    <div class="border border-[#333] rounded p-2 bg-black/20 flex justify-between items-center">
                        <div class="flex gap-2">
                            <i class="fas fa-scroll text-yellow-400"></i>
                            <div>
                                <div class="text-xs text-[#e0e0e0]">Рецепт: Зелье Силы</div>
                                <div class="text-[10px] text-gray-500">+10 к урону на 5 мин</div>
                            </div>
                        </div>
                        <button class="bg-[#222] border border-[#c8aa6e] text-[#c8aa6e] px-2 py-1 rounded text-[10px]">
                            200 <i class="far fa-gem"></i>
                        </button>
                    </div>

                    <div class="border border-[#333] rounded p-2 bg-black/20 flex justify-between items-center">
                        <div class="flex gap-2">
                            <i class="fas fa-scroll text-cyan-400"></i>
                            <div>
                                <div class="text-xs text-[#e0e0e0]">Рецепт: Зелье Скорости</div>
                                <div class="text-[10px] text-gray-500">+50% скорость работы</div>
                            </div>
                        </div>
                        <button class="bg-[#222] border border-[#c8aa6e] text-[#c8aa6e] px-2 py-1 rounded text-[10px]">
                            150 <i class="far fa-gem"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: TRAINING CAMP -->
        <section id="view-training-camp" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-gradient-to-br from-red-950/80 via-[#1a1a1d] to-[#0f0f10]">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(220,38,38,0.2),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-red-600/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-red-900/50 bg-black/30 flex items-center justify-center text-red-400 hover:bg-red-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-800/60 to-red-950 flex items-center justify-center border-2 border-red-600/60 shadow-[0_0_15px_rgba(220,38,38,0.3)]">
                        <i class="fas fa-shield-halved text-red-500 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-red-300 drop-shadow-md">Учебный Лагерь</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-4 space-y-4 text-center">
                 <p class="text-sm text-[#e0e0e0]">Здесь тренируются лучшие воины королевства.</p>

                 <!-- John NPC -->
                <div class="panel p-3 rounded flex items-center justify-between border-red-900/30 bg-red-900/10 text-left">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full border border-red-500 bg-[#222] flex items-center justify-center">
                            <i class="fas fa-user-shield text-red-400"></i>
                        </div>
                        <div>
                            <div class="text-sm text-[#e0e0e0] font-bold">Рыцарь Джон</div>
                            <div class="text-[10px] text-[#a0a0a0]">Наставник</div>
                        </div>
                    </div>
                    <button onclick="dialogue.start('john')" class="btn-medieval px-4 py-1.5 rounded text-xs">
                        Говорить
                    </button>
                </div>
                
                <div class="p-4 border border-[#333] rounded bg-black/20">
                    <i class="fas fa-dumbbell text-3xl text-gray-600 mb-2"></i>
                    <p class="text-xs text-gray-500">Тренировки временно недоступны.</p>
                </div>
            </div>
        </section>

        <!-- VIEW: ROYAL CASTLE -->
        <section id="view-royal-castle" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-gradient-to-br from-indigo-950/80 via-[#1a1a1d] to-[#0f0f10]">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(99,102,241,0.2),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-indigo-500/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-indigo-900/50 bg-black/30 flex items-center justify-center text-indigo-400 hover:bg-indigo-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-900/60 to-indigo-950 flex items-center justify-center border-2 border-indigo-500/60 shadow-[0_0_15px_rgba(99,102,241,0.3)]">
                        <i class="fas fa-chess-rook text-indigo-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-indigo-300 drop-shadow-md">Королевский замок</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-4 space-y-4">
                <div class="flex items-center justify-between p-3 bg-purple-900/10 rounded border border-purple-900/30">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full border border-purple-500 bg-[#222] flex items-center justify-center">
                            <i class="fas fa-shield text-purple-400"></i>
                        </div>
                        <div>
                            <div class="text-sm text-[#e0e0e0] font-bold">Стражник</div>
                            <div class="text-[10px] text-[#a0a0a0]">Королевская стража</div>
                        </div>
                    </div>
                    <button onclick="dialogue.start('castle_guard')" class="btn-medieval px-4 py-1.5 rounded text-xs">
                        Говорить
                    </button>
                </div>

                <div class="text-center text-xs text-[#777] bg-black/20 border border-[#333] rounded p-3">
                    Вход в замок закрыт для простолюдинов.
                </div>
            </div>
        </section>

        <!-- VIEW: POOR DISTRICT -->
        <section id="view-poor-district" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-gradient-to-br from-stone-900/80 via-[#1a1a1d] to-[#0f0f10]">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(120,113,108,0.15),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-stone-600/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-stone-700/50 bg-black/30 flex items-center justify-center text-stone-400 hover:bg-stone-800/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-stone-800/60 to-stone-950 flex items-center justify-center border-2 border-stone-600/60 shadow-[0_0_15px_rgba(120,113,108,0.2)]">
                        <i class="fas fa-house-crack text-stone-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-stone-300 drop-shadow-md">Район для бедняков</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-4 space-y-4">
                <div class="text-center text-xs text-[#777] bg-black/20 border border-[#333] rounded p-3">
                    Узкие грязные улочки, старые лачуги и отчаянные люди. Здесь выживают, а не живут.
                </div>

                <div class="panel p-3 rounded flex items-center justify-between border-gray-700/30 bg-gray-900/20">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full border border-gray-500 bg-[#222] flex items-center justify-center">
                            <i class="fas fa-hand-holding-medical text-gray-400"></i>
                        </div>
                        <div>
                            <div class="text-sm text-[#e0e0e0] font-bold">Старый нищий</div>
                            <div class="text-[10px] text-[#a0a0a0]">Проситель</div>
                        </div>
                    </div>
                    <button class="btn-medieval px-4 py-1.5 rounded text-xs" onclick="ui.showFloatText(this, 'Скоро...', '#777')">Говорить</button>
                </div>

                <!-- Poor House Section -->
                <div class="panel rounded p-3 space-y-3 border-t border-[#333] bg-black/10">
                    <h3 class="medieval-font text-sm text-gray-400"><i class="fas fa-home mr-2"></i>Старый Дом</h3>
                    
                    <div id="poor-house-buy" class="text-center py-2">
                        <p class="text-xs text-gray-500 mb-2">Ветхая лачуга, но крыша не течёт. Есть хранилище, верстак и печь.</p>
                        <button onclick="housing.buyPoorHouse()" class="btn-medieval w-full py-2 rounded text-sm text-gray-300 border-gray-600">
                            Купить (500 <i class="far fa-gem text-emerald-400"></i>)
                        </button>
                    </div>

                    <div id="poor-house-owned" class="hidden grid grid-cols-3 gap-2">
                        <div class="panel p-2 rounded flex flex-col items-center text-center bg-black/20">
                            <i class="fas fa-box text-amber-700 mb-1"></i>
                            <div class="text-[10px] text-gray-400">Склад</div>
                        </div>
                        <div class="panel p-2 rounded flex flex-col items-center text-center bg-black/20">
                            <i class="fas fa-hammer text-gray-500 mb-1"></i>
                            <div class="text-[10px] text-gray-400">Верстак</div>
                        </div>
                        <div class="panel p-2 rounded flex flex-col items-center text-center bg-black/20">
                            <i class="fas fa-fire text-orange-600 mb-1"></i>
                            <div class="text-[10px] text-gray-400">Печь</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: NOBLE QUARTER -->
        <section id="view-noble-quarter" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-gradient-to-br from-yellow-950/80 via-[#1a1a1d] to-[#0f0f10]">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(234,179,8,0.2),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-yellow-500/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-yellow-900/50 bg-black/30 flex items-center justify-center text-yellow-400 hover:bg-yellow-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-yellow-900/60 to-yellow-950 flex items-center justify-center border-2 border-yellow-500/60 shadow-[0_0_15px_rgba(234,179,8,0.3)]">
                        <i class="fas fa-crown text-yellow-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-yellow-300 drop-shadow-md">Дворянский квартал</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-4 space-y-4">
                <div class="text-center text-xs text-[#777] bg-black/20 border border-[#333] rounded p-3">
                    Мраморные особняки, золотые ворота и надменные взгляды. Здесь правит власть и честь.
                </div>
                <div class="panel p-3 rounded flex items-center justify-between border-yellow-900/30 bg-yellow-900/10">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full border border-yellow-500 bg-[#222] flex items-center justify-center">
                            <i class="fas fa-user-tie text-yellow-400"></i>
                        </div>
                        <div>
                            <div class="text-sm text-[#e0e0e0] font-bold">Советник</div>
                            <div class="text-[10px] text-[#a0a0a0]">Дворянин</div>
                        </div>
                    </div>
                    <button class="btn-medieval px-4 py-1.5 rounded text-xs" onclick="ui.showFloatText(this, 'Скоро...', '#c8aa6e')">Говорить</button>
                </div>

                <!-- Noble House Section -->
                <div class="panel rounded p-3 space-y-3 border-t border-yellow-600/30">
                    <h3 class="medieval-font text-sm text-yellow-500"><i class="fas fa-landmark mr-2"></i>Роскошный Особняк</h3>
                    
                    <div id="noble-house-buy" class="text-center py-2">
                        <p class="text-xs text-yellow-700/70 mb-2">Дом для истинной знати. Галерея, конюшня, оружейная.</p>
                        <button onclick="housing.buyNobleHouse()" class="btn-medieval w-full py-2 rounded text-sm text-yellow-200 border-yellow-600 bg-yellow-900/20">
                            Купить (10,000 <i class="far fa-gem text-emerald-400"></i>)
                        </button>
                    </div>

                    <div id="noble-house-owned" class="hidden space-y-2">
                        <div class="grid grid-cols-2 gap-2">
                            <div class="panel p-2 rounded flex items-center gap-2 bg-black/30 border border-yellow-900/30">
                                <i class="fas fa-palette text-pink-400"></i>
                                <div class="text-[10px] text-gray-300">Галерея Искусств</div>
                            </div>
                            <div class="panel p-2 rounded flex items-center gap-2 bg-black/30 border border-yellow-900/30">
                                <i class="fas fa-shield-halved text-gray-300"></i>
                                <div class="text-[10px] text-gray-300">Оружейная</div>
                            </div>
                            <div class="panel p-2 rounded flex items-center gap-2 bg-black/30 border border-yellow-900/30">
                                <i class="fas fa-horse-head text-amber-600"></i>
                                <div class="text-[10px] text-gray-300">Конюшня (2 места)</div>
                            </div>
                            <div class="panel p-2 rounded flex items-center gap-2 bg-black/30 border border-yellow-900/30">
                                <i class="fas fa-wine-glass text-purple-500"></i>
                                <div class="text-[10px] text-gray-300">Виноградник</div>
                            </div>
                        </div>
                        <div class="panel p-2 rounded flex items-center justify-between bg-black/30 border border-yellow-900/30">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-cow text-white"></i>
                                <div class="text-[10px] text-gray-300">Хозяйство</div>
                            </div>
                            <span class="text-[10px] text-yellow-600">Ур. 1</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: REFUGEE CAMP -->
        <section id="view-refugee-camp" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-gradient-to-br from-slate-900/80 via-[#1a1a1d] to-[#0f0f10]">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(100,116,139,0.15),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-slate-600/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-slate-700/50 bg-black/30 flex items-center justify-center text-slate-400 hover:bg-slate-800/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-slate-800/60 to-slate-950 flex items-center justify-center border-2 border-slate-600/60 shadow-[0_0_15px_rgba(100,116,139,0.2)]">
                        <i class="fas fa-campground text-slate-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-slate-300 drop-shadow-md">Лагерь беженцев</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-4 space-y-4">
                <div class="text-center text-xs text-[#777] bg-black/20 border border-[#333] rounded p-3">
                    Палатки из тряпья, потухшие костры и тихие разговоры о лучшей жизни за границей.
                </div>

                <div class="panel p-3 rounded flex items-center justify-between border-gray-600/30 bg-gray-800/10">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full border border-gray-500 bg-[#222] flex items-center justify-center">
                            <i class="fas fa-user-secret text-gray-400"></i>
                        </div>
                        <div>
                            <div class="text-sm text-[#e0e0e0] font-bold">Томас</div>
                            <div class="text-[10px] text-[#a0a0a0]">Перевозчик</div>
                        </div>
                    </div>
                    <button onclick="dialogue.start('thomas')" class="btn-medieval px-4 py-1.5 rounded text-xs">
                        Говорить
                    </button>
                </div>
            </div>
        </section>

        <!-- VIEW: REFUGEE CAMP -->
        <section id="view-refugee-camp" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-gradient-to-br from-slate-900/80 via-[#1a1a1d] to-[#0f0f10]">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(100,116,139,0.15),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-slate-600/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-slate-700/50 bg-black/30 flex items-center justify-center text-slate-400 hover:bg-slate-800/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-slate-800/60 to-slate-950 flex items-center justify-center border-2 border-slate-600/60 shadow-[0_0_15px_rgba(100,116,139,0.2)]">
                        <i class="fas fa-campground text-slate-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-slate-300 drop-shadow-md">Лагерь беженцев</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-4 space-y-4">
                <div class="text-center text-xs text-[#777] bg-black/20 border border-[#333] rounded p-3">
                    Палатки из тряпья, потухшие костры и тихие разговоры о лучшей жизни за границей.
                </div>

                <div class="panel p-3 rounded flex items-center justify-between border-gray-600/30 bg-gray-800/10">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full border border-gray-500 bg-[#222] flex items-center justify-center">
                            <i class="fas fa-user-secret text-gray-400"></i>
                        </div>
                        <div>
                            <div class="text-sm text-[#e0e0e0] font-bold">Томас</div>
                            <div class="text-[10px] text-[#a0a0a0]">Перевозчик</div>
                        </div>
                    </div>
                    <button onclick="dialogue.start('thomas')" class="btn-medieval px-4 py-1.5 rounded text-xs">
                        Говорить
                    </button>
                </div>
            </div>
        </section>

        <!-- VIEW: QUESTS -->
        <section id="view-quests" class="hidden space-y-4">
            <!-- Quests Header -->
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-gradient-to-br from-amber-950/80 via-[#1a1a1d] to-[#0f0f10]">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(217,119,6,0.15),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-amber-500/50 to-transparent"></div>
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-900/60 to-amber-950 flex items-center justify-center border-2 border-amber-500/60 shadow-[0_0_15px_rgba(217,119,6,0.3)]">
                        <i class="fas fa-scroll text-amber-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-amber-300 drop-shadow-md">Задания</h2>
                </div>
            </div>
             
             <!-- Quest Tabs -->
             <div class="flex items-center justify-center gap-2 overflow-x-auto pb-2 mb-4 no-scrollbar">
                <button onclick="quests.switchTab('daily')" id="tab-quests-daily" class="sub-tab active">Ежедневные</button>
                <button onclick="quests.switchTab('character')" id="tab-quests-character" class="sub-tab">Персонажи</button>
            </div>

            <div id="quests-list" class="space-y-3 pb-20">
                <!-- Quests populated by JS -->
            </div>
        </section>

    </main>

    <!-- Bottom Navigation -->
    <nav class="h-16 bg-[#141417] border-t border-[#333] flex justify-around items-center z-30 shrink-0 shadow-[0_-5px_15px_rgba(0,0,0,0.5)]">
        <button onclick="router.switchTab('map')" class="nav-item flex-1 flex flex-col items-center justify-center h-full text-[#777] hover:text-[#c8aa6e] transition-colors" id="nav-map">
            <i class="fas fa-map-marked-alt mb-1 text-lg"></i>
            <span class="text-[10px] uppercase tracking-wider font-serif">Карта</span>
        </button>
        <button onclick="router.switchTab('market')" class="nav-item flex-1 flex flex-col items-center justify-center h-full text-[#777] hover:text-[#c8aa6e] transition-colors" id="nav-market">
            <i class="fas fa-shopping-bag mb-1 text-lg"></i>
            <span class="text-[10px] uppercase tracking-wider font-serif">Рынок</span>
        </button>
        <button onclick="router.switchTab('quests')" class="nav-item flex-1 flex flex-col items-center justify-center h-full text-[#777] hover:text-[#c8aa6e] transition-colors" id="nav-quests">
            <i class="fas fa-scroll mb-1 text-lg"></i>
            <span class="text-[10px] uppercase tracking-wider font-serif">Задания</span>
        </button>
        <button onclick="router.switchTab('character')" class="nav-item active flex-1 flex flex-col items-center justify-center h-full text-[#777] hover:text-[#c8aa6e] transition-colors" id="nav-character">
            <i class="fas fa-user-shield mb-1 text-lg"></i>
            <span class="text-[10px] uppercase tracking-wider font-serif">Герой</span>
        </button>
    </nav>

    <script>
        // --- CONSTANTS ---
        const TOOLS_DB = {
            rod: { id: 'rod', name: 'Удочка', baseCost: 50, icon: 'fa-wand-magic', job: 'port' },
            sickle: { id: 'sickle', name: 'Серп', baseCost: 500, icon: 'fa-sickle', job: 'field' },
            pickaxe: { id: 'pickaxe', name: 'Кирка', baseCost: 2000, icon: 'fa-hammer', job: 'mine' },
            crossbow: { id: 'crossbow', name: 'Арбалет', baseCost: 5000, icon: 'fa-crosshairs', job: 'hunter' },
            sword: { id: 'sword', name: 'Меч', baseCost: 1000, icon: 'fa-khanda', job: 'guard' }
        };

        const JOBS_DB = {
            port: { name: 'Порт', resource: 'fish', price: 5, xp: 1, tool: 'rod', injuryChance: 0.04 },
            loader: { name: 'Грузчик', resource: 'gold', price: 6, xp: 2, tool: null, levelReq: 3, injuryChance: 0.04, requiresAlex: true },
            field: { name: 'Поле', resource: 'wheat', price: 15, xp: 3, tool: 'sickle', levelReq: 5 },
            mine: { name: 'Рудник', resource: 'ore', price: 40, xp: 8, tool: 'pickaxe', levelReq: 15 },
            hunter: { name: 'Охота', resource: 'leather', price: 100, xp: 15, tool: 'crossbow', levelReq: 30 }
        };
        
        const RESOURCE_NAMES = {
            fish: { name: 'Рыба', icon: 'fa-fish' },
            meat: { name: 'Мясо', icon: 'fa-drumstick-bite' },
            mushrooms: { name: 'Грибы', icon: 'fa-umbrella' },
            bread: { name: 'Хлеб', icon: 'fa-bread-slice' },
            eggs: { name: 'Яйца', icon: 'fa-egg' },
            milk: { name: 'Молоко', icon: 'fa-mug-hot' },
            ore: { name: 'Руда', icon: 'fa-cube' },
            bronze: { name: 'Бронза', icon: 'fa-coins' },
            silver: { name: 'Серебро', icon: 'fa-ring' },
            wheat: { name: 'Пшеница', icon: 'fa-wheat-awn' },
            wood: { name: 'Палка', icon: 'fa-tree' },
            stone: { name: 'Камень', icon: 'fa-shapes' },
            herbs: { name: 'Травы', icon: 'fa-leaf' },
            leather: { name: 'Кожа', icon: 'fa-scroll' }
        };

        // --- GAME STATE ---
        const gameState = {
            gold: 0,
            emeralds: 0,
            xp: 0,
            level: 1,
            hp: 100,
            maxHp: 100,
            skillPoints: 0,
            luck: 0,
            agility: 0,
            reputation: 0,
            craftingLevel: 0,
            clothes: {},
            xpToNextLevel: 100,
            
            // Resources
            fish: 0,
            meat: 0,
            mushrooms: 0,
            bread: 0,
            eggs: 0,
            milk: 0,
            ore: 0,
            bronze: 0,
            silver: 0,
            wheat: 0,
            wood: 0,
            stone: 0,
            herbs: 0,
            leather: 0,
            
            inventory: [],
            // Tools State: owns boolean, current level
            tools: {
                rod: { owned: false, level: 0 },
                sickle: { owned: false, level: 0 },
                pickaxe: { owned: false, level: 0 },
                crossbow: { owned: false, level: 0 },
                sword: { owned: false, level: 0 }
            },
            
            // Quests
            activeQuests: [], 
            lastQuestGenTime: 0,
            storyQuests: [], // [{ id, title, desc, goals: {type, target, count}, reward: {gold, xp}, state: 'active'|'claimed' }]
            
            // NPC Memory
            npcStates: {}, // { npcId: { met: bool, stage: int } }
            
            // Port Event Tracking
            portWorkCount: 0,
            oldManEventTriggered: false,
            oldManEventThreshold: 0, // Set randomly 50-100 on first load

            // Village & House
            hasHouse: false,
            pigPenLevel: 0,
            meat: 0,
            lastMeatCollect: 0,
            hasHorse: false,

            // Shoes
            shoes: {
                peasant: false,
                quality: false,
                elite: false
            },
            
            // Disease
            hasMeasles: false,
            lastMeaslesTick: 0,

            // Unconscious
            unconsciousUntil: 0,
            lowHpWarnedAt: 0,

            // Random Events
            treasuryPouchResolved: false,
            bookhousePouchResolved: false,

            // Tavern Brawl
            lastBrawlTime: 0,

            // Features
            bankedGold: 0,
            lastLoginDate: null,
            installDate: null, // Track when user first played
            dailyStreak: 0,
            rentExpiry: 0,
            introShown: false
        };

        // --- NPC DATABASE ---
        const NPC_DB = {
            arthur: {
                name: "Артур",
                role: "Травник",
                icon: "fa-user-tie",
                dialogue: {
                    root: {
                        text: "Здравствуй, путник. Рад видеть, что ты на ногах. Чем могу помочь?",
                        options: [
                            { text: "Как заработать золота?", next: "earn" },
                            { text: "Что это за место?", next: "lore" },
                            { text: "Есть для меня работа?", next: "quest_check" },
                            { text: "Пока", next: "exit" }
                        ]
                    },
                    earn: {
                        text: "Самый простой способ — работать в Порту или на Поле. Но сначала тебе понадобится инструмент. Попроси мелочь на площади, чтобы купить удочку.",
                        options: [{ text: "Понял, спасибо", next: "root" }]
                    },
                    lore: {
                        text: "Это вольный город на границе королевства. Здесь каждый сам за себя, но если трудиться — можно разбогатеть. Остерегайся Темного леса, пока не окрепнешь.",
                        options: [{ text: "Ясно", next: "root" }]
                    },
                    quest_check: function() {
                        if (!hasStoryQuest('q_arthur_1') && !isQuestCompleted('q_arthur_1')) {
                            return "quest_offer";
                        }
                        return "no_quest";
                    },
                    quest_offer: {
                        text: "Мне нужно 3 рыбы для лекарства. Принесешь — заплачу.",
                        options: [
                            { text: "Берусь!", action: "start_q_arthur_1", next: "quest_accepted" },
                            { text: "Не сейчас", next: "root" }
                        ]
                    },
                    quest_accepted: {
                        text: "Отлично. Жду рыбу.",
                        options: [{ text: "Ухожу", next: "exit" }]
                    },
                    no_quest: {
                        text: "Пока ничего нет. Заходи позже.",
                        options: [{ text: "Ладно", next: "root" }]
                    }
                }
            },
            lili: {
                name: "Лили",
                role: "Хозяйка Книжного Дома",
                icon: "fa-feather",
                dialogue: {
                    root: function() {
                        if (!gameState.npcStates) gameState.npcStates = {};
                        gameState.npcStates.lili_visitCount = (gameState.npcStates.lili_visitCount || 0) + 1;
                        if (!gameState.npcStates.lili_invited && gameState.npcStates.lili_visitCount >= 4) {
                            gameState.npcStates.lili_invited = true;
                            game.save();
                            return "invite";
                        }
                        if (gameState.npcStates.lili_gifted) {
                            return "later";
                        }
                        if (gameState.npcStates.lili_waiting) {
                            return "gift";
                        }
                        game.save();
                        return "intro";
                    },
                    intro: {
                        text: "О, привет! Ты явно не местный. Мне нравится твой взгляд — такой уверенный, но чуть потерянный. Я Лили. Этот Дом — моя маленькая крепость знаний. А ты кто?",
                        options: [
                            { text: "Я странник, ищу путь", next: "about_you" },
                            { text: "Просто хочу посмотреть рецепты", next: "recipes" }
                        ]
                    },
                    about_you: {
                        text: "Странник? Звучит романтично. Я люблю истории о таких, как ты. Здесь, в городе, всё крутится вокруг ремесла и торговли. Кто хочет выжить — учится. Кто хочет процветать — учится у меня.",
                        options: [
                            { text: "Расскажи о городе", next: "city" },
                            { text: "А ты сама?", next: "about_me" }
                        ]
                    },
                    city: {
                        text: "Город живёт деньгами и слухами. Порт кормит бедняков, казна хранит золото, таверна — тайны. А я... я даю тем, кто достоин, знание. И иногда — чуточку внимания.",
                        options: [
                            { text: "Мне нужны рецепты", next: "recipes" },
                            { text: "Ты заигрываешь?", next: "flirt" }
                        ]
                    },
                    flirt: {
                        text: "Может быть. Разве это плохо? Город здесь серый, а с тобой немного ярче. Но не обольщайся — знания дороже поцелуев.",
                        options: [
                            { text: "Где твои рецепты?", next: "recipes" },
                            { text: "Вернусь позже", next: "wait" }
                        ]
                    },
                    about_me: {
                        text: "Я родилась здесь и всегда мечтала о большом мире. Но осталась, чтобы хранить книги. Скучно, если честно... Поэтому мне нравится разговаривать с путниками. Вроде тебя.",
                        options: [
                            { text: "Я зайду позже", next: "wait" },
                            { text: "Покажи, что продаешь", next: "recipes" }
                        ]
                    },
                    recipes: {
                        text: "У меня есть рецепты, которые могут сделать тебя сильнее или богаче. Еда, оружие, броня, даже сумка побольше. Все за изумруды — знания бесценны.",
                        options: [
                            { text: "Спасибо, Лили", next: "wait" },
                            { text: "Вернусь позже", next: "wait" }
                        ]
                    },
                    wait: {
                        text: "Загляни чуть позже, хорошо? Мне приятно, когда ты рядом. И, может, у меня появится кое-что интересное для тебя.",
                        options: [
                            { text: "Договорились", action: "lili_wait", next: "exit" }
                        ]
                    },
                    gift: {
                        text: "Ты пришёл! Я скучала... Вот, держи. Это редкий рецепт — кожаное седло для лошади. Если соберёшь коня, пригодится. А теперь... не исчезай снова.",
                        options: [
                            { text: "Спасибо, Лили", action: "lili_gift", next: "exit" },
                            { text: "Я зайду позже", action: "lili_gift", next: "exit" }
                        ]
                    },
                    invite: {
                        text: "Ты часто заходишь, и мне это приятно. Знаешь... я живу в дворянском квартале. Если будешь свободен — загляни ко мне. Отец из высшей знати, но я люблю простые беседы больше приемов.",
                        options: [
                            { text: "Я обязательно приду", action: "start_q_lili_visit", next: "later" },
                            { text: "Спасибо за приглашение", action: "start_q_lili_visit", next: "later" }
                        ]
                    },
                    later: {
                        text: "Ты снова здесь. Я рада. Поболтай со мной ещё, когда устанешь от приключений... Этот дом становится слишком тихим без тебя.",
                        options: [
                            { text: "Я зайду позже", next: "exit" },
                            { text: "До встречи", next: "exit" }
                        ]
                    }
                }
            },
            gorn: {
                name: "Горн",
                role: "Кузнец",
                icon: "fa-hammer",
                dialogue: {
                    root: {
                        text: "Нужна крепкая сталь? Или ищешь работу?",
                        options: [
                            { text: "Хочу купить оружие", next: "shop_hint" },
                            { text: "Есть дело?", next: "quest_check" },
                            { text: "Бывай", next: "exit" }
                        ]
                    },
                    shop_hint: {
                        text: "Смотри вкладку 'Мечник' или 'Бронник' в торговых рядах. Там всё мое добро.",
                        options: [{ text: "Ага", next: "root" }]
                    },
                    quest_check: function() {
                         if (!hasStoryQuest('q_gorn_1') && !isQuestCompleted('q_gorn_1') && gameState.level >= 3) {
                            return "quest_offer";
                        }
                        return "no_quest";
                    },
                    quest_offer: {
                        text: "Мне не хватает руды для заказа. Принеси 5 кусков руды из шахты.",
                        options: [
                            { text: "Сделаю", action: "start_q_gorn_1", next: "quest_accepted" },
                            { text: "Нет кирки", next: "root" }
                        ]
                    },
                    quest_accepted: {
                        text: "Не подведи. Руда нужна чистая.",
                        options: [{ text: "Понял", next: "exit" }]
                    },
                    no_quest: {
                        text: "Работы нет. Приходи, когда станешь опытнее (Ур 3+).",
                        options: [{ text: "Ясно", next: "root" }]
                    }
                }
            },
            ben: {
                name: "Старый Бен",
                role: "Трактирщик",
                icon: "fa-wine-glass",
                dialogue: {
                    root: {
                        text: "Чего желаешь? Эля или комнату?",
                        options: [
                            { text: "Какие слухи?", next: "rumors" },
                            { text: "Комната свободна?", next: "room_hint" },
                            { text: "Ухожу", next: "exit" }
                        ]
                    },
                    rumors: {
                        text: "Говорят, в Темном Лесу видели странные тени. И еще... кто-то разбогател на Колесе Удачи. Но чаще там проигрывают штаны, хе-хе.",
                        options: [{ text: "Интересно", next: "root" }]
                    },
                    room_hint: {
                        text: "Всегда найдется койка за 20 изумрудов. Лечит любые раны.",
                        options: [{ text: "Понял", next: "root" }]
                    }
                }
            },
            elara: {
                name: "Элара",
                role: "Следопыт",
                icon: "fa-hood-cloak",
                dialogue: {
                    root: {
                        text: "Тише. Лес не любит шумных гостей.",
                        options: [
                            { text: "Что ты тут делаешь?", next: "about" },
                            { text: "Нужна помощь?", next: "quest_check" },
                            { text: "Ухожу", next: "exit" }
                        ]
                    },
                    about: {
                        text: "Слежу за балансом. Если убивать слишком много волков, придут чудовища похуже.",
                        options: [{ text: "...", next: "root" }]
                    },
                    quest_check: function() {
                        if (!hasStoryQuest('q_elara_1') && !isQuestCompleted('q_elara_1')) {
                            return "quest_offer";
                        }
                        return "no_quest";
                    },
                    quest_offer: {
                        text: "Мне нужны целебные травы. Собери 5 трав в лесу.",
                        options: [
                            { text: "Поищу", action: "start_q_elara_1", next: "quest_accepted" },
                            { text: "Слишком опасно", next: "root" }
                        ]
                    },
                    quest_accepted: {
                        text: "Будь осторожен. Смотри под ноги.",
                        options: [{ text: "Ладно", next: "exit" }]
                    },
                    no_quest: {
                        text: "Лес спокоен. Пока что.",
                        options: [{ text: "Хорошо", next: "root" }]
                    }
                }
            },
            marius: {
                name: "Мариус",
                role: "Алхимик",
                icon: "fa-user-md",
                dialogue: {
                    root: {
                        text: "Хвори и раны - моя забота. Или ты ищешь знания?",
                        options: [
                            { text: "Мне нужно лечение", next: "heal_hint" },
                            { text: "Что за знания?", next: "recipes_hint" },
                            { text: "Есть поручения?", next: "quest_check" },
                            { text: "Прощай", next: "exit" }
                        ]
                    },
                    heal_hint: {
                        text: "Я могу затянуть твои раны за скромную плату. Кнопка в меню хижины.",
                        options: [{ text: "Понял", next: "root" }]
                    },
                    recipes_hint: {
                        text: "Я продаю древние рецепты зелий. Они даруют силу, недоступную смертным. Если у тебя есть изумруды, конечно.",
                        options: [{ text: "Посмотрю", next: "root" }]
                    },
                    quest_check: function() {
                         if (!hasStoryQuest('q_marius_1') && !isQuestCompleted('q_marius_1')) {
                            return "quest_offer";
                        }
                        return "no_quest";
                    },
                    quest_offer: {
                        text: "Мои запасы трав истощились. Принеси мне 5 пучков редких трав из леса, и я дам тебе скидку... может быть.",
                        options: [
                            { text: "Соберу", action: "start_q_marius_1", next: "quest_accepted" },
                            { text: "Нет времени", next: "root" }
                        ]
                    },
                    quest_accepted: {
                        text: "Травы должны быть свежими. Поторопись.",
                        options: [{ text: "Иду", next: "exit" }]
                    },
                    no_quest: {
                        text: "Пока мне ничего не нужно. Изучай рецепты.",
                        options: [{ text: "Ладно", next: "root" }]
                    }
                }
            },
            john_intro: {
                name: "Рыцарь Джон",
                role: "Воин",
                icon: "fa-user-shield",
                dialogue: {
                    root: {
                        text: "Держи монету, парень. Хм... А в тебе что-то есть. Крепкие руки, ясный взгляд.",
                        options: [
                            { text: "Спасибо, милорд", next: "offer" },
                            { text: "Кто вы?", next: "identity" }
                        ]
                    },
                    identity: {
                        text: "Я Джон, инструктор королевской гвардии. Я ищу таланты даже в сточных канавах.",
                        options: [{ text: "Я не из канавы!", next: "offer" }]
                    },
                    offer: {
                        text: "Слушай. Если хочешь стать настоящим воином, а не побираться тут — приходи в Учебный лагерь. Но сперва окрепни. Получи 15 уровень, и я жду тебя.",
                        options: [
                            { text: "Я приду!", action: "start_q_john_1", next: "accepted" },
                            { text: "Мне и тут неплохо", next: "exit" }
                        ]
                    },
                    accepted: {
                        text: "Слово мужчины. До встречи.",
                        options: [{ text: "До встречи", next: "exit" }]
                    }
                }
            },
            john: {
                name: "Рыцарь Джон",
                role: "Наставник",
                icon: "fa-user-shield",
                dialogue: {
                    root: {
                        text: "Добро пожаловать в лагерь. Готов к тренировкам?",
                        options: [
                            { text: "Я пришел по твоему вызову", next: "check_quest" },
                            { text: "Просто смотрю", next: "exit" }
                        ]
                    },
                    check_quest: function() {
                        if (hasStoryQuest('q_john_1') && !isQuestCompleted('q_john_1')) {
                            // Completing the quest
                            game.completeQuest('q_john_1');
                            return "welcome";
                        }
                        return "training";
                    },
                    welcome: {
                        text: "Молодец. Ты сдержал слово. Вот тебе награда на первое снаряжение. Скоро начнем муштру.",
                        options: [{ text: "Спасибо", next: "exit" }]
                    },
                    training: {
                        text: "Пока что отдыхай. Скоро прибудут новобранцы.",
                        options: [{ text: "Хорошо", next: "exit" }]
                    }
                }
            },
            thomas_intro: {
                name: "Томас",
                role: "Незнакомец",
                icon: "fa-user-secret",
                dialogue: {
                    root: {
                        text: "Приятного аппетита. Вижу, ты при деньгах, раз можешь позволить себе горячее. Не ищешь работу посерьезнее рыбалки?",
                        options: [
                            { text: "Смотря какую", next: "offer" },
                            { text: "Я не ищу проблем", next: "leave" }
                        ]
                    },
                    offer: {
                        text: "Я переправляю беженцев через границу. Дело рисковое, но платят щедро. Приходи в Лагерь беженцев, обсудим. Но запомни: без меча не приходи. В тех краях опасно.",
                        options: [
                            { text: "Я приду", action: "unlock_refugee", next: "exit" }
                        ]
                    },
                    leave: {
                        text: "Твое дело. Если передумаешь — я буду в лагере беженцев. Но нужен меч.",
                        options: [{ text: "Угу", action: "unlock_refugee", next: "exit" }]
                    }
                }
            },
            thomas: {
                name: "Томас",
                role: "Перевозчик",
                icon: "fa-user-secret",
                dialogue: {
                    root: {
                        text: "Ты пришел. Меч принес?",
                        options: [
                            { text: "Да, я готов", next: "check_sword" },
                            { text: "Нет пока", next: "no_sword" }
                        ]
                    },
                    check_sword: function() {
                        if (gameState.tools.sword && gameState.tools.sword.owned) {
                            return "job_start";
                        }
                        return "no_sword";
                    },
                    no_sword: {
                        text: "Я же сказал — без оружия не приходи. Купи на рынке или сделай сам. Возвращайся, когда будешь готов.",
                        options: [{ text: "Ладно", next: "exit" }]
                    },
                    job_start: {
                        text: "Отлично. Меч при тебе. Скоро выдвигаемся. (Продолжение следует...)",
                        options: [{ text: "Жду", next: "exit" }]
                    }
                }
            },
            oldman_port: {
                name: "Старик",
                role: "Бродяга",
                icon: "fa-person-cane",
                dialogue: {
                    root: {
                        text: "Эй, парень... Вижу, ты тут целый день вкалываешь. Устал, небось? У меня есть местечко неподалёку — тихо, тепло. Можешь переночевать, набраться сил. Бесплатно, по доброте душевной.",
                        options: [
                            { text: "Спасибо, дедушка! Пойдём.", action: "accept_oldman", next: "robbery" },
                            { text: "Нет, спасибо. Я сам справлюсь.", next: "refuse" }
                        ]
                    },
                    robbery: {
                        text: "Хе-хе... Наивный дурачок.",
                        options: [{ text: "...", next: "exit" }]
                    },
                    refuse: {
                        text: "Ну, как знаешь... Береги себя, парень.",
                        options: [{ text: "Прощай", next: "exit" }]
                    }
                }
            },
            alex: {
                name: "Алекс",
                role: "Помощник капитана",
                icon: "fa-anchor",
                dialogue: {
                    root: {
                        text: "Эй, ты! Да, ты, рыбак. Вижу, как ты тут каждый день горбатишься. Неплохо справляешься.",
                        options: [
                            { text: "Спасибо. А ты кто?", next: "intro" },
                            { text: "Чего надо?", next: "intro" }
                        ]
                    },
                    intro: {
                        text: "Меня зовут Алекс. Я помощник капитана на торговом судне. Нам нужны крепкие руки — разгружать мешки с зерном. Платим 6 золотых за подход, работа почти безопасная.",
                        options: [
                            { text: "Звучит неплохо! Я в деле.", action: "accept_alex_job", next: "accepted" },
                            { text: "Нет, я лучше рыбачить буду.", next: "refuse" }
                        ]
                    },
                    accepted: {
                        text: "Отлично! Теперь ты можешь работать грузчиком в порту. Найдёшь эту работу в списке. Удачи, парень!",
                        options: [{ text: "Спасибо!", next: "exit" }]
                    },
                    refuse: {
                        text: "Как знаешь. Если передумаешь — я буду здесь.",
                        options: [{ text: "Ладно", next: "exit" }]
                    }
                }
            },
            peter: {
                name: "Питер",
                role: "Портной",
                icon: "fa-scissors",
                dialogue: {
                    root: {
                        text: "Ох, дружище, ты выглядишь как помятый мешок. В этом городе, чтобы тебя уважали, нужно выглядеть опрятно.",
                        options: [
                            { text: "Что ты предлагаешь?", next: "offer" },
                            { text: "Почему это так важно?", next: "why" },
                            { text: "Ладно, ухожу", next: "exit" }
                        ]
                    },
                    why: {
                        text: "Здесь все смотрят на внешний вид. Чистая одежда — первое, что отличает путника от нищего. И новые заказчики любят порядок.",
                        options: [ { text: "Покажи варианты", next: "offer" } ]
                    },
                    offer: {
                        text: "Я могу сшить три комплекта: крестьянин за 5000 золотых, состоятельный за 50000, и одежда знати за 500 изумрудов. Что выберешь?",
                        options: [
                            { text: "Крестьянин (5000 золота)", action: "buy_peasant", next: "root" },
                            { text: "Состоятельный (50000 золота)", action: "buy_rich", next: "root" },
                            { text: "Знать (500 изумрудов)", action: "buy_noble", next: "root" },
                            { text: "Подумаю", next: "exit" }
                        ]
                    }
                }
            },
            librarian: {
                name: "Библиотекарь Генрих",
                role: "Хранитель рецептов",
                icon: "fa-glasses",
                dialogue: {
                    root: {
                        text: "Добро пожаловать в Книжный Дом. Здесь собраны знания со всего королевства.",
                        options: [
                            { text: "Что ты продаёшь?", next: "about_recipes" },
                            { text: "Расскажи о себе", next: "about_self" },
                            { text: "Прощай", next: "exit" }
                        ]
                    },
                    about_recipes: {
                        text: "Я продаю рецепты для крафта. Еда восстановит здоровье, оружие усилит удары, броня защитит, а улучшенная сумка даст больше места для вещей. Всё стоит изумрудов — редкие знания не бесплатны.",
                        options: [{ text: "Понятно", next: "root" }]
                    },
                    about_self: {
                        text: "Я посвятил жизнь сбору знаний. Путешествовал по землям, записывал секреты мастеров. Теперь делюсь ими... за небольшую плату.",
                        options: [{ text: "Интересно", next: "root" }]
                    }
                }
            },
            bandits_village: {
                name: "Бандиты",
                role: "Шайка у трактира",
                icon: "fa-mask",
                dialogue: {
                    root: {
                        text: "Стой, путник. Проход через нашу деревню стоит 200 золотых. Плати — и уйдешь целым.",
                        options: [
                            { text: "Ладно, держите золото", action: "bandits_pay", next: "paid" },
                            { text: "Попытаюсь убежать", action: "bandits_run", next: "robbed" },
                            { text: "Я один из ваших. Золтан меня знает", action: "bandits_bluff", next: "bluff" }
                        ]
                    },
                    paid: {
                        text: "Умно. Проходи. И не возвращайся без пошлины.",
                        options: [{ text: "Ухожу", next: "exit" }]
                    },
                    robbed: {
                        text: "Ха! Бежать вздумал? Слабак.",
                        options: [{ text: "...", next: "exit" }]
                    },
                    bluff: {
                        text: "Золтан? Ах да… прости, брат. Проходи. И не держи зла.",
                        options: [{ text: "Ладно", next: "exit" }]
                    }
                }
            },
            sage: {
                name: "Мудрец Эльдар",
                role: "Хранитель знаний",
                icon: "fa-hat-wizard",
                dialogue: {
                    root: {
                        text: "Приветствую тебя, странник. Я Эльдар, хранитель древних знаний. Чем могу помочь?",
                        options: [
                            { text: "Расскажи о деревне", next: "about_village" },
                            { text: "У тебя есть рецепты?", next: "recipes" },
                            { text: "Мне нужна помощь с болезнью", next: "disease_check" },
                            { text: "Есть задание?", next: "quest_check" },
                            { text: "Прощай", next: "exit" }
                        ]
                    },
                    about_village: {
                        text: "Эта деревня — тихое место вдали от городской суеты. Здесь можно купить дом, завести хозяйство, выращивать свиней. Мясо и кожа — ценные ресурсы.",
                        options: [{ text: "Интересно", next: "root" }]
                    },
                    recipes: {
                        text: "Я продаю редкие рецепты зелий. Зелье Силы усилит твои удары, Зелье Скорости ускорит работу. Но они стоят изумрудов.",
                        options: [{ text: "Посмотрю", next: "root" }]
                    },
                    disease_check: function() {
                        if (gameState.hasMeasles) {
                            return "disease_cure";
                        }
                        return "no_disease";
                    },
                    disease_cure: {
                        text: "Вижу, ты заразился Корью в лесу. Опасная болезнь — она медленно убивает. Принеси мне 15 трав и 10 грибов, и я приготовлю лекарство.",
                        options: [
                            { text: "У меня есть ингредиенты", action: "try_cure", next: "root" },
                            { text: "Пойду соберу", next: "exit" }
                        ]
                    },
                    no_disease: {
                        text: "Ты здоров, странник. Но будь осторожен в Темном Лесу — там можно подхватить Корь.",
                        options: [{ text: "Буду осторожен", next: "root" }]
                    },
                    quest_check: function() {
                        if (!hasStoryQuest('q_sage_1') && !isQuestCompleted('q_sage_1')) {
                            return "quest_offer";
                        }
                        return "no_quest";
                    },
                    quest_offer: {
                        text: "Мне нужны редкие грибы из глубин леса. Принеси 20 грибов, и я щедро награжу тебя.",
                        options: [
                            { text: "Соберу!", action: "start_q_sage_1", next: "quest_accepted" },
                            { text: "Слишком много", next: "root" }
                        ]
                    },
                    quest_accepted: {
                        text: "Будь осторожен в лесу. Грибы растут в самых темных местах.",
                        options: [{ text: "Понял", next: "exit" }]
                    },
                    no_quest: {
                        text: "Пока мне ничего не нужно. Изучай мои рецепты.",
                        options: [{ text: "Хорошо", next: "root" }]
                    }
                }
            },
            castle_guard: {
                name: "Стражник",
                role: "Королевская стража",
                icon: "fa-shield",
                dialogue: {
                    root: {
                        text: "Эй, стой! Тебе здесь не место. Вход только для рыцарей и знати.",
                        options: [
                            { text: "Я просто посмотреть...", next: "dismiss" },
                            { text: "А если я рыцарь?", next: "deny" },
                            { text: "Ухожу", next: "exit" }
                        ]
                    },
                    dismiss: {
                        text: "Сказал же — проваливай. Ты не похож ни на одного из них.",
                        options: [{ text: "Ладно", next: "exit" }]
                    },
                    deny: {
                        text: "Рыцарь? Ха. Смотри в свои лохмотья. Тут таким не место.",
                        options: [{ text: "Понял", next: "exit" }]
                    }
                }
            },
            noble_guard: {
                name: "Стражник квартала",
                role: "Дворцовая охрана",
                icon: "fa-shield-halved",
                dialogue: {
                    root: {
                        text: "Стой. Дворянский квартал не для оборванцев. Переоденься хотя бы в приличную одежду.",
                        options: [
                            { text: "Где взять одежду?", next: "clothes" },
                            { text: "Я уйду", next: "exit" }
                        ]
                    },
                    clothes: {
                        text: "Купи одежду у портного на площади. Чистая рубаха — пропуск в этот район.",
                        options: [{ text: "Понял", next: "exit" }]
                    }
                }
            },
            shoemaker: {
                name: "Лорен",
                role: "Сапожник",
                icon: "fa-shoe-prints",
                dialogue: {
                    root: {
                        text: "Хорошая обувь спасёт от мозолей, дождя и простуды. Без неё ты долго не протянешь в дороге.",
                        options: [
                            { text: "Какая обувь лучше?", next: "advice" },
                            { text: "Я посмотрю товары", next: "exit" }
                        ]
                    },
                    advice: {
                        text: "Чем качественнее обувь, тем больше уважения от горожан. А грязные сапоги — путь к насмешкам.",
                        options: [{ text: "Понял", next: "exit" }]
                    }
                }
            }
        };

        // Helpers for Dialogue
        function hasStoryQuest(id) {
            return (gameState.storyQuests || []).some(q => q.id === id);
        }
        function isQuestCompleted(id) {
            // Check completed history if we added it, for now just check if not active and reward claimed logic
            // Simplified: we'll check a flag in npcStates or just assumed claimed quests are removed or marked
            return (gameState.storyQuests || []).some(q => q.id === id && q.state === 'claimed');
        }

        const dialogue = {
            currentNPC: null,
            
            start: function(npcId) {
                const npc = NPC_DB[npcId];
                if (!npc) return;
                
                this.currentNPC = npcId;
                document.getElementById('npc-name').innerText = npc.name;
                document.getElementById('npc-role').innerText = npc.role;
                
                const iconContainer = document.getElementById('npc-icon').parentNode;
                // Simple color logic
                let colorClass = "border-gray-500";
                if(npcId === 'arthur') colorClass = "border-[#c8aa6e]";
                else if(npcId === 'ben') colorClass = "border-orange-500";
                else if(npcId === 'elara') colorClass = "border-purple-500";
                
                iconContainer.className = `w-12 h-12 rounded-full border ${colorClass} bg-[#222] flex items-center justify-center overflow-hidden shrink-0`;
                document.getElementById('npc-icon').className = `fas ${npc.icon} text-xl text-gray-300`;

                this.renderNode('root');
                document.getElementById('modal-dialogue').classList.add('open');
            },
            
            close: function() {
                document.getElementById('modal-dialogue').classList.remove('open');
                this.currentNPC = null;
            },
            
            renderNode: function(nodeKey) {
                const npc = NPC_DB[this.currentNPC];
                let node = npc.dialogue[nodeKey];
                
                // If node is a function, execute it to get the real node key
                if (typeof node === 'function') {
                    const nextKey = node();
                    node = npc.dialogue[nextKey];
                }

                document.getElementById('npc-text').innerText = node.text;
                
                const optsContainer = document.getElementById('npc-options');
                optsContainer.innerHTML = '';
                
                node.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-2 rounded bg-[#222] hover:bg-[#333] border border-[#333] text-xs text-[#c8aa6e] transition-colors";
                    btn.innerText = `> ${opt.text}`;
                    btn.onclick = () => {
                        if (opt.action) this.handleAction(opt.action);
                        
                        if (opt.next === 'exit') this.close();
                        else this.renderNode(opt.next);
                    };
                    optsContainer.appendChild(btn);
                });
            },
            
            handleAction: function(action) {
                if (action === 'start_q_arthur_1') {
                    this.addQuest('q_arthur_1', 'Просьба Артура', 'Принести 3 рыбы Артуру.', {type: 'gather', target: 'fish', count: 3}, {gold: 50, xp: 10});
                }
                if (action === 'start_q_gorn_1') {
                    this.addQuest('q_gorn_1', 'Руда для Кузнеца', 'Добыть 5 руды для Горна.', {type: 'gather', target: 'ore', count: 5}, {gold: 250, xp: 50});
                }
                if (action === 'start_q_elara_1') {
                    this.addQuest('q_elara_1', 'Лесные травы', 'Собрать 5 трав для Элары.', {type: 'gather', target: 'herbs', count: 5}, {gold: 100, xp: 30});
                }
                if (action === 'start_q_john_1') {
                    this.addQuest('q_john_1', 'Путь Воина', 'Достичь 15 уровня и прийти в Учебный лагерь.', {type: 'visit', target: 'camp', count: 1}, {gold: 500, xp: 100});
                }
                if (action === 'start_q_marius_1') {
                    this.addQuest('q_marius_1', 'Травы для Мариуса', 'Собрать 5 трав.', {type: 'gather', target: 'herbs', count: 5}, {gold: 75, xp: 25});
                }
                if (action === 'accept_oldman') {
                    const stolenGold = gameState.gold;
                    gameState.gold = 0;
                    const damage = Math.floor(Math.random() * 20) + 30;
                    gameState.hp = Math.max(1, gameState.hp - damage);
                    game.addReputation(-5, document.body);
                    game.save();
                    ui.updateStats();
                    setTimeout(() => {
                        ui.showFloatText(document.body, `Ограбление! -${stolenGold} золота`, "#ff5555");
                        setTimeout(() => {
                            ui.showFloatText(document.body, `-${damage} HP (Удар камнем!)`, "#ef4444");
                        }, 500);
                    }, 300);
                }
                if (action === 'accept_alex_job') {
                    if (!gameState.npcStates) gameState.npcStates = {};
                    gameState.npcStates.alex_job_unlocked = true;
                    game.save();
                    ui.showFloatText(document.body, "Новая работа: Грузчик!", "#fbbf24");
                    ui.updateJobs();
                }
                if (action === 'buy_peasant') {
                    game.buyClothes('peasant', 5000);
                }
                if (action === 'buy_rich') {
                    game.buyClothes('rich', 50000);
                }
                if (action === 'buy_noble') {
                    game.buyClothes('noble', 500);
                }
                if (action === 'start_q_sage_1') {
                    this.addQuest('q_sage_1', 'Грибы для Мудреца', 'Собрать 20 грибов для Эльдара.', {type: 'gather', target: 'mushrooms', count: 20}, {gold: 300, xp: 80});
                }
                if (action === 'unlock_refugee') {
                    if (!gameState.npcStates) gameState.npcStates = {};
                    gameState.npcStates.thomas_met = true;
                    game.save();
                    ui.updateLocations();
                    ui.showFloatText(document.body, "Лагерь беженцев открыт", "#fbbf24");
                }
                if (action === 'try_cure') {
                    village.cureMeasles();
                }
                if (action === 'bandits_pay') {
                    gameState.gold = Math.max(0, gameState.gold - 200);
                    gameState.npcStates.villageBanditsDone = true;
                    game.addReputation(1, document.body);
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(document.body, "-200 Золота", "#ff5555");
                }
                if (action === 'bandits_run') {
                    gameState.gold = Math.max(0, gameState.gold - 200);
                    gameState.hp = Math.max(1, gameState.hp - 30);
                    gameState.npcStates.villageBanditsDone = true;
                    game.addReputation(-2, document.body);
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(document.body, "-200 Золота", "#ff5555");
                    setTimeout(() => ui.showFloatText(document.body, "-30 HP", "#ef4444"), 400);
                }
                if (action === 'bandits_bluff') {
                    gameState.npcStates.villageBanditsDone = true;
                    game.addReputation(-1, document.body);
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(document.body, "Отпущен без платы", "#34d399");
                }
                if (action === 'lili_wait') {
                    if (!gameState.npcStates) gameState.npcStates = {};
                    gameState.npcStates.lili_waiting = true;
                    gameState.npcStates.lili_wait_time = Date.now();
                    game.save();
                }
                if (action === 'lili_gift') {
                    if (!gameState.npcStates) gameState.npcStates = {};
                    gameState.npcStates.lili_gifted = true;
                    gameState.npcStates.lili_waiting = false;
                    if (!gameState.recipes) gameState.recipes = {};
                    gameState.recipes.saddle = true;
                    game.addReputation(2, document.body);
                    game.save();
                    ui.showFloatText(document.body, "Рецепт: Кожаное седло", "#34d399");
                }
                if (action === 'start_q_lili_visit') {
                    this.addQuest('q_lili_visit', 'Приглашение Лили', 'Навестить Лили в Дворянском квартале.', {type: 'visit', target: 'noble-quarter', count: 1}, {gold: 0, xp: 50});
                }
            },
            
            addQuest: function(id, title, desc, goals, reward) {
                if (!gameState.storyQuests) gameState.storyQuests = [];
                gameState.storyQuests.push({
                    id: id,
                    title: title,
                    desc: desc,
                    goals: goals, // Using 'sell' type logic for gathering just for tracking simplicity or create new type
                    current: 0,
                    reward: reward,
                    state: 'active'
                });
                game.save();
                ui.showFloatText(document.body, "Новое задание!", "#fbbf24");
            },
            
            // Helper to complete quest manually (dialogue driven)
            completeQuest: function(id) {
                // We rely on quests.claimStory logic but triggered manually without button
                quests.claimStory(id, true);
            }
        };

        // --- QUESTS CONTROLLER ---
        const quests = {
            currentTab: 'daily',
            timerInterval: null,

            init: function() {
                this.checkDailyQuests();
                this.startTimer();
            },

            switchTab: function(tab) {
                this.currentTab = tab;
                document.querySelectorAll('#view-quests .sub-tab').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-quests-${tab}`).classList.add('active');
                this.render();
            },

            getMskDayKey: function(ts) {
                return Math.floor((ts + 3 * 60 * 60 * 1000) / 86400000);
            },

            getNextResetTs: function(nowTs = Date.now()) {
                const next = new Date(nowTs);
                next.setUTCHours(21, 0, 0, 0);
                if (nowTs >= next.getTime()) {
                    next.setUTCDate(next.getUTCDate() + 1);
                }
                return next.getTime();
            },

            checkDailyQuests: function() {
                const nowTs = Date.now();
                const lastTs = gameState.lastQuestGenTime || 0;

                const needRefresh =
                    !gameState.activeQuests ||
                    gameState.activeQuests.length === 0 ||
                    this.getMskDayKey(nowTs) !== this.getMskDayKey(lastTs);

                if (needRefresh) {
                    this.generateDailyQuests();
                    return true;
                }
                return false;
            },

            generateDailyQuests: function() {
                const newQuests = [];
                for (let i = 0; i < 3; i++) {
                    newQuests.push(this.createRandomQuest(i));
                }
                gameState.activeQuests = newQuests;
                gameState.lastQuestGenTime = Date.now();
                game.save();
            },

            createRandomQuest: function(index) {
                const types = [
                    { type: 'sell', target: 'fish', text: 'Продать рыбу', baseGoal: 20, reward: 2 },
                    { type: 'sell', target: 'wheat', text: 'Продать пшеницу', baseGoal: 30, reward: 3 },
                    { type: 'sell', target: 'ore', text: 'Продать руду', baseGoal: 50, reward: 5 },
                    { type: 'sell', target: 'leather', text: 'Продать кожу', baseGoal: 5, reward: 8 },
                    { type: 'upgrade', target: 'rod', text: 'Улучшить удочку', baseGoal: 1, reward: 10 },
                    { type: 'upgrade', target: 'sickle', text: 'Улучшить серп', baseGoal: 1, reward: 8 },
                    { type: 'upgrade', target: 'pickaxe', text: 'Улучшить кирку', baseGoal: 1, reward: 9 },
                    { type: 'work', target: 'port', text: 'Работать в порту', baseGoal: 20, reward: 2 },
                    { type: 'work', target: 'mine', text: 'Работать в шахте', baseGoal: 10, reward: 4 }
                ];

                const template = types[Math.floor(Math.random() * types.length)];

                const goal = Math.max(1, Math.floor(template.baseGoal * (1 + Math.random())));
                const reward = Math.max(2, Math.floor(template.reward * (1 + Math.random())));

                return {
                    id: Date.now() + index,
                    text: `${template.text}`,
                    type: template.type,
                    target: template.target,
                    goal: goal,
                    current: 0,
                    reward: reward,
                    claimed: false
                };
            },

            onEvent: function(eventType, target, amount) {
                let updated = false;
                // Daily Quests
                (gameState.activeQuests || []).forEach(q => {
                    if (!q.claimed && q.type === eventType && q.target === target) {
                        q.current += amount;
                        if (q.current > q.goal) q.current = q.goal;
                        updated = true;
                    }
                });
                // Story Quests
                // Mapping actions to quest types.
                // Gathering/Selling logic in this game acts as 'acquire' for quest purposes usually
                // For this implementation, we map 'sell' events (which happen when you have resources)
                // OR 'work' events (getting resources) to quest progress.
                // Let's assume gathering/working adds to the counter.
                
                // For simplicity in this codebase structure: 
                // We'll update quests when you GAIN resources (via work/gather) or SELL resources.
                // The prompt implies 'Bring 3 fish' -> usually implies having them or collecting them.
                // Let's count "Gathered/Acquired" resources.
                
                if (eventType === 'work' || eventType === 'gather' || eventType === 'sell' || eventType === 'visit') {
                     (gameState.storyQuests || []).forEach(q => {
                        if (q.state === 'active' && q.goals.target === target) {
                            q.current += amount;
                            // Cap at goal for UI niceness, but keep logic open
                            if (q.current > q.goals.count) q.current = q.goals.count;
                            updated = true;
                        }
                    });
                }

                if (updated) {
                    game.save();
                    if (router.currentTab === 'quests') this.render();
                }
            },

            claim: function(id) {
                const q = (gameState.activeQuests || []).find(q => q.id === id);
                if (q && !q.claimed && q.current >= q.goal) {
                    q.claimed = true;
                    gameState.emeralds += q.reward;
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(event.target, `+${q.reward} Изумрудов`, "#34d399");
                    this.render();
                }
            },

            claimStory: function(id, force = false) {
                const q = (gameState.storyQuests || []).find(q => q.id === id);
                if (q && q.state === 'active' && (force || q.current >= q.goals.count)) {
                    q.state = 'claimed';
                    // Force complete implies progress met just now
                    if (force) q.current = q.goals.count; 
                    
                    gameState.gold += q.reward.gold;
                    game.addXp(q.reward.xp);
                    game.save();
                    ui.updateStats();
                    // If triggered from dialogue, event.target might not be valid or needed
                    const target = event && event.target ? event.target : document.body;
                    ui.showFloatText(target, `+${q.reward.gold} Gold +${q.reward.xp} XP`, "#fbbf24");
                    game.addReputation(2, target);
                    this.render();
                }
            },

            startTimer: function() {
                if (this.timerInterval) return;

                this.timerInterval = setInterval(() => {
                    const refreshed = this.checkDailyQuests();

                    if (router.currentTab === 'quests' && this.currentTab === 'daily') {
                        if (refreshed) this.render();
                        else this.updateTimerDisplay();
                    }
                }, 1000);
            },

            updateTimerDisplay: function() {
                const el = document.getElementById('quest-timer');
                if (!el) return;

                const nowTs = Date.now();
                const nextTs = this.getNextResetTs(nowTs);
                let diff = Math.max(0, nextTs - nowTs);

                const h = Math.floor(diff / 3600000);
                diff %= 3600000;
                const m = Math.floor(diff / 60000);
                diff %= 60000;
                const s = Math.floor(diff / 1000);

                el.innerText = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            },

            render: function() {
                const list = document.getElementById('quests-list');
                list.innerHTML = '';

                if (this.currentTab === 'daily') {
                    if (!gameState.activeQuests || gameState.activeQuests.length === 0) {
                        list.innerHTML = '<div class="text-center text-[#a0a0a0] py-4">Нет активных заданий</div>';
                        return;
                    }

                    gameState.activeQuests.forEach(q => {
                        const progress = Math.min(100, (q.current / q.goal) * 100);
                        const isDone = q.current >= q.goal;

                        const el = document.createElement('div');
                        el.className = `panel p-3 rounded flex flex-col gap-2 ${q.claimed ? 'opacity-50' : ''}`;
                        el.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-sm text-[#e0e0e0] font-bold">${q.text}</div>
                                    <div class="text-xs text-[#a0a0a0]">${q.current} / ${q.goal}</div>
                                </div>
                                <div class="text-xs text-emerald-400 font-bold border border-emerald-900 bg-emerald-900/20 px-2 py-1 rounded">
                                    +${q.reward} <i class="far fa-gem"></i>
                                </div>
                            </div>
                            <div class="w-full h-1.5 bg-[#000] rounded-full overflow-hidden border border-[#333]">
                                <div class="h-full bg-[#c8aa6e] transition-all duration-300" style="width: ${progress}%"></div>
                            </div>
                            ${isDone && !q.claimed ?
                                `<button onclick="quests.claim(${q.id})" class="btn-medieval w-full py-1 text-xs rounded mt-1">Забрать награду</button>` :
                                ''}
                            ${q.claimed ? '<div class="text-center text-[10px] text-green-500 uppercase">Выполнено</div>' : ''}
                        `;
                        list.appendChild(el);
                    });

                    // Countdown to next reset (00:00 MSK)
                    const timerWrap = document.createElement('div');
                    timerWrap.className = "text-center text-[11px] text-[#777] mt-2";
                    timerWrap.innerHTML = `До обновления (00:00 МСК): <span id="quest-timer" class="text-[#c8aa6e] font-mono">--:--:--</span>`;
                    list.appendChild(timerWrap);
                    this.updateTimerDisplay();

                } else {
                    if (!gameState.storyQuests || gameState.storyQuests.length === 0) {
                        list.innerHTML = `
                            <div class="panel p-4 rounded text-center opacity-70">
                                <i class="fas fa-user-secret text-4xl text-[#555] mb-2"></i>
                                <p class="text-sm text-[#a0a0a0]">Персонажи молчат...</p>
                                <p class="text-xs text-[#555]">Поговорите с жителями (Артур, Горн, Бен), чтобы получить задания.</p>
                            </div>
                        `;
                        return;
                    }

                    gameState.storyQuests.forEach(q => {
                        if (q.state === 'claimed') return; // Hide completed/claimed logic for now or move to separate list

                        const progress = Math.min(100, (q.current / q.goals.count) * 100);
                        const isDone = q.current >= q.goals.count;

                        const el = document.createElement('div');
                        el.className = "panel p-3 rounded flex flex-col gap-2 border-l-2 border-[#c8aa6e]";
                        el.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-sm text-[#c8aa6e] font-bold">${q.title}</div>
                                    <div class="text-[10px] text-[#a0a0a0] mb-1">${q.desc}</div>
                                    <div class="text-xs text-[#e0e0e0]">${q.current} / ${q.goals.count}</div>
                                </div>
                                <div class="text-right">
                                     <div class="text-[10px] text-yellow-500 font-bold">+${q.reward.gold} <i class="fas fa-coins"></i></div>
                                     <div class="text-[10px] text-blue-400 font-bold">+${q.reward.xp} XP</div>
                                </div>
                            </div>
                            <div class="w-full h-1.5 bg-[#000] rounded-full overflow-hidden border border-[#333]">
                                <div class="h-full bg-[#c8aa6e] transition-all duration-300" style="width: ${progress}%"></div>
                            </div>
                            ${isDone ?
                                `<button onclick="quests.claimStory('${q.id}')" class="btn-medieval w-full py-1 text-xs rounded mt-1">Завершить</button>` :
                                ''}
                        `;
                        list.appendChild(el);
                    });
                }
            }
        };

        // --- GAME LOGIC ---
        const game = {
            init: function() {
                this.load();
                this.calculateNextLevel();
                
                // Initialize resources if undefined
                ['fish', 'meat', 'mushrooms', 'bread', 'eggs', 'milk', 'ore', 'bronze', 'silver', 'wheat', 'wood', 'stone', 'herbs', 'leather'].forEach(r => {
                    if (gameState[r] === undefined) gameState[r] = 0;
                });
                if (gameState.hp === undefined) gameState.hp = 100;
                if (gameState.maxHp === undefined) gameState.maxHp = 100;
                if (gameState.skillPoints === undefined) gameState.skillPoints = 0;
                if (gameState.luck === undefined) gameState.luck = 0;
                if (gameState.reputation === undefined) gameState.reputation = 0;
                if (gameState.craftingLevel === undefined) gameState.craftingLevel = 0;
                if (gameState.unconsciousUntil === undefined) gameState.unconsciousUntil = 0;
                if (gameState.lowHpWarnedAt === undefined) gameState.lowHpWarnedAt = 0;
                if (gameState.unconsciousUntil && gameState.unconsciousUntil > Date.now()) {
                    gameState.hp = 0;
                }
                
                quests.init();
                this.checkDailyReward();
                ui.updateAll();
                this.checkUnconscious();
                ui.updateUnconsciousUI();
                
                // Show Intro if not shown
                if (!gameState.introShown) {
                    setTimeout(() => document.getElementById('modal-intro').classList.add('open'), 500);
                }
                
                // Initialize new state fields if missing
                if(!gameState.recipes) gameState.recipes = { immortality: false, luck: false, saddle: false };
                if(!gameState.effects) gameState.effects = { immortality: 0, luck: 0 };
                if (!gameState.npcStates) gameState.npcStates = {};
                if (gameState.hasPoorHouse === undefined) gameState.hasPoorHouse = false;
                if (gameState.hasNobleHouse === undefined) gameState.hasNobleHouse = false;
                if (!gameState.shoes) gameState.shoes = { peasant: false, quality: false, elite: false };
                if (gameState.treasuryPouchResolved === undefined) gameState.treasuryPouchResolved = false;
                if (gameState.bookhousePouchResolved === undefined) gameState.bookhousePouchResolved = false;
                
                if (gameState.npcStates.lili_waiting && gameState.npcStates.lili_wait_time) {
                    const elapsed = Date.now() - gameState.npcStates.lili_wait_time;
                    if (elapsed > 1000 * 60 * 3) {
                        gameState.npcStates.lili_waiting = true;
                    }
                }
                
                this.updateEffectsLoop();

                // Telegram Init
                if (window.Telegram && window.Telegram.WebApp) {
                    const tg = window.Telegram.WebApp;
                    tg.ready();
                    tg.expand();
                    tg.setHeaderColor('#141417');
                    tg.setBackgroundColor('#0f0f10');
                }
            },

            save: function() {
                localStorage.setItem('medieval_rpg_save_v5', JSON.stringify(gameState));
            },

            load: function() {
                const save = localStorage.getItem('medieval_rpg_save_v5');
                if (save) {
                    const parsed = JSON.parse(save);
                    Object.assign(gameState, parsed);
                    if(!gameState.activeQuests) gameState.activeQuests = [];
                }
            },
            
            closeIntro: function(goToMap) {
                document.getElementById('modal-intro').classList.remove('open');
                gameState.introShown = true;
                this.save();
                if (goToMap) {
                    router.navigate('town-square');
                }
            },
            
            getJobReward: function(jobType) {
                const job = JOBS_DB[jobType];
                const toolState = gameState.tools[job.tool];
                let amount = 1;
                if (toolState.owned && toolState.level > 1) {
                    amount += (toolState.level - 1);
                }
                // Return as 'gold' property to match UI usage, though it represents resource amount
                return { gold: amount }; 
            },

            calculateNextLevel: function() {
                gameState.xpToNextLevel = gameState.level * 100;
            },

            addXp: function(amount) {
                gameState.xp += amount;
                if (gameState.xp >= gameState.xpToNextLevel) {
                    this.levelUp();
                }
                this.save();
                ui.updateStats();
            },

            addReputation: function(amount, sourceElement = null) {
                const prev = gameState.reputation || 0;
                const next = Math.max(0, Math.min(100, prev + amount));
                if (next === prev) return;
                gameState.reputation = next;
                this.save();
                ui.updateStats();
                if (sourceElement) {
                    const sign = amount > 0 ? '+' : '';
                    const color = amount > 0 ? '#34d399' : '#ef4444';
                    ui.showFloatText(sourceElement, `${sign}${amount} Репутации`, color);
                }
            },

            levelUp: function() {
                gameState.xp -= gameState.xpToNextLevel;
                gameState.level++;

                const goldReward = (gameState.level - 1) * 100;
                gameState.gold += goldReward;
                gameState.skillPoints = (gameState.skillPoints || 0) + 1;

                this.calculateNextLevel();
                ui.updateJobs();
                ui.updateStats();

                this.showLevelUpModal(goldReward);
                this.save();
            },

            showLevelUpModal: function(goldReward) {
                const modal = document.getElementById('modal-levelup');
                if (!modal) return;

                document.getElementById('levelup-new-level').innerText = gameState.level;
                document.getElementById('levelup-gold').innerText = goldReward;

                let msg = "Ваш путь продолжается. Откройте вкладку Герой и улучшайте навыки.";
                if (gameState.level === 2) {
                    msg = "Открылся Книжный Дом на площади. Покупайте рецепты и развивайте героя.";
                } else if (gameState.level === 3) {
                    msg = "Появилась работа Грузчика в порту. Порыбачьте, чтобы встретить Алекса.";
                } else if (gameState.level === 5) {
                    msg = "Открыты Пшеничное поле и Темный лес. Нужны серп и осторожность.";
                } else if (gameState.level === 10) {
                    msg = "Пора накопить на дом в деревне и начать хозяйство.";
                } else if (gameState.level === 15) {
                    msg = "Открыт Рудник и Учебный лагерь. Навестите Рыцаря Джона.";
                } else if (gameState.level === 30) {
                    msg = "Открыта охота. Самая опасная, но прибыльная работа.";
                }

                document.getElementById('levelup-message').innerText = msg;
                modal.classList.add('open');

                if (window.navigator && window.navigator.vibrate) {
                    window.navigator.vibrate([120, 60, 120]);
                }
            },

            closeLevelUp: function() {
                const modal = document.getElementById('modal-levelup');
                if (modal) modal.classList.remove('open');
            },
            
            heal: function(amount, cost) {
                if(gameState.gold >= cost) {
                    if (gameState.hp >= gameState.maxHp) {
                        ui.showFloatText(event.target, "Здоровье полно", "#c8aa6e");
                        return;
                    }
                    gameState.gold -= cost;
                    gameState.hp = Math.min(gameState.maxHp, gameState.hp + amount);
                    ui.showFloatText(event.target, `+${amount} HP`, "#ef4444");
                    ui.updateStats();
                    this.save();
                } else {
                    ui.showFloatText(event.target, "Не хватает золота", "#ff5555");
                }
            },

            addReputation: function(amount, sourceElement = null) {
                const prev = gameState.reputation || 0;
                const next = Math.max(0, Math.min(100, prev + amount));
                if (next === prev) return;
                gameState.reputation = next;
                this.save();
                ui.updateStats();
                if (sourceElement) {
                    const sign = amount > 0 ? '+' : '';
                    const color = amount > 0 ? '#34d399' : '#ef4444';
                    ui.showFloatText(sourceElement, `${sign}${amount} Репутации`, color);
                }
            },

            knockOut: function() {
                if (gameState.unconsciousUntil && gameState.unconsciousUntil > Date.now()) return;
                gameState.hp = 0;
                gameState.unconsciousUntil = Date.now() + 10 * 60 * 1000;
                this.save();
                ui.updateStats();
                ui.updateUnconsciousUI();
            },

            checkUnconscious: function() {
                const now = Date.now();
                
                // If timer is running
                if (gameState.unconsciousUntil && gameState.unconsciousUntil > now) {
                    // Force HP to 0 if it somehow isn't
                    if (gameState.hp !== 0) {
                        gameState.hp = 0;
                        this.save();
                        ui.updateStats();
                    }
                    // Ensure UI is showing unconscious state
                    if (!document.body.classList.contains('unconscious')) {
                        ui.updateUnconsciousUI();
                    }
                    return;
                }

                // If timer expired (wake up)
                if (gameState.unconsciousUntil && gameState.unconsciousUntil <= now) {
                    gameState.unconsciousUntil = 0;
                    gameState.hp = Math.max(gameState.hp, 15);
                    this.save();
                    ui.updateStats();
                    ui.updateUnconsciousUI();
                    ui.showFloatText(document.body, "Вы пришли в себя (+15 HP)", "#34d399");
                }
            },

            checkDailyReward: function() {
                const today = new Date().toDateString();
                
                // First launch check
                if (!gameState.installDate) {
                    gameState.installDate = today;
                    gameState.lastLoginDate = today;
                    gameState.dailyStreak = 1;
                    this.save();
                    return; // Skip reward on first day
                }

                const last = gameState.lastLoginDate;
                
                if (last !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    if (last === yesterday.toDateString()) {
                        gameState.dailyStreak++;
                    } else {
                        // Reset streak if missed a day, but keep 1
                        gameState.dailyStreak = 1;
                    }
                    setTimeout(() => {
                        ui.showDailyModal();
                    }, 1000);
                }
            },

            claimDaily: function() {
                const streak = gameState.dailyStreak;
                let reward = 30;
                if (streak === 1) reward = 5;
                else if (streak === 2) reward = 10;
                else if (streak === 3) reward = 15;
                else if (streak === 4) reward = 20;
                
                gameState.emeralds += reward;
                gameState.lastLoginDate = new Date().toDateString();
                this.save();
                
                document.getElementById('modal-daily').classList.remove('open');
                ui.updateAll();
                ui.showFloatText(document.body, `+${reward} Изумрудов`, "#34d399");
            },

            work: function(jobType, event) {
                if (gameState.hp <= 0 || (gameState.unconsciousUntil && gameState.unconsciousUntil > Date.now())) {
                    ui.showFloatText(event.target, "Вы без сознания", "#ff5555");
                    return;
                }

                const job = JOBS_DB[jobType];
                
                // Check level requirement
                if (job.levelReq && gameState.level < job.levelReq) {
                    ui.showFloatText(event.target, `Нужен Уровень ${job.levelReq}`, "#ff5555");
                    return;
                }
                
                // Check if job requires Alex unlock
                if (job.requiresAlex && (!gameState.npcStates || !gameState.npcStates.alex_job_unlocked)) {
                    ui.showFloatText(event.target, "Работа недоступна", "#ff5555");
                    return;
                }
                
                // Check tool requirement (skip for loader job)
                const toolState = job.tool ? gameState.tools[job.tool] : null;
                const toolDef = job.tool ? TOOLS_DB[job.tool] : null;

                if (toolDef && !toolState.owned) {
                    if (jobType === 'port' && gameState.gold >= TOOLS_DB.rod.baseCost) {
                        ui.showFloatText(event.target, "Удочку можно купить на рынке", "#fbbf24");
                    } else {
                        ui.showFloatText(event.target, `Нужна ${toolDef.name}`, "#ff5555");
                    }
                    return;
                }
                
                // Track port work for old man event
                if (jobType === 'port') {
                    // Initialize threshold if not set
                    if (!gameState.oldManEventThreshold) {
                        gameState.oldManEventThreshold = Math.floor(Math.random() * 51) + 50; // 50-100
                    }
                    
                    gameState.portWorkCount = (gameState.portWorkCount || 0) + 1;
                    
                    // Trigger Alex meeting at level 3
                    if (!gameState.npcStates) gameState.npcStates = {};
                    if (!gameState.npcStates.alex_met && gameState.level >= 3) {
                        gameState.npcStates.alex_met = true;
                        this.save();
                        
                        setTimeout(() => {
                            dialogue.start('alex');
                        }, 500);
                        return; // Don't process the work this time
                    }
                    
                    // Trigger old man event
                    if (!gameState.oldManEventTriggered && gameState.portWorkCount >= gameState.oldManEventThreshold && gameState.gold > 0) {
                        gameState.oldManEventTriggered = true;
                        this.save();
                        
                        setTimeout(() => {
                            dialogue.start('oldman_port');
                        }, 500);
                        return; // Don't process the work this time
                    }
                }
                
                // Injury Chance (custom for loader job - 1%, others - 10%)
                const injuryChance = job.injuryChance !== undefined ? job.injuryChance : 0.1;
                if (Math.random() < injuryChance) {
                    const dmg = Math.floor(Math.random() * 10) + 5;
                    gameState.hp = Math.max(0, gameState.hp - dmg);
                    ui.showFloatText(event.target, `-${dmg} HP (Травма!)`, "#ef4444");
                    ui.updateStats();
                    this.save();
                    return; 
                }

                let amount = 1;
                if (toolState && toolState.level > 1) {
                    amount += (toolState.level - 1);
                }

                // Chance for Emerald
                const luckyDrop = Math.random() < 0.01;
                if (luckyDrop) {
                    gameState.emeralds += 1;
                    setTimeout(() => {
                        ui.showFloatText(event.target, `+1 ИЗУМРУД!`, "#34d399");
                    }, 200);
                }

                this.addXp(job.xp);

                // Handle loader job (gives gold directly)
                if (jobType === 'loader') {
                    const goldReward = job.price; // 6 gold
                    gameState.gold += goldReward;
                    ui.showFloatText(event.target, `+${goldReward} Золота`, "#c8aa6e");
                } else {
                    // Add Resource
                    if (gameState[job.resource] === undefined) gameState[job.resource] = 0;
                    gameState[job.resource] += amount;
                    
                    const rName = RESOURCE_NAMES[job.resource].name;
                    ui.showFloatText(event.target, `+${amount} ${rName}`, "#e0e0e0");
                }
                
                // Quest Progress
                quests.onEvent('work', jobType, 1);
                // Also trigger gather event for story quests
                quests.onEvent('gather', job.resource, amount);

                if (window.navigator && window.navigator.vibrate) {
                    window.navigator.vibrate(10);
                }
                
                this.save();
                ui.updateStats(); 
                ui.updateJobs();
            },

            buyRecipe: function(type, cost) {
                if (!gameState.recipes) gameState.recipes = {};

                if (gameState.emeralds >= cost) {
                    gameState.emeralds -= cost;
                    gameState.recipes[type] = true;
                    this.save();
                    ui.updateAll();
                    ui.showFloatText(event.target, "Рецепт куплен!", "#34d399");

                    if (type === 'immortality' || type === 'luck') {
                        document.getElementById('healer-crafting-station').classList.remove('hidden');
                        if (type === 'immortality') document.getElementById('craft-action-immortality').classList.remove('hidden');
                        if (type === 'luck') document.getElementById('craft-action-luck').classList.remove('hidden');
                    }
                } else {
                    ui.showFloatText(event.target, "Не хватает изумрудов", "#ff5555");
                }
            },

            activateEffect: function(effectType) {
                if (!gameState.effects) gameState.effects = { immortality: 0, luck: 0 };
                
                if (effectType === 'immortality') {
                    if (gameState.herbs >= 10) {
                        gameState.herbs -= 10;
                        gameState.effects.immortality = Date.now() + 2 * 60 * 1000;
                        ui.showFloatText(event.target, "Бессмертие активировано!", "#ef4444");
                    } else {
                        ui.showFloatText(event.target, "Нужно 10 трав", "#ff5555");
                        return;
                    }
                }
                if (effectType === 'luck') {
                    if (gameState.mushrooms >= 5) {
                        gameState.mushrooms -= 5;
                        gameState.effects.luck = Date.now() + 2 * 60 * 1000;
                        ui.showFloatText(event.target, "Удача x2 активирована!", "#34d399");
                    } else {
                        ui.showFloatText(event.target, "Нужно 5 грибов", "#ff5555");
                        return;
                    }
                }
                this.save();
                ui.updateAll();
            },

            updateEffectsLoop: function() {
                setInterval(() => {
                    if (!gameState.effects) return;

                    const now = Date.now();
                    const immActive = gameState.effects.immortality > now;
                    const luckActive = gameState.effects.luck > now;

                    const effectsContainer = document.getElementById('active-effects-container');
                    const immEl = document.getElementById('effect-immortality');
                    const luckEl = document.getElementById('effect-luck');

                    if (immActive || luckActive) effectsContainer.classList.remove('hidden');
                    else effectsContainer.classList.add('hidden');

                    if (immActive) {
                        immEl.classList.remove('hidden');
                        const remaining = Math.max(0, Math.floor((gameState.effects.immortality - now) / 1000));
                        document.getElementById('timer-immortality').innerText = `${Math.floor(remaining/60)}:${String(remaining%60).padStart(2,'0')}`;
                    } else {
                        immEl.classList.add('hidden');
                    }

                    if (luckActive) {
                        luckEl.classList.remove('hidden');
                        const remaining = Math.max(0, Math.floor((gameState.effects.luck - now) / 1000));
                        document.getElementById('timer-luck').innerText = `${Math.floor(remaining/60)}:${String(remaining%60).padStart(2,'0')}`;
                    } else {
                        luckEl.classList.add('hidden');
                    }
                }, 1000);
            },

            completeQuest: function(id) {
                quests.claimStory(id, true);
            },

            buyClothes: function(type, cost) {
                market.buyClothes(type, cost);
            },

            gainReputationForClothes: function(type, sourceElement) {
                if (type === 'peasant') this.addReputation(2, sourceElement);
                if (type === 'rich') this.addReputation(5, sourceElement);
                if (type === 'noble') this.addReputation(8, sourceElement);
            }
        };

        // --- LOCATIONS CONTROLLER ---
        const locations = {
            beg: function(event) {
                // Check for Knight John encounter (random chance or first time after some progress)
                // Let's make it trigger if player has > 10 gold total earned or simply not met yet
                if (!gameState.npcStates) gameState.npcStates = {};
                
                if (!gameState.npcStates.john_met && Math.random() < 0.2) {
                     gameState.npcStates.john_met = true;
                     gameState.gold += 10; // The coin he throws
                     ui.showFloatText(event.target, "+10 Золота (Рыцарь!)", "#fbbf24");
                     ui.updateStats();
                     game.save();
                     
                     setTimeout(() => {
                         dialogue.start('john_intro');
                     }, 500);
                     return;
                }

                gameState.gold += 2;
                ui.showFloatText(event.target, "+2 Золота", "#c8aa6e");
                ui.updateStats();
                game.save();
            },

            treasuryDepositAll: function(event) {
                // Not used in HTML but kept for logic safety
                const anchor = (event && event.target) ? event.target : document.body;
                if (gameState.gold > 0) {
                    const amount = gameState.gold;
                    gameState.gold = 0;
                    gameState.bankedGold += amount;
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(anchor, `Депозит ${amount}`, "#c8aa6e");
                } else {
                    ui.showFloatText(anchor, "Нет золота", "#ff5555");
                }
            },

            treasuryWithdrawAll: function(event) {
                 // Not used in HTML but kept for logic safety
                const anchor = (event && event.target) ? event.target : document.body;
                if (gameState.bankedGold > 0) {
                    const amount = gameState.bankedGold;
                    gameState.bankedGold = 0;
                    gameState.gold += amount;
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(anchor, `Снято ${amount}`, "#c8aa6e");
                } else {
                    ui.showFloatText(anchor, "Сейф пуст", "#ff5555");
                }
            },
            
            treasurySetMax: function(type, event) {
                const input = document.getElementById('bank-amount-input');
                if (type === 'deposit') {
                    input.value = gameState.gold;
                } else {
                    input.value = gameState.bankedGold;
                }
            },
            
            treasuryDepositAmount: function(event) {
                const input = document.getElementById('bank-amount-input');
                const val = parseInt(input.value);
                if (!val || val <= 0) return;
                if (gameState.gold >= val) {
                    gameState.gold -= val;
                    gameState.bankedGold += val;
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(event.target, `Депозит ${val}`, "#c8aa6e");
                    input.value = '';
                } else {
                    ui.showFloatText(event.target, "Не хватает", "#ff5555");
                }
            },
            
            treasuryWithdrawAmount: function(event) {
                const input = document.getElementById('bank-amount-input');
                const val = parseInt(input.value);
                if (!val || val <= 0) return;
                if (gameState.bankedGold >= val) {
                    gameState.bankedGold -= val;
                    gameState.gold += val;
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(event.target, `Снято ${val}`, "#c8aa6e");
                    input.value = '';
                } else {
                    ui.showFloatText(event.target, "Не хватает", "#ff5555");
                }
            },

            treasuryExchange: function(event) {
                const anchor = (event && event.target) ? event.target : document.body;
                if (gameState.emeralds >= 1) {
                    gameState.emeralds -= 1;
                    gameState.gold += 1000;
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(anchor, "+1000 Золота", "#c8aa6e");
                } else {
                    ui.showFloatText(anchor, "Нет изумрудов", "#ff5555");
                }
            },

            tavernRent: function() {
                if (gameState.emeralds >= 20) {
                    gameState.emeralds -= 20;
                    gameState.hp = gameState.maxHp; 
                    ui.updateStats();
                    ui.showFloatText(event.target, "Отдых... HP восстановлено!", "#34d399");
                    game.save();
                } else {
                    ui.showFloatText(event.target, "Не хватает изумрудов", "#ff5555");
                }
            },

            tavernBrawl: function(event) {
                if (gameState.hp < 20) {
                    ui.showFloatText(event.target, "Нужно 20+ HP", "#ff5555");
                    return;
                }
                const now = Date.now();
                const cooldown = 3600000; // 1 hour
                const last = gameState.lastBrawlTime || 0;
                
                if (now - last < cooldown) {
                    const left = Math.ceil((cooldown - (now - last)) / 60000);
                    ui.showFloatText(event.target, `Жди ${left} мин`, "#777");
                    return;
                }

                gameState.lastBrawlTime = now;
                
                // Fight logic
                // Chance to win increases with level
                const baseChance = 0.4;
                const levelBonus = (gameState.level * 0.02); // 2% per level
                const winChance = Math.min(0.8, baseChance + levelBonus);
                
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = "<i class='fas fa-fist-raised animate-bounce'></i> Бой...";
                
                setTimeout(() => {
                    const won = Math.random() < winChance;
                    
                    if (won) {
                        const gold = 50 + Math.floor(Math.random() * 100);
                        const rep = 1;
                        gameState.gold += gold;
                        game.addReputation(rep, btn);
                        ui.showFloatText(btn, `Победа! +${gold} монет`, "#fbbf24");
                    } else {
                        const dmg = 15 + Math.floor(Math.random() * 15);
                        gameState.hp = Math.max(1, gameState.hp - dmg);
                        ui.showFloatText(btn, `Поражение... -${dmg} HP`, "#ef4444");
                    }
                    
                    game.save();
                    ui.updateStats();
                    ui.updateLocations(); // Updates timer text
                }, 1000);
            },

            tavernSpin: function() {
                const btn = document.getElementById('btn-spin');
                if (gameState.emeralds < 1) {
                    ui.showFloatText(btn, "Нужен 1 Изумруд", "#ff5555");
                    return;
                }

                gameState.emeralds -= 1;
                ui.updateStats();
                
                btn.disabled = true;
                const wheel = document.getElementById('wheel');
                wheel.classList.add('spin-anim');
                
                // Determine Reward
                const rand = Math.random() * 100;
                let reward = { type: 'gold', val: 1000, text: '1000 Золота' };
                
                if (rand < 1) reward = { type: 'gem', val: 100, text: '100 ИЗУМРУДОВ!' };
                else if (rand < 11) reward = { type: 'gem', val: 10, text: '10 Изумрудов' };
                else if (rand < 26) reward = { type: 'gold', val: 10000, text: '10,000 Золота' };
                else if (rand < 51) reward = { type: 'gold', val: 5000, text: '5,000 Золота' };
                
                setTimeout(() => {
                    wheel.classList.remove('spin-anim');
                    btn.disabled = false;
                    
                    if (reward.type === 'gold') gameState.gold += reward.val;
                    else gameState.emeralds += reward.val;
                    
                    game.save();
                    ui.updateStats();
                    
                    const color = reward.type === 'gem' ? '#34d399' : '#c8aa6e';
                    ui.showFloatText(btn, `+${reward.text}`, color);
                }, 1000);
            },

            tavernEat: function(type) {
                if (gameState.gold >= 100) {
                    if (gameState.hp >= gameState.maxHp) {
                        ui.showFloatText(event.target, "Вы сыты", "#c8aa6e");
                        return;
                    }
                    gameState.gold -= 100;
                    gameState.hp = gameState.maxHp;
                    ui.updateStats();
                    game.save();
                    ui.showFloatText(event.target, "HP Восстановлено!", "#34d399");

                    // Thomas Event Trigger
                    if (!gameState.npcStates) gameState.npcStates = {};
                    if (!gameState.npcStates.thomas_met) {
                        setTimeout(() => {
                            dialogue.start('thomas_intro');
                        }, 1000);
                    }
                } else {
                    ui.showFloatText(event.target, "Не хватает золота", "#ff5555");
                }
            },

            forestGather: function(event) {
                const isImmortal = gameState.effects && gameState.effects.immortality > Date.now();
                if (!isImmortal && gameState.hp < 5) {
                    ui.showFloatText(event.target, "Мало здоровья", "#ff5555");
                    return;
                }
                if (!isImmortal) gameState.hp -= 5;
                
                game.addXp(3);
                
                const isLuckyEffect = gameState.effects && gameState.effects.luck > Date.now();
                const luckBonus = (gameState.luck || 0) * 0.05;
                
                let count = Math.floor(Math.random() * 3) + 1;
                if (Math.random() < luckBonus) count++;
                if (isLuckyEffect) count *= 2;
                
                const loot = [];
                for(let i=0; i<count; i++) {
                    const r = Math.random();
                    if(r < 0.4) loot.push('wood');       
                    else if(r < 0.7) loot.push('stone'); 
                    else if(r < 0.9) loot.push('herbs'); 
                    else loot.push('mushrooms');         
                }
                
                const gained = {};
                loot.forEach(item => {
                    gameState[item] = (gameState[item] || 0) + 1;
                    gained[item] = (gained[item] || 0) + 1;
                });
                
                let text = "";
                const names = {wood:'Палка', stone:'Камень', herbs:'Трава', mushrooms:'Гриб'};
                
                Object.keys(gained).forEach(k => {
                    text += `+${gained[k]} ${names[k]} `;
                });
                
                ui.showFloatText(event.target, text || "Пусто...", "#a855f7");

                Object.keys(gained).forEach(k => {
                    quests.onEvent('gather', k, gained[k]);
                });
                
                if (Math.random() < (0.05 + luckBonus/2)) {
                    gameState.emeralds++;
                    setTimeout(() => ui.showFloatText(event.target, "+1 Изумруд!", "#34d399"), 500);
                }
                
                // Chance to get measles
                disease.tryInfect();
                
                game.save();
                ui.updateStats();
            },

            forestHunt: function(event) {
                if (gameState.hp < 20) {
                    ui.showFloatText(event.target, "Слишком опасно...", "#ff5555");
                    return;
                }
                gameState.hp -= 20;
                game.addXp(20);
                
                const roll = Math.random();
                if (roll < 0.2) {
                    // Nothing / Escaped
                    ui.showFloatText(event.target, "Монстр сбежал...", "#777");
                } else if (roll < 0.7) {
                    // Win standard
                    const gold = Math.floor(Math.random() * 50) + 20;
                    gameState.gold += gold;
                    ui.showFloatText(event.target, `Победа! +${gold} Золота`, "#c8aa6e");
                } else if (roll < 0.9) {
                    // Win loot
                    const mushrooms = Math.floor(Math.random() * 5) + 2;
                    gameState.mushrooms += mushrooms;
                    ui.showFloatText(event.target, `Трофеи: +${mushrooms} Грибов`, "#a855f7");
                } else {
                    // Critical win / Chest
                    const gold = 100 + Math.floor(Math.random() * 100);
                    const gems = Math.random() < 0.5 ? 1 : 0;
                    gameState.gold += gold;
                    gameState.emeralds += gems;
                    ui.showFloatText(event.target, `ЛЕГЕНДАРНО! +${gold} Золота ${gems ? '+1 Гем' : ''}`, "#fbbf24");
                }
                
                game.save();
                ui.updateStats();
            }
        };

        // --- MARKET CONTROLLER ---
        const market = {
            currentCategory: 'tools',

            switchCategory: function(cat) {
                this.currentCategory = cat;
                document.querySelectorAll('#view-market .sub-tab').forEach(el => el.classList.remove('active'));
                const btn = document.getElementById(`tab-market-${cat}`);
                if(btn) btn.classList.add('active');

                document.getElementById('market-tools').classList.add('hidden');
                document.getElementById('market-placeholder').classList.add('hidden');

                if (cat === 'tools') {
                    // Show common tools
                    document.getElementById('market-tools').classList.remove('hidden');
                    // Hide sword for tools tab
                    const swordEl = document.getElementById('btn-buy-sword').parentElement;
                    if(swordEl) swordEl.style.display = 'none';
                    // Show others
                    ['rod','sickle','pickaxe','crossbow'].forEach(k => {
                        const el = document.getElementById(`btn-buy-${k}`).parentElement;
                        if(el) el.style.display = 'flex';
                    });
                    this.renderTools();
                } else if (cat === 'weapons') {
                    document.getElementById('market-tools').classList.remove('hidden');
                    // Hide common tools
                    ['rod','sickle','pickaxe','crossbow'].forEach(k => {
                        const el = document.getElementById(`btn-buy-${k}`).parentElement;
                        if(el) el.style.display = 'none';
                    });
                    // Show sword
                    const swordEl = document.getElementById('btn-buy-sword').parentElement;
                    if(swordEl) swordEl.style.display = 'flex';
                    this.renderTools();
                } else {
                    document.getElementById('market-placeholder').classList.remove('hidden');
                }
            },

            categoriesBuilt: false,

            buildTradeCategories: function() {
                ui.buildMarketCategories();
            },

            resourcePrices: {
                fish: 5,
                meat: 20,
                mushrooms: 25,
                bread: 12,
                eggs: 8,
                milk: 10,
                ore: 40,
                bronze: 80,
                silver: 120,
                wheat: 15,
                wood: 5,
                stone: 5,
                herbs: 10,
                leather: 100
            },

            getResourcePrice: function(resType) {
                return this.resourcePrices[resType] || 0;
            },

            getToolPrice: function(toolKey) {
                const toolState = gameState.tools[toolKey];
                const base = TOOLS_DB[toolKey].baseCost;
                if (!toolState.owned) return base;
                return Math.floor(base * (toolState.level + 1) * 1.5);
            },

            renderTools: function() {
                ['rod', 'sickle', 'pickaxe', 'crossbow', 'sword'].forEach(key => {
                    const state = gameState.tools[key];
                    if (!state) return; // safety
                    const price = this.getToolPrice(key);
                    const btn = document.getElementById(`btn-buy-${key}`);
                    const lvlSpan = document.getElementById(`market-lvl-${key}`);
                    const priceSpan = document.getElementById(`price-${key}`);
                    
                    if(lvlSpan) lvlSpan.innerText = state.owned ? `Ур: ${state.level}` : `Не куплено`;
                    
                    if(btn && priceSpan) {
                         priceSpan.innerText = price;
                         if (!state.owned) {
                            btn.innerHTML = `<span id="price-${key}">${price}</span> <i class="fas fa-coins text-[10px]"></i>`;
                        } else {
                            btn.innerHTML = `Улучшить <span id="price-${key}">${price}</span> <i class="fas fa-coins text-[10px]"></i>`;
                        }
                        if (gameState.gold < price) btn.style.opacity = '0.5';
                        else btn.style.opacity = '1';
                    }
                });
            },

            buyOrUpgradeTool: function(key) {
                const price = this.getToolPrice(key);
                if (gameState.gold >= price) {
                    gameState.gold -= price;
                    if (!gameState.tools[key].owned) {
                        gameState.tools[key].owned = true;
                        gameState.tools[key].level = 1;
                        ui.showFloatText(event.target, "Куплено!", "#34d399");
                    } else {
                        gameState.tools[key].level++;
                        ui.showFloatText(event.target, "Улучшено!", "#34d399");
                    }
                    // Quest Progress
                    quests.onEvent('upgrade', key, 1);
                    
                    game.save();
                    ui.updateAll();
                } else {
                    ui.showFloatText(event.target, "Не хватает золота", "#ff5555");
                }
            },

            buyClothes: function(type, cost) {
                if (type === 'noble' && gameState.emeralds < cost) {
                    ui.showFloatText(event.target, "Не хватает изумрудов", "#ff5555");
                    return;
                }
                if (type !== 'noble' && gameState.gold < cost) {
                    ui.showFloatText(event.target, "Не хватает золота", "#ff5555");
                    return;
                }
                
                if (type === 'noble') {
                    gameState.emeralds -= cost;
                } else {
                    gameState.gold -= cost;
                }
                
                gameState.clothes = gameState.clothes || {};
                gameState.clothes[type] = true;
                game.save();
                ui.updateStats();
                ui.showFloatText(event.target, "Одежда куплена!", "#34d399");
                game.gainReputationForClothes(type, event.target);
            },

            tradeMode: 'sell',

            setMax: function(resType) {
                const count = gameState[resType] || 0;
                const input = document.getElementById(`trade-input-${resType}`);
                if(input) input.value = count > 0 ? count : 1;
            },

            sellFromInput: function(resType) {
                const input = document.getElementById(`trade-input-${resType}`);
                let amount = parseInt(input.value);
                if (isNaN(amount) || amount <= 0) return;
                this.sellResource(resType, amount);
            },

            buyFromInput: function(resType) {
                const input = document.getElementById(`trade-input-${resType}`);
                let amount = parseInt(input.value);
                if (isNaN(amount) || amount <= 0) return;
                this.buyResource(resType, amount);
            },

            getResourcePrice: function(resType) {
                return this.resourcePrices[resType] || 0;
            },

            buyResource: function(resType, amount) {
                const price = this.getResourcePrice(resType);
                if (price === 0) return;
                const totalCost = price * 2 * amount;
                if (amount <= 0) {
                    ui.showFloatText(event.target, "Введите количество", "#ff5555");
                    return;
                }
                if (gameState.gold >= totalCost) {
                    gameState.gold -= totalCost;
                    gameState[resType] = (gameState[resType] || 0) + amount;
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(event.target, `-${totalCost} Золота`, "#ff5555");
                } else {
                    ui.showFloatText(event.target, "Не хватает золота", "#ff5555");
                }
            },

            switchTradeMode: function(mode) {
                this.tradeMode = mode;
                const sellTab = document.getElementById('market-trade-sell');
                const buyTab = document.getElementById('market-trade-buy');
                if (sellTab && buyTab) {
                    sellTab.classList.toggle('active', mode === 'sell');
                    buyTab.classList.toggle('active', mode === 'buy');
                }

                const resourceList = Object.keys(RESOURCE_NAMES);
                resourceList.forEach(resource => {
                    const btn = document.getElementById(`btn-trade-${resource}`);
                    if (btn) {
                        if (mode === 'sell') {
                            btn.innerText = 'Продать';
                            btn.onclick = () => this.sellFromInput(resource);
                        } else {
                            btn.innerText = 'Купить';
                            btn.onclick = () => this.buyFromInput(resource);
                        }
                    }
                });
                this.updateTradePrices();
            },

            updateTradePrices: function() {
                const resourceList = Object.keys(RESOURCE_NAMES);
                resourceList.forEach(resource => {
                    const priceEl = document.getElementById(`price-${resource}`);
                    if (priceEl) {
                        const base = this.getResourcePrice(resource);
                        const price = this.tradeMode === 'buy' ? base * 2 : base;
                        priceEl.innerText = price;
                    }
                });
            },

            sellResource: function(resType, amount) {
                const price = this.getResourcePrice(resType);
                if (price === 0) return;

                const current = gameState[resType] || 0;
                if (amount === -1) amount = current;

                if (amount <= 0) {
                     ui.showFloatText(event.target, "Нечего продавать", "#ff5555");
                     return;
                }

                if (current >= amount) {
                    gameState[resType] -= amount;
                    const totalGain = amount * price;
                    gameState.gold += totalGain;
                    
                    // Quest Progress
                    quests.onEvent('sell', resType, amount);

                    game.save();
                    ui.updateStats();
                    ui.showFloatText(event.target, `+${totalGain} Золота`, "#c8aa6e");
                } else {
                    ui.showFloatText(event.target, "Не хватает ресурсов", "#ff5555");
                }
            }
        };

        // --- HOUSING CONTROLLER ---
        const housing = {
            buyPoorHouse: function() {
                if (gameState.emeralds >= 500) {
                    gameState.emeralds -= 500;
                    gameState.hasPoorHouse = true;
                    game.save();
                    ui.updateStats();
                    this.updateUI();
                    ui.showFloatText(event.target, "Дом куплен!", "#fbbf24");
                } else {
                    ui.showFloatText(event.target, "Нужно 500 изумрудов", "#ff5555");
                }
            },
            
            buyNobleHouse: function() {
                if (gameState.emeralds >= 10000) {
                    gameState.emeralds -= 10000;
                    gameState.hasNobleHouse = true;
                    game.save();
                    ui.updateStats();
                    this.updateUI();
                    ui.showFloatText(event.target, "Особняк куплен!", "#fbbf24");
                } else {
                    ui.showFloatText(event.target, "Нужно 10,000 изумрудов", "#ff5555");
                }
            },
            
            updateUI: function() {
                // Poor House
                const poorBuy = document.getElementById('poor-house-buy');
                const poorOwned = document.getElementById('poor-house-owned');
                if (poorBuy && poorOwned) {
                    if (gameState.hasPoorHouse) {
                        poorBuy.classList.add('hidden');
                        poorOwned.classList.remove('hidden');
                    } else {
                        poorBuy.classList.remove('hidden');
                        poorOwned.classList.add('hidden');
                    }
                }
                
                // Noble House
                const nobleBuy = document.getElementById('noble-house-buy');
                const nobleOwned = document.getElementById('noble-house-owned');
                if (nobleBuy && nobleOwned) {
                    if (gameState.hasNobleHouse) {
                        nobleBuy.classList.add('hidden');
                        nobleOwned.classList.remove('hidden');
                    } else {
                        nobleBuy.classList.remove('hidden');
                        nobleOwned.classList.add('hidden');
                    }
                }
            }
        };

        // --- VILLAGE CONTROLLER ---
        const village = {
            buyHouse: function() {
                if (gameState.emeralds >= 1000) {
                    gameState.emeralds -= 1000;
                    gameState.hasHouse = true;
                    game.save();
                    ui.updateStats();
                    this.updateUI();
                    ui.showFloatText(event.target, "Дом куплен!", "#fbbf24");
                    game.addReputation(6, event.target);
                } else {
                    ui.showFloatText(event.target, "Нужно 1000 изумрудов", "#ff5555");
                }
            },

            updateUI: function() {
                const houseOwned = document.getElementById('house-owned');
                const houseNotOwned = document.getElementById('house-not-owned');
                const houseStatus = document.getElementById('house-status');
                const pigLevel = document.getElementById('pig-pen-level');
                const meatCount = document.getElementById('meat-count');
                const measlesWarning = document.getElementById('measles-warning');
                const cureSection = document.getElementById('cure-measles-section');
                
                if (gameState.hasHouse) {
                    if(houseOwned) houseOwned.classList.remove('hidden');
                    if(houseNotOwned) houseNotOwned.classList.add('hidden');
                    if(houseStatus) houseStatus.innerText = "Ваш";
                    if(houseStatus) houseStatus.className = "text-[10px] text-green-400";
                } else {
                    if(houseOwned) houseOwned.classList.add('hidden');
                    if(houseNotOwned) houseNotOwned.classList.remove('hidden');
                    if(houseStatus) houseStatus.innerText = "Не куплен";
                    if(houseStatus) houseStatus.className = "text-[10px] text-red-400";
                }
                
                if(pigLevel) pigLevel.innerText = gameState.pigPenLevel || 0;
                if(meatCount) meatCount.innerText = gameState.meat || 0;
                
                if (gameState.hasMeasles) {
                    if(measlesWarning) measlesWarning.classList.remove('hidden');
                    if(cureSection) cureSection.classList.remove('hidden');
                } else {
                    if(measlesWarning) measlesWarning.classList.add('hidden');
                    if(cureSection) cureSection.classList.add('hidden');
                }
            },

            upgradePigPen: function() {
                const cost = (gameState.pigPenLevel + 1) * 100;
                if (gameState.gold >= cost) {
                    gameState.gold -= cost;
                    gameState.pigPenLevel++;
                    game.save();
                    ui.updateStats();
                    this.updateUI();
                    ui.showFloatText(event.target, "Свинарник улучшен!", "#ec4899");
                } else {
                    ui.showFloatText(event.target, "Не хватает золота", "#ff5555");
                }
            },
            
            upgradePigPen: function() {
                const cost = (gameState.pigPenLevel + 1) * 100;
                if (gameState.gold >= cost) {
                    gameState.gold -= cost;
                    gameState.pigPenLevel++;
                    game.save();
                    ui.updateStats();
                    this.updateUI();
                    ui.showFloatText(event.target, "Свинарник улучшен!", "#ec4899");
                } else {
                    ui.showFloatText(event.target, "Не хватает золота", "#ff5555");
                }
            },
            
            collectMeat: function() {
                if (gameState.pigPenLevel < 1) {
                    ui.showFloatText(event.target, "Сначала постройте свинарник", "#ff5555");
                    return;
                }
                
                const now = Date.now();
                const timePassed = now - (gameState.lastMeatCollect || 0);
                const hoursPass = timePassed / 3600000;
                const meatGain = Math.floor(hoursPass * gameState.pigPenLevel);
                
                if (meatGain > 0) {
                    gameState.meat = (gameState.meat || 0) + meatGain;
                    gameState.lastMeatCollect = now;
                    game.save();
                    this.updateUI();
                    ui.showFloatText(event.target, `+${meatGain} Мяса`, "#ec4899");
                } else {
                    ui.showFloatText(event.target, "Подождите ещё", "#777");
                }
            },
            
            cureMeasles: function() {
                if (!gameState.hasMeasles) {
                    ui.showFloatText(event.target, "Вы здоровы", "#34d399");
                    return;
                }
                
                if (gameState.herbs >= 15 && gameState.mushrooms >= 10) {
                    gameState.herbs -= 15;
                    gameState.mushrooms -= 10;
                    gameState.hasMeasles = false;
                    game.save();
                    ui.updateStats();
                    this.updateUI();
                    ui.showFloatText(event.target, "Вы исцелены!", "#34d399");
                } else {
                    ui.showFloatText(event.target, "Нужно 15 трав и 10 грибов", "#ff5555");
                }
            },
            
            updateUI: function() {
                const houseOwned = document.getElementById('house-owned');
                const houseNotOwned = document.getElementById('house-not-owned');
                const houseStatus = document.getElementById('house-status');
                const pigLevel = document.getElementById('pig-pen-level');
                const meatCount = document.getElementById('meat-count');
                const measlesWarning = document.getElementById('measles-warning');
                const cureSection = document.getElementById('cure-measles-section');
                
                if (gameState.hasHouse) {
                    if(houseOwned) houseOwned.classList.remove('hidden');
                    if(houseNotOwned) houseNotOwned.classList.add('hidden');
                    if(houseStatus) houseStatus.innerText = "Ваш";
                    if(houseStatus) houseStatus.className = "text-[10px] text-green-400";
                } else {
                    if(houseOwned) houseOwned.classList.add('hidden');
                    if(houseNotOwned) houseNotOwned.classList.remove('hidden');
                    if(houseStatus) houseStatus.innerText = "Не куплен";
                    if(houseStatus) houseStatus.className = "text-[10px] text-red-400";
                }
                
                if(pigLevel) pigLevel.innerText = gameState.pigPenLevel || 0;
                if(meatCount) meatCount.innerText = gameState.meat || 0;
                
                if (gameState.hasMeasles) {
                    if(measlesWarning) measlesWarning.classList.remove('hidden');
                    if(cureSection) cureSection.classList.remove('hidden');
                } else {
                    if(measlesWarning) measlesWarning.classList.add('hidden');
                    if(cureSection) cureSection.classList.add('hidden');
                }
            }
        };

        // --- BULLETIN BOARD CONTROLLER ---
        const bulletin = {
            quests: {
                fish_delivery: { id: 'fish_delivery', title: 'Рыба для таверны', target: 'fish', count: 10, reward: { gold: 100, xp: 15 } },
                herbs_delivery: { id: 'herbs_delivery', title: 'Травы для лекаря', target: 'herbs', count: 8, reward: { gold: 80, xp: 10 } },
                ore_delivery: { id: 'ore_delivery', title: 'Руда для кузнеца', target: 'ore', count: 5, reward: { gold: 200, xp: 25 } }
            },
            
            acceptQuest: function(questId) {
                const quest = this.quests[questId];
                if (!quest) return;
                
                // Check if already have this quest
                if (hasStoryQuest('bulletin_' + questId)) {
                    ui.showFloatText(event.target, "Уже взято", "#ff5555");
                    return;
                }
                
                // Check if player has enough resources to complete immediately
                const hasResources = gameState[quest.target] >= quest.count;
                
                if (hasResources) {
                    // Complete immediately
                    gameState[quest.target] -= quest.count;
                    gameState.gold += quest.reward.gold;
                    game.addXp(quest.reward.xp);
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(event.target, `+${quest.reward.gold} Золота +${quest.reward.xp} XP`, "#fbbf24");
                    game.addReputation(2, event.target);
                } else {
                    // Add as story quest
                    dialogue.addQuest(
                        'bulletin_' + questId,
                        quest.title,
                        `Принести ${quest.count} ${RESOURCE_NAMES[quest.target].name}`,
                        { type: 'gather', target: quest.target, count: quest.count },
                        quest.reward
                    );
                }
            }
        };

        // --- DISEASE SYSTEM ---
        const disease = {
            startTick: function() {
                setInterval(() => {
                    if (gameState.hasMeasles && gameState.hp > 1) {
                        const now = Date.now();
                        if (now - (gameState.lastMeaslesTick || 0) >= 20000) {
                            gameState.hp = Math.max(1, gameState.hp - 1);
                            gameState.lastMeaslesTick = now;
                            game.save();
                            ui.updateStats();
                        }
                    }
                }, 1000);
            },
            
            tryInfect: function() {
                // 5% chance to get measles in the forest
                if (!gameState.hasMeasles && Math.random() < 0.05) {
                    gameState.hasMeasles = true;
                    gameState.lastMeaslesTick = Date.now();
                    game.save();
                    ui.showFloatText(document.body, "Вы заразились Корью!", "#ef4444");
                    village.updateUI();
                }
            }
        };

        // --- SKILLS CONTROLLER ---
        const skills = {
            upgrade: function(type) {
                if (gameState.skillPoints < 1) {
                    ui.showFloatText(event.target, "Нет жетонов", "#ff5555");
                    return;
                }
                
                if (type === 'hp') {
                    gameState.skillPoints--;
                    gameState.maxHp += 20;
                    gameState.hp += 20;
                    ui.showFloatText(event.target, "+20 Max HP", "#ef4444");
                } else if (type === 'luck') {
                    gameState.skillPoints--;
                    gameState.luck = (gameState.luck || 0) + 1;
                    ui.showFloatText(event.target, "+1 Удача", "#34d399");
                } else if (type === 'agility') {
                    gameState.skillPoints--;
                    gameState.agility = (gameState.agility || 0) + 1;
                    ui.showFloatText(event.target, "+1 Ловкость", "#3b82f6");
                }
                
                game.save();
                ui.updateStats();
            }
        };

        // --- CRAFTING & INVENTORY ---
        const crafting = {
            mode: 'inventory', 
            toggleMode: function() {
                const invUI = document.getElementById('ui-inventory');
                const craftUI = document.getElementById('ui-crafting');
                const btnText = document.getElementById('craft-btn-text');

                if (this.mode === 'inventory') {
                    this.mode = 'crafting';
                    invUI.classList.add('hidden');
                    craftUI.classList.remove('hidden');
                    btnText.innerText = 'Вернуться в рюкзак';
                } else {
                    this.mode = 'inventory';
                    invUI.classList.remove('hidden');
                    craftUI.classList.add('hidden');
                    btnText.innerText = 'Перейти к крафту';
                    inventory.render();
                }
            },
            switchCategory: function(cat) {
                document.querySelectorAll('#ui-crafting .sub-tab').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-craft-${cat}`).classList.add('active');
            }
        };

        const inventory = {
            currentCategory: 'tools',
            switchCategory: function(cat) {
                this.currentCategory = cat;
                document.querySelectorAll('#ui-inventory .sub-tab').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-inv-${cat}`).classList.add('active');
                this.render();
            },
            render: function() {
                const grid = document.getElementById('inventory-grid');
                grid.innerHTML = ''; 
                if (this.currentCategory === 'tools') {
                    Object.keys(TOOLS_DB).forEach(key => {
                        const state = gameState.tools[key];
                        if (state.owned) {
                            const db = TOOLS_DB[key];
                            const el = document.createElement('div');
                            el.className = 'aspect-square bg-[#1a1a1d] border border-[#c8aa6e] rounded flex flex-col items-center justify-center relative p-1';
                            el.innerHTML = `
                                <i class="fas ${db.icon} text-[#c8aa6e] text-xl mb-1"></i>
                                <span class="text-[8px] uppercase text-center leading-tight text-gray-400">${db.name}</span>
                                <span class="absolute top-0 right-1 text-[8px] text-white font-bold">${state.level}</span>
                            `;
                            grid.appendChild(el);
                        }
                    });
                } else if (this.currentCategory === 'other') {
                     const resList = ['fish', 'wheat', 'ore', 'leather', 'mushrooms', 'wood', 'stone', 'herbs'];
                     resList.forEach(r => {
                         if (gameState[r] > 0) {
                            const def = RESOURCE_NAMES[r];
                            const el = document.createElement('div');
                            el.className = 'aspect-square bg-[#1a1a1d] border border-[#c8aa6e] rounded flex flex-col items-center justify-center relative p-1';
                            el.innerHTML = `
                                <i class="fas ${def.icon} text-[#c8aa6e] text-xl mb-1"></i>
                                <span class="text-[8px] uppercase text-center leading-tight text-gray-400">${def.name}</span>
                                <span class="absolute top-0 right-1 text-[8px] text-white font-bold">${gameState[r]}</span>
                            `;
                            grid.appendChild(el);
                         }
                     });
                }
                const children = grid.children.length;
                for(let i=0; i < (12 - children); i++) {
                    grid.appendChild(this.createEmptySlot());
                }
            },
            createEmptySlot: function() {
                const el = document.createElement('div');
                el.className = 'aspect-square bg-[#111] border border-[#333] rounded';
                return el;
            }
        };

        // --- UI HANDLER ---
        const ui = {
            updateAll: function() {
                this.updateStats();
                this.updateJobs();
                this.updateLocations();
                this.updateUnconsciousUI();
                market.renderTools();
                ui.updateMarketCounts();
                if (document.getElementById('market-trade-sell')) {
                    market.switchTradeMode(market.tradeMode || 'sell');
                }
                market.updateTradePrices();
                if (crafting.mode === 'inventory' && !document.getElementById('view-character').classList.contains('hidden') && document.getElementById('ui-skills').classList.contains('hidden')) {
                    inventory.render();
                }
                if(router.currentTab === 'quests') quests.render();
            },

            updateMarketCounts: function() {
                Object.keys(RESOURCE_NAMES).forEach(key => {
                    const el = document.getElementById(`market-count-${key}`);
                    if (el) el.innerText = gameState[key] || 0;
                });
            },

            buildMarketCategories: function() {
                if (market.categoriesBuilt) return;
                const list = [
                    {
                        id: 'food',
                        title: 'Еда',
                        tone: 'amber',
                        items: ['fish', 'meat', 'mushrooms', 'bread', 'eggs', 'milk']
                    },
                    {
                        id: 'metals',
                        title: 'Металлы',
                        tone: 'slate',
                        items: ['ore', 'bronze', 'silver']
                    },
                    {
                        id: 'other',
                        title: 'Другое',
                        tone: 'emerald',
                        items: ['wheat', 'wood', 'stone', 'herbs', 'leather']
                    }
                ];

                const container = document.getElementById('market-trade-grid');
                if (!container) return;
                container.innerHTML = '';

                list.forEach(group => {
                    const section = document.createElement('div');
                    section.className = `col-span-2 panel p-3 rounded border-${group.tone}-900/30 bg-${group.tone}-900/10`;
                    section.innerHTML = `
                        <div class="flex items-center gap-2 text-[10px] text-[#c8aa6e] uppercase tracking-widest mb-2">
                            <i class="fas fa-layer-group"></i> ${group.title}
                        </div>
                        <div id="market-group-${group.id}" class="grid grid-cols-2 gap-3"></div>
                    `;
                    container.appendChild(section);

                    const groupGrid = section.querySelector(`#market-group-${group.id}`);
                    group.items.forEach(item => {
                        const def = RESOURCE_NAMES[item];
                        const card = document.createElement('div');
                        card.className = 'panel p-2 rounded flex flex-col items-center text-center border-[#333] bg-black/20';
                        card.innerHTML = `
                            <i class="fas ${def.icon} text-[#c8aa6e] mb-1"></i>
                            <div class="text-xs text-[#e0e0e0]">${def.name}</div>
                            <div class="text-[10px] text-[#a0a0a0] mb-1"><span id="price-${item}">0</span> <i class="fas fa-coins"></i></div>
                            <div class="text-[10px] text-blue-300 mb-1">У вас: <span id="market-count-${item}">0</span></div>
                            <div class="flex gap-1 w-full mb-1">
                                <input id="trade-input-${item}" type="number" min="1" value="1" class="w-full bg-[#111] border border-[#333] text-center text-[10px] text-white rounded p-0 outline-none focus:border-[#c8aa6e]">
                                <button onclick="market.setMax('${item}')" class="w-auto px-2 bg-[#222] border border-[#444] rounded text-[10px] text-gray-400 hover:text-white">Max</button>
                            </div>
                            <button onclick="market.sellFromInput('${item}')" id="btn-trade-${item}" class="w-full bg-[#2c2c30] border border-[#c8aa6e] rounded text-[10px] py-1 text-[#c8aa6e] hover:bg-[#c8aa6e] hover:text-black transition-colors uppercase">Продать</button>
                        `;
                        groupGrid.appendChild(card);
                    });
                });
                market.categoriesBuilt = true;
                market.updateTradePrices();
                ui.updateMarketCounts();
                market.switchTradeMode(market.tradeMode || 'sell');
            },

            updateStats: function() {
                document.getElementById('gold-display').innerText = gameState.gold;
                document.getElementById('emerald-display').innerText = gameState.emeralds;
                document.getElementById('char-level').innerText = gameState.level;
                
                const bankDisplay = document.getElementById('bank-display');
                if(bankDisplay) bankDisplay.innerText = gameState.bankedGold;
                const bankMini = document.getElementById('bank-display-mini');
                if(bankMini) bankMini.innerText = gameState.bankedGold;
                const walletMini = document.getElementById('wallet-display');
                if(walletMini) walletMini.innerText = gameState.gold;
                
                document.getElementById('level-display-header').innerText = `Ур ${gameState.level}`;
                const percent = Math.min(100, (gameState.xp / gameState.xpToNextLevel) * 100);
                const charBar = document.getElementById('xp-bar');
                if (charBar) charBar.style.width = `${percent}%`;
                const headerBar = document.getElementById('header-xp-bar');
                if (headerBar) headerBar.style.width = `${percent}%`;
                const xpText = document.getElementById('xp-text');
                if (xpText) xpText.innerText = `${gameState.xp} / ${gameState.xpToNextLevel} XP`;
                const headerXpText = document.getElementById('header-xp-text');
                if (headerXpText) headerXpText.innerText = `${gameState.xp}/${gameState.xpToNextLevel}`;
                const remaining = Math.max(0, gameState.xpToNextLevel - gameState.xp);
                const xpRemElement = document.getElementById('xp-remaining');
                if(xpRemElement) xpRemElement.innerText = remaining;
                document.getElementById('header-hp-text').innerText = gameState.hp;
                const hpPercent = (gameState.hp / gameState.maxHp) * 100;
                document.getElementById('hp-bar').style.width = `${hpPercent}%`;
                document.getElementById('hp-text').innerText = `${gameState.hp} / ${gameState.maxHp}`;
                ui.updateMarketCounts();

                const repValue = Math.max(0, Math.min(100, gameState.reputation || 0));
                const repValueEl = document.getElementById('rep-value');
                const repBar = document.getElementById('rep-bar');
                const repRank = document.getElementById('rep-rank');
                if (repValueEl) repValueEl.innerText = repValue;
                if (repBar) repBar.style.width = `${repValue}%`;
                if (repRank) {
                    let rankText = 'Безымянный странник';
                    if (repValue >= 80) rankText = 'Герой королевства';
                    else if (repValue >= 60) rankText = 'Прославленный защитник';
                    else if (repValue >= 40) rankText = 'Почтенный гражданин';
                    else if (repValue >= 20) rankText = 'Добрый житель';
                    repRank.innerText = rankText;
                }

                if (gameState.hp <= 0) {
                    const now = Date.now();
                    if (gameState.unconsciousUntil && gameState.unconsciousUntil > now) {
                        // Already unconscious, keep timer running
                    } else if (gameState.unconsciousUntil && gameState.unconsciousUntil <= now) {
                        game.checkUnconscious();
                    } else {
                        game.knockOut();
                    }
                } else if (gameState.hp < 14) {
                    const cooldown = 2 * 60 * 1000;
                    const lastWarn = gameState.lowHpWarnedAt || 0;
                    if (Date.now() - lastWarn > cooldown) {
                        this.showLowHpWarning();
                    }
                } else {
                    const lowHpModal = document.getElementById('modal-lowhp');
                    if (lowHpModal && lowHpModal.classList.contains('open')) {
                        lowHpModal.classList.remove('open');
                    }
                }
            },

            updateJobs: function() {
                const portReward = game.getJobReward('port');
                this.updateJobButton('port', 'rod', 0);
                document.getElementById('reward-port').innerText = `${portReward.gold} Рыбы`; 
                
                // Loader job visibility (unlocked by Alex)
                const loaderJob = document.getElementById('job-loader');
                if (loaderJob) {
                    if (gameState.npcStates && gameState.npcStates.alex_job_unlocked) {
                        loaderJob.classList.remove('hidden');
                    } else {
                        loaderJob.classList.add('hidden');
                    }
                }
                
                const fieldReward = game.getJobReward('field');
                this.updateJobButton('field', 'sickle', 5);
                document.getElementById('reward-field').innerText = `${fieldReward.gold} Пшеницы`;
                const mineReward = game.getJobReward('mine');
                this.updateJobButton('mine', 'pickaxe', 15);
                document.getElementById('reward-mine').innerText = `${mineReward.gold} Руды`;
                this.updateJobButton('hunter', 'crossbow', 30);

                // Update Skills UI
                const spEl = document.getElementById('skill-points-display');
                if(spEl) spEl.innerText = gameState.skillPoints || 0;
                const luckEl = document.getElementById('luck-display');
                if(luckEl) luckEl.innerText = gameState.luck || 0;
                const agilityEl = document.getElementById('agility-display');
                if(agilityEl) agilityEl.innerText = gameState.agility || 0;
            },

            switchCharTab: function(tab) {
                document.getElementById('btn-tab-inv').className = "flex-1 bg-[#1a1a1d] border border-[#333] text-[#777] py-1 rounded text-xs uppercase font-serif transition-colors";
                document.getElementById('btn-tab-skills').className = "flex-1 bg-[#1a1a1d] border border-[#333] text-[#777] py-1 rounded text-xs uppercase font-serif transition-colors";
                
                document.getElementById(`btn-tab-${tab === 'inventory' ? 'inv' : 'skills'}`).className = "flex-1 bg-[#2c2c30] border border-[#c8aa6e] text-[#c8aa6e] py-1 rounded text-xs uppercase font-serif transition-colors";
                
                document.getElementById('ui-inventory').classList.add('hidden');
                document.getElementById('ui-crafting').classList.add('hidden');
                document.getElementById('ui-skills').classList.add('hidden');
                
                if (tab === 'inventory') {
                    // Reset crafting mode when switching tabs
                    crafting.mode = 'inventory';
                    document.getElementById('ui-inventory').classList.remove('hidden');
                    document.getElementById('craft-btn-text').innerText = 'Перейти к крафту';
                    inventory.render();
                } else {
                    document.getElementById('ui-skills').classList.remove('hidden');
                }
            },

            updateJobButton: function(jobId, toolId, lvlReq) {
                const btn = document.getElementById(`btn-work-${jobId}`);
                const info = document.getElementById(`job-info-${jobId}`);
                const container = document.getElementById(`job-${jobId}`);
                const toolOwned = gameState.tools[toolId].owned;
                const levelMet = gameState.level >= lvlReq;
                if (container) {
                     if (levelMet) container.classList.remove('opacity-50');
                     else container.classList.add('opacity-50');
                }
                if (!levelMet) {
                    btn.disabled = true;
                    btn.innerHTML = `<i class="fas fa-lock text-xs"></i> Требуется Уровень ${lvlReq}`;
                } else if (!toolOwned) {
                    btn.disabled = false;
                    btn.innerHTML = `<i class="fas fa-shopping-cart text-xs"></i> Требуется ${TOOLS_DB[toolId].name}`;
                } else {
                    btn.disabled = false;
                    let actionName = 'Работать';
                    let icon = 'fa-hammer';
                    if(jobId === 'port') { actionName = 'Рыбачить'; icon = 'fa-fish'; }
                    else if(jobId === 'field') { actionName = 'Собрать'; icon = 'fa-seedling'; }
                    else if(jobId === 'mine') { actionName = 'Добывать'; icon = 'fa-hammer'; }
                    else if(jobId === 'hunter') { actionName = 'Охотиться'; icon = 'fa-crosshairs'; }
                    btn.innerHTML = `<i class="fas ${icon} mr-2"></i> ${actionName}`;
                }
                if(info) {
                    if(toolOwned) info.innerHTML = `<span class="text-green-500"><i class="fas fa-check"></i> ${TOOLS_DB[toolId].name} (Ур ${gameState.tools[toolId].level})</span>`;
                    else info.innerHTML = `Требуется: ${TOOLS_DB[toolId].name}`;
                }
            },
            
            showFloatText: function(element, text, color) {
                const rect = element.getBoundingClientRect();
                const floatEl = document.createElement('div');
                floatEl.className = 'floating-text';
                floatEl.innerText = text;
                floatEl.style.color = color;
                floatEl.style.left = (rect.left + rect.width / 2) + 'px';
                floatEl.style.top = (rect.top) + 'px';
                document.body.appendChild(floatEl);
                setTimeout(() => { floatEl.remove(); }, 1000);
            },

            updateLocations: function() {
                // Tavern Brawl Timer
                const brawlTimerEl = document.getElementById('brawl-timer');
                const brawlBtn = document.getElementById('btn-brawl');
                if (brawlTimerEl && brawlBtn) {
                    const now = Date.now();
                    const last = gameState.lastBrawlTime || 0;
                    const cooldown = 3600000;
                    if (now - last < cooldown) {
                        const left = Math.ceil((cooldown - (now - last)) / 60000);
                        brawlTimerEl.innerText = `${left} мин`;
                        brawlTimerEl.className = "text-gray-500 font-mono";
                        brawlBtn.disabled = true;
                        brawlBtn.classList.add('opacity-50');
                        brawlBtn.innerText = "Отдых...";
                    } else {
                        brawlTimerEl.innerText = "Доступно";
                        brawlTimerEl.className = "text-[#c8aa6e] font-mono";
                        brawlBtn.disabled = false;
                        brawlBtn.classList.remove('opacity-50');
                        brawlBtn.innerHTML = "Выйти на бой";
                    }
                }

                // Rent Logic
                const statusEl = document.getElementById('rent-status');
                const btn = document.getElementById('btn-rent-room');
                if (gameState.rentExpiry > new Date().getTime()) {
                    // Logic here if needed
                }

                // Dark Forest Lock Logic
                const forestBtn = document.getElementById('btn-loc-forest');
                const forestDesc = document.getElementById('forest-desc');
                const forestIcon = document.getElementById('forest-lock-icon');
                
                if (forestBtn && forestDesc && forestIcon) {
                    if (gameState.level < 5) {
                        forestBtn.onclick = function() { ui.showFloatText(forestBtn, "Требуется Уровень 5", "#ff5555"); };
                        forestBtn.classList.add('opacity-50', 'grayscale');
                        forestBtn.classList.remove('hover:border-[#c8aa6e]');
                        forestDesc.innerText = "Требуется Уровень 5";
                        forestDesc.className = "text-xs text-red-400";
                        forestIcon.className = "fas fa-lock text-red-500 z-10";
                    } else {
                        forestBtn.onclick = function() { router.navigate('dark-forest'); };
                        forestBtn.classList.remove('opacity-50', 'grayscale');
                        forestBtn.classList.add('hover:border-[#c8aa6e]');
                        forestDesc.innerText = "Опасность и редкие травы";
                        forestDesc.className = "text-xs text-gray-300";
                        forestIcon.className = "fas fa-chevron-right text-gray-400 z-10";
                    }
                }

                // Training Camp Lock Logic
                const campBtn = document.getElementById('btn-loc-camp');
                const campDesc = document.getElementById('camp-desc');
                const campIcon = document.getElementById('camp-lock-icon');

                if (campBtn && campDesc && campIcon) {
                    if (gameState.level < 15) {
                         campBtn.onclick = function() { ui.showFloatText(campBtn, "Требуется Уровень 15", "#ff5555"); };
                         campBtn.classList.add('opacity-50', 'grayscale');
                         campBtn.classList.remove('hover:border-[#c8aa6e]');
                         campDesc.innerText = "Требуется Уровень 15";
                         campDesc.className = "text-xs text-red-400";
                         campIcon.className = "fas fa-lock text-red-500 z-10";
                    } else {
                         campBtn.onclick = function() { router.navigate('training-camp'); };
                         campBtn.classList.remove('opacity-50', 'grayscale');
                         campBtn.classList.add('hover:border-[#c8aa6e]');
                         campDesc.innerText = "Путь воина";
                         campDesc.className = "text-xs text-red-300";
                         campIcon.className = "fas fa-chevron-right text-gray-400 z-10";
                    }
                }

                // Refugee Camp Logic
                const refBtn = document.getElementById('btn-loc-refugee');
                const refDesc = document.getElementById('refugee-desc');
                const refIcon = document.getElementById('refugee-lock-icon');
                
                if (refBtn && refDesc && refIcon) {
                    if (gameState.npcStates && gameState.npcStates.thomas_met) {
                        refBtn.classList.remove('opacity-60');
                        refBtn.onclick = function() { router.navigate('refugee-camp'); };
                        refDesc.innerText = "Убежище изгоев";
                        refDesc.className = "text-xs text-gray-400";
                        refIcon.className = "fas fa-chevron-right text-gray-400 z-10";
                    } else {
                        refBtn.classList.add('opacity-60');
                        refBtn.onclick = function() { ui.showFloatText(refBtn, "Закрыто", "#777"); };
                        refDesc.innerText = "Тайное место";
                        refDesc.className = "text-xs text-gray-500";
                        refIcon.className = "fas fa-lock text-gray-600 z-10";
                    }
                }
            },

            showDailyModal: function() {
                const daysContainer = document.getElementById('daily-days-container');
                daysContainer.innerHTML = '';
                const streak = gameState.dailyStreak;
                const rewards = [5, 10, 15, 20, 30];
                rewards.forEach((amt, idx) => {
                    const dayNum = idx + 1;
                    const isCurrent = (streak > 5 && idx === 4) || (streak === dayNum);
                    const isPassed = streak > dayNum;
                    let bgClass = 'bg-[#111] border-gray-700 text-gray-500';
                    if (isPassed) bgClass = 'bg-emerald-900 border-emerald-700 text-emerald-400';
                    if (isCurrent) bgClass = 'bg-[#c8aa6e] border-yellow-500 text-black font-bold scale-110 shadow-lg';
                    const el = document.createElement('div');
                    el.className = `w-10 h-12 rounded border flex flex-col items-center justify-center text-[10px] ${bgClass}`;
                    el.innerHTML = `<span>Д${dayNum}</span><span class="${isCurrent ? 'text-black' : (isPassed ? 'text-emerald-400' : 'text-emerald-700')}">${amt}</span>`;
                    daysContainer.appendChild(el);
                });
                let todayReward = 30;
                if (streak <= 4) todayReward = rewards[streak-1];
                document.getElementById('daily-amount').innerText = todayReward;
                document.getElementById('modal-daily').classList.add('open');
            },

            updateUnconsciousUI: function() {
                const modal = document.getElementById('modal-unconscious');
                if (!modal) return;
                const now = Date.now();
                const active = gameState.unconsciousUntil && gameState.unconsciousUntil > now;

                if (active) {
                    modal.classList.add('open');
                    document.body.classList.add('unconscious');
                    this.updateTimerVisuals(); // Update immediately to prevent "10:00" flash
                } else {
                    modal.classList.remove('open');
                    document.body.classList.remove('unconscious');
                }
            },

            updateTimerVisuals: function() {
                if (gameState.unconsciousUntil && gameState.unconsciousUntil > Date.now()) {
                    const remaining = Math.max(0, Math.floor((gameState.unconsciousUntil - Date.now()) / 1000));
                    const minutes = Math.floor(remaining / 60);
                    const seconds = remaining % 60;
                    const timerEl = document.getElementById('unconscious-timer');
                    if (timerEl) {
                        timerEl.innerText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    }
                }
            },

            showLowHpWarning: function() {
                const modal = document.getElementById('modal-lowhp');
                if (!modal) return;
                if (gameState.unconsciousUntil && gameState.unconsciousUntil > Date.now()) return;
                if (modal.classList.contains('open')) return;
                modal.classList.add('open');
                gameState.lowHpWarnedAt = Date.now();
                game.save();
            },

            dismissLowHpWarning: function() {
                const modal = document.getElementById('modal-lowhp');
                if (modal) modal.classList.remove('open');
            },

            maybeTriggerTreasuryPouch: function() {
                if (gameState.treasuryPouchResolved) return;
                if (gameState.level < 3) return;
                if (gameState.npcStates && gameState.npcStates.treasuryPouchSeen) return;
                if (Math.random() < 0.35) {
                    if (!gameState.npcStates) gameState.npcStates = {};
                    gameState.npcStates.treasuryPouchSeen = true;
                    game.save();
                    setTimeout(() => {
                        ui.showTreasuryPouch();
                    }, 400);
                }
            },

            maybeTriggerBookhousePouch: function() {
                if (gameState.bookhousePouchResolved) return;
                if (gameState.level < 5) return;
                if (gameState.npcStates && gameState.npcStates.bookhousePouchSeen) return;
                if (Math.random() < 0.35) {
                    if (!gameState.npcStates) gameState.npcStates = {};
                    gameState.npcStates.bookhousePouchSeen = true;
                    game.save();
                    setTimeout(() => {
                        ui.showBookhousePouch();
                    }, 400);
                }
            },

            openRepInfo: function() {
                const modal = document.getElementById('modal-reputation');
                if (modal) modal.classList.add('open');
            },

            closeRepInfo: function() {
                const modal = document.getElementById('modal-reputation');
                if (modal) modal.classList.remove('open');
            },

            showTreasuryPouch: function() {
                const modal = document.getElementById('modal-treasury-pouch');
                if (modal) modal.classList.add('open');
            },

            resolveTreasuryPouch: function(choice) {
                const modal = document.getElementById('modal-treasury-pouch');
                if (modal) modal.classList.remove('open');
                if (gameState.treasuryPouchResolved) return;

                if (choice === 'return') {
                    game.addReputation(3, document.body);
                    ui.showFloatText(document.body, "+3 Репутации", "#34d399");
                } else {
                    gameState.gold += 1000;
                    game.addReputation(-5, document.body);
                    ui.showFloatText(document.body, "+1000 Золота", "#fbbf24");
                }

                gameState.treasuryPouchResolved = true;
                game.save();
                ui.updateStats();
            },

            showBookhousePouch: function() {
                const modal = document.getElementById('modal-bookhouse-pouch');
                if (modal) modal.classList.add('open');
            },

            resolveBookhousePouch: function(choice) {
                const modal = document.getElementById('modal-bookhouse-pouch');
                if (modal) modal.classList.remove('open');
                if (gameState.bookhousePouchResolved) return;

                if (choice === 'return') {
                    game.addReputation(3, document.body);
                    ui.showFloatText(document.body, "+3 Репутации", "#34d399");
                } else {
                    gameState.emeralds += 10;
                    game.addReputation(-5, document.body);
                    ui.showFloatText(document.body, "+10 Изумрудов", "#34d399");
                }

                gameState.bookhousePouchResolved = true;
                game.save();
                ui.updateStats();
            }
        };

        // --- ROUTER ---
        const router = {
            currentTab: 'map',
            switchTab: function(tabId) {
                this.currentTab = tabId;
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const activeNav = document.getElementById(`nav-${tabId}`);
                if(activeNav) activeNav.classList.add('active');
                document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                const view = document.getElementById(`view-${tabId}`);
                if(view) view.classList.remove('hidden');
                if (tabId === 'map') {
                    document.getElementById('view-jobs').classList.add('hidden');
                    document.getElementById('view-town-square').classList.add('hidden');
                    document.getElementById('view-tavern').classList.add('hidden');
                    document.getElementById('view-treasury').classList.add('hidden');
                    document.getElementById('view-dark-forest').classList.add('hidden');
                    document.getElementById('view-map').classList.remove('hidden');
                }
                if (tabId === 'market') {
                    market.switchCategory('tools');
                    market.buildTradeCategories();
                    ui.updateAll();
                }
                if (tabId === 'character') {
                    if (crafting.mode === 'inventory') inventory.render();
                }
                if (tabId === 'quests') {
                    quests.render();
                }
            },
            navigate: function(screenId) {
                document.getElementById('view-map').classList.add('hidden');
                document.getElementById('view-jobs').classList.add('hidden');
                document.getElementById('view-town-square').classList.add('hidden');
                document.getElementById('view-tavern').classList.add('hidden');
                document.getElementById('view-treasury').classList.add('hidden');
                document.getElementById('view-dark-forest').classList.add('hidden');
                const trainingCamp = document.getElementById('view-training-camp');
                if (trainingCamp) trainingCamp.classList.add('hidden');
                const villageView = document.getElementById('view-village');
                if (villageView) villageView.classList.add('hidden');
                const healerView = document.getElementById('view-healer');
                if (healerView) healerView.classList.add('hidden');
                const bookHouseView = document.getElementById('view-bookhouse');
                if (bookHouseView) bookHouseView.classList.add('hidden');
                const bulletinView = document.getElementById('view-bulletin');
                if (bulletinView) bulletinView.classList.add('hidden');
                const castleView = document.getElementById('view-royal-castle');
                if (castleView) castleView.classList.add('hidden');
                const poorView = document.getElementById('view-poor-district');
                if (poorView) poorView.classList.add('hidden');
                const nobleView = document.getElementById('view-noble-quarter');
                if (nobleView) nobleView.classList.add('hidden');
                const refugeeView = document.getElementById('view-refugee-camp');
                if (refugeeView) refugeeView.classList.add('hidden');
                const tailorView = document.getElementById('view-tailor');
                if (tailorView) tailorView.classList.add('hidden');
                const shoemakerView = document.getElementById('view-shoemaker');
                if (shoemakerView) shoemakerView.classList.add('hidden');
                
                const target = document.getElementById(`view-${screenId}`);
                if (target) target.classList.remove('hidden');
                if(screenId === 'jobs') ui.updateJobs();
                if(screenId === 'market' || screenId === 'treasury' || screenId === 'healer' || screenId === 'bookhouse') {
                    ui.updateAll();
                    if (screenId === 'market') {
                        market.switchTradeMode(market.tradeMode || 'sell');
                    }
                }
                if(screenId === 'poor-district' || screenId === 'noble-quarter') housing.updateUI();
                if (screenId === 'noble-quarter') {
                    if (!gameState.clothes || !gameState.clothes.peasant) {
                        dialogue.start('noble_guard');
                        router.navigate('map');
                        ui.showFloatText(document.body, "Нужна одежда крестьянина", "#fbbf24");
                        return;
                    }
                    quests.onEvent('visit', 'noble-quarter', 1);
                    // Trigger quest completion if active
                    quests.onEvent('visit', 'noble-quarter', 1);
                }
                if(screenId === 'village') {
                    village.updateUI();
                    if (!gameState.npcStates) gameState.npcStates = {};
                    if (!gameState.npcStates.villageBanditsDone && Math.random() < 0.35) {
                        gameState.npcStates.villageBanditsTriggered = true;
                        setTimeout(() => {
                            dialogue.start('bandits_village');
                        }, 400);
                    }
                }

                if (screenId === 'treasury') {
                    ui.maybeTriggerTreasuryPouch();
                }
                if (screenId === 'bookhouse') {
                    ui.maybeTriggerBookhousePouch();
                }
            }
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {


            // Enhance router.switchTab to call updateLocations
            const originalSwitchTab = router.switchTab;
            router.switchTab = function(tabId) {
                originalSwitchTab.call(router, tabId);
                if (tabId === 'map') {
                    ui.updateLocations();
                }
            };

            // Enhance game.levelUp to call updateLocations
            const originalLevelUp = game.levelUp;
            game.levelUp = function() {
                originalLevelUp.call(game);
                ui.updateLocations();
            };

            game.init();
            router.switchTab('map');
            
            // Start disease tick
            disease.startTick();

            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    game.checkUnconscious();
                    ui.updateUnconsciousUI();
                }
            });

            setInterval(() => {
                game.checkUnconscious();
                // We don't need to call updateUnconsciousUI constantly, just the timer text
                if (gameState.unconsciousUntil && gameState.unconsciousUntil > Date.now()) {
                    ui.updateTimerVisuals();
                } else if (document.getElementById('modal-unconscious').classList.contains('open') && (!gameState.unconsciousUntil || gameState.unconsciousUntil <= Date.now())) {
                    // Close modal if timer expired naturally
                    ui.updateUnconsciousUI();
                }
            }, 1000);
        });

    </script>
</body>
</html>
