<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WAR SAGA: WHEEL OF FORTUNE</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #0a0a0a;
            --card-bg: #141414;
            --gold: #ffcc00;
            --emerald: #2ecc71;
            --text-main: #e0e0e0;
            --text-dim: #888;
            --accent: #b8860b;
            --red: #f44336;
            --blue: #3498db;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text-main); font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        header { padding: 15px; background: var(--card-bg); border-bottom: 1px solid #333; }
        .stats-top { display: flex; justify-content: space-around; font-weight: bold; margin-bottom: 8px; }
        .xp-container { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .xp-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }

        nav { position: fixed; bottom: 0; width: 100%; background: var(--card-bg); border-top: 1px solid #333; display: flex; justify-content: space-around; padding: 10px 0; padding-bottom: max(10px, env(safe-area-inset-bottom)); z-index: 100; }
        .nav-item { text-align: center; color: var(--text-dim); font-size: 10px; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--gold); }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }

        main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card-bg); border: 1px solid #333; border-radius: 12px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; gap: 15px; position: relative; }
        .card .icon { font-size: 30px; min-width: 50px; text-align: center; }
        .card .info { flex: 1; }
        
        .btn { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; text-align: center; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background: #333; color: #666; cursor: not-allowed; }

        /* WHEEL STYLES */
        .wheel-container { position: relative; width: 180px; height: 180px; margin: 15px auto; }
        #wheel { width: 100%; height: 100%; border-radius: 50%; border: 4px solid var(--gold); background: conic-gradient(var(--accent) 0deg 60deg, #222 60deg 120deg, var(--blue) 120deg 180deg, #222 180deg 240deg, var(--emerald) 240deg 300deg, #222 300deg 360deg); transition: transform 4s cubic-bezier(0.15, 0, 0.15, 1); }
        .wheel-pointer { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 20px; height: 25px; background: var(--red); clip-path: polygon(50% 100%, 0 0, 100% 0); z-index: 10; }

        .profile-header { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; }
        .avatar { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--gold); background: #222; display: flex; align-items: center; justify-content: center; font-size: 24px; overflow: hidden; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-box { background: #1a1a1a; padding: 10px; border-radius: 8px; border: 1px solid #222; }
        
        .float-text { position: fixed; pointer-events: none; font-weight: bold; animation: floatUp 0.8s forwards; z-index: 1000; }
        @keyframes floatUp { to { transform: translateY(-50px); opacity: 0; } }
    </style>
</head>
<body>

<header>
    <div class="stats-top">
        <span>ü™ô <span id="ui-gold">0</span></span>
        <span>üíé <span id="ui-emeralds">0</span></span>
        <span>‚≠ê <span id="ui-lvl">1</span></span>
    </div>
    <div class="xp-container"><div id="ui-xp" class="xp-bar"></div></div>
</header>

<main>
    <section id="tab-battle" class="screen active">
        <h2 style="color: var(--gold); margin-bottom: 15px;">–ö–∞—Ä—Ç–∞ –ú–∏—Ä–∞</h2>
        <div id="world-map"></div>
    </section>

    <section id="tab-town" class="screen">
        <h2 style="color: var(--gold); margin-bottom: 15px;">üèôÔ∏è –ì–æ—Ä–æ–¥</h2>
        <div class="card" onclick="game.openTownPlace('tavern')">
            <div class="icon">üç∫</div>
            <div class="info"><h3>–¢–∞–≤–µ—Ä–Ω–∞</h3><p>–ö–æ–ª–µ—Å–æ —É–¥–∞—á–∏ –∏ –Ω–∞–µ–º–Ω–∏–∫–∏</p></div>
        </div>
        <div class="card" onclick="game.openTownPlace('forge')">
            <div class="icon">‚öíÔ∏è</div>
            <div class="info"><h3>–ö—É–∑–Ω–∏—Ü–∞</h3><p>–°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ –≥–µ—Ä–æ—è</p></div>
        </div>
        <div class="card" onclick="game.openTownPlace('stables')">
            <div class="icon">üêé</div>
            <div class="info"><h3>–ö–æ–Ω—é—à–Ω–∏</h3><p>–ú–∞—É–Ω—Ç—ã –¥–ª—è —Ñ–∞—Ä–º–∞</p></div>
        </div>
    </section>

    <section id="tab-town-detail" class="screen">
        <button class="btn" style="background: #333; margin-bottom: 15px; width: 100%;" onclick="game.switchTab('town')">‚Üê –ù–∞–∑–∞–¥ –≤ –≥–æ—Ä–æ–¥</button>
        <div id="town-detail-content"></div>
    </section>

    <section id="tab-profile" class="screen">
        <div class="profile-header">
            <div class="avatar" id="user-avatar">üë§</div>
            <div><h2 id="user-name">–ì–µ—Ä–æ–π</h2><p id="user-rank" style="color: var(--accent);">–°—Ç—Ä–∞–Ω–Ω–∏–∫</p></div>
        </div>
        <div class="stat-grid">
            <div class="stat-box">–ú–æ—â—å: <b id="st-power">1</b></div>
            <div class="stat-box">–î–æ—Ö–æ–¥: <b id="st-income">0</b>/—Å</div>
            <div class="stat-box">–ö–ª–∏–∫–∏: <b id="st-clicks">0</b></div>
            <div class="stat-box">–ì–µ–º—ã: <b id="st-gems">0</b></div>
        </div>
    </section>

    <section id="tab-bank" class="screen">
        <h2 style="color: var(--blue); margin-bottom: 15px;">üèõÔ∏è –ë–∞–Ω–∫</h2>
        <div class="card" style="flex-direction: column; text-align: center;">
            <p>–ù–∞–∫–æ–ø–ª–µ–Ω–æ –∑–æ–ª–æ—Ç–∞:</p>
            <h1 style="color: var(--gold);">ü™ô <span id="bank-val">0</span></h1>
            <p style="font-size: 12px;">–õ–∏–º–∏—Ç: <span id="bank-limit">0</span></p>
            <button class="btn" style="background: var(--blue); width: 100%;" onclick="game.collectBank()">–ó–ê–ë–†–ê–¢–¨</button>
        </div>
    </section>
</main>

<nav>
    <div class="nav-item active" onclick="game.switchTab('battle', this)"><span class="nav-icon">‚öîÔ∏è</span>–ë–∏—Ç–≤–∞</div>
    <div class="nav-item" onclick="game.switchTab('town', this)"><span class="nav-icon">üèôÔ∏è</span>–ì–æ—Ä–æ–¥</div>
    <div class="nav-item" onclick="game.switchTab('profile', this)"><span class="nav-icon">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</div>
    <div class="nav-item" onclick="game.switchTab('bank', this)"><span class="nav-icon">üèõÔ∏è</span>–ë–∞–Ω–∫</div>
</nav>

<script>
const DB = {
    locations: [
        { id: 'forest', name: '–õ–µ—Å', icon: 'üå≤', lvl: 1, gold: 2, xp: 5 },
        { id: 'cave', name: '–ü–µ—â–µ—Ä–∞', icon: 'ü¶á', lvl: 5, gold: 10, xp: 20 },
        { id: 'castle', name: '–ó–∞–º–æ–∫', icon: 'üè∞', lvl: 15, gold: 50, xp: 100 }
    ],
    gear: [
        { id: 'item1', name: '–ú–µ—á', power: 3, price: 100, icon: 'üó°Ô∏è' },
        { id: 'item2', name: '–ë—Ä–æ–Ω—è', power: 5, price: 500, icon: 'üëï' }
    ],
    workers: [
        { id: 'w1', name: '–†–∞–±–æ—á–∏–π', income: 1, price: 50, icon: 'üë®‚Äçüåæ' }
    ],
    mounts: [
        { id: 'm1', name: '–û—Å–ª–∏–∫', mult: 1.2, price: 1000, icon: 'ü´è' }
    ]
};

const game = {
    state: {
        gold: 0, emeralds: 0, lvl: 1, xp: 0, xpNeed: 100,
        inventory: [], workers: {}, currentMount: null,
        totalClicks: 0, bankGold: 0, lastSave: Date.now()
    },

    init() {
        const saved = localStorage.getItem('WAR_SAGA_V3');
        if (saved) Object.assign(this.state, JSON.parse(saved));
        
        if (window.Telegram?.WebApp) {
            const user = window.Telegram.WebApp.initDataUnsafe?.user;
            if (user) document.getElementById('user-name').innerText = user.first_name;
            window.Telegram.WebApp.expand();
        }

        const diff = Math.floor((Date.now() - this.state.lastSave) / 1000);
        this.state.bankGold = Math.min(this.state.bankGold + (diff * this.getIncome()), this.getBankLimit());

        this.renderMap();
        this.updateUI();
        setInterval(() => this.tick(), 1000);
    },

    getIncome() {
        return Object.keys(this.state.workers).reduce((sum, id) => {
            const w = DB.workers.find(x => x.id === id);
            return sum + (w.income * this.state.workers[id]);
        }, 0);
    },

    getPower() {
        let p = 1;
        this.state.inventory.forEach(id => {
            const item = DB.gear.find(x => x.id === id);
            if (item) p += item.power;
        });
        return p;
    },

    getBankLimit() { return this.state.lvl * 2000; },

    tick() {
        const inc = this.getIncome();
        if (inc > 0) this.state.bankGold = Math.min(this.state.bankGold + inc, this.getBankLimit());
        this.state.lastSave = Date.now();
        this.updateUI();
        this.save();
    },

    handleAttack(locId, e) {
        const loc = DB.locations.find(l => l.id === locId);
        if (this.state.lvl < loc.lvl) return;
        const gain = Math.floor(loc.gold * this.getPower() * (this.state.currentMount ? 1.5 : 1));
        this.state.gold += gain;
        this.state.totalClicks++;
        if (Math.random() < 0.02) this.state.emeralds++;
        this.addXp(loc.xp);
        this.showFloat(e, `+${gain}ü™ô`, "var(--gold)");
        this.updateUI();
    },

    addXp(val) {
        this.state.xp += val;
        if (this.state.xp >= this.state.xpNeed) {
            this.state.lvl++;
            this.state.xp = 0;
            this.state.xpNeed = Math.floor(this.state.xpNeed * 1.5);
        }
    },

    collectBank() {
        this.state.gold += Math.floor(this.state.bankGold);
        this.state.bankGold = 0;
        this.updateUI();
    },

    spinWheel() {
        if (this.state.gold < 500) return alert("–ù—É–∂–Ω–æ 500 –∑–æ–ª–æ—Ç–∞!");
        const btn = document.getElementById('spin-btn');
        const wheel = document.getElementById('wheel');
        const msg = document.getElementById('wheel-msg');
        
        this.state.gold -= 500;
        btn.disabled = true;
        msg.innerText = "–£–¥–∞—á–∏...";
        
        const deg = Math.floor(Math.random() * 360) + 1800;
        wheel.style.transform = `rotate(${deg}deg)`;

        setTimeout(() => {
            btn.disabled = false;
            const finalDeg = deg % 360;
            if (finalDeg < 60) { this.state.gold += 1000; msg.innerText = "+1000 –ó–æ–ª–æ—Ç–∞!"; }
            else if (finalDeg < 120) { msg.innerText = "–ü—É—Å—Ç–æ..."; }
            else if (finalDeg < 180) { this.addXp(this.state.xpNeed*0.2); msg.innerText = "+–û–ø—ã—Ç!"; }
            else if (finalDeg < 240) { msg.innerText = "–ú–∏–º–æ..."; }
            else if (finalDeg < 300) { this.state.emeralds += 2; msg.innerText = "+2 –ì–µ–º–∞!"; }
            else { msg.innerText = "–ï—â–µ —Ä–∞–∑?"; }
            this.updateUI();
        }, 4000);
    },

    openTownPlace(place) {
        this.switchTab('town-detail');
        const content = document.getElementById('town-detail-content');
        if (place === 'tavern') {
            content.innerHTML = `
                <div class="card" style="flex-direction:column; text-align:center;">
                    <h3>üé° –ö–æ–ª–µ—Å–æ –£–¥–∞—á–∏</h3>
                    <div class="wheel-container"><div class="wheel-pointer"></div><div id="wheel"></div></div>
                    <button class="btn" id="spin-btn" style="width:100%" onclick="game.spinWheel()">–ö—Ä—É—Ç–∏—Ç—å (500 ü™ô)</button>
                    <p id="wheel-msg" style="margin-top:10px;"></p>
                </div>
                <h3>üë∑ –ù–∞–µ–º–Ω–∏–∫–∏</h3>` + 
                DB.workers.map(w => `<div class="card"><div class="icon">${w.icon}</div><div class="info"><b>${w.name}</b></div><button class="btn" onclick="game.buyW('${w.id}')">${w.price}ü™ô</button></div>`).join('');
        }
        if (place === 'forge') {
            content.innerHTML = `<h3>‚öíÔ∏è –ö—É–∑–Ω–∏—Ü–∞</h3>` + 
                DB.gear.map(g => `<div class="card"><div class="icon">${g.icon}</div><div class="info"><b>${g.name}</b></div><button class="btn" onclick="game.buyG('${g.id}')">${g.price}ü™ô</button></div>`).join('');
        }
    },

    buyW(id) {
        const w = DB.workers.find(x => x.id === id);
        if (this.state.gold >= w.price) { this.state.gold -= w.price; this.state.workers[id] = (this.state.workers[id]||0)+1; this.updateUI(); }
    },

    buyG(id) {
        const g = DB.gear.find(x => x.id === id);
        if (this.state.gold >= g.price && !this.state.inventory.includes(id)) { this.state.gold -= g.price; this.state.inventory.push(id); this.updateUI(); }
    },

    renderMap() {
        document.getElementById('world-map').innerHTML = DB.locations.map(loc => `<div class="card" onclick="game.handleAttack('${loc.id}', event)"><div class="icon">${loc.icon}</div><div class="info"><b>${loc.name}</b><p>–£—Ä. ${loc.lvl}</p></div><button class="btn">–ë–û–ô</button></div>`).join('');
    },

    updateUI() {
        document.getElementById('ui-gold').innerText = Math.floor(this.state.gold);
        document.getElementById('ui-emeralds').innerText = this.state.emeralds;
        document.getElementById('ui-lvl').innerText = this.state.lvl;
        document.getElementById('ui-xp').style.width = (this.state.xp / this.state.xpNeed * 100) + "%";
        document.getElementById('st-power').innerText = this.getPower();
        document.getElementById('st-income').innerText = this.getIncome();
        document.getElementById('st-clicks').innerText = this.state.totalClicks;
        document.getElementById('st-gems').innerText = this.state.emeralds;
        document.getElementById('bank-val').innerText = Math.floor(this.state.bankGold);
        document.getElementById('bank-limit').innerText = this.getBankLimit();
    },

    switchTab(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
        if (el) { document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); el.classList.add('active'); }
    },

    showFloat(e, text, color) {
        const el = document.createElement('div');
        el.className = 'float-text'; el.innerText = text; el.style.color = color;
        el.style.left = (e.clientX || window.innerWidth/2) + 'px'; el.style.top = (e.clientY || window.innerHeight/2) + 'px';
        document.body.appendChild(el); setTimeout(() => el.remove(), 800);
    },

    save() { localStorage.setItem('WAR_SAGA_V3', JSON.stringify(this.state)); }
};

window.onload = () => game.init();
</script>
</body>
</html>
