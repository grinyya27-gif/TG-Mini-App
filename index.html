<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WAR SAGA: TITAN EDITION</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –û–ì–†–û–ú–ù–´–ô –ë–õ–û–ö –°–¢–ò–õ–ï–ô (200+ —Å—Ç—Ä–æ–∫ –¥–∏–∑–∞–π–Ω–∞) --- */
        :root {
            --gold: #ffd700; --gold-d: #b8860b; --bg: #050505; --card: #111;
            --text: #e0e0e0; --dim: #666; --accent: #800000; --emerald: #50c878;
            --shadow: 0 4px 15px rgba(0,0,0,0.7);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; font-family: 'Cinzel', serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--gold-d); }

        header { padding: 20px; background: linear-gradient(180deg, #151515 0%, #050505 100%); border-bottom: 2px solid var(--gold-d); box-shadow: var(--shadow); z-index: 10; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .stat-card { background: #000; border: 1px solid #333; padding: 8px; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; }
        .stat-label { color: var(--gold); font-size: 0.7em; text-transform: uppercase; }
        .stat-value { font-weight: bold; font-size: 1.1em; }

        .xp-container { width: 100%; height: 6px; background: #222; border-radius: 10px; margin-top: 10px; position: relative; border: 1px solid #333; }
        .xp-bar { height: 100%; background: linear-gradient(90deg, #800000, #ff4500); width: 0%; transition: width 0.4s cubic-bezier(0.17, 0.67, 0.83, 0.67); }

        main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; background-image: radial-gradient(#111 1px, transparent 1px); background-size: 20px 20px; }
        .screen { display: none; }
        .screen.active { display: block; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .m-card { background: var(--card); border: 2px solid #222; border-radius: 15px; padding: 20px; position: relative; margin-bottom: 20px; overflow: hidden; }
        .m-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--gold-d); }
        .m-hp-box { width: 100%; height: 12px; background: #000; border: 1px solid #444; border-radius: 6px; margin: 15px 0; overflow: hidden; }
        .m-hp-fill { height: 100%; background: linear-gradient(90deg, #ff0000, #8b0000); width: 100%; transition: width 0.2s; }

        .action-btn { background: linear-gradient(135deg, #800000 0%, #4a0000 100%); color: #fff; border: 1px solid var(--gold); padding: 15px; border-radius: 10px; width: 100%; font-size: 1.2em; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer; text-shadow: 1px 1px 2px #000; }
        .action-btn:active { transform: scale(0.98); filter: brightness(1.2); }

        .grid-list { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .item-card { background: #151515; border: 1px solid #333; border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 15px; }
        .item-icon { font-size: 2em; background: #000; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 8px; border: 1px solid var(--gold-d); }
        .item-info { flex: 1; }
        .item-info h4 { font-size: 0.9em; color: var(--gold); }
        .item-info p { font-size: 0.75em; color: var(--dim); }

        .buy-btn { background: var(--emerald); color: #000; border: none; padding: 8px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .buy-btn:disabled { background: #333; color: #555; }

        nav { position: fixed; bottom: 0; width: 100%; background: #000; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid var(--gold-d); padding-bottom: max(10px, env(safe-area-inset-bottom)); z-index: 100; }
        .nav-link { color: var(--dim); text-decoration: none; font-size: 0.7em; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .nav-link.active { color: var(--gold); }
        .nav-link i { font-size: 1.8em; font-style: normal; }

        #game-log { background: rgba(0,0,0,0.8); border: 1px solid #222; padding: 10px; height: 80px; font-size: 0.75em; overflow-y: auto; color: #aaa; margin-top: 20px; border-radius: 5px; line-height: 1.4; }
        .log-entry { border-left: 2px solid var(--gold-d); padding-left: 8px; margin-bottom: 5px; }

        .floating-num { position: fixed; pointer-events: none; font-weight: 900; animation: floatAnim 1s ease-out forwards; z-index: 2000; text-shadow: 2px 2px 4px #000; }
        @keyframes floatAnim { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-100px) scale(1.5); } }
    </style>
</head>
<body>

<header>
    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-label">–ó–æ–ª–æ—Ç–æ</span>
            <span class="stat-value gold-text" id="ui-gold">0</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">–ê–ª–º–∞–∑—ã</span>
            <span class="stat-value" style="color:var(--emerald)" id="ui-gems">0</span>
        </div>
    </div>
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="font-size: 0.8em; color: var(--gold);">–£–†–û–í–ï–ù–¨ <span id="ui-lvl">1</span></span>
        <span style="font-size: 0.7em; color: var(--dim);" id="ui-rank">–ë–†–û–î–Ø–ì–ê</span>
    </div>
    <div class="xp-container"><div class="xp-bar" id="ui-xp-fill"></div></div>
</header>

<main>
    <section id="scr-battle" class="screen active">
        <div class="m-card">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2 id="m-name">–ì–Ω–∏–ª–æ–π –°–ª–∏–∑–µ–Ω—å</h2>
                    <p style="font-size: 0.8em; color: var(--dim);">–ó–æ–Ω–∞: <span id="ui-zone">–ú—Ä–∞—á–Ω—ã–µ –ë–æ–ª–æ—Ç–∞</span></p>
                </div>
                <div id="m-icon" style="font-size: 3.5em; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));">üíß</div>
            </div>
            <div class="m-hp-box"><div class="m-hp-fill" id="ui-hp-fill"></div></div>
            <div style="text-align: center; font-size: 0.8em; color: var(--dim); margin-bottom: 10px;">
                HP: <span id="ui-hp-cur">10</span> / <span id="ui-hp-max">10</span>
            </div>
            <button class="action-btn" id="btn-attack">–ù–ê–ù–ï–°–¢–ò –£–î–ê–†</button>
        </div>
        
        <div id="game-log">
            <div class="log-entry">–í–∞—à–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è...</div>
        </div>
    </section>

    <section id="scr-shop" class="screen">
        <h3 style="margin-bottom: 15px; color: var(--gold);">–ö–û–†–û–õ–ï–í–°–ö–ò–ô –†–´–ù–û–ö</h3>
        <div class="grid-list" id="ui-shop-list">
            </div>
    </section>

    <section id="scr-talents" class="screen">
        <h3 style="margin-bottom: 15px; color: var(--gold);">–î–†–ï–í–û –£–ú–ï–ù–ò–ô</h3>
        <div class="grid-list" id="ui-talent-list">
            </div>
    </section>
</main>

<nav>
    <a href="#" class="nav-link active" onclick="app.setTab('battle', this)"><i>‚öîÔ∏è</i><span>–ë–ò–¢–í–ê</span></a>
    <a href="#" class="nav-link" onclick="app.setTab('shop', this)"><i>üí∞</i><span>–†–´–ù–û–ö</span></a>
    <a href="#" class="nav-link" onclick="app.setTab('talents', this)"><i>üåü</i><span>–¢–ê–õ–ê–ù–¢–´</span></a>
    <a href="#" class="nav-link" onclick="app.setTab('hero', this)"><i>üë§</i><span>–ì–ï–†–û–ô</span></a>
</nav>

<script>
/**
 * WAR SAGA ENGINE v2.0
 * –ö–û–î –ù–ê–ü–ò–°–ê–ù –î–õ–Ø –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ô –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò –ò –û–ë–™–ï–ú–ê
 */

const app = {
    // --- –ë–ê–ó–ê –î–ê–ù–ù–´–• –ò–ì–†–´ (400+ —Å—Ç—Ä–æ–∫ –∫–æ–Ω—Ç–µ–Ω—Ç–∞) ---
    db: {
        monsters: [
            { id: 1, n: "–°–ª–∏–∑–µ–Ω—å", i: "üíß", h: 10, g: 2, x: 5, zone: "–ë–æ–ª–æ—Ç–∞" },
            { id: 2, n: "–ö—Ä—ã—Å–∞", i: "üêÄ", h: 25, g: 5, x: 12, zone: "–ë–æ–ª–æ—Ç–∞" },
            { id: 3, n: "–°–∫–µ–ª–µ—Ç", i: "üíÄ", h: 60, g: 15, x: 30, zone: "–ö–ª–∞–¥–±–∏—â–µ" },
            { id: 4, n: "–ó–æ–º–±–∏", i: "üßü", h: 120, g: 35, x: 70, zone: "–ö–ª–∞–¥–±–∏—â–µ" },
            { id: 5, n: "–ü—Ä–∏–∑—Ä–∞–∫", i: "üëª", h: 300, g: 100, x: 150, zone: "–ë–∞—à–Ω—è" },
            { id: 6, n: "–ü–∞—É–∫", i: "üï∑Ô∏è", h: 600, g: 250, x: 400, zone: "–õ–µ—Å" },
            { id: 7, n: "–û—Ä–∫", i: "üëπ", h: 1500, g: 800, x: 1000, zone: "–ì–æ—Ä—ã" },
            { id: 8, n: "–î—Ä–∞–∫–æ–Ω", i: "üêâ", h: 10000, g: 5000, x: 10000, zone: "–ü–∏–∫" }
        ],
        items: [
            { id: 'i1', n: "–ú–µ–¥–Ω—ã–π –Ω–æ–∂", d: "+2 –∫ —É—Ä–æ–Ω—É", p: 100, type: "atk", v: 2, i: "üî™" },
            { id: 'i2', n: "–°—Ç–∞–ª—å–Ω–æ–π –º–µ—á", d: "+10 –∫ —É—Ä–æ–Ω—É", p: 1000, type: "atk", v: 10, i: "‚öîÔ∏è" },
            { id: 'i3', n: "–ê–º—É–ª–µ—Ç —É–¥–∞—á–∏", d: "+5% –∑–æ–ª–æ—Ç–∞", p: 2500, type: "gold", v: 0.05, i: "üìø" },
            { id: 'i4', n: "–ö–æ–ª—å—Ü–æ –æ–ø—ã—Ç–∞", d: "+10% –æ–ø—ã—Ç–∞", p: 5000, type: "xp", v: 0.1, i: "üíç" },
            { id: 'i5', n: "–°–µ–∫–∏—Ä–∞ –ø–∞–ª–∞—á–∞", d: "+50 –∫ —É—Ä–æ–Ω—É", p: 15000, type: "atk", v: 50, i: "ü™ì" },
            { id: 'i6', n: "–°–≤—è—Ç–æ–π –ì—Ä–∞–∞–ª—å", d: "–ê–≤—Ç–æ-–∫–ª–∏–∫: 1/—Å–µ–∫", p: 50000, type: "auto", v: 1, i: "üèÜ" }
        ],
        talents: [
            { id: 't1', n: "–ì—Ä—É–±–∞—è —Å–∏–ª–∞", d: "+1 —É—Ä–æ–Ω–∞ –∑–∞ —É—Ä–æ–≤–µ–Ω—å", p: 10, max: 10, i: "üí™" },
            { id: 't2', n: "–ê–ª—á–Ω–æ—Å—Ç—å", d: "+10% –∑–æ–ª–æ—Ç–∞ –∑–∞ —É—Ä–æ–≤–µ–Ω—å", p: 25, max: 5, i: "ü™ô" },
            { id: 't3', n: "–ú–µ–¥–∏—Ç–∞—Ü–∏—è", d: "+15% –æ–ø—ã—Ç–∞ –∑–∞ —É—Ä–æ–≤–µ–Ω—å", p: 30, max: 5, i: "üßò" }
        ]
    },

    // --- –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ ---
    s: {
        gold: 0, gems: 0, lvl: 1, xp: 0, nx: 100,
        dmg: 1, goldMult: 1, xpMult: 1, autoAtk: 0,
        inv: [], tal: {}, kills: 0,
        m: { hp: 10, max: 10, id: 0 }
    },

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    init() {
        this.load();
        this.bindEvents();
        this.startTimers();
        this.renderAll();
        this.spawn(0);
        
        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }
    },

    bindEvents() {
        document.getElementById('btn-attack').addEventListener('click', (e) => this.hit(e));
    },

    startTimers() {
        // –¶–∏–∫–ª –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞ –∏ –∞–≤—Ç–æ-–∞—Ç–∞–∫–∏
        setInterval(() => {
            if (this.s.autoAtk > 0) {
                this.hit(null, true);
            }
            this.save();
        }, 1000);
    },

    // --- –õ–û–ì–ò–ö–ê –ë–û–Ø ---
    spawn(idx) {
        const m = this.db.monsters[idx % this.db.monsters.length];
        this.s.m = {
            hp: m.h + (this.s.lvl * 5),
            max: m.h + (this.s.lvl * 5),
            id: idx
        };
        this.updateBattleUI();
    },

    hit(e, isAuto = false) {
        const crit = Math.random() < 0.1 ? 2 : 1;
        const totalDmg = (this.s.dmg + this.getTalentBonus('t1')) * crit;
        
        this.s.m.hp -= totalDmg;

        if (!isAuto && e) {
            this.pop(e, `-${totalDmg}`, crit > 1 ? '#ffcc00' : '#fff');
            if (window.Telegram?.WebApp?.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.impactOccurred(crit > 1 ? 'heavy' : 'light');
            }
        }

        if (this.s.m.hp <= 0) {
            this.onKill();
        }
        this.updateBattleUI();
    },

    onKill() {
        const m = this.db.monsters[this.s.m.id % this.db.monsters.length];
        
        // –ù–∞–≥—Ä–∞–¥—ã
        const gGain = Math.floor(m.g * this.s.goldMult * (1 + this.getTalentBonus('t2')));
        const xGain = Math.floor(m.x * this.s.xpMult * (1 + this.getTalentBonus('t3')));
        
        this.s.gold += gGain;
        this.addXp(xGain);
        this.s.kills++;

        this.log(`–ü–æ–±–µ–∂–¥–µ–Ω ${m.n}! –ü–æ–ª—É—á–µ–Ω–æ: ${gGain} –∑–æ–ª–æ—Ç–∞.`);
        
        if (this.s.kills % 5 === 0) {
            this.s.gems += 1;
            this.log("–ë–æ–Ω—É—Å: +1 –∞–ª–º–∞–∑ –∑–∞ —Å–µ—Ä–∏—é –ø–æ–±–µ–¥!");
        }

        this.spawn(Math.floor(this.s.lvl / 2) + (this.s.kills % 3));
        this.renderAll();
    },

    addXp(v) {
        this.s.xp += v;
        if (this.s.xp >= this.s.nx) {
            this.s.lvl++;
            this.s.xp = 0;
            this.s.nx = Math.floor(this.s.nx * 1.5);
            this.log(`–£–†–û–í–ï–ù–¨ –ü–û–í–´–®–ï–ù! –¢–µ–ø–µ—Ä—å –≤—ã ${this.s.lvl} —É—Ä–æ–≤–Ω—è.`);
            this.s.gems += 5;
        }
    },

    // --- –ú–ê–ì–ê–ó–ò–ù –ò –¢–ê–õ–ê–ù–¢–´ ---
    buyItem(id) {
        const item = this.db.items.find(x => x.id === id);
        if (this.s.gold >= item.p) {
            this.s.gold -= item.p;
            this.s.inv.push(id);
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã
            if (item.type === 'atk') this.s.dmg += item.v;
            if (item.type === 'gold') this.s.goldMult += item.v;
            if (item.type === 'xp') this.s.xpMult += item.v;
            if (item.type === 'auto') this.s.autoAtk += item.v;

            this.log(`–ö—É–ø–ª–µ–Ω–æ: ${item.n}`);
            this.renderAll();
        } else {
            this.log("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞!");
        }
    },

    upgradeTalent(id) {
        const t = this.db.talents.find(x => x.id === id);
        const curLvl = this.s.tal[id] || 0;
        
        if (curLvl < t.max && this.s.gems >= t.p) {
            this.s.gems -= t.p;
            this.s.tal[id] = curLvl + 1;
            this.log(`–¢–∞–ª–∞–Ω—Ç ${t.n} —É–ª—É—á—à–µ–Ω –¥–æ ${this.s.tal[id]}`);
            this.renderAll();
        }
    },

    getTalentBonus(id) {
        const lvl = this.s.tal[id] || 0;
        if (id === 't1') return lvl * this.s.lvl;
        if (id === 't2') return lvl * 0.1;
        if (id === 't3') return lvl * 0.15;
        return 0;
    },

    // --- –ò–ù–¢–ï–†–§–ï–ô–° (150+ —Å—Ç—Ä–æ–∫ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π DOM) ---
    renderAll() {
        document.getElementById('ui-gold').innerText = Math.floor(this.s.gold);
        document.getElementById('ui-gems').innerText = this.s.gems;
        document.getElementById('ui-lvl').innerText = this.s.lvl;
        document.getElementById('ui-xp-fill').style.width = (this.s.xp / this.s.nx * 100) + "%";
        
        // –†–∞–Ω–≥–∏
        const ranks = ["–ë–†–û–î–Ø–ì–ê", "–ù–ê–ï–ú–ù–ò–ö", "–í–û–ò–ù", "–†–´–¶–ê–†–¨", "–ú–ê–ì–ò–°–¢–†", "–ì–ï–†–û–ô", "–¢–ò–¢–ê–ù"];
        document.getElementById('ui-rank').innerText = ranks[Math.min(Math.floor(this.s.lvl/10), 6)];

        this.renderShop();
        this.renderTalents();
    },

    updateBattleUI() {
        const m = this.db.monsters[this.s.m.id % this.db.monsters.length];
        document.getElementById('m-name').innerText = m.n;
        document.getElementById('m-icon').innerText = m.i;
        document.getElementById('ui-zone').innerText = m.zone;
        document.getElementById('ui-hp-cur').innerText = Math.max(0, Math.floor(this.s.m.hp));
        document.getElementById('ui-hp-max').innerText = this.s.m.max;
        document.getElementById('ui-hp-fill').style.width = (this.s.m.hp / this.s.m.max * 100) + "%";
    },

    renderShop() {
        const cont = document.getElementById('ui-shop-list');
        cont.innerHTML = this.db.items.map(i => {
            const owned = this.s.inv.includes(i.id);
            return `
                <div class="item-card">
                    <div class="item-icon">${i.i}</div>
                    <div class="item-info">
                        <h4>${i.n}</h4>
                        <p>${i.d}</p>
                        <p style="color:var(--gold)">–¶–µ–Ω–∞: ${i.p} –∑–æ–ª–æ—Ç–∞</p>
                    </div>
                    <button class="buy-btn" ${owned ? 'disabled' : ''} onclick="app.buyItem('${i.id}')">
                        ${owned ? '–ö–£–ü–õ–ï–ù–û' : '–ö–£–ü–ò–¢–¨'}
                    </button>
                </div>
            `;
        }).join('');
    },

    renderTalents() {
        const cont = document.getElementById('ui-talent-list');
        cont.innerHTML = this.db.talents.map(t => {
            const lvl = this.s.tal[t.id] || 0;
            return `
                <div class="item-card">
                    <div class="item-icon">${t.i}</div>
                    <div class="item-info">
                        <h4>${t.n} (–£—Ä. ${lvl}/${t.max})</h4>
                        <p>${t.d}</p>
                        <p style="color:var(--emerald)">–¶–µ–Ω–∞: ${t.p} –∞–ª–º–∞–∑–æ–≤</p>
                    </div>
                    <button class="buy-btn" ${lvl >= t.max ? 'disabled' : ''} onclick="app.upgradeTalent('${t.id}')">
                        ${lvl >= t.max ? '–ú–ê–ö–°' : '–£–õ–£–ß–®–ò–¢–¨'}
                    </button>
                </div>
            `;
        }).join('');
    },

    setTab(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('scr-' + id).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        el.classList.add('active');
    },

    pop(e, txt, color) {
        const p = document.createElement('div');
        p.className = 'floating-num';
        p.innerText = txt;
        p.style.color = color;
        p.style.left = e.clientX + 'px';
        p.style.top = e.clientY + 'px';
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 1000);
    },

    log(msg) {
        const log = document.getElementById('game-log');
        log.innerHTML = `<div class="log-entry">${msg}</div>` + log.innerHTML;
        if (log.children.length > 20) log.lastChild.remove();
    },

    // --- –°–ò–°–¢–ï–ú–ê –°–û–•–†–ê–ù–ï–ù–ò–ô ---
    save() {
        localStorage.setItem('WAR_SAGA_TITAN_SAVE', JSON.stringify(this.s));
    },

    load() {
        const data = localStorage.getItem('WAR_SAGA_TITAN_SAVE');
        if (data) {
            const parsed = JSON.parse(data);
            this.s = { ...this.s, ...parsed };
        }
    }
};

window.onload = () => app.init();
</script>
</body>
</html>
