<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WAR SAGA: ELITE</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #0a0a0a;
            --card-bg: #141414;
            --gold: #ffcc00;
            --emerald: #2ecc71;
            --text-main: #e0e0e0;
            --text-dim: #888;
            --accent: #b8860b;
            --red: #f44336;
            --blue: #3498db;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text-main); font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { padding: 15px; background: var(--card-bg); border-bottom: 1px solid #333; }
        .stats-top { display: flex; justify-content: space-around; font-weight: bold; margin-bottom: 8px; }
        .xp-container { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .xp-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }

        /* NAVIGATION */
        nav { position: fixed; bottom: 0; width: 100%; background: var(--card-bg); border-top: 1px solid #333; display: flex; justify-content: space-around; padding: 10px 0; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .nav-item { text-align: center; color: var(--text-dim); font-size: 10px; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--gold); }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }

        /* SCREENS */
        main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* CARDS */
        .card { background: var(--card-bg); border: 1px solid #333; border-radius: 12px; padding: 15px; margin-bottom: 12px; }
        .btn { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background: #333; color: #666; }

        /* PROFILE SPECIFIC */
        .profile-header { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; }
        .avatar { width: 70px; height: 70px; border-radius: 50%; border: 2px solid var(--gold); display: flex; align-items: center; justify-content: center; font-size: 30px; background: #222; overflow: hidden; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-box { background: #1a1a1a; padding: 10px; border-radius: 8px; border: 1px solid #222; }
        .stat-label { font-size: 10px; color: var(--text-dim); display: block; }

        /* INVENTORY */
        .inv-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .inv-slot { aspect-ratio: 1; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; position: relative; }
        .inv-slot.equipped { border-color: var(--emerald); box-shadow: 0 0 5px var(--emerald); }

        .float-text { position: fixed; pointer-events: none; font-weight: bold; animation: floatUp 0.8s forwards; z-index: 100; }
        @keyframes floatUp { to { transform: translateY(-50px); opacity: 0; } }
    </style>
</head>
<body>

<header>
    <div class="stats-top">
        <span>ü™ô <span id="ui-gold">0</span></span>
        <span>üíé <span id="ui-emeralds">0</span></span>
        <span>‚≠ê <span id="ui-lvl">1</span></span>
    </div>
    <div class="xp-container"><div id="ui-xp" class="xp-bar"></div></div>
</header>

<main>
    <section id="tab-battle" class="screen active">
        <h2 style="color: var(--gold); margin-bottom: 15px;">–ö–∞—Ä—Ç–∞ –ú–∏—Ä–∞</h2>
        <div id="world-map"></div>
    </section>

    <section id="tab-profile" class="screen">
        <div class="profile-header">
            <div class="avatar" id="user-avatar">üë§</div>
            <div>
                <h2 id="user-name">–ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫</h2>
                <p id="user-rank" style="color: var(--accent); font-size: 14px;">–ù–æ–≤–∏—á–æ–∫</p>
            </div>
        </div>
        <div class="stat-grid">
            <div class="stat-box"><span class="stat-label">–ú–û–©–¨ –ö–õ–ò–ö–ê</span><b id="st-power">1</b></div>
            <div class="stat-box"><span class="stat-label">–û–ë–©–ò–ô –î–û–•–û–î</span><b id="st-income">0</b>/—Å</div>
            <div class="stat-box"><span class="stat-label">–í–°–ï–ì–û –ö–õ–ò–ö–û–í</span><b id="st-clicks">0</b></div>
            <div class="stat-box"><span class="stat-label">–ë–û–°–°–û–í –£–ë–ò–¢–û</span><b id="st-bosses">0</b></div>
        </div>
        <h3 style="margin-top: 20px; font-size: 14px; color: var(--text-dim);">–¢–í–û–ô –ò–ù–í–ï–ù–¢–ê–†–¨</h3>
        <div id="inventory-list" class="inv-grid"></div>
    </section>

    <section id="tab-bank" class="screen">
        <h2 style="color: var(--blue); margin-bottom: 15px;">–ö–æ—Ä–æ–ª–µ–≤—Å–∫–æ–µ –•—Ä–∞–Ω–∏–ª–∏—â–µ</h2>
        <div class="card" style="text-align: center;">
            <p style="color: var(--text-dim);">–ù–∞–∫–æ–ø–ª–µ–Ω–æ –∑–æ–ª–æ—Ç–∞:</p>
            <h1 style="font-size: 2.5em; color: var(--gold); margin: 10px 0;">ü™ô <span id="bank-val">0</span></h1>
            <p style="font-size: 12px;">–õ–∏–º–∏—Ç: <span id="bank-limit">1000</span> ü™ô</p>
            <button class="btn" style="background: var(--blue);" onclick="game.collectBank()">–ó–ê–ë–†–ê–¢–¨ –ó–û–õ–û–¢–û</button>
        </div>
        <div class="card">
            <h3>–û–±–º–µ–Ω–Ω–∏–∫</h3>
            <p style="font-size: 12px; margin-top: 5px;">–ü–æ–º–µ–Ω—è–π 10,000 ü™ô –Ω–∞ 1 üíé</p>
            <button class="btn" style="background: var(--emerald);" onclick="game.buyEmerald()">–ö–£–ü–ò–¢–¨ –ò–ó–£–ú–†–£–î</button>
        </div>
    </section>

    <section id="tab-shop" class="screen">
        <h2 style="color: var(--emerald); margin-bottom: 15px;">–õ–∞–≤–∫–∞ –∏ –ù–∞–µ–º–Ω–∏–∫–∏</h2>
        <div id="shop-list"></div>
    </section>
</main>

<nav>
    <div class="nav-item active" onclick="game.switchTab('battle', this)"><span class="nav-icon">‚öîÔ∏è</span>–ë–∏—Ç–≤–∞</div>
    <div class="nav-item" onclick="game.switchTab('profile', this)"><span class="nav-icon">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</div>
    <div class="nav-item" onclick="game.switchTab('bank', this)"><span class="nav-icon">üèõÔ∏è</span>–ë–∞–Ω–∫</div>
    <div class="nav-item" onclick="game.switchTab('shop', this)"><span class="nav-icon">üí∞</span>–ú–∞–≥–∞–∑–∏–Ω</div>
</nav>

<script>
const DB = {
    locations: [
        { id: 'forest', name: '–õ–µ—Å', icon: 'üå≤', lvl: 1, baseGold: 2, boss: '–í–æ–ª–∫', bossHp: 200 },
        { id: 'cave', name: '–ü–µ—â–µ—Ä–∞', icon: 'ü¶á', lvl: 5, baseGold: 10, boss: '–ü–∞—É–∫', bossHp: 1500 },
        { id: 'castle', name: '–ó–∞–º–æ–∫', icon: 'üè∞', lvl: 15, baseGold: 50, boss: '–†—ã—Ü–∞—Ä—å', bossHp: 10000 }
    ],
    gear: [
        { id: 'item1', name: '–ú–µ—á', power: 3, price: 100, icon: 'üó°Ô∏è' },
        { id: 'item2', name: '–ë—Ä–æ–Ω—è', power: 5, price: 500, icon: 'üëï' },
        { id: 'item3', name: '–ö–æ–ª—å—Ü–æ', power: 15, price: 2500, icon: 'üíç' }
    ],
    workers: [
        { id: 'w1', name: '–†–∞–±–æ—Ç—è–≥–∞', income: 1, price: 50, icon: 'üë®‚Äçüåæ' },
        { id: 'w2', name: '–û—Ö—Ä–∞–Ω–Ω–∏–∫', income: 5, price: 300, icon: 'üõ°Ô∏è' }
    ]
};

const game = {
    state: {
        gold: 0, emeralds: 0, lvl: 1, xp: 0, xpNeed: 100,
        inventory: [], totalClicks: 0, bossKills: 0,
        workers: {}, bankGold: 0, lastSave: Date.now()
    },

    init() {
        const saved = localStorage.getItem('WAR_SAGA_ELITE_DATA');
        if (saved) Object.assign(this.state, JSON.parse(saved));

        // Telegram Integration
        if (window.Telegram?.WebApp) {
            const user = window.Telegram.WebApp.initDataUnsafe?.user;
            if (user) {
                document.getElementById('user-name').innerText = user.first_name;
                if (user.photo_url) document.getElementById('user-avatar').innerHTML = `<img src="${user.photo_url}" style="width:100%">`;
            }
        }

        this.renderMap();
        this.renderShop();
        this.updateUI();
        
        // –û—Ñ—Ñ–ª–∞–π–Ω –¥–æ—Ö–æ–¥ (–ë–∞–Ω–∫)
        const diff = Math.floor((Date.now() - this.state.lastSave) / 1000);
        this.state.bankGold += diff * this.getAutoIncome();
        this.state.bankGold = Math.min(this.state.bankGold, this.getBankLimit());

        setInterval(() => this.tick(), 1000);
    },

    getAutoIncome() {
        let inc = 0;
        for (let id in this.state.workers) {
            const w = DB.workers.find(x => x.id === id);
            inc += w.income * this.state.workers[id];
        }
        return inc;
    },

    getPower() {
        let p = 1;
        this.state.inventory.forEach(id => {
            const item = DB.gear.find(x => x.id === id);
            if (item) p += item.power;
        });
        return p;
    },

    getBankLimit() { return this.state.lvl * 2000; },

    tick() {
        const inc = this.getAutoIncome();
        if (inc > 0) {
            this.state.bankGold = Math.min(this.state.bankGold + inc, this.getBankLimit());
        }
        this.state.lastSave = Date.now();
        this.updateUI();
        this.save();
    },

    handleAttack(locId, e) {
        const loc = DB.locations.find(l => l.id === locId);
        const gain = loc.baseGold * this.getPower();
        
        this.state.gold += gain;
        this.state.totalClicks++;
        this.addXp(loc.baseGold);
        this.showFloat(e, `+${gain}ü™ô`, 'var(--gold)');
        this.updateUI();
    },

    addXp(val) {
        this.state.xp += val;
        if (this.state.xp >= this.state.xpNeed) {
            this.state.lvl++;
            this.state.xp = 0;
            this.state.xpNeed = Math.floor(this.state.xpNeed * 1.5);
        }
    },

    collectBank() {
        this.state.gold += Math.floor(this.state.bankGold);
        this.state.bankGold = 0;
        this.updateUI();
    },

    buyEmerald() {
        if (this.state.gold >= 10000) {
            this.state.gold -= 10000;
            this.state.emeralds++;
            this.updateUI();
        }
    },

    buyItem(id, type) {
        if (type === 'gear') {
            const item = DB.gear.find(x => x.id === id);
            if (this.state.gold >= item.price && !this.state.inventory.includes(id)) {
                this.state.gold -= item.price;
                this.state.inventory.push(id);
            }
        } else {
            const w = DB.workers.find(x => x.id === id);
            const price = Math.floor(w.price * Math.pow(1.15, this.state.workers[id] || 0));
            if (this.state.gold >= price) {
                this.state.gold -= price;
                this.state.workers[id] = (this.state.workers[id] || 0) + 1;
            }
        }
        this.renderShop();
        this.updateUI();
    },

    renderMap() {
        const html = DB.locations.map(loc => `
            <div class="card" onclick="game.handleAttack('${loc.id}', event)">
                <div style="display:flex; justify-content:space-between">
                    <span>${loc.icon} <b>${loc.name}</b></span>
                    <span style="color:var(--text-dim)">–£—Ä. ${loc.lvl}</span>
                </div>
                <button class="btn">–ê–¢–ê–ö–û–í–ê–¢–¨</button>
            </div>
        `).join('');
        document.getElementById('world-map').innerHTML = html;
    },

    renderShop() {
        let html = '<h4>–°–ù–ê–†–Ø–ñ–ï–ù–ò–ï</h4>';
        html += DB.gear.map(i => {
            const owned = this.state.inventory.includes(i.id);
            return `
                <div class="card" style="display:flex; align-items:center; gap:10px">
                    <span style="font-size:24px">${i.icon}</span>
                    <div style="flex:1"><b>${i.name}</b><br><small>–ú–æ—â—å +${i.power}</small></div>
                    <button class="btn" style="width:80px" onclick="game.buyItem('${i.id}','gear')" ${owned?'disabled':''}>${owned?'–ö–£–ü–õ–ï–ù–û':i.price}</button>
                </div>
            `;
        }).join('');

        html += '<h4 style="margin-top:15px">–ù–ê–ï–ú–ù–ò–ö–ò</h4>';
        html += DB.workers.map(w => {
            const count = this.state.workers[w.id] || 0;
            const price = Math.floor(w.price * Math.pow(1.15, count));
            return `
                <div class="card" style="display:flex; align-items:center; gap:10px">
                    <span style="font-size:24px">${w.icon}</span>
                    <div style="flex:1"><b>${w.name}</b> (${count})<br><small>–î–æ—Ö–æ–¥ +${w.income}/—Å</small></div>
                    <button class="btn" style="width:80px" onclick="game.buyItem('${w.id}','worker')">${price}</button>
                </div>
            `;
        }).join('');
        document.getElementById('shop-list').innerHTML = html;
    },

    updateUI() {
        document.getElementById('ui-gold').innerText = Math.floor(this.state.gold);
        document.getElementById('ui-emeralds').innerText = this.state.emeralds;
        document.getElementById('ui-lvl').innerText = this.state.lvl;
        document.getElementById('ui-xp').style.width = (this.state.xp / this.state.xpNeed * 100) + '%';
        
        // Profile Stats
        document.getElementById('st-power').innerText = this.getPower();
        document.getElementById('st-income').innerText = this.getAutoIncome();
        document.getElementById('st-clicks').innerText = this.state.totalClicks;
        document.getElementById('st-bosses').innerText = this.state.bossKills;
        
        // Bank Stats
        document.getElementById('bank-val').innerText = Math.floor(this.state.bankGold);
        document.getElementById('bank-limit').innerText = this.getBankLimit();

        // Inventory
        const invHtml = this.state.inventory.map(id => {
            const item = DB.gear.find(x => x.id === id);
            return `<div class="inv-slot equipped">${item.icon}</div>`;
        }).join('');
        document.getElementById('inventory-list').innerHTML = invHtml + '<div class="inv-slot"></div>'.repeat(Math.max(0, 8 - this.state.inventory.length));
    },

    switchTab(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    },

    showFloat(e, text, color) {
        const el = document.createElement('div');
        el.className = 'float-text';
        el.innerText = text;
        el.style.color = color;
        el.style.left = (e.clientX || window.innerWidth/2) + 'px';
        el.style.top = (e.clientY || window.innerHeight/2) + 'px';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 800);
    },

    save() { localStorage.setItem('WAR_SAGA_ELITE_DATA', JSON.stringify(this.state)); }
};

window.onload = () => game.init();
</script>
</body>
</html>
