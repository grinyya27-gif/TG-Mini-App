<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spark ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∑–Ω–∞–∫–æ–º—Å—Ç–≤</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

    :root{
      --spark-pink:#ec4899;
      --spark-rose:#f43f5e;
    }

    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#f8fafc;
      overflow:hidden;
      height:100vh;
    }

    .no-scrollbar::-webkit-scrollbar{display:none;}
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }

    .card-stack{
      position:relative;
      width:100%;
      height:70vh;
      max-width:420px;
      margin:0 auto;
    }

    .swipe-card{
      position:absolute;
      width:100%;
      height:100%;
      border-radius:22px;
      user-select:none;
      touch-action:none;
      cursor:grab;
      will-change:transform,opacity;
      transition: transform .25s ease, opacity .25s ease;
      overflow:hidden;
      background:white;
    }

    .swipe-card:active{ cursor:grabbing; }

    .gradient-overlay{
      background: linear-gradient(0deg, rgba(0,0,0,.86) 0%, rgba(0,0,0,0) 55%);
    }

    .btn-shadow{ box-shadow: 0 10px 24px rgba(15,23,42,.10); }

    .nav-active{ color: var(--spark-pink); }

    /* Simple line clamp without Tailwind plugin */
    .line-clamp-2{
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    /* iOS safe-area bottom padding */
    .safe-bottom{ padding-bottom: calc(1rem + env(safe-area-inset-bottom)); }

    .kbd{ border:1px solid rgba(148,163,184,.45); background:rgba(241,245,249,.8); border-bottom-width:2px; }

    .pulse-ring{
      box-shadow: 0 0 0 0 rgba(236,72,153,.45);
      animation: ring 1.6s infinite;
    }

    @keyframes ring{
      0%{ box-shadow:0 0 0 0 rgba(236,72,153,.45); }
      70%{ box-shadow:0 0 0 18px rgba(236,72,153,0); }
      100%{ box-shadow:0 0 0 0 rgba(236,72,153,0); }
    }
  </style>
</head>
<body class="flex flex-col">

  <div id="app" class="relative max-w-md mx-auto w-full h-screen bg-white shadow-2xl overflow-hidden flex flex-col">

    <!-- Header -->
    <header id="main-header" class="flex items-center justify-between px-6 py-4 border-b border-gray-100 bg-white">
      <div class="flex items-center gap-2">
        <div class="w-9 h-9 bg-pink-500 rounded-xl flex items-center justify-center">
          <i data-lucide="flame" class="text-white w-5 h-5"></i>
        </div>
        <div class="leading-tight">
          <h1 class="text-2xl font-extrabold bg-gradient-to-r from-pink-500 to-rose-500 bg-clip-text text-transparent italic">Spark</h1>
          <div class="flex items-center gap-2 text-[11px] text-gray-400 -mt-0.5">
            <span id="header-stats">0 –ª–∞–π–∫–æ–≤ ‚Ä¢ 0 –º–∞—Ç—á–µ–π</span>
            <span id="boost-pill" class="hidden px-2 py-0.5 rounded-full bg-pink-50 text-pink-600 font-semibold">Boost 00:30</span>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div onclick="toggleShop()" class="flex items-center bg-amber-50 px-2 py-1 rounded-full border border-amber-200 cursor-pointer hover:bg-amber-100 transition shadow-sm">
          <i data-lucide="coins" class="w-4 h-4 text-amber-500 mr-1.5"></i>
          <span id="header-coins" class="text-sm font-bold text-amber-600">0</span>
        </div>
        <button id="btn-notif" onclick="toggleNotifications()" class="relative text-gray-300 hover:text-gray-600" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
          <i data-lucide="bell" class="w-5 h-5"></i>
          <span id="notif-badge" class="hidden absolute -top-1 -right-1 min-w-5 h-5 px-1 bg-pink-500 text-white text-[10px] rounded-full flex items-center justify-center border-2 border-white font-extrabold">1</span>
        </button>
        <button onclick="toggleSettings()" class="text-gray-400 hover:text-gray-600" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
          <i data-lucide="sliders-horizontal"></i>
        </button>
      </div>
    </header>

    <!-- Main -->
    <main id="main-content" class="flex-1 relative overflow-hidden bg-gray-50">

      <!-- Feed View -->
      <div id="view-feed" class="h-full flex flex-col pt-6 pb-20">
        <div id="card-container" class="card-stack px-4 relative">
          <div id="empty-state" class="hidden absolute inset-0 flex flex-col items-center justify-center text-center p-8">
            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
              <i data-lucide="users" class="text-gray-400 w-10 h-10"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-800">–ü—Ä–æ—Ñ–∏–ª–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å</h3>
            <p class="text-gray-500 mt-2">–ò–∑–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ –ª–µ–Ω—Ç—É.</p>
            <div class="flex gap-2 mt-6">
              <button onclick="resetFeed()" class="px-6 py-2 bg-pink-500 text-white rounded-full font-medium">–û–±–Ω–æ–≤–∏—Ç—å</button>
              <button onclick="toggleSettings(true)" class="px-6 py-2 bg-white border border-gray-200 rounded-full font-medium text-gray-700">–§–∏–ª—å—Ç—Ä—ã</button>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div id="action-buttons" class="flex items-center justify-center space-x-4 mt-auto mb-4 px-4">
          <button id="btn-rewind" onclick="undoSwipe()" class="w-12 h-12 flex items-center justify-center rounded-full bg-white text-yellow-500 btn-shadow border border-gray-100 hover:scale-110 transition" title="–û—Ç–º–µ–Ω–∏—Ç—å">
            <i data-lucide="rotate-ccw" class="w-6 h-6"></i>
          </button>
          <button id="btn-nope" onclick="handleManualAction('pass')" class="w-16 h-16 flex items-center justify-center rounded-full bg-white text-rose-500 btn-shadow border border-gray-100 hover:scale-110 transition" title="–ù–µ—Ç">
            <i data-lucide="x" class="w-8 h-8"></i>
          </button>
          <button id="btn-super" onclick="handleManualAction('superlike')" class="w-12 h-12 flex items-center justify-center rounded-full bg-white text-blue-500 btn-shadow border border-gray-100 hover:scale-110 transition" title="–°—É–ø–µ—Ä–ª–∞–π–∫">
            <i data-lucide="star" class="w-6 h-6 fill-current"></i>
          </button>
          <button id="btn-like" onclick="handleManualAction('like')" class="w-16 h-16 flex items-center justify-center rounded-full bg-white text-emerald-500 btn-shadow border border-gray-100 hover:scale-110 transition" title="–õ–∞–π–∫">
            <i data-lucide="heart" class="w-8 h-8 fill-current"></i>
          </button>
          <button id="btn-boost" onclick="toggleBoost()" class="w-12 h-12 flex items-center justify-center rounded-full bg-white text-purple-500 btn-shadow border border-gray-100 hover:scale-110 transition" title="Boost (30 —Å–µ–∫)">
            <i data-lucide="zap" class="w-6 h-6 fill-current"></i>
          </button>
        </div>


      </div>

      <!-- Messages View -->
      <div id="view-messages" class="hidden h-full flex flex-col bg-white">
        <div id="messages-list-container" class="flex flex-col h-full">
          <div class="px-6 py-4">
            <h2 class="text-xl font-extrabold mb-4">–ù–æ–≤—ã–µ –ø–∞—Ä—ã</h2>
            <div id="matches-row" class="flex space-x-4 overflow-x-auto no-scrollbar pb-2"></div>
          </div>

          <div class="px-6 py-4 border-t border-gray-100 flex-1 overflow-y-auto no-scrollbar">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-extrabold">–°–æ–æ–±—â–µ–Ω–∏—è</h2>
              <button onclick="markAllRead()" class="text-xs text-gray-400 hover:text-gray-600">–ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å—ë</button>
            </div>
            <div id="chats-list" class="space-y-4"></div>
          </div>
        </div>

        <!-- Chat Window -->
        <div id="chat-window" class="hidden flex flex-col h-full bg-white z-50">
          <div class="flex items-center px-4 py-3 border-b">
            <button onclick="closeChat()" class="p-2 -ml-2 text-gray-500"><i data-lucide="chevron-left"></i></button>
            <button id="chat-user-header" onclick="openProfileDetail(window.__activeChatId, {from:'chat'})" class="flex items-center space-x-3 ml-2">
              <img id="chat-user-img" src="" class="w-10 h-10 rounded-full object-cover" />
              <div class="text-left">
                <h3 id="chat-user-name" class="font-extrabold text-sm"></h3>
                <span id="chat-user-status" class="text-xs text-emerald-500">–í —Å–µ—Ç–∏</span>
              </div>
            </button>
            <div class="ml-auto flex items-center space-x-4 text-gray-400">
              <button onclick="openChatMenu()"><i data-lucide="more-vertical" class="w-5 h-5"></i></button>
            </div>
          </div>

          <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-gray-50 space-y-3 no-scrollbar"></div>

          <div class="p-4 bg-white border-t flex items-end space-x-2 safe-bottom">
            <button onclick="toast('–°—Ç–∏–∫–µ—Ä—ã –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500">
              <i data-lucide="smile" class="w-5 h-5"></i>
            </button>
            <div class="flex-1">
              <textarea id="chat-input" rows="1" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="w-full resize-none bg-gray-100 rounded-2xl px-4 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-pink-500"></textarea>
              <div id="typing-indicator" class="hidden text-[11px] text-gray-400 mt-1">–ü–µ—á–∞—Ç–∞–µ—Ç‚Ä¶</div>
            </div>
            <button id="chat-send" onclick="sendChatMessage()" class="w-10 h-10 bg-pink-500 rounded-full flex items-center justify-center text-white shadow-md">
              <i data-lucide="send" class="w-5 h-5"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Explore View -->
      <div id="view-explore" class="hidden h-full flex flex-col bg-white overflow-y-auto p-4 no-scrollbar">
        <div class="flex items-center space-x-2 mb-4">
          <div class="flex-1 relative">
            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"></i>
            <input id="explore-search" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º..." class="w-full bg-gray-100 rounded-xl py-2 pl-10 pr-4 text-sm outline-none" />
          </div>
          <button onclick="toggleSettings(true)" class="w-10 h-10 rounded-xl bg-gray-100 flex items-center justify-center text-gray-600" title="–§–∏–ª—å—Ç—Ä—ã">
            <i data-lucide="sliders-horizontal" class="w-5 h-5"></i>
          </button>
        </div>

        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-extrabold">Explore</h2>
          <span id="explore-count" class="text-xs text-gray-400"></span>
        </div>

        <div id="explore-grid" class="grid grid-cols-2 gap-3"></div>
      </div>

      <!-- Profile View -->
      <div id="view-profile" class="hidden h-full overflow-y-auto bg-white p-6 no-scrollbar">
        <div class="relative flex flex-col items-center mb-7">
          <div class="absolute top-0 right-0 bg-amber-50 px-3 py-1.5 rounded-2xl border border-amber-200 flex items-center shadow-sm">
            <i data-lucide="coins" class="w-4 h-4 text-amber-500 mr-2"></i>
            <span id="profile-coins" class="text-sm font-black text-amber-600">0</span>
          </div>

          <div class="w-32 h-32 rounded-full ring-4 ring-pink-50 overflow-hidden mb-4 relative group">
            <img id="my-profile-pic" src="" class="w-full h-full object-cover" />
            <label class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition cursor-pointer">
              <i data-lucide="camera" class="text-white"></i>
              <input id="my-avatar-input" type="file" accept="image/*" class="hidden" />
            </label>
            <div id="premium-badge" class="hidden absolute -bottom-1 left-1/2 -translate-x-1/2 bg-gradient-to-r from-pink-500 to-rose-500 text-white px-3 py-1 rounded-full text-[10px] font-black italic shadow-lg flex items-center gap-1 border-2 border-white">
              <i data-lucide="sparkles" class="w-3 h-3"></i> Spark Plus
            </div>
          </div>

          <div class="w-full">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-gray-500">–ò–º—è</label>
                <input id="my-name" type="text" class="w-full mt-1 px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-pink-500 focus:outline-none" />
              </div>
              <div>
                <label class="text-xs text-gray-500">–í–æ–∑—Ä–∞—Å—Ç</label>
                <input id="my-age" type="number" min="18" max="99" class="w-full mt-1 px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-pink-500 focus:outline-none" />
              </div>
            </div>
          </div>
        </div>

        <div class="space-y-6">
          <section>
            <div class="flex items-center justify-between">
              <h3 class="font-semibold text-gray-700">–û —Å–µ–±–µ</h3>
              <span id="bio-counter" class="text-xs text-gray-400">0/240</span>
            </div>
            <textarea id="my-bio" maxlength="240" class="w-full mt-2 p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-pink-500 focus:outline-none h-28" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ: —á–µ–º –≥–æ—Ä–∏—Ç–µ, —á—Ç–æ –∏—â–µ—Ç–µ, –∫–∞–∫–æ–π –∏–¥–µ–∞–ª—å–Ω—ã–π –≤–µ—á–µ—Ä..."></textarea>
          </section>

          <section>
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold text-gray-700">–ò–Ω—Ç–µ—Ä–µ—Å—ã</h3>
              <button onclick="randomizeInterests()" class="text-xs text-gray-400 hover:text-gray-600">–ü–æ–¥–æ–±—Ä–∞—Ç—å</button>
            </div>
            <div id="interests-container" class="flex flex-wrap gap-2"></div>
          </section>

          <section>
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold text-gray-700">–ú–æ–∏ —Ñ–æ—Ç–æ</h3>
              <button onclick="toast('–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ ‚Äî –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')" class="text-xs text-gray-400 hover:text-gray-600">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
            </div>
            <div id="my-photos-grid" class="grid grid-cols-3 gap-2"></div>
            <input id="my-photos-input" type="file" accept="image/*" class="hidden" />
          </section>

          <div class="grid grid-cols-2 gap-3">
            <button onclick="saveProfile()" class="w-full py-4 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-xl font-extrabold text-base shadow-lg active:scale-95 transition">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button onclick="resetMyProfile()" class="w-full py-4 bg-white border border-gray-200 text-gray-700 rounded-xl font-bold active:scale-95 transition">–°–±—Ä–æ—Å</button>
          </div>

          <button onclick="logoutDemo()" class="w-full py-4 text-gray-400 font-medium">–í—ã–π—Ç–∏ (–¥–µ–º–æ)</button>
        </div>
      </div>

    </main>

    <!-- Bottom Navigation -->
    <nav class="flex items-center justify-around px-6 py-4 bg-white border-t border-gray-100 safe-bottom">
      <button onclick="switchView('feed')" id="nav-feed" class="nav-active transition" title="–õ–µ–Ω—Ç–∞">
        <i data-lucide="flame" class="w-7 h-7"></i>
      </button>
      <button onclick="switchView('explore')" id="nav-explore" class="text-gray-300 transition" title="Explore">
        <i data-lucide="search" class="w-7 h-7"></i>
      </button>
      <button onclick="switchView('messages')" id="nav-messages" class="text-gray-300 transition relative" title="–°–æ–æ–±—â–µ–Ω–∏—è">
        <i data-lucide="message-circle" class="w-7 h-7"></i>
        <span id="nav-messages-badge" class="hidden absolute -top-1 -right-1 min-w-5 h-5 px-1 bg-pink-500 text-white text-[10px] rounded-full flex items-center justify-center border-2 border-white">1</span>
      </button>
      <button onclick="switchView('profile')" id="nav-profile" class="text-gray-300 transition" title="–ü—Ä–æ—Ñ–∏–ª—å">
        <i data-lucide="user" class="w-7 h-7"></i>
      </button>
    </nav>

    <!-- Profile Detail Overlay -->
    <div id="profile-detail" class="hidden fixed inset-0 bg-white z-50 overflow-y-auto no-scrollbar">
      <div class="relative h-[60vh]">
        <img id="detail-img" src="" class="w-full h-full object-cover" />

        <button onclick="closeProfileDetail()" class="absolute top-6 left-6 w-10 h-10 bg-black/20 backdrop-blur-md rounded-full flex items-center justify-center text-white">
          <i data-lucide="chevron-left"></i>
        </button>

        <div class="absolute top-6 right-6 flex gap-2">
          <button onclick="copyProfileLink()" class="w-10 h-10 bg-black/20 backdrop-blur-md rounded-full flex items-center justify-center text-white" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
            <i data-lucide="share-2" class="w-5 h-5"></i>
          </button>
          <button onclick="openDetailMenu()" class="w-10 h-10 bg-black/20 backdrop-blur-md rounded-full flex items-center justify-center text-white" title="–ú–µ–Ω—é">
            <i data-lucide="more-horizontal" class="w-5 h-5"></i>
          </button>
        </div>

        <button id="detail-prev" onclick="detailPrevPhoto()" class="absolute left-3 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black/20 text-white flex items-center justify-center backdrop-blur-md">
          <i data-lucide="chevron-left" class="w-5 h-5"></i>
        </button>
        <button id="detail-next" onclick="detailNextPhoto()" class="absolute right-3 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black/20 text-white flex items-center justify-center backdrop-blur-md">
          <i data-lucide="chevron-right" class="w-5 h-5"></i>
        </button>

        <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-white via-white/80 to-transparent pt-20">
          <div class="flex items-end justify-between gap-3">
            <div>
              <h2 id="detail-name-age" class="text-3xl font-extrabold text-gray-900"></h2>
              <p id="detail-meta" class="text-gray-500 text-sm"></p>
            </div>
            <div id="detail-badges" class="flex gap-2"></div>
          </div>
        </div>
      </div>

      <div class="p-6 space-y-6">
        <div id="detail-photo-thumbs" class="flex gap-2 overflow-x-auto no-scrollbar"></div>

        <div>
          <h3 class="font-extrabold text-gray-800 mb-2 italic text-lg underline decoration-pink-300">–û —Å–µ–±–µ</h3>
          <p id="detail-bio" class="text-gray-600 leading-relaxed"></p>
        </div>

        <div>
          <h3 class="font-extrabold text-gray-800 mb-3">–ò–Ω—Ç–µ—Ä–µ—Å—ã</h3>
          <div id="detail-interests" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="pb-28">
          <h3 class="font-extrabold text-gray-800 mb-3">–î–µ–π—Å—Ç–≤–∏—è</h3>
          <div class="grid grid-cols-2 gap-2">
            <button onclick="blockFromDetail()" class="py-3 rounded-xl bg-gray-100 text-gray-700 font-bold flex items-center justify-center gap-2">
              <i data-lucide="shield-ban" class="w-4 h-4"></i> <span>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</span>
            </button>
            <button onclick="reportFromDetail()" class="py-3 rounded-xl bg-rose-50 text-rose-600 font-bold flex items-center justify-center gap-2">
              <i data-lucide="flag" class="w-4 h-4"></i> <span>–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</span>
            </button>
          </div>
          <p class="text-xs text-gray-400 mt-2">–í –¥–µ–º–æ –¥–µ–π—Å—Ç–≤–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.</p>
        </div>
      </div>

      <div class="fixed bottom-6 left-0 right-0 flex justify-center space-x-4 px-6">
        <button onclick="closeProfileDetail(); handleManualAction('pass')" class="flex-1 py-4 bg-white border border-gray-100 rounded-2xl text-rose-500 font-extrabold shadow-xl flex items-center justify-center space-x-2">
          <i data-lucide="x" class="w-5 h-5"></i> <span>–ù–µ—Ç</span>
        </button>
        <button onclick="closeProfileDetail(); handleManualAction('superlike')" class="py-4 px-4 bg-white border border-gray-100 rounded-2xl text-blue-500 font-extrabold shadow-xl flex items-center justify-center">
          <i data-lucide="star" class="w-5 h-5 fill-current"></i>
        </button>
        <button onclick="closeProfileDetail(); handleManualAction('like')" class="flex-1 py-4 bg-pink-500 rounded-2xl text-white font-extrabold shadow-xl shadow-pink-200 flex items-center justify-center space-x-2">
          <i data-lucide="heart" class="w-5 h-5 fill-current"></i> <span>–õ–∞–π–∫</span>
        </button>
      </div>
    </div>

    <!-- Match Modal -->
    <div id="match-modal" class="hidden fixed inset-0 bg-black/90 flex flex-col items-center justify-center p-8 z-50">
      <div class="text-center">
        <h2 class="text-5xl font-black italic text-pink-500 mb-2">Match!</h2>
        <p class="text-white text-center mb-3">–í—ã –∏ <span id="match-name" class="font-extrabold">–ê–Ω–Ω–∞</span> –ø–æ–Ω—Ä–∞–≤–∏–ª–∏—Å—å –¥—Ä—É–≥ –¥—Ä—É–≥—É</p>
        <div id="match-sub" class="text-xs text-white/70 mb-7"></div>
      </div>

      <div class="flex items-center space-x-4 mb-10">
        <div class="w-24 h-24 rounded-full border-4 border-white overflow-hidden -rotate-6">
          <img id="match-my-img" src="" class="w-full h-full object-cover" />
        </div>
        <div class="w-24 h-24 rounded-full border-4 border-white overflow-hidden rotate-6">
          <img id="match-their-img" src="" class="w-full h-full object-cover" />
        </div>
      </div>

      <div class="w-full space-y-4">
        <button onclick="goToMatchChat()" class="w-full py-4 bg-pink-500 text-white rounded-full font-extrabold">–ù–∞–ø–∏—Å–∞—Ç—å</button>
        <button onclick="closeMatchModal()" class="w-full py-4 border border-white text-white rounded-full font-extrabold">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
      </div>
    </div>

    <!-- Settings Sidebar -->
    <div id="settings-panel" class="fixed inset-y-0 right-[-100%] w-full max-w-md bg-white z-40 transition-all duration-300 shadow-2xl overflow-y-auto no-scrollbar">
      <div class="p-6">
        <div class="flex items-center justify-between mb-8">
          <h2 class="text-2xl font-extrabold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∏—Å–∫–∞</h2>
          <button onclick="toggleSettings()" class="p-2 bg-gray-100 rounded-full">
            <i data-lucide="x"></i>
          </button>
        </div>

        <div class="space-y-8">
          <section>
            <div class="flex justify-between mb-4">
              <span class="font-semibold">–ú–∞–∫—Å. —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ</span>
              <span id="setting-distance-label" class="text-pink-500 font-extrabold">40 –∫–º</span>
            </div>
            <input id="setting-distance" type="range" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-pink-500" min="2" max="160" />
          </section>

          <section>
            <div class="flex justify-between mb-4">
              <span class="font-semibold">–í–æ–∑—Ä–∞—Å—Ç–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω</span>
              <span id="setting-age-label" class="text-pink-500 font-extrabold">18 ‚Äî 35</span>
            </div>
            <div class="flex space-x-4">
              <input id="setting-age-min" type="number" value="18" min="18" max="99" class="w-1/2 p-2 bg-gray-50 border rounded-lg" />
              <input id="setting-age-max" type="number" value="35" min="18" max="99" class="w-1/2 p-2 bg-gray-50 border rounded-lg" />
            </div>
          </section>

          <section>
            <h3 class="font-semibold mb-4">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–Ω–µ</h3>
            <div class="space-y-2">
              <label class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                <span>–ñ–µ–Ω—â–∏–Ω</span>
                <input type="radio" name="pref" value="female" class="w-5 h-5 accent-pink-500" />
              </label>
              <label class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                <span>–ú—É–∂—á–∏–Ω</span>
                <input type="radio" name="pref" value="male" class="w-5 h-5 accent-pink-500" />
              </label>
              <label class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                <span>–í—Å–µ—Ö</span>
                <input type="radio" name="pref" value="all" class="w-5 h-5 accent-pink-500" />
              </label>
            </div>
          </section>

          <section>
            <h3 class="font-semibold mb-3">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
            <div class="grid grid-cols-2 gap-2">
              <button onclick="resetFeed()" class="py-3 rounded-xl bg-gray-900 text-white font-extrabold">–û–±–Ω–æ–≤–∏—Ç—å –ª–µ–Ω—Ç—É</button>
              <button onclick="clearAllData()" class="py-3 rounded-xl bg-white border border-gray-200 text-gray-700 font-extrabold">–°–±—Ä–æ—Å–∏—Ç—å –¥–µ–º–æ</button>
            </div>
            <p class="text-xs text-gray-400 mt-2">–°–±—Ä–æ—Å —É–¥–∞–ª–∏—Ç —á–∞—Ç—ã, –º–∞—Ç—á–∏ –∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.</p>
          </section>

          <div class="pt-2">
            <button onclick="toggleSettings()" class="w-full py-4 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-xl font-extrabold">–ì–æ—Ç–æ–≤–æ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Daily Reward Modal -->
    <div id="reward-modal" class="hidden fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-6">
      <div class="w-full max-w-sm bg-white rounded-3xl p-8 text-center shadow-2xl relative overflow-hidden">
        <div class="absolute -top-12 -left-12 w-32 h-32 bg-amber-100 rounded-full blur-3xl opacity-50"></div>
        <div class="absolute -bottom-12 -right-12 w-32 h-32 bg-pink-100 rounded-full blur-3xl opacity-50"></div>
        
        <div class="relative">
          <div class="w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
            <i data-lucide="coins" class="w-10 h-10 text-amber-500"></i>
          </div>
          <h2 class="text-2xl font-black text-gray-800 mb-2">–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞!</h2>
          <p class="text-gray-500 mb-6">–í—ã –∑–∞—à–ª–∏ –≤ Spark <span id="reward-streak" class="font-bold text-pink-500">1-–π</span> –¥–µ–Ω—å –ø–æ–¥—Ä—è–¥.</p>
          
          <div class="bg-gray-50 rounded-2xl p-4 mb-6 flex items-center justify-center">
            <span class="text-4xl font-black text-amber-500 mr-2">+<span id="reward-amount">10</span></span>
            <i data-lucide="coins" class="w-6 h-6 text-amber-500"></i>
          </div>
          
          <button onclick="closeRewardModal()" class="w-full py-4 bg-gray-900 text-white rounded-2xl font-extrabold shadow-lg active:scale-95 transition">–ó–∞–±—Ä–∞—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- Toasts -->
    <div id="toast-container" class="fixed left-0 right-0 bottom-24 z-[60] px-4 pointer-events-none">
      <div id="toast" class="hidden max-w-md mx-auto bg-gray-900 text-white text-sm px-4 py-3 rounded-xl shadow-2xl"></div>
    </div>

    <!-- Shop Modal -->
    <div id="shop-modal" class="hidden fixed inset-0 bg-black/60 z-[80] flex items-center justify-center p-4">
      <div class="w-full max-w-md bg-white rounded-3xl overflow-y-auto max-h-[90vh] no-scrollbar shadow-2xl">
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-black italic">Spark Shop</h2>
            <button onclick="toggleShop()" class="p-2 bg-gray-100 rounded-full"><i data-lucide="x"></i></button>
          </div>

          <!-- Premium Section -->
          <div class="bg-gradient-to-br from-pink-500 to-rose-600 rounded-3xl p-6 text-white mb-8 relative overflow-hidden shadow-xl">
            <div class="absolute -right-4 -top-4 opacity-10"><i data-lucide="crown" class="w-32 h-32"></i></div>
            <div class="relative z-10">
              <div class="flex items-center gap-2 mb-2">
                <i data-lucide="sparkles" class="w-5 h-5"></i>
                <span class="font-black text-xl italic uppercase tracking-wider">Spark Plus</span>
              </div>
              <ul class="text-sm space-y-2 mb-6 opacity-90">
                <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4"></i> –ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ –ª–∞–π–∫–∏</li>
                <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4"></i> 5 —Å—É–ø–µ—Ä–ª–∞–π–∫–æ–≤ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å</li>
                <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4"></i> –ü—Ä–µ–º–∏—É–º-–±–µ–π–¥–∂ –≤ –ø—Ä–æ—Ñ–∏–ª–µ</li>
                <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4"></i> –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤ –ª–µ–Ω—Ç–µ</li>
              </ul>
              <div class="flex items-end gap-3 mb-4">
                <span class="text-3xl font-black">500‚ÇΩ</span>
                <span class="text-lg line-through opacity-50 mb-1">800‚ÇΩ</span>
                <span class="text-xs bg-white text-pink-600 px-2 py-0.5 rounded-full font-bold mb-1.5">-37%</span>
              </div>
              <button onclick="buyPremium()" class="w-full py-3 bg-white text-pink-600 rounded-xl font-black shadow-lg active:scale-95 transition">–ö—É–ø–∏—Ç—å –¥–æ—Å—Ç—É–ø</button>
            </div>
          </div>

          <!-- Coins Section -->
          <div class="space-y-4">
            <h3 class="font-extrabold text-gray-800 flex items-center gap-2">
              <i data-lucide="coins" class="text-amber-500"></i> –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
            </h3>
            <div class="bg-gray-50 p-4 rounded-2xl border-2 border-dashed border-gray-200">
              <label class="text-xs text-gray-400 block mb-2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç (50 ‚Äî 10 000)</label>
              <div class="flex items-center gap-4">
                <input id="shop-coin-input" type="number" value="100" min="50" max="10000" oninput="updateShopPrice()" class="flex-1 bg-transparent text-2xl font-black text-gray-800 outline-none" />
                <div class="text-right">
                  <div id="shop-total-price" class="text-xl font-black text-emerald-500">500‚ÇΩ</div>
                  <div class="text-[10px] text-gray-400 italic">1 –º–æ–Ω–µ—Ç–∞ = 5‚ÇΩ</div>
                </div>
              </div>
            </div>
            <button onclick="buyCoins()" class="w-full py-4 bg-gray-900 text-white rounded-2xl font-extrabold shadow-lg active:scale-95 transition">–û–ø–ª–∞—Ç–∏—Ç—å –º–æ–Ω–µ—Ç—ã</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // -----------------------
    // Data
    // -----------------------
    const INITIAL_PROFILES = [
      {
        id: 1,
        name: '–ê–Ω–Ω–∞',
        age: 22,
        gender: 'female',
        bio: '–õ—é–±–ª—é –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –∏ –∫–æ—Ñ–µ. –ò—â—É –∫–æ–≥–æ-—Ç–æ –¥–ª—è –ø–æ—Ö–æ–¥–æ–≤ –≤ –≥–æ—Ä—ã ‚õ∞Ô∏è',
        distanceKm: 3,
        photos: [
          'https://images.unsplash.com/photo-1494790108377-be9c29b29330?q=80&w=800&h=1000&auto=format&fit=crop',
          'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?q=80&w=800&h=1000&auto=format&fit=crop',
          'https://images.unsplash.com/photo-1524503033411-f7a2fe8c7e9f?q=80&w=800&h=1000&auto=format&fit=crop'
        ],
        interests: ['–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è', '–ö–æ—Ñ–µ', '–°–ø–æ—Ä—Ç']
      },
      {
        id: 2,
        name: '–ï–ª–µ–Ω–∞',
        age: 25,
        gender: 'female',
        bio: '–ô–æ–≥–∞, –¥–∏–∑–∞–π–Ω –∏ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –¥–æ –Ω–æ—á–∏. –ú–µ—á—Ç–∞—é –æ –¥–æ–º–∏–∫–µ —É –º–æ—Ä—è. üåä',
        distanceKm: 7,
        photos: [
          'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?q=80&w=800&h=1000&auto=format&fit=crop',
          'https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?q=80&w=800&h=1000&auto=format&fit=crop',
          'https://images.unsplash.com/photo-1524502397800-2eeaad7c3fe5?q=80&w=800&h=1000&auto=format&fit=crop'
        ],
        interests: ['–ô–æ–≥–∞', '–ò—Å–∫—É—Å—Å—Ç–≤–æ', '–ö–∏–Ω–æ']
      },
      {
        id: 3,
        name: '–ú–∞—Ä–∏—è',
        age: 24,
        gender: 'female',
        bio: '–í –ø–æ–∏—Å–∫–µ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è –∏ –Ω–æ–≤—ã—Ö –∑–Ω–∞–∫–æ–º—Å—Ç–≤. –û–±–æ–∂–∞—é –∫–æ—Ç–∏–∫–æ–≤. üêà',
        distanceKm: 12,
        photos: [
          'https://images.unsplash.com/photo-1517841905240-472988babdf9?q=80&w=800&h=1000&auto=format&fit=crop',
          'https://images.unsplash.com/photo-1524502397800-2eeaad7c3fe5?q=80&w=800&h=1000&auto=format&fit=crop',
          'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?q=80&w=800&h=1000&auto=format&fit=crop'
        ],
        interests: ['–ñ–∏–≤–æ—Ç–Ω—ã–µ', '–ú—É–∑—ã–∫–∞', '–í–∏–Ω–æ']
      },
      {
        id: 4,
        name: '–ö—Ä–∏—Å—Ç–∏–Ω–∞',
        age: 23,
        gender: 'female',
        bio: '–§–æ—Ç–æ–≥—Ä–∞—Ñ –∏ –º–µ—á—Ç–∞—Ç–µ–ª—å–Ω–∏—Ü–∞. –î–∞–≤–∞–π —Å–¥–µ–ª–∞–µ–º –∫—Ä—É—Ç–æ–π –∫–∞–¥—Ä? üì∏',
        distanceKm: 5,
        photos: [
          'https://images.unsplash.com/photo-1534528741775-53994a69daeb?q=80&w=800&h=1000&auto=format&fit=crop',
          'https://images.unsplash.com/photo-1512310604669-443f26c35f52?q=80&w=800&h=1000&auto=format&fit=crop',
          'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?q=80&w=800&h=1000&auto=format&fit=crop'
        ],
        interests: ['–§–æ—Ç–æ', '–ú–æ–¥–∞', '–¢–∞–Ω—Ü—ã']
      },
      {
        id: 5,
        name: '–ò–≥–æ—Ä—å',
        age: 27,
        gender: 'male',
        bio: '–†–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—é –ø—Ä–æ–¥—É–∫—Ç—ã, –±–µ–≥–∞—é –ø–æ —É—Ç—Ä–∞–º, –≤–∞—Ä—é –∫–æ—Ñ–µ –ª—É—á—à–µ –±–∞—Ä–∏—Å—Ç–∞.',
        distanceKm: 10,
        photos: [
          'https://images.unsplash.com/photo-1539571696357-5a69c17a67c6?q=80&w=800&h=1000&auto=format&fit=crop',
          'https://images.unsplash.com/photo-1542178243-bc20204b769f?q=80&w=800&h=1000&auto=format&fit=crop',
          'https://images.unsplash.com/photo-1521119989659-a83eee488004?q=80&w=800&h=1000&auto=format&fit=crop'
        ],
        interests: ['–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏', '–ë–µ–≥', '–ö–æ—Ñ–µ']
      },
      {
        id: 6,
        name: '–î–∞–Ω–∏–∏–ª',
        age: 29,
        gender: 'male',
        bio: '–õ—é–±–ª—é –∫–∏–Ω–æ, —Ö–æ—Ä–æ—à–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –∏ —Å–ø–æ–Ω—Ç–∞–Ω–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏. üé¨',
        distanceKm: 16,
        photos: [
          'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=800&h=1000&auto=format&fit=crop',
          'https://images.unsplash.com/photo-1521119989659-a83eee488004?q=80&w=800&h=1000&auto=format&fit=crop',
          'https://images.unsplash.com/photo-1542178243-bc20204b769f?q=80&w=800&h=1000&auto=format&fit=crop'
        ],
        interests: ['–ö–∏–Ω–æ', '–ú—É–∑—ã–∫–∞', '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è']
      }
    ];

    const INTERESTS_LIST = [
      '–°–ø–æ—Ä—Ç','–ú—É–∑—ã–∫–∞','–ö–∏–Ω–æ','–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è','–ö–æ—Ñ–µ','–ò—Å–∫—É—Å—Å—Ç–≤–æ','–ì–µ–π–º–∏–Ω–≥','–§–æ—Ç–æ','–ö—É–ª–∏–Ω–∞—Ä–∏—è','–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏',
      '–ô–æ–≥–∞','–ë–µ–≥','–¢–∞–Ω—Ü—ã','–ú–æ–¥–∞','–ñ–∏–≤–æ—Ç–Ω—ã–µ','–ö–Ω–∏–≥–∏','–ù–∞—Å—Ç–æ–ª–∫–∏','–í–µ–ª–æ—Å–∏–ø–µ–¥','–ë–∞—Ä—ã','–ü—Ä–æ–≥—É–ª–∫–∏'
    ];

    const STORAGE_KEY = 'spark.demo.v2';

    const DEFAULT_STATE = {
      currentView: 'feed',
      settings: {
        maxDistance: 40,
        ageMin: 18,
        ageMax: 35,
        pref: 'all'
      },
      myProfile: {
        name: '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä',
        age: 24,
        bio: '',
        interests: ['–°–ø–æ—Ä—Ç', '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏'],
        photos: [
          'https://images.unsplash.com/photo-1539571696357-5a69c17a67c6?q=80&w=400&h=400&auto=format&fit=crop'
        ]
      },
      seen: [],
      likes: [],
      passes: [],
      superLikes: [],
      blocked: [],
      matches: [],
      chats: {},
      swipeHistory: [],
      boost: {
        active: false,
        endsAt: 0
      },
      coins: 0,
      streak: 0,
      lastVisit: null,
      isPremium: false
    };

    let state = structuredClone(DEFAULT_STATE);
    let boostTimer = null;

    // Drag state
    let drag = {
      active: false,
      pointerId: null,
      startX: 0,
      startY: 0,
      dx: 0,
      dy: 0,
      card: null
    };

    // Detail state
    let detail = {
      profileId: null,
      photoIndex: 0
    };

    // Match modal state
    let lastMatchId = null;
    let lastMatchWasSuper = false;

    // -----------------------
    // Helpers
    // -----------------------
    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function formatDistance(km){ return `${km} –∫–º –æ—Ç –≤–∞—Å`; }

    function formatTime(ts){
      try{
        const d = new Date(ts);
        return d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute:'2-digit' });
      } catch { return ''; }
    }

    function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

    function getProfileById(id){ return INITIAL_PROFILES.find(p => p.id === id) || null; }

    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    function toast(message){
      const el = document.getElementById('toast');
      el.textContent = message;
      el.classList.remove('hidden');
      el.classList.add('pointer-events-auto');
      clearTimeout(window.__toastT);
      window.__toastT = setTimeout(() => {
        el.classList.add('hidden');
        el.classList.remove('pointer-events-auto');
      }, 1800);
    }

    function persist(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn('persist failed', e);
      }
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        // shallow merge with defaults for forward compatibility
        state = {
          ...structuredClone(DEFAULT_STATE),
          ...parsed,
          settings: { ...DEFAULT_STATE.settings, ...(parsed.settings || {}) },
          myProfile: { ...DEFAULT_STATE.myProfile, ...(parsed.myProfile || {}) },
          boost: { ...DEFAULT_STATE.boost, ...(parsed.boost || {}) }
        };
      } catch (e) {
        console.warn('loadState failed', e);
      }
    }

    function clearAllData(){
      if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –¥–µ–º–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ?')) return;
      localStorage.removeItem(STORAGE_KEY);
      state = structuredClone(DEFAULT_STATE);
      toast('–î–µ–º–æ —Å–±—Ä–æ—à–µ–Ω–æ');
      init();
    }

    function updateHeaderStats(){
      const likes = state.likes.length + state.superLikes.length;
      const matches = state.matches.length;
      document.getElementById('header-stats').textContent = `${likes} –ª–∞–π–∫–æ–≤ ‚Ä¢ ${matches} –º–∞—Ç—á–µ–π`;

      // coins
      const coins = state.coins || 0;
      document.getElementById('header-coins').textContent = coins;
      const profileCoins = document.getElementById('profile-coins');
      if (profileCoins) profileCoins.textContent = coins;

      // badge unread
      const unread = Object.values(state.chats || {}).reduce((sum, c) => sum + (c.unread || 0), 0);
      const badge = document.getElementById('nav-messages-badge');
      if (unread > 0) {
        badge.textContent = unread > 99 ? '99+' : String(unread);
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    function checkDailyReward(){
      const now = new Date();
      const todayStr = now.toDateString(); // e.g. "Mon May 22 2023"
      
      if (state.lastVisit === todayStr) return;

      let reward = 30;
      const yesterday = new Date(now);
      yesterday.setDate(now.getDate() - 1);
      const yesterdayStr = yesterday.toDateString();

      if (state.lastVisit === yesterdayStr) {
        state.streak = (state.streak || 0) + 1;
      } else {
        state.streak = 1;
      }

      const schedule = { 1: 10, 2: 20, 3: 35, 4: 50, 5: 70 };
      reward = schedule[state.streak] || 30;

      state.coins = (state.coins || 0) + reward;
      state.lastVisit = todayStr;
      
      persist();

      // Show modal
      document.getElementById('reward-streak').textContent = `${state.streak}-–π`;
      document.getElementById('reward-amount').textContent = reward;
      document.getElementById('reward-modal').classList.remove('hidden');
      lucide.createIcons();
    }

    function closeRewardModal(){
      document.getElementById('reward-modal').classList.add('hidden');
      updateHeaderStats();
    }

    function setBoostUi(){
      const pill = document.getElementById('boost-pill');
      const btn = document.getElementById('btn-boost');
      if (!state.boost.active) {
        pill.classList.add('hidden');
        btn.classList.remove('pulse-ring');
        return;
      }

      const left = Math.max(0, state.boost.endsAt - Date.now());
      const sec = Math.ceil(left / 1000);
      const mm = String(Math.floor(sec / 60)).padStart(2,'0');
      const ss = String(sec % 60).padStart(2,'0');
      pill.textContent = `Boost ${mm}:${ss}`;
      pill.classList.remove('hidden');
      btn.classList.add('pulse-ring');

      if (left <= 0) {
        state.boost.active = false;
        state.boost.endsAt = 0;
        persist();
        setBoostUi();
        toast('Boost –∑–∞–∫–æ–Ω—á–∏–ª—Å—è');
      }
    }

    // -----------------------
    // Filters & Deck
    // -----------------------
    function passesFilters(profile){
      const s = state.settings;
      if (state.blocked.includes(profile.id)) return false;
      if (profile.distanceKm > s.maxDistance) return false;
      if (profile.age < s.ageMin || profile.age > s.ageMax) return false;
      if (s.pref !== 'all' && profile.gender !== s.pref) return false;
      return true;
    }

    function getRemainingProfiles(){
      const seen = new Set(state.seen);
      return INITIAL_PROFILES
        .filter(p => !seen.has(p.id))
        .filter(passesFilters)
        .sort((a,b) => a.distanceKm - b.distanceKm);
    }

    // -----------------------
    // Views
    // -----------------------
    function switchView(view){
      state.currentView = view;
      closeChat();

      const views = ['feed', 'messages', 'profile', 'explore'];
      for (const v of views) {
        const el = document.getElementById(`view-${v}`);
        const nav = document.getElementById(`nav-${v}`);
        if (v === view) {
          el.classList.remove('hidden');
          if (nav) {
            nav.classList.add('nav-active');
            nav.classList.remove('text-gray-300');
          }
        } else {
          el.classList.add('hidden');
          if (nav) {
            nav.classList.remove('nav-active');
            nav.classList.add('text-gray-300');
          }
        }
      }

      if (view === 'feed') renderFeed();
      if (view === 'explore') renderExplore();
      if (view === 'messages') renderMessages();
      if (view === 'profile') renderMyProfile();

      updateHeaderStats();
      persist();
      lucide.createIcons();
    }

    // -----------------------
    // Feed / Cards
    // -----------------------
    function renderFeed(){
      const container = document.getElementById('card-container');
      const empty = document.getElementById('empty-state');
      const buttons = document.getElementById('action-buttons');

      container.querySelectorAll('.swipe-card').forEach(c => c.remove());

      const remaining = getRemainingProfiles();

      if (remaining.length === 0) {
        empty.classList.remove('hidden');
        buttons.classList.add('opacity-30', 'pointer-events-none');
        return;
      }

      empty.classList.add('hidden');
      buttons.classList.remove('opacity-30', 'pointer-events-none');

      // Render up to 3 cards; top card is last appended
      const slice = remaining.slice(0, 3);

      slice.forEach((p, idx) => {
        const isTop = idx === 0; // first in slice should be top visually (we append in reverse to stack)
      });

      // We want the first profile to be on top, so we append from bottom to top
      [...slice].reverse().forEach((profile, idx) => {
        const isTop = idx === slice.length - 1;
        const card = createCard(profile, isTop);
        container.appendChild(card);
      });

      document.getElementById('btn-rewind').classList.toggle('opacity-40', state.swipeHistory.length === 0);
      lucide.createIcons();
    }

    function createCard(profile, isTop){
      const card = document.createElement('div');
      card.className = `swipe-card shadow-xl ${isTop ? 'z-30' : 'z-10'}`;
      card.dataset.id = profile.id;
      if (isTop) card.dataset.top = 'true';

      const interests = profile.interests.slice(0,3).map(i =>
        `<span class="px-2 py-1 bg-white/20 backdrop-blur-md rounded-lg text-xs font-semibold">${escapeHtml(i)}</span>`
      ).join('');

      card.innerHTML = `
        <div class="relative h-full w-full group">
          <img src="${profile.photos[0]}" class="w-full h-full object-cover pointer-events-none" loading="lazy" />

          <div class="gradient-overlay absolute inset-0 flex flex-col justify-end p-6 text-white pointer-events-none">
            <div class="flex items-center justify-between pointer-events-auto">
              <div>
                <div class="flex items-center gap-2">
                  <h3 class="text-2xl font-extrabold">${escapeHtml(profile.name)}, ${profile.age}</h3>
                  <div class="w-4 h-4 bg-blue-400 rounded-full flex items-center justify-center">
                    <i data-lucide="check" class="w-3 h-3 text-white"></i>
                  </div>
                </div>
                <p class="text-sm opacity-90 flex items-center mt-1">
                  <i data-lucide="map-pin" class="w-3 h-3 mr-1"></i> ${formatDistance(profile.distanceKm)}
                </p>
              </div>

              <div class="flex items-center gap-2">
                <button onclick="openProfileDetail(${profile.id})" class="w-10 h-10 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center" title="–ü–æ–¥—Ä–æ–±–Ω–µ–µ">
                  <i data-lucide="info" class="w-5 h-5 text-white"></i>
                </button>
              </div>
            </div>

            <p class="text-sm mt-3 line-clamp-2">${escapeHtml(profile.bio)}</p>
            <div class="flex space-x-2 mt-3">${interests}</div>
          </div>

          <!-- Drag indicators -->
          <div class="like-indicator absolute top-10 left-6 border-4 border-emerald-500 text-emerald-500 font-black text-3xl uppercase px-4 py-1 rounded-lg opacity-0 -rotate-12 transition-opacity">LIKE</div>
          <div class="nope-indicator absolute top-10 right-6 border-4 border-rose-500 text-rose-500 font-black text-3xl uppercase px-4 py-1 rounded-lg opacity-0 rotate-12 transition-opacity">NOPE</div>
          <div class="super-indicator absolute top-10 left-1/2 -translate-x-1/2 border-4 border-blue-500 text-blue-400 font-black text-2xl uppercase px-3 py-1 rounded-lg opacity-0 transition-opacity">SUPER</div>
        </div>
      `;

      if (isTop) initDraggable(card);
      return card;
    }

    function getTopCard(){
      return document.querySelector('.swipe-card[data-top="true"]');
    }

    function initDraggable(card){
      card.addEventListener('pointerdown', onPointerDown);
    }

    function onPointerDown(e){
      const card = e.currentTarget;
      if (drag.active) return;
      drag.active = true;
      drag.pointerId = e.pointerId;
      drag.startX = e.clientX;
      drag.startY = e.clientY;
      drag.dx = 0;
      drag.dy = 0;
      drag.card = card;

      card.setPointerCapture(e.pointerId);
      card.style.transition = 'none';
      card.addEventListener('pointermove', onPointerMove);
      card.addEventListener('pointerup', onPointerUp);
      card.addEventListener('pointercancel', onPointerUp);
    }

    function onPointerMove(e){
      if (!drag.active || e.pointerId !== drag.pointerId) return;
      drag.dx = e.clientX - drag.startX;
      drag.dy = e.clientY - drag.startY;

      const card = drag.card;
      const rotate = clamp(drag.dx / 18, -18, 18);
      card.style.transform = `translate(${drag.dx}px, ${drag.dy}px) rotate(${rotate}deg)`;

      const like = card.querySelector('.like-indicator');
      const nope = card.querySelector('.nope-indicator');
      const sup = card.querySelector('.super-indicator');

      const likeO = drag.dx > 40 ? clamp(drag.dx / 160, 0, 1) : 0;
      const nopeO = drag.dx < -40 ? clamp(Math.abs(drag.dx) / 160, 0, 1) : 0;
      const supO = (drag.dy < -40 && Math.abs(drag.dx) < 90) ? clamp(Math.abs(drag.dy) / 180, 0, 1) : 0;

      like.style.opacity = likeO;
      nope.style.opacity = nopeO;
      sup.style.opacity = supO;
    }

    function onPointerUp(e){
      if (!drag.active || e.pointerId !== drag.pointerId) return;

      const card = drag.card;
      card.releasePointerCapture(drag.pointerId);
      card.removeEventListener('pointermove', onPointerMove);
      card.removeEventListener('pointerup', onPointerUp);
      card.removeEventListener('pointercancel', onPointerUp);

      card.style.transition = 'transform .25s ease, opacity .25s ease';

      const dx = drag.dx;
      const dy = drag.dy;
      drag.active = false;
      drag.pointerId = null;
      drag.card = null;

      let action = null;
      if (dx > 120) action = 'like';
      else if (dx < -120) action = 'pass';
      else if (dy < -140 && Math.abs(dx) < 90) action = 'superlike';

      if (!action) {
        card.style.transform = 'translate(0,0) rotate(0deg)';
        card.querySelectorAll('.like-indicator, .nope-indicator, .super-indicator').forEach(i => i.style.opacity = 0);
        return;
      }

      performSwipe(action, { card });
    }

    function handleManualAction(action){
      const card = getTopCard();
      if (!card) return;
      performSwipe(action, { card, manual: true });
    }

    function performSwipe(action, { card, manual = false } = {}){
      const top = card || getTopCard();
      if (!top) return;

      const id = parseInt(top.dataset.id, 10);
      const profile = getProfileById(id);
      if (!profile) return;

      // animate out
      let outX = 0, outY = 0, rot = 0;
      if (action === 'like') { outX = window.innerWidth; rot = 25; }
      if (action === 'pass') { outX = -window.innerWidth; rot = -25; }
      if (action === 'superlike') { outY = -window.innerHeight; rot = 0; }

      top.style.transform = `translate(${outX}px, ${outY}px) rotate(${rot}deg)`;
      top.style.opacity = 0;

      setTimeout(() => {
        const createdMatch = applyActionToState(profile, action);
        state.seen.push(profile.id);
        state.swipeHistory.push({ id: profile.id, action, createdMatch, ts: Date.now() });

        // keep history limited
        if (state.swipeHistory.length > 50) state.swipeHistory.shift();

        persist();
        renderFeed();
        updateHeaderStats();
        if (state.currentView === 'explore') renderExplore();
        if (state.currentView === 'messages') renderMessages();
      }, 220);
    }

    function applyActionToState(profile, action){
      // Remove duplicates from arrays if any
      state.likes = state.likes.filter(x => x !== profile.id);
      state.passes = state.passes.filter(x => x !== profile.id);
      state.superLikes = state.superLikes.filter(x => x !== profile.id);

      if (action === 'like') state.likes.push(profile.id);
      if (action === 'pass') state.passes.push(profile.id);
      if (action === 'superlike') state.superLikes.push(profile.id);

      // match probability
      const boosted = state.boost.active && state.boost.endsAt > Date.now();
      let chance = 0.35;
      if (boosted) chance = 0.55;
      if (action === 'superlike') chance = boosted ? 0.85 : 0.75;

      // Make demo feel good: some deterministic matches
      const deterministic = [1, 2].includes(profile.id) && (action !== 'pass');
      const matched = deterministic || (action !== 'pass' && Math.random() < chance);

      if (matched) {
        if (!state.matches.includes(profile.id)) state.matches.push(profile.id);
        ensureChat(profile.id);

        lastMatchId = profile.id;
        lastMatchWasSuper = action === 'superlike';
        showMatchModal(profile, lastMatchWasSuper);
        return true;
      }

      return false;
    }

    function undoSwipe(){
      if (state.swipeHistory.length === 0) return toast('–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å');

      const last = state.swipeHistory.pop();

      // remove from seen
      state.seen = state.seen.filter(x => x !== last.id);

      // remove from action lists
      if (last.action === 'like') state.likes = state.likes.filter(x => x !== last.id);
      if (last.action === 'pass') state.passes = state.passes.filter(x => x !== last.id);
      if (last.action === 'superlike') state.superLikes = state.superLikes.filter(x => x !== last.id);

      // if it created a match, rollback match & chat
      if (last.createdMatch) {
        state.matches = state.matches.filter(x => x !== last.id);
        delete state.chats[last.id];
        toast('–û—Ç–º–µ–Ω–∏–ª–∏ –∏ –º–∞—Ç—á —Ç–æ–∂–µ –æ—Ç–∫–∞—Ç–∏–ª—Å—è');
      } else {
        toast('–û—Ç–º–µ–Ω–µ–Ω–æ');
      }

      persist();
      renderFeed();
      updateHeaderStats();
      if (state.currentView === 'explore') renderExplore();
      if (state.currentView === 'messages') renderMessages();
    }

    function resetFeed(){
      state.seen = [];
      state.likes = [];
      state.passes = [];
      state.superLikes = [];
      state.swipeHistory = [];
      toast('–õ–µ–Ω—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
      persist();
      renderFeed();
      if (state.currentView === 'explore') renderExplore();
      updateHeaderStats();
    }

    // -----------------------
    // Explore
    // -----------------------
    function renderExplore(){
      const grid = document.getElementById('explore-grid');
      const q = (document.getElementById('explore-search').value || '').trim().toLowerCase();
      grid.innerHTML = '';

      const list = INITIAL_PROFILES
        .filter(passesFilters)
        .filter(p => !state.blocked.includes(p.id))
        .filter(p => {
          if (!q) return true;
          const hay = `${p.name} ${p.interests.join(' ')} ${p.bio}`.toLowerCase();
          return hay.includes(q);
        })
        .sort((a,b) => a.distanceKm - b.distanceKm);

      document.getElementById('explore-count').textContent = `${list.length} –ø—Ä–æ—Ñ.`;

      if (list.length === 0) {
        grid.innerHTML = `
          <div class="col-span-2 p-6 text-center text-gray-400">
            <div class="w-14 h-14 mx-auto mb-3 rounded-2xl bg-gray-100 flex items-center justify-center"><i data-lucide="search-x" class="w-6 h-6"></i></div>
            –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ò–∑–º–µ–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏–ª–∏ —Ñ–∏–ª—å—Ç—Ä—ã.
          </div>
        `;
        lucide.createIcons();
        return;
      }

      for (const p of list) {
        const item = document.createElement('div');
        item.className = 'relative aspect-[3/4] rounded-2xl overflow-hidden shadow-sm group cursor-pointer bg-gray-100';
        item.onclick = () => openProfileDetail(p.id, { from: 'explore' });

        const alreadySeen = state.seen.includes(p.id);
        const isMatch = state.matches.includes(p.id);

        item.innerHTML = `
          <img src="${p.photos[0]}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500" />
          <div class="absolute inset-0 bg-gradient-to-t from-black/65 to-transparent flex flex-col justify-end p-3 text-white">
            <div class="flex items-center justify-between gap-2">
              <div class="min-w-0">
                <span class="font-extrabold text-sm block truncate">${escapeHtml(p.name)}, ${p.age}</span>
                <span class="text-[10px] opacity-80 block truncate">${escapeHtml(p.interests[0] || '–ò–Ω—Ç–µ—Ä–µ—Å—ã')} ‚Ä¢ ${formatDistance(p.distanceKm)}</span>
              </div>
              <div class="flex items-center gap-2">
                ${isMatch ? '<span class="text-[10px] px-2 py-1 rounded-full bg-pink-500/90 font-extrabold">MATCH</span>' : ''}
                ${alreadySeen ? '<span class="text-[10px] px-2 py-1 rounded-full bg-white/20 font-bold">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</span>' : ''}
              </div>
            </div>
          </div>
          <button class="absolute top-3 right-3 w-9 h-9 rounded-full bg-white/20 backdrop-blur-md text-white flex items-center justify-center" title="–õ–∞–π–∫" onclick="event.stopPropagation(); quickLikeFromExplore(${p.id});">
            <i data-lucide="heart" class="w-5 h-5"></i>
          </button>
        `;

        grid.appendChild(item);
      }

      lucide.createIcons();
    }

    function quickLikeFromExplore(id){
      if (state.seen.includes(id)) return toast('–£–∂–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ');
      const p = getProfileById(id);
      if (!p) return;
      // Apply like without animation
      const createdMatch = applyActionToState(p, 'like');
      state.seen.push(p.id);
      state.swipeHistory.push({ id: p.id, action: 'like', createdMatch, ts: Date.now() });
      persist();
      toast(createdMatch ? '–õ–∞–π–∫ ‚Üí MATCH!' : '–õ–∞–π–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
      renderExplore();
      updateHeaderStats();
    }

    // -----------------------
    // Profile Detail
    // -----------------------
    function openProfileDetail(id, opts = {}){
      const p = getProfileById(id);
      if (!p) return;
      detail.profileId = id;
      detail.photoIndex = 0;

      fillProfileDetail(p);
      document.getElementById('profile-detail').classList.remove('hidden');
      lucide.createIcons();
    }

    function fillProfileDetail(p){
      document.getElementById('detail-name-age').textContent = `${p.name}, ${p.age}`;
      document.getElementById('detail-meta').textContent = `${formatDistance(p.distanceKm)} ‚Ä¢ ${p.gender === 'female' ? '–ñ–µ–Ω—â–∏–Ω–∞' : '–ú—É–∂—á–∏–Ω–∞'}`;
      document.getElementById('detail-bio').textContent = p.bio;

      // badges
      const badges = document.getElementById('detail-badges');
      badges.innerHTML = '';
      if (state.matches.includes(p.id)) badges.innerHTML += `<span class="px-3 py-1 rounded-full bg-pink-50 text-pink-600 font-extrabold text-xs">Match</span>`;
      if (state.superLikes.includes(p.id)) badges.innerHTML += `<span class="px-3 py-1 rounded-full bg-blue-50 text-blue-600 font-extrabold text-xs">Superliked</span>`;

      // interests
      const interests = document.getElementById('detail-interests');
      interests.innerHTML = '';
      p.interests.forEach(i => {
        const span = document.createElement('span');
        span.className = 'px-3 py-1 border border-pink-200 text-pink-600 rounded-full text-sm font-semibold';
        span.textContent = i;
        interests.appendChild(span);
      });

      // photos
      renderDetailPhoto();
      renderDetailThumbs();
    }

    function renderDetailPhoto(){
      const p = getProfileById(detail.profileId);
      if (!p) return;
      detail.photoIndex = clamp(detail.photoIndex, 0, p.photos.length - 1);
      document.getElementById('detail-img').src = p.photos[detail.photoIndex];
      document.getElementById('detail-prev').style.opacity = detail.photoIndex === 0 ? 0.35 : 1;
      document.getElementById('detail-next').style.opacity = detail.photoIndex === p.photos.length - 1 ? 0.35 : 1;
    }

    function renderDetailThumbs(){
      const p = getProfileById(detail.profileId);
      const wrap = document.getElementById('detail-photo-thumbs');
      wrap.innerHTML = '';
      if (!p) return;

      p.photos.forEach((src, idx) => {
        const b = document.createElement('button');
        b.className = `flex-shrink-0 w-16 h-16 rounded-xl overflow-hidden border ${idx === detail.photoIndex ? 'border-pink-500' : 'border-gray-200'} bg-gray-100`;
        b.onclick = () => {
          detail.photoIndex = idx;
          renderDetailPhoto();
          renderDetailThumbs();
        };
        b.innerHTML = `<img src="${src}" class="w-full h-full object-cover" />`;
        wrap.appendChild(b);
      });
    }

    function detailPrevPhoto(){
      const p = getProfileById(detail.profileId);
      if (!p) return;
      if (detail.photoIndex === 0) return;
      detail.photoIndex -= 1;
      renderDetailPhoto();
      renderDetailThumbs();
    }

    function detailNextPhoto(){
      const p = getProfileById(detail.profileId);
      if (!p) return;
      if (detail.photoIndex >= p.photos.length - 1) return;
      detail.photoIndex += 1;
      renderDetailPhoto();
      renderDetailThumbs();
    }

    function closeProfileDetail(){
      document.getElementById('profile-detail').classList.add('hidden');
      detail.profileId = null;
      detail.photoIndex = 0;
    }

    function copyProfileLink(){
      if (!detail.profileId) return;
      const link = `${location.href.split('#')[0]}#profile=${detail.profileId}`;
      navigator.clipboard?.writeText(link)
        .then(() => toast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'))
        .catch(() => toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'));
    }

    function openDetailMenu(){
      toast('–ú–µ–Ω—é –ø—Ä–æ—Ñ–∏–ª—è: –±–ª–æ–∫/—Ä–µ–ø–æ—Ä—Ç –Ω–∏–∂–µ');
    }

    function blockFromDetail(){
      if (!detail.profileId) return;
      const id = detail.profileId;
      const p = getProfileById(id);
      if (!p) return;
      if (!confirm(`–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å ${p.name}?`)) return;

      if (!state.blocked.includes(id)) state.blocked.push(id);
      // also remove from matches/chats
      state.matches = state.matches.filter(x => x !== id);
      delete state.chats[id];
      toast('–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
      persist();
      closeProfileDetail();
      renderFeed();
      if (state.currentView === 'explore') renderExplore();
      if (state.currentView === 'messages') renderMessages();
      updateHeaderStats();
    }

    function reportFromDetail(){
      if (!detail.profileId) return;
      const p = getProfileById(detail.profileId);
      if (!p) return;
      toast(`–ñ–∞–ª–æ–±–∞ –Ω–∞ ${p.name} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ (–¥–µ–º–æ)`);
    }

    // -----------------------
    // Match modal
    // -----------------------
    function showMatchModal(profile, isSuper){
      document.getElementById('match-name').textContent = profile.name;
      document.getElementById('match-their-img').src = profile.photos[0];
      document.getElementById('match-my-img').src = state.myProfile.photos[0] || '';
      document.getElementById('match-sub').textContent = isSuper ? '–°—É–ø–µ—Ä–ª–∞–π–∫ —Å—Ä–∞–±–æ—Ç–∞–ª!' : '–°–∞–º–æ–µ –≤—Ä–µ–º—è –Ω–∞–ø–∏—Å–∞—Ç—å –ø–µ—Ä–≤–æ–π/–ø–µ—Ä–≤—ã–º.';
      document.getElementById('match-modal').classList.remove('hidden');
    }

    function closeMatchModal(){
      document.getElementById('match-modal').classList.add('hidden');
    }

    function goToMatchChat(){
      if (!lastMatchId) return closeMatchModal();
      closeMatchModal();
      switchView('messages');
      openChat(lastMatchId);
    }

    // -----------------------
    // Messages / Chats
    // -----------------------
    function ensureChat(profileId){
      if (!state.chats) state.chats = {};
      if (!state.chats[profileId]) {
        const p = getProfileById(profileId);
        state.chats[profileId] = {
          messages: [
            {
              id: uid(),
              from: 'them',
              text: `–ü—Ä–∏–≤–µ—Ç! –Ø ${p?.name || '...'}. –†–∞–¥(–∞) –º–∞—Ç—á—É üôÇ`,
              ts: Date.now()
            }
          ],
          unread: 1
        };
      }
    }

    function renderMessages(){
      renderMatchesRow();
      renderChatsList();
      lucide.createIcons();
    }

    function renderMatchesRow(){
      const row = document.getElementById('matches-row');
      row.innerHTML = '';

      const ids = [...state.matches].slice().reverse();
      if (ids.length === 0) {
        row.innerHTML = '<p class="text-gray-400 text-sm italic">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π</p>';
        return;
      }

      for (const id of ids) {
        const p = getProfileById(id);
        if (!p) continue;
        const div = document.createElement('div');
        div.className = 'flex-shrink-0 flex flex-col items-center space-y-1 cursor-pointer';
        div.onclick = () => openChat(id);
        div.innerHTML = `
          <div class="w-16 h-16 rounded-full ring-2 ring-pink-500 p-1">
            <img src="${p.photos[0]}" class="w-full h-full object-cover rounded-full" />
          </div>
          <span class="text-xs font-bold text-gray-700">${escapeHtml(p.name)}</span>
        `;
        row.appendChild(div);
      }
    }

    function renderChatsList(){
      const list = document.getElementById('chats-list');
      list.innerHTML = '';

      const ids = [...state.matches].slice().reverse();
      if (ids.length === 0) {
        list.innerHTML = '<p class="text-gray-400 text-center py-8">–¢—É—Ç –±—É–¥–µ—Ç –≤–∞—à–∞ –ø–µ—Ä–µ–ø–∏—Å–∫–∞</p>';
        return;
      }

      for (const id of ids) {
        const p = getProfileById(id);
        if (!p) continue;
        ensureChat(id);
        const chat = state.chats[id];
        const last = chat.messages[chat.messages.length - 1];

        const el = document.createElement('div');
        el.className = 'flex items-center space-x-4 p-2 hover:bg-gray-50 rounded-xl cursor-pointer';
        el.onclick = () => openChat(id);
        el.innerHTML = `
          <div class="w-16 h-16 rounded-full overflow-hidden">
            <img src="${p.photos[0]}" class="w-full h-full object-cover" />
          </div>
          <div class="flex-1 border-b border-gray-50 pb-2 min-w-0">
            <div class="flex justify-between items-center mb-1">
              <h4 class="font-extrabold truncate">${escapeHtml(p.name)}</h4>
              <div class="flex items-center gap-2">
                <span class="text-xs text-gray-400">${formatTime(last.ts)}</span>
                ${chat.unread > 0 ? `<span class="min-w-5 h-5 px-1 rounded-full bg-pink-500 text-white text-[10px] flex items-center justify-center font-extrabold">${chat.unread}</span>` : ''}
              </div>
            </div>
            <p class="text-sm text-gray-500 truncate">${escapeHtml(last.text)}</p>
          </div>
        `;
        list.appendChild(el);
      }

      updateHeaderStats();
    }

    function openChat(profileId){
      const p = getProfileById(profileId);
      if (!p) return;

      window.__activeChatId = profileId;
      ensureChat(profileId);

      document.getElementById('messages-list-container').classList.add('hidden');
      document.getElementById('chat-window').classList.remove('hidden');
      document.getElementById('chat-user-img').src = p.photos[0];
      document.getElementById('chat-user-name').textContent = p.name;

      // mark read
      state.chats[profileId].unread = 0;
      persist();
      updateHeaderStats();

      renderChatMessages(profileId);
      lucide.createIcons();

      // focus input
      setTimeout(() => document.getElementById('chat-input')?.focus(), 80);
    }

    function closeChat(){
      window.__activeChatId = null;
      const a = document.getElementById('messages-list-container');
      const b = document.getElementById('chat-window');
      if (a && b) {
        a.classList.remove('hidden');
        b.classList.add('hidden');
      }
    }

    function renderChatMessages(profileId){
      const wrap = document.getElementById('chat-messages');
      wrap.innerHTML = '';
      const chat = state.chats[profileId];
      if (!chat) return;

      for (const m of chat.messages) {
        const row = document.createElement('div');
        const isMe = m.from === 'me';
        row.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
        row.innerHTML = `
          <div class="${isMe ? 'bg-pink-500 text-white' : 'bg-white text-gray-800'} p-3 rounded-2xl ${isMe ? 'rounded-tr-none' : 'rounded-tl-none'} shadow-sm max-w-[80%] text-sm">
            <div>${escapeHtml(m.text)}</div>
            <div class="mt-1 text-[10px] ${isMe ? 'text-white/70' : 'text-gray-400'}">${formatTime(m.ts)}</div>
          </div>
        `;
        wrap.appendChild(row);
      }

      wrap.scrollTop = wrap.scrollHeight;
    }

    function sendChatMessage(){
      const id = window.__activeChatId;
      if (!id) return;

      const input = document.getElementById('chat-input');
      const text = (input.value || '').trim();
      if (!text) return;

      ensureChat(id);
      state.chats[id].messages.push({ id: uid(), from: 'me', text, ts: Date.now() });
      input.value = '';

      persist();
      renderChatMessages(id);
      renderChatsList();

      // simulate typing + reply
      simulateReply(id);
    }

    function simulateReply(profileId){
      const typing = document.getElementById('typing-indicator');
      typing.classList.remove('hidden');

      const replies = [
        '–ö–ª–∞—Å—Å! –†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ üôÇ',
        '–û–≥–æ, –∑–≤—É—á–∏—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ. –ö–æ–≥–¥–∞ —Å–≤–æ–±–æ–¥–µ–Ω/—Å–≤–æ–±–æ–¥–Ω–∞?',
        '–•–∞—Ö–∞, –º–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —Ç–≤–æ–π –≤–∞–π–± üòÑ',
        '–î–∞–≤–∞–π –æ–±–º–µ–Ω—è–µ–º—Å—è –ø–ª–µ–π–ª–∏—Å—Ç–∞–º–∏?',
        '–ö–∞–∫–æ–π —É —Ç–µ–±—è –∏–¥–µ–∞–ª—å–Ω—ã–π –≤–µ—á–µ—Ä?'
      ];

      const delay = 900 + Math.random() * 900;
      setTimeout(() => {
        typing.classList.add('hidden');
        const reply = replies[Math.floor(Math.random() * replies.length)];
        ensureChat(profileId);
        state.chats[profileId].messages.push({ id: uid(), from: 'them', text: reply, ts: Date.now() });

        // if chat is open -> read, else unread++
        if (window.__activeChatId === profileId) {
          state.chats[profileId].unread = 0;
          renderChatMessages(profileId);
        } else {
          state.chats[profileId].unread = (state.chats[profileId].unread || 0) + 1;
        }

        persist();
        renderChatsList();
        updateHeaderStats();
      }, delay);
    }

    function markAllRead(){
      Object.keys(state.chats || {}).forEach(k => state.chats[k].unread = 0);
      persist();
      renderMessages();
      toast('–í—Å–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ');
    }

    function openChatMenu(){
      const id = window.__activeChatId;
      if (!id) return;
      const p = getProfileById(id);
      if (!p) return;
      const action = prompt(`–ú–µ–Ω—é —á–∞—Ç–∞ —Å ${p.name}:\n1 ‚Äî –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç\n2 ‚Äî –£–¥–∞–ª–∏—Ç—å –º–∞—Ç—á\n(–í–≤–µ–¥–∏—Ç–µ 1 –∏–ª–∏ 2)`);
      if (!action) return;
      if (action === '1') {
        state.chats[id].messages = [];
        state.chats[id].unread = 0;
        persist();
        renderChatMessages(id);
        renderChatsList();
        toast('–ß–∞—Ç –æ—á–∏—â–µ–Ω');
      }
      if (action === '2') {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –º–∞—Ç—á –∏ —á–∞—Ç?')) return;
        state.matches = state.matches.filter(x => x !== id);
        delete state.chats[id];
        persist();
        closeChat();
        renderMessages();
        updateHeaderStats();
        toast('–ú–∞—Ç—á —É–¥–∞–ª–µ–Ω');
      }
    }

    // -----------------------
    // Profile (My)
    // -----------------------
    function renderMyProfile(){
      document.getElementById('my-name').value = state.myProfile.name || '';
      document.getElementById('my-age').value = state.myProfile.age || 24;
      document.getElementById('my-bio').value = state.myProfile.bio || '';
      updateBioCounter();

      const avatar = state.myProfile.photos?.[0] || '';
      document.getElementById('my-profile-pic').src = avatar;
      document.getElementById('match-my-img').src = avatar;

      const pBadge = document.getElementById('premium-badge');
      if (state.isPremium) pBadge.classList.remove('hidden');
      else pBadge.classList.add('hidden');

      renderInterests();
      renderMyPhotosGrid();
      lucide.createIcons();
    }

    function updateBioCounter(){
      const v = document.getElementById('my-bio').value || '';
      document.getElementById('bio-counter').textContent = `${v.length}/240`;
    }

    function renderInterests(){
      const container = document.getElementById('interests-container');
      container.innerHTML = '';

      for (const interest of INTERESTS_LIST) {
        const isActive = state.myProfile.interests.includes(interest);
        const btn = document.createElement('button');
        btn.textContent = interest;
        btn.className = `px-4 py-2 rounded-full text-sm font-bold transition ${isActive ? 'bg-pink-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`;
        btn.onclick = () => {
          if (state.myProfile.interests.includes(interest)) {
            state.myProfile.interests = state.myProfile.interests.filter(i => i !== interest);
          } else {
            if (state.myProfile.interests.length >= 8) return toast('–ú–∞–∫—Å. 8 –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤');
            state.myProfile.interests.push(interest);
          }
          persist();
          renderInterests();
        };
        container.appendChild(btn);
      }
    }

    function randomizeInterests(){
      const shuffled = [...INTERESTS_LIST].sort(() => Math.random() - 0.5);
      state.myProfile.interests = shuffled.slice(0, 5);
      persist();
      renderInterests();
      toast('–ò–Ω—Ç–µ—Ä–µ—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
    }

    function renderMyPhotosGrid(){
      const grid = document.getElementById('my-photos-grid');
      grid.innerHTML = '';

      const photos = state.myProfile.photos || [];

      photos.forEach((src, idx) => {
        const cell = document.createElement('div');
        cell.className = 'relative aspect-square rounded-lg overflow-hidden bg-gray-100';
        cell.innerHTML = `
          <img src="${src}" class="w-full h-full object-cover" />
          <button class="absolute top-1 right-1 w-7 h-7 rounded-full bg-black/40 text-white flex items-center justify-center" title="–£–¥–∞–ª–∏—Ç—å" onclick="removeMyPhoto(${idx})">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
          <button class="absolute bottom-1 left-1 text-[10px] px-2 py-1 rounded-full ${idx===0 ? 'bg-pink-500 text-white' : 'bg-white/80 text-gray-700'} font-extrabold" onclick="setMainMyPhoto(${idx})">
            ${idx===0 ? '–ì–ª–∞–≤–Ω–æ–µ' : '–°–¥–µ–ª–∞—Ç—å –≥–ª–∞–≤–Ω—ã–º'}
          </button>
        `;
        grid.appendChild(cell);
      });

      // add tile
      const add = document.createElement('button');
      add.className = 'aspect-square bg-gray-100 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-300 hover:bg-gray-50';
      add.onclick = () => document.getElementById('my-photos-input').click();
      add.innerHTML = '<i data-lucide="plus" class="text-gray-400"></i>';
      grid.appendChild(add);

      lucide.createIcons();
    }

    function removeMyPhoto(index){
      if ((state.myProfile.photos || []).length <= 1) return toast('–ù—É–∂–Ω–æ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ñ–æ—Ç–æ');
      state.myProfile.photos.splice(index, 1);
      persist();
      renderMyProfile();
      toast('–§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ');
    }

    function setMainMyPhoto(index){
      const photos = state.myProfile.photos || [];
      if (!photos[index]) return;
      const [picked] = photos.splice(index, 1);
      photos.unshift(picked);
      state.myProfile.photos = photos;
      persist();
      renderMyProfile();
      toast('–ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
    }

    function saveProfile(){
      const name = (document.getElementById('my-name').value || '').trim();
      const age = parseInt(document.getElementById('my-age').value || '24', 10);
      const bio = (document.getElementById('my-bio').value || '').trim();

      if (!name) return toast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
      if (!age || age < 18 || age > 99) return toast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç');

      state.myProfile.name = name;
      state.myProfile.age = age;
      state.myProfile.bio = bio;

      persist();
      toast('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
      switchView('feed');
    }

    function resetMyProfile(){
      if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –¥–æ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) return;
      state.myProfile = structuredClone(DEFAULT_STATE.myProfile);
      persist();
      renderMyProfile();
      toast('–ü—Ä–æ—Ñ–∏–ª—å —Å–±—Ä–æ—à–µ–Ω');
    }

    function logoutDemo(){
      toast('–í –¥–µ–º–æ —Ä–µ–∂–∏–º–µ –≤—Ö–æ–¥/–≤—ã—Ö–æ–¥ –æ—Ç–∫–ª—é—á–µ–Ω');
    }

    function fileToDataUrl(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // -----------------------
    // Settings
    // -----------------------
    function toggleSettings(forceOpen = null){
      const panel = document.getElementById('settings-panel');
      const isOpen = panel.style.right === '0px';
      const shouldOpen = forceOpen === null ? !isOpen : !!forceOpen;
      panel.style.right = shouldOpen ? '0px' : '-100%';
    }

    function syncSettingsUI(){
      document.getElementById('setting-distance').value = state.settings.maxDistance;
      document.getElementById('setting-distance-label').textContent = `${state.settings.maxDistance} –∫–º`;

      document.getElementById('setting-age-min').value = state.settings.ageMin;
      document.getElementById('setting-age-max').value = state.settings.ageMax;
      document.getElementById('setting-age-label').textContent = `${state.settings.ageMin} ‚Äî ${state.settings.ageMax}`;

      const radios = document.querySelectorAll('input[name="pref"]');
      radios.forEach(r => r.checked = (r.value === state.settings.pref));
    }

    function applySettingsFromUI(){
      const dist = parseInt(document.getElementById('setting-distance').value || '40', 10);
      let minA = parseInt(document.getElementById('setting-age-min').value || '18', 10);
      let maxA = parseInt(document.getElementById('setting-age-max').value || '35', 10);

      if (minA > maxA) [minA, maxA] = [maxA, minA];

      const pref = document.querySelector('input[name="pref"]:checked')?.value || 'all';

      state.settings.maxDistance = clamp(dist, 2, 160);
      state.settings.ageMin = clamp(minA, 18, 99);
      state.settings.ageMax = clamp(maxA, 18, 99);
      state.settings.pref = ['female','male','all'].includes(pref) ? pref : 'all';

      syncSettingsUI();
      persist();

      // refresh relevant views
      if (state.currentView === 'feed') renderFeed();
      if (state.currentView === 'explore') renderExplore();

      updateHeaderStats();
    }

    // -----------------------
    // Boost
    // -----------------------
    function toggleBoost(){
      const now = Date.now();
      if (state.boost.active && state.boost.endsAt > now) {
        state.boost.active = false;
        state.boost.endsAt = 0;
        persist();
        setBoostUi();
        toast('Boost –≤—ã–∫–ª—é—á–µ–Ω');
        return;
      }

      state.boost.active = true;
      state.boost.endsAt = now + 30_000;
      persist();
      setBoostUi();
      toast('Boost –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –Ω–∞ 30 —Å–µ–∫');

      if (boostTimer) clearInterval(boostTimer);
      boostTimer = setInterval(() => {
        if (!state.boost.active) return;
        setBoostUi();
      }, 250);
    }

    // -----------------------
    // Shop & Premium
    // -----------------------
    function toggleShop(){
      const modal = document.getElementById('shop-modal');
      modal.classList.toggle('hidden');
      if (!modal.classList.contains('hidden')) {
        updateShopPrice();
        lucide.createIcons();
      }
    }

    function updateShopPrice(){
      const input = document.getElementById('shop-coin-input');
      const val = parseInt(input.value || '0', 10);
      const display = document.getElementById('shop-total-price');
      display.textContent = `${val * 5}‚ÇΩ`;
    }

    function buyCoins(){
      const input = document.getElementById('shop-coin-input');
      const amount = parseInt(input.value || '0', 10);
      
      if (amount < 50) return toast('–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ ‚Äî 50 –º–æ–Ω–µ—Ç');
      if (amount > 10000) return toast('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ ‚Äî 10 000 –º–æ–Ω–µ—Ç');
      
      const price = amount * 5;
      if (confirm(`–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–∫—É–ø–∫—É ${amount} –º–æ–Ω–µ—Ç –∑–∞ ${price}‚ÇΩ`)) {
        state.coins = (state.coins || 0) + amount;
        persist();
        updateHeaderStats();
        toast(`–ù–∞ –±–∞–ª–∞–Ω—Å –∑–∞—á–∏—Å–ª–µ–Ω–æ ${amount} –º–æ–Ω–µ—Ç!`);
        toggleShop();
      }
    }

    function buyPremium(){
      if (state.isPremium) return toast('–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å Spark Plus!');
      
      if (confirm('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–∫—É–ø–∫—É Spark Plus –∑–∞ 500‚ÇΩ –≤ –º–µ—Å—è—Ü')) {
        state.isPremium = true;
        persist();
        updateHeaderStats();
        renderMyProfile();
        toast('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –¢–µ–ø–µ—Ä—å —É –≤–∞—Å Spark Plus ‚ú®');
        toggleShop();
      }
    }

    // -----------------------
    // Init & Events
    // -----------------------
    function init(){
      loadState();

      // Bind inputs
      document.getElementById('explore-search').addEventListener('input', () => {
        if (state.currentView === 'explore') renderExplore();
      });

      document.getElementById('my-bio').addEventListener('input', () => {
        updateBioCounter();
        state.myProfile.bio = document.getElementById('my-bio').value;
        persist();
      });

      // Settings listeners
      document.getElementById('setting-distance').addEventListener('input', () => {
        document.getElementById('setting-distance-label').textContent = `${document.getElementById('setting-distance').value} –∫–º`;
      });
      document.getElementById('setting-distance').addEventListener('change', applySettingsFromUI);
      document.getElementById('setting-age-min').addEventListener('change', applySettingsFromUI);
      document.getElementById('setting-age-max').addEventListener('change', applySettingsFromUI);
      document.querySelectorAll('input[name="pref"]').forEach(r => r.addEventListener('change', applySettingsFromUI));

      // Photo uploads
      document.getElementById('my-avatar-input').addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const url = await fileToDataUrl(file);
        // set as main photo
        const photos = state.myProfile.photos || [];
        photos.unshift(url);
        state.myProfile.photos = photos.slice(0, 9);
        // remove duplicates
        state.myProfile.photos = [...new Set(state.myProfile.photos)];
        persist();
        renderMyProfile();
        toast('–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
      });

      document.getElementById('my-photos-input').addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const url = await fileToDataUrl(file);
        state.myProfile.photos = (state.myProfile.photos || []).concat([url]).slice(0, 9);
        persist();
        renderMyProfile();
        toast('–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
      });

      // Keyboard shortcuts
      window.addEventListener('keydown', (e) => {
        const tag = (document.activeElement?.tagName || '').toLowerCase();
        const inInput = ['input','textarea'].includes(tag);
        if (inInput) {
          if (e.key === 'Enter' && document.activeElement?.id === 'chat-input' && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage();
          }
          return;
        }

        if (e.key === 'ArrowRight') handleManualAction('like');
        if (e.key === 'ArrowLeft') handleManualAction('pass');
        if (e.key === 'ArrowUp') handleManualAction('superlike');
        if (e.key.toLowerCase() === 'r') undoSwipe();
        if (e.key.toLowerCase() === 'z') toggleBoost();
        if (e.key.toLowerCase() === 's') toggleSettings(true);
        if (e.key === 'Escape') {
          closeMatchModal();
          closeProfileDetail();
          closeRewardModal();
        }
      });

      // Resume boost timer if needed
      if (state.boost.active && state.boost.endsAt > Date.now()) {
        if (boostTimer) clearInterval(boostTimer);
        boostTimer = setInterval(setBoostUi, 250);
      } else {
        state.boost.active = false;
        state.boost.endsAt = 0;
      }

      syncSettingsUI();
      setBoostUi();
      updateHeaderStats();
      checkDailyReward();

      // render
      switchView(state.currentView || 'feed');

      // deep link to profile
      try {
        const hash = location.hash;
        if (hash.startsWith('#profile=')) {
          const id = parseInt(hash.split('=')[1] || '', 10);
          if (id) openProfileDetail(id);
          history.replaceState(null, '', location.href.split('#')[0]);
        }
      } catch {}

      lucide.createIcons();
    }

    window.onload = init;
  </script>
</body>
</html>
