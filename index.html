<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WAR SAGA: CITY UPDATE</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #0a0a0a;
            --card-bg: #141414;
            --gold: #ffcc00;
            --emerald: #2ecc71;
            --text-main: #e0e0e0;
            --text-dim: #888;
            --accent: #b8860b;
            --red: #f44336;
            --blue: #3498db;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text-main); font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { padding: 15px; background: var(--card-bg); border-bottom: 1px solid #333; }
        .stats-top { display: flex; justify-content: space-around; font-weight: bold; margin-bottom: 8px; }
        .xp-container { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .xp-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }

        /* NAVIGATION */
        nav { position: fixed; bottom: 0; width: 100%; background: var(--card-bg); border-top: 1px solid #333; display: flex; justify-content: space-around; padding: 10px 0; padding-bottom: max(10px, env(safe-area-inset-bottom)); z-index: 100; }
        .nav-item { text-align: center; color: var(--text-dim); font-size: 10px; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--gold); }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }

        /* SCREENS */
        main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* CARDS */
        .card { background: var(--card-bg); border: 1px solid #333; border-radius: 12px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; gap: 15px; position: relative; }
        .card .icon { font-size: 30px; min-width: 50px; text-align: center; }
        .card .info { flex: 1; }
        .card h3 { font-size: 16px; margin-bottom: 4px; }
        .card p { font-size: 12px; color: var(--text-dim); }
        
        .btn { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; text-align: center; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background: #333; color: #666; cursor: not-allowed; }

        /* PROFILE */
        .profile-header { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; }
        .avatar { width: 70px; height: 70px; border-radius: 50%; border: 2px solid var(--gold); background: #222; display: flex; align-items: center; justify-content: center; font-size: 30px; overflow: hidden; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-box { background: #1a1a1a; padding: 10px; border-radius: 8px; border: 1px solid #222; }
        .stat-label { font-size: 10px; color: var(--text-dim); display: block; }

        /* TOWN DETAIL */
        #town-detail-content { margin-top: 10px; }

        .float-text { position: fixed; pointer-events: none; font-weight: bold; animation: floatUp 0.8s forwards; z-index: 1000; }
        @keyframes floatUp { to { transform: translateY(-50px); opacity: 0; } }
    </style>
</head>
<body>

<header>
    <div class="stats-top">
        <span>ü™ô <span id="ui-gold">0</span></span>
        <span>üíé <span id="ui-emeralds">0</span></span>
        <span>‚≠ê <span id="ui-lvl">1</span></span>
    </div>
    <div class="xp-container"><div id="ui-xp" class="xp-bar"></div></div>
</header>

<main>
    <section id="tab-battle" class="screen active">
        <h2 style="color: var(--gold); margin-bottom: 15px;">–ö–∞—Ä—Ç–∞ –ú–∏—Ä–∞</h2>
        <div id="world-map"></div>
    </section>

    <section id="tab-town" class="screen">
        <h2 style="color: var(--gold); margin-bottom: 15px;">üèôÔ∏è –ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π –ì–æ—Ä–æ–¥</h2>
        <div class="card" onclick="game.openTownPlace('tavern')">
            <div class="icon">üç∫</div>
            <div class="info"><h3>–¢–∞–≤–µ—Ä–Ω–∞</h3><p>–ù–∞–π–º —Ä–∞–±–æ—á–∏—Ö –∏ –æ—Ç–¥—ã—Ö</p></div>
        </div>
        <div class="card" onclick="game.openTownPlace('forge')">
            <div class="icon">‚öíÔ∏è</div>
            <div class="info"><h3>–ö—É–∑–Ω–∏—Ü–∞</h3><p>–û—Ä—É–∂–∏–µ –∏ –±—Ä–æ–Ω—è</p></div>
        </div>
        <div class="card" onclick="game.openTownPlace('stables')">
            <div class="icon">üêé</div>
            <div class="info"><h3>–ö–æ–Ω—é—à–Ω–∏</h3><p>–ú–∞—É–Ω—Ç—ã –∏ —Å–∫–æ—Ä–æ—Å—Ç—å</p></div>
        </div>
    </section>

    <section id="tab-town-detail" class="screen">
        <button class="btn" style="background: #333; margin-bottom: 15px; width: 100%;" onclick="game.switchTab('town')">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–æ—Ä–æ–¥</button>
        <div id="town-detail-content"></div>
    </section>

    <section id="tab-profile" class="screen">
        <div class="profile-header">
            <div class="avatar" id="user-avatar">üë§</div>
            <div><h2 id="user-name">–ì–µ—Ä–æ–π</h2><p id="user-rank" style="color: var(--accent);">–°—Ç—Ä–∞–Ω–Ω–∏–∫</p></div>
        </div>
        <div class="stat-grid">
            <div class="stat-box"><span class="stat-label">–ú–û–©–¨</span><b id="st-power">1</b></div>
            <div class="stat-box"><span class="stat-label">–î–û–•–û–î</span><b id="st-income">0</b>/—Å</div>
            <div class="stat-box"><span class="stat-label">–ö–õ–ò–ö–ò</span><b id="st-clicks">0</b></div>
            <div class="stat-box"><span class="stat-label">–ò–ó–£–ú–†–£–î–´</span><b id="st-gems">0</b></div>
        </div>
    </section>

    <section id="tab-bank" class="screen">
        <h2 style="color: var(--blue); margin-bottom: 15px;">üèõÔ∏è –ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π –ë–∞–Ω–∫</h2>
        <div class="card" style="flex-direction: column; text-align: center;">
            <p style="color: var(--text-dim);">–ù–∞–∫–æ–ø–ª–µ–Ω–æ –∑–æ–ª–æ—Ç–∞:</p>
            <h1 style="font-size: 32px; color: var(--gold);">ü™ô <span id="bank-val">0</span></h1>
            <p style="font-size: 12px; margin-bottom: 10px;">–õ–∏–º–∏—Ç: <span id="bank-limit">0</span></p>
            <button class="btn" style="background: var(--blue); width: 100%;" onclick="game.collectBank()">–ó–ê–ë–†–ê–¢–¨ –ó–û–õ–û–¢–û</button>
        </div>
        <div class="card" style="flex-direction: column;">
            <h3>–ö—É—Ä—Å –æ–±–º–µ–Ω–∞</h3>
            <p>10,000 –∑–æ–ª–æ—Ç–∞ = 1 –∏–∑—É–º—Ä—É–¥</p>
            <button class="btn" style="background: var(--emerald); width: 100%; margin-top: 10px;" onclick="game.exchangeGem()">–û–ë–ú–ï–ù–Ø–¢–¨</button>
        </div>
    </section>
</main>

<nav>
    <div class="nav-item active" onclick="game.switchTab('battle', this)"><span class="nav-icon">‚öîÔ∏è</span>–ë–∏—Ç–≤–∞</div>
    <div class="nav-item" onclick="game.switchTab('town', this)"><span class="nav-icon">üèôÔ∏è</span>–ì–æ—Ä–æ–¥</div>
    <div class="nav-item" onclick="game.switchTab('profile', this)"><span class="nav-icon">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</div>
    <div class="nav-item" onclick="game.switchTab('bank', this)"><span class="nav-icon">üèõÔ∏è</span>–ë–∞–Ω–∫</div>
</nav>

<script>
const DB = {
    locations: [
        { id: 'forest', name: '–õ–µ—Å', icon: 'üå≤', lvl: 1, gold: 2, xp: 5 },
        { id: 'cave', name: '–ü–µ—â–µ—Ä–∞', icon: 'ü¶á', lvl: 5, gold: 10, xp: 20 },
        { id: 'castle', name: '–†—É–∏–Ω—ã', icon: 'üè∞', lvl: 15, gold: 50, xp: 100 }
    ],
    gear: [
        { id: 'sword1', name: '–ú–µ—á –Ω–æ–≤–∏—á–∫–∞', power: 3, price: 100, icon: 'üó°Ô∏è' },
        { id: 'armor1', name: '–ö–æ–∂–∞–Ω—ã–π –∂–∏–ª–µ—Ç', power: 5, price: 500, icon: 'üëï' },
        { id: 'sword2', name: '–°—Ç–∞–ª—å–Ω–æ–π –∫–ª–∏–Ω–æ–∫', power: 15, price: 5000, icon: '‚öîÔ∏è' }
    ],
    workers: [
        { id: 'worker1', name: '–ü–æ–º–æ—â–Ω–∏–∫', income: 1, price: 50, icon: 'üë®‚Äçüåæ' },
        { id: 'worker2', name: '–û—Ö–æ—Ç–Ω–∏–∫', income: 5, price: 400, icon: 'üèπ' }
    ],
    mounts: [
        { id: 'm1', name: '–û—Å–ª–∏–∫', mult: 1.2, price: 1000, icon: 'ü´è' },
        { id: 'm2', name: '–ö–æ–Ω—å', mult: 2.5, price: 10, currency: 'emerald', icon: 'üêé' }
    ]
};

const game = {
    state: {
        gold: 0, emeralds: 0, lvl: 1, xp: 0, xpNeed: 100,
        inventory: [], workers: {}, currentMount: null,
        totalClicks: 0, bankGold: 0, lastSave: Date.now()
    },

    init() {
        const saved = localStorage.getItem('WAR_SAGA_DATA_V2');
        if (saved) Object.assign(this.state, JSON.parse(saved));

        // Telegram Data
        if (window.Telegram?.WebApp) {
            const user = window.Telegram.WebApp.initDataUnsafe?.user;
            if (user) {
                document.getElementById('user-name').innerText = user.first_name;
                if (user.photo_url) document.getElementById('user-avatar').innerHTML = `<img src="${user.photo_url}" style="width:100%">`;
            }
            window.Telegram.WebApp.expand();
        }

        // –û—Ñ—Ñ–ª–∞–π–Ω –¥–æ—Ö–æ–¥
        const secondsOffline = Math.floor((Date.now() - this.state.lastSave) / 1000);
        this.state.bankGold += secondsOffline * this.getIncome();
        this.state.bankGold = Math.min(this.state.bankGold, this.getBankLimit());

        this.renderMap();
        this.updateUI();
        setInterval(() => this.tick(), 1000);
    },

    getIncome() {
        return Object.keys(this.state.workers).reduce((sum, id) => {
            const w = DB.workers.find(x => x.id === id);
            return sum + (w.income * this.state.workers[id]);
        }, 0);
    },

    getPower() {
        let p = 1;
        this.state.inventory.forEach(id => {
            const item = DB.gear.find(x => x.id === id);
            if (item) p += item.power;
        });
        return p;
    },

    getBankLimit() { return this.state.lvl * 5000; },

    getGoldMult() {
        if (!this.state.currentMount) return 1;
        return DB.mounts.find(m => m.id === this.state.currentMount).mult;
    },

    tick() {
        const inc = this.getIncome();
        if (inc > 0) {
            this.state.bankGold = Math.min(this.state.bankGold + inc, this.getBankLimit());
        }
        this.state.lastSave = Date.now();
        this.updateUI();
        this.save();
    },

    handleAttack(locId, e) {
        const loc = DB.locations.find(l => l.id === locId);
        if (this.state.lvl < loc.lvl) return alert("–£—Ä–æ–≤–µ–Ω—å —Å–ª–∏—à–∫–æ–º –º–∞–ª!");

        const gain = Math.floor(loc.gold * this.getPower() * this.getGoldMult());
        this.state.gold += gain;
        this.state.totalClicks++;
        
        // –®–∞–Ω—Å –Ω–∞ –∏–∑—É–º—Ä—É–¥ 1%
        if (Math.random() < 0.01) {
            this.state.emeralds++;
            this.showFloat(e, "+1 üíé", "var(--emerald)");
        }

        this.addXp(loc.xp);
        this.showFloat(e, `+${gain}ü™ô`, "var(--gold)");
        this.updateUI();
    },

    addXp(val) {
        this.state.xp += val;
        if (this.state.xp >= this.state.xpNeed) {
            this.state.lvl++;
            this.state.xp -= this.state.xpNeed;
            this.state.xpNeed = Math.floor(this.state.xpNeed * 1.5);
            alert("–ù–û–í–´–ô –£–†–û–í–ï–ù–¨: " + this.state.lvl);
        }
    },

    collectBank() {
        this.state.gold += Math.floor(this.state.bankGold);
        this.state.bankGold = 0;
        this.updateUI();
    },

    exchangeGem() {
        if (this.state.gold >= 10000) {
            this.state.gold -= 10000;
            this.state.emeralds++;
            this.updateUI();
        }
    },

    openTownPlace(place) {
        this.switchTab('town-detail');
        const content = document.getElementById('town-detail-content');
        
        if (place === 'tavern') {
            content.innerHTML = `<h3>üç∫ –ù–∞–Ω—è—Ç—å —Ä–∞–±–æ—á–∏—Ö</h3>` + DB.workers.map(w => {
                const count = this.state.workers[w.id] || 0;
                const price = Math.floor(w.price * Math.pow(1.15, count));
                return `
                    <div class="card">
                        <div class="icon">${w.icon}</div>
                        <div class="info"><b>${w.name}</b><br><small>–î–æ—Ö–æ–¥: +${w.income}/—Å (–£ –≤–∞—Å: ${count})</small></div>
                        <button class="btn" onclick="game.buyWorker('${w.id}')">${price}ü™ô</button>
                    </div>`;
            }).join('');
        }

        if (place === 'forge') {
            content.innerHTML = `<h3>‚öíÔ∏è –°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ</h3>` + DB.gear.map(g => {
                const owned = this.state.inventory.includes(g.id);
                return `
                    <div class="card">
                        <div class="icon">${g.icon}</div>
                        <div class="info"><b>${g.name}</b><br><small>–ú–æ—â—å: +${g.power}</small></div>
                        <button class="btn" ${owned?'disabled':''} onclick="game.buyGear('${g.id}')">${owned?'–ö–£–ü–õ–ï–ù–û':g.price+'ü™ô'}</button>
                    </div>`;
            }).join('');
        }

        if (place === 'stables') {
            content.innerHTML = `<h3>üêé –ö—É–ø–∏—Ç—å –º–∞—É–Ω—Ç–∞</h3>` + DB.mounts.map(m => {
                const active = this.state.currentMount === m.id;
                const priceText = m.currency === 'emerald' ? m.price + ' üíé' : m.price + ' ü™ô';
                return `
                    <div class="card">
                        <div class="icon">${m.icon}</div>
                        <div class="info"><b>${m.name}</b><br><small>–ë–æ–Ω—É—Å –∑–æ–ª–æ—Ç–∞: x${m.mult}</small></div>
                        <button class="btn" ${active?'disabled':''} onclick="game.buyMount('${m.id}')">${active?'–í –°–ï–î–õ–ï':priceText}</button>
                    </div>`;
            }).join('');
        }
    },

    buyWorker(id) {
        const w = DB.workers.find(x => x.id === id);
        const count = this.state.workers[id] || 0;
        const price = Math.floor(w.price * Math.pow(1.15, count));
        if (this.state.gold >= price) {
            this.state.gold -= price;
            this.state.workers[id] = count + 1;
            this.openTownPlace('tavern');
            this.updateUI();
        }
    },

    buyGear(id) {
        const g = DB.gear.find(x => x.id === id);
        if (this.state.gold >= g.price && !this.state.inventory.includes(id)) {
            this.state.gold -= g.price;
            this.state.inventory.push(id);
            this.openTownPlace('forge');
            this.updateUI();
        }
    },

    buyMount(id) {
        const m = DB.mounts.find(x => x.id === id);
        const cur = m.currency === 'emerald' ? 'emeralds' : 'gold';
        if (this.state[cur] >= m.price) {
            this.state[cur] -= m.price;
            this.state.currentMount = id;
            this.openTownPlace('stables');
            this.updateUI();
        }
    },

    renderMap() {
        document.getElementById('world-map').innerHTML = DB.locations.map(loc => `
            <div class="card" onclick="game.handleAttack('${loc.id}', event)">
                <div class="icon">${loc.icon}</div>
                <div class="info"><b>${loc.name}</b><p>–ú–∏–Ω. —É—Ä–æ–≤–µ–Ω—å: ${loc.lvl}</p></div>
                <button class="btn" ${this.state.lvl < loc.lvl ? 'disabled' : ''}>–í –ë–û–ô</button>
            </div>
        `).join('');
    },

    updateUI() {
        document.getElementById('ui-gold').innerText = Math.floor(this.state.gold).toLocaleString();
        document.getElementById('ui-emeralds').innerText = this.state.emeralds;
        document.getElementById('ui-lvl').innerText = this.state.lvl;
        document.getElementById('ui-xp').style.width = (this.state.xp / this.state.xpNeed * 100) + "%";
        
        document.getElementById('st-power').innerText = this.getPower();
        document.getElementById('st-income').innerText = this.getIncome();
        document.getElementById('st-clicks').innerText = this.state.totalClicks;
        document.getElementById('st-gems').innerText = this.state.emeralds;

        document.getElementById('bank-val').innerText = Math.floor(this.state.bankGold).toLocaleString();
        document.getElementById('bank-limit').innerText = this.getBankLimit().toLocaleString();
    },

    switchTab(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
        if (el) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }
        if (id === 'battle') this.renderMap();
    },

    showFloat(e, text, color) {
        const el = document.createElement('div');
        el.className = 'float-text';
        el.innerText = text;
        el.style.color = color;
        el.style.left = (e.clientX || window.innerWidth/2) + 'px';
        el.style.top = (e.clientY || window.innerHeight/2) + 'px';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 800);
    },

    save() { localStorage.setItem('WAR_SAGA_DATA_V2', JSON.stringify(this.state)); }
};

window.onload = () => game.init();
</script>
</body>
</html>
