<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WAR SAGA: REBORN</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò --- */
        :root {
            --bg: #0a0a0a;
            --card-bg: #141414;
            --gold: #ffcc00;
            --text-main: #e0e0e0;
            --text-dim: #888;
            --accent: #b8860b;
            --green: #4caf50;
            --red: #f44336;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- –ó–ê–ì–†–£–ó–ß–ò–ö --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #333;
            border-top: 4px solid var(--gold); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- –®–ê–ü–ö–ê --- */
        header {
            padding: 15px; background: var(--card-bg);
            border-bottom: 1px solid #333; display: flex; flex-direction: column; gap: 10px;
        }
        .stats-row { display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1em; }
        
        .xp-container { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; position: relative; }
        .xp-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }

        /* --- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ --- */
        main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }
        .screen { display: none; animation: fade 0.3s; }
        .screen.active { display: block; }
        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }

        /* --- –ö–ê–†–¢–û–ß–ö–ò --- */
        .card {
            background: var(--card-bg); border: 1px solid #333; border-radius: 8px;
            padding: 15px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px;
            position: relative;
        }
        .icon { font-size: 2em; min-width: 50px; text-align: center; }
        .info { flex: 1; }
        .info h3 { font-size: 1em; margin-bottom: 4px; }
        .info p { font-size: 0.85em; color: var(--text-dim); }
        
        button.btn {
            background: var(--accent); color: #fff; border: none;
            padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer;
        }
        button.btn:active { transform: scale(0.95); opacity: 0.8; }
        button.btn:disabled { background: #333; color: #555; cursor: not-allowed; }

        /* --- –ù–û–í–û–ï: –ö–ê–†–¢–ê –ò –ë–û–°–°–´ --- */
        .lock-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.85);
            display: flex; justify-content: center; align-items: center;
            border-radius: 8px; font-weight: bold; color: var(--red); z-index: 2;
        }
        .boss-card {
            background: linear-gradient(135deg, #200, #411);
            border: 2px solid var(--red);
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 5px var(--red); }
            50% { box-shadow: 0 0 15px var(--red); }
            100% { box-shadow: 0 0 5px var(--red); }
        }

        /* --- –ù–ê–í–ò–ì–ê–¶–ò–Ø --- */
        nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--card-bg); border-top: 1px solid #333;
            display: flex; justify-content: space-around; padding: 10px 0;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        .nav-item {
            text-align: center; color: var(--text-dim); font-size: 0.75em;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .nav-item.active { color: var(--gold); }
        .nav-icon { font-size: 1.4em; }

        .float-text {
            position: fixed; color: var(--gold); font-weight: bold; font-size: 1.2em;
            pointer-events: none; animation: floatUp 0.8s forwards; z-index: 1000;
        }
        @keyframes floatUp { to { transform: translateY(-50px); opacity: 0; } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∏—Ä–∞...</p>
    </div>

    <header>
        <div class="stats-row">
            <span>ü™ô <span id="ui-gold">0</span></span>
            <span>–£—Ä. <span id="ui-lvl">1</span></span>
        </div>
        <div class="xp-container"><div id="ui-xp" class="xp-bar"></div></div>
        <div style="font-size: 0.8em; color: #666; text-align: center;">
            –°–∏–ª–∞: <span id="ui-power">1</span> (x<span id="ui-mult">1</span>) | –î–æ—Ö–æ–¥: <span id="ui-auto">0</span>/—Å–µ–∫
        </div>
    </header>

    <main>
        <section id="tab-battle" class="screen active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="color: var(--gold);">–ö–∞—Ä—Ç–∞ –ú–∏—Ä–∞</h2>
                <button class="btn" style="font-size: 0.7em; background: #222;" onclick="game.showPrestige()">üåü –í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ</button>
            </div>
            <div id="world-map"></div>
        </section>

        <section id="tab-gear" class="screen">
            <h2 style="margin-bottom: 15px; color: var(--gold);">–û—Ä—É–∂–µ–π–Ω–∞—è</h2>
            <div id="gear-list"></div>
        </section>

        <section id="tab-shop" class="screen">
            <h2 style="margin-bottom: 15px; color: var(--gold);">–ù–∞–µ–º–Ω–∏–∫–∏</h2>
            <div id="shop-list"></div>
        </section>
    </main>

    <nav>
        <div class="nav-item active" onclick="game.switchTab('battle', this)">
            <span class="nav-icon">‚öîÔ∏è</span>
            <span>–ë–∏—Ç–≤–∞</span>
        </div>
        <div class="nav-item" onclick="game.switchTab('gear', this)">
            <span class="nav-icon">üõ°Ô∏è</span>
            <span>–ì–µ—Ä–æ–π</span>
        </div>
        <div class="nav-item" onclick="game.switchTab('shop', this)">
            <span class="nav-icon">üí∞</span>
            <span>–õ–∞–≤–∫–∞</span>
        </div>
    </nav>

    <script>
        const DB = {
            locations: [
                { id: 'forest', name: '–¢–µ–º–Ω—ã–π –õ–µ—Å', icon: 'üå≤', lvl: 1, base: 1, boss: '–ö–æ—Ä–æ–ª—å –í–æ–ª–∫–æ–≤', bossHp: 500 },
                { id: 'cave', name: '–ü–µ—â–µ—Ä–∞ –£–∂–∞—Å–∞', icon: 'ü¶á', lvl: 5, base: 5, boss: '–ú–∞—Ç—å –ü–∞—É–∫–æ–≤', bossHp: 2500 },
                { id: 'castle', name: '–¶–∏—Ç–∞–¥–µ–ª—å', icon: 'üè∞', lvl: 15, base: 20, boss: '–ü–∞–¥—à–∏–π –†—ã—Ü–∞—Ä—å', bossHp: 15000 },
                { id: 'abyss', name: '–ë–µ–∑–¥–Ω–∞', icon: 'üåÄ', lvl: 30, base: 100, boss: '–í–ª–∞–¥—ã–∫–∞ –•–∞–æ—Å–∞', bossHp: 100000 }
            ],
            gear: [
                { id: 'sword1', name: '–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π –º–µ—á', power: 2, price: 50, icon: 'üó°Ô∏è' },
                { id: 'sword2', name: '–ñ–µ–ª–µ–∑–Ω—ã–π –º–µ—á', power: 5, price: 250, icon: '‚öîÔ∏è' },
                { id: 'armor1', name: '–ö–æ–∂–∞–Ω–∞—è –±—Ä–æ–Ω—è', power: 3, price: 500, icon: 'üëï' },
                { id: 'ring1', name: '–ö–æ–ª—å—Ü–æ —Å–∏–ª—ã', power: 10, price: 1500, icon: 'üíç' },
                { id: 'sword3', name: '–ú–µ—á –ì–µ—Ä–æ—è', power: 25, price: 5000, icon: 'üî•' }
            ],
            workers: [
                { id: 'peasant', name: '–ö—Ä–µ—Å—Ç—å—è–Ω–∏–Ω', income: 1, price: 100, icon: 'üë®‚Äçüåæ' },
                { id: 'miner', name: '–®–∞—Ö—Ç–µ—Ä', income: 5, price: 600, icon: '‚õèÔ∏è' },
                { id: 'merchant', name: '–¢–æ—Ä–≥–æ–≤–µ—Ü', income: 15, price: 2000, icon: '‚öñÔ∏è' }
            ]
        };

        const game = {
            state: {
                gold: 0,
                lvl: 1,
                xp: 0,
                xpNeed: 100,
                inventory: [],
                workers: {},
                unlockedLocs: ['forest'],
                locationProgress: {},
                prestigePoints: 1,
                bossDefeated: []
            },

            init() {
                try {
                    const saved = localStorage.getItem('WAR_SAGA_REBORN_V1');
                    if (saved) this.state = Object.assign(this.state, JSON.parse(saved));

                    if (window.Telegram?.WebApp) {
                        window.Telegram.WebApp.ready();
                        window.Telegram.WebApp.expand();
                    }

                    this.renderMap();
                    this.renderShop();
                    this.renderGear();
                    this.updateUI();

                    setInterval(() => this.tick(), 1000);

                    setTimeout(() => {
                        document.getElementById('loader').style.opacity = '0';
                        setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
                    }, 800);
                } catch (e) {
                    console.error(e);
                }
            },

            // --- –õ–û–ì–ò–ö–ê –ë–ò–¢–í–´ ---
            handleLocClick(locId, e) {
                const loc = DB.locations.find(l => l.id === locId);
                if (this.state.lvl < loc.lvl && !this.state.unlockedLocs.includes(loc.id)) {
                    this.showFloat(e, "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!", "red");
                    return;
                }

                const progress = this.state.locationProgress[locId] || 0;
                const isBoss = progress >= 50 && !this.state.bossDefeated.includes(locId);

                if (isBoss) {
                    this.fightBoss(loc, e);
                } else {
                    const power = (1 + this.getGearPower()) * this.state.prestigePoints;
                    const gain = Math.floor(loc.base * power);
                    this.state.gold += gain;
                    this.state.locationProgress[locId] = (this.state.locationProgress[locId] || 0) + 1;
                    this.addXp(loc.base * 2);
                    this.showFloat(e, `+${gain}ü™ô`);
                    this.renderMap();
                }
                this.updateUI();
                if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
            },

            fightBoss(loc, e) {
                const myPower = (1 + this.getGearPower()) * this.state.prestigePoints * 15;
                if (myPower >= loc.bossHp / 5) {
                    this.state.bossDefeated.push(loc.id);
                    const reward = loc.bossHp * 2;
                    this.state.gold += reward;
                    alert(`–ü–û–ë–ï–î–ê! ${loc.boss} –ø–æ–≤–µ—Ä–∂–µ–Ω! –ù–∞–≥—Ä–∞–¥–∞: ${reward} ü™ô`);
                    
                    const nextLoc = DB.locations[DB.locations.indexOf(loc) + 1];
                    if (nextLoc) this.state.unlockedLocs.push(nextLoc.id);
                } else {
                    alert(`–°–ª–∏—à–∫–æ–º —Å–ª–∞–±! –¢–≤–æ—è –º–æ—â—å: ${Math.floor(myPower)}. –ù—É–∂–Ω–æ: ${loc.bossHp/5}`);
                }
                this.renderMap();
            },

            // --- –†–ï–ù–î–ï–†–ò–ù–ì ---
            renderMap() {
                const container = document.getElementById('world-map');
                if (!container) return;
                container.innerHTML = DB.locations.map(loc => {
                    const isLocked = this.state.lvl < loc.lvl && !this.state.unlockedLocs.includes(loc.id);
                    const progress = this.state.locationProgress[loc.id] || 0;
                    const isBossTime = progress >= 50 && !this.state.bossDefeated.includes(loc.id);
                    
                    return `
                    <div class="card ${isBossTime ? 'boss-card' : ''}" onclick="game.handleLocClick('${loc.id}', event)">
                        <div class="icon">${isBossTime ? 'üëπ' : loc.icon}</div>
                        <div class="info">
                            <h3>${isBossTime ? '–ë–û–°–°: ' + loc.boss : loc.name}</h3>
                            <p>${isBossTime ? '–ù—É–∂–Ω–∞ –º–æ—â—å –¥–ª—è –ø–æ–±–µ–¥—ã!' : '–ú–∏–Ω. —É—Ä–æ–≤–µ–Ω—å: ' + loc.lvl}</p>
                            ${!isLocked ? `<div class="xp-container" style="height:4px; margin-top:5px;"><div class="xp-bar" style="width:${Math.min(100, (progress/50)*100)}%"></div></div>` : ''}
                        </div>
                        ${isLocked ? `<div class="lock-overlay">üîí –£–†. ${loc.lvl}</div>` : ''}
                        <button class="btn">${isBossTime ? '–ë–ò–¢–í–ê' : '–û–•–û–¢–ê'}</button>
                    </div>`;
                }).join('');
            },

            renderGear() {
                const container = document.getElementById('gear-list');
                container.innerHTML = DB.gear.map(item => {
                    const owned = this.state.inventory.includes(item.id);
                    return `
                    <div class="card" style="opacity: ${owned ? 0.6 : 1}">
                        <div class="icon">${item.icon}</div>
                        <div class="info">
                            <h3>${item.name}</h3>
                            <p>–°–∏–ª–∞: +${item.power}</p>
                        </div>
                        <button class="btn" ${owned ? 'disabled' : ''} onclick="game.buyGear('${item.id}')">
                            ${owned ? '–ö–£–ü–õ–ï–ù–û' : item.price + ' ü™ô'}
                        </button>
                    </div>`;
                }).join('');
            },

            renderShop() {
                const container = document.getElementById('shop-list');
                container.innerHTML = DB.workers.map(w => {
                    const count = this.state.workers[w.id] || 0;
                    const cost = Math.floor(w.price * Math.pow(1.15, count));
                    return `
                    <div class="card">
                        <div class="icon">${w.icon}</div>
                        <div class="info">
                            <h3>${w.name}</h3>
                            <p>–î–æ—Ö–æ–¥: ${w.income}/—Å–µ–∫ (–£ –≤–∞—Å: ${count})</p>
                        </div>
                        <button class="btn" onclick="game.hireWorker('${w.id}')">${cost} ü™ô</button>
                    </div>`;
                }).join('');
            },

            // --- –°–ò–°–¢–ï–ú–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
            addXp(amount) {
                this.state.xp += amount;
                while (this.state.xp >= this.state.xpNeed) {
                    this.state.lvl++;
                    this.state.xp -= this.state.xpNeed;
                    this.state.xpNeed = Math.floor(this.state.xpNeed * 1.4);
                    this.showFloat({clientX: window.innerWidth/2, clientY: 100}, "–£–†–û–í–ï–ù–¨ –ü–û–í–´–®–ï–ù!", "var(--gold)");
                }
            },

            tick() {
                let income = 0;
                for (let id in this.state.workers) {
                    const worker = DB.workers.find(w => w.id === id);
                    if (worker) income += worker.income * this.state.workers[id];
                }
                if (income > 0) {
                    this.state.gold += (income * this.state.prestigePoints) / 10; // –î—Ä–æ–±–Ω—ã–π —Ç–∏–∫ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ (–≤—ã–∑–æ–≤ 1 —Ä–∞–∑ –≤ —Å–µ–∫)
                    this.state.gold += (income * this.state.prestigePoints);
                    this.updateUI();
                    this.save();
                }
            },

            buyGear(id) {
                const item = DB.gear.find(i => i.id === id);
                if (this.state.gold >= item.price && !this.state.inventory.includes(id)) {
                    this.state.gold -= item.price;
                    this.state.inventory.push(id);
                    this.renderGear();
                    this.updateUI();
                    this.save();
                }
            },

            hireWorker(id) {
                const worker = DB.workers.find(w => w.id === id);
                const count = this.state.workers[id] || 0;
                const cost = Math.floor(worker.price * Math.pow(1.15, count));
                if (this.state.gold >= cost) {
                    this.state.gold -= cost;
                    this.state.workers[id] = count + 1;
                    this.renderShop();
                    this.updateUI();
                    this.save();
                }
            },

            getGearPower() {
                return this.state.inventory.reduce((sum, id) => {
                    const item = DB.gear.find(i => i.id === id);
                    return sum + (item ? item.power : 0);
                }, 0);
            },

            updateUI() {
                document.getElementById('ui-gold').innerText = Math.floor(this.state.gold);
                document.getElementById('ui-lvl').innerText = this.state.lvl;
                document.getElementById('ui-xp').style.width = (this.state.xp / this.state.xpNeed * 100) + "%";
                document.getElementById('ui-power').innerText = (1 + this.getGearPower());
                document.getElementById('ui-mult').innerText = this.state.prestigePoints;
                
                let income = 0;
                for (let id in this.state.workers) {
                    const w = DB.workers.find(x => x.id === id);
                    if(w) income += w.income * this.state.workers[id];
                }
                document.getElementById('ui-auto').innerText = Math.floor(income * this.state.prestigePoints);
            },

            showPrestige() {
                if (this.state.lvl < 20) return alert("–ù—É–∂–µ–Ω 20 —É—Ä–æ–≤–µ–Ω—å –¥–ª—è –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è!");
                if (confirm("–í–æ–∑—Ä–æ–¥–∏—Ç—å—Å—è? –í—ã –ø–æ—Ç–µ—Ä—è–µ—Ç–µ –≤—Å—ë, –Ω–æ –ø–æ–ª—É—á–∏—Ç–µ –º–Ω–æ–∂–∏—Ç–µ–ª—å —Å–∏–ª—ã x1.5 –Ω–∞–≤—Å–µ–≥–¥–∞!")) {
                    const newMult = this.state.prestigePoints + 0.5;
                    this.state = {
                        gold: 0, lvl: 1, xp: 0, xpNeed: 100, inventory: [], workers: {},
                        unlockedLocs: ['forest'], locationProgress: {}, bossDefeated: [],
                        prestigePoints: newMult
                    };
                    this.save();
                    location.reload();
                }
            },

            switchTab(id, el) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('tab-' + id).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
                if (id === 'battle') this.renderMap();
            },

            save() { localStorage.setItem('WAR_SAGA_REBORN_V1', JSON.stringify(this.state)); },

            showFloat(e, text, color = null) {
                const el = document.createElement('div');
                el.className = 'float-text';
                el.innerText = text;
                if(color) el.style.color = color;
                const x = e.clientX || window.innerWidth / 2;
                const y = e.clientY || window.innerHeight / 2;
                el.style.left = x + 'px'; el.style.top = y + 'px';
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 800);
            }
        };

        window.onload = () => game.init();
    </script>
</body>
</html>
