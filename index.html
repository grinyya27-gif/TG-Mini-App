<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Средневековая RPG</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
        <script src="usersStore.js"></script>

    <!-- Google Fonts: Cinzel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0f0f10;
            --bg-panel: #1a1a1d;
            --accent-gold: #c8aa6e;
            --text-muted: #a0a0a0;
            --text-light: #e0e0e0;
            --border-color: #3e3e42;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-family: 'Lato', sans-serif;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        h1, h2, h3, .medieval-font {
            font-family: 'Cinzel', serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 2px;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* UI Panel Style */
        .panel {
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* Button Styles */
        .btn-medieval {
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            text-transform: uppercase;
            font-family: 'Cinzel', serif;
            letter-spacing: 1px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .btn-medieval:hover {
            background: rgba(0,0,0,0.5);
            box-shadow: 0 4px 12px rgba(200, 170, 110, 0.3);
        }
        .btn-ghost {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            text-transform: uppercase;
            font-family: 'Cinzel', serif;
            letter-spacing: 1px;
            transition: all 0.2s;
            backdrop-filter: blur(4px);
        }
        .btn-ghost:hover {
            background: rgba(0,0,0,0.5);
        }

        .btn-medieval:active {
            transform: scale(0.98);
            background: #c8aa6e;
            color: #000;
        }
        
        .btn-medieval:disabled {
            border-color: #555;
            color: #555;
            opacity: 0.7;
            pointer-events: none;
        }
        
        /* Tab Styles */
        .sub-tab {
            white-space: nowrap;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            color: #777;
            border: 1px solid rgba(200, 170, 110, 0.2);
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
            transition: all 0.2s;
        }
        .sub-tab:hover {
            background: rgba(0,0,0,0.4);
            border-color: rgba(200, 170, 110, 0.4);
        }
        .sub-tab.active {
            color: var(--accent-gold);
            border-color: var(--accent-gold);
            background: rgba(200, 170, 110, 0.15);
        }

        /* Progress Bar */
        .progress-container {
            background-color: #000;
            border: 1px solid #333;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b733d, #c8aa6e);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Bottom Nav Active State */
        .nav-item.active {
            color: var(--accent-gold);
            border-top: 2px solid var(--accent-gold);
        }

        /* Animations */
        @keyframes floatText {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-30px); opacity: 0; }
        }
        .floating-text {
            position: absolute;
            animation: floatText 1s ease-out forwards;
            pointer-events: none;
            font-weight: bold;
            color: var(--accent-gold);
            text-shadow: 1px 1px 0 #000;
            z-index: 50;
        }
        
        /* Grid background pattern */
        .bg-pattern {
            background-image: radial-gradient(#2a2a2e 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.1;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.95) 0%, 
                rgba(20, 20, 25, 0.95) 50%, 
                rgba(0, 0, 0, 0.95) 100%);
            backdrop-filter: blur(12px);
            border: 1px solid var(--accent-gold);
            width: 90%;
            max-width: 320px;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 0 30px rgba(200, 170, 110, 0.3);
        }
        .modal-overlay.open .modal-content {
            transform: scale(1);
        }

        /* Job Button Enhanced */
        .job-button {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.5) 0%, 
                rgba(20, 20, 25, 0.6) 50%, 
                rgba(0, 0, 0, 0.5) 100%);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(200, 170, 110, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .job-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(200, 170, 110, 0.15), 
                transparent);
            transition: left 0.6s ease;
        }
        
        .job-button:hover {
            background: linear-gradient(135deg, 
                rgba(10, 10, 15, 0.6) 0%, 
                rgba(30, 30, 35, 0.7) 50%, 
                rgba(10, 10, 15, 0.6) 100%);
            border-color: rgba(200, 170, 110, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(200, 170, 110, 0.25);
        }
        
        .job-button:hover::before {
            left: 100%;
        }
        
        .job-button:active {
            transform: translateY(0);
            background: linear-gradient(135deg, 
                rgba(200, 170, 110, 0.2) 0%, 
                rgba(200, 170, 110, 0.3) 50%, 
                rgba(200, 170, 110, 0.2) 100%);
        }
        
        .job-button:disabled {
            background: linear-gradient(135deg, 
                rgba(26, 26, 29, 0.3) 0%, 
                rgba(42, 42, 46, 0.3) 50%, 
                rgba(26, 26, 29, 0.3) 100%);
            border-color: rgba(85, 85, 85, 0.3);
            opacity: 0.5;
        }
        
        /* Universal Card Styles - Beautiful Gradients */
        .quest-card,
        .recipe-card,
        .market-item-card {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.5) 0%, 
                rgba(20, 20, 25, 0.6) 50%, 
                rgba(0, 0, 0, 0.5) 100%);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(200, 170, 110, 0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .quest-card::before,
        .recipe-card::before,
        .market-item-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(200, 170, 110, 0.15), 
                transparent);
            transition: left 0.6s ease;
        }
        
        .quest-card:hover::before,
        .recipe-card:hover::before,
        .market-item-card:hover::before {
            left: 100%;
        }
        
        .quest-card:hover,
        .recipe-card:hover,
        .market-item-card:hover {
            background: linear-gradient(135deg, 
                rgba(10, 10, 15, 0.6) 0%, 
                rgba(30, 30, 35, 0.7) 50%, 
                rgba(10, 10, 15, 0.6) 100%);
            border-color: rgba(200, 170, 110, 0.5);
            box-shadow: 0 6px 16px rgba(200, 170, 110, 0.25);
            transform: translateY(-2px);
        }

        /* Job Button Enhanced */

        /* Gem Price Color */
        .gem-price {
            color: #34d399 !important;
        }
        
        /* Resource Cards - Beautiful gradient style */
        .resource-card {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.5) 0%, 
                rgba(20, 20, 25, 0.6) 50%, 
                rgba(0, 0, 0, 0.5) 100%);
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .resource-card:hover {
            background: linear-gradient(135deg, 
                rgba(10, 10, 15, 0.6) 0%, 
                rgba(30, 30, 35, 0.7) 50%, 
                rgba(10, 10, 15, 0.6) 100%);
            box-shadow: 0 6px 16px rgba(200, 170, 110, 0.25);
            transform: translateY(-2px);
        }
        
        /* NPC Cards - Enhanced with gradient */
        .npc-card {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.6) 0%, 
                rgba(25, 25, 30, 0.7) 50%, 
                rgba(0, 0, 0, 0.6) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(200, 170, 110, 0.3);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .npc-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(200, 170, 110, 0.1), 
                transparent);
            transition: left 0.6s ease;
        }
        
        .npc-card:hover::before {
            left: 100%;
        }
        
        .npc-card:hover {
            background: linear-gradient(135deg, 
                rgba(15, 15, 20, 0.7) 0%, 
                rgba(35, 35, 40, 0.8) 50%, 
                rgba(15, 15, 20, 0.7) 100%);
            border-color: rgba(200, 170, 110, 0.5);
            box-shadow: 0 6px 16px rgba(200, 170, 110, 0.3);
        }

        /* Developer Panel Styles */
        .dev-panel-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(8px);
            z-index: 200;
            display: none;
            overflow-y: auto;
        }
        .dev-panel-overlay.open {
            display: block;
        }
        .dev-panel-content {
            background: linear-gradient(135deg, #1a1a1d 0%, #2a1a2a 100%);
            border: 2px solid #ff00ff;
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.4);
            margin: 20px auto;
            max-width: 800px;
            border-radius: 8px;
        }
        .dev-search-input {
            background: #0f0f10;
            border: 1px solid #ff00ff;
            color: #e0e0e0;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            width: 100%;
            font-family: monospace;
        }
        .dev-search-input:focus {
            outline: none;
            border-color: #c8aa6e;
            box-shadow: 0 0 10px rgba(200, 170, 110, 0.3);
        }
        .dev-player-card {
            background: #1a1a1d;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
            cursor: pointer;
        }
        .dev-player-card:hover {
            border-color: #ff00ff;
            background: #2a1a2a;
            transform: translateX(4px);
        }
        .dev-stat-input {
            background: #0f0f10;
            border: 1px solid #3e3e42;
            color: #e0e0e0;
            padding: 0.4rem 0.75rem;
            border-radius: 4px;
            width: 100%;
            font-family: monospace;
        }
        .dev-stat-input:focus {
            outline: none;
            border-color: #c8aa6e;
        }
        .dev-btn {
            background: linear-gradient(to bottom, #ff00ff, #8b008b);
            border: 1px solid #ff00ff;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .dev-btn:hover {
            background: linear-gradient(to bottom, #ff44ff, #aa00aa);
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.5);
        }
        .dev-btn:active {
            transform: scale(0.98);
        }
        .game-title-secret {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }
        .game-title-secret:active {
            color: #ff00ff;
        }

        /* Level Up Modal Animations */
        .levelup-card {
            border: 1px solid rgba(200, 170, 110, 0.6);
            background: radial-gradient(circle at top, rgba(200, 170, 110, 0.15), transparent 60%), #1a1a1d;
            box-shadow: 0 0 30px rgba(200, 170, 110, 0.2), inset 0 0 20px rgba(0,0,0,0.6);
            animation: levelPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) both;
        }
        .levelup-glow {
            animation: levelGlow 2.5s ease-in-out infinite;
        }
        @keyframes levelPop {
            0% { transform: scale(0.7); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes levelGlow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }

        /* Wheel Animation */
        .wheel-container {
            transition: transform 3s cubic-bezier(0.1, 0.7, 0.1, 1);
        }
        .spin-anim {
            animation: wheelSpin 1.5s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
        }
        @keyframes wheelSpin {
            0% { 
                transform: rotate(0deg);
            }
            100% { 
                transform: rotate(1080deg);
            }
        }
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        /* Witcher-style image filter */
        .witcher-img {
            filter: contrast(1.1) saturate(0.85) sepia(0.15) brightness(0.9);
        }
        .location-bg {
            background-size: cover;
            background-position: center;
            filter: contrast(1.15) saturate(0.7) sepia(0.2) brightness(0.6);
        }

        /* Location hero image (inside location headers) */
        .loc-hero {
            position: relative;
            isolation: isolate;
        }
        .loc-hero::before {
            content: "";
            position: absolute;
            inset: 0;
            background-image: var(--hero-img);
            background-size: cover;
            background-position: center;
            opacity: 0.35;
            filter: contrast(1.1) saturate(0.85) sepia(0.15) brightness(0.9);
            z-index: 0;
            pointer-events: none;
        }
        .loc-hero::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.15), rgba(0,0,0,0.45), rgba(0,0,0,0.75));
            z-index: 0;
            pointer-events: none;
        }
        /* Keep header content above the pseudo background */
        .loc-hero > * {
            z-index: 1;
        }
        /* Don't break Tailwind's .absolute positioning */
        .loc-hero > *:not(.absolute) {
            position: relative;
        }

        /* Unconscious State */
        body.unconscious header,
        body.unconscious #app-container,
        body.unconscious nav {
            pointer-events: none;
            filter: grayscale(0.7) brightness(0.6);
        }

        /* Small square icon buttons */
        .icon-tile {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            border: 1px solid #333;
            background: rgba(0,0,0,0.35);
            color: #a0a0a0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .icon-tile:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
            background: rgba(200,170,110,0.12);
        }

        /* Inventory item tiles */
        .inv-item {
            cursor: pointer;
            transition: transform 0.15s ease, border-color 0.15s ease;
        }
        .inv-item:hover {
            border-color: rgba(200,170,110,0.9);
            transform: translateY(-1px);
        }

        /* SVG Icon styling */
        .icon-svg {
            width: 1em;
            height: 1em;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            display: inline-block;
            vertical-align: middle;
        }
        
        .icon-svg-fill {
            width: 1em;
            height: 1em;
            fill: currentColor;
            display: inline-block;
            vertical-align: middle;
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC6aLcnMowI8x2kkauzJl_xaTS4RIWbbao",
            authDomain: "medieval-legacy.firebaseapp.com",
            projectId: "medieval-legacy",
            storageBucket: "medieval-legacy.firebasestorage.app",
            messagingSenderId: "858324582839",
            appId: "1:858324582839:web:4ade80dc6f0301ea552832",
            measurementId: "G-Q420MSR85C"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Telegram WebApp initialization
        let tgUser = null;
        let tgUserId = null;
        let tgUsername = null;
        
        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                tgUser = tg.initDataUnsafe.user;
                tgUserId = tgUser.id;
                tgUsername = tgUser.username || tgUser.first_name || 'Player';
            }
        }
        
        // If not in Telegram, use fallback ID
        if (!tgUserId) {
            tgUserId = 'local_' + (localStorage.getItem('fallback_id') || Date.now());
            if (!localStorage.getItem('fallback_id')) {
                localStorage.setItem('fallback_id', tgUserId);
            }
            tgUsername = 'Local Player';
        }
    </script>

</head>
<body class="h-screen flex flex-col relative" style="overflow: hidden; -webkit-tap-highlight-color: transparent;">

    <!-- Background Pattern -->
    <div class="absolute inset-0 bg-pattern pointer-events-none"></div>

    <!-- Inline SVG Icon Sprite (Solid Style) -->
    <svg aria-hidden="true" style="position:absolute; width:0; height:0; overflow:hidden">
        <!-- Fishing rod (Solid) -->
        <symbol id="icon-rod" viewBox="0 0 512.01 512.01">
            <path fill="currentColor" d="M501.338,0c-2.954,0-5.624,1.201-7.555,3.138l-306.21,306.201l-7.537-7.536c-4.167-4.167-10.917-4.167-15.084,0
                L9.365,457.385c-12.48,12.479-12.48,32.771,0,45.25c6.042,6.042,14.084,9.375,22.626,9.375c8.563,0,16.605-3.333,22.647-9.375
                l94.929-94.939c1.275,34.177,29.28,61.637,63.764,61.637c35.293,0,64.002-28.708,64.002-64c0-2.568-0.253-52.451-18.031-100.676
                c7.673,2.77,15.442,4.499,23.281,4.499c19.938,0,40.126-8.948,59.127-26.802c20.521-19.302,31.834-42.813,31.834-66.198
                c0-9.033-1.938-17.672-5.259-25.875c29.661-1.863,65.583-22.423,87.262-44.073c13.625-13.615,25.688-31.437,35.126-50.917V480
                c0,5.885-4.792,10.667-10.667,10.667c-5.875,0-10.667-4.781-10.667-10.667v-42.667c0-4.313-2.604-8.208-6.583-9.854
                c-3.938-1.667-8.584-0.75-11.625,2.313l-10.667,10.667c-4.167,4.167-4.167,10.917,0,15.083c2.083,2.083,4.813,3.125,7.542,3.125
                V480c0,17.646,14.355,32,32.001,32s32.001-14.354,32.001-32V10.667C512.005,4.771,507.234,0,501.338,0z M232.033,295.056
                c9.19,19.033,14.909,39.885,18.392,58.316c-10.486-7.508-23.234-12.039-37.086-12.039c-0.124,0-0.238,0.035-0.362,0.036
                c0.595-3.319-0.197-6.835-2.763-9.401l-7.547-7.547L232.033,295.056z M39.568,487.552c-4.042,4.021-11.062,4.021-15.104,0
                c-4.167-4.156-4.167-10.927,0-15.083l148.042-148.042l15.083,15.083L39.568,487.552z M256.005,405.335
                c0,23.531-19.146,42.665-42.667,42.665c-23.521,0-42.667-19.135-42.667-42.667s19.146-42.667,42.667-42.667
                c23.521,0,42.667,19.134,42.667,42.665V405.335z M327.089,266.813c-25.967,24.419-51.576,27.504-76.273,9.461l90.527-90.527
                c7.138,9.128,10.871,19.294,10.871,30.41C352.214,233.344,343.047,251.802,327.089,266.813z M440.464,131.125
                c-22.458,22.448-56.5,39.438-77.563,38.198c-1.651-0.082-2.87-0.555-4.279-0.857L487.415,39.673
                C480.514,73.357,462.926,108.663,440.464,131.125z"/>
        </symbol>
        <!-- Sickle (Solid) -->
        <symbol id="icon-sickle" viewBox="0 0 512.001 512.001">
            <path fill="currentColor" d="M493.88,172.132c-11.966-27.852-29.753-54.467-53.123-77.837c-20.514-20.513-43.529-36.701-67.679-48.422
                c-24.152-11.72-49.443-18.984-74.56-21.615c-8.168-0.855-15.781,4.398-17.879,12.34c-2.098,7.941,1.925,16.268,9.45,19.561
                c20.029,8.765,39.283,21.197,56.228,38.138c17.17,17.168,30.153,36.558,38.812,56.47c8.665,19.911,12.982,40.328,12.977,59.482
                c0,14.302-2.392,27.887-7.089,40.181c-4.706,12.302-11.68,23.327-21.09,32.746c-9.419,9.41-20.444,16.384-32.745,21.09
                c-12.294,4.697-25.879,7.089-40.181,7.089c-19.154,0.006-39.571-4.313-59.482-12.977c-19.912-8.659-39.304-21.642-56.47-38.812
                c-6.52-6.52-17.09-6.52-23.61,0l-0.001,0.001l-16.982,16.982c-0.028,0.029-0.057,0.056-0.085,0.085L14.665,402.336
                c-5.003,4.998-8.718,10.862-11.122,17.011c-2.411,6.156-3.542,12.59-3.543,18.938c-0.003,12.884,5.23,25.454,14.665,34.881
                c4.856,4.858,10.537,8.554,16.577,11.001c6.043,2.45,12.444,3.668,18.838,3.668c6.394,0,12.795-1.219,18.838-3.668
                c6.04-2.446,11.721-6.141,16.577-11.001L193.241,365.42c20.266,17.818,42.526,31.774,65.645,41.707
                c27.853,11.961,56.96,18.117,85.367,18.122c22.37,0,44.319-3.831,64.749-11.721c20.423-7.882,39.315-19.856,55.365-35.914
                c16.058-16.051,28.032-34.943,35.914-55.366c7.89-20.43,11.721-42.379,11.721-64.749C511.998,229.092,505.842,199.987,493.88,172.132z"/>
        </symbol>
        <!-- Pickaxe (Solid) -->
        <symbol id="icon-pickaxe" viewBox="0 0 512 512">
            <path fill="currentColor" d="m510.367 288.035c-3.353-30.175-11.837-60.012-25.217-88.684-10.683-22.893-24.535-45.057-41.34-66.254l15.519-15.519c17.595-17.594 17.595-46.222.003-63.813l-1.105-1.105c-17.594-17.595-46.223-17.595-63.816 0l-15.519 15.519c-21.198-16.805-43.362-30.657-66.253-41.34-28.672-13.38-58.51-21.864-88.685-25.217-51.852-5.761-86.883 5.653-88.349 6.141-6.979 2.327-11.241 9.372-10.063 16.633 1.179 7.262 7.45 12.597 14.807 12.597.188 0 19.737.413 54.188 15.177 27.799 11.914 69.458 35.183 120.292 80.073l-301.624 301.62c-17.592 17.594-17.592 46.222.003 63.818l1.104 1.103c8.523 8.521 19.854 13.214 31.906 13.214 12.054 0 23.385-4.694 31.907-13.217l301.62-301.62c43.911 49.732 67.034 90.578 79.032 117.892 15.284 34.792 16.178 55.393 16.218 56.65-.091 7.375 5.199 13.604 12.477 14.846.832.142 1.661.21 2.481.21 6.376 0 12.199-4.154 14.273-10.376.488-1.465 11.902-36.5 6.141-88.348zm-140.883-145.531c-58.841-58.841-109.467-92.14-148.058-110.978.253.029.507.059.761.088 61.215 7.206 118.34 36.947 169.79 88.396 51.449 51.45 81.19 108.575 88.396 169.79.03.254.06.508.089.761-18.838-38.59-52.136-89.216-110.978-148.057zm46.139-68.632c2.949-2.949 6.823-4.423 10.696-4.423 3.872 0 7.745 1.474 10.691 4.421l1.105 1.105c5.897 5.897 5.897 15.493 0 21.39l-13.895 13.895c-3.575-3.858-7.25-7.681-11.031-11.462s-7.604-7.456-11.462-11.031zm-358.712 403.697c-2.855 2.856-6.653 4.429-10.693 4.429s-7.839-1.573-10.695-4.43c-.001-.001-.001-.002-.002-.002l-1.101-1.1c-5.897-5.897-5.897-15.494-.001-21.391l302.489-302.489c3.748 3.599 7.533 7.299 11.364 11.13 3.83 3.83 7.532 7.616 11.13 11.363z"/>
        </symbol>
        <!-- Crossbow (Solid) -->
        <symbol id="icon-crossbow" viewBox="0 0 512.001 512.001">
            <path fill="currentColor" d="M477.227,238.166h-0.256c-40.395-70.524-112.067-117.492-192.853-126.379l16.043-16.043 c5.137-5.156,6.439-13.003,3.243-19.541L270.806,8.534c-3.076-5.328-8.781-8.588-14.933-8.533 c-6.389-0.013-12.25,3.543-15.189,9.216l-32.427,66.987c-3.175,6.556-1.838,14.405,3.328,19.541l16.043,16.043 c-80.786,8.887-152.458,55.854-192.853,126.379c-18.851-0.212-34.305,14.898-34.517,33.749 c-0.212,18.851,14.898,34.305,33.749,34.517h8.533c2.335-0.006,4.66-0.322,6.912-0.939v0.768l146.688,33.365v44.373 c-0.13,0.763-0.13,1.542,0,2.304l17.067,60.928c1.988,7.682,9.148,12.872,17.067,12.373v35.328 c0,9.426,7.641,17.067,17.067,17.067h17.067c9.426,0,17.067-7.641,17.067-17.067v-35.328c7.605,0.09,14.293-5.014,16.213-12.373 l17.067-60.928c0.421-0.71,0.711-1.491,0.853-2.304v-44.373l146.944-33.365v-0.768c2.253,0.617,4.577,0.932,6.912,0.939h8.533 c18.851-0.212,33.961-15.666,33.749-34.517S496.078,237.954,477.227,238.166z M230.272,442.539l-17.067-59.733V281.601h17.067 V442.539z M230.272,264.534h-17.067c-9.426,0-17.067,7.641-17.067,17.067v40.533L65.323,292.353c0-0.597,0.597-1.109,0.853-1.707 c27.477-69.151,90.299-117.958,164.096-127.488V264.534z M298.539,382.806l-17.067,59.733V281.601h17.067V382.806z M315.606,322.134v-40.533c0-9.426-7.641-17.067-17.067-17.067h-17.067V163.158c73.761,9.617,136.544,58.394,164.096,127.488 c0,0.597,0.597,1.195,0.853,1.707L315.606,322.134z"/>
        </symbol>
        <!-- Leather (Solid) -->
        <symbol id="icon-leather" viewBox="0 0 467.473 467.473">
            <path fill="currentColor" d="m424.392,374.451c-26.765-30.588-42.326-69.803-43.816-110.419-1.49-40.617 11.154-80.866 35.605-113.334l5.488-7.288c2.328-3.091 2.663-7.249 0.861-10.673l-31.849-60.513c-1.729-3.286-5.136-5.343-8.849-5.343h-18.875c-28.06,0-53.333-16.665-64.386-42.456l-7.871-18.365c-1.575-3.676-5.19-6.06-9.19-6.06h-95.546c-4,0-7.616,2.384-9.191,6.061l-7.871,18.365c-11.053,25.791-36.327,42.456-64.386,42.456h-18.875c-3.713,0-7.12,2.057-8.849,5.343l-31.849,60.513c-1.802,3.424-1.467,7.582 0.861,10.673l5.488,7.288c24.451,32.468 37.096,72.717 35.605,113.334-1.49,40.617-17.051,79.831-43.816,110.419-2.784,3.182-3.266,7.772-1.204,11.463l30.256,54.143c2.148,3.844 6.56,5.829 10.861,4.892l12.05-2.629c46.118-10.062 93.472-1.681 133.336,23.599 1.635,1.037 3.495,1.555 5.355,1.555s3.721-0.519 5.355-1.555c39.864-25.28 87.216-33.66 133.336-23.599l12.05,2.629c4.303,0.939 8.713-1.047 10.861-4.892l30.256-54.143c2.065-3.692 1.583-8.282-1.201-11.464zm-42.894,49.377l-4.806-1.048c-49.248-10.746-99.763-2.582-142.955,22.967-30.778-18.206-65.269-27.583-100.374-27.583-14.161,0-28.427,1.527-42.582,4.615l-4.806,1.048-23.265-41.633c26.974-33.183 42.602-74.604 44.174-117.429 1.658-45.192-12.411-89.975-39.616-126.099l-1.675-2.224 26.085-49.561h12.837c36.071,0 68.56-21.423 82.769-54.577l5.274-12.304h82.358l5.273,12.305c14.209,33.154 46.698,54.577 82.769,54.577h12.837l26.085,49.561-1.675,2.224c-27.205,36.124-41.273,80.906-39.615,126.098 1.571,42.825 17.199,84.247 44.173,117.429l-23.265,41.634z"/>
            <path fill="currentColor" d="m382.256,140.073c2.035-3.048 2.239-6.965 0.532-10.209l-12.537-23.819c-1.707-3.243-5.05-5.292-8.714-5.341-40.083-0.541-76.666-24.483-93.199-60.998-1.62-3.577-5.183-5.875-9.11-5.875h-50.981c-3.927,0-7.49,2.298-9.11,5.875-16.534,36.514-53.117,60.457-93.2,60.998-3.664,0.049-7.008,2.099-8.714,5.342l-12.536,23.819c-1.707,3.243-1.503,7.16 0.532,10.208 24.5,36.709 37.104,81.173 35.489,125.199-1.489,40.571-14.573,79.688-37.837,113.122-2.185,3.14-2.387,7.25-0.521,10.59l7.273,13.015c2.044,3.657 6.153,5.653 10.291,4.999 10.926-1.727 22.06-2.603 33.092-2.603 33.308,0 66.57,7.982 96.191,23.083 1.427,0.727 2.984,1.091 4.542,1.091s3.115-0.364 4.542-1.091c29.619-15.101 62.882-23.083 96.191-23.083 11.032,0 22.166,0.875 33.092,2.603 4.136,0.651 8.246-1.342 10.291-5l7.272-13.015c1.866-3.339 1.664-7.45-0.521-10.589-23.264-33.434-36.347-72.551-37.836-113.122-1.618-44.026 10.985-88.489 35.486-125.199zm-18.516,246.18c-9.71-1.234-19.526-1.858-29.271-1.858-34.759,0-69.475,7.944-100.733,23.012-31.26-15.068-65.975-23.012-100.733-23.012-9.745,0-19.561,0.624-29.271,1.858l-.922-1.65c23.255-35.414 36.329-76.28 37.881-118.598 1.695-46.201-10.91-92.834-35.581-132.009l7.117-13.521c21.453-1.327 42.136-8.178 60.157-19.975 17.871-11.7 32.331-27.747 42.123-46.669h38.458c9.792,18.922 24.252,34.969 42.123,46.669 18.021,11.797 38.704,18.648 60.156,19.975l7.117,13.522c-24.671,39.175-37.276,85.809-35.581,132.008 1.553,42.318 14.626,83.185 37.881,118.598l-.921,1.65z"/>
            <path fill="currentColor" d="m233.74,84.185c2.63,0 5.21-1.07 7.07-2.93s2.93-4.44 2.93-7.07c0-2.63-1.07-5.21-2.93-7.07-1.86-1.87-4.44-2.93-7.07-2.93-2.64,0-5.21,1.06-7.07,2.93-1.87,1.86-2.93,4.44-2.93,7.07 0,2.63 1.06,5.21 2.93,7.07 1.86,1.86 4.43,2.93 7.07,2.93z"/>
            <path fill="currentColor" d="m287.734,196.177h-107.995c-5.523,0-10,4.477-10,10s4.477,10 10,10h107.995c5.523,0 10-4.477 10-10s-4.477-10-10-10z"/>
            <path fill="currentColor" d="m287.734,230.675h-107.995c-5.523,0-10,4.477-10,10s4.477,10 10,10h107.995c5.523,0 10-4.477 10-10s-4.477-10-10-10z"/>
            <path fill="currentColor" d="m287.734,265.174h-107.995c-5.523,0-10,4.477-10,10s4.477,10 10,10h107.995c5.523,0 10-4.477 10-10s-4.477-10-10-10z"/>
        </symbol>
        <!-- Cloth (Solid) - new -->
        <symbol id="icon-cloth" viewBox="0 0 512.001 512.001">
            <path fill="currentColor" d="M482.166,0H165.704c-16.445,0-29.825,14.191-29.825,31.635v48.212H96.837c-16.434,0-29.803,14.18-29.803,31.61v60.574H29.814c-16.434,0-29.804,13.29-29.804,29.627v280.714c0,16.337,13.37,29.629,29.804,29.629h316.112c16.434,0,29.803-13.291,29.803-29.629v-30.173h37.219c16.434,0,29.803-14.18,29.803-31.61V372.74h39.413c16.446,0,29.826-14.191,29.826-31.635V31.635C511.992,14.191,498.613,0,482.166,0z M355.654,482.372c0,5.266-4.364,9.552-9.726,9.552H29.814c-5.364,0-9.727-4.284-9.727-9.552V201.658c0-5.265,4.364-9.55,9.727-9.55h37.219v228.48c0,17.43,13.369,31.61,29.803,31.61h258.817V482.372z M422.676,420.589c0,6.359-4.364,11.533-9.726,11.533H96.837c-5.363,0-9.726-5.174-9.726-11.533V111.458c0-6.359,4.364-11.533,9.726-11.533h39.043v241.18c0,17.444,13.379,31.635,29.825,31.635h256.972V420.589z M491.915,341.105c0,6.373-4.373,11.558-9.748,11.558H165.704c-5.375,0-9.747-5.185-9.747-11.558V31.635c0-6.373,4.373-11.558,9.747-11.558h316.462c5.375,0,9.748,5.185,9.748,11.558V341.105z"/>
            <path fill="currentColor" d="M392.074,61.312H191.302c-5.541,0-10.039,4.497-10.039,10.039c0,5.532,4.497,10.039,10.039,10.039h200.771c5.531,0,10.028-4.506,10.029-10.039C402.101,65.81,397.605,61.312,392.074,61.312z"/>
            <path fill="currentColor" d="M433.592,100.102c-5.541,0-10.039,4.496-10.039,10.029V292.1c0,5.531,4.497,10.039,10.039,10.039c5.531,0,10.039-4.508,10.039-10.039V110.141C443.63,104.599,439.124,100.102,433.592,100.102z"/>
            <path fill="currentColor" d="M432.227,81.39c5.531,0,10.027-4.506,10.027-10.039c0-5.541-4.496-10.039-10.027-10.039c-5.542,0-10.039,4.497-10.039,10.039C422.188,76.883,426.684,81.39,432.227,81.39z"/>
        </symbol>
        <!-- Sword (Solid) -->
        <!-- Shield (armor) icon -->
        <symbol id="icon-armor-generic" viewBox="0 0 512 512">
            <path fill="currentColor" d="M256 0c4.6 0 9.2 1 13.4 2.9L457.7 82.8c22 9.3 38.4 31 38.3 57.2c-.5 99.2-41.3 280.7-213.7 363.2c-16.7 8-36.1 8-52.8 0C57.3 420.7 16.5 239.2 16 140c-.1-26.2 16.3-47.9 38.3-57.2L242.7 2.9C246.8 1 251.4 0 256 0zm0 66.8V444.8C394 378 431.1 230.1 432 141.4L256 66.8z"/>
        </symbol>
        <symbol id="icon-sword-generic" viewBox="0 0 512.001 512.001">
            <path fill="currentColor" d="M507.606,4.394c-3.339-3.339-8.055-4.909-12.728-4.243L346.387,21.364c-3.688,0.527-7.047,2.406-9.425,5.273 L139.321,264.938c-16.353-7.263-36.394-4.357-50.074,9.323l-21.213,21.213c-5.854,5.854-5.857,15.356,0,21.213l31.82,31.82 l-48.64,48.64H45c-24.813,0-45,20.187-45,45V467c0,24.813,20.187,45,45,45h24.853c24.813,0,45-20.187,45-45v-6.213l48.639-48.64 l31.82,31.82c5.854,5.854,15.356,5.857,21.213,0l21.212-21.213c13.638-13.638,16.611-33.666,9.323-50.075l238.302-197.641 c2.866-2.378,4.746-5.737,5.273-9.425L511.85,17.121C512.517,12.447,510.945,7.732,507.606,4.394z M84.853,467 c0,8.271-6.729,15-15,15H45c-8.271,0-15-6.729-15-15v-24.853c0-8.271,6.729-15,15-15h6.213l33.64,33.64V467z M99.853,433.36 L78.64,412.147l42.426-42.426l21.213,21.213L99.853,433.36z M216.525,401.54l-10.606,10.606L99.853,306.081l10.607-10.606 c5.863-5.863,15.349-5.863,21.213,0l84.853,84.853C222.388,386.191,222.388,395.677,216.525,401.54z M461.757,155.642 L228.075,349.451l-22.156-22.157l174.408-174.408c5.858-5.858,5.858-15.355,0-21.213c-5.857-5.858-15.355-5.858-21.213,0 L184.706,306.081l-22.156-22.156L356.358,50.244l122.964-17.566L461.757,155.642z"/>
        </symbol>
        <!-- Mushroom (Solid) -->
        <symbol id="icon-mushroom" viewBox="0 0 330.18 330.18">
            <g>
                <path fill="currentColor" d="M165.09,0C88.446,0,26.316,57.804,26.316,129.108c0,4.096,0.214,34.958,0.615,38.957c0,0,4.17,17.875,138.159,17.875 c135.583,0,138.158-17.875,138.158-17.875c0.4-4,0.615-34.861,0.615-38.957C303.863,57.804,241.732,0,165.09,0z M121.426,41.466 c-11.932,2.803-23.274,8.827-33.276,17.01c-23.177,18.962-32.125,46.485-29.974,75.899c0.542,7.416-10.981,7.363-11.52,0 c-2.307-31.545,7.718-63.076,32.705-83.519c11.18-9.146,24.783-17.158,39.002-20.498 C125.59,28.661,128.656,39.768,121.426,41.466z"/>
                <path fill="currentColor" d="M206.987,194.845c-13.836,0.513-25.226,0.775-41.898,0.775c-14.889,0-26.655-0.226-41.896-0.817L109.045,316.47 c-0.494,7.54,5.284,13.71,12.841,13.71h86.407c7.557,0,13.336-6.17,12.84-13.71L206.987,194.845z"/>
            </g>
        </symbol>
    </svg>

    <!-- Intro Modal (Arthur) -->
    <div id="modal-intro" class="modal-overlay">
        <div class="modal-content rounded-lg p-6 relative overflow-hidden text-left">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[#c8aa6e] to-transparent"></div>

            <div class="flex items-center gap-4 mb-4">
                <div class="w-14 h-14 rounded-full border-2 border-[#c8aa6e] bg-[#222] flex items-center justify-center overflow-hidden">
                    <img src="https://i.postimg.cc/Y9Yn3XLD/IMG-4611.png" alt="Артур" class="w-full h-full object-cover object-top">
                </div>
                <div>
                    <h2 class="medieval-font text-xl text-[#c8aa6e] leading-tight">Артур</h2>
                    <p class="text-[10px] text-[#777]">Травник</p>
                </div>
            </div>
            
            
            
            

            <div class="space-y-3 text-sm text-[#e0e0e0] leading-relaxed">
                <p>Очнулся наконец? Я нашёл тебя без сознания под мостом.</p>
                <p>Привёл в дом, обмыл, перевязал… и вылечил. Повезло тебе.</p>
                <p class="text-[#a0a0a0]">Совет на первое время: сходи на <span class="text-[#c8aa6e] font-bold">Городскую площадь</span> и попроси милостыню. Накопишь — купи <span class="text-[#c8aa6e] font-bold">удочку</span> на рынке. С неё и начнёшь вставать на ноги.</p>
            </div>

            <div class="mt-6 grid grid-cols-2 gap-2">
                <button onclick="game.closeIntro(false)" class="btn-medieval w-full py-2 rounded font-bold text-xs">
                    Понял
                </button>
                <button onclick="game.closeIntro(true)" class="btn-medieval w-full py-2 rounded font-bold text-xs">
                    На площадь
                </button>
            </div>
        </div>
    </div>

    <!-- Level Up Modal -->
    <div id="modal-levelup" class="modal-overlay">
        <div class="modal-content levelup-card rounded-lg p-6 text-center relative overflow-hidden">
            <div class="absolute inset-0 bg-[radial-gradient(circle_at_top,rgba(200,170,110,0.15),transparent_55%)]"></div>
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[#c8aa6e] to-transparent"></div>
            <div class="absolute inset-0 opacity-20 pointer-events-none bg-[url('https://www.transparenttextures.com/patterns/black-scales.png')]"></div>

            <div class="relative mb-4">
                <div class="levelup-glow absolute -inset-6 rounded-full bg-[#c8aa6e]/30 blur-3xl"></div>
                <i class="fas fa-crown text-5xl text-[#c8aa6e] drop-shadow-[0_0_15px_rgba(200,170,110,0.8)]"></i>
            </div>

            <h2 class="medieval-font text-2xl text-[#c8aa6e] mb-1 tracking-widest">УРОВЕНЬ ПОВЫШЕН</h2>
            <div id="levelup-new-level" class="text-5xl font-bold text-white mb-1 medieval-font drop-shadow-md">2</div>
            <div id="levelup-new-title" class="text-sm text-[#c8aa6e]/80 font-serif italic mb-4">Странник</div>

            <div class="space-y-3 mb-6">
                <div class="bg-[#111]/80 border border-[#333] rounded p-3 flex items-center justify-between backdrop-blur-sm">
                    <span class="text-xs text-[#a0a0a0] uppercase tracking-wider">Награда</span>
                    <div class="flex items-center gap-2 text-[#ffd700] font-bold text-lg">
                        +<span id="levelup-gold">100</span> <i class="fas fa-coins"></i>
                    </div>
                </div>
                <div class="bg-[#111]/80 border border-[#333] rounded p-3 flex items-center justify-between backdrop-blur-sm">
                    <span class="text-xs text-[#a0a0a0] uppercase tracking-wider">Навыки</span>
                    <div class="text-[#34d399] font-bold text-lg">+1 Жетон</div>
                </div>
                <div class="text-left bg-[#222]/80 border-l-2 border-[#c8aa6e] rounded-r p-3 backdrop-blur-sm">
                    <div class="text-[10px] text-[#c8aa6e] font-bold mb-1 uppercase tracking-widest flex items-center gap-2">
                        <i class="fas fa-scroll"></i> Новые возможности
                    </div>
                    <p id="levelup-message" class="text-xs text-[#e0e0e0] leading-relaxed">...</p>
                </div>
            </div>

            <button onclick="game.closeLevelUp()" class="btn-medieval w-full py-3 rounded font-bold text-sm tracking-wider">ПРИНЯТЬ ДАРЫ</button>
        </div>
    </div>

    <!-- Daily Reward Modal -->
    <div id="modal-daily" class="modal-overlay">
        <div class="modal-content rounded-lg p-6 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[#c8aa6e] to-transparent"></div>
            <h2 class="medieval-font text-2xl text-[#c8aa6e] mb-2">Ежедневная Награда</h2>
            <p class="text-sm text-[#a0a0a0] mb-4">С возвращением, путник!</p>
            
            <div class="flex justify-center gap-2 mb-6">
                <div id="daily-days-container" class="flex gap-1"></div>
            </div>

            <div class="mb-6">
                <i class="far fa-gem text-4xl text-emerald-400 mb-2 drop-shadow-[0_0_10px_rgba(52,211,153,0.5)]"></i>
                <div class="text-xl font-bold text-white">+<span id="daily-amount">0</span> Изумрудов</div>
            </div>

            <button onclick="game.claimDaily()" class="btn-medieval w-full py-2 rounded font-bold">
                Забрать
            </button>
        </div>
    </div>

    <!-- Lost Pouch: Treasury -->
    <div id="modal-treasury-pouch" class="modal-overlay">
        <div class="modal-content rounded-lg p-6 text-center relative overflow-hidden border-yellow-500">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-yellow-400 to-transparent"></div>
            <div class="absolute inset-0 opacity-20 pointer-events-none bg-[radial-gradient(circle_at_top,rgba(250,204,21,0.2),transparent_60%)]"></div>
            <div class="relative">
                <div class="w-16 h-16 rounded-full border border-yellow-400/60 bg-[#111] flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-sack-dollar text-3xl text-yellow-400"></i>
                </div>
                <h2 class="medieval-font text-2xl text-yellow-300 mb-2">Чужой кошель</h2>
                <p class="text-sm text-[#a0a0a0] mb-4">У входа в казну выпал мешочек с <span class="text-yellow-300 font-bold">1000 золота</span>.</p>
                <div class="panel p-3 rounded bg-black/40 border border-[#333] mb-4 text-left">
                    <div class="text-[10px] text-[#c8aa6e] uppercase tracking-widest mb-1">Выбор</div>
                    <p class="text-xs text-[#e0e0e0] leading-relaxed">Ты можешь позвать владельца и вернуть мешок — или забрать себе.</p>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="ui.resolveTreasuryPouch('return')" class="btn-medieval w-full py-2 rounded text-xs border-emerald-500 text-emerald-300">
                        Вернуть (+3 Реп.)
                    </button>
                    <button onclick="ui.resolveTreasuryPouch('keep')" class="btn-medieval w-full py-2 rounded text-xs border-red-500 text-red-300">
                        Забрать (-5 Реп.)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lost Pouch: Bookhouse -->
    <div id="modal-bookhouse-pouch" class="modal-overlay">
        <div class="modal-content rounded-lg p-6 text-center relative overflow-hidden border-emerald-500">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-emerald-400 to-transparent"></div>
            <div class="absolute inset-0 opacity-20 pointer-events-none bg-[radial-gradient(circle_at_top,rgba(52,211,153,0.2),transparent_60%)]"></div>
            <div class="relative">
                <div class="w-16 h-16 rounded-full border border-emerald-500/60 bg-[#111] flex items-center justify-center mx-auto mb-4">
                    <i class="far fa-gem text-3xl text-emerald-400"></i>
                </div>
                <h2 class="medieval-font text-2xl text-emerald-300 mb-2">Забытая шкатулка</h2>
                <p class="text-sm text-[#a0a0a0] mb-4">Между полками лежит шкатулка с <span class="text-emerald-300 font-bold">10 изумрудами</span>.</p>
                <div class="panel p-3 rounded bg-black/40 border border-[#333] mb-4 text-left">
                    <div class="text-[10px] text-[#c8aa6e] uppercase tracking-widest mb-1">Совесть</div>
                    <p class="text-xs text-[#e0e0e0] leading-relaxed">Вернёшь владельцу — заслужишь уважение. Оставишь — легко разбогатеешь.</p>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="ui.resolveBookhousePouch('return')" class="btn-medieval w-full py-2 rounded text-xs border-emerald-500 text-emerald-300">
                        Вернуть (+3 Реп.)
                    </button>
                    <button onclick="ui.resolveBookhousePouch('keep')" class="btn-medieval w-full py-2 rounded text-xs border-red-500 text-red-300">
                        Забрать (-5 Реп.)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Unconscious Modal -->
    <div id="modal-unconscious" class="modal-overlay">
        <div class="modal-content rounded-lg p-6 text-center relative overflow-hidden border-red-500">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-red-500 to-transparent"></div>
            <div class="absolute inset-0 opacity-20 pointer-events-none bg-[radial-gradient(circle_at_top,rgba(239,68,68,0.2),transparent_60%)]"></div>
            <div class="relative">
                <div class="w-16 h-16 rounded-full border border-red-500/60 bg-[#111] flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-skull-crossbones text-3xl text-red-400"></i>
                </div>
                <h2 class="medieval-font text-2xl text-red-400 mb-2">Потеря сознания</h2>
                <p class="text-sm text-[#a0a0a0] mb-4">Вы лишились сил. Мир меркнет...</p>
                <div class="panel p-3 rounded bg-black/40 border border-[#333] mb-4">
                    <div class="text-[10px] text-[#777] uppercase tracking-widest mb-1">До пробуждения</div>
                    <div id="unconscious-timer" class="text-2xl font-bold text-[#c8aa6e] medieval-font">10:00</div>
                </div>
                <p class="text-[10px] text-[#777]">После пробуждения здоровье восстановится до 15 HP.</p>
            </div>
        </div>
    </div>

    <!-- Low HP Warning Modal -->
    <div id="modal-lowhp" class="modal-overlay">
        <div class="modal-content rounded-lg p-6 text-center relative overflow-hidden border-amber-500">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-amber-400 to-transparent"></div>
            <div class="absolute inset-0 opacity-20 pointer-events-none bg-[radial-gradient(circle_at_top,rgba(251,191,36,0.2),transparent_60%)]"></div>
            <div class="relative">
                <div class="w-16 h-16 rounded-full border border-amber-500/60 bg-[#111] flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-triangle-exclamation text-3xl text-amber-400"></i>
                </div>
                <h2 class="medieval-font text-2xl text-amber-300 mb-2">Слишком слаб</h2>
                <p class="text-sm text-[#a0a0a0] mb-4">Ты можешь потерять сознание. Сил осталось совсем мало.</p>
                <div class="panel p-3 rounded bg-black/40 border border-[#333] mb-4 text-left">
                    <div class="text-[10px] text-[#c8aa6e] uppercase tracking-widest mb-1">Совет</div>
                    <p class="text-xs text-[#e0e0e0] leading-relaxed">Посети лекаря в хижине или съешь еду, чтобы восстановить здоровье.</p>
                </div>
                <button onclick="ui.dismissLowHpWarning()" class="btn-medieval w-full py-2 rounded text-xs border-amber-500 text-amber-300">
                    Понял
                </button>
            </div>
        </div>
    </div>

    <!-- Hunger Warning Modal -->
    <div id="modal-hunger" class="modal-overlay">
        <div class="modal-content rounded-lg p-6 text-center relative overflow-hidden border-orange-500">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-orange-400 to-transparent"></div>
            <div class="absolute inset-0 opacity-20 pointer-events-none bg-[radial-gradient(circle_at_top,rgba(251,146,60,0.2),transparent_60%)]"></div>
            <div class="relative">
                <div class="w-16 h-16 rounded-full border border-orange-500/60 bg-[#111] flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-utensils text-3xl text-orange-400"></i>
                </div>
                <h2 class="medieval-font text-2xl text-orange-300 mb-2">Сильный голод</h2>
                <p class="text-sm text-[#a0a0a0] mb-4">Ваш персонаж очень голоден! Теперь вы будете получать в два раза больше урона.</p>
                <div class="panel p-3 rounded bg-black/40 border border-[#333] mb-4 text-left">
                    <div class="text-[10px] text-[#c8aa6e] uppercase tracking-widest mb-1">Совет</div>
                    <p class="text-xs text-[#e0e0e0] leading-relaxed">Приготовьте еду, поешьте в таверне или в другом месте, чтобы восстановить сытость.</p>
                </div>
                <button onclick="ui.dismissHungerWarning()" class="btn-medieval w-full py-2 rounded text-xs border-orange-500 text-orange-300">
                    Понял
                </button>
            </div>
        </div>
    </div>

    <!-- Measles Infection Modal -->
    <div id="modal-measles-infected" class="modal-overlay">
        <div class="modal-content rounded-lg p-6 text-center relative overflow-hidden border-red-500">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-red-400 to-transparent"></div>
            <div class="absolute inset-0 opacity-20 pointer-events-none bg-[radial-gradient(circle_at_top,rgba(239,68,68,0.2),transparent_60%)]"></div>
            <div class="relative">
                <div class="w-16 h-16 rounded-full border border-red-500/60 bg-[#111] flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-virus text-3xl text-red-400"></i>
                </div>
                <h2 class="medieval-font text-2xl text-red-300 mb-2">Вы заболели корью!</h2>
                <p class="text-sm text-[#a0a0a0] mb-4">Вы подхватили опасную болезнь в Тёмном лесу!</p>
                <div class="panel p-3 rounded bg-black/40 border border-red-900/50 mb-4 text-left">
                    <div class="text-[10px] text-red-400 uppercase tracking-widest mb-2">⚠️ Опасность</div>
                    <p class="text-xs text-[#e0e0e0] leading-relaxed mb-2">
                        Теперь вы будете терять <span class="text-red-400 font-bold">-1 ХП каждые 20 секунд</span>.
                    </p>
                    <p class="text-xs text-[#a0a0a0] leading-relaxed">
                        Ходят слухи, что <span class="text-[#c8aa6e] font-semibold">Эльдар из Деревни</span> лечит людей от этой страшной болезни.
                    </p>
                </div>
                <button onclick="ui.dismissMeaslesWarning()" class="btn-medieval w-full py-2 rounded text-xs border-red-500 text-red-300">
                    Понял
                </button>
            </div>
        </div>
    </div>

    <!-- Escort Work Progress Modal -->
    <div id="modal-escort-progress" class="modal-overlay">
        <div class="modal-content rounded-lg p-6 text-center relative overflow-hidden border-red-500" onclick="event.stopPropagation()">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-red-400 to-transparent"></div>
            <div class="absolute inset-0 opacity-20 pointer-events-none bg-[radial-gradient(circle_at_top,rgba(239,68,68,0.2),transparent_60%)]"></div>
            <div class="relative">
                <div class="w-16 h-16 rounded-full border border-red-500/60 bg-[#111] flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-route text-3xl text-red-400"></i>
                </div>
                <h2 class="medieval-font text-2xl text-red-300 mb-2">Переправка беженцев</h2>
                <p class="text-sm text-[#a0a0a0] mb-4">Опасный путь через границу...</p>
                <div class="panel p-3 rounded bg-black/40 border border-red-900/50 mb-4">
                    <div id="escort-progress-text" class="text-sm text-[#e0e0e0] leading-relaxed">
                        Подготовка к переправке...
                    </div>
                    <div class="mt-3 progress-container">
                        <div id="escort-progress-bar" class="progress-fill" style="width: 0%; background: linear-gradient(90deg, #991b1b, #dc2626);"></div>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        <span id="escort-timer">60</span> секунд
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Escort Result Modal -->
    <div id="modal-escort-result" class="modal-overlay">
        <div class="modal-content rounded-lg p-6 text-center relative overflow-hidden border-amber-500">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-amber-400 to-transparent"></div>
            <div class="absolute inset-0 opacity-20 pointer-events-none bg-[radial-gradient(circle_at_top,rgba(245,158,11,0.2),transparent_60%)]"></div>
            <div class="relative">
                <div class="w-16 h-16 rounded-full border border-amber-500/60 bg-[#111] flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check-circle text-3xl text-amber-400"></i>
                </div>
                <h2 class="medieval-font text-2xl text-amber-300 mb-2">Переправка завершена</h2>
                <p class="text-sm text-[#a0a0a0] mb-4">Вы успешно переправили беженцев!</p>
                <div class="panel p-3 rounded bg-black/40 border border-[#333] mb-4 text-left space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-400">Получено:</span>
                        <span class="text-emerald-400 font-bold" id="escort-result-emeralds">+8 изумрудов</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-400">Репутация:</span>
                        <span class="text-red-400 font-bold" id="escort-result-rep">-5</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-400">Урон:</span>
                        <span class="text-red-400 font-bold" id="escort-result-hp">-40 ХП</span>
                    </div>
                </div>
                <button onclick="refugeeCamp.closeResult()" class="btn-medieval w-full py-2 rounded text-xs border-amber-500 text-amber-300">
                    Понял
                </button>
            </div>
        </div>
    </div>

    <!-- Reputation Info Modal -->
    <div id="modal-reputation" class="modal-overlay">
        <div class="modal-content rounded-lg p-6 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[#c8aa6e] to-transparent"></div>
            <h2 class="medieval-font text-2xl text-[#c8aa6e] mb-2">Репутация</h2>
            <p class="text-sm text-[#a0a0a0] mb-4">То, как тебя видят жители города.</p>
            <div class="panel p-3 rounded bg-black/30 border border-[#333] text-left text-xs text-[#e0e0e0] space-y-2">
                <p><span class="text-[#c8aa6e] font-bold">Повышается</span> за добрые поступки, выполнение заданий, покупку хорошей одежды, оружия и приличного дома.</p>
                <p><span class="text-red-400 font-bold">Понижается</span> за грубость, обман и сомнительные дела.</p>
                <p class="text-[10px] text-[#777]">Совет: будь вежливым, носи чистую одежду и обзаведись достойным домом.</p>
            </div>
            <button onclick="ui.closeRepInfo()" class="btn-medieval w-full py-2 rounded font-bold mt-4">Понял</button>
        </div>
    </div>

    </div>

    <!-- Reputation Change Notification Modal -->
    <div id="modal-rep-change" class="modal-overlay" style="pointer-events:none; z-index:1050;">
        <div id="rep-change-card" class="modal-content rounded-lg p-5 text-center relative overflow-hidden" style="max-width:320px; transform:scale(0.85); opacity:0; transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1), opacity 0.3s ease; pointer-events:none;">
            <div id="rep-change-topbar" class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[#34d399] to-transparent"></div>
            <div class="relative mb-2">
                <i id="rep-change-icon" class="fas fa-shield-halved text-3xl text-[#34d399] drop-shadow-[0_0_10px_rgba(52,211,153,0.6)]"></i>
            </div>
            <h2 class="medieval-font text-lg text-[#c8aa6e] mb-1">Репутация</h2>
            <div id="rep-change-amount" class="text-2xl font-bold text-[#34d399] medieval-font mb-2">+5</div>
            <div class="flex items-center justify-center gap-3 mb-1">
                <span id="rep-change-from" class="text-xs text-[#a0a0a0]">было: 0</span>
                <span class="text-[#555]">→</span>
                <span id="rep-change-to" class="text-xs text-[#c8aa6e] font-bold">стало: 5</span>
            </div>
            <div class="w-full bg-[#222] rounded-full h-1.5 mt-2 overflow-hidden">
                <div id="rep-change-bar" class="h-full rounded-full transition-all duration-500" style="width:5%; background:#34d399;"></div>
            </div>
        </div>
    </div>

    <!-- Item Info Modal -->
    <div id="modal-item" class="modal-overlay" onclick="itemModal.close()">
        <div class="modal-content rounded-lg p-6 text-center relative overflow-hidden" onclick="event.stopPropagation()">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[#c8aa6e] to-transparent"></div>

            <div class="w-16 h-16 rounded-full border border-[#c8aa6e]/70 bg-[#111] flex items-center justify-center mx-auto mb-3">
                <i id="item-modal-icon" class="fas fa-question text-3xl text-[#c8aa6e]"></i>
            </div>

            <h2 id="item-modal-name" class="medieval-font text-xl text-[#c8aa6e] mb-1">Предмет</h2>
            <div id="item-modal-count" class="text-[10px] text-[#777] mb-3"></div>

            <div class="panel p-3 rounded bg-black/30 border border-[#333] text-left">
                <div class="text-[10px] text-[#c8aa6e] uppercase tracking-widest mb-1">Описание</div>
                <p id="item-modal-desc" class="text-xs text-[#e0e0e0] leading-relaxed">—</p>
                <div class="mt-3 flex items-center justify-between text-[10px] text-[#a0a0a0]">
                    <span>Вес</span>
                    <span id="item-modal-weight" class="text-[#c8aa6e] font-bold">0 кг</span>
                </div>
            </div>

            <button id="btn-equip-item" class="w-full py-2 rounded font-bold mt-4 border border-green-700/40 bg-green-900/20 text-green-400 hover:bg-green-900/30 transition-all backdrop-blur-sm" style="display: none;">
                <i class="fas fa-hand-sparkles mr-2"></i>Экипировать
            </button>
            <button id="btn-unequip-item" class="w-full py-2 rounded font-bold mt-2 border border-orange-700/40 bg-orange-900/20 text-orange-400 hover:bg-orange-900/30 transition-all backdrop-blur-sm" style="display: none;">
                <i class="fas fa-hand mr-2"></i>Снять экипировку
            </button>
            <button id="btn-sell-item" class="w-full py-2 rounded font-bold mt-2 border border-yellow-700/40 bg-yellow-900/20 text-yellow-400 hover:bg-yellow-900/30 transition-all backdrop-blur-sm" style="display: none;">
                <i class="fas fa-coins mr-2"></i>Продать за <span id="sell-price">0</span>
            </button>
            <button id="btn-discard-item" class="w-full py-2 rounded font-bold mt-2 border border-red-700/40 bg-red-900/20 text-red-400 hover:bg-red-900/30 transition-all backdrop-blur-sm" style="display: none;">
                <i class="fas fa-trash mr-2"></i>Выбросить
            </button>
            <button onclick="itemModal.close()" class="btn-medieval w-full py-2 rounded font-bold mt-2">Закрыть</button>
        </div>
    </div>

    <!-- Dialogue Modal -->
    <div id="modal-dialogue" class="modal-overlay">
        <div class="modal-content rounded-xl p-0 relative overflow-hidden text-left flex flex-col max-h-[85vh] max-w-md shadow-2xl" style="background: linear-gradient(135deg, rgba(26,26,29,0.98), rgba(42,42,46,0.98));">
            <!-- Character Image Header -->
            <div class="relative h-48 overflow-hidden">
                <!-- Background gradient overlay -->
                <div class="absolute inset-0 bg-gradient-to-b from-transparent via-[#1a1a1d]/60 to-[#1a1a1d]"></div>
                
                <!-- Animated gradient background -->
                <div id="npc-bg-gradient" class="absolute inset-0 opacity-30 transition-all duration-1000" style="background: linear-gradient(135deg, #c8aa6e 0%, #8b733d 50%, #c8aa6e 100%); background-size: 200% 200%; animation: gradientShift 8s ease infinite;"></div>
                
                <!-- Character Image -->
                <div class="absolute inset-0 flex items-end justify-center pb-0">
                    <img id="npc-character-image" 
                         src="" 
                         alt="Character" 
                         class="h-full object-contain drop-shadow-2xl transition-all duration-700 ease-out"
                         style="filter: drop-shadow(0 0 30px rgba(200,170,110,0.4)); transform: translateY(10px); opacity: 0;">
                </div>
                
                <!-- Decorative particles -->
                <div class="absolute inset-0 pointer-events-none overflow-hidden">
                    <div class="particle-float" style="position: absolute; width: 4px; height: 4px; background: rgba(200,170,110,0.6); border-radius: 50%; top: 20%; left: 15%; animation: float 6s ease-in-out infinite;"></div>
                    <div class="particle-float" style="position: absolute; width: 3px; height: 3px; background: rgba(200,170,110,0.4); border-radius: 50%; top: 40%; right: 20%; animation: float 8s ease-in-out infinite 1s;"></div>
                    <div class="particle-float" style="position: absolute; width: 5px; height: 5px; background: rgba(200,170,110,0.5); border-radius: 50%; top: 60%; left: 25%; animation: float 7s ease-in-out infinite 0.5s;"></div>
                </div>
                
                <!-- Close button -->
                <button onclick="dialogue.close()" class="absolute top-3 right-3 w-8 h-8 rounded-full bg-black/40 backdrop-blur-sm border border-white/10 flex items-center justify-center text-white/70 hover:text-white hover:bg-black/60 hover:border-white/20 transition-all z-10">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>

            <!-- NPC Info Bar -->
            <div class="relative px-5 pt-4 pb-3 border-b border-[#333]/50">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center overflow-hidden shrink-0 relative" style="background: linear-gradient(135deg, rgba(200,170,110,0.2), rgba(139,115,61,0.2)); border: 2px solid rgba(200,170,110,0.4); box-shadow: 0 0 20px rgba(200,170,110,0.3), inset 0 0 10px rgba(0,0,0,0.3);">
                        <i id="npc-icon" class="fas fa-user text-2xl" style="color: #c8aa6e; filter: drop-shadow(0 0 8px rgba(200,170,110,0.6));"></i>
                    </div>
                    <div class="flex-1">
                        <h2 id="npc-name" class="medieval-font text-xl text-[#e0e0e0] leading-tight mb-0.5" style="text-shadow: 0 0 10px rgba(200,170,110,0.5);">Имя</h2>
                        <p id="npc-role" class="text-xs text-[#c8aa6e]/70 flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 rounded-full bg-[#c8aa6e] animate-pulse"></span>
                            <span>Роль</span>
                        </p>
                    </div>
                </div>
                
                <!-- Decorative line -->
                <div class="absolute bottom-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-[#c8aa6e]/30 to-transparent"></div>
            </div>

            <!-- Chat Body with enhanced styling -->
            <div class="p-5 overflow-y-auto min-h-[120px] max-h-[200px] relative" style="background: linear-gradient(to bottom, rgba(15,15,16,0.4), rgba(26,26,29,0.6));">
                <!-- Text container with animation -->
                <div class="relative">
                    <div class="absolute -left-2 top-0 w-1 h-full bg-gradient-to-b from-[#c8aa6e]/50 via-[#c8aa6e]/20 to-transparent rounded-full"></div>
                    <p id="npc-text" class="text-sm text-[#e0e0e0] leading-relaxed pl-3 dialogue-text" style="line-height: 1.7; animation: fadeInText 0.6s ease-out;">...</p>
                </div>
                
                <!-- Ambient glow effect -->
                <div class="absolute inset-0 pointer-events-none" style="background: radial-gradient(circle at 50% 0%, rgba(200,170,110,0.03), transparent 70%);"></div>
            </div>

            <!-- Options with enhanced design -->
            <div id="npc-options" class="p-4 flex flex-col gap-2.5" style="background: linear-gradient(to top, rgba(15,15,16,0.8), rgba(26,26,29,0.4));">
                <!-- Options populated by JS -->
            </div>
        </div>
    </div>

    <!-- Blackjack Modal -->
    <div id="modal-blackjack" class="modal-overlay">
        <div class="modal-content rounded-xl p-0 relative overflow-hidden text-left flex flex-col max-h-[90vh] max-w-2xl shadow-2xl" style="background: linear-gradient(135deg, rgba(26,26,29,0.98), rgba(42,42,46,0.98)); width: 95%; max-width: 600px;">
            <!-- Header -->
            <div class="relative h-16 overflow-hidden border-b border-purple-900/30">
                <div class="absolute inset-0 bg-gradient-to-r from-purple-900/20 via-purple-700/20 to-purple-900/20"></div>
                <div class="relative z-10 h-full flex items-center justify-between px-6">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-600/30 to-purple-900/30 flex items-center justify-center border-2 border-purple-500/50">
                            <i class="fas fa-cards text-purple-400 text-lg"></i>
                        </div>
                        <div>
                            <h2 class="medieval-font text-xl text-purple-300">Блэкджек</h2>
                            <p class="text-[10px] text-purple-400/70">Карточная игра высоких ставок</p>
                        </div>
                    </div>
                    <button onclick="blackjack.close()" class="w-8 h-8 rounded-full bg-black/40 backdrop-blur-sm border border-white/10 flex items-center justify-center text-white/70 hover:text-white hover:bg-black/60 transition-all">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>

            <!-- Game Area -->
            <div class="p-6 space-y-4 overflow-y-auto" style="max-height: calc(90vh - 16rem);">
                <!-- Dealer Section -->
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-red-600/30 to-red-900/30 flex items-center justify-center border border-red-500/50">
                                <i class="fas fa-user-tie text-red-400 text-sm"></i>
                            </div>
                            <span class="text-sm text-red-300 medieval-font">Дилер</span>
                        </div>
                        <div class="text-sm">
                            <span class="text-gray-400">Очки: </span>
                            <span id="dealer-score" class="text-red-300 font-bold">0</span>
                        </div>
                    </div>
                    <div id="dealer-cards" class="flex gap-2 min-h-[120px] p-3 rounded-lg bg-black/30 border border-red-900/30 items-center justify-center flex-wrap">
                        <!-- Dealer cards will be added here -->
                    </div>
                </div>

                <!-- Player Section -->
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-green-600/30 to-green-900/30 flex items-center justify-center border border-green-500/50">
                                <i class="fas fa-user text-green-400 text-sm"></i>
                            </div>
                            <span class="text-sm text-green-300 medieval-font">Вы</span>
                        </div>
                        <div class="text-sm">
                            <span class="text-gray-400">Очки: </span>
                            <span id="player-score" class="text-green-300 font-bold">0</span>
                        </div>
                    </div>
                    <div id="player-cards" class="flex gap-2 min-h-[120px] p-3 rounded-lg bg-black/30 border border-green-900/30 items-center justify-center flex-wrap">
                        <!-- Player cards will be added here -->
                    </div>
                </div>

                <!-- Game Message -->
                <div id="game-message" class="text-center py-3 px-4 rounded-lg bg-purple-900/20 border border-purple-700/30 min-h-[60px] flex items-center justify-center">
                    <p class="text-sm text-purple-300 medieval-font">Сделайте ставку, чтобы начать игру</p>
                </div>
            </div>

            <!-- Controls -->
            <div class="p-6 pt-4 border-t border-purple-900/30 space-y-3" style="background: linear-gradient(to top, rgba(15,15,16,0.8), transparent);">
                <!-- Bet Controls -->
                <div id="bet-controls" class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-400">Ваша ставка:</span>
                        <div class="flex items-center gap-2">
                            <span id="current-bet" class="text-xl font-bold text-yellow-400 medieval-font">2000</span>
                            <i class="fas fa-coins text-yellow-500"></i>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="blackjack.setBet(2000, event)" class="bet-btn py-2 rounded text-xs border border-purple-700/40 bg-black/30 text-purple-300 hover:bg-purple-900/20 transition-all">2000</button>
                        <button onclick="blackjack.setBet(5000, event)" class="bet-btn py-2 rounded text-xs border border-purple-700/40 bg-black/30 text-purple-300 hover:bg-purple-900/20 transition-all">5000</button>
                        <button onclick="blackjack.setBet(10000, event)" class="bet-btn py-2 rounded text-xs border border-purple-700/40 bg-black/30 text-purple-300 hover:bg-purple-900/20 transition-all">10000</button>
                        <button onclick="blackjack.setBet(25000, event)" class="bet-btn py-2 rounded text-xs border border-purple-700/40 bg-black/30 text-purple-300 hover:bg-purple-900/20 transition-all">25000</button>
                    </div>
                    <button onclick="blackjack.startGame()" class="w-full py-3 rounded font-bold border-2 border-purple-500/50 bg-gradient-to-r from-purple-900/40 to-purple-700/40 text-purple-200 hover:from-purple-800/50 hover:to-purple-600/50 transition-all medieval-font text-sm">
                        <i class="fas fa-play mr-2"></i>Начать игру
                    </button>
                </div>

                <!-- Game Controls -->
                <div id="game-controls" class="hidden space-y-2">
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="blackjack.hit()" id="btn-hit" class="py-3 rounded font-bold border-2 border-green-500/50 bg-gradient-to-r from-green-900/40 to-green-700/40 text-green-200 hover:from-green-800/50 hover:to-green-600/50 transition-all medieval-font text-sm">
                            <i class="fas fa-plus mr-2"></i>Взять карту
                        </button>
                        <button onclick="blackjack.stand()" id="btn-stand" class="py-3 rounded font-bold border-2 border-yellow-500/50 bg-gradient-to-r from-yellow-900/40 to-yellow-700/40 text-yellow-200 hover:from-yellow-800/50 hover:to-yellow-600/50 transition-all medieval-font text-sm">
                            <i class="fas fa-hand-paper mr-2"></i>Хватит
                        </button>
                    </div>
                    <button onclick="blackjack.resetGame()" class="w-full py-2 rounded font-bold border border-gray-700/40 bg-black/30 text-gray-400 hover:bg-gray-900/20 transition-all text-xs">
                        <i class="fas fa-redo mr-2"></i>Новая игра
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tournament Battle Modal -->
    <div id="modal-tournament-battle" class="modal-overlay">
        <div class="modal-content rounded-xl p-0 relative overflow-hidden text-left flex flex-col max-h-[90vh] shadow-2xl" style="background: linear-gradient(135deg, rgba(26,26,29,0.98), rgba(42,42,46,0.98)); width: 95%; max-width: 700px;">
            <!-- Battle Header -->
            <div class="relative h-24 overflow-hidden border-b border-amber-900/30">
                <div class="absolute inset-0 bg-gradient-to-r from-amber-900/30 via-red-900/30 to-amber-900/30"></div>
                <div class="absolute inset-0" style="background-image: url('https://i.postimg.cc/s2cXkKrW/IMG-4610.jpg'); background-size: cover; background-position: center; opacity: 0.15;"></div>
                
                <div class="relative z-10 h-full flex flex-col justify-center px-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="medieval-font text-2xl text-amber-300 drop-shadow-lg" id="battle-title">Турнирный Поединок</h2>
                            <p class="text-xs text-amber-400/70" id="battle-subtitle">Раунд 1 из 3</p>
                        </div>
                        <button onclick="tournamentBattle.forfeit()" class="w-10 h-10 rounded-full bg-black/40 backdrop-blur-sm border border-red-500/30 flex items-center justify-center text-red-400 hover:text-red-300 hover:bg-red-900/30 transition-all">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Decorative swords -->
                <div class="absolute top-2 left-1/2 -translate-x-1/2 flex gap-2 opacity-20">
                    <i class="fas fa-sword text-amber-400 text-xs rotate-45"></i>
                    <i class="fas fa-sword text-amber-400 text-xs -rotate-45"></i>
                </div>
            </div>

            <!-- Battle Arena -->
            <div class="p-4 space-y-3 overflow-y-auto" style="max-height: calc(90vh - 20rem);">
                <!-- Opponent Info -->
                <div class="relative rounded-lg p-4 border border-red-900/40 overflow-hidden" style="background: linear-gradient(135deg, rgba(127, 29, 29, 0.2), rgba(69, 10, 10, 0.3));">
                    <div class="absolute top-0 right-0 w-32 h-32 opacity-10">
                        <i class="fas fa-skull text-red-500 text-8xl"></i>
                    </div>
                    
                    <div class="relative z-10 space-y-2">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full border-2 border-red-500/50 flex items-center justify-center bg-gradient-to-br from-red-900/40 to-black/60">
                                    <i id="opponent-icon" class="fas fa-user-ninja text-red-400 text-xl"></i>
                                </div>
                                <div>
                                    <h3 id="opponent-name" class="text-lg font-bold text-red-300 medieval-font">Противник</h3>
                                    <p id="opponent-tactic" class="text-xs text-red-400/70">Тактика: Агрессивная</p>
                                </div>
                            </div>
                            <div id="opponent-stamina-indicator" class="flex gap-1">
                                <!-- Stamina dots will be added here -->
                            </div>
                        </div>
                        
                        <!-- Opponent Stats Bar -->
                        <div class="space-y-1.5">
                            <div class="flex items-center justify-between text-xs">
                                <span class="text-red-300">❤️ Здоровье</span>
                                <span id="opponent-hp-text" class="text-red-200 font-bold">100/100</span>
                            </div>
                            <div class="h-3 bg-black/50 rounded-full overflow-hidden border border-red-900/50">
                                <div id="opponent-hp-bar" class="h-full bg-gradient-to-r from-red-600 to-red-500 transition-all duration-500" style="width: 100%;"></div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <div class="text-xs text-center p-1.5 bg-black/30 rounded border border-red-900/30">
                                    <div class="text-red-400/60">⚔️ Урон</div>
                                    <div id="opponent-damage" class="text-red-300 font-bold">15</div>
                                </div>
                                <div class="text-xs text-center p-1.5 bg-black/30 rounded border border-red-900/30">
                                    <div class="text-red-400/60">🛡️ Броня</div>
                                    <div id="opponent-armor" class="text-red-300 font-bold">10</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Opponent Status Effects -->
                        <div id="opponent-effects" class="flex gap-1 flex-wrap min-h-[20px]">
                            <!-- Status effects will appear here -->
                        </div>
                    </div>
                </div>

                <!-- Battle Log -->
                <div class="rounded-lg p-3 bg-black/40 border border-amber-900/30 min-h-[80px] max-h-[120px] overflow-y-auto" id="battle-log">
                    <div class="space-y-1 text-xs">
                        <p class="text-amber-400/70 italic">⚔️ Поединок начинается...</p>
                    </div>
                </div>

                <!-- Player Info -->
                <div class="relative rounded-lg p-4 border border-green-900/40 overflow-hidden" style="background: linear-gradient(135deg, rgba(22, 101, 52, 0.2), rgba(20, 83, 45, 0.3));">
                    <div class="absolute top-0 left-0 w-32 h-32 opacity-10">
                        <i class="fas fa-shield text-green-500 text-8xl"></i>
                    </div>
                    
                    <div class="relative z-10 space-y-2">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full border-2 border-green-500/50 flex items-center justify-center bg-gradient-to-br from-green-900/40 to-black/60">
                                    <i class="fas fa-user-shield text-green-400 text-xl"></i>
                                </div>
                                <div>
                                    <h3 id="player-battle-name" class="text-lg font-bold text-green-300 medieval-font">Вы</h3>
                                    <p class="text-xs text-green-400/70">Рыцарь</p>
                                </div>
                            </div>
                            <div id="player-stamina-indicator" class="flex gap-1">
                                <!-- Stamina dots will be added here -->
                            </div>
                        </div>
                        
                        <!-- Player Stats Bar -->
                        <div class="space-y-1.5">
                            <div class="flex items-center justify-between text-xs">
                                <span class="text-green-300">❤️ Здоровье</span>
                                <span id="player-hp-text" class="text-green-200 font-bold">100/100</span>
                            </div>
                            <div class="h-3 bg-black/50 rounded-full overflow-hidden border border-green-900/50">
                                <div id="player-hp-bar" class="h-full bg-gradient-to-r from-green-600 to-green-500 transition-all duration-500" style="width: 100%;"></div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <div class="text-xs text-center p-1.5 bg-black/30 rounded border border-green-900/30">
                                    <div class="text-green-400/60">⚔️ Урон</div>
                                    <div id="player-damage" class="text-green-300 font-bold">10</div>
                                </div>
                                <div class="text-xs text-center p-1.5 bg-black/30 rounded border border-green-900/30">
                                    <div class="text-green-400/60">🛡️ Броня</div>
                                    <div id="player-armor" class="text-green-300 font-bold">5</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Player Status Effects -->
                        <div id="player-effects" class="flex gap-1 flex-wrap min-h-[20px]">
                            <!-- Status effects will appear here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Battle Actions -->
            <div class="p-4 pt-3 border-t border-amber-900/30 space-y-2" style="background: linear-gradient(to top, rgba(15,15,16,0.9), transparent);">
                <div id="battle-actions" class="grid grid-cols-2 gap-2">
                    <!-- Quick Strike -->
                    <button onclick="tournamentBattle.playerAction('quick_strike')" class="battle-action-btn p-3 rounded-lg border-2 transition-all group" data-stamina="1">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-bold text-yellow-300 medieval-font">⚡ Быстрая атака</span>
                            <span class="stamina-cost text-xs text-yellow-500">💧1</span>
                        </div>
                        <p class="text-xs text-gray-400 leading-tight">Быстрый удар. Средний урон, низкий шанс блока врага.</p>
                    </button>
                    
                    <!-- Power Strike -->
                    <button onclick="tournamentBattle.playerAction('power_strike')" class="battle-action-btn p-3 rounded-lg border-2 transition-all group" data-stamina="2">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-bold text-red-300 medieval-font">💥 Мощная атака</span>
                            <span class="stamina-cost text-xs text-red-500">💧2</span>
                        </div>
                        <p class="text-xs text-gray-400 leading-tight">Сильный удар. Высокий урон, но можно пропустить контратаку.</p>
                    </button>
                    
                    <!-- Defend -->
                    <button onclick="tournamentBattle.playerAction('defend')" class="battle-action-btn p-3 rounded-lg border-2 transition-all group" data-stamina="1">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-bold text-blue-300 medieval-font">🛡️ Защита</span>
                            <span class="stamina-cost text-xs text-blue-500">💧1</span>
                        </div>
                        <p class="text-xs text-gray-400 leading-tight">Блок щитом. Снижает урон на 80% и восстанавливает 1 выносливость.</p>
                    </button>
                    
                    <!-- Counter -->
                    <button onclick="tournamentBattle.playerAction('counter')" class="battle-action-btn p-3 rounded-lg border-2 transition-all group" data-stamina="2">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-bold text-purple-300 medieval-font">🎯 Контратака</span>
                            <span class="stamina-cost text-xs text-purple-500">💧2</span>
                        </div>
                        <p class="text-xs text-gray-400 leading-tight">Парирование и ответный удар. Если враг атакует - наносите двойной урон!</p>
                    </button>
                </div>
                
                <div class="text-center text-xs text-amber-400/70 italic" id="battle-hint">
                    💡 Изучите тактику противника и выбирайте действия мудро!
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Tournament Battle Styles */
        .battle-action-btn {
            background: linear-gradient(135deg, rgba(42,42,46,0.6), rgba(26,26,29,0.8));
            border-color: rgba(200,170,110,0.3);
        }
        
        .battle-action-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, rgba(200,170,110,0.2), rgba(42,42,46,0.8));
            border-color: rgba(200,170,110,0.6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(200,170,110,0.3);
        }
        
        .battle-action-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .battle-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: rgba(100,100,100,0.3);
        }
        
        .status-effect {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            border: 1px solid;
        }
        
        .status-effect.buff {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.4);
            color: #86efac;
        }
        
        .status-effect.debuff {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
            color: #fca5a5;
        }
        
        .stamina-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.5);
            transition: all 0.3s;
        }
        
        .stamina-dot.active {
            background: rgba(59, 130, 246, 0.9);
            border-color: #3b82f6;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.6);
        }
        
        @keyframes damageShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .damage-shake {
            animation: damageShake 0.3s ease-in-out;
        }
        
        @keyframes healPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .heal-pulse {
            animation: healPulse 0.5s ease-in-out;
        }
        
        #battle-log {
            scrollbar-width: thin;
            scrollbar-color: rgba(200,170,110,0.5) rgba(0,0,0,0.3);
        }
        
        #battle-log::-webkit-scrollbar {
            width: 4px;
        }
        
        #battle-log::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
        }
        
        #battle-log::-webkit-scrollbar-thumb {
            background: rgba(200,170,110,0.5);
            border-radius: 2px;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .bj-card {
            width: 70px;
            height: 100px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            font-weight: bold;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: transform 0.3s, box-shadow 0.3s;
            animation: cardDeal 0.4s ease-out;
        }
        
        .bj-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
        }
        
        .bj-card.red {
            background: linear-gradient(135deg, #fef3f3, #fde8e8);
            border: 2px solid #dc2626;
            color: #dc2626;
        }
        
        .bj-card.black {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border: 2px solid #1f2937;
            color: #1f2937;
        }
        
        .bj-card.back {
            background: linear-gradient(135deg, #581c87, #6b21a8, #7c3aed);
            border: 2px solid #a855f7;
            position: relative;
            overflow: hidden;
        }
        
        .bj-card.back::before {
            content: '';
            position: absolute;
            inset: 8px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 4px;
        }
        
        .bj-card.back::after {
            content: '♠♥♣♦';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: rgba(255,255,255,0.2);
            letter-spacing: 2px;
        }
        
        .bj-card-rank {
            font-size: 20px;
            line-height: 1;
        }
        
        .bj-card-suit {
            font-size: 32px;
            line-height: 1;
        }
        
        .bj-card-corner {
            position: absolute;
            bottom: 8px;
            right: 8px;
            font-size: 12px;
            opacity: 0.6;
        }
        
        @keyframes cardDeal {
            from {
                opacity: 0;
                transform: translateY(-20px) rotateX(90deg);
            }
            to {
                opacity: 1;
                transform: translateY(0) rotateX(0);
            }
        }
        
        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 0 10px rgba(168, 85, 247, 0.4);
            }
            50% {
                box-shadow: 0 0 20px rgba(168, 85, 247, 0.8);
            }
        }
        
        .bet-btn.active {
            background: rgba(168, 85, 247, 0.3) !important;
            border-color: #a855f7 !important;
            color: #e9d5ff !important;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) translateX(0px); opacity: 0.6; }
            50% { transform: translateY(-20px) translateX(10px); opacity: 1; }
        }
        
        @keyframes fadeInText {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInOption {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .dialogue-text {
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        /* Smooth scrollbar for dialogue */
        #modal-dialogue .overflow-y-auto::-webkit-scrollbar {
            width: 6px;
        }
        #modal-dialogue .overflow-y-auto::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 3px;
        }
        #modal-dialogue .overflow-y-auto::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #c8aa6e, #8b733d);
            border-radius: 3px;
        }
        #modal-dialogue .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #d4b87a, #9a8147);
        }
        
        /* Character image entrance animation */
        #npc-character-image.loaded {
            transform: translateY(0) !important;
            opacity: 1 !important;
        }
    </style>
    
    <div id="loading-screen" class="fixed inset-0 z-50 overflow-hidden bg-[#0f0f10]">
        <img src="https://s5.iimage.su/s/03/gnibzcbxwV0bKrjzR3V0zXlwLSOkZCZUsu0Db0Ia.jpg" alt="Loading" class="absolute inset-0 w-full h-full object-cover" onerror="this.onerror=null; this.style.display='none';">
        <div class="absolute inset-x-0 bottom-0 h-48 bg-gradient-to-t from-black/70 via-black/40 to-transparent pointer-events-none"></div>
        <div class="absolute bottom-8 left-1/2 -translate-x-1/2 w-4/5 max-w-md">
            <div class="h-2 rounded-full overflow-hidden border border-[#c8aa6e]/60 bg-black/20">
                <div id="loading-bar-fill" class="h-full bg-gradient-to-r from-[#8b733d] to-[#c8aa6e] w-0 transition-all duration-150"></div>
            </div>
            <div class="text-center text-xs text-[#c8aa6e]/80 mt-2">Загрузка...</div>
        </div>
    </div>

    <!-- Header / Currency Bar -->
    <header class="h-14 flex items-center justify-between px-4 bg-opacity-90 bg-[#141417] border-b border-[#333] z-20 backdrop-blur-md shrink-0">
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-1">
                <i class="fas fa-coins text-yellow-500 text-sm"></i>
                <span id="gold-display" class="font-bold tracking-wide text-sm">0</span>
            </div>
            <div class="flex items-center gap-1">
                <i class="far fa-gem text-emerald-400 text-sm"></i>
                <span id="emerald-display" class="font-bold tracking-wide text-sm">0</span>
            </div>
        </div>
        
        <!-- Header Level & XP -->
        <div class="flex flex-col items-end justify-center w-32">
             <div class="flex items-center justify-between w-full mb-0.5">
                <span class="text-[10px] text-[#a0a0a0] flex items-center gap-1"><i class="fas fa-heart text-red-500"></i> <span id="header-hp-text">100</span></span>
                <span class="text-xs text-[#c8aa6e] font-serif font-bold" id="level-display-header">Ур 1</span>
             </div>
             <div class="w-full h-1.5 bg-[#000] rounded-full overflow-hidden border border-[#333] mb-0.5">
                 <div id="header-xp-bar" class="h-full bg-gradient-to-r from-[#8b733d] to-[#c8aa6e] w-0 transition-all duration-300"></div>
             </div>
             <div class="text-[8px] text-[#777] font-mono tracking-tighter" id="header-xp-text">0/100</div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="app-container" class="flex-1 overflow-y-auto p-4 pb-20 relative">
        
        <!-- VIEW: CHARACTER -->
        <section id="view-character" class="space-y-6 hidden">
            <div class="flex flex-col items-center justify-center py-6 relative">
                <!-- Hero quick actions -->
                <div class="absolute top-0 right-0 flex gap-2">
                    <button onclick="ui.openSettings()" class="icon-tile" aria-label="Настройки">
                        <i class="fas fa-gear"></i>
                    </button>
                </div>

                <div class="w-32 h-32 rounded-full border-2 border-[#c8aa6e] overflow-hidden shadow-[0_0_15px_rgba(200,170,110,0.3)] mb-4 relative bg-[#222]" style="box-shadow: inset 0 0 20px rgba(0,0,0,0.5), 0 0 15px rgba(200,170,110,0.3);">
                    <img src="https://i.postimg.cc/L5B41FgX/IMG-4572.jpg" alt="Герой" class="w-full h-full object-cover scale-110" onerror="this.onerror=null; this.src='https://api.dicebear.com/7.x/adventurer/svg?seed=medievalWarrior&backgroundColor=1a1a1d&skinColor=f2d3b1&hair=short01&hairColor=796a45&eyes=variant01&eyebrows=variant10&mouth=variant01';">
                    <div class="absolute inset-0 bg-gradient-to-b from-transparent via-transparent to-[#c8aa6e]/30 pointer-events-none"></div>
                    <div class="absolute inset-0 border-4 border-[#c8aa6e]/30 rounded-full pointer-events-none"></div>
                </div>
                <h2 id="hero-title" class="text-2xl medieval-font text-[#e0e0e0]">Странник</h2>
                <p id="hero-title-desc" class="text-sm text-[#a0a0a0] mb-2">Начинающий искатель приключений</p>
                <div class="panel rounded p-2 text-center text-[10px] text-[#a0a0a0] w-full max-w-xs mb-2">
                    <div class="flex items-center justify-center gap-2">
                        <span>Имя:</span>
                        <span id="player-name" class="text-[#c8aa6e] font-bold">Странник</span>
                    </div>
                    <div class="mt-1">ID: <span id="player-id" class="text-[#c8aa6e] font-bold">—</span></div>
                </div>
                
                <!-- Level Progress -->
                <div class="w-full max-w-xs space-y-1">
                    <div class="flex justify-between text-xs text-[#a0a0a0]">
                        <span>Уровень <span id="char-level">1</span></span>
                    </div>
                    <div class="progress-container">
                        <div id="xp-bar" class="progress-fill"></div>
                    </div>
                    <div class="flex justify-between items-center mt-1">
                        <div class="text-[10px] text-[#777]">
                             <span id="xp-text">0 / 100 XP</span>
                        </div>
                        <div class="text-[10px] text-[#777]">
                            Осталось <span id="xp-remaining" class="text-[#c8aa6e]">100</span>
                        </div>
                    </div>
                </div>

                <!-- HP Status -->
                <div class="w-full max-w-xs mt-2">
                    <div class="flex justify-between text-xs text-[#a0a0a0] mb-1">
                        <span>Здоровье</span>
                        <span id="hp-text" class="text-red-400">100 / 100</span>
                    </div>
                    <div class="h-2 bg-[#000] border border-[#333] rounded-full overflow-hidden relative">
                        <div id="hp-bar" class="h-full bg-red-600 w-full transition-all duration-300"></div>
                    </div>
                </div>

                <!-- Hunger Status -->
                <div class="w-full max-w-xs mt-2">
                    <div class="flex justify-between text-xs text-[#a0a0a0] mb-1">
                        <span>Голод</span>
                        <span id="hunger-text" class="text-amber-400">100 / 100</span>
                    </div>
                    <div class="h-2 bg-[#000] border border-[#333] rounded-full overflow-hidden relative">
                        <div id="hunger-bar" class="h-full bg-amber-500 w-full transition-all duration-300"></div>
                    </div>
                </div>
            </div>

            <!-- Equipment Slots -->
            <div class="panel rounded p-4 relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-br from-amber-900/5 via-transparent to-purple-900/5 pointer-events-none"></div>
                <h3 class="medieval-font text-sm text-[#c8aa6e] mb-4 text-center relative z-10">Экипировка</h3>
                
                <div class="flex gap-3 relative z-10">
                    <!-- Left: ALL Equipment buttons -->
                    <div class="flex-1 space-y-2">
                        <!-- Armor Slot -->
                        <div id="slot-armor" onclick="equipment.openSlot('armor')" class="cursor-pointer rounded-lg border-2 border-blue-600/40 backdrop-blur-sm p-3 flex items-center gap-3 hover:border-blue-500/80 hover:shadow-lg hover:shadow-blue-500/20 transition-all relative overflow-hidden group" style="background: linear-gradient(135deg, rgba(30, 58, 138, 0.15) 0%, rgba(0, 0, 0, 0.4) 50%, rgba(30, 58, 138, 0.15) 100%);">
                            <div class="absolute inset-0 bg-gradient-to-r from-blue-600/20 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div class="w-12 h-12 rounded-full border-2 border-blue-500/40 flex items-center justify-center flex-shrink-0 relative z-10" style="background: linear-gradient(135deg, rgba(30, 58, 138, 0.3), rgba(0, 0, 0, 0.5));">
                                <i class="fas fa-shield-halved text-blue-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <div class="flex-1 relative z-10">
                                <div class="text-sm text-blue-300 font-bold medieval-font slot-item-name">Броня</div>
                                <div class="text-[10px] text-blue-400/70 slot-item-sub">Не экипирована</div>
                            </div>
                            <i class="fas fa-chevron-right text-blue-500/50 group-hover:text-blue-400/80 transition-colors relative z-10"></i>
                        </div>
                        
                        <!-- Sword Slot -->
                        <div id="slot-sword" onclick="equipment.openSlot('sword')" class="cursor-pointer rounded-lg border-2 border-red-600/40 backdrop-blur-sm p-3 flex items-center gap-3 hover:border-red-500/80 hover:shadow-lg hover:shadow-red-500/20 transition-all relative overflow-hidden group" style="background: linear-gradient(135deg, rgba(153, 27, 27, 0.15) 0%, rgba(0, 0, 0, 0.4) 50%, rgba(153, 27, 27, 0.15) 100%);">
                            <div class="absolute inset-0 bg-gradient-to-r from-red-600/20 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div class="w-12 h-12 rounded-full border-2 border-red-500/40 flex items-center justify-center flex-shrink-0 relative z-10 slot-icon-wrap" style="background: linear-gradient(135deg, rgba(153, 27, 27, 0.3), rgba(0, 0, 0, 0.5));">
                                <i class="fas fa-khanda text-red-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <div class="flex-1 relative z-10">
                                <div class="text-sm text-red-300 font-bold medieval-font slot-item-name">Меч</div>
                                <div class="text-[10px] text-red-400/70 slot-item-sub">Не экипирован</div>
                            </div>
                            <i class="fas fa-chevron-right text-red-500/50 group-hover:text-red-400/80 transition-colors relative z-10"></i>
                        </div>
                        
                        <!-- Clothes Slot -->
                        <div id="slot-clothes" onclick="equipment.openSlot('clothes')" class="cursor-pointer rounded-lg border-2 border-green-600/40 backdrop-blur-sm p-3 flex items-center gap-3 hover:border-green-500/80 hover:shadow-lg hover:shadow-green-500/20 transition-all relative overflow-hidden group" style="background: linear-gradient(135deg, rgba(22, 101, 52, 0.15) 0%, rgba(0, 0, 0, 0.4) 50%, rgba(22, 101, 52, 0.15) 100%);">
                            <div class="absolute inset-0 bg-gradient-to-r from-green-600/20 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div class="w-12 h-12 rounded-full border-2 border-green-500/40 flex items-center justify-center flex-shrink-0 relative z-10" style="background: linear-gradient(135deg, rgba(22, 101, 52, 0.3), rgba(0, 0, 0, 0.5));">
                                <i class="fas fa-shirt text-green-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <div class="flex-1 relative z-10">
                                <div class="text-sm text-green-300 font-bold medieval-font">Одежда</div>
                                <div class="text-[10px] text-green-400/70">Не экипирована</div>
                            </div>
                            <i class="fas fa-chevron-right text-green-500/50 group-hover:text-green-400/80 transition-colors relative z-10"></i>
                        </div>
                        
                        <!-- Saddle Slot -->
                        <div id="slot-saddle" onclick="equipment.openSlot('saddle')" class="cursor-pointer rounded-lg border-2 border-purple-600/40 backdrop-blur-sm p-3 flex items-center gap-3 hover:border-purple-500/80 hover:shadow-lg hover:shadow-purple-500/20 transition-all relative overflow-hidden group" style="background: linear-gradient(135deg, rgba(107, 33, 168, 0.15) 0%, rgba(0, 0, 0, 0.4) 50%, rgba(107, 33, 168, 0.15) 100%);">
                            <div class="absolute inset-0 bg-gradient-to-r from-purple-600/20 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div class="w-12 h-12 rounded-full border-2 border-purple-500/40 flex items-center justify-center flex-shrink-0 relative z-10" style="background: linear-gradient(135deg, rgba(107, 33, 168, 0.3), rgba(0, 0, 0, 0.5));">
                                <i class="fas fa-horse-head text-purple-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <div class="flex-1 relative z-10">
                                <div class="text-sm text-purple-300 font-bold medieval-font">Седло</div>
                                <div class="text-[10px] text-purple-400/70">Не экипировано</div>
                            </div>
                            <i class="fas fa-chevron-right text-purple-500/50 group-hover:text-purple-400/80 transition-colors relative z-10"></i>
                        </div>
                    </div>
                    
                    <!-- Right: Character Display -->
                    <div class="flex-shrink-0" style="width: 160px;">
                        <div class="w-full rounded-lg border-2 border-amber-600/40 backdrop-blur-sm overflow-hidden relative hover:border-amber-500/60 transition-all" style="height: 100%; background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(20, 20, 25, 0.7) 50%, rgba(0, 0, 0, 0.6) 100%);">
                            <img src="https://i.postimg.cc/RF2Bf1CP/IMG-4647.png" alt="Персонаж" class="w-full h-full object-cover object-center opacity-90">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-black/20"></div>
                            <div class="absolute inset-0 bg-[radial-gradient(circle_at_50%_120%,rgba(200,170,110,0.15),transparent_70%)]"></div>
                            <div class="absolute bottom-0 left-0 right-0 p-2 text-center">
                                <div class="text-xs text-amber-300 font-bold medieval-font drop-shadow-[0_2px_8px_rgba(0,0,0,0.9)]" id="char-panel-title">Странник</div>
                                <div class="text-[9px] text-amber-500/90 drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)]" id="char-panel-level">Уровень 1</div>
                            </div>
                            <div class="absolute top-0 left-0 right-0 h-0.5 bg-gradient-to-r from-transparent via-amber-500/50 to-transparent"></div>
                            <div class="absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-transparent via-amber-500/50 to-transparent"></div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center text-[10px] text-gray-500 mt-3 relative z-10">
                    Экипировка влияет на характеристики и защиту персонажа
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 gap-3">
                <div class="panel p-3 rounded text-center">
                    <div class="text-[10px] text-[#a0a0a0] uppercase tracking-widest">Урон</div>
                    <div id="stat-damage" class="text-lg font-bold text-[#c8aa6e]">0</div>
                </div>
                <div class="panel p-3 rounded text-center">
                    <div class="text-[10px] text-[#a0a0a0] uppercase tracking-widest">Броня</div>
                    <div id="stat-armor" class="text-lg font-bold text-[#c8aa6e]">0</div>
                </div>
                <div class="panel p-3 rounded text-center">
                    <div class="text-[10px] text-[#a0a0a0] uppercase tracking-widest">Ловкость</div>
                    <div id="stat-agility" class="text-lg font-bold text-[#c8aa6e]">0</div>
                </div>
                <div class="panel p-3 rounded text-center">
                    <div class="text-[10px] text-[#a0a0a0] uppercase tracking-widest">Удача</div>
                    <div id="stat-luck" class="text-lg font-bold text-[#c8aa6e]">0</div>
                </div>
            </div>

            <div class="panel rounded p-3 cursor-pointer" onclick="ui.openRepInfo()">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2 text-xs text-[#a0a0a0] uppercase tracking-widest">
                        <i class="fas fa-scale-balanced text-[#c8aa6e]"></i>
                        Репутация
                    </div>
                    <div class="text-sm font-bold text-[#c8aa6e]"><span id="rep-value">0</span>/100</div>
                </div>
                <div class="h-2 bg-[#000] border border-[#333] rounded-full overflow-hidden">
                    <div id="rep-bar" class="h-full bg-gradient-to-r from-emerald-700 to-[#c8aa6e] w-0 transition-all duration-300"></div>
                </div>
                <div id="rep-rank" class="text-[10px] text-[#777] mt-2">Безымянный странник</div>
            </div>
            
            <!-- Active Effects Display -->
            <div id="active-effects-container" class="grid grid-cols-2 gap-2 hidden">
                <div id="effect-immortality" class="panel p-2 rounded flex items-center gap-2 border-red-500/50 hidden">
                    <i class="fas fa-heart text-red-500 animate-pulse"></i>
                    <div>
                        <div class="text-[10px] text-red-400 font-bold uppercase">Бессмертие</div>
                        <div class="text-[10px] text-gray-400" id="timer-immortality">00:00</div>
                    </div>
                </div>
                <div id="effect-luck" class="panel p-2 rounded flex items-center gap-2 border-green-500/50 hidden">
                    <i class="fas fa-clover text-green-500 animate-pulse"></i>
                    <div>
                        <div class="text-[10px] text-green-400 font-bold uppercase">Удача x2</div>
                        <div class="text-[10px] text-gray-400" id="timer-luck">00:00</div>
                    </div>
                </div>
                <div id="effect-measles" class="panel p-2 rounded flex items-center gap-2 border-red-500/50 hidden">
                    <i class="fas fa-virus text-red-500 animate-pulse"></i>
                    <div>
                        <div class="text-[10px] text-red-400 font-bold uppercase">Корь</div>
                        <div class="text-[10px] text-gray-400">-1 HP каждые 20 сек</div>
                    </div>
                </div>
            </div>

             <!-- Integrated Inventory & Crafting & Skills -->
             <div class="panel rounded p-4">
                <div class="flex gap-2 mb-4">
                    <button onclick="ui.switchCharTab('inventory')" id="btn-tab-inv" class="flex-1 bg-[#2c2c30] border border-[#c8aa6e] text-[#c8aa6e] py-1 rounded text-xs uppercase font-serif transition-colors">Инвентарь</button>
                    <button onclick="ui.switchCharTab('skills')" id="btn-tab-skills" class="flex-1 bg-[#1a1a1d] border border-[#333] text-[#777] py-1 rounded text-xs uppercase font-serif transition-colors">Навыки</button>
                </div>
                
                <!-- Inventory UI -->
                <div id="ui-inventory">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="medieval-font text-sm text-[#c8aa6e]">Рюкзак</h3>
                    </div>
                    <!-- Inventory Tabs -->
                    <div class="flex items-center gap-2 overflow-x-auto pb-2 mb-2 no-scrollbar">
                        <button onclick="inventory.switchCategory('tools')" id="tab-inv-tools" class="sub-tab active">Инструменты</button>
                        <button onclick="inventory.switchCategory('combat')" id="tab-inv-combat" class="sub-tab">Мечи/Броня</button>
                        <button onclick="inventory.switchCategory('amulets')" id="tab-inv-amulets" class="sub-tab">Амулеты</button>
                        <button onclick="inventory.switchCategory('potions')" id="tab-inv-potions" class="sub-tab">Зелья</button>
                        <button onclick="inventory.switchCategory('other')" id="tab-inv-other" class="sub-tab">Другое</button>
                    </div>

                    <div id="inventory-grid" class="grid grid-cols-4 gap-2">
                        <!-- Slots populated by JS -->
                    </div>
                    <div class="mt-2">
                        <div class="flex items-center justify-between text-[10px] text-[#a0a0a0] mb-1">
                            <span>Нагрузка</span>
                            <span id="weight-text" class="text-[#c8aa6e] font-bold">0 / 100 кг</span>
                        </div>
                        <div class="h-1.5 bg-[#000] border border-[#333] rounded-full overflow-hidden">
                            <div id="weight-bar" class="h-full bg-gradient-to-r from-emerald-700 to-[#c8aa6e] w-0 transition-all duration-300"></div>
                        </div>
                    </div>
                    <p class="text-[10px] text-[#777] mt-2">Вместимость рюкзака можно улучшать через крафт (рецепт продается в Книжном Доме).</p>
                    
                    <!-- Crafting UI moved to separate panel below -->
                    <div class="panel rounded p-4 mt-4 relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-b from-black/10 via-black/30 to-black/60"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_25%_15%,rgba(200,170,110,0.12),transparent_60%)]"></div>
                        <div class="relative">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="medieval-font text-sm text-[#c8aa6e]"><i class="fas fa-hammer mr-1"></i> Крафт</h3>
                            </div>
                            <div id="ui-crafting">
                                <div class="flex items-center gap-2 overflow-x-auto pb-2 mb-2 no-scrollbar">
                                    <button onclick="crafting.switchCategory('potions')" id="tab-craft-potions" class="sub-tab active">Зелья</button>
                                    <button onclick="crafting.switchCategory('amulets')" id="tab-craft-amulets" class="sub-tab">Амулеты</button>
                                    <button onclick="crafting.switchCategory('tools')" id="tab-craft-tools" class="sub-tab">Материалы</button>
                                    <button onclick="crafting.switchCategory('food')" id="tab-craft-food" class="sub-tab">Еда</button>
                                    <button onclick="crafting.switchCategory('other')" id="tab-craft-other" class="sub-tab">Другое</button>
                                </div>
                                <div id="crafting-list" class="space-y-3">
                                    <div class="text-center text-xs text-gray-500 py-4">Нет рецептов</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Skills UI -->
                <div id="ui-skills" class="hidden space-y-3">
                    <div class="flex justify-between items-center p-2 bg-black/20 rounded border border-[#333]">
                        <span class="text-sm text-[#a0a0a0]"><i class="fas fa-star text-yellow-500 mr-1"></i> Жетоны навыков</span>
                        <span class="text-xl font-bold text-[#c8aa6e]" id="skill-points-display">0</span>
                    </div>

                    <!-- Max HP -->
                    <div class="panel p-3 rounded flex justify-between items-center bg-[#151518]">
                        <div>
                            <div class="text-[#e0e0e0] font-bold text-xs"><i class="fas fa-heart text-red-500 mr-1"></i> Живучесть</div>
                            <div class="text-[10px] text-[#777]">+20 Макс. здоровья</div>
                        </div>
                        <button onclick="skills.upgrade('hp')" class="bg-[#222] border border-[#c8aa6e] text-[#c8aa6e] px-3 py-1 text-[10px] rounded hover:bg-[#c8aa6e] hover:text-black transition-colors uppercase">
                            1 Жетон
                        </button>
                    </div>
                    
                    <!-- Luck -->
                    <div class="panel p-3 rounded flex justify-between items-center bg-[#151518]">
                        <div>
                            <div class="text-[#e0e0e0] font-bold text-xs"><i class="fas fa-clover text-green-500 mr-1"></i> Удача (Ур <span id="luck-display">0</span>)</div>
                            <div class="text-[10px] text-[#777]">Больше шансов на добычу</div>
                        </div>
                        <button onclick="skills.upgrade('luck')" class="bg-[#222] border border-[#c8aa6e] text-[#c8aa6e] px-3 py-1 text-[10px] rounded hover:bg-[#c8aa6e] hover:text-black transition-colors uppercase">
                            1 Жетон
                        </button>
                    </div>

                     <!-- Agility -->
                    <div class="panel p-3 rounded flex justify-between items-center bg-[#151518]">
                        <div>
                            <div class="text-[#e0e0e0] font-bold text-xs"><i class="fas fa-person-running text-blue-400 mr-1"></i> Ловкость (Ур <span id="agility-display">0</span>)</div>
                            <div class="text-[10px] text-[#777]">Меньше шанс травмы</div>
                        </div>
                        <button onclick="skills.upgrade('agility')" class="bg-[#222] border border-[#c8aa6e] text-[#c8aa6e] px-3 py-1 text-[10px] rounded hover:bg-[#c8aa6e] hover:text-black transition-colors uppercase">
                            1 Жетон
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Secret Game Title (10 clicks to open dev panel) -->
            <div class="text-center mt-6 pb-4">
                <div class="game-title-secret text-[10px] text-gray-700 medieval-font tracking-wider" onclick="devPanel.handleSecretClick()">
                    Medieval Legacy
                </div>
            </div>
        </section>

        <!-- VIEW: MAP -->
        <section id="view-map" class="space-y-4">
            <h2 class="medieval-font text-2xl text-center mb-6 text-[#c8aa6e]">Карта Мира</h2>
            
            <div class="space-y-4">
                <div class="flex items-center gap-2 text-[11px] text-[#c8aa6e] uppercase tracking-[0.3em]">
                    <i class="fas fa-city"></i>
                    Город
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <!-- Jobs -->
                    <button onclick="router.navigate('jobs')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-black/30 backdrop-blur-sm">
                        <img 
                          src="https://i.postimg.cc/zvrrJHQg/IMG-4559.jpg"
                          alt="Работы"
                          class="absolute inset-0 w-full h-full object-cover opacity-35 witcher-img"
                          onerror="this.onerror=null; this.style.display='none';"
                        />
                        <div class="absolute inset-0 bg-gradient-to-b from-black/10 via-black/40 to-black/70"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(30,144,255,0.18),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-[#1E90FF]/20 flex items-center justify-center">
                            <i class="fas fa-chevron-right text-[#7fb7ff]/70 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-[#0e3a6b]/70 to-[#0b2a55] flex items-center justify-center border-2 border-[#1E90FF]/60 shadow-[0_0_20px_rgba(30,144,255,0.35)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-hammer text-[#1E90FF] text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-[#dbeafe] drop-shadow-lg text-center">Работы</h3>
                            <p class="text-[9px] text-[#90c2ff]/70 text-center mt-0.5">Порт, Поле, Шахта</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-[#1E90FF]/50 to-transparent"></div>
                    </button>

                    <!-- Town Square -->
                    <button onclick="router.navigate('town-square')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-black/30 backdrop-blur-sm">
                        <img 
                          src="https://i.postimg.cc/BnPztnfV/IMG-4542.jpg"
                          alt="Городская площадь"
                          class="absolute inset-0 w-full h-full object-cover opacity-35 witcher-img"
                          onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1697730268732-1bb29e0bb8f6?w=1200&q=85';"
                        />
                        <div class="absolute inset-0 bg-gradient-to-b from-black/10 via-black/40 to-black/70"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(139,69,19,0.2),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-[#8B4513]/20 flex items-center justify-center">
                            <i class="fas fa-chevron-right text-[#d2a679]/70 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-[#5a2d0f]/70 to-[#3b1f0b] flex items-center justify-center border-2 border-[#8B4513]/60 shadow-[0_0_20px_rgba(139,69,19,0.35)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-landmark text-[#c47a2c] text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-[#f5e1c9] drop-shadow-lg text-center">Городская площадь</h3>
                            <p class="text-[9px] text-[#cfa57a]/70 text-center mt-0.5">Милостыня, слухи</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-[#8B4513]/50 to-transparent"></div>
                    </button>

                    <!-- Tavern -->
                    <button onclick="router.navigate('tavern')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-black/30 backdrop-blur-sm">
                        <img 
                          src="https://i.postimg.cc/kGckq181/IMG-4560.jpg"
                          alt="Таверна"
                          class="absolute inset-0 w-full h-full object-cover opacity-35 witcher-img"
                          onerror="this.onerror=null; this.style.display='none';"
                        />
                        <div class="absolute inset-0 bg-gradient-to-b from-black/10 via-black/40 to-black/70"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(249,115,22,0.15),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-orange-600/20 flex items-center justify-center">
                            <i class="fas fa-chevron-right text-orange-500/60 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-orange-900/60 to-orange-950 flex items-center justify-center border-2 border-orange-500/60 shadow-[0_0_20px_rgba(249,115,22,0.3)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-beer-mug-empty text-orange-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-orange-100 drop-shadow-lg text-center">Таверна</h3>
                            <p class="text-[9px] text-orange-300/60 text-center mt-0.5">Отдых и игры</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-orange-500/40 to-transparent"></div>
                    </button>

                    <!-- Treasury -->
                    <button onclick="router.navigate('treasury')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-black/30 backdrop-blur-sm">
                        <img 
                          src="https://i.postimg.cc/hvS5yLws/IMG-4561.jpg"
                          alt="Казна"
                          class="absolute inset-0 w-full h-full object-cover opacity-35 witcher-img"
                          onerror="this.onerror=null; this.style.display='none';"
                        />
                        <div class="absolute inset-0 bg-gradient-to-b from-black/10 via-black/40 to-black/70"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(234,179,8,0.15),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-yellow-600/20 flex items-center justify-center">
                            <i class="fas fa-chevron-right text-yellow-500/60 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-yellow-900/60 to-yellow-950 flex items-center justify-center border-2 border-yellow-500/60 shadow-[0_0_20px_rgba(234,179,8,0.3)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-coins text-yellow-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-yellow-100 drop-shadow-lg text-center">Казна</h3>
                            <p class="text-[9px] text-yellow-300/60 text-center mt-0.5">Обмен, хранилище</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-yellow-500/40 to-transparent"></div>
                    </button>

                    <!-- Healer's Hut -->
                    <button onclick="router.navigate('healer')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-black/30 backdrop-blur-sm">
                        <img 
                          src="https://i.postimg.cc/rpXgZGRd/IMG-4564.jpg"
                          alt="Хижина лекаря"
                          class="absolute inset-0 w-full h-full object-cover opacity-35 witcher-img"
                          onerror="this.onerror=null; this.style.display='none';"
                        />
                        <div class="absolute inset-0 bg-gradient-to-b from-black/10 via-black/40 to-black/70"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(239,68,68,0.15),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-red-600/20 flex items-center justify-center">
                            <i class="fas fa-chevron-right text-red-500/60 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-red-900/60 to-red-950 flex items-center justify-center border-2 border-red-500/60 shadow-[0_0_20px_rgba(239,68,68,0.3)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-mortar-pestle text-red-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-red-100 drop-shadow-lg text-center">Хижина Лекаря</h3>
                            <p class="text-[9px] text-red-300/60 text-center mt-0.5">Лечение и зелья</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-red-500/40 to-transparent"></div>
                    </button>

                    <!-- Royal Castle -->
                    <button onclick="router.navigate('royal-castle')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-black/30 backdrop-blur-sm">
                        <img 
                          src="https://i.postimg.cc/JnqyJXkK/IMG-4567.jpg"
                          alt="Королевский замок"
                          class="absolute inset-0 w-full h-full object-cover opacity-35 witcher-img"
                          onerror="this.onerror=null; this.style.display='none';"
                        />
                        <div class="absolute inset-0 bg-gradient-to-b from-black/10 via-black/40 to-black/70"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(99,102,241,0.15),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-indigo-600/20 flex items-center justify-center">
                            <i class="fas fa-chevron-right text-indigo-500/60 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-indigo-900/60 to-indigo-950 flex items-center justify-center border-2 border-indigo-500/60 shadow-[0_0_20px_rgba(99,102,241,0.3)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-chess-rook text-indigo-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-indigo-100 drop-shadow-lg text-center">Королевский замок</h3>
                            <p class="text-[9px] text-indigo-300/60 text-center mt-0.5">Для знати</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-indigo-500/40 to-transparent"></div>
                    </button>

                    <!-- Noble Quarter -->
                    <button onclick="router.navigate('noble-quarter')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-black/30 backdrop-blur-sm">
                        <img 
                          src="https://i.postimg.cc/hv51LVqc/IMG-4565.jpg"
                          alt="Дворянский квартал"
                          class="absolute inset-0 w-full h-full object-cover opacity-35 witcher-img"
                          onerror="this.onerror=null; this.style.display='none';"
                        />
                        <div class="absolute inset-0 bg-gradient-to-b from-black/10 via-black/40 to-black/70"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(202,138,4,0.15),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-yellow-600/20 flex items-center justify-center">
                            <i class="fas fa-chevron-right text-yellow-500/60 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-yellow-800/60 to-yellow-950 flex items-center justify-center border-2 border-yellow-500/60 shadow-[0_0_20px_rgba(202,138,4,0.3)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-crown text-yellow-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-yellow-100 drop-shadow-lg text-center">Дворянский квартал</h3>
                            <p class="text-[9px] text-yellow-300/60 text-center mt-0.5">Роскошь и власть</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-yellow-500/40 to-transparent"></div>
                    </button>

                    <!-- Poor District -->
                    <button onclick="router.navigate('poor-district')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-black/30 backdrop-blur-sm">
                        <img 
                          src="https://i.postimg.cc/B6hT32bL/IMG-4566.jpg"
                          alt="Район для бедняков"
                          class="absolute inset-0 w-full h-full object-cover opacity-35 witcher-img"
                          onerror="this.onerror=null; this.style.display='none';"
                        />
                        <div class="absolute inset-0 bg-gradient-to-b from-black/10 via-black/40 to-black/70"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(120,113,108,0.1),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-stone-600/20 flex items-center justify-center">
                            <i class="fas fa-chevron-right text-stone-500/60 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-stone-800/60 to-stone-950 flex items-center justify-center border-2 border-stone-600/60 shadow-[0_0_20px_rgba(120,113,108,0.2)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-house-crack text-stone-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-stone-200 drop-shadow-lg text-center">Район для бедняков</h3>
                            <p class="text-[9px] text-stone-400/60 text-center mt-0.5">Грязные улицы</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-stone-600/40 to-transparent"></div>
                    </button>

                    <!-- Knight Tournament -->
                    <button onclick="router.navigate('knight-tournament')" class="panel col-span-2 p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative h-32 bg-black/30 backdrop-blur-sm">
                        <img 
                          src="https://i.postimg.cc/s2cXkKrW/IMG-4610.jpg"
                          alt="Рыцарский Турнир"
                          class="absolute inset-0 w-full h-full object-cover opacity-35 witcher-img"
                          onerror="this.onerror=null; this.style.display='none';"
                        />
                        <div class="absolute inset-0 bg-gradient-to-b from-black/10 via-black/40 to-black/70"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(217,119,6,0.2),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-amber-700/20 flex items-center justify-center">
                            <i class="fas fa-chevron-right text-amber-500/60 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex items-center justify-between px-6">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-amber-800/70 to-amber-950 flex items-center justify-center border-2 border-amber-500/70 shadow-[0_0_25px_rgba(217,119,6,0.4)] group-hover:scale-110 transition-transform">
                                    <i class="fas fa-chess-knight text-amber-400 text-2xl drop-shadow-lg"></i>
                                </div>
                                <div class="text-left">
                                    <h3 class="medieval-font text-lg text-amber-100 drop-shadow-lg">Рыцарский Турнир</h3>
                                    <p class="text-xs text-amber-300/70 drop-shadow-md">Слава и честь на арене</p>
                                </div>
                            </div>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-amber-500/50 to-transparent"></div>
                    </button>
                </div>

                <div class="flex items-center gap-2 text-[11px] text-[#c8aa6e] uppercase tracking-[0.3em] pt-2">
                    <i class="fas fa-mountain"></i>
                    Предместье
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <!-- Village -->
                    <button id="btn-loc-village" onclick="router.navigate('village')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-black/30 backdrop-blur-sm">
                        <img 
                          src="https://i.postimg.cc/P5BFss9w/IMG-4562.jpg"
                          alt="Деревня"
                          class="absolute inset-0 w-full h-full object-cover opacity-35 witcher-img"
                          onerror="this.onerror=null; this.style.display='none';"
                        />
                        <div class="absolute inset-0 bg-gradient-to-b from-black/10 via-black/40 to-black/70"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(0,128,0,0.2),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-[#008000]/20 flex items-center justify-center">
                            <i id="village-lock-icon" class="fas fa-chevron-right text-[#7ad37a]/70 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-[#0f4a26]/70 to-[#0b2b17] flex items-center justify-center border-2 border-[#008000]/60 shadow-[0_0_20px_rgba(0,128,0,0.35)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-house-chimney text-[#3ddc84] text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-[#def7de] drop-shadow-lg text-center">Деревня на окраине</h3>
                            <p id="village-desc" class="text-[9px] text-[#9fe0a1]/70 text-center mt-0.5">Дом и хозяйство</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-[#008000]/50 to-transparent"></div>
                    </button>

                    <!-- Livestock Trader -->
                    <button id="btn-loc-livestock" onclick="router.navigate('livestock-trader')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-black/30 backdrop-blur-sm">
                        <img 
                          src="https://i.postimg.cc/zvw13wHX/IMG-4569.jpg"
                          alt="Торговец скотом"
                          class="absolute inset-0 w-full h-full object-cover opacity-35 witcher-img"
                          onerror="this.onerror=null; this.style.display='none';"
                        />
                        <div class="absolute inset-0 bg-gradient-to-b from-black/10 via-black/40 to-black/70"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(16,185,129,0.18),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-emerald-600/20 flex items-center justify-center">
                            <i class="fas fa-chevron-right text-emerald-500/70 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-emerald-900/60 to-emerald-950 flex items-center justify-center border-2 border-emerald-500/60 shadow-[0_0_20px_rgba(16,185,129,0.35)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-cow text-emerald-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-emerald-100 drop-shadow-lg text-center">Торговец скотом</h3>
                            <p class="text-[9px] text-emerald-300/60 text-center mt-0.5">Животные и корм</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-emerald-500/40 to-transparent"></div>
                    </button>

                    <!-- Refugee Camp -->
                    <button id="btn-loc-refugee" onclick="router.navigate('refugee-camp')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-black/30 backdrop-blur-sm">
                        <img 
                          src="https://i.postimg.cc/d3CV6T7L/IMG-4568.jpg"
                          alt="Лагерь беженцев"
                          class="absolute inset-0 w-full h-full object-cover opacity-35 witcher-img"
                          onerror="this.onerror=null; this.style.display='none';"
                        />
                        <div class="absolute inset-0 bg-gradient-to-b from-black/10 via-black/40 to-black/70"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(100,116,139,0.1),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-slate-600/20 flex items-center justify-center">
                            <i id="refugee-lock-icon" class="fas fa-lock text-slate-500/60 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-slate-800/60 to-slate-950 flex items-center justify-center border-2 border-slate-600/60 shadow-[0_0_20px_rgba(100,116,139,0.2)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-campground text-slate-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-slate-300 drop-shadow-lg text-center">Лагерь беженцев</h3>
                            <p id="refugee-desc" class="text-[9px] text-slate-500 text-center mt-0.5">Тайное место</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-slate-600/40 to-transparent"></div>
                    </button>

                    <!-- Dark Forest -->
                    <button id="btn-loc-forest" onclick="router.navigate('dark-forest')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-black/30 backdrop-blur-sm">
                        <img 
                          src="https://i.postimg.cc/kGXTFn6F/IMG-4563.jpg"
                          alt="Тёмный лес"
                          class="absolute inset-0 w-full h-full object-cover opacity-35 witcher-img"
                          onerror="this.onerror=null; this.style.display='none';"
                        />
                        <div class="absolute inset-0 bg-gradient-to-b from-black/10 via-black/40 to-black/70"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(168,85,247,0.15),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-purple-600/20 flex items-center justify-center">
                            <i id="forest-lock-icon" class="fas fa-chevron-right text-purple-500/60 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-purple-900/60 to-purple-950 flex items-center justify-center border-2 border-purple-500/60 shadow-[0_0_20px_rgba(168,85,247,0.4)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-tree text-purple-400 text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-purple-100 drop-shadow-lg text-center">Тёмный Лес</h3>
                            <p id="forest-desc" class="text-[9px] text-purple-300/60 text-center mt-0.5">Опасность и травы</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-purple-500/40 to-transparent"></div>
                    </button>

                </div>

                <div class="flex items-center gap-2 text-[11px] text-[#c8aa6e] uppercase tracking-[0.3em] pt-2">
                    <i class="fas fa-tower-observation"></i>
                    Цитадель
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <!-- Training Camp (moved here) -->
                    <button id="btn-loc-camp" onclick="router.navigate('training-camp')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-black/30 backdrop-blur-sm">
                        <img 
                          src="https://i.postimg.cc/C1D36CNf/IMG-4570.jpg"
                          alt="Учебный лагерь"
                          class="absolute inset-0 w-full h-full object-cover opacity-35 witcher-img"
                          onerror="this.onerror=null; this.style.display='none';"
                        />
                        <div class="absolute inset-0 bg-gradient-to-b from-black/10 via-black/40 to-black/70"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(220,38,38,0.15),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-red-700/20 flex items-center justify-center">
                            <i id="camp-lock-icon" class="fas fa-chevron-right text-red-600/60 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-red-800/60 to-red-950 flex items-center justify-center border-2 border-red-600/60 shadow-[0_0_20px_rgba(220,38,38,0.3)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-shield-halved text-red-500 text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-red-100 drop-shadow-lg text-center">Учебный Лагерь</h3>
                            <p id="camp-desc" class="text-[9px] text-red-300/60 text-center mt-0.5">Путь воина</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-red-600/40 to-transparent"></div>
                    </button>

                    <!-- Military Fortress -->
                    <button id="btn-loc-fortress" onclick="router.navigate('military-fortress')" class="panel p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative aspect-square bg-black/30 backdrop-blur-sm">
                        <img 
                          src="https://i.postimg.cc/Ss0582pT/IMG-4571.jpg"
                          alt="Военная Крепость"
                          class="absolute inset-0 w-full h-full object-cover opacity-35 witcher-img"
                          onerror="this.onerror=null; this.style.display='none';"
                        />
                        <div class="absolute inset-0 bg-gradient-to-b from-black/10 via-black/40 to-black/70"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(148,163,184,0.12),transparent_60%)]"></div>
                        <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-slate-600/20 flex items-center justify-center">
                            <i id="fortress-lock-icon" class="fas fa-lock text-slate-500/70 text-[10px]"></i>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-3">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-slate-800/60 to-slate-950 flex items-center justify-center border-2 border-slate-500/60 shadow-[0_0_20px_rgba(148,163,184,0.25)] mb-2 group-hover:scale-110 transition-transform">
                                <i class="fas fa-tower-observation text-slate-300 text-xl drop-shadow-lg"></i>
                            </div>
                            <h3 class="medieval-font text-sm text-slate-100 drop-shadow-lg text-center">Военная Крепость</h3>
                            <p id="fortress-desc" class="text-[9px] text-slate-300/60 text-center mt-0.5">Только для обученных</p>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-slate-500/40 to-transparent"></div>
                    </button>

                    <!-- Online Mode (Soon) -->
                    <button onclick="ui.showFloatText(this, 'Скоро', '#777')" class="panel col-span-2 p-0 rounded-lg overflow-hidden group hover:border-[#c8aa6e] transition-all relative h-20 bg-gradient-to-br from-[#1a1a1d] via-[#121214] to-[#0f0f10]">
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(200,170,110,0.12),transparent_60%)]"></div>
                        <div class="absolute inset-0 bg-gradient-to-b from-black/10 via-black/30 to-black/60"></div>
                        <div class="absolute inset-0 flex items-center justify-between px-5">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full bg-[#111] border border-[#c8aa6e]/40 flex items-center justify-center shadow-[0_0_18px_rgba(200,170,110,0.18)]">
                                    <i class="fas fa-globe text-[#c8aa6e] text-lg"></i>
                                </div>
                                <div class="text-left">
                                    <div class="medieval-font text-sm text-[#e0e0e0]">Онлайн режим</div>
                                    <div class="text-[10px] text-[#777]">Скоро</div>
                                </div>
                            </div>
                            <div class="text-[10px] px-2 py-1 rounded border border-[#333] bg-black/30 text-[#777] uppercase tracking-widest">
                                Скоро
                            </div>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-[#c8aa6e]/30 to-transparent"></div>
                    </button>
                </div>
            </div>
        </section>

        <!-- SUB-VIEW: JOBS -->
        <section id="view-jobs" class="hidden space-y-4">
            <!-- Header with Gradient -->
            <div class="loc-hero h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm" data-loc="jobs" style="--hero-img: none;">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(30,144,255,0.25),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-[#1E90FF]/60 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-[#1E90FF]/40 bg-black/30 flex items-center justify-center text-[#7fb7ff] hover:bg-[#1E90FF]/20 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-[#0e3a6b]/70 to-[#0b2a55] flex items-center justify-center border-2 border-[#1E90FF]/60 shadow-[0_0_15px_rgba(30,144,255,0.35)]">
                        <i class="fas fa-hammer text-[#1E90FF] text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-[#dbeafe] drop-shadow-md">Работы</h2>
                </div>
            </div>

            <!-- The Port -->
            <div id="job-port" class="panel rounded-lg p-0 relative overflow-hidden h-40 group">
                <div class="absolute inset-0 bg-[url('https://i.postimg.cc/6Q8ndMmr/IMG-4591.jpg')] bg-cover bg-center opacity-30 group-hover:opacity-40 transition-opacity"></div>
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(30,144,255,0.25),transparent_60%)]"></div>
                <div class="absolute inset-0 bg-black/30"></div>
                <div class="absolute inset-0 p-4 flex flex-col justify-between">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="medieval-font text-lg text-white drop-shadow-md">Порт</h3>
                            <p class="text-xs text-gray-300 drop-shadow-md">Ловля рыбы для рынка.</p>
                            <p class="text-xs text-[#c8aa6e] mt-1 drop-shadow-md" id="job-info-port">Требуется: Удочка</p>
                        </div>
                        <span class="text-xs bg-green-900/80 text-green-200 px-2 py-0.5 rounded border border-green-800 backdrop-blur-sm">Ур 1</span>
                    </div>
                    <div>
                        <div class="flex items-center gap-4 mb-3">
                            <div class="text-sm text-[#e0e0e0] flex items-center gap-1 drop-shadow-md">
                                <i class="fas fa-fish"></i> <span id="reward-port" class="font-bold">1-2 Рыбы</span>
                            </div>
                            <div class="text-sm text-blue-400 flex items-center gap-1 drop-shadow-md">
                                <i class="fas fa-star"></i> +1 XP
                            </div>
                        </div>
                        <button id="btn-work-port" onclick="game.work('port', event)" class="job-button w-full py-2 rounded font-bold shadow-lg">
                            <i class="fas fa-fish mr-2"></i> Рыбачить
                        </button>
                    </div>
                </div>
            </div>

            <!-- The Loader (Unlocked by Alex) -->
            <div id="job-loader" class="panel rounded-lg p-0 relative overflow-hidden h-40 group hidden">
                <div class="absolute inset-0 bg-[url('https://i.postimg.cc/kG0pmVtr/IMG-4592.jpg')] bg-cover bg-center opacity-30 group-hover:opacity-40 transition-opacity"></div>
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(30,144,255,0.25),transparent_60%)]"></div>
                <div class="absolute inset-0 bg-black/30"></div>
                <div class="absolute inset-0 p-4 flex flex-col justify-between">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="medieval-font text-lg text-white drop-shadow-md">Грузчик в порту</h3>
                            <p class="text-xs text-gray-300 drop-shadow-md">Разгрузка мешков с зерном.</p>
                            <p class="text-xs text-[#c8aa6e] mt-1 drop-shadow-md" id="job-info-loader"><span class="text-green-500"><i class="fas fa-check"></i> Работа от Алекса</span></p>
                        </div>
                        <span class="text-xs bg-blue-900/80 text-blue-200 px-2 py-0.5 rounded border border-blue-800 backdrop-blur-sm">Ур 3</span>
                    </div>
                    <div>
                        <div class="flex items-center gap-4 mb-3">
                            <div class="text-sm text-[#e0e0e0] flex items-center gap-1 drop-shadow-md">
                                <i class="fas fa-coins"></i> <span id="reward-loader" class="font-bold">6 Золота</span>
                            </div>
                            <div class="text-sm text-blue-400 flex items-center gap-1 drop-shadow-md">
                                <i class="fas fa-star"></i> +2 XP
                            </div>
                            <div class="text-sm text-green-400 flex items-center gap-1 drop-shadow-md">
                                <i class="fas fa-shield-alt"></i> 1% травма
                            </div>
                        </div>
                        <button id="btn-work-loader" onclick="game.work('loader', event)" class="job-button w-full py-2 rounded font-bold shadow-lg">
                            <i class="fas fa-box mr-2"></i> Разгружать
                        </button>
                    </div>
                </div>
            </div>

            <!-- The Field -->
            <div id="job-field" class="panel rounded-lg p-0 relative overflow-hidden h-40 opacity-50 group">
                <div class="absolute inset-0 bg-[url('https://i.postimg.cc/446tb7WK/IMG-4588.jpg')] bg-cover bg-center opacity-30 group-hover:opacity-40 transition-opacity"></div>
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(200,170,110,0.25),transparent_60%)]"></div>
                <div class="absolute inset-0 bg-black/30"></div>
                 <div class="absolute inset-0 p-4 flex flex-col justify-between">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="medieval-font text-lg text-white drop-shadow-md">Пшеничное поле</h3>
                            <p class="text-xs text-gray-300 drop-shadow-md">Сбор урожая под солнцем.</p>
                            <p class="text-xs text-[#c8aa6e] mt-1 drop-shadow-md" id="job-info-field">Требуется: Серп</p>
                        </div>
                        <span class="text-xs bg-gray-800/80 text-gray-400 px-2 py-0.5 rounded border border-gray-700 backdrop-blur-sm">Ур 5</span>
                    </div>
                    
                    <div>
                        <div class="flex items-center gap-4 mb-3">
                            <div class="text-sm text-[#e0e0e0] flex items-center gap-1 drop-shadow-md">
                                <i class="fas fa-wheat-awn"></i> <span id="reward-field" class="font-bold">1-2 Пшеницы</span>
                            </div>
                            <div class="text-sm text-blue-400 flex items-center gap-1 drop-shadow-md">
                                <i class="fas fa-star"></i> +3 XP
                            </div>
                        </div>
                        <button id="btn-work-field" disabled onclick="game.work('field', event)" class="job-button w-full py-2 rounded font-bold flex items-center justify-center gap-2 shadow-lg">
                            <i class="fas fa-lock text-xs"></i> Закрыто
                        </button>
                    </div>
                </div>
            </div>

            <!-- The Mine -->
            <div id="job-mine" class="panel rounded-lg p-0 relative overflow-hidden h-40 opacity-50 group">
                <div class="absolute inset-0 bg-[url('https://i.postimg.cc/dVxTt8Vg/IMG-4589.jpg')] bg-cover bg-center opacity-30 group-hover:opacity-40 transition-opacity"></div>
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(16,185,129,0.25),transparent_60%)]"></div>
                <div class="absolute inset-0 bg-black/30"></div>
                 <div class="absolute inset-0 p-4 flex flex-col justify-between">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="medieval-font text-lg text-white drop-shadow-md">Железный рудник</h3>
                            <p class="text-xs text-gray-300 drop-shadow-md">Опасная работа в темноте.</p>
                            <p class="text-xs text-[#c8aa6e] mt-1 drop-shadow-md" id="job-info-mine">Требуется: Кирка</p>
                        </div>
                        <span class="text-xs bg-gray-800/80 text-gray-400 px-2 py-0.5 rounded border border-gray-700 backdrop-blur-sm">Ур 15</span>
                    </div>
                    
                    <div>
                        <div class="flex items-center gap-4 mb-3">
                            <div class="text-sm text-[#e0e0e0] flex items-center gap-1 drop-shadow-md">
                                <i class="fas fa-cube"></i> <span id="reward-mine" class="font-bold">1-2 Руды</span>
                            </div>
                            <div class="text-sm text-blue-400 flex items-center gap-1 drop-shadow-md">
                                <i class="fas fa-star"></i> +8 XP
                            </div>
                            <div class="text-[11px] text-emerald-400 flex items-center gap-1 drop-shadow-md">
                                <i class="far fa-gem gem-price"></i> Шанс найти изумруды
                            </div>
                        </div>
                        <button id="btn-work-mine" disabled onclick="game.work('mine', event)" class="job-button w-full py-2 rounded font-bold flex items-center justify-center gap-2 shadow-lg">
                            <i class="fas fa-lock text-xs"></i> Закрыто
                        </button>
                    </div>
                </div>
            </div>

            <!-- The Hunter -->

        </section>

        <!-- VIEW: DARK FOREST -->
        <section id="view-dark-forest" class="hidden space-y-4">
            <div class="loc-hero h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm" data-loc="dark-forest" style="--hero-img: none;">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(168,85,247,0.2),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-purple-500/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-purple-900/50 bg-black/30 flex items-center justify-center text-purple-400 hover:bg-purple-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-900/60 to-purple-950 flex items-center justify-center border-2 border-purple-500/60 shadow-[0_0_15px_rgba(168,85,247,0.4)]">
                        <i class="fas fa-tree text-purple-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-purple-300 drop-shadow-md">Тёмный Лес</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-4 space-y-4 bg-gradient-to-b from-[#1a1a1d] to-[#100b14] border-purple-900/30">
                <div class="text-center">
                    <p class="text-sm text-[#e0e0e0]">Мрачные деревья скрывают опасности...</p>
                    <p class="text-xs text-purple-400">И редкие ингредиенты.</p>
                </div>

                <!-- Forest NPC -->
                <div class="panel p-3 rounded flex items-center justify-between border-purple-900/30 bg-purple-900/10">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full border border-purple-500 bg-[#222] flex items-center justify-center">
                            <i class="fas fa-hood-cloak text-purple-400"></i>
                        </div>
                        <div>
                            <div class="text-base text-[#e0e0e0] font-bold medieval-font">Элара</div>
                            <div class="text-[10px] text-[#a0a0a0]">Следопыт</div>
                        </div>
                    </div>
                    <button onclick="dialogue.start('elara')" class="btn-medieval px-4 py-1.5 rounded text-xs">
                        Говорить
                    </button>
                </div>

                <!-- Gather Resources -->
                <div class="p-3 border border-[#333] rounded bg-black/20 flex flex-col gap-2">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded bg-[#222] flex items-center justify-center text-emerald-500">
                                <i class="fas fa-leaf"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-sm text-gray-200">Собирательство</h4>
                                <p class="text-[10px] text-gray-500">Палки, камни, травы и грибы.</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="locations.forestGather(event)" class="btn-medieval w-full py-2 rounded text-xs border-emerald-900 text-emerald-500 hover:bg-emerald-900/20">
                        Искать (-5 HP)
                    </button>
                    <div class="flex justify-between text-[10px] text-gray-500 px-1">
                        <span>Награда: Ресурсы</span>
                        <span>+3 XP</span>
                    </div>
                </div>

                <!-- Hunt Monsters -->
                <div class="p-3 border border-purple-900/50 rounded bg-purple-900/10 flex flex-col gap-2 relative overflow-hidden">
                    <div class="absolute -right-2 -top-2 text-6xl text-purple-900 opacity-20 pointer-events-none">
                        <i class="fas fa-dragon"></i>
                    </div>
                    <div class="flex justify-between items-center z-10">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded bg-[#222] flex items-center justify-center text-purple-500 border border-purple-900">
                                <i class="fas fa-skull"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-sm text-gray-200">Охота</h4>
                                <p class="text-[10px] text-gray-500">Углубиться в чащу леса.</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="locations.forestHunt(event)" class="btn-medieval w-full py-2 rounded text-xs border-red-900 text-red-500 hover:bg-red-900/20 z-10">
                        Сразиться (-10 HP)
                    </button>
                    <div class="flex justify-between text-[10px] text-gray-500 px-1 z-10">
                        <span>Награда: Кожа/Мясо</span>
                        <span>+20 XP</span>
                    </div>
                </div>

                <!-- Hunter's Hut -->
                <div class="panel p-3 rounded border-amber-900/30 bg-amber-900/10">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full border border-amber-600/60 bg-amber-950/50 flex items-center justify-center">
                                <i class="fas fa-home text-amber-500"></i>
                            </div>
                            <div>
                                <div class="text-base text-[#e0e0e0] font-bold">Хижина охотника</div>
                                <div class="text-[10px] text-amber-400">Тайное убежище</div>
                            </div>
                        </div>
                        <button onclick="router.navigate('hunter-hut')" class="btn-medieval px-4 py-1.5 rounded text-xs border-amber-600 text-amber-400">
                            Войти
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: HUNTER'S HUT -->
        <section id="view-hunter-hut" class="hidden space-y-4">
            <div class="loc-hero h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm" data-loc="hunter-hut" style="--hero-img: url('https://i.postimg.cc/kGXTFn6F/IMG-4563.jpg');">
                <div class="absolute inset-0 bg-gradient-to-b from-amber-950/40 via-transparent to-black/60"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-amber-500/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('dark-forest')" class="w-8 h-8 rounded border border-amber-900/50 bg-black/30 flex items-center justify-center text-amber-400 hover:bg-amber-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-900/60 to-amber-950 flex items-center justify-center border-2 border-amber-500/60 shadow-[0_0_15px_rgba(245,158,11,0.4)]">
                        <i class="fas fa-home text-amber-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-amber-300 drop-shadow-md">Хижина охотника</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-4 space-y-4 bg-gradient-to-b from-[#1a1a1d] to-[#1a1208] border-amber-900/30">
                <div class="text-center">
                    <p class="text-sm text-[#e0e0e0]">Уютная хижина опытного охотника...</p>
                    <p class="text-xs text-amber-400">Запах дыма и кожи наполняет воздух.</p>
                </div>

                <!-- Eigan NPC -->
                <div class="panel p-4 rounded border-amber-700/50 bg-gradient-to-br from-amber-950/30 to-amber-900/20 relative overflow-hidden">
                    <div class="absolute -right-8 -bottom-8 text-8xl text-amber-900/10 pointer-events-none">
                        <i class="fas fa-bow-arrow"></i>
                    </div>
                    <div class="flex items-center gap-4 relative z-10">
                        <div class="w-16 h-16 rounded-full border-2 border-amber-600/60 bg-black/40 flex items-center justify-center overflow-hidden">
                            <img src="https://i.postimg.cc/mDDy3F2s/image-Picsart-Background-Remover-(7).png" alt="Эйган" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1">
                            <div class="text-lg text-amber-300 font-bold medieval-font">Эйган</div>
                            <div class="text-xs text-amber-500/80">Охотник и торговец</div>
                            <div class="text-[10px] text-gray-500 mt-1">Эксперт по лесным тайнам</div>
                        </div>
                        <button onclick="dialogue.start('eigan')" class="btn-medieval px-6 py-2 rounded text-sm border-amber-600 text-amber-400 hover:bg-amber-900/30">
                            Поговорить
                        </button>
                    </div>
                </div>

                <!-- Amulet Shop -->
                <div class="panel p-4 rounded border-purple-700/50 bg-gradient-to-br from-purple-950/30 to-purple-900/20">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="fas fa-gem text-purple-400"></i>
                        <h3 class="text-base font-bold text-purple-300 medieval-font">Магические амулеты</h3>
                    </div>
                    
                    <!-- XP Amulet -->
                    <div class="mb-3 p-3 rounded border border-blue-900/50 bg-blue-950/20">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded bg-blue-950/60 border border-blue-700/50 flex items-center justify-center">
                                    <i class="fas fa-star text-blue-400"></i>
                                </div>
                                <div>
                                    <div class="text-sm font-bold text-blue-300">Амулет опыта</div>
                                    <div class="text-[10px] text-blue-400/70">+50% к получаемому опыту</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="text-xs text-emerald-400 flex items-center gap-1">
                                <i class="far fa-gem"></i>
                                <span class="font-bold">200 изумрудов</span>
                            </div>
                            <button onclick="hunterHut.buyAmulet('xp', event)" class="btn-medieval px-4 py-1.5 rounded text-xs border-blue-700 text-blue-400">
                                Купить
                            </button>
                        </div>
                    </div>

                    <!-- Gathering Amulet -->
                    <div class="p-3 rounded border border-emerald-900/50 bg-emerald-950/20">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded bg-emerald-950/60 border border-emerald-700/50 flex items-center justify-center">
                                    <i class="fas fa-leaf text-emerald-400"></i>
                                </div>
                                <div>
                                    <div class="text-sm font-bold text-emerald-300">Амулет добычи</div>
                                    <div class="text-[10px] text-emerald-400/70">+50% к добыче материалов</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="text-xs text-emerald-400 flex items-center gap-1">
                                <i class="far fa-gem"></i>
                                <span class="font-bold">400 изумрудов</span>
                            </div>
                            <button onclick="hunterHut.buyAmulet('gathering', event)" class="btn-medieval px-4 py-1.5 rounded text-xs border-emerald-700 text-emerald-400">
                                Купить
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: TOWN SQUARE -->
        <section id="view-town-square" class="hidden space-y-4">
            <div class="loc-hero h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm" data-loc="town-square" style="--hero-img: none;">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(139,69,19,0.25),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-[#8B4513]/60 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-[#8B4513]/40 bg-black/30 flex items-center justify-center text-[#d2a679] hover:bg-[#8B4513]/20 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-[#5a2d0f]/70 to-[#3b1f0b] flex items-center justify-center border-2 border-[#8B4513]/60 shadow-[0_0_15px_rgba(139,69,19,0.35)]">
                        <i class="fas fa-landmark text-[#c47a2c] text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-[#f5e1c9] drop-shadow-md">Городская площадь</h2>
                </div>
            </div>

            <div class="rounded-lg p-6 text-center space-y-4 border border-amber-700/30" >
                <i class="fas fa-hands text-4xl text-gray-500"></i>
                <div>
                    <p class="text-sm text-[#e0e0e0]">Вы стоите посреди людной площади.</p>
                    <p class="text-xs text-[#a0a0a0]">Иногда прохожие кидают монеты бродягам.</p>
                </div>
                <button onclick="locations.beg(event)" class="btn-medieval w-full py-3 rounded font-bold">
                    <i class="fas fa-hand-holding-medical mr-2"></i> Попрошайничать
                </button>
                <p class="text-[10px] text-gray-600 mb-4">+2 Золота за клик</p>

                <!-- Bulletin Board - Large Button -->
                <div class="mt-4">
                    <button onclick="router.navigate('bulletin')" class="w-full p-0 rounded-lg overflow-hidden group hover:border-amber-500 transition-all relative h-24 border border-amber-700/30" >
                        <img src="https://i.postimg.cc/BbHX1G86/IMG-4606.jpg" alt="Bulletin Board" class="absolute inset-0 w-full h-full object-cover opacity-30">
                        <div class="absolute inset-0 bg-gradient-to-b from-black/70 via-black/60 to-black/80"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(217,119,6,0.2),transparent_60%)]"></div>
                        <div class="absolute inset-0 flex items-center justify-between p-4">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 rounded-full bg-gradient-to-br from-amber-900/60 to-amber-950 border-2 border-amber-500/60 flex items-center justify-center shadow-[0_0_15px_rgba(217,119,6,0.3)]">
                                    <i class="fas fa-clipboard-list text-amber-400 text-2xl"></i>
                                </div>
                                <div class="text-left">
                                    <div class="text-base font-bold text-amber-300 medieval-font">Доска Объявлений</div>
                                    <div class="text-xs text-amber-600/80">Работы, заказы и объявления</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-500 group-hover:text-amber-500 text-xl"></i>
                        </div>
                    </button>
                </div>
                
                <!-- Book House Button -->
                <div class="mt-4">
                     <button onclick="router.navigate('bookhouse')" class="w-full p-0 rounded-lg overflow-hidden group hover:border-blue-500 transition-all relative h-20 border border-blue-700/30" >
                        <img src="https://i.postimg.cc/s2jDDh9j/IMG-4603.jpg" alt="Book House" class="absolute inset-0 w-full h-full object-cover opacity-30">
                        <div class="absolute inset-0 bg-gradient-to-b from-black/70 via-black/60 to-black/80"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(59,130,246,0.18),transparent_60%)]"></div>
                        <div class="absolute inset-0 flex items-center justify-between p-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-[#111] border border-blue-500 flex items-center justify-center">
                                    <i class="fas fa-book text-blue-400"></i>
                                </div>
                                <div class="text-left">
                                    <div class="text-sm font-bold text-[#e0e0e0]">Книжный Дом</div>
                                    <div class="text-[10px] text-[#777]">Рецепты и знания</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-500 group-hover:text-blue-500"></i>
                        </div>
                    </button>
                </div>

                <!-- Tailor Button -->
                <div class="mt-3">
                    <button onclick="router.navigate('tailor')" class="w-full p-0 rounded-lg overflow-hidden group hover:border-pink-500 transition-all relative h-20 border border-pink-700/30" >
                        <img src="https://i.postimg.cc/s1C3FQDt/IMG-4604.jpg" alt="Tailor Workshop" class="absolute inset-0 w-full h-full object-cover opacity-30">
                        <div class="absolute inset-0 bg-gradient-to-b from-black/70 via-black/60 to-black/80"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(236,72,153,0.18),transparent_60%)]"></div>
                        <div class="absolute inset-0 flex items-center justify-between p-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-[#111] border border-pink-500 flex items-center justify-center">
                                    <i class="fas fa-shirt text-pink-400"></i>
                                </div>
                                <div class="text-left">
                                    <div class="text-sm font-bold text-[#e0e0e0]">Мастерская Портного</div>
                                    <div class="text-[10px] text-[#777]">Одежда на заказ</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-500 group-hover:text-pink-500"></i>
                        </div>
                    </button>
                </div>

                <!-- Shoemaker Button -->
                <div class="mt-3">
                    <button onclick="router.navigate('shoemaker')" class="w-full p-0 rounded-lg overflow-hidden group hover:border-amber-500 transition-all relative h-20 border border-amber-700/30" >
                        <img src="https://i.postimg.cc/MpxjVXmz/IMG-4605.jpg" alt="Shoemaker Workshop" class="absolute inset-0 w-full h-full object-cover opacity-30">
                        <div class="absolute inset-0 bg-gradient-to-b from-black/70 via-black/60 to-black/80"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(217,119,6,0.2),transparent_60%)]"></div>
                        <div class="absolute inset-0 flex items-center justify-between p-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-[#111] border border-amber-500 flex items-center justify-center">
                                    <i class="fas fa-shoe-prints text-amber-400"></i>
                                </div>
                                <div class="text-left">
                                    <div class="text-sm font-bold text-[#e0e0e0]">Мастерская Сапожника</div>
                                    <div class="text-[10px] text-[#777]">Обувь и ремонт</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-500 group-hover:text-amber-500"></i>
                        </div>
                    </button>
                </div>
            </div>
        </section>

        <!-- VIEW: BULLETIN BOARD -->
        <section id="view-bulletin" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden">
                <!-- Background Image -->
                <img src="https://i.postimg.cc/BbHX1G86/IMG-4606.jpg" alt="Bulletin Board" class="absolute inset-0 w-full h-full object-cover opacity-30">
                <div class="absolute inset-0 bg-gradient-to-b from-black/70 via-black/60 to-black/80"></div>
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(217,119,6,0.2),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-amber-500/50 to-transparent"></div>
                
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('town-square')" class="w-8 h-8 rounded border border-amber-900/50 bg-black/30 flex items-center justify-center text-amber-400 hover:bg-amber-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-900/60 to-amber-950 flex items-center justify-center border-2 border-amber-500/60 shadow-[0_0_15px_rgba(217,119,6,0.3)]">
                        <i class="fas fa-clipboard-list text-amber-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-amber-300 drop-shadow-md">Доска Объявлений</h2>
                </div>
            </div>

            <div class="panel rounded p-4 space-y-4">
                <div class="text-center mb-4">
                    <i class="fas fa-scroll text-3xl text-amber-500 mb-2"></i>
                    <p class="text-sm text-[#a0a0a0]">Здесь вывешивают объявления о работе и просьбы о помощи.</p>
                </div>

                <!-- Active Bounties/Jobs -->
                <div class="space-y-3">
                    <h3 class="text-xs text-[#777] uppercase border-b border-[#333] pb-1">Срочные заказы</h3>
                    
                    <!-- Bounty 1: Fish -->
                    <div class="market-item-card border rounded p-3">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex gap-3">
                                <i class="fas fa-fish text-blue-400 text-lg mt-1"></i>
                                <div>
                                    <div class="text-sm font-bold text-[#e0e0e0]">Рыба для таверны</div>
                                    <div class="text-[10px] text-[#777]">Старый Бен ищет свежую рыбу.</div>
                                    <div class="text-[10px] text-gray-500 mt-1">Нужно: 10 Рыб</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-yellow-500 font-bold">100 <i class="fas fa-coins"></i></div>
                                <div class="text-[10px] text-blue-400">+15 XP</div>
                            </div>
                        </div>
                        <button onclick="bulletin.acceptQuest('fish_delivery')" class="w-full py-1.5 rounded text-[10px] border border-amber-700/40 bg-black/30 text-amber-300 hover:bg-amber-900/20 backdrop-blur-sm">
                            Взять заказ
                        </button>
                    </div>

                    <!-- Bounty 2: Herbs -->
                    <div class="market-item-card border rounded p-3">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex gap-3">
                                <i class="fas fa-leaf text-green-400 text-lg mt-1"></i>
                                <div>
                                    <div class="text-sm font-bold text-[#e0e0e0]">Травы для лекаря</div>
                                    <div class="text-[10px] text-[#777]">Мариусу нужны свежие травы.</div>
                                    <div class="text-[10px] text-gray-500 mt-1">Нужно: 8 Трав</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-yellow-500 font-bold">80 <i class="fas fa-coins"></i></div>
                                <div class="text-[10px] text-blue-400">+10 XP</div>
                            </div>
                        </div>
                        <button onclick="bulletin.acceptQuest('herbs_delivery')" class="w-full py-1.5 rounded text-[10px] border border-amber-700/40 bg-black/30 text-amber-300 hover:bg-amber-900/20 backdrop-blur-sm">
                            Взять заказ
                        </button>
                    </div>

                    <!-- Bounty 3: Ore -->
                    <div class="market-item-card border rounded p-3">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex gap-3">
                                <i class="fas fa-cube text-gray-400 text-lg mt-1"></i>
                                <div>
                                    <div class="text-sm font-bold text-[#e0e0e0]">Руда для кузнеца</div>
                                    <div class="text-[10px] text-[#777]">Горну нужна железная руда.</div>
                                    <div class="text-[10px] text-gray-500 mt-1">Нужно: 5 Руды</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-yellow-500 font-bold">200 <i class="fas fa-coins"></i></div>
                                <div class="text-[10px] text-blue-400">+25 XP</div>
                            </div>
                        </div>
                        <button onclick="bulletin.acceptQuest('ore_delivery')" class="w-full py-1.5 rounded text-[10px] border border-amber-700/40 bg-black/30 text-amber-300 hover:bg-amber-900/20 backdrop-blur-sm">
                            Взять заказ
                        </button>
                    </div>

                    <!-- Quest 4: Lily's Lost Book -->
                    <div id="lily-book-quest" class="hidden market-item-card border rounded p-3">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex gap-3">
                                <i class="fas fa-book text-pink-400 text-lg mt-1"></i>
                                <div>
                                    <div class="text-sm font-bold text-pink-200">Найдена книга</div>
                                    <div class="text-[10px] text-[#777]">Нашел роскошную книгу. Верну за вознаграждение.</div>
                                    <div class="text-[10px] text-gray-500 mt-1">Награда: 100 золота</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-yellow-500 font-bold">100 <i class="fas fa-coins"></i></div>
                            </div>
                        </div>
                        <button onclick="bulletin.takeLilyBook()" class="w-full py-1.5 rounded text-[10px] border border-pink-700/40 bg-black/30 text-pink-300 hover:bg-pink-900/20 backdrop-blur-sm">
                            Забрать книгу
                        </button>
                    </div>
                </div>

                <!-- Community Notices -->
                <div class="space-y-2 mt-4">
                    <h3 class="text-xs text-[#777] uppercase border-b border-[#333] pb-1">Объявления</h3>
                    
                    <div class="border border-[#333] rounded p-2 bg-black/10 text-[10px] text-gray-400">
                        <i class="fas fa-thumbtack text-red-400 mr-1"></i> "Осторожно! В лесу видели волков." — Стража
                    </div>
                    <div class="border border-[#333] rounded p-2 bg-black/10 text-[10px] text-gray-400">
                        <i class="fas fa-thumbtack text-yellow-400 mr-1"></i> "Куплю кожу. Хорошо плачу." — Бронник
                    </div>
                    <div class="border border-[#333] rounded p-2 bg-black/10 text-[10px] text-gray-400">
                        <i class="fas fa-thumbtack text-blue-400 mr-1"></i> "Ищу помощника на ферму. Обращаться в деревню." — Фермер
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: TAILOR -->
        <section id="view-tailor" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden">
                <!-- Background Image -->
                <img src="https://i.postimg.cc/s1C3FQDt/IMG-4604.jpg" alt="Tailor Workshop" class="absolute inset-0 w-full h-full object-cover opacity-30">
                <div class="absolute inset-0 bg-gradient-to-b from-black/70 via-black/60 to-black/80"></div>
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(236,72,153,0.2),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-pink-500/50 to-transparent"></div>
                
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('town-square')" class="w-8 h-8 rounded border border-pink-900/50 bg-black/30 flex items-center justify-center text-pink-400 hover:bg-pink-900/30 transition-colors backdrop-blur-sm">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-pink-900/60 to-pink-950 flex items-center justify-center border-2 border-pink-500/60 shadow-[0_0_15px_rgba(236,72,153,0.3)]">
                        <i class="fas fa-scissors text-pink-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-pink-300 drop-shadow-md">Мастерская Портного</h2>
                </div>
            </div>

            <!-- Tailor NPC -->
            <div class="panel p-4 rounded-lg border-pink-500/40 bg-black/30 backdrop-blur-sm mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full border-2 border-purple-600/50 overflow-hidden flex-shrink-0" style="background: linear-gradient(135deg, rgba(124,58,237,0.3), rgba(0,0,0,0.5));">
                            <img src="https://i.postimg.cc/50MPG1q6/IMG-4667.png" alt="Питер" class="w-full h-full object-cover object-top">
                        </div>
                    <div>
                        <div class="text-base text-[#e0e0e0] font-bold medieval-font">Портной Питер</div>
                        <div class="text-[10px] text-[#a0a0a0]">Портной</div>
                    </div>
                </div>
                <button onclick="dialogue.start('peter')" class="px-4 py-1.5 rounded text-xs border border-pink-700/40 bg-black/30 text-pink-300 hover:bg-pink-900/20 backdrop-blur-sm">
                    Говорить
                </button>
            </div>

            <div class="panel rounded p-4 space-y-3">
                <h3 class="medieval-font text-sm text-[#c8aa6e]">Одежда на заказ</h3>
                <div class="market-item-card border rounded p-3">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-3">
                            <i class="fas fa-shirt text-[#c8aa6e] text-xl mt-1"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">Одежда крестьянина</div>
                                <div class="text-[10px] text-[#777]">Набор простой чистой одежды.</div>
                            </div>
                        </div>
                        <div class="text-sm text-yellow-400 font-bold">5,000 <i class="fas fa-coins"></i></div>
                    </div>
                    <button onclick="game.buyClothes('peasant', 5000)" class="w-full py-1.5 rounded text-[10px] border border-pink-700/40 bg-black/30 text-pink-300 hover:bg-pink-900/20 backdrop-blur-sm">
                        Купить
                    </button>
                </div>

                <div class="market-item-card border rounded p-3">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-3">
                            <i class="fas fa-shirt text-[#c8aa6e] text-xl mt-1"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">Одежда состоятельного</div>
                                <div class="text-[10px] text-[#777]">Для тех, кто любит выглядеть солидно.</div>
                            </div>
                        </div>
                        <div class="text-sm text-yellow-400 font-bold">50,000 <i class="fas fa-coins"></i></div>
                    </div>
                    <button onclick="game.buyClothes('rich', 50000)" class="w-full py-1.5 rounded text-[10px] border border-pink-700/40 bg-black/30 text-pink-300 hover:bg-pink-900/20 backdrop-blur-sm">
                        Купить
                    </button>
                </div>

                <div class="market-item-card border rounded p-3">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-3">
                            <i class="fas fa-crown text-[#c8aa6e] text-xl mt-1"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">Одежда знати</div>
                                <div class="text-[10px] text-[#777]">Высшее качество для истинной элиты.</div>
                            </div>
                        </div>
                        <div class="text-sm gem-price font-bold">500 <i class="far fa-gem gem-price"></i></div>
                    </div>
                    <button onclick="game.buyClothes('noble', 500)" class="w-full py-1.5 rounded text-[10px] border border-pink-700/40 bg-black/30 text-pink-300 hover:bg-pink-900/20 backdrop-blur-sm">
                        Купить
                    </button>
                </div>
            </div>
        </section>

        <!-- VIEW: SHOEMAKER -->
        <section id="view-shoemaker" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden">
                <!-- Background Image -->
                <img src="https://i.postimg.cc/MpxjVXmz/IMG-4605.jpg" alt="Shoemaker Workshop" class="absolute inset-0 w-full h-full object-cover opacity-30">
                <div class="absolute inset-0 bg-gradient-to-b from-black/70 via-black/60 to-black/80"></div>
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(217,119,6,0.2),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-amber-500/50 to-transparent"></div>
                
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('town-square')" class="w-8 h-8 rounded border border-amber-900/50 bg-black/30 flex items-center justify-center text-amber-400 hover:bg-amber-900/30 transition-colors backdrop-blur-sm">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-900/60 to-amber-950 flex items-center justify-center border-2 border-amber-500/60 shadow-[0_0_15px_rgba(217,119,6,0.3)]">
                        <i class="fas fa-shoe-prints text-amber-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-amber-300 drop-shadow-md">Мастерская Сапожника</h2>
                </div>
            </div>

            <!-- Shoemaker NPC -->
            <div class="panel p-4 rounded-lg border-amber-500/40 bg-black/30 backdrop-blur-sm mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full border-2 border-amber-600/50 overflow-hidden flex-shrink-0" style="background: linear-gradient(135deg, rgba(146,64,14,0.3), rgba(0,0,0,0.5));">
                            <img src="https://i.postimg.cc/brymyT5Z/IMG-4668.png" alt="Лорен" class="w-full h-full object-cover object-top">
                        </div>
                    <div>
                        <div class="text-base text-[#e0e0e0] font-bold medieval-font">Сапожник Лорен</div>
                        <div class="text-[10px] text-[#a0a0a0]">Мастер обуви</div>
                    </div>
                </div>
                <button onclick="dialogue.start('shoemaker')" class="px-4 py-1.5 rounded text-xs border border-amber-700/40 bg-black/30 text-amber-300 hover:bg-amber-900/20 backdrop-blur-sm">
                    Говорить
                </button>
            </div>

            <div class="panel rounded p-4 space-y-3">
                <h3 class="medieval-font text-sm text-[#c8aa6e]">Обувь на заказ</h3>

                <div class="market-item-card border rounded p-3">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-3">
                            <i class="fas fa-shoe-prints text-amber-400 text-xl mt-1"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">Ботинки крестьянина</div>
                                <div class="text-[10px] text-[#777]">Простая крепкая обувь для дороги.</div>
                            </div>
                        </div>
                        <div class="text-sm text-yellow-400 font-bold">4,000 <i class="fas fa-coins"></i></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="shoemaker.buyShoes('peasant')" class="w-full py-1.5 rounded text-[10px] border border-amber-700/40 bg-black/30 text-amber-300 hover:bg-amber-900/20 backdrop-blur-sm">Купить</button>
                        <button onclick="shoemaker.sellShoes('peasant')" class="w-full py-1.5 rounded text-[10px] border border-amber-700/40 bg-black/30 text-amber-300 hover:bg-amber-900/20 backdrop-blur-sm">Продать</button>
                    </div>
                </div>

                <div class="market-item-card border rounded p-3">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-3">
                            <i class="fas fa-shoe-prints text-emerald-400 text-xl mt-1"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">Качественные ботинки</div>
                                <div class="text-[10px] text-[#777]">Удобные, мягкие и прочные.</div>
                            </div>
                        </div>
                        <div class="text-sm gem-price font-bold">100 <i class="far fa-gem gem-price"></i></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="shoemaker.buyShoes('quality')" class="w-full py-1.5 rounded text-[10px] border border-emerald-700/40 bg-black/30 text-emerald-300 hover:bg-emerald-900/20 backdrop-blur-sm">Купить</button>
                        <button onclick="shoemaker.sellShoes('quality')" class="w-full py-1.5 rounded text-[10px] border border-emerald-700/40 bg-black/30 text-emerald-300 hover:bg-emerald-900/20 backdrop-blur-sm">Продать</button>
                    </div>
                </div>

                <div class="market-item-card border rounded p-3">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-3">
                            <i class="fas fa-crown text-yellow-400 text-xl mt-1"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">Элитные ботинки</div>
                                <div class="text-[10px] text-[#777]">Для тех, кто ценит роскошь.</div>
                            </div>
                        </div>
                        <div class="text-sm gem-price font-bold">300 <i class="far fa-gem gem-price"></i></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="shoemaker.buyShoes('elite')" class="w-full py-1.5 rounded text-[10px] border border-yellow-700/40 bg-black/30 text-yellow-300 hover:bg-yellow-900/20 backdrop-blur-sm">Купить</button>
                        <button onclick="shoemaker.sellShoes('elite')" class="w-full py-1.5 rounded text-[10px] border border-yellow-700/40 bg-black/30 text-yellow-300 hover:bg-yellow-900/20 backdrop-blur-sm">Продать</button>
                    </div>
                </div>

                <div class="panel p-3 rounded bg-black/20 border border-[#333] text-[10px] text-[#a0a0a0]">
                    <i class="fas fa-info-circle text-amber-400 mr-1"></i> Старую обувь можно сдать за половину стоимости.
                </div>
            </div>
        </section>

        <!-- VIEW: BOOK HOUSE -->
        <section id="view-bookhouse" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden">
                <!-- Background Image -->
                <img src="https://i.postimg.cc/s2jDDh9j/IMG-4603.jpg" alt="Book House" class="absolute inset-0 w-full h-full object-cover opacity-30">
                <div class="absolute inset-0 bg-gradient-to-b from-black/70 via-black/60 to-black/80"></div>
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(59,130,246,0.2),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-blue-500/50 to-transparent"></div>
                
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('town-square')" class="w-8 h-8 rounded border border-blue-900/50 bg-black/30 flex items-center justify-center text-blue-400 hover:bg-blue-900/30 transition-colors backdrop-blur-sm">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-900/60 to-blue-950 flex items-center justify-center border-2 border-blue-500/60 shadow-[0_0_15px_rgba(59,130,246,0.3)]">
                        <i class="fas fa-book text-blue-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-blue-300 drop-shadow-md">Книжный Дом</h2>
                </div>
            </div>

            <!-- Book House NPC -->
            <div class="panel p-4 rounded-lg border-blue-500/40 bg-black/30 backdrop-blur-sm mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full border-2 border-pink-600/50 overflow-hidden flex-shrink-0" style="background: linear-gradient(135deg, rgba(236,72,153,0.3), rgba(0,0,0,0.5));">
                            <img src="https://i.postimg.cc/yxdCDXtp/image-Picsart-Background-Remover.png" alt="Лили" class="w-full h-full object-cover object-top">
                        </div>
                    <div>
                        <div class="text-base text-[#e0e0e0] font-bold medieval-font">Лили</div>
                        <div class="text-[10px] text-[#a0a0a0]">Хранительница знаний</div>
                    </div>
                </div>
                <button onclick="dialogue.start('lili')" class="px-4 py-1.5 rounded text-xs border border-blue-700/40 bg-black/30 text-blue-300 hover:bg-blue-900/20 backdrop-blur-sm">
                    Говорить
                </button>
            </div>

            <div class="panel rounded p-4 space-y-4">
                <h3 class="medieval-font text-sm text-[#c8aa6e] border-b border-[#333] pb-2">Рецепты в продаже</h3>
                
                <!-- Food Recipe -->
                <div class="market-item-card border rounded p-3">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-3">
                            <i class="fas fa-drumstick-bite text-amber-400 text-xl mt-1"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">Рецепт: Жаркое</div>
                                <div class="text-[10px] text-[#777]">Готовьте еду из мяса. +30 HP</div>
                                <div class="text-[10px] text-gray-500 mt-1">Требуется: 2 Мяса</div>
                            </div>
                        </div>
                        <div class="text-sm gem-price font-bold">50 <i class="far fa-gem gem-price"></i></div>
                    </div>
                    <button id="btn-buy-recipe-food" onclick="game.buyRecipe('food', 50)" class="w-full py-1.5 rounded text-[10px] border border-blue-700/40 bg-black/30 text-blue-300 hover:bg-blue-900/20 backdrop-blur-sm">
                        Купить Рецепт
                    </button>
                </div>

                <!-- Sword Recipe -->
                <div class="market-item-card border rounded p-3">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-3">
                            <i class="fas fa-gavel text-gray-400 text-xl mt-1"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">Рецепт: Самодельный Меч</div>
                                <div class="text-[10px] text-[#777]">Создайте простое оружие. +5 Урона</div>
                                <div class="text-[10px] text-gray-500 mt-1">Требуется: 3 Руды, 2 Палки</div>
                            </div>
                        </div>
                        <div class="text-sm gem-price font-bold">100 <i class="far fa-gem gem-price"></i></div>
                    </div>
                    <button id="btn-buy-recipe-sword" onclick="game.buyRecipe('sword', 100)" class="w-full py-1.5 rounded text-[10px] border border-blue-700/40 bg-black/30 text-blue-300 hover:bg-blue-900/20 backdrop-blur-sm">
                        Купить Рецепт
                    </button>
                </div>

                <!-- Leather Armor Recipe -->
                <div class="market-item-card border rounded p-3">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-3">
                            <i class="fas fa-vest text-amber-600 text-xl mt-1"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">Рецепт: Кожаная Броня</div>
                                <div class="text-[10px] text-[#777]">Защитная броня из кожи. +10 Защиты</div>
                                <div class="text-[10px] text-gray-500 mt-1">Требуется: 5 Кожи</div>
                            </div>
                        </div>
                        <div class="text-sm gem-price font-bold">150 <i class="far fa-gem gem-price"></i></div>
                    </div>
                    <button id="btn-buy-recipe-armor" onclick="game.buyRecipe('armor', 150)" class="w-full py-1.5 rounded text-[10px] border border-blue-700/40 bg-black/30 text-blue-300 hover:bg-blue-900/20 backdrop-blur-sm">
                        Купить Рецепт
                    </button>
                </div>

                <!-- Upgraded Bag Recipe -->
                <div class="market-item-card border rounded p-3">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-3">
                            <i class="fas fa-suitcase text-yellow-500 text-xl mt-1"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">Рецепт: Улучшенная Сумка</div>
                                <div class="text-[10px] text-[#777]">Больше места в инвентаре. +8 слотов</div>
                                <div class="text-[10px] text-gray-500 mt-1">Требуется: 3 Кожи, 2 Палки</div>
                            </div>
                        </div>
                        <div class="text-sm gem-price font-bold">200 <i class="far fa-gem gem-price"></i></div>
                    </div>
                    <button id="btn-buy-recipe-bag" onclick="game.buyRecipe('bag', 200)" class="w-full py-1.5 rounded text-[10px] border border-blue-700/40 bg-black/30 text-blue-300 hover:bg-blue-900/20 backdrop-blur-sm">
                        Купить Рецепт
                    </button>
                </div>
            </div>
        </section>

        <!-- VIEW: HEALER -->
        <section id="view-healer" class="hidden space-y-4">
            <div class="loc-hero h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm" data-loc="healer" style="--hero-img: none;">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(239,68,68,0.15),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-red-500/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-red-900/50 bg-black/30 flex items-center justify-center text-red-400 hover:bg-red-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-900/60 to-red-950 flex items-center justify-center border-2 border-red-500/60 shadow-[0_0_15px_rgba(239,68,68,0.3)]">
                        <i class="fas fa-mortar-pestle text-red-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-red-300 drop-shadow-md">Хижина Лекаря</h2>
                </div>
            </div>

            <!-- NPC Marius -->
            <div class="panel p-4 rounded-lg border-red-500/40 bg-black/30 backdrop-blur-sm mb-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full border-2 border-red-600/50 overflow-hidden flex-shrink-0" style="background: linear-gradient(135deg, rgba(239,68,68,0.3), rgba(0,0,0,0.5));">
                            <img src="https://i.postimg.cc/65gZWBmZ/IMG-4614.png" alt="Мариус" class="w-full h-full object-cover object-top">
                        </div>
                        <div>
                            <div class="text-base text-[#e0e0e0] font-bold medieval-font">Мариус</div>
                            <div class="text-[10px] text-[#a0a0a0]">Алхимик</div>
                        </div>
                    </div>
                    <button onclick="dialogue.start('marius')" class="btn-medieval px-4 py-1.5 rounded text-xs">
                        Говорить
                    </button>
                </div>
            </div>

            <!-- Healing Service -->
            <div class="panel rounded p-4 space-y-3">
                <h3 class="medieval-font text-sm text-[#c8aa6e]">Лечение</h3>
                <div class="flex items-center justify-between">
                    <div class="text-xs text-[#a0a0a0]">Восстановить здоровье</div>
                    <div class="text-xs text-yellow-500">50 <i class="fas fa-coins"></i></div>
                </div>
                <button onclick="game.heal(50, 50)" class="btn-medieval w-full py-2 rounded text-xs text-red-400 border-red-900 hover:bg-red-900/20">
                    <i class="fas fa-heart mr-2"></i> +50 HP
                </button>
            </div>

            <!-- Recipes Shop -->
            <div class="panel rounded p-4 space-y-4">
                <h3 class="medieval-font text-sm text-[#c8aa6e]">Тайные Знания (Рецепты)</h3>
                
                <!-- Immortality Recipe -->
                <div class="border border-[#333] rounded p-2 bg-black/20">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-2">
                            <i class="fas fa-scroll text-purple-400 mt-1"></i>
                            <div>
                                <div class="text-xs font-bold text-[#e0e0e0]">Зелье Бессмертия</div>
                                <div class="text-[10px] text-[#777]">Неуязвимость на 2 минуты.</div>
                            </div>
                        </div>
                        <div class="text-xs gem-price font-bold">100 <i class="far fa-gem gem-price"></i></div>
                    </div>
                    <button id="btn-buy-recipe-immortality" onclick="game.buyRecipe('immortality', 100)" class="btn-medieval w-full py-1.5 rounded text-[10px]">
                        Купить Рецепт
                    </button>
                </div>

                <!-- Luck Recipe -->
                <div class="border border-[#333] rounded p-2 bg-black/20">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-2">
                            <i class="fas fa-scroll text-green-400 mt-1"></i>
                            <div>
                                <div class="text-xs font-bold text-[#e0e0e0]">Зелье Удачи</div>
                                <div class="text-[10px] text-[#777]">x2 Добыча на 2 минуты.</div>
                            </div>
                        </div>
                        <div class="text-xs gem-price font-bold">50 <i class="far fa-gem gem-price"></i></div>
                    </div>
                    <button id="btn-buy-recipe-luck" onclick="game.buyRecipe('luck', 50)" class="btn-medieval w-full py-1.5 rounded text-[10px]">
                        Купить Рецепт
                    </button>
                </div>
            </div>

            <!-- Crafting Station (Visible if recipes unlocked) -->
            <div id="healer-crafting-station" class="hidden panel rounded p-4 space-y-3 border-t-2 border-[#c8aa6e]">
                <h3 class="medieval-font text-sm text-[#c8aa6e]">Алхимический Стол</h3>
                
                <div id="craft-action-immortality" class="hidden flex justify-between items-center bg-[#111] p-2 rounded">
                    <div class="text-xs text-purple-400">Зелье Бессмертия</div>
                    <button onclick="game.activateEffect('immortality')" class="bg-[#222] border border-purple-500 text-purple-500 px-3 py-1 rounded text-[10px] hover:bg-purple-900/30">
                        Использовать (10 трав)
                    </button>
                </div>

                <div id="craft-action-luck" class="hidden flex justify-between items-center bg-[#111] p-2 rounded">
                    <div class="text-xs text-green-400">Зелье Удачи</div>
                    <button onclick="game.activateEffect('luck')" class="bg-[#222] border border-green-500 text-green-500 px-3 py-1 rounded text-[10px] hover:bg-green-900/30">
                        Использовать (5 грибов)
                    </button>
                </div>
            </div>
        </section>

        <!-- VIEW: TREASURY -->
        <section id="view-treasury" class="hidden space-y-4">
            <div class="loc-hero h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm" data-loc="treasury" style="--hero-img: none;">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(234,179,8,0.2),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-yellow-500/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-yellow-900/50 bg-black/30 flex items-center justify-center text-yellow-400 hover:bg-yellow-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-yellow-900/60 to-yellow-950 flex items-center justify-center border-2 border-yellow-500/60 shadow-[0_0_15px_rgba(234,179,8,0.3)]">
                        <i class="fas fa-coins text-yellow-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-yellow-300 drop-shadow-md">Казна</h2>
                </div>
            </div>

            <!-- Banker Hank NPC -->
            <div class="panel p-4 rounded-lg border-yellow-900/40 bg-black/30 backdrop-blur-sm mb-4">
                <div class="flex items-center justify-between border-b border-[#333] pb-3 mb-3">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full border-2 border-yellow-600/50 overflow-hidden flex-shrink-0" style="background: linear-gradient(135deg, rgba(234,179,8,0.3), rgba(0,0,0,0.5));">
                            <img src="https://i.postimg.cc/jjVk70L0/IMG-4615.png" alt="Ханк" class="w-full h-full object-cover object-top">
                        </div>
                        <div>
                            <div class="text-base text-[#e0e0e0] font-bold medieval-font">Хэнк</div>
                            <div class="text-[10px] text-[#a0a0a0]">Главный банкир</div>
                        </div>
                    </div>
                    <button onclick="dialogue.start('hank')" class="btn-medieval px-4 py-2 rounded text-xs">
                        Говорить
                    </button>
                </div>
                
                <!-- Hank's Quest Status -->
                <div id="hank-quest-status" class="hidden">
                    <div class="text-xs text-yellow-600 bg-yellow-900/20 border border-yellow-900/50 rounded p-2">
                        <i class="fas fa-scroll mr-1"></i>
                        <span id="hank-quest-text">Ищите амулет брата Хэнка...</span>
                    </div>
                </div>
            </div>

            <!-- Bank Info -->
            <div class="panel rounded-lg p-4 flex items-center justify-between bg-[#101012]">
                <div>
                    <div class="text-xs text-[#a0a0a0] uppercase">В сейфе</div>
                    <div class="text-xl font-bold text-[#c8aa6e]">
                        <i class="fas fa-lock text-xs mr-1"></i> <span id="bank-display">0</span>
                    </div>
                </div>
                <i class="fas fa-shield-alt text-2xl text-[#333]"></i>
            </div>

            <!-- Deposit/Withdraw -->
            <div class="panel rounded-lg p-4 space-y-3">
                <h3 class="text-sm font-bold text-[#e0e0e0] border-b border-[#333] pb-2">Хранилище</h3>


                <div class="mt-2 space-y-2">
                    <div class="flex items-center justify-between text-[10px] text-[#777]">
                        <div>На руках: <span id="wallet-display" class="text-[#c8aa6e] font-bold">0</span></div>
                        <div>В сейфе: <span class="text-[#c8aa6e] font-bold" id="bank-display-mini">0</span></div>
                    </div>

                    <div class="flex gap-2">
                        <input id="bank-amount-input" type="number" min="1" step="1" placeholder="Сумма" class="w-full bg-[#111] border border-[#333] text-center text-xs text-white rounded p-2 outline-none focus:border-[#c8aa6e]">
                        <button onclick="locations.treasurySetMax('deposit', event)" class="px-3 bg-[#222] border border-[#444] rounded text-xs text-gray-400 hover:text-white">Max</button>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="locations.treasuryDepositAmount(event)" class="btn-medieval py-2 text-xs rounded">
                            Положить
                        </button>
                        <button onclick="locations.treasuryWithdrawAmount(event)" class="btn-medieval py-2 text-xs rounded">
                            Снять
                        </button>
                    </div>

                    <div class="flex justify-end">
                        <button onclick="locations.treasurySetMax('withdraw', event)" class="text-[10px] text-gray-500 underline underline-offset-2 hover:text-[#c8aa6e]">Max для снятия</button>
                    </div>
                </div>

                <p class="text-[10px] text-center text-[#777]">Деньги в сейфе защищены от краж.</p>
            </div>

            <!-- Exchange -->
            <div class="panel rounded-lg p-4 space-y-3">
                <h3 class="text-sm font-bold text-[#e0e0e0] border-b border-[#333] pb-2">Обмен Валюты</h3>
                <div class="flex justify-between items-center bg-[#000] p-2 rounded border border-[#333]">
                    <div class="flex items-center gap-2">
                        <i class="far fa-gem gem-price"></i>
                        <span class="font-bold">1</span>
                    </div>
                    <i class="fas fa-arrow-right text-gray-600"></i>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-coins text-yellow-500"></i>
                        <span class="font-bold">1000</span>
                    </div>
                </div>
                <button onclick="locations.treasuryExchange(event)" class="btn-medieval w-full py-2 rounded text-sm">
                    Обменять
                </button>
            </div>
        </section>

        <!-- VIEW: TAVERN -->
        <section id="view-tavern" class="hidden space-y-4">
            <div class="loc-hero h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm" data-loc="tavern" style="--hero-img: none;">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(249,115,22,0.2),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-orange-500/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-orange-900/50 bg-black/30 flex items-center justify-center text-orange-400 hover:bg-orange-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-orange-900/60 to-orange-950 flex items-center justify-center border-2 border-orange-500/60 shadow-[0_0_15px_rgba(249,115,22,0.3)]">
                        <i class="fas fa-beer-mug-empty text-orange-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-orange-300 drop-shadow-md">Таверна</h2>
                </div>
            </div>

            <!-- Tavern NPC -->
            <div class="panel p-4 rounded-lg border-orange-500/40 bg-black/30 backdrop-blur-sm mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full border-2 border-orange-600/50 overflow-hidden flex-shrink-0" style="background: linear-gradient(135deg, rgba(249,115,22,0.3), rgba(0,0,0,0.5));">
                            <img src="https://i.postimg.cc/vTr8kPhR/IMG-4620.png" alt="Бен" class="w-full h-full object-cover object-top">
                        </div>
                    <div>
                        <div class="text-base text-[#e0e0e0] font-bold medieval-font">Старый Бен</div>
                        <div class="text-[10px] text-[#a0a0a0]">Трактирщик</div>
                    </div>
                </div>
                        <button onclick="dialogue.start('ben')" class="px-4 py-1.5 rounded text-xs border border-orange-700/40 bg-black/30 text-orange-300 hover:bg-orange-900/20 backdrop-blur-sm">
                    Слухи
                </button>
            </div>

            <!-- Rent Room -->
            <div class="panel rounded-lg p-4 relative overflow-hidden bg-black/30 backdrop-blur-sm border border-amber-700/40">
                <!-- Background Image with Overlay -->
                <div class="absolute inset-0 z-0">
                    <img src="https://i.postimg.cc/brsZYtPY/IMG-4601.jpg" alt="Tavern Room" class="w-full h-full object-cover opacity-25">
                    <div class="absolute inset-0 bg-gradient-to-b from-black/70 via-black/60 to-black/80"></div>
                    <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(217,119,6,0.15),transparent_60%)]"></div>
                </div>
                
                <div class="relative z-10">
                    <h3 class="medieval-font text-lg text-amber-300">Комната</h3>
                    <p class="text-xs text-[#a0a0a0] mb-3">Личная комната с сундуком для вещей (200 кг).</p>
                    
                    <div id="tavern-room-rent-ui" class="bg-black/30 backdrop-blur-sm rounded p-3 border border-amber-700/30">
                        <div class="flex items-center gap-2 mb-3 text-sm">
                            <span class="text-[#c8aa6e]">Цена: 1000</span> <i class="fas fa-coins text-yellow-500"></i> / сутки
                        </div>
                        <button onclick="locations.tavernRent()" class="w-full py-2 rounded text-sm border border-amber-700/40 bg-black/30 text-amber-300 hover:bg-amber-900/20 backdrop-blur-sm">
                            Снять комнату
                        </button>
                    </div>

                    <div id="tavern-room-active-ui" class="hidden bg-black/30 backdrop-blur-sm rounded p-3 border border-green-700/30">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-xs text-green-400"><i class="fas fa-check-circle"></i> Арендовано</div>
                            <div id="room-timer" class="text-xs font-mono text-[#c8aa6e]">--:--:--</div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <button onclick="locations.openTavernChest()" class="panel p-2 rounded flex flex-col items-center justify-center hover:bg-[#222] transition-colors backdrop-blur-sm">
                                <i class="fas fa-box-open text-2xl text-[#c8aa6e] mb-1"></i>
                                <span class="text-xs font-bold">Сундук</span>
                            </button>
                            <button onclick="locations.tavernExtendRent()" class="panel p-2 rounded flex flex-col items-center justify-center hover:bg-[#222] transition-colors backdrop-blur-sm">
                                <i class="fas fa-clock text-2xl text-blue-400 mb-1"></i>
                                <span class="text-xs font-bold">Продлить (1к)</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Brawl Night -->
            <div class="panel rounded-lg p-4 relative overflow-hidden border-orange-700/40 bg-black/30 backdrop-blur-sm">
                <!-- Background Image with Overlay -->
                <div class="absolute inset-0 z-0">
                    <img src="https://i.postimg.cc/B6wvznFS/IMG-4602.jpg" alt="Brawl Fight" class="w-full h-full object-cover opacity-25">
                    <div class="absolute inset-0 bg-gradient-to-b from-black/70 via-black/60 to-black/80"></div>
                    <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(249,115,22,0.2),transparent_60%)]"></div>
                </div>
                
                <div class="relative z-10">
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <h3 class="medieval-font text-lg text-orange-300">Кулачные бои</h3>
                            <p class="text-[10px] text-[#a0a0a0]">Раз в час. Ставки и слава.</p>
                        </div>
                        <div class="text-[10px] text-[#c8aa6e] uppercase tracking-wider">Арена</div>
                    </div>
                    <div class="panel p-2 rounded bg-black/50 backdrop-blur-sm border border-orange-700/30 text-[10px] text-[#a0a0a0] mb-3">
                        Победа даёт золото и репутацию, поражение — травмы. Требуется 20+ HP.
                    </div>
                    <div class="flex items-center justify-between text-[10px] text-[#777] mb-3">
                        <span>До следующего боя:</span>
                        <span id="brawl-timer" class="text-[#c8aa6e] font-mono">Доступно</span>
                    </div>
                    <button id="btn-brawl" onclick="locations.tavernBrawl(event)" class="w-full py-2 rounded font-bold border border-orange-700/40 bg-black/30 text-orange-300 hover:bg-orange-900/20 backdrop-blur-sm">
                        Выйти на бой
                    </button>
                </div>
            </div>

            <!-- Food & Thomas Event -->
            <div class="panel rounded-lg p-4 space-y-3">
                <h3 class="medieval-font text-lg text-[#c8aa6e]">Горячая еда</h3>
                <p class="text-xs text-[#a0a0a0]">Восстанавливает 100% здоровья и 100% сытости.</p>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="locations.tavernEat('stew')" class="panel p-2 rounded flex flex-col items-center bg-[#222] border border-[#333] hover:border-[#c8aa6e] transition-colors group">
                        <i class="fas fa-bowl-food text-orange-400 text-2xl mb-2 group-hover:scale-110 transition-transform"></i>
                        <span class="text-xs text-[#e0e0e0] font-bold">Мясное рагу</span>
                        <span class="text-[10px] text-yellow-500 mt-1">100 <i class="fas fa-coins"></i></span>
                    </button>
                    <button onclick="locations.tavernEat('soup')" class="panel p-2 rounded flex flex-col items-center bg-[#222] border border-[#333] hover:border-[#c8aa6e] transition-colors group">
                        <i class="fas fa-utensils text-yellow-200 text-2xl mb-2 group-hover:scale-110 transition-transform"></i>
                        <span class="text-xs text-[#e0e0e0] font-bold">Куриный суп</span>
                        <span class="text-[10px] text-yellow-500 mt-1">100 <i class="fas fa-coins"></i></span>
                    </button>
                </div>
            </div>

            <!-- Wheel of Fortune -->
            <div class="panel rounded-lg p-4 text-center space-y-4 overflow-hidden relative">
                <h3 class="medieval-font text-lg text-[#c8aa6e]">Колесо Удачи</h3>
                
                <div class="relative w-56 h-56 mx-auto my-4">
                    <!-- Wheel -->
                    <div id="wheel" class="w-full h-full rounded-full border-4 border-[#c8aa6e] relative shadow-[0_0_30px_rgba(200,170,110,0.4)] flex items-center justify-center overflow-hidden wheel-container" style="background: conic-gradient(
                        from 0deg,
                        #2d1810 0deg 60deg,
                        #1a1410 60deg 120deg,
                        #2d1810 120deg 180deg,
                        #1a1410 180deg 240deg,
                        #2d1810 240deg 300deg,
                        #1a1410 300deg 360deg
                    );">
                        <!-- Center circle -->
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-[#c8aa6e] to-[#8b733d] border-2 border-[#e0c89b] shadow-[0_0_20px_rgba(200,170,110,0.6)] flex items-center justify-center">
                                <i class="fas fa-dice text-2xl text-[#1a1410]"></i>
                            </div>
                        </div>
                        
                        <!-- Prize segments (decorative) -->
                        <div class="absolute inset-0 flex items-center justify-center">
                            <!-- Lines dividing segments -->
                            <div class="absolute w-full h-0.5 bg-[#c8aa6e]/30 rotate-0"></div>
                            <div class="absolute w-full h-0.5 bg-[#c8aa6e]/30 rotate-60"></div>
                            <div class="absolute w-full h-0.5 bg-[#c8aa6e]/30 rotate-[120deg]"></div>
                        </div>
                    </div>
                    
                    <!-- Pointer -->
                    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-3 z-10">
                        <div class="relative">
                            <i class="fas fa-caret-down text-4xl text-[#c8aa6e] drop-shadow-[0_0_8px_rgba(200,170,110,0.8)]"></i>
                            <div class="absolute inset-0 blur-sm">
                                <i class="fas fa-caret-down text-4xl text-[#c8aa6e]"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-sm text-[#a0a0a0] mb-3">
                    Цена: <span class="text-emerald-400 font-bold text-lg">1 <i class="far fa-gem gem-price"></i></span>
                </div>

                <!-- Prize list -->
                <div class="bg-black/30 rounded-lg p-3 mb-3 border border-[#c8aa6e]/20">
                    <div class="text-xs text-[#c8aa6e] font-bold mb-2 uppercase tracking-wider">Возможные призы:</div>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="bg-[#1a1410] rounded p-2 border border-yellow-600/30">
                            <i class="fas fa-coins text-yellow-500"></i> <span class="text-[#e0e0e0]">500 золота</span>
                        </div>
                        <div class="bg-[#1a1410] rounded p-2 border border-yellow-600/30">
                            <i class="fas fa-coins text-yellow-500"></i> <span class="text-[#e0e0e0]">1,000 золота</span>
                        </div>
                        <div class="bg-[#1a1410] rounded p-2 border border-yellow-600/40">
                            <i class="fas fa-coins text-yellow-500"></i> <span class="text-[#e0e0e0]">5,000 золота</span>
                        </div>
                        <div class="bg-[#1a1410] rounded p-2 border border-emerald-600/30">
                            <i class="far fa-gem gem-price"></i> <span class="text-[#e0e0e0]">10 изумрудов</span>
                        </div>
                        <div class="bg-[#1a1410] rounded p-2 border border-emerald-600/40">
                            <i class="far fa-gem gem-price"></i> <span class="text-[#e0e0e0]">30 изумрудов</span>
                        </div>
                        <div class="bg-[#1a1410] rounded p-2 border border-emerald-600/50 shadow-[0_0_15px_rgba(16,185,129,0.3)]">
                            <i class="far fa-gem gem-price"></i> <span class="text-[#e0e0e0] font-bold">100 изумрудов!</span>
                        </div>
                    </div>
                </div>

                <button id="btn-spin" onclick="locations.tavernSpin()" class="btn-medieval w-full py-3 rounded font-bold text-base">
                    <i class="fas fa-dice-d20 mr-2"></i>Испытать удачу!
                </button>
            </div>
        </section>

        <!-- Tavern Chest View -->
        <section id="view-tavern-chest" class="hidden space-y-4 h-full flex flex-col">
             <div class="flex items-center gap-4 mb-2">
                <button onclick="router.navigate('tavern')" class="w-8 h-8 rounded border border-[#333] bg-black/30 flex items-center justify-center text-[#a0a0a0] hover:bg-[#333]">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="medieval-font text-xl text-[#c8aa6e]">Сундук в комнате</h2>
            </div>

            <div class="flex-1 overflow-hidden grid grid-cols-2 gap-2 h-full">
                <!-- Inventory Side -->
                <div class="panel p-2 rounded flex flex-col h-full overflow-hidden">
                    <h3 class="text-xs font-bold text-[#a0a0a0] mb-2 uppercase text-center border-b border-[#333] pb-1">Инвентарь</h3>
                    <div id="chest-inventory-grid" class="flex-1 overflow-y-auto grid grid-cols-3 gap-1 content-start pr-1">
                        <!-- Items -->
                    </div>
                </div>

                <!-- Chest Side -->
                <div class="panel p-2 rounded flex flex-col h-full overflow-hidden border border-[#c8aa6e]/30">
                    <div class="flex justify-between items-center mb-2 border-b border-[#333] pb-1">
                        <h3 class="text-xs font-bold text-[#c8aa6e] uppercase">Сундук</h3>
                        <span class="text-[10px] text-[#a0a0a0]"><span id="chest-weight">0</span>/200 кг</span>
                    </div>
                    <div id="chest-storage-grid" class="flex-1 overflow-y-auto grid grid-cols-3 gap-1 content-start pr-1">
                        <!-- Stored Items -->
                    </div>
                </div>
            </div>
            
            <div class="panel p-2 rounded text-[10px] text-[#777] text-center">
                Нажмите на предмет, чтобы переместить его.
            </div>
        </section>

        <!-- VIEW: MARKET -->
        <section id="view-market" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(217,119,6,0.15),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-amber-500/50 to-transparent"></div>
                <div class="absolute top-1/2 left-4 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-900/60 to-amber-950 flex items-center justify-center border-2 border-amber-500/60 shadow-[0_0_15px_rgba(217,119,6,0.3)]">
                        <i class="fas fa-store text-amber-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-amber-300 drop-shadow-md">Торговые ряды</h2>
                </div>
            </div>

            <!-- Market NPC -->
            <div class="p-4 rounded-lg border-gray-500/40 mb-4" >
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full border-2 border-gray-500 bg-[#222] flex items-center justify-center shadow-[0_0_10px_rgba(107,114,128,0.3)]">
                            <i class="fas fa-hammer text-gray-400 text-lg"></i>
                        </div>
                        <div>
                            <div class="text-base text-[#e0e0e0] font-bold medieval-font">Горн</div>
                            <div class="text-[10px] text-[#a0a0a0]">Кузнец</div>
                        </div>
                    </div>
                    <button onclick="dialogue.start('gorn')" class="btn-medieval px-4 py-2 rounded text-xs">
                        Говорить
                    </button>
                </div>
            </div>

            <!-- Market Tabs -->
            <div class="flex items-center gap-2 overflow-x-auto pb-2 mb-2 no-scrollbar">
                <button onclick="market.switchCategory('tools')" id="tab-market-tools" class="sub-tab active">Инструменты</button>
                <button onclick="market.switchCategory('armor')" id="tab-market-armor" class="sub-tab">Бронник</button>
                <button onclick="market.switchCategory('weapons')" id="tab-market-weapons" class="sub-tab">Мечник</button>
                <!-- Horses tab removed -->
            </div>

            <!-- Content: Tools -->
            <div id="market-tools" class="space-y-3">
                <!-- Rod -->
                <div class="market-item-card p-3 rounded flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-900/60 to-amber-950 border-2 border-amber-500/60 flex items-center justify-center shadow-[0_0_10px_rgba(217,119,6,0.3)]">
                            <svg class="w-6 h-6 text-[#c8aa6e]" viewBox="0 0 24 24"><use href="#icon-rod"></use></svg>
                        </div>
                        <div>
                            <div class="text-[#e0e0e0] font-serif">Удочка</div>
                            <div class="text-xs text-[#a0a0a0]">Позволяет ловить рыбу</div>
                            <div class="text-xs text-blue-400" id="market-lvl-rod">Ур: 0</div>
                        </div>
                    </div>
                    <button id="btn-buy-rod" onclick="market.buyOrUpgradeTool('rod')" class="btn-ghost px-3 py-1.5 text-xs rounded">
                        <span id="price-rod">50</span> <i class="fas fa-coins text-[10px]"></i>
                    </button>
                </div>
                <!-- Sickle -->
                <div class="market-item-card p-3 rounded flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-900/60 to-amber-950 border-2 border-amber-500/60 flex items-center justify-center shadow-[0_0_10px_rgba(217,119,6,0.3)]">
                            <svg class="w-6 h-6 text-[#c8aa6e]" viewBox="0 0 24 24"><use href="#icon-sickle"></use></svg>
                        </div>
                        <div>
                            <div class="text-[#e0e0e0] font-serif">Серп</div>
                            <div class="text-xs text-[#a0a0a0]">Позволяет собирать пшеницу</div>
                            <div class="text-xs text-blue-400" id="market-lvl-sickle">Ур: 0</div>
                        </div>
                    </div>
                    <button id="btn-buy-sickle" onclick="market.buyOrUpgradeTool('sickle')" class="btn-ghost px-3 py-1.5 text-xs rounded">
                        <span id="price-sickle">500</span> <i class="fas fa-coins text-[10px]"></i>
                    </button>
                </div>
                <!-- Pickaxe -->
                <div class="market-item-card p-3 rounded flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-900/60 to-amber-950 border-2 border-amber-500/60 flex items-center justify-center shadow-[0_0_10px_rgba(217,119,6,0.3)]">
                            <i class="fas fa-person-digging"></i>
                        </div>
                        <div>
                            <div class="text-[#e0e0e0] font-serif">Кирка</div>
                            <div class="text-xs text-[#a0a0a0]">Позволяет добывать руду</div>
                            <div class="text-xs text-blue-400" id="market-lvl-pickaxe">Ур: 0</div>
                        </div>
                    </div>
                    <button id="btn-buy-pickaxe" onclick="market.buyOrUpgradeTool('pickaxe')" class="btn-ghost px-3 py-1.5 text-xs rounded">
                        <span id="price-pickaxe">2000</span> <i class="fas fa-coins text-[10px]"></i>
                    </button>
                </div>
                 <!-- Crossbow -->
                 <div class="market-item-card p-3 rounded flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-900/60 to-amber-950 border-2 border-amber-500/60 flex items-center justify-center shadow-[0_0_10px_rgba(217,119,6,0.3)]">
                            <svg class="w-6 h-6 text-[#c8aa6e] mx-auto" viewBox="0 0 512.001 512.001" preserveAspectRatio="xMidYMid meet"><use href="#icon-crossbow"></use></svg>
                        </div>
                        <div>
                            <div class="text-[#e0e0e0] font-serif">Арбалет</div>
                            <div class="text-xs text-[#a0a0a0]">Позволяет добывать шкуры</div>
                            <div class="text-xs text-blue-400" id="market-lvl-crossbow">Ур: 0</div>
                        </div>
                    </div>
                    <button id="btn-buy-crossbow" onclick="market.buyOrUpgradeTool('crossbow')" class="btn-ghost px-3 py-1.5 text-xs rounded">
                        <span id="price-crossbow">5000</span> <i class="fas fa-coins text-[10px]"></i>
                    </button>
                </div>
                <!-- Sword -->
                 <div class="market-item-card p-3 rounded flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-900/60 to-amber-950 border-2 border-amber-500/60 flex items-center justify-center shadow-[0_0_10px_rgba(217,119,6,0.3)]">
                            <i class="fas fa-khanda"></i>
                        </div>
                        <div>
                            <div class="text-[#e0e0e0] font-serif">Меч</div>
                            <div class="text-xs text-[#a0a0a0]">Оружие для защиты</div>
                            <div class="text-xs text-blue-400" id="market-lvl-sword">Ур: 0</div>
                        </div>
                    </div>
                    <button id="btn-buy-sword" onclick="market.buyOrUpgradeTool('sword')" class="btn-ghost px-3 py-1.5 text-xs rounded">
                        <span id="price-sword">1000</span> <i class="fas fa-coins text-[10px]"></i>
                    </button>
                </div>
            </div>

            <!-- Content: Weapons (Swords) -->
            <div id="market-weapons" class="hidden space-y-3">
                <!-- Wooden Sword -->
                <div class="market-item-card p-3 rounded flex items-center justify-between" data-sword="wooden">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-gray-700/60 to-gray-900 border-2 border-gray-500/60 flex items-center justify-center shadow-[0_0_10px_rgba(136,136,136,0.3)]">
                            <svg class="w-6 h-6" viewBox="0 0 512.001 512.001" style="fill: #888888;"><use href="#icon-sword-generic"></use></svg>
                        </div>
                        <div>
                            <div class="text-[#e0e0e0] font-serif">Деревянный меч</div>
                            <div class="text-xs text-[#a0a0a0]">Урон: +5</div>
                        </div>
                    </div>
                    <div class="market-buy-area">
                        <button onclick="market.buySword('wooden')" class="btn-ghost px-3 py-1.5 text-xs rounded">
                            5,000 <i class="fas fa-coins text-[10px]"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Stone Sword -->
                <div class="market-item-card p-3 rounded flex items-center justify-between" data-sword="stone">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-700/40 to-blue-950 border-2 border-blue-500/60 flex items-center justify-center shadow-[0_0_10px_rgba(108,159,255,0.3)]">
                            <svg class="w-6 h-6" viewBox="0 0 512.001 512.001" style="fill: #6c9fff;"><use href="#icon-sword-generic"></use></svg>
                        </div>
                        <div>
                            <div class="text-[#e0e0e0] font-serif">Каменный меч</div>
                            <div class="text-xs text-[#a0a0a0]">Урон: +15</div>
                        </div>
                    </div>
                    <div class="market-buy-area">
                        <button onclick="market.buySword('stone')" class="btn-ghost px-3 py-1.5 text-xs rounded">
                            15,000 <i class="fas fa-coins text-[10px]"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Metal Sword -->
                <div class="market-item-card p-3 rounded flex items-center justify-between" data-sword="metal">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-pink-700/40 to-pink-950 border-2 border-pink-500/60 flex items-center justify-center shadow-[0_0_10px_rgba(232,123,168,0.3)]">
                            <svg class="w-6 h-6" viewBox="0 0 512.001 512.001" style="fill: #e87ba8;"><use href="#icon-sword-generic"></use></svg>
                        </div>
                        <div>
                            <div class="text-[#e0e0e0] font-serif">Металлический меч</div>
                            <div class="text-xs text-[#a0a0a0]">Урон: +25</div>
                        </div>
                    </div>
                    <div class="market-buy-area">
                        <button onclick="market.buySword('metal')" class="btn-ghost px-3 py-1.5 text-xs rounded">
                            200 <i class="far fa-gem text-[10px] gem-price"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Steel Sword -->
                <div class="market-item-card p-3 rounded flex items-center justify-between" data-sword="steel">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-700/40 to-red-950 border-2 border-red-500/60 flex items-center justify-center shadow-[0_0_10px_rgba(239,68,68,0.3)]">
                            <svg class="w-6 h-6" viewBox="0 0 512.001 512.001" style="fill: #ef4444;"><use href="#icon-sword-generic"></use></svg>
                        </div>
                        <div>
                            <div class="text-[#e0e0e0] font-serif">Стальной меч</div>
                            <div class="text-xs text-[#a0a0a0]">Урон: +40</div>
                        </div>
                    </div>
                    <div class="market-buy-area">
                        <button onclick="market.buySword('steel')" class="btn-ghost px-3 py-1.5 text-xs rounded">
                            500 <i class="far fa-gem text-[10px] gem-price"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Silver Master Sword -->
                <div class="panel p-3 rounded flex items-center justify-between border-yellow-900/50 bg-yellow-900/10" data-sword="silver">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-yellow-700/60 to-yellow-950 border-2 border-yellow-400/80 flex items-center justify-center shadow-[0_0_15px_rgba(200,170,110,0.4)]">
                            <svg class="w-6 h-6" viewBox="0 0 512.001 512.001" style="fill: #c8aa6e;"><use href="#icon-sword-generic"></use></svg>
                        </div>
                        <div>
                            <div class="text-[#c8aa6e] font-serif">Серебряный меч мастера</div>
                            <div class="text-xs text-[#c8aa6e]/70">Урон: +60</div>
                        </div>
                    </div>
                    <div class="market-buy-area">
                        <button onclick="market.buySword('silver')" class="btn-ghost px-3 py-1.5 text-xs rounded border-[#c8aa6e]">
                            1,500 <i class="far fa-gem text-[10px] gem-price"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Content: Armor -->
            <div id="market-armor" class="hidden space-y-3">
                <!-- Leather Armor -->
                <div class="market-item-card p-3 rounded flex items-center justify-between" data-armor="leather">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-gray-700/60 to-gray-900 border-2 border-gray-500/60 flex items-center justify-center shadow-[0_0_10px_rgba(136,136,136,0.3)]">
                            <svg class="w-6 h-6" viewBox="0 0 512 512" style="fill: #888888;"><use href="#icon-armor-generic"></use></svg>
                        </div>
                        <div>
                            <div class="text-[#e0e0e0] font-serif">Кожаная броня</div>
                            <div class="text-xs text-[#a0a0a0]">Броня: +5</div>
                        </div>
                    </div>
                    <div class="market-buy-area">
                        <button onclick="market.buyArmor('leather')" class="btn-ghost px-3 py-1.5 text-xs rounded">
                            10,000 <i class="fas fa-coins text-[10px]"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Improved Leather -->
                <div class="market-item-card p-3 rounded flex items-center justify-between" data-armor="improved">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-700/40 to-blue-950 border-2 border-blue-500/60 flex items-center justify-center shadow-[0_0_10px_rgba(108,159,255,0.3)]">
                            <svg class="w-6 h-6" viewBox="0 0 512 512" style="fill: #6c9fff;"><use href="#icon-armor-generic"></use></svg>
                        </div>
                        <div>
                            <div class="text-[#e0e0e0] font-serif">Улучшенная кожаная броня</div>
                            <div class="text-xs text-[#a0a0a0]">Броня: +15</div>
                        </div>
                    </div>
                    <div class="market-buy-area">
                        <button onclick="market.buyArmor('improved')" class="btn-ghost px-3 py-1.5 text-xs rounded">
                            30,000 <i class="fas fa-coins text-[10px]"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Chainmail -->
                <div class="market-item-card p-3 rounded flex items-center justify-between" data-armor="chainmail">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-pink-700/40 to-pink-950 border-2 border-pink-500/60 flex items-center justify-center shadow-[0_0_10px_rgba(232,123,168,0.3)]">
                            <svg class="w-6 h-6" viewBox="0 0 512 512" style="fill: #e87ba8;"><use href="#icon-armor-generic"></use></svg>
                        </div>
                        <div>
                            <div class="text-[#e0e0e0] font-serif">Кольчужная броня</div>
                            <div class="text-xs text-[#a0a0a0]">Броня: +25</div>
                        </div>
                    </div>
                    <div class="market-buy-area">
                        <button onclick="market.buyArmor('chainmail')" class="btn-ghost px-3 py-1.5 text-xs rounded">
                            200 <i class="far fa-gem text-[10px] gem-price"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Iron Armor -->
                <div class="market-item-card p-3 rounded flex items-center justify-between" data-armor="iron">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-700/40 to-red-950 border-2 border-red-500/60 flex items-center justify-center shadow-[0_0_10px_rgba(239,68,68,0.3)]">
                            <svg class="w-6 h-6" viewBox="0 0 512 512" style="fill: #ef4444;"><use href="#icon-armor-generic"></use></svg>
                        </div>
                        <div>
                            <div class="text-[#e0e0e0] font-serif">Железная броня</div>
                            <div class="text-xs text-[#a0a0a0]">Броня: +40</div>
                        </div>
                    </div>
                    <div class="market-buy-area">
                        <button onclick="market.buyArmor('iron')" class="btn-ghost px-3 py-1.5 text-xs rounded">
                            600 <i class="far fa-gem text-[10px] gem-price"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Silver Master Armor -->
                <div class="panel p-3 rounded flex items-center justify-between border-yellow-900/50 bg-yellow-900/10" data-armor="silver_master">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-yellow-700/60 to-yellow-950 border-2 border-yellow-400/80 flex items-center justify-center shadow-[0_0_15px_rgba(200,170,110,0.4)]">
                            <svg class="w-6 h-6" viewBox="0 0 512 512" style="fill: #c8aa6e;"><use href="#icon-armor-generic"></use></svg>
                        </div>
                        <div>
                            <div class="text-[#c8aa6e] font-serif">Серебряная броня мастера</div>
                            <div class="text-xs text-[#c8aa6e]/70">Броня: +60</div>
                        </div>
                    </div>
                    <div class="market-buy-area">
                        <button onclick="market.buyArmor('silver_master')" class="btn-ghost px-3 py-1.5 text-xs rounded border-[#c8aa6e]">
                            1,200 <i class="far fa-gem text-[10px] gem-price"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Content: Placeholders -->
            <div id="market-placeholder" class="hidden flex flex-col items-center justify-center py-10 opacity-50">
                <i class="fas fa-horse-head text-4xl mb-3 text-amber-700"></i>
                <p class="text-sm text-gray-400 text-center mb-2">Лошади продаются у Фермера Хью</p>
                <button onclick="router.navigate('view-livestock-trader')" class="btn-medieval px-4 py-1 rounded text-xs">Перейти к Фермеру</button>
            </div>

            <!-- Resources Trade -->
            <div class="rounded-lg p-4 mt-4 border border-amber-700/30" >
                <div class="flex items-center justify-between mb-3">
                    <h3 class="medieval-font text-sm text-[#c8aa6e]">Материалы</h3>
                    <div class="flex gap-2">
                        <button onclick="market.switchTradeMode('sell')" id="market-trade-sell" class="sub-tab active">Продажа</button>
                        <button onclick="market.switchTradeMode('buy')" id="market-trade-buy" class="sub-tab">Покупка</button>
                    </div>
                </div>

                <div id="market-trade-grid" class="grid grid-cols-2 gap-3">
                    <div class="resource-card p-2 rounded flex flex-col items-center text-center border-blue-900/30">
                        <i class="fas fa-fish text-[#c8aa6e] mb-1"></i>
                        <div class="text-xs text-[#e0e0e0]">Рыба</div>
                        <div class="text-[10px] text-[#a0a0a0] mb-1"><span id="price-fish">5</span> <i class="fas fa-coins"></i></div>
                        <div class="text-[10px] text-blue-300 mb-1">У вас: <span id="market-count-fish">0</span></div>
                        <div class="flex gap-1 w-full mb-1">
                            <input id="trade-input-fish" type="number" min="1" value="1" class="w-full bg-[#111] border border-[#333] text-center text-[10px] text-white rounded p-0 outline-none focus:border-[#c8aa6e]">
                            <button onclick="market.setMax('fish')" class="w-auto px-2 border border-[#444] rounded text-[10px] text-gray-400 hover:text-white" >Max</button>
                        </div>
                        <button onclick="market.sellFromInput('fish')" id="btn-trade-fish" class="btn-ghost w-full rounded text-[10px] py-1 hover:bg-amber-900/20 transition-colors">Продать</button>
                    </div>
                    <div class="resource-card p-2 rounded flex flex-col items-center text-center border-yellow-900/30">
                        <i class="fas fa-wheat-awn text-[#c8aa6e] mb-1"></i>
                        <div class="text-xs text-[#e0e0e0]">Пшеница</div>
                        <div class="text-[10px] text-[#a0a0a0] mb-1"><span id="price-wheat">15</span> <i class="fas fa-coins"></i></div>
                        <div class="text-[10px] text-blue-300 mb-1">У вас: <span id="market-count-wheat">0</span></div>
                        <div class="flex gap-1 w-full mb-1">
                            <input id="trade-input-wheat" type="number" min="1" value="1" class="w-full bg-[#111] border border-[#333] text-center text-[10px] text-white rounded p-0 outline-none focus:border-[#c8aa6e]">
                            <button onclick="market.setMax('wheat')" class="w-auto px-2 border border-[#444] rounded text-[10px] text-gray-400 hover:text-white" >Max</button>
                        </div>
                        <button onclick="market.sellFromInput('wheat')" id="btn-trade-wheat" class="btn-ghost w-full rounded text-[10px] py-1 hover:bg-amber-900/20 transition-colors">Продать</button>
                    </div>
                    <div class="resource-card p-2 rounded flex flex-col items-center text-center border-gray-700/30">
                        <i class="fas fa-cube text-[#c8aa6e] mb-1"></i>
                        <div class="text-xs text-[#e0e0e0]">Руда</div>
                        <div class="text-[10px] text-[#a0a0a0] mb-1"><span id="price-ore">40</span> <i class="fas fa-coins"></i></div>
                        <div class="text-[10px] text-blue-300 mb-1">У вас: <span id="market-count-ore">0</span></div>
                        <div class="flex gap-1 w-full mb-1">
                            <input id="trade-input-ore" type="number" min="1" value="1" class="w-full bg-[#111] border border-[#333] text-center text-[10px] text-white rounded p-0 outline-none focus:border-[#c8aa6e]">
                            <button onclick="market.setMax('ore')" class="w-auto px-2 border border-[#444] rounded text-[10px] text-gray-400 hover:text-white" >Max</button>
                        </div>
                        <button onclick="market.sellFromInput('ore')" id="btn-trade-ore" class="btn-ghost w-full rounded text-[10px] py-1 hover:bg-amber-900/20 transition-colors">Продать</button>
                    </div>
                    <div class="resource-card p-2 rounded flex flex-col items-center text-center border-red-900/30">
                        <i class="fas fa-scroll text-[#c8aa6e] mb-1"></i>
                        <div class="text-xs text-[#e0e0e0]">Кожа</div>
                        <div class="text-[10px] text-[#a0a0a0] mb-1"><span id="price-leather">100</span> <i class="fas fa-coins"></i></div>
                        <div class="text-[10px] text-blue-300 mb-1">У вас: <span id="market-count-leather">0</span></div>
                        <div class="flex gap-1 w-full mb-1">
                            <input id="trade-input-leather" type="number" min="1" value="1" class="w-full bg-[#111] border border-[#333] text-center text-[10px] text-white rounded p-0 outline-none focus:border-[#c8aa6e]">
                            <button onclick="market.setMax('leather')" class="w-auto px-2 border border-[#444] rounded text-[10px] text-gray-400 hover:text-white" >Max</button>
                        </div>
                        <button onclick="market.sellFromInput('leather')" id="btn-trade-leather" class="btn-ghost w-full rounded text-[10px] py-1 hover:bg-amber-900/20 transition-colors">Продать</button>
                    </div>
                    <div class="resource-card p-2 rounded flex flex-col items-center text-center border-amber-900/30">
                        <i class="fas fa-tree text-[#c8aa6e] mb-1"></i>
                        <div class="text-xs text-[#e0e0e0]">Палки</div>
                        <div class="text-[10px] text-[#a0a0a0] mb-1"><span id="price-wood">5</span> <i class="fas fa-coins"></i></div>
                        <div class="text-[10px] text-blue-300 mb-1">У вас: <span id="market-count-wood">0</span></div>
                        <div class="flex gap-1 w-full mb-1">
                            <input id="trade-input-wood" type="number" min="1" value="1" class="w-full bg-[#111] border border-[#333] text-center text-[10px] text-white rounded p-0 outline-none focus:border-[#c8aa6e]">
                            <button onclick="market.setMax('wood')" class="w-auto px-2 border border-[#444] rounded text-[10px] text-gray-400 hover:text-white" >Max</button>
                        </div>
                        <button onclick="market.sellFromInput('wood')" id="btn-trade-wood" class="btn-ghost w-full rounded text-[10px] py-1 hover:bg-amber-900/20 transition-colors">Продать</button>
                    </div>
                    <div class="resource-card p-2 rounded flex flex-col items-center text-center border-gray-600/30">
                        <i class="fas fa-shapes text-gray-400 mb-1"></i>
                        <div class="text-xs text-[#e0e0e0]">Камни</div>
                        <div class="text-[10px] text-[#a0a0a0] mb-1"><span id="price-stone">5</span> <i class="fas fa-coins"></i></div>
                        <div class="text-[10px] text-blue-300 mb-1">У вас: <span id="market-count-stone">0</span></div>
                        <div class="flex gap-1 w-full mb-1">
                            <input id="trade-input-stone" type="number" min="1" value="1" class="w-full bg-[#111] border border-[#333] text-center text-[10px] text-white rounded p-0 outline-none focus:border-[#c8aa6e]">
                            <button onclick="market.setMax('stone')" class="w-auto px-2 border border-[#444] rounded text-[10px] text-gray-400 hover:text-white" >Max</button>
                        </div>
                        <button onclick="market.sellFromInput('stone')" id="btn-trade-stone" class="btn-ghost w-full rounded text-[10px] py-1 hover:bg-amber-900/20 transition-colors">Продать</button>
                    </div>
                    <div class="resource-card p-2 rounded flex flex-col items-center text-center border-green-900/30">
                        <i class="fas fa-leaf text-green-400 mb-1"></i>
                        <div class="text-xs text-[#e0e0e0]">Травы</div>
                        <div class="text-[10px] text-[#a0a0a0] mb-1"><span id="price-herbs">10</span> <i class="fas fa-coins"></i></div>
                        <div class="text-[10px] text-blue-300 mb-1">У вас: <span id="market-count-herbs">0</span></div>
                        <div class="flex gap-1 w-full mb-1">
                            <input id="trade-input-herbs" type="number" min="1" value="1" class="w-full bg-[#111] border border-[#333] text-center text-[10px] text-white rounded p-0 outline-none focus:border-[#c8aa6e]">
                            <button onclick="market.setMax('herbs')" class="w-auto px-2 border border-[#444] rounded text-[10px] text-gray-400 hover:text-white" >Max</button>
                        </div>
                        <button onclick="market.sellFromInput('herbs')" id="btn-trade-herbs" class="btn-ghost w-full rounded text-[10px] py-1 hover:bg-amber-900/20 transition-colors">Продать</button>
                    </div>
                    <div class="resource-card p-2 rounded flex flex-col items-center text-center border-purple-900/30">
                        <i class="fas fa-spider text-purple-400 mb-1"></i>
                        <div class="text-xs text-[#e0e0e0]">Грибы</div>
                        <div class="text-[10px] text-[#a0a0a0] mb-1"><span id="price-mushrooms">25</span> <i class="fas fa-coins"></i></div>
                        <div class="text-[10px] text-blue-300 mb-1">У вас: <span id="market-count-mushrooms">0</span></div>
                        <div class="flex gap-1 w-full mb-1">
                            <input id="trade-input-mushrooms" type="number" min="1" value="1" class="w-full bg-[#111] border border-[#333] text-center text-[10px] text-white rounded p-0 outline-none focus:border-[#c8aa6e]">
                            <button onclick="market.setMax('mushrooms')" class="w-auto px-2 border border-[#444] rounded text-[10px] text-gray-400 hover:text-white" >Max</button>
                        </div>
                        <button onclick="market.sellFromInput('mushrooms')" id="btn-trade-mushrooms" class="btn-ghost w-full rounded text-[10px] py-1 hover:bg-amber-900/20 transition-colors">Продать</button>
                    </div>
                </div>
            </div>

        </section>

        <!-- VIEW: LIVESTOCK TRADER -->
        <section id="view-livestock-trader" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(16,185,129,0.18),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-emerald-500/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-emerald-900/50 bg-black/30 flex items-center justify-center text-emerald-400 hover:bg-emerald-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-emerald-900/60 to-emerald-950 flex items-center justify-center border-2 border-emerald-500/60 shadow-[0_0_15px_rgba(16,185,129,0.35)]">
                        <i class="fas fa-cow text-emerald-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-emerald-300 drop-shadow-md">Торговец скотом</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-4 space-y-4">
                <div class="panel p-3 rounded flex items-center justify-between border-emerald-900/30 bg-emerald-900/10">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full border-2 border-emerald-600/50 overflow-hidden flex-shrink-0" style="background: linear-gradient(135deg, rgba(22,101,52,0.3), rgba(0,0,0,0.5));">
                            <img src="https://i.postimg.cc/tgFkFwQ1/IMG-4670.png" alt="Хью" class="w-full h-full object-cover object-top">
                        </div>
                        <div>
                            <div class="text-base text-[#e0e0e0] font-bold medieval-font">Фермер Хью</div>
                            <div class="text-[10px] text-[#a0a0a0]">Торговец скотом</div>
                        </div>
                    </div>
                    <button onclick="dialogue.start('hugh')" class="btn-medieval px-4 py-1.5 rounded text-xs">
                        Говорить
                    </button>
                </div>

                <div class="panel p-3 rounded bg-black/20 border border-[#333] text-[10px] text-[#a0a0a0]">
                    <div class="text-[10px] text-emerald-400 font-bold uppercase tracking-widest mb-1">Важно</div>
                    Купить животных можно только если у тебя есть <span class="text-[#c8aa6e] font-bold">дом</span> с загоном для животных.
                </div>

                <div class="space-y-3">
                    <h3 class="text-xs text-[#777] uppercase border-b border-[#333] pb-1">Животные</h3>

                    <div class="market-item-card border rounded p-3">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex gap-3">
                                <i class="fas fa-rabbit text-emerald-300 text-lg mt-1"></i>
                                <div>
                                    <div class="text-sm font-bold text-[#e0e0e0]">Кролик</div>
                                    <div class="text-[10px] text-[#777]">Для хозяйства.</div>
                                </div>
                            </div>
                            <div class="text-sm text-yellow-400 font-bold">4,000 <i class="fas fa-coins"></i></div>
                        </div>
                        <button onclick="livestock.buyAnimal('rabbit')" class="w-full py-1.5 rounded text-[10px] text-emerald-300 border border-emerald-700/40 hover:bg-emerald-900/30 transition-all" >Купить</button>
                    </div>

                    <div class="market-item-card border rounded p-3">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex gap-3">
                                <i class="fas fa-kiwi-bird text-amber-300 text-lg mt-1"></i>
                                <div>
                                    <div class="text-sm font-bold text-[#e0e0e0]">Курица</div>
                                    <div class="text-[10px] text-[#777]">Несёт яйца.</div>
                                </div>
                            </div>
                            <div class="text-sm text-yellow-400 font-bold">5,000 <i class="fas fa-coins"></i></div>
                        </div>
                        <button onclick="livestock.buyAnimal('chicken')" class="w-full py-1.5 rounded text-[10px] text-emerald-300 border border-emerald-700/40 hover:bg-emerald-900/30 transition-all" >Купить</button>
                    </div>

                    <div class="market-item-card border rounded p-3">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex gap-3">
                                <i class="fas fa-piggy-bank text-pink-300 text-lg mt-1"></i>
                                <div>
                                    <div class="text-sm font-bold text-[#e0e0e0]">Свинья</div>
                                    <div class="text-[10px] text-[#777]">Даёт мясо.</div>
                                </div>
                            </div>
                            <div class="text-sm text-yellow-400 font-bold">10,000 <i class="fas fa-coins"></i></div>
                        </div>
                        <button onclick="livestock.buyAnimal('pig')" class="w-full py-1.5 rounded text-[10px] text-emerald-300 border border-emerald-700/40 hover:bg-emerald-900/30 transition-all" >Купить</button>
                    </div>

                    <div class="market-item-card border rounded p-3">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex gap-3">
                                <i class="fas fa-cow text-white text-lg mt-1"></i>
                                <div>
                                    <div class="text-sm font-bold text-[#e0e0e0]">Корова</div>
                                    <div class="text-[10px] text-[#777]">Даёт молоко.</div>
                                </div>
                            </div>
                            <div class="text-sm text-yellow-400 font-bold">50,000 <i class="fas fa-coins"></i></div>
                        </div>
                        <button onclick="livestock.buyAnimal('cow')" class="w-full py-1.5 rounded text-[10px] text-emerald-300 border border-emerald-700/40 hover:bg-emerald-900/30 transition-all" >Купить</button>
                    </div>

                    <!-- Horses Section -->
                    <div class="space-y-3 mt-4 pt-4 border-t border-[#333]">
                        <h3 class="text-xs text-[#777] uppercase pb-1">Лошади</h3>
                        
                        <!-- Arabian -->
                        <div class="market-item-card border rounded p-3">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex gap-3">
                                    <i class="fas fa-horse text-amber-200 text-lg mt-1"></i>
                                    <div>
                                        <div class="text-sm font-bold text-[#e0e0e0]">Арабский скакун</div>
                                        <div class="text-[10px] text-[#777]">Быстрая и выносливая.</div>
                                    </div>
                                </div>
                                <div class="text-sm text-yellow-400 font-bold">150,000 <i class="fas fa-coins"></i></div>
                            </div>
                            <button onclick="livestock.buyHorse('arabian')" class="w-full py-1.5 rounded text-[10px] text-emerald-300 border border-emerald-700/40 hover:bg-emerald-900/30 transition-all" >Купить</button>
                        </div>

                        <!-- Thoroughbred -->
                        <div class="market-item-card border rounded p-3">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex gap-3">
                                    <i class="fas fa-horse-head text-orange-300 text-lg mt-1"></i>
                                    <div>
                                        <div class="text-sm font-bold text-[#e0e0e0]">Чистокровная</div>
                                        <div class="text-[10px] text-[#777]">Рождена для скачек.</div>
                                    </div>
                                </div>
                                <div class="text-sm text-yellow-400 font-bold">120,000 <i class="fas fa-coins"></i></div>
                            </div>
                            <button onclick="livestock.buyHorse('thoroughbred')" class="w-full py-1.5 rounded text-[10px] text-emerald-300 border border-emerald-700/40 hover:bg-emerald-900/30 transition-all" >Купить</button>
                        </div>

                        <!-- Draft -->
                        <div class="market-item-card border rounded p-3">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex gap-3">
                                    <i class="fas fa-weight-hanging text-stone-400 text-lg mt-1"></i>
                                    <div>
                                        <div class="text-sm font-bold text-[#e0e0e0]">Тяжеловоз</div>
                                        <div class="text-[10px] text-[#777]">Мощная. +100кг веса.</div>
                                    </div>
                                </div>
                                <div class="text-sm text-yellow-400 font-bold">80,000 <i class="fas fa-coins"></i></div>
                            </div>
                            <button onclick="livestock.buyHorse('draft')" class="w-full py-1.5 rounded text-[10px] text-emerald-300 border border-emerald-700/40 hover:bg-emerald-900/30 transition-all" >Купить</button>
                        </div>
                        
                         <!-- Pony -->
                        <div class="market-item-card border rounded p-3">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex gap-3">
                                    <i class="fas fa-horse text-yellow-600 text-lg mt-1"></i>
                                    <div>
                                        <div class="text-sm font-bold text-[#e0e0e0]">Пони</div>
                                        <div class="text-[10px] text-[#777]">Недорогая.</div>
                                    </div>
                                </div>
                                <div class="text-sm text-yellow-400 font-bold">30,000 <i class="fas fa-coins"></i></div>
                            </div>
                            <button onclick="livestock.buyHorse('pony')" class="w-full py-1.5 rounded text-[10px] text-emerald-300 border border-emerald-700/40 hover:bg-emerald-900/30 transition-all" >Купить</button>
                        </div>

                        <!-- Mustang -->
                        <div class="market-item-card border rounded p-3">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex gap-3">
                                    <i class="fas fa-wind text-slate-400 text-lg mt-1"></i>
                                    <div>
                                        <div class="text-sm font-bold text-[#e0e0e0]">Мустанг</div>
                                        <div class="text-[10px] text-[#777]">Дикая и своенравная.</div>
                                    </div>
                                </div>
                                <div class="text-sm text-yellow-400 font-bold">90,000 <i class="fas fa-coins"></i></div>
                            </div>
                            <button onclick="livestock.buyHorse('mustang')" class="w-full py-1.5 rounded text-[10px] text-emerald-300 border border-emerald-700/40 hover:bg-emerald-900/30 transition-all" >Купить</button>
                        </div>

                        <!-- Warhorse -->
                        <div class="market-item-card border rounded p-3">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex gap-3">
                                    <i class="fas fa-chess-knight text-red-500 text-lg mt-1"></i>
                                    <div>
                                        <div class="text-sm font-bold text-[#e0e0e0]">Боевой конь</div>
                                        <div class="text-[10px] text-[#777]">Тренированная для битв.</div>
                                    </div>
                                </div>
                                <div class="text-sm text-yellow-400 font-bold">250,000 <i class="fas fa-coins"></i></div>
                            </div>
                            <button onclick="livestock.buyHorse('warhorse')" class="w-full py-1.5 rounded text-[10px] text-emerald-300 border border-emerald-700/40 hover:bg-emerald-900/30 transition-all" >Купить</button>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <h3 class="text-xs text-[#777] uppercase border-b border-[#333] pb-1">Корм</h3>
                    <div class="grid grid-cols-1 gap-2">
                        <button onclick="livestock.buyFeed('feed')" class="p-3 rounded text-center border border-emerald-700/40 hover:bg-emerald-900/30 transition-all" >
                            <i class="fas fa-carrot text-orange-300 text-2xl"></i>
                            <div class="text-sm text-emerald-300 mt-2 font-bold">Корм</div>
                            <div class="text-xs text-yellow-500 mt-1">20 <i class="fas fa-coins"></i></div>
                        </button>
                    </div>
                    <p class="text-[10px] text-[#777]">Универсальный корм для всех животных. Добавляется в инвентарь как ресурс и имеет вес.</p>
                </div>
            </div>
        </section>

        <!-- VIEW: VILLAGE -->
        <section id="view-village" class="hidden space-y-4">
            <div class="loc-hero h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm" data-loc="village" style="--hero-img: none;">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(0,128,0,0.25),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-[#008000]/60 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-[#008000]/40 bg-black/30 flex items-center justify-center text-[#7ad37a] hover:bg-[#008000]/20 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-[#0f4a26]/70 to-[#0b2b17] flex items-center justify-center border-2 border-[#008000]/60 shadow-[0_0_15px_rgba(0,128,0,0.35)]">
                        <i class="fas fa-house-chimney text-[#3ddc84] text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-[#def7de] drop-shadow-md">Деревня на окраине</h2>
                </div>
            </div>

            <!-- Disease Warning -->
            <div id="measles-warning" class="hidden panel p-3 rounded border-red-500 bg-red-900/20 flex items-center gap-3">
                <i class="fas fa-virus text-red-500 text-xl animate-pulse"></i>
                <div>
                    <div class="text-sm text-red-400 font-bold">Корь!</div>
                    <div class="text-[10px] text-gray-400">-1 HP каждые 20 сек. Посетите мудреца.</div>
                </div>
            </div>

            <!-- Your House -->
            <div class="panel rounded-lg p-4 space-y-3">
                <div class="flex items-center justify-between">
                    <h3 class="medieval-font text-lg text-[#c8aa6e]"><i class="fas fa-home mr-2"></i>Ваш Дом</h3>
                    <span id="house-status" class="text-[10px] text-red-400">Не куплен</span>
                </div>
                
                <div id="house-not-owned" class="text-center py-4">
                    <i class="fas fa-house-circle-xmark text-4xl text-gray-600 mb-2"></i>
                    <p class="text-xs text-gray-400 mb-3">Купите дом, чтобы хранить вещи и заниматься хозяйством.</p>
                    <button onclick="village.buyHouse()" class="btn-medieval w-full py-2 rounded text-sm">
                        Купить дом <span class="text-emerald-400">1000 <i class="far fa-gem gem-price"></i></span>
                    </button>
                </div>

                <div id="house-owned" class="hidden space-y-3">
                    <!-- Storage -->
                    <div class="border border-[#333] rounded p-2 bg-black/20">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-box text-amber-500"></i>
                            <span class="text-xs text-[#e0e0e0]">Хранилище</span>
                        </div>
                        <p class="text-[10px] text-gray-500">Здесь можно хранить ненужные вещи (в разработке)</p>
                    </div>

                    <!-- Workbench -->
                    <div class="border border-[#333] rounded p-2 bg-black/20">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-gavel text-blue-400"></i>
                            <span class="text-xs text-[#e0e0e0]">Верстак</span>
                        </div>
                        <p class="text-[10px] text-gray-500">Создавайте новые предметы (в разработке)</p>
                    </div>

                    <!-- Stable -->
                    <div class="border border-[#333] rounded p-2 bg-black/20">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-horse-head text-amber-500"></i>
                                <span class="text-xs text-[#e0e0e0]">Конюшня (Ур <span id="stable-level">0</span>)</span>
                            </div>
                        </div>
                        <div id="stable-empty" class="text-[10px] text-gray-500 mb-2">Нет лошади</div>
                        <div id="stable-occupied" class="hidden flex items-center gap-2 mb-2 p-2 bg-[#1a1a1d] rounded border border-[#333]">
                             <div class="w-8 h-8 flex items-center justify-center bg-black/50 rounded text-[#c8aa6e]">
                                 <i id="horse-icon" class="fas fa-horse"></i>
                             </div>
                             <div>
                                 <div id="horse-name" class="text-xs text-[#e0e0e0] font-bold">Лошадь</div>
                                 <div id="horse-desc" class="text-[8px] text-gray-500">Описание</div>
                             </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="village.upgradeStable()" class="flex-1 bg-[#222] border border-amber-600 text-amber-500 py-1 rounded text-[10px] hover:bg-amber-900/30">
                                Улучшить (2000 <i class="fas fa-coins"></i>)
                            </button>
                        </div>
                    </div>

                    <!-- Pig Pen -->
                    <div class="border border-[#333] rounded p-2 bg-black/20">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-piggy-bank text-pink-400"></i>
                                <span class="text-xs text-[#e0e0e0]">Свинарник (Ур <span id="pig-pen-level">0</span>)</span>
                            </div>
                            <span class="text-[10px] text-gray-400">Мясо: <span id="meat-count">0</span></span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="village.upgradePigPen()" class="flex-1 bg-[#222] border border-pink-500 text-pink-400 py-1 rounded text-[10px] hover:bg-pink-900/30">
                                Улучшить (100 <i class="fas fa-coins"></i>)
                            </button>
                            <button onclick="village.collectMeat()" class="flex-1 bg-[#222] border border-[#c8aa6e] text-[#c8aa6e] py-1 rounded text-[10px] hover:bg-[#c8aa6e]/20">
                                Собрать мясо
                            </button>
                        </div>
                    </div>

                    <!-- Stable -->
                    <div class="border border-[#333] rounded p-2 bg-black/20">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-horse text-amber-600"></i>
                            <span class="text-xs text-[#e0e0e0]">Конюшня</span>
                        </div>
                        <p class="text-[10px] text-gray-500" id="stable-status">Пусто. Купите коня на рынке.</p>
                    </div>
                </div>
            </div>

            <!-- Sage's House -->
            <div class="p-4 rounded-lg border-indigo-500/40 space-y-3 relative" style="background: url('https://i.postimg.cc/KYjjDTKd/IMG-4607.jpg'); background-size: cover; background-position: center; box-shadow: inset 0 0 0 2000px rgba(0,0,0,0.75), 0 4px 6px rgba(0,0,0,0.3);">
                <!-- Additional overlay for gradient effect -->
                <div class="absolute inset-0 z-0 pointer-events-none" style="background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0.5)); border-radius: 0.5rem;"></div>
                <div class="absolute inset-0 z-0 pointer-events-none" style="background: radial-gradient(circle at 30% 30%, rgba(99,102,241,0.2), transparent 60%); border-radius: 0.5rem;"></div>
                
                <div class="relative z-10 flex items-center justify-between border-b border-indigo-500/30 pb-3">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full border-2 border-indigo-600/50 overflow-hidden flex-shrink-0" style="background: linear-gradient(135deg, rgba(99,102,241,0.3), rgba(0,0,0,0.5));">
                            <img src="https://i.postimg.cc/8PjyXPvd/IMG-4616.png" alt="Мудрец" class="w-full h-full object-cover object-top">
                        </div>
                        <div>
                            <div class="text-base text-[#e0e0e0] font-bold medieval-font">Мудрец Эльдар</div>
                            <div class="text-[10px] text-[#a0a0a0]">Хранитель знаний</div>
                        </div>
                    </div>
                    <button onclick="dialogue.start('sage')" class="px-4 py-2 rounded text-xs border border-indigo-700/40 bg-black/30 text-indigo-300 hover:bg-indigo-900/20 backdrop-blur-sm">
                        Говорить
                    </button>
                </div>

                <!-- Cure Measles -->
                <div id="cure-measles-section" class="relative z-10 hidden border border-red-900/50 rounded p-3 bg-red-900/20 backdrop-blur-sm">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-flask text-red-400 text-xl"></i>
                        <div>
                            <div class="text-sm font-bold text-red-300">Лечение от Кори</div>
                            <div class="text-[10px] text-gray-400">Мудрец может исцелить вас</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 text-[10px] text-gray-500 mb-2">
                        <span>Требуется:</span>
                        <span class="text-green-400">15 <i class="fas fa-leaf"></i></span>
                        <span class="text-purple-400">10 <i class="fas fa-spider"></i></span>
                    </div>
                    <button onclick="village.cureMeasles()" class="w-full py-2 rounded text-xs border border-red-700/40 bg-black/30 text-red-300 hover:bg-red-900/20 backdrop-blur-sm">
                        Исцелиться
                    </button>
                </div>

                <!-- Sage's Shop -->
                <div class="relative z-10 space-y-2">
                    <h4 class="text-xs text-indigo-400 uppercase tracking-wider font-bold">Магазин Мудреца</h4>
                    
                    <!-- Strength Potion Recipe -->
                    <div class="border border-yellow-900/50 rounded p-3 bg-yellow-900/20 backdrop-blur-sm flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-scroll text-yellow-400 text-xl"></i>
                            <div>
                                <div class="text-sm font-bold text-yellow-300">Рецепт: Зелье Силы</div>
                                <div class="text-[10px] text-gray-400">+10 к урону на 5 мин</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm gem-price font-bold">200 <i class="far fa-gem gem-price"></i></div>
                            <button onclick="ui.showFloatText(this, 'В разработке', '#777')" class="btn-medieval px-3 py-1 rounded text-[10px] mt-1">
                                Купить
                            </button>
                        </div>
                    </div>

                    <!-- Speed Potion Recipe -->
                    <div class="border border-cyan-900/50 rounded p-3 bg-cyan-900/20 backdrop-blur-sm flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-scroll text-cyan-400 text-xl"></i>
                            <div>
                                <div class="text-sm font-bold text-cyan-300">Рецепт: Зелье Скорости</div>
                                <div class="text-[10px] text-gray-400">+50% скорость работы</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm gem-price font-bold">150 <i class="far fa-gem gem-price"></i></div>
                            <button onclick="ui.showFloatText(this, 'В разработке', '#777')" class="btn-medieval px-3 py-1 rounded text-[10px] mt-1">
                                Купить
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fresh Bread Stall -->
            <div class="rounded-lg p-4 space-y-3 relative border border-amber-700/40" style="background: url('https://i.postimg.cc/6QJnHYXF/IMG-4600.jpg'); background-size: cover; background-position: center; box-shadow: inset 0 0 0 2000px rgba(0,0,0,0.7), 0 4px 6px rgba(0,0,0,0.3);">
                <!-- Additional overlay for gradient effect -->
                <div class="absolute inset-0 z-0 pointer-events-none" style="background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.4)); border-radius: 0.5rem;"></div>
                <div class="absolute inset-0 z-0 pointer-events-none" style="background: radial-gradient(circle at 30% 30%, rgba(217,119,6,0.2), transparent 60%); border-radius: 0.5rem;"></div>
                
                <div class="relative z-10 flex items-center justify-between">
                    <h3 class="medieval-font text-lg text-amber-300"><i class="fas fa-bread-slice mr-2"></i>Ларёк со свежим хлебом</h3>
                </div>
                
                <div class="relative z-10 p-3 rounded bg-amber-900/20 border border-amber-700/40 backdrop-blur-sm">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-bread-slice text-4xl text-amber-400"></i>
                            <div>
                                <div class="text-base text-[#e0e0e0] font-bold medieval-font">Свежий хлеб</div>
                                <div class="text-[10px] text-gray-400">Восстанавливает 20% голода</div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 mb-3 text-sm">
                        <span class="text-yellow-500">Цена: 20 <i class="fas fa-coins"></i></span>
                    </div>
                    <button onclick="village.buyBread(event)" class="w-full py-2 rounded text-sm text-amber-300 border border-amber-700/40 hover:bg-amber-900/30 transition-all" >
                        Купить хлеб
                    </button>
                </div>
            </div>

            <!-- Livestock Farm (Unlocks at Level 10) -->
            <div class="mt-4">
                <button id="livestock-farm-button" onclick="livestockFarm.tryOpen()" class="panel w-full p-4 rounded-lg flex items-center justify-between group transition-colors bg-black/30 backdrop-blur-sm opacity-60">
                    <div class="flex items-center gap-4">
                        <div id="livestock-farm-icon" class="w-14 h-14 rounded-full bg-gradient-to-br from-gray-800/60 to-gray-950 border-2 border-gray-600/60 flex items-center justify-center shadow-[0_0_15px_rgba(107,114,128,0.2)]">
                            <i class="fas fa-cow text-gray-500 text-2xl"></i>
                        </div>
                        <div class="text-left">
                            <div id="livestock-farm-title" class="text-base font-bold text-gray-400 medieval-font">Скотный двор</div>
                            <div id="livestock-farm-subtitle" class="text-xs text-gray-600">Ухаживайте за животными</div>
                        </div>
                    </div>
                    <div id="livestock-farm-status" class="flex items-center gap-2">
                        <i class="fas fa-lock text-gray-500 mr-2"></i>
                        <span class="text-xs text-gray-500">Ур. 10</span>
                    </div>
                </button>
            </div>
        </section>

        <!-- VIEW: LIVESTOCK FARM -->
        <section id="view-livestock-farm" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(34,197,94,0.2),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-green-500/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('village')" class="w-8 h-8 rounded border border-green-900/50 bg-black/30 flex items-center justify-center text-green-400 hover:bg-green-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-900/60 to-green-950 flex items-center justify-center border-2 border-green-500/60 shadow-[0_0_15px_rgba(34,197,94,0.3)]">
                        <i class="fas fa-cow text-green-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-green-300 drop-shadow-md">Скотный двор</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-4 space-y-3">
                <div class="flex items-center justify-between border-b border-[#333] pb-3 mb-3">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full border-2 border-green-500 bg-[#222] flex items-center justify-center shadow-[0_0_10px_rgba(34,197,94,0.3)]">
                            <i class="fas fa-cow text-green-400 text-lg"></i>
                        </div>
                        <div>
                            <div class="text-base text-[#e0e0e0] font-bold medieval-font">Скотный двор</div>
                            <div class="text-[10px] text-[#a0a0a0]">Хозяйка: Анна</div>
                        </div>
                    </div>
                    <button onclick="dialogue.start('anna')" class="btn-medieval px-4 py-2 rounded text-xs">
                        Говорить
                    </button>
                </div>

                <!-- Animals Grid -->
                <div class="grid grid-cols-2 gap-3">
                    <!-- Chicken -->
                    <div id="animal-chicken" class="border border-amber-700/50 rounded p-3 bg-amber-900/10">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-egg text-amber-400 text-xl"></i>
                            <div class="text-base text-[#e0e0e0] font-bold medieval-font">Куры</div>
                        </div>
                        <div class="text-[10px] text-gray-400 mb-2">
                            Кормление: <span id="chicken-feed-time">--:--:--</span>
                        </div>
                        <div class="text-[10px] text-green-400 mb-2">
                            <i class="fas fa-gift"></i> Яйца, Мясо
                        </div>
                        <button onclick="livestockFarm.feedAnimal('chicken', event)" id="btn-feed-chicken" class="btn-medieval w-full py-1.5 rounded text-xs">
                            Покормить (5 <i class="fas fa-seedling"></i>)
                        </button>
                    </div>

                    <!-- Cow -->
                    <div id="animal-cow" class="border border-blue-700/50 rounded p-3 bg-blue-900/10">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-cow text-blue-300 text-xl"></i>
                            <div class="text-base text-[#e0e0e0] font-bold medieval-font">Коровы</div>
                        </div>
                        <div class="text-[10px] text-gray-400 mb-2">
                            Кормление: <span id="cow-feed-time">--:--:--</span>
                        </div>
                        <div class="text-[10px] text-green-400 mb-2">
                            <i class="fas fa-gift"></i> Молоко, Кожа
                        </div>
                        <button onclick="livestockFarm.feedAnimal('cow', event)" id="btn-feed-cow" class="btn-medieval w-full py-1.5 rounded text-xs">
                            Покормить (10 <i class="fas fa-seedling"></i>)
                        </button>
                    </div>

                    <!-- Pig -->
                    <div id="animal-pig" class="border border-pink-700/50 rounded p-3 bg-pink-900/10">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-piggy-bank text-pink-400 text-xl"></i>
                            <div class="text-base text-[#e0e0e0] font-bold medieval-font">Свиньи</div>
                        </div>
                        <div class="text-[10px] text-gray-400 mb-2">
                            Кормление: <span id="pig-feed-time">--:--:--</span>
                        </div>
                        <div class="text-[10px] text-green-400 mb-2">
                            <i class="fas fa-gift"></i> Мясо
                        </div>
                        <button onclick="livestockFarm.feedAnimal('pig', event)" id="btn-feed-pig" class="btn-medieval w-full py-1.5 rounded text-xs">
                            Покормить (8 <i class="fas fa-seedling"></i>)
                        </button>
                    </div>

                    <!-- Rabbit -->
                    <div id="animal-rabbit" class="border border-gray-700/50 rounded p-3 bg-gray-900/10">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-rabbit text-gray-300 text-xl"></i>
                            <div class="text-base text-[#e0e0e0] font-bold medieval-font">Кролики</div>
                        </div>
                        <div class="text-[10px] text-gray-400 mb-2">
                            Кормление: <span id="rabbit-feed-time">--:--:--</span>
                        </div>
                        <div class="text-[10px] text-green-400 mb-2">
                            <i class="fas fa-gift"></i> Мясо, Кожа
                        </div>
                        <button onclick="livestockFarm.feedAnimal('rabbit', event)" id="btn-feed-rabbit" class="btn-medieval w-full py-1.5 rounded text-xs">
                            Покормить (3 <i class="fas fa-seedling"></i>)
                        </button>
                    </div>
                </div>

                <!-- Info -->
                <div class="text-xs text-gray-500 text-center mt-3 bg-black/20 border border-[#333] rounded p-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    Кормите животных раз в 4 часа для получения ресурсов. Корм можно купить у продавца скота.
                </div>
            </div>
        </section>

        <!-- VIEW: TRAINING CAMP -->
        <section id="view-training-camp" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(220,38,38,0.2),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-red-600/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-red-900/50 bg-black/30 flex items-center justify-center text-red-400 hover:bg-red-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-800/60 to-red-950 flex items-center justify-center border-2 border-red-600/60 shadow-[0_0_15px_rgba(220,38,38,0.3)]">
                        <i class="fas fa-shield-halved text-red-500 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-red-300 drop-shadow-md">Учебный Лагерь</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-4 space-y-4 text-center">
                 <p class="text-sm text-[#e0e0e0]">Здесь тренируются лучшие воины королевства.</p>

                 <!-- John NPC -->
                <div class="panel p-3 rounded flex items-center justify-between border-red-900/30 bg-red-900/10 text-left">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full border-2 border-red-600/50 overflow-hidden flex-shrink-0" style="background: linear-gradient(135deg, rgba(239,68,68,0.3), rgba(0,0,0,0.5));">
                            <img src="https://i.postimg.cc/fRy8FW0W/IMG-4613.png" alt="Джон" class="w-full h-full object-cover object-top">
                        </div>
                        <div>
                            <div class="text-base text-[#e0e0e0] font-bold medieval-font">Рыцарь Джон</div>
                            <div class="text-[10px] text-[#a0a0a0]">Наставник</div>
                        </div>
                    </div>
                    <button onclick="dialogue.start('john')" class="btn-medieval px-4 py-1.5 rounded text-xs">
                        Говорить
                    </button>
                </div>
                
                <div class="p-4 border border-[#333] rounded bg-black/20">
                    <i class="fas fa-dumbbell text-3xl text-gray-600 mb-2"></i>
                    <p class="text-xs text-gray-500">Тренировки временно недоступны.</p>
                </div>
            </div>
        </section>

        <!-- VIEW: MILITARY FORTRESS -->
        <section id="view-military-fortress" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(148,163,184,0.15),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-slate-500/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-slate-700/50 bg-black/30 flex items-center justify-center text-slate-300 hover:bg-slate-800/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-slate-800/60 to-slate-950 flex items-center justify-center border-2 border-slate-500/60 shadow-[0_0_15px_rgba(148,163,184,0.25)]">
                        <i class="fas fa-tower-observation text-slate-300 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-slate-200 drop-shadow-md">Военная Крепость</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-4 space-y-4">
                <div class="text-center text-xs text-[#777] bg-black/20 border border-[#333] rounded p-3">
                    За высокими стенами — железная дисциплина, оружейные склады и элитные отряды королевства.
                </div>

                <div class="panel p-3 rounded flex items-center justify-between border-slate-600/30 bg-slate-900/10">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full border border-slate-500 bg-[#222] flex items-center justify-center">
                            <i class="fas fa-shield-halved text-slate-300"></i>
                        </div>
                        <div>
                            <div class="text-base text-[#e0e0e0] font-bold medieval-font">Капрал</div>
                            <div class="text-[10px] text-[#a0a0a0]">Страж крепости</div>
                        </div>
                    </div>
                    <button onclick="dialogue.start('fortress_guard')" class="btn-medieval px-4 py-1.5 rounded text-xs">
                        Говорить
                    </button>
                </div>

                <div class="panel p-3 rounded bg-black/20 border border-[#333] text-[10px] text-[#a0a0a0]">
                    <div class="text-[10px] text-slate-300 font-bold uppercase tracking-widest mb-1">Пропуск</div>
                    Вход сюда разрешён только тем, кто прошёл подготовку в Учебном лагере.
                </div>
            </div>
        </section>

        <!-- VIEW: ROYAL CASTLE -->
        <section id="view-royal-castle" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(99,102,241,0.2),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-indigo-500/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-indigo-900/50 bg-black/30 flex items-center justify-center text-indigo-400 hover:bg-indigo-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-900/60 to-indigo-950 flex items-center justify-center border-2 border-indigo-500/60 shadow-[0_0_15px_rgba(99,102,241,0.3)]">
                        <i class="fas fa-chess-rook text-indigo-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-indigo-300 drop-shadow-md">Королевский замок</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-4 space-y-4">
                <div class="flex items-center justify-between p-3 bg-purple-900/10 rounded border border-purple-900/30">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full border-2 border-purple-600/50 overflow-hidden flex-shrink-0" style="background: linear-gradient(135deg, rgba(190,18,60,0.3), rgba(0,0,0,0.5));">
                            <img src="https://i.postimg.cc/FsKTwTc6/IMG-4669.png" alt="Стражник" class="w-full h-full object-cover object-top">
                        </div>
                        <div>
                            <div class="text-base text-[#e0e0e0] font-bold medieval-font">Стражник</div>
                            <div class="text-[10px] text-[#a0a0a0]">Королевская стража</div>
                        </div>
                    </div>
                    <button onclick="dialogue.start('castle_guard')" class="btn-medieval px-4 py-1.5 rounded text-xs">
                        Говорить
                    </button>
                </div>

                <div class="text-center text-xs text-[#777] bg-black/20 border border-[#333] rounded p-3">
                    Вход в замок закрыт для простолюдинов.
                </div>
            </div>
        </section>

        <!-- VIEW: POOR DISTRICT -->
        <section id="view-poor-district" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(120,113,108,0.15),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-stone-600/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-stone-700/50 bg-black/30 flex items-center justify-center text-stone-400 hover:bg-stone-800/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-stone-800/60 to-stone-950 flex items-center justify-center border-2 border-stone-600/60 shadow-[0_0_15px_rgba(120,113,108,0.2)]">
                        <i class="fas fa-house-crack text-stone-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-stone-300 drop-shadow-md">Район бедняков</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-4 space-y-4">
                <div class="text-center text-xs text-[#777] bg-black/20 border border-[#333] rounded p-3">
                    Узкие грязные улочки, старые лачуги и отчаянные люди. Здесь выживают, а не живут.
                </div>

                <!-- Дом Артура -->
                <div class="p-4 rounded-lg border-[#c8aa6e]/40 space-y-3 relative shadow-lg" style="background: url('https://i.postimg.cc/fkQt0tH5/IMG-4621.jpg'); background-size: cover; background-position: center; box-shadow: inset 0 0 0 2000px rgba(0,0,0,0.75), 0 4px 6px rgba(0,0,0,0.3);">
                    <!-- Additional overlay for gradient effect -->
                    <div class="absolute inset-0 z-0 pointer-events-none" style="background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0.5)); border-radius: 0.5rem;"></div>
                    <div class="absolute inset-0 z-0 pointer-events-none" style="background: radial-gradient(circle at 30% 30%, rgba(200,170,110,0.2), transparent 60%); border-radius: 0.5rem;"></div>
                    
                    <div class="relative z-10 flex items-center justify-between border-b border-[#333] pb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full border-2 border-[#c8aa6e]/50 overflow-hidden flex-shrink-0" style="background: linear-gradient(135deg, rgba(200,170,110,0.3), rgba(0,0,0,0.5));">
                                <img src="https://i.postimg.cc/Y9Yn3XLD/IMG-4611.png" alt="Артур" class="w-full h-full object-cover object-top">
                            </div>
                            <div>
                                <div class="text-base text-[#e0e0e0] font-bold medieval-font">Артур</div>
                                <div class="text-[10px] text-[#a0a0a0]">Алхимик и старый друг</div>
                            </div>
                        </div>
                        <button onclick="dialogue.start('arthur')" class="btn-medieval px-4 py-2 rounded text-xs">
                            Говорить
                        </button>
                    </div>

                    <!-- Arthur's Shop -->
                    <div class="relative z-10 space-y-2">
                        <h4 class="text-xs text-[#c8aa6e] uppercase tracking-wider font-bold">Зелья Артура</h4>
                        
                        <!-- XP Potion -->
                        <div class="border border-blue-900/50 rounded p-3 bg-blue-900/10 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-flask text-blue-400 text-xl"></i>
                                <div>
                                    <div class="text-sm font-bold text-blue-300">Зелье Опыта</div>
                                    <div class="text-[10px] text-gray-400">х2 опыт на 5 минут</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm gem-price font-bold">100 <i class="far fa-gem gem-price"></i></div>
                                <button onclick="arthurShop.buyPotion('xp', event)" class="btn-medieval px-3 py-1 rounded text-[10px] mt-1">
                                    Купить
                                </button>
                            </div>
                        </div>

                        <!-- Strength Potion -->
                        <div class="border border-red-900/50 rounded p-3 bg-red-900/10 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-dumbbell text-red-400 text-xl"></i>
                                <div>
                                    <div class="text-sm font-bold text-red-300">Зелье Силы</div>
                                    <div class="text-[10px] text-gray-400">х2 урон на 5 минут</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm gem-price font-bold">100 <i class="far fa-gem gem-price"></i></div>
                                <button onclick="arthurShop.buyPotion('strength', event)" class="btn-medieval px-3 py-1 rounded text-[10px] mt-1">
                                    Купить
                                </button>
                            </div>
                        </div>

                        <!-- Quest: Bring 100 Herbs -->
                        <div id="arthur-quest-herbs" class="border border-green-900/50 rounded p-3 bg-green-900/10">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-leaf text-green-400 text-xl"></i>
                                    <div>
                                        <div class="text-sm font-bold text-green-300">Заказ Артура</div>
                                        <div class="text-[10px] text-gray-400">Принести 100 трав</div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-400 mb-2">
                                <span id="arthur-herbs-count">0</span> / 100 трав собрано
                            </div>
                            <div class="text-[10px] text-green-400 mb-2">
                                <i class="fas fa-gift mr-1"></i>Награда: Зелье Силы (навсегда +5 урона)
                            </div>
                            <button id="btn-arthur-herbs" onclick="arthurShop.completeHerbQuest(event)" disabled class="btn-medieval w-full py-1.5 rounded text-xs">
                                Отдать травы
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Старый нищий -->
                <div class="panel p-3 rounded flex items-center justify-between border-gray-700/30 bg-gray-900/20">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full border-2 border-gray-500 bg-[#222] flex items-center justify-center shadow-[0_0_10px_rgba(107,114,128,0.3)]">
                            <i class="fas fa-user-injured text-gray-400"></i>
                        </div>
                        <div>
                            <div class="text-base text-[#e0e0e0] font-bold medieval-font">Старый нищий</div>
                            <div class="text-[10px] text-[#a0a0a0]">Просит милостыню</div>
                        </div>
                    </div>
                    <button class="btn-medieval px-4 py-1.5 rounded text-xs" onclick="dialogue.start('old_beggar')">Говорить</button>
                </div>

                <!-- Благотворительная столовая -->
                <div class="panel p-3 rounded flex items-center justify-between border-green-700/30 bg-green-900/10">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full border border-green-600 bg-[#222] flex items-center justify-center">
                            <i class="fas fa-bowl-food text-green-500"></i>
                        </div>
                        <div>
                            <div class="text-base text-[#e0e0e0] font-bold medieval-font">Столовая для бедных</div>
                            <div class="text-[10px] text-[#a0a0a0]">+50% сытости • до 7 уровня • 1 раз/день</div>
                            <div class="text-[10px] text-green-400 mt-1">До следующего бесплатного посещения: <span id="poor-canteen-timer">--:--:--</span></div>
                        </div>
                    </div>
                    <button id="btn-poor-canteen" class="btn-medieval px-4 py-1.5 rounded text-xs" onclick="poorDistrict.eatCanteen(event)">Поесть</button>
                </div>

                <!-- Ларёк со свежим хлебом -->
                <div class="rounded-lg p-4 space-y-3 relative border border-amber-700/40" style="background: url('https://i.postimg.cc/6QJnHYXF/IMG-4600.jpg'); background-size: cover; background-position: center; box-shadow: inset 0 0 0 2000px rgba(0,0,0,0.7), 0 4px 6px rgba(0,0,0,0.3);">
                    <!-- Additional overlay for gradient effect -->
                    <div class="absolute inset-0 z-0 pointer-events-none" style="background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.4)); border-radius: 0.5rem;"></div>
                    <div class="absolute inset-0 z-0 pointer-events-none" style="background: radial-gradient(circle at 30% 30%, rgba(217,119,6,0.2), transparent 60%); border-radius: 0.5rem;"></div>
                    
                    <div class="relative z-10 flex items-center justify-between">
                        <h3 class="medieval-font text-lg text-amber-300"><i class="fas fa-bread-slice mr-2"></i>Ларёк со свежим хлебом</h3>
                    </div>
                    
                    <div class="relative z-10 p-3 rounded bg-amber-900/20 border border-amber-700/40 backdrop-blur-sm">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-bread-slice text-4xl text-amber-400"></i>
                                <div>
                                    <div class="text-base text-[#e0e0e0] font-bold medieval-font">Свежий хлеб</div>
                                    <div class="text-[10px] text-gray-400">Восстанавливает 20% голода</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mb-3 text-sm">
                            <span class="text-yellow-500">Цена: 20 <i class="fas fa-coins"></i></span>
                        </div>
                        <button onclick="poorDistrict.buyBread(event)" class="w-full py-2 rounded text-sm text-amber-300 border border-amber-700/40 hover:bg-amber-900/30 transition-all" >
                            Купить хлеб
                        </button>
                    </div>
                </div>

                <!-- Азартный игрок -->
                <div class="panel p-3 rounded flex items-center justify-between border-yellow-700/30 bg-yellow-900/10">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full border border-yellow-600 bg-[#222] flex items-center justify-center">
                            <i class="fas fa-dice text-yellow-500"></i>
                        </div>
                        <div>
                            <div class="text-base text-[#e0e0e0] font-bold medieval-font">Азартный игрок</div>
                            <div class="text-[10px] text-[#a0a0a0]">Предлагает сыграть в кости</div>
                        </div>
                    </div>
                    <button class="btn-medieval px-4 py-1.5 rounded text-xs" onclick="dialogue.start('gambler')">Сыграть</button>
                </div>

                <!-- Poor House Section -->
                <div class="panel rounded p-3 space-y-3 border-t border-[#333] bg-black/10">
                    <h3 class="medieval-font text-sm text-gray-400"><i class="fas fa-home mr-2"></i>Старый Дом</h3>
                    
                    <div id="poor-house-buy" class="text-center py-2">
                        <p class="text-xs text-gray-500 mb-2">Ветхая лачуга, но крыша не течёт. Есть хранилище, верстак и печь.</p>
                        <button onclick="housing.buyPoorHouse()" class="btn-medieval w-full py-2 rounded text-sm text-gray-300 border-gray-600">
                            Купить (500 <i class="far fa-gem gem-price"></i>)
                        </button>
                    </div>

                    <div id="poor-house-owned" class="hidden grid grid-cols-3 gap-2">
                        <div class="panel p-2 rounded flex flex-col items-center text-center bg-black/20">
                            <i class="fas fa-box text-amber-700 mb-1"></i>
                            <div class="text-[10px] text-gray-400">Склад</div>
                        </div>
                        <div class="panel p-2 rounded flex flex-col items-center text-center bg-black/20">
                            <i class="fas fa-hammer text-gray-500 mb-1"></i>
                            <div class="text-[10px] text-gray-400">Верстак</div>
                        </div>
                        <div class="panel p-2 rounded flex flex-col items-center text-center bg-black/20">
                            <i class="fas fa-fire text-orange-600 mb-1"></i>
                            <div class="text-[10px] text-gray-400">Печь</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: NOBLE QUARTER -->
        <section id="view-noble-quarter" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(234,179,8,0.2),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-yellow-500/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-yellow-900/50 bg-black/30 flex items-center justify-center text-yellow-400 hover:bg-yellow-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-yellow-900/60 to-yellow-950 flex items-center justify-center border-2 border-yellow-500/60 shadow-[0_0_15px_rgba(234,179,8,0.3)]">
                        <i class="fas fa-crown text-yellow-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-yellow-300 drop-shadow-md">Дворянский квартал</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-4 space-y-4">
                <div class="text-center text-xs text-[#777] bg-black/20 border border-[#333] rounded p-3">
                    Мраморные особняки, золотые ворота и надменные взгляды. Здесь правит власть и честь.
                </div>
                <div class="panel p-3 rounded flex items-center justify-between border-yellow-900/30 bg-yellow-900/10">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full border-2 border-yellow-600/50 overflow-hidden flex-shrink-0" style="background: linear-gradient(135deg, rgba(180,83,9,0.3), rgba(0,0,0,0.5));">
                            <img src="https://i.postimg.cc/5y4CYk1g/IMG-4664.png" alt="Леонард" class="w-full h-full object-cover object-top">
                        </div>
                        <div>
                            <div class="text-base text-[#e0e0e0] font-bold medieval-font">Леонард</div>
                            <div class="text-[10px] text-[#a0a0a0]">Советник квартала</div>
                        </div>
                    </div>
                    <button class="btn-medieval px-4 py-1.5 rounded text-xs" onclick="dialogue.start('leonard')">Говорить</button>
                </div>

                <!-- Noble House Section -->
                <div class="panel rounded p-3 space-y-3 border-t border-yellow-600/30">
                    <h3 class="medieval-font text-sm text-yellow-500"><i class="fas fa-landmark mr-2"></i>Роскошный Особняк</h3>
                    
                    <div id="noble-house-buy" class="text-center py-2">
                        <p class="text-xs text-yellow-700/70 mb-2">Дом для истинной знати. Галерея, конюшня, оружейная.</p>
                        <button onclick="housing.buyNobleHouse()" class="btn-medieval w-full py-2 rounded text-sm text-yellow-200 border-yellow-600 bg-yellow-900/20">
                            Купить (10,000 <i class="far fa-gem gem-price"></i>)
                        </button>
                    </div>

                    <div id="noble-house-owned" class="hidden space-y-2">
                        <div class="grid grid-cols-2 gap-2">
                            <div class="panel p-2 rounded flex items-center gap-2 bg-black/30 border border-yellow-900/30">
                                <i class="fas fa-palette text-pink-400"></i>
                                <div class="text-[10px] text-gray-300">Галерея Искусств</div>
                            </div>
                            <div class="panel p-2 rounded flex items-center gap-2 bg-black/30 border border-yellow-900/30">
                                <i class="fas fa-shield-halved text-gray-300"></i>
                                <div class="text-[10px] text-gray-300">Оружейная</div>
                            </div>
                            <div class="panel p-2 rounded flex items-center gap-2 bg-black/30 border border-yellow-900/30">
                                <i class="fas fa-horse-head text-amber-600"></i>
                                <div class="text-[10px] text-gray-300">Конюшня (2 места)</div>
                            </div>
                            <div class="panel p-2 rounded flex items-center gap-2 bg-black/30 border border-yellow-900/30">
                                <i class="fas fa-wine-glass text-purple-500"></i>
                                <div class="text-[10px] text-gray-300">Виноградник</div>
                            </div>
                        </div>
                        <div class="panel p-2 rounded flex items-center justify-between bg-black/30 border border-yellow-900/30">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-cow text-white"></i>
                                <div class="text-[10px] text-gray-300">Хозяйство</div>
                            </div>
                            <span class="text-[10px] text-yellow-600">Ур. 1</span>
                        </div>
                    </div>
                </div>

                <!-- Lily's House Button -->
                <div class="mt-4" id="lily-house-btn-wrap" style="display:none;">
                    <button onclick="router.navigate('lily-house')" class="panel w-full p-0 rounded-lg overflow-hidden group hover:border-pink-500 transition-all relative h-20">
                        <div class="absolute inset-0 bg-gradient-to-b from-pink-900/30 via-purple-900/20 to-black/60"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(236,72,153,0.2),transparent_60%)]"></div>
                        <div class="absolute inset-0 flex items-center justify-between p-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-pink-900/60 to-pink-950 border-2 border-pink-500/60 flex items-center justify-center shadow-[0_0_10px_rgba(236,72,153,0.3)]">
                                    <i class="fas fa-heart text-pink-400"></i>
                                </div>
                                <div class="text-left">
                                    <div class="text-sm font-bold text-pink-300 medieval-font">Дом Лили</div>
                                    <div class="text-[10px] text-pink-400/70">Особняк дворянки</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-500 group-hover:text-pink-500"></i>
                        </div>
                    </button>
                </div>

                <!-- Guest House Button -->
                <div class="mt-4">
                    <button onclick="router.navigate('guest-house')" class="panel w-full p-0 rounded-lg overflow-hidden group hover:border-purple-500 transition-all relative h-20">
                        <div class="absolute inset-0 bg-gradient-to-b from-purple-900/30 via-indigo-900/20 to-black/60"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(168,85,247,0.2),transparent_60%)]"></div>
                        <div class="absolute inset-0 flex items-center justify-between p-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-900/60 to-purple-950 border-2 border-purple-500/60 flex items-center justify-center shadow-[0_0_10px_rgba(168,85,247,0.3)]">
                                    <i class="fas fa-wine-glass-alt text-purple-400"></i>
                                </div>
                                <div class="text-left">
                                    <div class="text-sm font-bold text-purple-300 medieval-font">Гостевой Дом</div>
                                    <div class="text-[10px] text-purple-400/70">Элитный отдых</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-500 group-hover:text-purple-500"></i>
                        </div>
                    </button>
                </div>
            </div>
        </section>

        <!-- VIEW: LILY'S HOUSE -->
        <section id="view-lily-house" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm">
                <div class="absolute inset-0 bg-gradient-to-b from-pink-900/30 via-purple-900/20 to-black/60"></div>
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(236,72,153,0.25),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-pink-500/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('noble-quarter')" class="w-8 h-8 rounded border border-pink-900/50 bg-black/30 flex items-center justify-center text-pink-400 hover:bg-pink-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-pink-900/60 to-pink-950 flex items-center justify-center border-2 border-pink-500/60 shadow-[0_0_15px_rgba(236,72,153,0.35)]">
                        <i class="fas fa-heart text-pink-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-pink-300 drop-shadow-md">Дом Лили</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-4 space-y-4">
                <div class="text-center text-xs text-pink-400/70 bg-black/20 border border-pink-900/30 rounded p-3">
                    Изящный особняк, утопающий в розах. В окнах мерцает теплый свет свечей.
                </div>

                <!-- Lily NPC -->
                <div class="panel p-3 rounded flex items-center justify-between border-pink-900/30">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full border-2 border-pink-500 bg-gradient-to-br from-pink-900/60 to-pink-950 flex items-center justify-center shadow-[0_0_10px_rgba(236,72,153,0.3)]">
                            <i class="fas fa-user-crown text-pink-400 text-lg"></i>
                        </div>
                        <div>
                            <div class="text-base text-pink-200 font-bold medieval-font">Лили</div>
                            <div class="text-[10px] text-pink-400/70">Дворянка</div>
                        </div>
                    </div>
                    <button onclick="dialogue.start('lily_home')" class="btn-medieval px-4 py-2 rounded text-xs border-pink-500 text-pink-300">
                        Поговорить
                    </button>
                </div>

                <!-- Quest Status -->
                <div id="lily-quest-status" class="hidden panel p-3 rounded border-pink-900/30 bg-pink-900/10">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-book text-pink-400"></i>
                        <div class="text-sm text-pink-200 font-bold">Любимая книга Лили</div>
                    </div>
                    <div class="text-[10px] text-pink-400/70">
                        Лили потеряла свою любимую книгу где-то в городе. Попробуй её найти.
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: GUEST HOUSE -->
        <section id="view-guest-house" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm">
                <div class="absolute inset-0 bg-gradient-to-b from-purple-900/30 via-indigo-900/20 to-black/60"></div>
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(168,85,247,0.2),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-purple-500/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('noble-quarter')" class="w-8 h-8 rounded border border-purple-900/50 bg-black/30 flex items-center justify-center text-purple-400 hover:bg-purple-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-900/60 to-purple-950 flex items-center justify-center border-2 border-purple-500/60 shadow-[0_0_15px_rgba(168,85,247,0.35)]">
                        <i class="fas fa-wine-glass-alt text-purple-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-purple-300 drop-shadow-md">Гостевой Дом</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-4 space-y-4">
                <div class="text-center text-xs text-purple-400/70 bg-black/20 border border-purple-900/30 rounded p-3">
                    Место, где знать отдыхает от интриг. Лучшее вино, изысканные блюда и азартные игры.
                </div>

                <!-- Sarah NPC -->
                <div class="panel p-3 rounded flex items-center justify-between border-purple-900/30">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full border-2 border-purple-500 bg-gradient-to-br from-purple-900/60 to-purple-950 flex items-center justify-center shadow-[0_0_10px_rgba(168,85,247,0.3)] overflow-hidden">
                            <img src="https://i.postimg.cc/fWcmXfxm/IMG-4671.png" alt="Сара" class="w-full h-full object-cover object-top">
                        </div>
                        <div>
                            <div class="text-base text-purple-200 font-bold medieval-font">Сара</div>
                            <div class="text-[10px] text-purple-400/70">Дочь владельца</div>
                        </div>
                    </div>
                    <button onclick="dialogue.start('sarah')" class="btn-medieval px-4 py-2 rounded text-xs border-purple-500 text-purple-300">
                        Поговорить
                    </button>
                </div>

                <!-- High-End Food -->
                <div class="panel rounded p-4 space-y-3 border-purple-900/30">
                    <h3 class="medieval-font text-lg text-purple-300">Изысканная Кухня</h3>
                    <p class="text-xs text-[#a0a0a0]">Восстанавливает 100 HP и 100 сытости.</p>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="locations.guestHouseEat('meatpie')" class="panel p-2 rounded flex flex-col items-center bg-[#222] border border-[#333] hover:border-purple-500 transition-colors group">
                            <i class="fas fa-bread-slice text-amber-600 text-2xl mb-2 group-hover:scale-110 transition-transform"></i>
                            <span class="text-xs text-[#e0e0e0] font-bold">Пирог с Мясом</span>
                            <span class="text-[10px] text-yellow-500 mt-1">1000 <i class="fas fa-coins"></i></span>
                        </button>
                        <button onclick="locations.guestHouseEat('julienne')" class="panel p-2 rounded flex flex-col items-center bg-[#222] border border-[#333] hover:border-purple-500 transition-colors group">
                            <i class="fas fa-bowl-food text-yellow-200 text-2xl mb-2 group-hover:scale-110 transition-transform"></i>
                            <span class="text-xs text-[#e0e0e0] font-bold">Жульен</span>
                            <span class="text-[10px] text-yellow-500 mt-1">1000 <i class="fas fa-coins"></i></span>
                        </button>
                    </div>
                </div>

                <!-- High Stakes Card Game -->
                <div class="panel rounded-lg p-4 relative overflow-hidden border-purple-900/30 bg-black/30 backdrop-blur-sm">
                    <div class="relative z-10">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <h3 class="medieval-font text-lg text-purple-300">Блэкджек</h3>
                                <p class="text-[10px] text-[#a0a0a0]">Классическая карточная игра. Ставки от 2000 до 25000 золота.</p>
                            </div>
                        </div>
                        
                        <button id="btn-play-cards" onclick="locations.guestHousePlayCards()" class="w-full py-2 rounded font-bold border border-purple-700/40 bg-black/30 text-purple-300 hover:bg-purple-900/20 backdrop-blur-sm transition-all">
                            <i class="fas fa-cards mr-2"></i>Играть в Блэкджек
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: KNIGHT TOURNAMENT -->
        <section id="view-knight-tournament" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(217,119,6,0.2),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-amber-500/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-amber-900/50 bg-black/30 flex items-center justify-center text-amber-400 hover:bg-amber-900/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-800/70 to-amber-950 flex items-center justify-center border-2 border-amber-500/70 shadow-[0_0_15px_rgba(217,119,6,0.4)]">
                        <i class="fas fa-chess-knight text-amber-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-amber-300 drop-shadow-md">Рыцарский Турнир</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-4 space-y-4">
                <div class="text-center text-xs text-[#777] bg-black/20 border border-[#333] rounded p-3">
                    Арена, где рыцари сражаются за честь и славу. Звон мечей, крики толпы и запах победы.
                </div>

                <!-- Tournament Master -->
                <div class="panel p-4 rounded-lg border-amber-900/40 bg-black/30 backdrop-blur-sm space-y-3">
                    <div class="flex items-center justify-between border-b border-amber-900/30 pb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full border-2 border-amber-600/50 overflow-hidden flex-shrink-0" style="background: linear-gradient(135deg, rgba(217,119,6,0.3), rgba(0,0,0,0.5));">
                                <img src="https://i.postimg.cc/50vfQPDr/IMG-4619.png" alt="Мастер турниров" class="w-full h-full object-cover object-top">
                            </div>
                            <div>
                                <div class="text-base text-amber-200 font-bold medieval-font">Мастер Турниров</div>
                                <div class="text-[10px] text-amber-400/60">Организатор состязаний</div>
                            </div>
                        </div>
                        <button onclick="dialogue.start('tournamentmaster')" class="btn-medieval px-4 py-2 rounded text-xs">
                            Говорить
                        </button>
                    </div>

                    <!-- Tournament Info -->
                    <div class="space-y-3">
                        <div class="text-xs text-amber-300/80 text-center italic">
                            "Докажите свою доблесть на арене! Победители получат золото и славу!"
                        </div>
                        
                        <!-- Tournament Options -->
                        <div class="space-y-2">
                            <!-- Beginner Tournament -->
                            <div class="border border-green-900/50 rounded p-3 bg-green-900/10">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-3">
                                        <i class="fas fa-shield text-green-400 text-xl"></i>
                                        <div>
                                            <div class="text-sm font-bold text-green-300">Турнир Новичков</div>
                                            <div class="text-[10px] text-gray-400">Требуется: Ур. 5 | Награда: 50 золота</div>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="tournamentBattle.startTournament('beginner')" class="btn-medieval w-full py-2 rounded text-xs">
                                    <i class="fas fa-swords mr-2"></i> Участвовать
                                </button>
                            </div>

                            <!-- Warrior Tournament -->
                            <div class="border border-blue-900/50 rounded p-3 bg-blue-900/10">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-3">
                                        <i class="fas fa-sword text-blue-400 text-xl"></i>
                                        <div>
                                            <div class="text-sm font-bold text-blue-300">Турнир Воинов</div>
                                            <div class="text-[10px] text-gray-400">Требуется: Ур. 10 | Награда: 1500 золота</div>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="tournamentBattle.startTournament('warrior')" class="btn-medieval w-full py-2 rounded text-xs">
                                    <i class="fas fa-swords mr-2"></i> Участвовать
                                </button>
                            </div>

                            <!-- Champion Tournament -->
                            <div class="border border-red-900/50 rounded p-3 bg-red-900/10">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-3">
                                        <i class="fas fa-trophy text-red-400 text-xl"></i>
                                        <div>
                                            <div class="text-sm font-bold text-red-300">Турнир Чемпионов</div>
                                            <div class="text-[10px] text-gray-400">Требуется: Ур. 20 | Награда: 5000 золота</div>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="tournamentBattle.startTournament('champion')" class="btn-medieval w-full py-2 rounded text-xs">
                                    <i class="fas fa-swords mr-2"></i> Участвовать
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Leaderboard -->
                <div class="panel rounded p-4 space-y-3 border-t border-amber-600/30">
                    <h3 class="medieval-font text-sm text-amber-500 flex items-center gap-2">
                        <i class="fas fa-medal"></i>
                        Таблица Лидеров
                    </h3>
                    
                    <div class="space-y-2">
                        <div class="flex items-center justify-between p-2 bg-gradient-to-r from-yellow-900/20 to-transparent rounded border-l-2 border-yellow-500">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-yellow-900/40 flex items-center justify-center border border-yellow-600">
                                    <span class="text-yellow-400 font-bold text-sm">1</span>
                                </div>
                                <div>
                                    <div class="text-sm text-yellow-300 font-bold">Сэр Гэлахад</div>
                                    <div class="text-[10px] text-gray-400">152 победы</div>
                                </div>
                            </div>
                            <i class="fas fa-crown text-yellow-500 text-lg"></i>
                        </div>
                        
                        <div class="flex items-center justify-between p-2 bg-gradient-to-r from-gray-400/20 to-transparent rounded border-l-2 border-gray-400">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-gray-700/40 flex items-center justify-center border border-gray-500">
                                    <span class="text-gray-300 font-bold text-sm">2</span>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-200 font-bold">Рыцарь Ланселот</div>
                                    <div class="text-[10px] text-gray-400">128 побед</div>
                                </div>
                            </div>
                            <i class="fas fa-medal text-gray-400 text-lg"></i>
                        </div>
                        
                        <div class="flex items-center justify-between p-2 bg-gradient-to-r from-amber-700/20 to-transparent rounded border-l-2 border-amber-700">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-amber-900/40 flex items-center justify-center border border-amber-600">
                                    <span class="text-amber-400 font-bold text-sm">3</span>
                                </div>
                                <div>
                                    <div class="text-sm text-amber-200 font-bold">Леди Гвиневра</div>
                                    <div class="text-[10px] text-gray-400">94 победы</div>
                                </div>
                            </div>
                            <i class="fas fa-medal text-amber-600 text-lg"></i>
                        </div>
                        
                        <div class="text-center py-2">
                            <button onclick="ui.showFloatText(this, 'Скоро...', '#c8aa6e')" class="text-xs text-amber-500 hover:text-amber-400 transition-colors">
                                Показать больше <i class="fas fa-chevron-down ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: REFUGEE CAMP -->
        <section id="view-refugee-camp" class="hidden space-y-4">
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(100,116,139,0.15),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-slate-600/50 to-transparent"></div>
                <div class="absolute top-4 left-4">
                    <button onclick="router.navigate('map')" class="w-8 h-8 rounded border border-slate-700/50 bg-black/30 flex items-center justify-center text-slate-400 hover:bg-slate-800/30 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-16 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-slate-800/60 to-slate-950 flex items-center justify-center border-2 border-slate-600/60 shadow-[0_0_15px_rgba(100,116,139,0.2)]">
                        <i class="fas fa-campground text-slate-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-slate-300 drop-shadow-md">Лагерь беженцев</h2>
                </div>
            </div>

            <div class="panel rounded-lg p-4 space-y-4">
                <div class="text-center text-xs text-[#777] bg-black/20 border border-[#333] rounded p-3">
                    Палатки из тряпья, потухшие костры и тихие разговоры о лучшей жизни за границей.
                </div>

                <!-- Escort Work -->
                <div class="p-3 border border-red-900/50 rounded bg-red-900/10 flex flex-col gap-2">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded bg-[#222] flex items-center justify-center text-red-500 border border-red-900">
                                <i class="fas fa-route"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-sm text-gray-200">Переправить беженцев</h4>
                                <p class="text-[10px] text-gray-500">Опасная работа, требует меч</p>
                            </div>
                        </div>
                    </div>
                    <button id="btn-escort-refugees" onclick="refugeeCamp.startEscort(event)" class="btn-medieval w-full py-2 rounded text-xs border-red-900 text-red-500 hover:bg-red-900/20">
                        Переправить (Раз в 3 часа)
                    </button>
                    <div class="flex justify-between text-[10px] text-gray-500 px-1">
                        <span class="text-red-400">-5 репутация</span>
                        <span class="text-emerald-400">+8 изумрудов</span>
                    </div>
                    <div id="escort-cooldown" class="text-[10px] text-center text-amber-400 hidden"></div>
                </div>

                <div class="panel p-3 rounded flex items-center justify-between border-gray-600/30 bg-gray-800/10">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full border border-gray-500 bg-[#222] flex items-center justify-center">
                            <i class="fas fa-user-secret text-gray-400"></i>
                        </div>
                        <div>
                            <div class="text-base text-[#e0e0e0] font-bold medieval-font">Томас</div>
                            <div class="text-[10px] text-[#a0a0a0]">Перевозчик</div>
                        </div>
                    </div>
                    <button onclick="dialogue.start('thomas')" class="btn-medieval px-4 py-1.5 rounded text-xs">
                        Говорить
                    </button>
                </div>
            </div>
        </section>

        <!-- VIEW: QUESTS -->
        <section id="view-quests" class="hidden space-y-4">
            <!-- Quests Header -->
            <div class="h-20 w-full relative rounded-lg mb-4 overflow-hidden bg-black/30 backdrop-blur-sm">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(217,119,6,0.15),transparent_60%)]"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-amber-500/50 to-transparent"></div>
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-900/60 to-amber-950 flex items-center justify-center border-2 border-amber-500/60 shadow-[0_0_15px_rgba(217,119,6,0.3)]">
                        <i class="fas fa-scroll text-amber-400 text-lg"></i>
                    </div>
                    <h2 class="medieval-font text-2xl text-amber-300 drop-shadow-md">Задания</h2>
                </div>
            </div>
             
             <!-- Quest Tabs -->
             <div class="flex items-center justify-center gap-2 overflow-x-auto pb-2 mb-4 no-scrollbar">
                <button onclick="quests.switchTab('daily')" id="tab-quests-daily" class="sub-tab active">Ежедневные</button>
                <button onclick="quests.switchTab('character')" id="tab-quests-character" class="sub-tab">Персонажи</button>
            </div>

            <div id="quests-list" class="space-y-3 pb-20">
                <!-- Quests populated by JS -->
            </div>
        </section>

    </main>

    <!-- Bottom Navigation -->
    <nav class="h-16 bg-[#141417] border-t border-[#333] flex justify-around items-center z-30 shrink-0 shadow-[0_-5px_15px_rgba(0,0,0,0.5)]">
        <button onclick="router.switchTab('map')" class="nav-item flex-1 flex flex-col items-center justify-center h-full text-[#777] hover:text-[#c8aa6e] transition-colors" id="nav-map">
            <i class="fas fa-map-marked-alt mb-1 text-lg"></i>
            <span class="text-[10px] uppercase tracking-wider font-serif">Карта</span>
        </button>
        <button onclick="router.switchTab('market')" class="nav-item flex-1 flex flex-col items-center justify-center h-full text-[#777] hover:text-[#c8aa6e] transition-colors" id="nav-market">
            <i class="fas fa-shopping-bag mb-1 text-lg"></i>
            <span class="text-[10px] uppercase tracking-wider font-serif">Рынок</span>
        </button>
        <button onclick="router.switchTab('quests')" class="nav-item flex-1 flex flex-col items-center justify-center h-full text-[#777] hover:text-[#c8aa6e] transition-colors" id="nav-quests">
            <i class="fas fa-scroll mb-1 text-lg"></i>
            <span class="text-[10px] uppercase tracking-wider font-serif">Задания</span>
        </button>
        <button onclick="router.switchTab('character')" class="nav-item active flex-1 flex flex-col items-center justify-center h-full text-[#777] hover:text-[#c8aa6e] transition-colors" id="nav-character">
            <i class="fas fa-user-shield mb-1 text-lg"></i>
            <span class="text-[10px] uppercase tracking-wider font-serif">Герой</span>
        </button>
    </nav>

    <!-- Developer Panel -->
    <div id="dev-panel" class="dev-panel-overlay">
        <div class="dev-panel-content">
            <div class="p-4 border-b-2 border-purple-600 flex justify-between items-center">
                <h2 class="text-xl font-bold medieval-font" style="color: #ff00ff;">🔧 Developer Panel</h2>
                <button onclick="devPanel.close()" class="text-2xl text-purple-500 hover:text-purple-300" style="line-height: 1;">&times;</button>
            </div>
            
            <div class="p-4">
                <!-- Search -->
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-2">🔍 Поиск по ID или Username</label>
                    <input 
                        type="text" 
                        id="dev-search" 
                        class="dev-search-input" 
                        placeholder="Введите ID или username..."
                        oninput="devPanel.search(this.value)"
                    >
                </div>

                <!-- Players List -->
                <div id="dev-players-list" class="mb-4" style="max-height: 300px; overflow-y: auto;">
                    <!-- Players will be listed here -->
                </div>

                <!-- Player Details -->
                <div id="dev-player-details" class="hidden">
                    <div class="border-t-2 border-purple-600 pt-4 mt-4">
                        <h3 class="text-lg font-bold mb-3" style="color: #ff00ff;">Редактирование игрока</h3>
                        
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">ID</label>
                                <input type="text" id="dev-edit-id" class="dev-stat-input" readonly>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Username</label>
                                <input type="text" id="dev-edit-username" class="dev-stat-input" readonly>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">💰 Золото</label>
                                <input type="number" id="dev-edit-gold" class="dev-stat-input">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">💎 Изумруды</label>
                                <input type="number" id="dev-edit-gems" class="dev-stat-input">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">⚔️ Уровень</label>
                                <input type="number" id="dev-edit-level" class="dev-stat-input" min="1" max="60">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">✨ Опыт</label>
                                <input type="number" id="dev-edit-xp" class="dev-stat-input" min="0">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">❤️ Здоровье</label>
                                <input type="number" id="dev-edit-hp" class="dev-stat-input" min="0" max="100">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">🍖 Сытость</label>
                                <input type="number" id="dev-edit-hunger" class="dev-stat-input" min="0" max="100">
                            </div>
                        </div>

                        <div class="flex gap-2">
                            <button id="dev-btn-save" onclick="devPanel.savePlayer(event)" class="dev-btn flex-1">💾 Сохранить</button>
                            <button id="dev-btn-delete" onclick="devPanel.deletePlayer(event)" class="dev-btn flex-1" style="background: linear-gradient(to bottom, #dc2626, #991b1b);">🗑️ Удалить</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const TOOLS_DB = {
            rod: { id: 'rod', name: 'Удочка', baseCost: 50, icon: 'icon-rod', job: 'port' },
            sickle: { id: 'sickle', name: 'Серп', baseCost: 500, icon: 'icon-sickle', job: 'field' },
            pickaxe: { id: 'pickaxe', name: 'Кирка', baseCost: 2000, icon: 'icon-pickaxe', job: 'mine' },
            crossbow: { id: 'crossbow', name: 'Арбалет', baseCost: 5000, icon: 'fa-crosshairs', job: null },
            sword: { id: 'sword', name: 'Меч', baseCost: 1000, icon: 'fa-khanda', job: 'guard' }
        };

        const SWORDS_DB = {
            wooden: { id: 'wooden', name: 'Деревянный меч', cost: 5000, costType: 'gold', damage: 5, icon: 'icon-sword-generic', color: '#888888', rarity: 'common' },
            stone: { id: 'stone', name: 'Каменный меч', cost: 15000, costType: 'gold', damage: 15, icon: 'icon-sword-generic', color: '#6c9fff', rarity: 'uncommon' },
            metal: { id: 'metal', name: 'Металлический меч', cost: 200, costType: 'emeralds', damage: 25, icon: 'icon-sword-generic', color: '#e87ba8', rarity: 'rare' },
            steel: { id: 'steel', name: 'Стальной меч', cost: 500, costType: 'emeralds', damage: 40, icon: 'icon-sword-generic', color: '#ef4444', rarity: 'epic' },
            silver: { id: 'silver', name: 'Серебряный меч мастера', cost: 1500, costType: 'emeralds', damage: 60, icon: 'icon-sword-generic', color: '#c8aa6e', rarity: 'legendary' }
        };

        const ARMOR_DB = {
            leather: { id: 'leather', name: 'Кожаная броня', cost: 10000, costType: 'gold', armor: 5, icon: 'icon-armor-generic', color: '#888888' },
            improved: { id: 'improved', name: 'Улучшенная кожаная броня', cost: 30000, costType: 'gold', armor: 15, icon: 'icon-armor-generic', color: '#6c9fff' },
            chainmail: { id: 'chainmail', name: 'Кольчужная броня', cost: 200, costType: 'emeralds', armor: 25, icon: 'icon-armor-generic', color: '#e87ba8' },
            iron: { id: 'iron', name: 'Железная броня', cost: 600, costType: 'emeralds', armor: 40, icon: 'icon-armor-generic', color: '#ef4444' },
            silver_master: { id: 'silver_master', name: 'Серебряная броня мастера', cost: 1200, costType: 'emeralds', armor: 60, icon: 'icon-armor-generic', color: '#c8aa6e' }
        };

        const JOBS_DB = {
            port: { name: 'Порт', resource: 'fish', price: 5, xp: 1, tool: 'rod', injuryChance: 0.01 },
            loader: { name: 'Грузчик', resource: 'gold', price: 6, xp: 2, tool: null, levelReq: 3, injuryChance: 0.01, requiresAlex: true },
            field: { name: 'Поле', resource: 'wheat', price: 15, xp: 3, tool: 'sickle', levelReq: 5, injuryChance: 0.01 },
            mine: { name: 'Рудник', resource: 'ore', price: 40, xp: 8, tool: 'pickaxe', levelReq: 15, injuryChance: 0.03 }
        };
        
        const RESOURCE_NAMES = {
            fish: { name: 'Рыба', icon: 'fa-fish' },
            meat: { name: 'Мясо', icon: 'fa-drumstick-bite' },
            mushrooms: { name: 'Грибы', icon: 'icon-mushroom', isSvg: true },
            bread: { name: 'Хлеб', icon: 'fa-bread-slice' },
            eggs: { name: 'Яйца', icon: 'fa-egg' },
            milk: { name: 'Молоко', icon: 'fa-mug-hot' },

            ore: { name: 'Руда', icon: 'fa-cube' },
            bronze: { name: 'Бронза', icon: 'fa-coins' },
            silver: { name: 'Серебро', icon: 'fa-ring' },

            wheat: { name: 'Пшеница', icon: 'fa-wheat-awn' },
            wood: { name: 'Палка', icon: 'fa-tree' },
            stone: { name: 'Камень', icon: 'fa-shapes' },
            herbs: { name: 'Травы', icon: 'fa-leaf' },
            leather: { name: 'Кожа', icon: 'icon-leather' },

            wool: { name: 'Шерсть', icon: 'fa-cloud' },
            rope: { name: 'Верёвка', icon: 'fa-link' },
            cloth: { name: 'Ткань', icon: 'icon-cloth' },

            feed: { name: 'Корм', icon: 'fa-carrot' }
        };

        const RESOURCE_WEIGHTS = {
            fish: 0.6,
            meat: 1.2,
            mushrooms: 0.2,
            bread: 0.5,
            eggs: 0.2,
            milk: 1.0,

            ore: 3.0,
            bronze: 2.5,
            silver: 2.0,

            wheat: 0.1,
            wood: 1.0,
            stone: 1.5,
            herbs: 0.3,
            leather: 1.1,

            wool: 0.5,
            rope: 0.7,
            cloth: 0.6,

            feed: 0.7
        };

        const TOOL_WEIGHTS = {
            rod: 1.0,
            sickle: 1.2,
            pickaxe: 3.5,
            crossbow: 2.8,
            sword: 3.0
        };
        
        const TOOL_BASE_PRICES = {
            rod: 50,
            sickle: 500,
            pickaxe: 2000,
            crossbow: 5000,
            sword: 1000
        };

        const SHOES_WEIGHTS = {
            peasant: 1.0,
            quality: 1.2,
            elite: 1.4
        };

        // --- GAME STATE ---
        const gameState = {
            gold: 0,
            emeralds: 0,
            xp: 0,
            level: 1,
            hp: 100,
            maxHp: 100,
            hunger: 100,
            maxHunger: 100,
            actionCount: 0,
            skillPoints: 0,
            luck: 0,
            agility: 0,
            reputation: 0,
            craftingLevel: 0,
            clothes: {},
            xpToNextLevel: 100,
            
            // Resources
            fish: 0,
            meat: 0,
            mushrooms: 0,
            bread: 0,
            eggs: 0,
            milk: 0,
            ore: 0,
            bronze: 0,
            silver: 0,
            wheat: 0,
            wood: 0,
            stone: 0,
            herbs: 0,
            leather: 0,
            wool: 0,
            rope: 0,
            cloth: 0,
            feed: 0,
            
            inventory: [],
            ownedSwords: [],
            ownedArmor: [],
            equippedSword: null,
            equippedArmor: null,
            bagLevel: 0,
            // Tools State: owns boolean, current level
            tools: {
                rod: { owned: false, level: 0 },
                sickle: { owned: false, level: 0 },
                pickaxe: { owned: false, level: 0 },
                crossbow: { owned: false, level: 0 },
                sword: { owned: false, level: 0 }
            },
            livestock: {
                rabbit: false,
                chicken: false,
                pig: false,
                cow: false
            },
            
            // Quests
            activeQuests: [], 
            lastQuestGenTime: 0,
            storyQuests: [], // [{ id, title, desc, goals: {type, target, count}, reward: {gold, xp}, state: 'active'|'claimed' }]
            
            // NPC Memory
            npcStates: {}, // { npcId: { met: bool, stage: int } }
            
            // Port Event Tracking
            portWorkCount: 0,
            oldManEventTriggered: false,
            oldManEventThreshold: 0, // Set randomly 50-100 on first load

            // Village & House
            hasHouse: false,
            pigPenLevel: 0,
            meat: 0,
            lastMeatCollect: 0,
            hasHorse: false,
            livestock: {
                rabbit: false,
                chicken: false,
                pig: false,
                cow: false
            },

            // Shoes
            shoes: {
                peasant: false,
                quality: false,
                elite: false
            },
            
            // Disease
            hasMeasles: false,
            lastMeaslesTick: 0,

            // Unconscious
            unconsciousUntil: 0,
            lowHpWarnedAt: 0,

            // Random Events
            treasuryPouchResolved: false,
            bookhousePouchResolved: false,

            // Tavern Brawl
            lastBrawlTime: 0,

            // Arthur's Shop & Effects
            activeEffects: {}, // { xpBoost: timestamp, strengthBoost: timestamp }
            permanentStats: {}, // { bonusDamage: number }

            // Features
            bankedGold: 0,
            lastLoginDate: null,
            installDate: null, // Track when user first played
            dailyStreak: 0,
            rentExpiry: 0,
            introShown: false,
            playerId: null,
            playerName: "Странник",
            lastUpdate: null,
            lastSeen: null,
            
            // Channel Subscription Task
            channelSubscribed: false,
            channelTaskCompleted: false
        };

        // --- NPC DATABASE ---
        const NPC_DB = {
            arthur: {
                name: "Артур",
                role: "Алхимик",
                icon: "fa-user-tie",
                dialogue: {
                    root: function() {
                        // Check if player has completed herb quest
                        if (gameState.npcStates && gameState.npcStates.arthurHerbsComplete) {
                            return "after_quest";
                        }
                        // First time or regular visit
                        if (!gameState.npcStates || !gameState.npcStates.arthurMet) {
                            if (!gameState.npcStates) gameState.npcStates = {};
                            gameState.npcStates.arthurMet = true;
                            game.save();
                            return "first_meet";
                        }
                        return "regular";
                    },
                    first_meet: {
                        text: "О, смотри-ка! Ты выглядишь уже намного лучше, чем когда я встретил тебя на площади. Рад, что ты на ногах и не сдался. Меня зовут Артур, я занимаюсь алхимией и травами.",
                        options: [
                            { text: "Спасибо. Что ты делаешь здесь?", next: "about" },
                            { text: "У тебя есть зелья?", next: "potions" },
                            { text: "Пока", next: "exit" }
                        ]
                    },
                    regular: {
                        text: "Снова здесь? Всегда рад помочь. Чем могу быть полезен?",
                        options: [
                            { text: "Расскажи о своих зельях", next: "potions" },
                            { text: "Есть ли у тебя работа?", next: "herb_quest" },
                            { text: "До встречи", next: "exit" }
                        ]
                    },
                    about: {
                        text: "Я изучаю свойства трав и создаю зелья. Город полон опасностей, а мои эликсиры помогают выжить и стать сильнее. Если нужно — могу приготовить что-нибудь особенное.",
                        options: [
                            { text: "Что ты можешь предложить?", next: "potions" },
                            { text: "Вернусь позже", next: "exit" }
                        ]
                    },
                    potions: {
                        text: "У меня есть зелье опыта — удваивает твой опыт на 5 минут. И зелье силы — удваивает урон. Оба стоят по 100 изумрудов. Но есть и кое-что особенное...",
                        options: [
                            { text: "Что особенного?", next: "herb_quest" },
                            { text: "Куплю позже", next: "exit" }
                        ]
                    },
                    herb_quest: {
                        text: "Если принесёшь мне 100 трав, я сделаю тебе зелье силы особого рецепта. Оно навсегда увеличит твой урон на 5 единиц. Но мне нужно именно 100 трав — не меньше.",
                        options: [
                            { text: "Я постараюсь найти их", next: "quest_accepted" },
                            { text: "Может позже", next: "exit" }
                        ]
                    },
                    quest_accepted: {
                        text: "Отлично! Травы можно собирать в тёмном лесу. Будь осторожен там. Жду тебя с травами.",
                        options: [
                            { text: "Вернусь с травами", next: "exit" }
                        ]
                    },
                    after_quest: {
                        text: "Ты проделал отличную работу с теми травами. Зелье должно служить тебе верой и правдой. Если нужны обычные эликсиры — всегда к твоим услугам.",
                        options: [
                            { text: "Спасибо, Артур", next: "exit" }
                        ]
                    }
                }
            },
            lili: {
                name: "Лили",
                role: "Хозяйка Книжного Дома",
                icon: "fa-feather",
                dialogue: {
                    root: function() {
                        if (!gameState.npcStates) gameState.npcStates = {};
                        gameState.npcStates.lili_visitCount = (gameState.npcStates.lili_visitCount || 0) + 1;
                        if (!gameState.npcStates.lili_invited && gameState.npcStates.lili_visitCount >= 4) {
                            gameState.npcStates.lili_invited = true;
                            game.save();
                            return "invite";
                        }
                        if (gameState.npcStates.lili_gifted) {
                            return "later";
                        }
                        if (gameState.npcStates.lili_waiting) {
                            return "gift";
                        }
                        game.save();
                        return "intro";
                    },
                    intro: {
                        text: "О, привет! Ты явно не местный. Мне нравится твой взгляд — такой уверенный, но чуть потерянный. Я Лили. Этот Дом — моя маленькая крепость знаний. А ты кто?",
                        options: [
                            { text: "Я странник, ищу путь", next: "about_you" },
                            { text: "Просто хочу посмотреть рецепты", next: "recipes" }
                        ]
                    },
                    about_you: {
                        text: "Странник? Звучит романтично. Я люблю истории о таких, как ты. Здесь, в городе, всё крутится вокруг ремесла и торговли. Кто хочет выжить — учится. Кто хочет процветать — учится у меня.",
                        options: [
                            { text: "Расскажи о городе", next: "city" },
                            { text: "А ты сама?", next: "about_me" }
                        ]
                    },
                    city: {
                        text: "Город живёт деньгами и слухами. Порт кормит бедняков, казна хранит золото, таверна — тайны. А я... я даю тем, кто достоин, знание. И иногда — чуточку внимания.",
                        options: [
                            { text: "Мне нужны рецепты", next: "recipes" },
                            { text: "Ты заигрываешь?", next: "flirt" }
                        ]
                    },
                    flirt: {
                        text: "Может быть. Разве это плохо? Город здесь серый, а с тобой немного ярче. Но не обольщайся — знания дороже поцелуев.",
                        options: [
                            { text: "Где твои рецепты?", next: "recipes" },
                            { text: "Вернусь позже", next: "wait" }
                        ]
                    },
                    about_me: {
                        text: "Я родилась здесь и всегда мечтала о большом мире. Но осталась, чтобы хранить книги. Скучно, если честно... Поэтому мне нравится разговаривать с путниками. Вроде тебя.",
                        options: [
                            { text: "Я зайду позже", next: "wait" },
                            { text: "Покажи, что продаешь", next: "recipes" }
                        ]
                    },
                    recipes: {
                        text: "У меня есть рецепты, которые могут сделать тебя сильнее или богаче. Еда, оружие, броня, даже сумка побольше. Все за изумруды — знания бесценны.",
                        options: [
                            { text: "Спасибо, Лили", next: "wait" },
                            { text: "Вернусь позже", next: "wait" }
                        ]
                    },
                    wait: {
                        text: "Загляни чуть позже, хорошо? Мне приятно, когда ты рядом. И, может, у меня появится кое-что интересное для тебя.",
                        options: [
                            { text: "Договорились", action: "lili_wait", next: "exit" }
                        ]
                    },
                    gift: {
                        text: "Ты пришёл! Я скучала... Вот, держи. Это редкий рецепт — кожаное седло для лошади. Если соберёшь коня, пригодится. А теперь... не исчезай снова.",
                        options: [
                            { text: "Спасибо, Лили", action: "lili_gift", next: "exit" },
                            { text: "Я зайду позже", action: "lili_gift", next: "exit" }
                        ]
                    },
                    invite: {
                        text: "Ты часто заходишь, и мне это приятно. Знаешь... я живу в дворянском квартале. Если будешь свободен — загляни ко мне. Отец из высшей знати, но я люблю простые беседы больше приемов.",
                        options: [
                            { text: "Я обязательно приду", action: "start_q_lili_visit", next: "later" },
                            { text: "Спасибо за приглашение", action: "start_q_lili_visit", next: "later" }
                        ]
                    },
                    later: {
                        text: "Ты снова здесь. Я рада. Поболтай со мной ещё, когда устанешь от приключений... Этот дом становится слишком тихим без тебя.",
                        options: [
                            { text: "Я зайду позже", next: "exit" },
                            { text: "До встречи", next: "exit" }
                        ]
                    }
                }
            },
            sarah: {
                name: "Сара",
                role: "Дочь владельца",
                icon: "fa-wine-glass-alt",
                dialogue: {
                    root: {
                        text: "Добро пожаловать в Гостевой Дом. Здесь отдыхают лучшие люди города. Чего ты хочешь?",
                        options: [
                            { text: "Расскажи об этом месте", next: "about" },
                            { text: "Ты здесь работаешь?", next: "flirt_start" },
                            { text: "Я просто смотрю", next: "exit" }
                        ]
                    },
                    about: {
                        text: "Отец создал это место для элиты. Вино из лучших погребов, еда, достойная королей. И, конечно, карты. Если у тебя есть золото — тебе здесь рады.",
                        options: [
                            { text: "Звучит дорого", next: "root" }
                        ]
                    },
                    flirt_start: {
                        text: "Я помогаю отцу. И присматриваю за гостями. Некоторые... требуют особого внимания.",
                        options: [
                            { text: "Я требую внимания?", next: "flirt_1" },
                            { text: "Понятно", next: "root" }
                        ]
                    },
                    flirt_1: {
                        text: "Может быть. Ты выглядишь интереснее, чем наши обычные напыщенные лорды. Но не думай, что я так проста.",
                        options: [
                            { text: "Я люблю сложные задачи", next: "flirt_2" },
                            { text: "Не буду мешать", next: "exit" }
                        ]
                    },
                    flirt_2: {
                        text: "Хм. Дерзкий. Мне это нравится. Заходи чаще, может быть, я угощу тебя вином за счет заведения. Когда-нибудь.",
                        options: [
                            { text: "Ловлю на слове", next: "exit" }
                        ]
                    }
                }
            },
            gorn: {
                name: "Горн",
                role: "Кузнец",
                icon: "fa-hammer",
                dialogue: {
                    root: {
                        text: "Нужна крепкая сталь? Или ищешь работу?",
                        options: [
                            { text: "Хочу купить оружие", next: "shop_hint" },
                            { text: "Есть дело?", next: "quest_check" },
                            { text: "Бывай", next: "exit" }
                        ]
                    },
                    shop_hint: {
                        text: "Смотри вкладку 'Мечник' или 'Бронник' в торговых рядах. Там всё мое добро.",
                        options: [{ text: "Ага", next: "root" }]
                    },
                    quest_check: function() {
                         if (!hasStoryQuest('q_gorn_1') && !isQuestCompleted('q_gorn_1') && gameState.level >= 3) {
                            return "quest_offer";
                        }
                        return "no_quest";
                    },
                    quest_offer: {
                        text: "Мне не хватает руды для заказа. Принеси 5 кусков руды из шахты.",
                        options: [
                            { text: "Сделаю", action: "start_q_gorn_1", next: "quest_accepted" },
                            { text: "Нет кирки", next: "root" }
                        ]
                    },
                    quest_accepted: {
                        text: "Не подведи. Руда нужна чистая.",
                        options: [{ text: "Понял", next: "exit" }]
                    },
                    no_quest: {
                        text: "Работы нет. Приходи, когда станешь опытнее (Ур 3+).",
                        options: [{ text: "Ясно", next: "root" }]
                    }
                }
            },
            ben: {
                name: "Старый Бен",
                role: "Трактирщик",
                icon: "fa-wine-glass",
                dialogue: {
                    root: {
                        text: "Чего желаешь? Эля или комнату?",
                        options: [
                            { text: "Какие слухи?", next: "rumors" },
                            { text: "Комната свободна?", next: "room_hint" },
                            { text: "Ухожу", next: "exit" }
                        ]
                    },
                    rumors: {
                        text: "Говорят, в Темном Лесу видели странные тени. И еще... кто-то разбогател на Колесе Удачи. Но чаще там проигрывают штаны, хе-хе.",
                        options: [{ text: "Интересно", next: "root" }]
                    },
                    room_hint: {
                        text: "Всегда найдется койка за 20 изумрудов. Лечит любые раны.",
                        options: [{ text: "Понял", next: "root" }]
                    }
                }
            },
            elara: {
                name: "Элара",
                role: "Следопыт",
                icon: "fa-hood-cloak",
                dialogue: {
                    root: {
                        text: "Тише. Лес не любит шумных гостей.",
                        options: [
                            { text: "Что ты тут делаешь?", next: "about" },
                            { text: "Нужна помощь?", next: "quest_check" },
                            { text: "Ухожу", next: "exit" }
                        ]
                    },
                    about: {
                        text: "Слежу за балансом. Если убивать слишком много волков, придут чудовища похуже.",
                        options: [{ text: "...", next: "root" }]
                    },
                    quest_check: function() {
                        if (!hasStoryQuest('q_elara_1') && !isQuestCompleted('q_elara_1')) {
                            return "quest_offer";
                        }
                        return "no_quest";
                    },
                    quest_offer: {
                        text: "Мне нужны целебные травы. Собери 5 трав в лесу.",
                        options: [
                            { text: "Поищу", action: "start_q_elara_1", next: "quest_accepted" },
                            { text: "Слишком опасно", next: "root" }
                        ]
                    },
                    quest_accepted: {
                        text: "Будь осторожен. Смотри под ноги.",
                        options: [{ text: "Ладно", next: "exit" }]
                    },
                    no_quest: {
                        text: "Лес спокоен. Пока что.",
                        options: [{ text: "Хорошо", next: "root" }]
                    }
                }
            },
            marius: {
                name: "Мариус",
                role: "Алхимик",
                icon: "fa-user-md",
                dialogue: {
                    root: {
                        text: "Хвори и раны - моя забота. Или ты ищешь знания?",
                        options: [
                            { text: "Мне нужно лечение", next: "heal_hint" },
                            { text: "Что за знания?", next: "recipes_hint" },
                            { text: "Есть поручения?", next: "quest_check" },
                            { text: "Прощай", next: "exit" }
                        ]
                    },
                    heal_hint: {
                        text: "Я могу затянуть твои раны за скромную плату. Кнопка в меню хижины.",
                        options: [{ text: "Понял", next: "root" }]
                    },
                    recipes_hint: {
                        text: "Я продаю древние рецепты зелий. Они даруют силу, недоступную смертным. Если у тебя есть изумруды, конечно.",
                        options: [{ text: "Посмотрю", next: "root" }]
                    },
                    quest_check: function() {
                         if (!hasStoryQuest('q_marius_1') && !isQuestCompleted('q_marius_1')) {
                            return "quest_offer";
                        }
                        return "no_quest";
                    },
                    quest_offer: {
                        text: "Мои запасы трав истощились. Принеси мне 5 пучков редких трав из леса, и я дам тебе скидку... может быть.",
                        options: [
                            { text: "Соберу", action: "start_q_marius_1", next: "quest_accepted" },
                            { text: "Нет времени", next: "root" }
                        ]
                    },
                    quest_accepted: {
                        text: "Травы должны быть свежими. Поторопись.",
                        options: [{ text: "Иду", next: "exit" }]
                    },
                    no_quest: {
                        text: "Пока мне ничего не нужно. Изучай рецепты.",
                        options: [{ text: "Ладно", next: "root" }]
                    }
                }
            },
            john_intro: {
                name: "Рыцарь Джон",
                role: "Воин",
                icon: "fa-user-shield",
                dialogue: {
                    root: {
                        text: "Держи монету, парень. Хм... А в тебе что-то есть. Крепкие руки, ясный взгляд.",
                        options: [
                            { text: "Спасибо, милорд", next: "offer" },
                            { text: "Кто вы?", next: "identity" }
                        ]
                    },
                    identity: {
                        text: "Я Джон, инструктор королевской гвардии. Я ищу таланты даже в сточных канавах.",
                        options: [{ text: "Я не из канавы!", next: "offer" }]
                    },
                    offer: {
                        text: "Слушай. Если хочешь стать настоящим воином, а не побираться тут — приходи в Учебный лагерь. Но сперва окрепни. Получи 15 уровень, и я жду тебя.",
                        options: [
                            { text: "Я приду!", action: "start_q_john_1", next: "accepted" },
                            { text: "Мне и тут неплохо", next: "exit" }
                        ]
                    },
                    accepted: {
                        text: "Слово мужчины. До встречи.",
                        options: [{ text: "До встречи", next: "exit" }]
                    }
                }
            },
            john: {
                name: "Рыцарь Джон",
                role: "Наставник",
                icon: "fa-user-shield",
                dialogue: {
                    root: {
                        text: "Добро пожаловать в лагерь. Готов к тренировкам?",
                        options: [
                            { text: "Я пришел по твоему вызову", next: "check_quest" },
                            { text: "Просто смотрю", next: "exit" }
                        ]
                    },
                    check_quest: function() {
                        if (hasStoryQuest('q_john_1') && !isQuestCompleted('q_john_1')) {
                            // Completing the quest
                            game.completeQuest('q_john_1');
                            return "welcome";
                        }
                        return "training";
                    },
                    welcome: {
                        text: "Молодец. Ты сдержал слово. Вот тебе награда на первое снаряжение. Скоро начнем муштру.",
                        options: [{ text: "Спасибо", next: "exit" }]
                    },
                    training: {
                        text: "Пока что отдыхай. Скоро прибудут новобранцы.",
                        options: [{ text: "Хорошо", next: "exit" }]
                    }
                }
            },
            thomas_intro: {
                name: "Томас",
                role: "Незнакомец",
                icon: "fa-user-secret",
                dialogue: {
                    root: {
                        text: "Приятного аппетита. Вижу, ты при деньгах, раз можешь позволить себе горячее. Не ищешь работу посерьезнее рыбалки?",
                        options: [
                            { text: "Смотря какую", next: "offer" },
                            { text: "Я не ищу проблем", next: "leave" }
                        ]
                    },
                    offer: {
                        text: "Я переправляю беженцев через границу. Дело рисковое, но платят щедро. Приходи в Лагерь беженцев, обсудим. Но запомни: без меча не приходи. В тех краях опасно.",
                        options: [
                            { text: "Я приду", action: "unlock_refugee", next: "exit" }
                        ]
                    },
                    leave: {
                        text: "Твое дело. Если передумаешь — я буду в лагере беженцев. Но нужен меч.",
                        options: [{ text: "Угу", action: "unlock_refugee", next: "exit" }]
                    }
                }
            },
            thomas: {
                name: "Томас",
                role: "Перевозчик",
                icon: "fa-user-secret",
                dialogue: {
                    root: {
                        text: "Ты пришел. Меч принес?",
                        options: [
                            { text: "Да, я готов", next: "check_sword" },
                            { text: "Нет пока", next: "no_sword" }
                        ]
                    },
                    check_sword: function() {
                        if (gameState.tools.sword && gameState.tools.sword.owned) {
                            return "job_start";
                        }
                        return "no_sword";
                    },
                    no_sword: {
                        text: "Я же сказал — без оружия не приходи. Купи на рынке или сделай сам. Возвращайся, когда будешь готов.",
                        options: [{ text: "Ладно", next: "exit" }]
                    },
                    job_start: {
                        text: "Отлично. Меч при тебе. Скоро выдвигаемся. (Продолжение следует...)",
                        options: [{ text: "Жду", next: "exit" }]
                    }
                }
            },
            oldman_port: {
                name: "Старик",
                role: "Бродяга",
                icon: "fa-person-cane",
                dialogue: {
                    root: {
                        text: "Эй, парень... Вижу, ты тут целый день вкалываешь. Устал, небось? У меня есть местечко неподалёку — тихо, тепло. Можешь переночевать, набраться сил. Бесплатно, по доброте душевной.",
                        options: [
                            { text: "Спасибо, дедушка! Пойдём.", action: "accept_oldman", next: "robbery" },
                            { text: "Нет, спасибо. Я сам справлюсь.", next: "refuse" }
                        ]
                    },
                    robbery: {
                        text: "Хе-хе... Наивный дурачок.",
                        options: [{ text: "...", next: "exit" }]
                    },
                    refuse: {
                        text: "Ну, как знаешь... Береги себя, парень.",
                        options: [{ text: "Прощай", next: "exit" }]
                    }
                }
            },
            alex: {
                name: "Алекс",
                role: "Помощник капитана",
                icon: "fa-anchor",
                dialogue: {
                    root: {
                        text: "Эй, ты! Да, ты, рыбак. Вижу, как ты тут каждый день горбатишься. Неплохо справляешься.",
                        options: [
                            { text: "Спасибо. А ты кто?", next: "intro" },
                            { text: "Чего надо?", next: "intro" }
                        ]
                    },
                    intro: {
                        text: "Меня зовут Алекс. Я помощник капитана на торговом судне. Нам нужны крепкие руки — разгружать мешки с зерном. Платим 6 золотых за подход, работа почти безопасная.",
                        options: [
                            { text: "Звучит неплохо! Я в деле.", action: "accept_alex_job", next: "accepted" },
                            { text: "Нет, я лучше рыбачить буду.", next: "refuse" }
                        ]
                    },
                    accepted: {
                        text: "Отлично! Теперь ты можешь работать грузчиком в порту. Найдёшь эту работу в списке. Удачи, парень!",
                        options: [{ text: "Спасибо!", next: "exit" }]
                    },
                    refuse: {
                        text: "Как знаешь. Если передумаешь — я буду здесь.",
                        options: [{ text: "Ладно", next: "exit" }]
                    }
                }
            },
            peter: {
                name: "Питер",
                role: "Портной",
                icon: "fa-scissors",
                dialogue: {
                    root: {
                        text: "Ох, дружище, ты выглядишь как помятый мешок. В этом городе, чтобы тебя уважали, нужно выглядеть опрятно.",
                        options: [
                            { text: "Что ты предлагаешь?", next: "offer" },
                            { text: "Почему это так важно?", next: "why" },
                            { text: "Ладно, ухожу", next: "exit" }
                        ]
                    },
                    why: {
                        text: "Здесь все смотрят на внешний вид. Чистая одежда — первое, что отличает путника от нищего. И новые заказчики любят порядок.",
                        options: [ { text: "Покажи варианты", next: "offer" } ]
                    },
                    offer: {
                        text: "Я могу сшить три комплекта: крестьянин за 5000 золотых, состоятельный за 50000, и одежда знати за 500 изумрудов. Что выберешь?",
                        options: [
                            { text: "Крестьянин (5000 золота)", action: "buy_peasant", next: "root" },
                            { text: "Состоятельный (50000 золота)", action: "buy_rich", next: "root" },
                            { text: "Знать (500 изумрудов)", action: "buy_noble", next: "root" },
                            { text: "Подумаю", next: "exit" }
                        ]
                    }
                }
            },
            librarian: {
                name: "Библиотекарь Генрих",
                role: "Хранитель рецептов",
                icon: "fa-glasses",
                dialogue: {
                    root: {
                        text: "Добро пожаловать в Книжный Дом. Здесь собраны знания со всего королевства.",
                        options: [
                            { text: "Что ты продаёшь?", next: "about_recipes" },
                            { text: "Расскажи о себе", next: "about_self" },
                            { text: "Прощай", next: "exit" }
                        ]
                    },
                    about_recipes: {
                        text: "Я продаю рецепты для крафта. Еда восстановит здоровье, оружие усилит удары, броня защитит, а улучшенная сумка даст больше места для вещей. Всё стоит изумрудов — редкие знания не бесплатны.",
                        options: [{ text: "Понятно", next: "root" }]
                    },
                    about_self: {
                        text: "Я посвятил жизнь сбору знаний. Путешествовал по землям, записывал секреты мастеров. Теперь делюсь ими... за небольшую плату.",
                        options: [{ text: "Интересно", next: "root" }]
                    }
                }
            },
            bandits_village: {
                name: "Бандиты",
                role: "Шайка у трактира",
                icon: "fa-mask",
                dialogue: {
                    root: {
                        text: "Стой, путник. Проход через нашу деревню стоит 200 золотых. Плати — и уйдешь целым.",
                        options: [
                            { text: "Ладно, держите золото", action: "bandits_pay", next: "paid" },
                            { text: "Попытаюсь убежать", action: "bandits_run", next: "robbed" },
                            { text: "Я один из ваших. Золтан меня знает", action: "bandits_bluff", next: "bluff" }
                        ]
                    },
                    paid: {
                        text: "Умно. Проходи. И не возвращайся без пошлины.",
                        options: [{ text: "Ухожу", next: "exit" }]
                    },
                    robbed: {
                        text: "Ха! Бежать вздумал? Слабак.",
                        options: [{ text: "...", next: "exit" }]
                    },
                    bluff: {
                        text: "Золтан? Ах да… прости, брат. Проходи. И не держи зла.",
                        options: [{ text: "Ладно", next: "exit" }]
                    }
                }
            },
            sage: {
                name: "Мудрец Эльдар",
                role: "Хранитель знаний",
                icon: "fa-hat-wizard",
                dialogue: {
                    root: {
                        text: "Приветствую тебя, странник. Я Эльдар, хранитель древних знаний. Чем могу помочь?",
                        options: [
                            { text: "Расскажи о деревне", next: "about_village" },
                            { text: "У тебя есть рецепты?", next: "recipes" },
                            { text: "Мне нужна помощь с болезнью", next: "disease_check" },
                            { text: "Есть задание?", next: "quest_check" },
                            { text: "Прощай", next: "exit" }
                        ]
                    },
                    about_village: {
                        text: "Эта деревня — тихое место вдали от городской суеты. Здесь можно купить дом, завести хозяйство, выращивать свиней. Мясо и кожа — ценные ресурсы.",
                        options: [{ text: "Интересно", next: "root" }]
                    },
                    recipes: {
                        text: "Я продаю редкие рецепты зелий. Зелье Силы усилит твои удары, Зелье Скорости ускорит работу. Но они стоят изумрудов.",
                        options: [{ text: "Посмотрю", next: "root" }]
                    },
                    disease_check: function() {
                        if (gameState.hasMeasles) {
                            return "disease_cure";
                        }
                        return "no_disease";
                    },
                    disease_cure: {
                        text: "Вижу, ты заразился Корью в лесу. Опасная болезнь — она медленно убивает. Принеси мне 15 трав и 10 грибов, и я приготовлю лекарство.",
                        options: [
                            { text: "У меня есть ингредиенты", action: "try_cure", next: "root" },
                            { text: "Пойду соберу", next: "exit" }
                        ]
                    },
                    no_disease: {
                        text: "Ты здоров, странник. Но будь осторожен в Темном Лесу — там можно подхватить Корь.",
                        options: [{ text: "Буду осторожен", next: "root" }]
                    },
                    quest_check: function() {
                        if (!hasStoryQuest('q_sage_1') && !isQuestCompleted('q_sage_1')) {
                            return "quest_offer";
                        }
                        return "no_quest";
                    },
                    quest_offer: {
                        text: "Мне нужны редкие грибы из глубин леса. Принеси 20 грибов, и я щедро награжу тебя.",
                        options: [
                            { text: "Соберу!", action: "start_q_sage_1", next: "quest_accepted" },
                            { text: "Слишком много", next: "root" }
                        ]
                    },
                    quest_accepted: {
                        text: "Будь осторожен в лесу. Грибы растут в самых темных местах.",
                        options: [{ text: "Понял", next: "exit" }]
                    },
                    no_quest: {
                        text: "Пока мне ничего не нужно. Изучай мои рецепты.",
                        options: [{ text: "Хорошо", next: "root" }]
                    }
                }
            },
            castle_guard: {
                name: "Стражник",
                role: "Королевская стража",
                icon: "fa-shield",
                dialogue: {
                    root: {
                        text: "Эй, стой! Тебе здесь не место. Вход только для рыцарей и знати.",
                        options: [
                            { text: "Я просто посмотреть...", next: "dismiss" },
                            { text: "А если я рыцарь?", next: "deny" },
                            { text: "Ухожу", next: "exit" }
                        ]
                    },
                    dismiss: {
                        text: "Сказал же — проваливай. Ты не похож ни на одного из них.",
                        options: [{ text: "Ладно", next: "exit" }]
                    },
                    deny: {
                        text: "Рыцарь? Ха. Смотри в свои лохмотья. Тут таким не место.",
                        options: [{ text: "Понял", next: "exit" }]
                    }
                }
            },
            fortress_guard: {
                name: "Капрал",
                role: "Страж крепости",
                icon: "fa-shield-halved",
                dialogue: {
                    root: function() {
                        if (gameState.npcStates && gameState.npcStates.campTrained) return "allow";
                        return "deny";
                    },
                    deny: {
                        text: "Стой. В крепость пускают только тех, кто прошёл подготовку в Учебном лагере. Ты ещё не готов.",
                        options: [
                            { text: "Понял, вернусь позже", next: "exit" }
                        ]
                    },
                    allow: {
                        text: "Вижу печать наставника. Проходи. Здесь слабых не держат.",
                        options: [
                            { text: "Я готов", next: "exit" }
                        ]
                    }
                }
            },
            noble_guard: {
                name: "Стражник квартала",
                role: "Дворцовая охрана",
                icon: "fa-shield-halved",
                dialogue: {
                    root: {
                        text: "Стой. Дворянский квартал не для оборванцев. Переоденься хотя бы в приличную одежду.",
                        options: [
                            { text: "Где взять одежду?", next: "clothes" },
                            { text: "Я уйду", next: "exit" }
                        ]
                    },
                    clothes: {
                        text: "Купи одежду у портного на площади. Чистая рубаха — пропуск в этот район.",
                        options: [{ text: "Понял", next: "exit" }]
                    }
                }
            },
            shoemaker: {
                name: "Лорен",
                role: "Сапожник",
                icon: "fa-shoe-prints",
                dialogue: {
                    root: {
                        text: "Хорошая обувь спасёт от мозолей, дождя и простуды. Без неё ты долго не протянешь в дороге.",
                        options: [
                            { text: "Какая обувь лучше?", next: "advice" },
                            { text: "Я посмотрю товары", next: "exit" }
                        ]
                    },
                    advice: {
                        text: "Чем качественнее обувь, тем больше уважения от горожан. А грязные сапоги — путь к насмешкам.",
                        options: [{ text: "Понял", next: "exit" }]
                    }
                }
            },
            old_beggar: {
                name: "Старый нищий",
                role: "Нищий",
                icon: "fa-user-injured",
                dialogue: {
                    root: function() {
                        if (!gameState.npcStates) gameState.npcStates = {};
                        if (gameState.npcStates.old_beggar_helped) return "thanks";
                        if (gameState.npcStates.old_beggar_refused) return "silent";
                        return "root_default";
                    },
                    root_default: {
                        text: "Подайте монетку, добрый человек... Я уже три дня не ел... Старик совсем обессилел...",
                        options: [
                            { text: "Подать 10 золотых", next: "give_small" },
                            { text: "Подать 50 золотых", next: "give_medium" },
                            { text: "Подать 100 золотых", next: "give_large" },
                            { text: "Извини, ничего нет", next: "refuse" }
                        ]
                    },
                    give_small: {
                        text: "Благословит вас Господь! Хоть на хлеба хватит...",
                        options: [{ text: "Всего хорошего", action: "beggar_give_10", next: "exit" }]
                    },
                    give_medium: {
                        text: "О, такой щедрости я не видел уже много лет! Спасибо вам, добрый человек! Пусть удача сопутствует вам!",
                        options: [{ text: "Поправляйтесь", action: "beggar_give_50", next: "exit" }]
                    },
                    give_large: {
                        text: "Сто золотых?! Это... это целое состояние для меня! Благословение небес на вас! Вы спасли мою жизнь!",
                        options: [{ text: "Берегите себя", action: "beggar_give_100", next: "exit" }]
                    },
                    refuse: {
                        text: "*кивает с пониманием* Ничего страшного... Времена нынче тяжелые для всех...",
                        options: [{ text: "Прощайте", action: "beggar_refuse", next: "exit" }]
                    },
                    thanks: {
                        text: "Спасибо вам за помощь, добрый человек. Я не забуду вашей доброты.",
                        options: [{ text: "Пусть вам сопутствует удача", next: "exit" }]
                    },
                    silent: {
                        text: "...",
                        options: [{ text: "Уйти", next: "exit" }]
                    }
                }
            },
            eigan: {
                name: "Эйган",
                role: "Охотник",
                icon: "fa-bow-arrow",
                dialogue: {
                    root: function() {
                        if (gameState.npcStates && gameState.npcStates.eiganQuestComplete) {
                            return "after_quest";
                        }
                        if (gameState.npcStates && gameState.npcStates.eiganQuestActive) {
                            return "quest_active";
                        }
                        if (!gameState.npcStates || !gameState.npcStates.eiganMet) {
                            if (!gameState.npcStates) gameState.npcStates = {};
                            gameState.npcStates.eiganMet = true;
                            game.save();
                            return "first_meet";
                        }
                        return "regular";
                    },
                    first_meet: {
                        text: "Приветствую, путник. Я Эйган, охотник этих земель. Ты нашел мою хижину — значит, ты либо смелый, либо отчаянный. Надеюсь, первое.",
                        options: [
                            { text: "Расскажи мне о лесе", next: "about_forest" },
                            { text: "Что ты тут делаешь?", next: "about_hunter" },
                            { text: "Я просто осматриваюсь", next: "exit" }
                        ]
                    },
                    about_forest: {
                        text: "Тёмный лес — место опасное, но и богатое. Здесь можно найти редкие травы, грибы, ценную кожу зверей... Но будь осторожен. Лес таит в себе болезни. Корь — самая распространённая из них. Она медленно забирает жизненные силы. Без лечения долго не протянешь.",
                        options: [
                            { text: "Как защититься от кори?", next: "about_measles" },
                            { text: "Какие ещё опасности тут есть?", next: "about_dangers" },
                            { text: "Понятно, спасибо", next: "regular" }
                        ]
                    },
                    about_measles: {
                        text: "Корь распространяется через воздух в глубине леса. Шанс невелик, но он есть. Если заболеешь — найди Эльдара в Деревне. Только он умеет лечить эту хворь. А я тут продаю амулеты, которые помогут тебе в путешествиях.",
                        options: [
                            { text: "Расскажи про амулеты", next: "about_amulets" },
                            { text: "Хорошо знать", next: "regular" }
                        ]
                    },
                    about_dangers: {
                        text: "Помимо кори, в лесу водятся волки, медведи и кое-что похуже... Древние создания, о которых лучше не знать. Если у тебя нет арбалета, не углубляйся слишком далеко. И следи за здоровьем — раненый путник привлекает хищников.",
                        options: [
                            { text: "Я буду осторожен", next: "regular" },
                            { text: "Расскажи про амулеты", next: "about_amulets" }
                        ]
                    },
                    about_hunter: {
                        text: "Я охочусь здесь больше двадцати лет. Знаю каждую тропу, каждую нору. Лес даёт мне всё необходимое для жизни, а я помогаю путникам вроде тебя. За разумную плату, разумеется.",
                        options: [
                            { text: "Что ты можешь предложить?", next: "about_amulets" },
                            { text: "Есть ли у тебя работа?", next: "quest_offer" },
                            { text: "Понял", next: "regular" }
                        ]
                    },
                    about_amulets: {
                        text: "У меня есть два особых амулета. Амулет опыта — усиливает твоё обучение, даёт на 50% больше опыта. А Амулет добычи — помогает находить больше ресурсов при собирательстве. Оба стоят недёшево, но они того стоят.",
                        options: [
                            { text: "Я подумаю", next: "regular" },
                            { text: "У тебя есть задание?", next: "quest_offer" }
                        ]
                    },
                    regular: {
                        text: "Чем могу помочь, путник?",
                        options: [
                            { text: "Расскажи про лес", next: "about_forest" },
                            { text: "Есть работа?", next: "quest_offer" },
                            { text: "Я уйду", next: "exit" }
                        ]
                    },
                    quest_offer: {
                        text: "Есть одно дело. Недавно я видел в лесу старинный тотем — древний артефакт наших предков. Он находится где-то в глубине леса. Если найдёшь его и принесёшь мне, я щедро награжу тебя. Этот тотем имеет для меня особое значение.",
                        options: [
                            { text: "Где искать этот тотем?", next: "quest_hint" },
                            { text: "Я поищу его", action: "start_eigan_quest", next: "quest_accepted" },
                            { text: "Слишком опасно", next: "regular" }
                        ]
                    },
                    quest_hint: {
                        text: "Тотем спрятан в самой чаще. Тебе придётся много раз исследовать лес, собирая ресурсы. Рано или поздно наткнёшься на него. Помни — лес открывает свои секреты лишь терпеливым.",
                        options: [
                            { text: "Я найду его", action: "start_eigan_quest", next: "quest_accepted" },
                            { text: "Подумаю", next: "regular" }
                        ]
                    },
                    quest_accepted: {
                        text: "Отлично! Будь осторожен в лесу. Когда найдёшь тотем, возвращайся ко мне. Удачи, охотник.",
                        options: [{ text: "Вернусь с тотемом", next: "exit" }]
                    },
                    quest_active: {
                        text: "Нашёл древний тотем? Это старинный деревянный идол с резьбой.",
                        options: function() {
                            if (gameState.npcStates && gameState.npcStates.eiganTotemFound) {
                                return [
                                    { text: "Да! Вот он!", action: "return_totem", next: "totem_returned" }
                                ];
                            }
                            return [
                                { text: "Ещё ищу", next: "searching" },
                                { text: "Пока нет", next: "exit" }
                            ];
                        }
                    },
                    searching: {
                        text: "Продолжай искать. Тотем где-то в чаще леса. Собирай ресурсы, исследуй — и ты найдёшь его.",
                        options: [{ text: "Продолжу поиски", next: "exit" }]
                    },
                    totem_returned: {
                        text: "Это он! Древний тотем моих предков! Ты не представляешь, как много это значит для меня. Вот твоя награда — 15 изумрудов и мой личный амулет удачи. Носи его с гордостью, друг!",
                        options: [
                            { text: "Рад был помочь", next: "exit" }
                        ]
                    },
                    after_quest: {
                        text: "Спасибо тебе ещё раз за тотем. Если нужны амулеты — я всегда к твоим услугам.",
                        options: [
                            { text: "Расскажи про лес", next: "about_forest" },
                            { text: "До встречи", next: "exit" }
                        ]
                    }
                }
            },
            gambler: {
                name: "Азартный игрок",
                role: "Игрок в кости",
                icon: "fa-dice",
                dialogue: {
                    root: {
                        text: "Эй, приятель! Хочешь испытать удачу? Сыграем в кости на 500 золотых? Все честно — бросаем два кубика, у кого сумма больше, тот и выиграл!",
                        options: [
                            { text: "Давай сыграем! (500 золотых)", next: "check_gold" },
                            { text: "Как это работает?", next: "rules" },
                            { text: "Нет, спасибо", next: "refuse" }
                        ]
                    },
                    rules: {
                        text: "Все просто! Каждый бросает два кубика. У кого сумма выпавших чисел больше — тот забирает банк в 1000 золотых! Ничья — деньги возвращаются. Азарт, да?",
                        options: [
                            { text: "Ладно, сыграем! (500 золотых)", next: "check_gold" },
                            { text: "Не сегодня", next: "exit" }
                        ]
                    },
                    check_gold: function() {
                        if (gameState.gold >= 500) {
                            return "play";
                        }
                        return "no_gold";
                    },
                    no_gold: {
                        text: "Хм, приятель, похоже у тебя не хватает золота. Возвращайся, когда будет 500 золотых!",
                        options: [{ text: "Вернусь позже", next: "exit" }]
                    },
                    play: {
                        text: "Отлично! Делаем ставки... Бросаем кости!",
                        options: [{ text: "Бросить кости!", action: "play_dice", next: "exit" }]
                    },
                    refuse: {
                        text: "Как знаешь! Но помни — удача любит смелых! Заходи, если передумаешь!",
                        options: [{ text: "Может быть позже", next: "exit" }]
                    }
                }
            },
            hank: {
                name: "Хэнк",
                role: "Главный банкир",
                icon: "fa-user-tie",
                dialogue: {
                    root: function() {
                        if (gameState.npcStates && gameState.npcStates.hankAmuletComplete) {
                            return "after_quest";
                        }
                        if (gameState.npcStates && gameState.npcStates.hankAmuletActive) {
                            return "quest_active";
                        }
                        if (!gameState.npcStates || !gameState.npcStates.hankMet) {
                            if (!gameState.npcStates) gameState.npcStates = {};
                            gameState.npcStates.hankMet = true;
                            game.save();
                            return "first_meet";
                        }
                        return "regular";
                    },
                    first_meet: {
                        text: "Добро пожаловать в казну! Я Хэнк, главный банкир этого города. Позвольте объяснить, почему вам стоит хранить свои деньги здесь.",
                        options: [
                            { text: "Почему я должен хранить здесь золото?", next: "why_bank" },
                            { text: "Расскажи о городе", next: "about_city" },
                            { text: "До встречи", next: "exit" }
                        ]
                    },
                    why_bank: {
                        text: "В нашем городе полным-полно воров и обманщиков. Они только и ждут момента, чтобы обокрасть тебя до нитки! В казне твои деньги в безопасности, под надежной охраной.",
                        options: [
                            { text: "Понял. А чем ещё ты можешь помочь?", next: "regular" },
                            { text: "Спасибо за совет", next: "exit" }
                        ]
                    },
                    about_city: {
                        text: "Этот город — опасное место для беспечных. Карманники, мошенники, бандиты... Но если ты умён и осторожен, можешь разбогатеть здесь.",
                        options: [
                            { text: "Понятно", next: "regular" }
                        ]
                    },
                    regular: {
                        text: "Чем могу помочь? Нужно положить золото в сейф или обменять изумруды?",
                        options: [
                            { text: "У тебя есть какая-то работа?", next: "quest_offer" },
                            { text: "Просто зашёл поговорить", next: "exit" }
                        ]
                    },
                    quest_offer: {
                        text: "Знаешь... У меня есть одно личное дело. Мой брат потерял семейный амулет где-то в окрестностях города. Это очень важная реликвия для нашей семьи. Если найдёшь — щедро награжу.",
                        options: [
                            { text: "Где мне искать?", next: "quest_hint" },
                            { text: "Я попробую найти", action: "accept_hank_quest", next: "quest_accepted" },
                            { text: "Может позже", next: "exit" }
                        ]
                    },
                    quest_hint: {
                        text: "Точно не знаю... Он последний раз был в окрестностях города. Может, в лесу? Попробуй поискать в разных местах. Амулет небольшой, его легко не заметить.",
                        options: [
                            { text: "Я поищу его", action: "accept_hank_quest", next: "quest_accepted" },
                            { text: "Хорошо, подумаю", next: "exit" }
                        ]
                    },
                    quest_accepted: {
                        text: "Благодарю тебя! Это очень много значит для моей семьи. Удачи в поисках!",
                        options: [
                            { text: "Вернусь, когда найду", next: "exit" }
                        ]
                    },
                    quest_active: {
                        text: "Нашёл амулет моего брата? Это небольшой золотой медальон с гравировкой.",
                        options: function() {
                            if (gameState.npcStates && gameState.npcStates.hankAmuletFound) {
                                return [
                                    { text: "Да! Вот он!", action: "return_amulet", next: "amulet_returned" }
                                ];
                            }
                            return [
                                { text: "Ещё ищу", next: "exit" },
                                { text: "Пока нет", next: "exit" }
                            ];
                        }
                    },
                    amulet_returned: {
                        text: "Это он! О, я так рад! Спасибо тебе огромное! Вот твоя награда — 10 изумрудов. Моя семья навеки в долгу перед тобой!",
                        options: [
                            { text: "Рад помочь", next: "exit" }
                        ]
                    },
                    after_quest: {
                        text: "Спасибо тебе ещё раз за возврат амулета! Моя семья в долгу перед тобой.",
                        options: [
                            { text: "Всегда пожалуйста", next: "exit" }
                        ]
                    }
                }
            },
            anna: {
                name: "Анна",
                role: "Хозяйка скотного двора",
                icon: "fa-cow",
                dialogue: {
                    root: function() {
                        if (!gameState.npcStates || !gameState.npcStates.annaMet) {
                            if (!gameState.npcStates) gameState.npcStates = {};
                            gameState.npcStates.annaMet = true;
                            game.save();
                            return "first_meet";
                        }
                        return "regular";
                    },
                    first_meet: {
                        text: "Привет, путник! Я Анна, присматриваю за животными здесь. Если хочешь помочь мне ухаживать за ними — получишь награду и ценные материалы!",
                        options: [
                            { text: "Как это работает?", next: "how_it_works" },
                            { text: "Что за награды?", next: "rewards" },
                            { text: "Спасибо, зайду позже", next: "exit" }
                        ]
                    },
                    how_it_works: {
                        text: "Всё просто! Корми животных раз в 4 часа специальным кормом. За это я дам тебе немного золота, а животные — ценные материалы: яйца, молоко, мясо, кожу.",
                        options: [
                            { text: "Где взять корм?", next: "where_feed" },
                            { text: "Понятно", next: "regular" }
                        ]
                    },
                    where_feed: {
                        text: "Корм можно купить у продавца скота. Он продаёт качественный корм для всех видов животных.",
                        options: [
                            { text: "Спасибо за информацию", next: "exit" }
                        ]
                    },
                    rewards: {
                        text: "От кур получишь яйца и мясо, от коров — молоко и кожу, от свиней — мясо, от кроликов — мясо и кожу. Плюс я заплачу тебе золотом за работу!",
                        options: [
                            { text: "Звучит выгодно!", next: "exit" },
                            { text: "Как часто кормить?", next: "how_it_works" }
                        ]
                    },
                    regular: {
                        text: "Снова здесь? Животные всегда рады свежему корму!",
                        options: [
                            { text: "Расскажи ещё раз как это работает", next: "how_it_works" },
                            { text: "Пока", next: "exit" }
                        ]
                    }
                }
            },
            tournamentmaster: {
                name: "Мастер Турниров",
                role: "Организатор состязаний",
                icon: "fa-crown",
                dialogue: {
                    root: function() {
                        if (!gameState.npcStates) gameState.npcStates = {};
                        if (!gameState.npcStates.tournamentMasterMet) {
                            gameState.npcStates.tournamentMasterMet = true;
                            game.save();
                            return "first_meet";
                        }
                        return "regular";
                    },
                    first_meet: {
                        text: "Приветствую тебя, воин! Я — Мастер Турниров, организатор величайших состязаний в этом королевстве. Здесь собираются самые отважные бойцы, чтобы доказать свою доблесть на арене!",
                        options: [
                            { text: "Что это за турниры?", next: "about_tournaments" },
                            { text: "Как мне принять участие?", next: "how_to_join" },
                            { text: "Прощай", next: "exit" }
                        ]
                    },
                    regular: {
                        text: "О, снова ты! Готов испытать свою удачу на арене? Или пришёл просто посмотреть, как сражаются настоящие воины?",
                        options: [
                            { text: "Расскажи о турнирах", next: "about_tournaments" },
                            { text: "Какие награды?", next: "rewards" },
                            { text: "Есть ли правила?", next: "rules" },
                            { text: "До встречи", next: "exit" }
                        ]
                    },
                    about_tournaments: {
                        text: "Наши турниры — это не просто бои. Это испытание силы, ловкости и духа! Мы проводим состязания для воинов разных уровней. Новички могут начать с простых поединков, а опытные бойцы сражаются за королевские награды!",
                        options: [
                            { text: "Звучит заманчиво! Что нужно для участия?", next: "how_to_join" },
                            { text: "А какие награды?", next: "rewards" },
                            { text: "Интересно, вернусь позже", next: "exit" }
                        ]
                    },
                    how_to_join: {
                        text: "Чтобы участвовать, тебе нужно соответствовать требованиям турнира: определённый уровень и экипировка. Новичкам достаточно 5-го уровня, а для турнира воинов нужен 10-й уровень и хорошее оружие!",
                        options: [
                            { text: "Понятно. А как проходят бои?", next: "rules" },
                            { text: "Какие награды ждут победителей?", next: "rewards" },
                            { text: "Спасибо за информацию", next: "exit" }
                        ]
                    },
                    rewards: {
                        text: "Ха! Награды — вот что привлекает всех! Победители получают золото, редкое оружие, доспехи и, конечно же, славу! Чем выше турнир, тем ценнее награды. Некоторые чемпионы получают даже королевские благословения!",
                        options: [
                            { text: "Впечатляет! Расскажи о правилах", next: "rules" },
                            { text: "Как мне начать?", next: "how_to_join" },
                            { text: "Я обязательно вернусь", next: "exit" }
                        ]
                    },
                    rules: {
                        text: "Правила просты: честный бой, никакого колдовства и отравленных клинков. Зрители любят зрелище, но безопасность бойцов — превыше всего. Смертельные исходы редки, но случаются. Ты должен быть готов ко всему!",
                        options: [
                            { text: "Я готов сражаться!", next: "ready" },
                            { text: "Мне нужно ещё подготовиться", next: "not_ready" },
                            { text: "Спасибо за объяснение", next: "exit" }
                        ]
                    },
                    ready: {
                        text: "Вот это дух! Но турниры сейчас в разработке. Скоро арена откроется, и ты сможешь доказать свою доблесть! Готовься, воин — великие сражения ждут тебя!",
                        options: [
                            { text: "Буду ждать!", next: "exit" }
                        ]
                    },
                    not_ready: {
                        text: "Мудрое решение. Тренируйся, собирай снаряжение, повышай уровень. Арена не прощает слабых. Когда будешь готов — возвращайся!",
                        options: [
                            { text: "Я вернусь сильнее", next: "exit" }
                        ]
                    }
                }
            },
            hugh: {
                name: "Хью",
                role: "Торговец скотом",
                icon: "fa-hat-cowboy",
                dialogue: {
                    root: function() {
                        if (!gameState.npcStates) gameState.npcStates = {};
                        if (!gameState.npcStates.hugh_met) {
                            gameState.npcStates.hugh_met = true;
                            game.save();
                            return "first_meet";
                        }
                        if (gameState.horse) return "has_horse";
                        return "regular";
                    },
                    first_meet: {
                        text: "*Широкоплечий мужчина в потёртой шляпе оборачивается от загона и вытирает руки на грубую ткань штанов* — О! Новое лицо. *Он широко улыбается и протягивает загрубевшую руку* — Хью меня зовут. Я тут всем заведую — от кролика до боевого коня. Если тебе нужна скотина или конь — ты пришёл куда нужно.",
                        options: [
                            { text: "Какие животные у тебя есть?", next: "about_animals" },
                            { text: "Расскажи про лошадей.", next: "about_horses" },
                            { text: "Чем питаются твои животные?", next: "about_feed" }
                        ]
                    },
                    about_animals: {
                        text: "*Хью развёртывается и указывает на загоны рукой* — Вот смотри. Кролики — самые простые, быстро размножаются. Куры несут яйца каждый день, если кормить. Свиньи — настоящая гирька, когда вырастет — мяса будет на зиму. А коровы... *Он поцокает языком* — Коровы дают молоко. Ценная штука, скажу тебе.",
                        options: [
                            { text: "А как их купить?", next: "how_buy" },
                            { text: "Расскажи про лошадей.", next: "about_horses" },
                            { text: "Понял, спасибо.", next: "exit" }
                        ]
                    },
                    about_horses: {
                        text: "*Хью гордно стукает ладонью по деревянному столбу загона* — О, лошади — это отдельный разговор! У меня есть Пони — самая дешёвая, для начала пойдёт. Тяжеловоз — для грузов, крепкий как камень. Мустанг — дикая душа, но характер ещё тот. *Его глаза загораются* — А есть Арабский скакун и Чистокровная — настоящие красавицы. И Боевой конь — для настоящих воин.",
                        options: [
                            { text: "Какую лучше купить первой?", next: "horse_advice" },
                            { text: "А как купить лошадь?", next: "how_buy" },
                            { text: "Понял, спасибо.", next: "exit" }
                        ]
                    },
                    horse_advice: {
                        text: "*Хью почесывает подбородок и щурится* — Смотри на кошелёк и на то, что тебе нужно. Если только начинаешь — бери Пони. Тридцать тысяч, и уже ты верхом. Тяжеловоз неплох для грузов — сто кило на спине несёт. *Он понижает голос* — А если хочешь душе — Арабский скакун. Когда сядешь на него — поймёшь, о чём я.",
                        options: [
                            { text: "Спасибо за совет!", next: "exit" },
                            { text: "А как купить?", next: "how_buy" }
                        ]
                    },
                    how_buy: {
                        text: "*Хью поднимает палец* — Есть одна загвоздка. Чтобы купить животное или коня — тебе нужен дом с загоном. Без загона куда их деть? *Он пожимает плечами* — Купи себе домик сначала, а потом заходи. Я тут каждый день. Никуда не денусь.",
                        options: [
                            { text: "Понял. Куплю дом.", next: "exit" },
                            { text: "У меня уже есть дом.", next: "exit" }
                        ]
                    },
                    about_feed: {
                        text: "*Хью берёт горсть зерна из мешка и показывает ладонь* — Корм — это основа всего. Без кормления животное болеет и не даёт продукции. Корм стоит двадцать монет за порцию. *Он серьёзно смотрит* — Забудешь кормить — животные начнут болеть. Куры перестанут нести яйца. Коровы — давать молоко. Понимаешь?",
                        options: [
                            { text: "Понял, буду кормить.", next: "exit" },
                            { text: "Что ещё нужно знать?", next: "care_tips" }
                        ]
                    },
                    care_tips: {
                        text: "*Хью загибает пальцы* — Раз — кормить. Каждый день. Два — не забивай загон, иначе будут драться. Три — куры несут яйца только если накормлены. *Задумывается и чуть улыбается* — Ну а ещё... уважай животных. Они чувствуют, когда тебе на них плевать. Поверь мне — за годы работы навидался всего.",
                        options: [
                            { text: "Спасибо, Хью.", next: "exit" }
                        ]
                    },
                    has_horse: function() {
                        if (!gameState.npcStates.hugh_saw_horse) {
                            gameState.npcStates.hugh_saw_horse = true;
                            game.save();
                            return "saw_horse";
                        }
                        return "regular_with_horse";
                    },
                    saw_horse: {
                        text: "*Хью бросает взгляд за твою спину и его лицо светлеет* — О-о! Ты уже разбогател! Смотри-ка какой конь! *Он цокает языком с уважением* — Молодец. Теперь у тебя есть скорость. И седло, надеюсь, купил? Без седла на коне — одно мучение для обоих.",
                        options: [
                            { text: "Конь мне очень нравится!", next: "exit" },
                            { text: "А что ещё можно купить?", next: "about_animals" }
                        ]
                    },
                    regular_with_horse: {
                        text: "*Хью кивает тебе с привычной улыбкой* — О, снова ты. Как твой конь? Ничего не болеет? *Оглядывает загоны* — Если нужно что-то — я тут.",
                        options: [
                            { text: "Расскажи ещё про животных.", next: "about_animals" },
                            { text: "Нет, всё хорошо.", next: "exit" }
                        ]
                    },
                    regular: {
                        text: "*Хью стоит у загона и поправляет шляпу* — О, ты! Снова заходишь. *Широко улыбается* — Чем могу помочь? Скотина, лошади, корм — всё тут.",
                        options: [
                            { text: "Расскажи про животных.", next: "about_animals" },
                            { text: "Расскажи про лошадей.", next: "about_horses" },
                            { text: "Просто смотрю.", next: "exit" }
                        ]
                    }
                }
            },
            leonard: {
                name: "Леонард",
                icon: "fa-user-tie",
                dialogue: {
                    root: function() {
                        if (!gameState.npcStates) gameState.npcStates = {};
                        if (gameState.npcStates.leonard_quest_done) return "after_quest";
                        if (gameState.npcStates.leonard_quest_active) return "quest_active";
                        if (!gameState.npcStates.leonard_met) {
                            gameState.npcStates.leonard_met = true;
                            game.save();
                            return "first_meet";
                        }
                        return "regular";
                    },
                    first_meet: {
                        text: "*Леонард оборачивается и измеряет тебя взглядом с головы до ног. Его губы чуть кривятся в полуулыбке* — Хм. Новичок. Я таких вижу каждый день. Большинство уходят с хвостом между ногами. *Он складывает руки на груди* — Меня зовут Леонард. Я — Советник этого квартала. И единственный, кто может решить кое-какие проблемы... если попросить правильно.",
                        options: [
                            { text: "Какие проблемы ты решаешь?", next: "what_do" },
                            { text: "Впечатляет. Я новый в этих краях.", next: "new_here" },
                            { text: "Мне нужна твоя помощь.", next: "need_help" }
                        ]
                    },
                    what_do: {
                        text: "*Леонард усмехается и поправляет манжету* — О, многие вещи. Вопросы земли. Связи между родами. Разрешения на торговлю. *Он наклоняется чуть ближе, снижая голос* — И кое-что менее публичное. Дворянский квартал — место, где умеющий договариваться может получить многое.",
                        options: [
                            { text: "Звучит как предложение.", next: "offer_hint" },
                            { text: "Мне многое ещё не понятно.", next: "new_here" }
                        ]
                    },
                    new_here: {
                        text: "*Леонард кивает, его взгляд становится чуть теплее* — Все когда-то были новичками. Даже я. *Он окидывает взгляд окрестности* — Дворянский квартал — место, где живут те, кто чего-то добился. Но добиться чего-то здесь нужны связи. А связи — моя специальность.",
                        options: [
                            { text: "Как мне обзавестись связями?", next: "offer_hint" },
                            { text: "Спасибо за информацию.", next: "exit" }
                        ]
                    },
                    need_help: {
                        text: "*Леонард поднимает бровь и смотрит тебе в глаза* — Помощь? *Пауза* Многие просят. Немногие могут отдать взамен. *Он чуть склоняет голову* — Скажи, что ты можешь предложить. Или просто докажи, что ты не из тех, кто только берёт.",
                        options: [
                            { text: "Я готов выполнить любое задание.", next: "quest_offer" },
                            { text: "Что тебе нужно?", next: "quest_offer" }
                        ]
                    },
                    offer_hint: {
                        text: "*Леонард задумчиво постукивает пальцами* — Связи строятся на услугах. Кто полезен — того помнят. *Он бросает на тебя быстрый взгляд* — У меня есть одно дело. Небольшое, но деликатное. Если справишься — ты попадёшь в мой список. А из моего списка открываются двери.",
                        options: [
                            { text: "Я готов. Говори.", next: "quest_offer" },
                            { text: "Что за дело?", next: "quest_offer" }
                        ]
                    },
                    quest_offer: {
                        text: "*Леонард понижает голос и чуть наклоняется* — Один из торговцев на рынке — некий Марк — крысит золото из общей кассы квартала. Немного, но достаточно, чтобы заметить. Мне нужны доказательства. *Он достаёт сложенную бумагу* — Адрес его склада. Тихо, незаметно. Найдёшь что-нибудь — принеси мне. Без глупостей.",
                        options: [
                            { text: "Понял. Я справлюсь.", action: "leonard_accept_quest", next: "quest_accepted" },
                            { text: "Мне нужно подумать.", next: "quest_think" }
                        ]
                    },
                    quest_think: {
                        text: "*Леонард пожимает плечами* — Время не терпит, но я не тороплю. *Через плечо* — Только не тяни. Марк нервный. Если почуит, что кто-то копается в его делах...",
                        options: [
                            { text: "Ладно, я возьмусь.", action: "leonard_accept_quest", next: "quest_accepted" },
                            { text: "Я вернусь позже.", next: "exit" }
                        ]
                    },
                    quest_accepted: {
                        text: "*Леонард кивает, и на его лице появляется тень уважения* — Хорошо. Склад Марка — юго-восточный угол рынка, красная крыша. Приходи тихо. Когда найдёшь бумаги — сюда, ко мне. *Он протягивает руку* — Добро пожаловать в большую игру.",
                        options: [
                            { text: "До встречи, Леонард.", next: "exit" }
                        ]
                    },
                    quest_active: {
                        text: "*Леонард бросает быстрый взгляд за твою спину* — Ты быстро вернулся. *Пауза* Как дела со складом Марка? Нашёл что-нибудь?",
                        options: [
                            { text: "Я ещё не нашёл доказательств.", next: "quest_wait" },
                            { text: "Дай мне ещё время.", next: "quest_wait" }
                        ]
                    },
                    quest_wait: {
                        text: "*Леонард морщит лоб* — Не затягивай. Марк — нервный человек. Если почуит, что кто-то копается в его делах... *Многозначительно замолкает*. Поторопись. Тебе нужно собрать 10 монет с гербом Марка — они где-то на его складе.",
                        options: [
                            { text: "Я найду их. Скоро.", next: "exit" }
                        ]
                    },
                    after_quest: function() {
                        if (!gameState.npcStates.leonard_thanked) {
                            gameState.npcStates.leonard_thanked = true;
                            game.save();
                            return "reward";
                        }
                        return "after_thanked";
                    },
                    reward: {
                        text: "*Леонард берёт бумаги и быстро просматривает их. Его глаза чуть расширяются* — Вот это да. Марк даже не подозревал. *Складывает документы* — Ты оправдал доверие. *Достаёт кошелёк* — 200 золота. И кое-что ещё — теперь ты можешь закупаться в лавке элиты. Добро пожаловать.",
                        options: [
                            { text: "Спасибо, Леонард.", next: "exit" }
                        ]
                    },
                    after_thanked: {
                        text: "*Леонард откинется назад* — Приятно иметь дело с надёжными людьми. *Смотрит на тебя* — Если появится новое дело — я дам знать. А пока пользуйся привилегиями.",
                        options: [
                            { text: "Что за привилегии?", next: "privileges" },
                            { text: "До встречи, Леонард.", next: "exit" }
                        ]
                    },
                    privileges: {
                        text: "*Леонард улыбается — редко, но искренне* — Лавка элиты открыта только для тех, кому я доверяю. Кожа высшего сорта, редкие материалы для крафта. *Наклоняет голову* — Заслуженно.",
                        options: [
                            { text: "Благодарю тебя.", next: "exit" }
                        ]
                    },
                    regular: {
                        text: "*Леонард кивает мимоходом* — О, ты снова здесь. *Не останавливается, пролистывая записи* — Если есть дело — говори.",
                        options: [
                            { text: "У меня есть вопрос.", next: "regular_question" },
                            { text: "Просто проходил мимо.", next: "exit" }
                        ]
                    },
                    regular_question: {
                        text: "*Леонард поднимает взгляд и терпеливо ждёт* — Слушаю.",
                        options: [
                            { text: "Как устроен этот квартал?", next: "about_district" },
                            { text: "Кто здесь живёт?", next: "about_nobles" },
                            { text: "Ладно, ничего страшного.", next: "exit" }
                        ]
                    },
                    about_district: {
                        text: "*Леонард оставляет бумаги* — Дворянский квартал — сердце власти. Каждый особняк принадлежит роду с историей. *Указывает вдаль* — Золотые ворота ведут к замку. Здесь живут те, кому подчиняются другие. И каждый хочет ещё больше.",
                        options: [
                            { text: "Понял.", next: "exit" }
                        ]
                    },
                    about_nobles: {
                        text: "*Леонард задумывается* — Дворяне — непростые люди. Каждый с амбициями. Кто-то строит дом, кто-то ищет союзников. *Снижает голос* — И все следят друг за другом. Здесь слова имеют вес. Будь осторожен, с кем говоришь.",
                        options: [
                            { text: "Буду иметь в виду.", next: "exit" }
                        ]
                    }
                }
            },
            lily_home: {
                name: "Лили",
                role: "Дворянка",
                icon: "fa-user-crown",
                dialogue: {
                    root: function() {
                        // Если книга возвращена
                        if (gameState.npcStates && gameState.npcStates.lilyBookReturned) {
                            return "after_book";
                        }
                        // Если книга в инвентаре
                        if (gameState.lilyBook) {
                            return "has_book";
                        }
                        // Если задание активно
                        if (gameState.npcStates && gameState.npcStates.lilyQuestActive) {
                            return "quest_active";
                        }
                        // Первая встреча
                        if (!gameState.npcStates || !gameState.npcStates.lilyHomeMet) {
                            if (!gameState.npcStates) gameState.npcStates = {};
                            gameState.npcStates.lilyHomeMet = true;
                            game.save();
                            return "first_meet";
                        }
                        return "regular";
                    },
                    first_meet: {
                        text: "О, это ты! — *Лили улыбается, её глаза сверкают* — Я так рада, что ты пришёл. Проходи, не стесняйся! *Она игриво наклоняет голову* Мой дом — твой дом.",
                        options: [
                            { text: "Ты очень гостеприимна", next: "flirt_1" },
                            { text: "У тебя красивый дом", next: "about_house" },
                            { text: "Как твои дела?", next: "how_are_you" }
                        ]
                    },
                    flirt_1: {
                        text: "*Лили подходит ближе, её аромат духов окутывает тебя* — Только для особенных людей. *Она касается твоей руки* А ты... особенный. Знаешь, я давно хотела тебя о чём-то попросить...",
                        options: [
                            { text: "О чём?", next: "quest_reveal" },
                            { text: "*Улыбнуться* Я весь внимание", next: "quest_reveal" }
                        ]
                    },
                    about_house: {
                        text: "*Лили оглядывается вокруг* — Спасибо! Но знаешь... даже в таком прекрасном доме чего-то не хватает. *Она вздыхает* Я потеряла нечто очень дорогое моему сердцу...",
                        options: [
                            { text: "Что ты потеряла?", next: "quest_reveal" }
                        ]
                    },
                    how_are_you: {
                        text: "*Лили грустно улыбается* — Если честно... не очень. Я потеряла свою самую любимую книгу. Это было последнее, что осталось от моей матери... *Её глаза увлажняются*",
                        options: [
                            { text: "Может, я помогу найти её?", next: "quest_reveal" },
                            { text: "Мне очень жаль", next: "quest_reveal" }
                        ]
                    },
                    quest_reveal: {
                        text: "*Лили берёт тебя за руки* — Ты бы... правда помог мне? Это была книга со стихами, в кожаном переплёте с золотым тиснением. Я потеряла её где-то в городе... *Она смотрит тебе в глаза* Если ты найдёшь её... я буду так тебе благодарна...",
                        options: [
                            { text: "Я обязательно найду её для тебя", action: "accept_lily_quest", next: "quest_accepted" },
                            { text: "Я постараюсь", action: "accept_lily_quest", next: "quest_accepted" }
                        ]
                    },
                    quest_accepted: {
                        text: "*Лили обнимает тебя* — Спасибо! Ты не представляешь, как это для меня важно! *Она нежно целует тебя в щёку* Я буду ждать тебя...",
                        options: [
                            { text: "Я вернусь с книгой", next: "exit" }
                        ]
                    },
                    quest_active: {
                        text: "*Лили с надеждой смотрит на тебя* — Ты нашёл мою книгу? Я так волнуюсь...",
                        options: [
                            { text: "Ещё ищу", next: "still_searching" },
                            { text: "Я не забыл о твоей просьбе", next: "exit" }
                        ]
                    },
                    still_searching: {
                        text: "*Лили нежно гладит твою руку* — Я знаю, что ты найдёшь её. Я верю в тебя... *Она смотрит на тебя с обожанием*",
                        options: [
                            { text: "Я не подведу тебя", next: "exit" }
                        ]
                    },
                    has_book: {
                        text: "*Лили видит книгу в твоих руках, её глаза расширяются* — Это она! Моя книга! О боже, ты нашёл её! *Она хватает книгу и прижимает к груди, слёзы радости блестят в её глазах*",
                        options: [
                            { text: "Я рад, что смог помочь", action: "return_book", next: "book_returned" }
                        ]
                    },
                    book_returned: {
                        text: "*Лили ставит книгу на стол и подходит к тебе очень близко* — Ты не просто вернул мне книгу... ты вернул мне частичку моей души. *Она обнимает тебя и нежно целует в губы* Спасибо... спасибо тебе... *Её щёки розовеют* Теперь ты всегда можешь приходить ко мне...",
                        options: [
                            { text: "Я обязательно приду", next: "exit" }
                        ]
                    },
                    after_book: {
                        text: "*Лили светится от счастья* — Ты вернулся ко мне! *Она обнимает тебя* Каждый раз, когда я открываю эту книгу, я думаю о тебе... *Она краснеет*",
                        options: [
                            { text: "Я тоже думаю о тебе", next: "romance_continue" },
                            { text: "Как ты?", next: "casual_chat" },
                            { text: "Просто зашёл навестить", next: "exit" }
                        ]
                    },
                    romance_continue: {
                        text: "*Лили нежно целует тебя* — Ты такой... особенный. С тобой я чувствую себя в безопасности. *Она прижимается к тебе* Останься со мной немного...",
                        options: [
                            { text: "С удовольствием", next: "exit" }
                        ]
                    },
                    casual_chat: {
                        text: "Я читаю стихи и думаю о прекрасном. А ещё... я думаю о тебе. *Она игриво улыбается* Ты стал для меня очень важным человеком.",
                        options: [
                            { text: "Ты тоже важна для меня", next: "exit" }
                        ]
                    },
                    regular: {
                        text: "Привет! Заходи, я всегда рада видеть тебя. *Она улыбается*",
                        options: [
                            { text: "Как дела?", next: "how_are_you" },
                            { text: "Просто зашёл поздороваться", next: "exit" }
                        ]
                    }
                }
            }
        };

        // Helpers for Dialogue
        function hasStoryQuest(id) {
            return (gameState.storyQuests || []).some(q => q.id === id);
        }
        function isQuestCompleted(id) {
            // Check completed history if we added it, for now just check if not active and reward claimed logic
            // Simplified: we'll check a flag in npcStates or just assumed claimed quests are removed or marked
            return (gameState.storyQuests || []).some(q => q.id === id && q.state === 'claimed');
        }

        const dialogue = {
            currentNPC: null,
            
            // Character images database
            characterImages: {
                'lili': 'https://i.postimg.cc/yxdCDXtp/image-Picsart-Background-Remover.png',
                'arthur': 'https://i.postimg.cc/Y9Yn3XLD/IMG-4611.png',
                'john': 'https://i.postimg.cc/fRy8FW0W/IMG-4613.png',
                'marius': 'https://i.postimg.cc/65gZWBmZ/IMG-4614.png',
                'hank': 'https://i.postimg.cc/jjVk70L0/IMG-4615.png',
                'sage': 'https://i.postimg.cc/8PjyXPvd/IMG-4616.png',
                'eldar': 'https://i.postimg.cc/8PjyXPvd/IMG-4616.png',
                'ben': 'https://i.postimg.cc/vTr8kPhR/IMG-4620.png',
                'tournamentmaster': 'https://i.postimg.cc/50vfQPDr/IMG-4619.png',
                'leonard': 'https://i.postimg.cc/5y4CYk1g/IMG-4664.png',
                'hugh': 'https://i.postimg.cc/tgFkFwQ1/IMG-4670.png',
                'alex': 'https://i.postimg.cc/tCDLx1dM/IMG-4665.png',
                'oldman_port': 'https://i.postimg.cc/ncVWpF8k/IMG-4666.png',
                'peter': 'https://i.postimg.cc/50MPG1q6/IMG-4667.png',
                'shoemaker': 'https://i.postimg.cc/brymyT5Z/IMG-4668.png',
                'castle_guard': 'https://i.postimg.cc/FsKTwTc6/IMG-4669.png',
                'noble_guard': 'https://i.postimg.cc/QdvqgMK8/image-Picsart-Background-Remover-(8).png',
                'elara': '',
                'sarah': 'https://i.postimg.cc/fWcmXfxm/IMG-4671.png',
                'eigan': '',
                'gorn': '',
                'thomas': '',
                'sage': 'https://i.postimg.cc/8PjyXPvd/IMG-4616.png'
            },
            
            start: function(npcId) {
                const npc = NPC_DB[npcId];
                if (!npc) return;
                
                this.currentNPC = npcId;
                document.getElementById('npc-name').innerText = npc.name;
                document.getElementById('npc-role').innerText = npc.role;
                
                // Set character image
                const charImg = document.getElementById('npc-character-image');
                const bgGradient = document.getElementById('npc-bg-gradient');
                charImg.onerror = () => {
                    charImg.src = '';
                    charImg.style.opacity = '0';
                    charImg.classList.remove('loaded');
                };
                
                let chosenSrc = '';
                const mapped = this.characterImages[npcId];
                const uiImg = document.querySelector(`img[alt="${npc.name}"]`);
                chosenSrc = mapped || (uiImg && uiImg.src) || '';
                if (chosenSrc) {
                    charImg.src = chosenSrc;
                    charImg.classList.remove('loaded');
                    charImg.onload = () => {
                        setTimeout(() => {
                            charImg.classList.add('loaded');
                        }, 50);
                    };
                } else {
                    charImg.src = '';
                    charImg.style.opacity = '0';
                }
                
                // Set gradient colors based on NPC
                let gradientColors = "linear-gradient(135deg, #c8aa6e 0%, #8b733d 50%, #c8aa6e 100%)";
                if(npcId === 'arthur') {
                    gradientColors = "linear-gradient(135deg, #c8aa6e 0%, #d4af37 50%, #c8aa6e 100%)"; // Golden
                } else if(npcId === 'lili') {
                    gradientColors = "linear-gradient(135deg, #ec4899 0%, #8b5cf6 50%, #ec4899 100%)"; // Pink-Purple
                } else if(npcId === 'ben') {
                    gradientColors = "linear-gradient(135deg, #f97316 0%, #ea580c 50%, #f97316 100%)"; // Orange
                } else if(npcId === 'elara') {
                    gradientColors = "linear-gradient(135deg, #8b5cf6 0%, #6366f1 50%, #8b5cf6 100%)"; // Purple
                } else if(npcId === 'gorn') {
                    gradientColors = "linear-gradient(135deg, #dc2626 0%, #991b1b 50%, #dc2626 100%)"; // Red
                } else if(npcId === 'john') {
                    gradientColors = "linear-gradient(135deg, #ef4444 0%, #b91c1c 50%, #ef4444 100%)"; // Warrior Red
                } else if(npcId === 'marius') {
                    gradientColors = "linear-gradient(135deg, #10b981 0%, #059669 50%, #10b981 100%)"; // Healer Green
                } else if(npcId === 'hank') {
                    gradientColors = "linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #f59e0b 100%)"; // Merchant Amber
                } else if(npcId === 'sage') {
                    gradientColors = "linear-gradient(135deg, #6366f1 0%, #4f46e5 50%, #6366f1 100%)"; // Sage Indigo
                } else if(npcId === 'eldar') {
                    gradientColors = "linear-gradient(135deg, #6366f1 0%, #4f46e5 50%, #6366f1 100%)"; // Sage Indigo
                } else if(npcId === 'alex') {
                    gradientColors = "linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #3b82f6 100%)"; // Blue
                } else if(npcId === 'thomas') {
                    gradientColors = "linear-gradient(135deg, #64748b 0%, #475569 50%, #64748b 100%)"; // Slate Gray
                } else if(npcId === 'tournamentmaster') {
                    gradientColors = "linear-gradient(135deg, #d97706 0%, #f59e0b 50%, #d97706 100%)"; // Tournament Gold
                } else if(npcId === 'leonard') {
                    gradientColors = "linear-gradient(135deg, #b45309 0%, #d97706 50%, #92400e 100%)"; // Dark Noble Gold
                } else if(npcId === 'hugh') {
                    gradientColors = "linear-gradient(135deg, #166534 0%, #15803d 50%, #14532d 100%)"; // Emerald Farm
                } else if(npcId === 'sarah') {
                    gradientColors = "linear-gradient(135deg, #a855f7 0%, #7c3aed 50%, #a855f7 100%)";
                } else if(npcId === 'eigan') {
                    gradientColors = "linear-gradient(135deg, #0ea5e9 0%, #1d4ed8 50%, #0ea5e9 100%)";
                } else if(npcId === 'oldman_port') {
                    gradientColors = "linear-gradient(135deg, #0369a1 0%, #0284c7 50%, #075985 100%)"; // Ocean Blue
                } else if(npcId === 'peter') {
                    gradientColors = "linear-gradient(135deg, #7c3aed 0%, #a78bfa 50%, #6d28d9 100%)"; // Tailor Violet
                } else if(npcId === 'shoemaker') {
                    gradientColors = "linear-gradient(135deg, #92400e 0%, #b45309 50%, #78350f 100%)"; // Leather Brown
                } else if(npcId === 'castle_guard') {
                    gradientColors = "linear-gradient(135deg, #be123c 0%, #e11d48 50%, #9f1239 100%)"; // Royal Crimson
                } else if(npcId === 'noble_guard') {
                    gradientColors = "linear-gradient(135deg, #1e3a5f 0%, #2d5a8e 50%, #1a2f4a 100%)"; // Palace Steel Blue
                }
                
                bgGradient.style.background = gradientColors;
                bgGradient.style.backgroundSize = "200% 200%";
                
                const iconContainer = document.getElementById('npc-icon').parentNode;
                document.getElementById('npc-icon').className = `fas ${npc.icon} text-2xl`;
                document.getElementById('npc-icon').style.color = "#c8aa6e";
                document.getElementById('npc-icon').style.filter = "drop-shadow(0 0 8px rgba(200,170,110,0.6))";

                this.renderNode('root');
                document.getElementById('modal-dialogue').classList.add('open');
            },
            
            close: function() {
                document.getElementById('modal-dialogue').classList.remove('open');
                this.currentNPC = null;
            },
            
            renderNode: function(nodeKey) {
                const npc = NPC_DB[this.currentNPC];
                let node = npc.dialogue[nodeKey];
                
                // If node is a function, execute it to get the real node key
                if (typeof node === 'function') {
                    const nextKey = node();
                    node = npc.dialogue[nextKey];
                }

                const textElement = document.getElementById('npc-text');
                textElement.style.animation = 'none';
                setTimeout(() => {
                    textElement.innerText = node.text;
                    textElement.style.animation = 'fadeInText 0.6s ease-out';
                }, 10);
                
                const optsContainer = document.getElementById('npc-options');
                optsContainer.innerHTML = '';
                
                const options = typeof node.options === 'function' ? node.options() : node.options;
                options.forEach((opt, index) => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-3.5 rounded-lg relative overflow-hidden border transition-all group";
                    
                    // Create gradient background
                    btn.style.background = "linear-gradient(135deg, rgba(42,42,46,0.6), rgba(26,26,29,0.8))";
                    btn.style.borderColor = "rgba(200,170,110,0.3)";
                    btn.style.animation = `slideInOption 0.4s ease-out ${index * 0.1}s both`;
                    
                    // Add hover glow effect element
                    const glowEffect = document.createElement('div');
                    glowEffect.className = "absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300";
                    glowEffect.style.background = "linear-gradient(135deg, rgba(200,170,110,0.15), rgba(139,115,61,0.1))";
                    glowEffect.style.pointerEvents = "none";
                    btn.appendChild(glowEffect);
                    
                    // Add shine effect
                    const shine = document.createElement('div');
                    shine.className = "absolute inset-0 opacity-0 group-hover:opacity-100 transition-all duration-500";
                    shine.style.background = "linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent)";
                    shine.style.transform = "translateX(-100%)";
                    shine.style.pointerEvents = "none";
                    btn.appendChild(shine);
                    
                    // Text content
                    const textSpan = document.createElement('span');
                    textSpan.className = "relative text-sm text-[#e0e0e0] group-hover:text-[#c8aa6e] transition-colors duration-300 flex items-center gap-2";
                    textSpan.style.textShadow = "0 1px 2px rgba(0,0,0,0.5)";
                    
                    const arrow = document.createElement('i');
                    arrow.className = "fas fa-chevron-right text-[10px] text-[#c8aa6e]/50 group-hover:text-[#c8aa6e] group-hover:translate-x-1 transition-all duration-300";
                    
                    const text = document.createElement('span');
                    text.innerText = opt.text;
                    
                    textSpan.appendChild(arrow);
                    textSpan.appendChild(text);
                    btn.appendChild(textSpan);
                    
                    // Enhanced hover effects
                    btn.onmouseenter = () => {
                        btn.style.borderColor = "rgba(200,170,110,0.6)";
                        btn.style.transform = "translateX(4px)";
                        btn.style.boxShadow = "0 0 20px rgba(200,170,110,0.2), inset 0 0 20px rgba(200,170,110,0.05)";
                        shine.style.transform = "translateX(100%)";
                    };
                    
                    btn.onmouseleave = () => {
                        btn.style.borderColor = "rgba(200,170,110,0.3)";
                        btn.style.transform = "translateX(0)";
                        btn.style.boxShadow = "none";
                        shine.style.transform = "translateX(-100%)";
                    };
                    
                    btn.onclick = () => {
                        // Click animation
                        btn.style.transform = "scale(0.98)";
                        setTimeout(() => {
                            if (opt.action) this.handleAction(opt.action);
                            
                            if (opt.next === 'exit') this.close();
                            else this.renderNode(opt.next);
                        }, 100);
                    };
                    
                    optsContainer.appendChild(btn);
                });
            },
            
            handleAction: function(action) {
                if (action === 'start_q_arthur_1') {
                    this.addQuest('q_arthur_1', 'Просьба Артура', 'Принести 3 рыбы Артуру.', {type: 'gather', target: 'fish', count: 3}, {gold: 50, xp: 10});
                }
                if (action === 'start_q_gorn_1') {
                    this.addQuest('q_gorn_1', 'Руда для Кузнеца', 'Добыть 5 руды для Горна.', {type: 'gather', target: 'ore', count: 5}, {gold: 250, xp: 50});
                }
                if (action === 'start_q_elara_1') {
                    this.addQuest('q_elara_1', 'Лесные травы', 'Собрать 5 трав для Элары.', {type: 'gather', target: 'herbs', count: 5}, {gold: 100, xp: 30});
                }
                if (action === 'start_q_john_1') {
                    this.addQuest('q_john_1', 'Путь Воина', 'Достичь 15 уровня и прийти в Учебный лагерь.', {type: 'visit', target: 'camp', count: 1}, {gold: 500, xp: 100});
                }
                if (action === 'start_q_marius_1') {
                    this.addQuest('q_marius_1', 'Травы для Мариуса', 'Собрать 5 трав.', {type: 'gather', target: 'herbs', count: 5}, {gold: 75, xp: 25});
                }
                if (action === 'set_player_name') {
                    const name = prompt('Как тебя зовут?').trim();
                    if (name) {
                        gameState.playerName = name.slice(0, 20);
                        game.save();
                        ui.updateStats();
                        ui.showFloatText(document.body, `Имя обновлено: ${gameState.playerName}`, "#34d399");
                    }
                    this.addQuest('q_arthur_1', 'Просьба Артура', 'Принести 3 рыбы Артуру.', {type: 'gather', target: 'fish', count: 3}, {gold: 50, xp: 10});
                }
                if (action === 'accept_oldman') {
                    const stolenGold = gameState.gold;
                    gameState.gold = 0;
                    const damage = Math.floor(Math.random() * 20) + 30;
                    gameState.hp = Math.max(1, gameState.hp - damage);
                    game.addReputation(-5, document.body);
                    game.save();
                    ui.updateStats();
                    setTimeout(() => {
                        ui.showFloatText(document.body, `Ограбление! -${stolenGold} золота`, "#ff5555");
                        setTimeout(() => {
                            ui.showFloatText(document.body, `-${damage} HP (Удар камнем!)`, "#ef4444");
                        }, 500);
                    }, 300);
                }
                if (action === 'accept_alex_job') {
                    if (!gameState.npcStates) gameState.npcStates = {};
                    gameState.npcStates.alex_job_unlocked = true;
                    game.save();
                    ui.showFloatText(document.body, "Новая работа: Грузчик!", "#fbbf24");
                    ui.updateJobs();
                }
                if (action === 'beggar_give_10' || action === 'beggar_give_50' || action === 'beggar_give_100') {
                    if (!gameState.npcStates) gameState.npcStates = {};
                    const amount = action === 'beggar_give_10' ? 10 : action === 'beggar_give_50' ? 50 : 100;
                    if (gameState.gold >= amount) {
                        gameState.gold -= amount;
                        gameState.npcStates.old_beggar_helped = true;
                        game.save();
                        ui.updateStats();
                        ui.showFloatText(document.body, `- ${amount} золота`, "#ffdd55");
                    } else {
                        ui.showFloatText(document.body, "Не хватает золота", "#ff5555");
                    }
                }
                if (action === 'beggar_refuse') {
                    if (!gameState.npcStates) gameState.npcStates = {};
                    gameState.npcStates.old_beggar_refused = true;
                    game.save();
                }
                if (action === 'buy_peasant') {
                    game.buyClothes('peasant', 5000);
                }
                if (action === 'buy_rich') {
                    game.buyClothes('rich', 50000);
                }
                if (action === 'buy_noble') {
                    game.buyClothes('noble', 500);
                }
                if (action === 'start_q_sage_1') {
                    this.addQuest('q_sage_1', 'Грибы для Мудреца', 'Собрать 20 грибов для Эльдара.', {type: 'gather', target: 'mushrooms', count: 20}, {gold: 300, xp: 80});
                }
                if (action === 'start_eigan_quest') {
                    if (!gameState.npcStates) gameState.npcStates = {};
                    gameState.npcStates.eiganQuestActive = true;
                    game.save();
                    ui.showFloatText(document.body, "Новый квест: Древний тотем", "#fbbf24");
                }
                if (action === 'return_totem') {
                    if (!gameState.npcStates) gameState.npcStates = {};
                    gameState.npcStates.eiganQuestActive = false;
                    gameState.npcStates.eiganQuestComplete = true;
                    gameState.emeralds += 15;
                    gameState.xp += 100;
                    
                    // Give luck amulet as reward
                    if (!gameState.amulets) gameState.amulets = {};
                    gameState.amulets.luck = { owned: true, name: "Амулет удачи", bonus: "+10% к шансу редких находок" };
                    
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(document.body, "+15 изумрудов", "#10b981");
                    setTimeout(() => {
                        ui.showFloatText(document.body, "+100 XP", "#3b82f6");
                    }, 300);
                    setTimeout(() => {
                        ui.showFloatText(document.body, "Получен: Амулет удачи!", "#c084fc");
                    }, 600);
                }
                if (action === 'unlock_refugee') {
                    if (!gameState.npcStates) gameState.npcStates = {};
                    gameState.npcStates.thomas_met = true;
                    game.save();
                    ui.updateLocations();
                    ui.showFloatText(document.body, "Лагерь беженцев открыт", "#fbbf24");
                }
                if (action === 'leonard_accept_quest') {
                    if (!gameState.npcStates) gameState.npcStates = {};
                    gameState.npcStates.leonard_quest_active = true;
                    game.save();
                    ui.showFloatText(document.body, "Новое задание: Склад Марка", "#fbbf24");
                }
                if (action === 'try_cure') {
                    village.cureMeasles();
                }
                if (action === 'bandits_pay') {
                    gameState.gold = Math.max(0, gameState.gold - 200);
                    gameState.npcStates.villageBanditsDone = true;
                    game.addReputation(1, document.body);
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(document.body, "-200 Золота", "#ff5555");
                }
                if (action === 'bandits_run') {
                    gameState.gold = Math.max(0, gameState.gold - 200);
                    gameState.hp = Math.max(1, gameState.hp - 30);
                    gameState.npcStates.villageBanditsDone = true;
                    game.addReputation(-2, document.body);
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(document.body, "-200 Золота", "#ff5555");
                    setTimeout(() => ui.showFloatText(document.body, "-30 HP", "#ef4444"), 400);
                }
                if (action === 'bandits_bluff') {
                    gameState.npcStates.villageBanditsDone = true;
                    game.addReputation(-1, document.body);
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(document.body, "Отпущен без платы", "#34d399");
                }
                if (action === 'lili_wait') {
                    if (!gameState.npcStates) gameState.npcStates = {};
                    gameState.npcStates.lili_waiting = true;
                    gameState.npcStates.lili_wait_time = Date.now();
                    game.save();
                }
                if (action === 'lili_gift') {
                    if (!gameState.npcStates) gameState.npcStates = {};
                    gameState.npcStates.lili_gifted = true;
                    gameState.npcStates.lili_waiting = false;
                    if (!gameState.recipes) gameState.recipes = {};
                    gameState.recipes.saddle = true;
                    game.addReputation(2, document.body);
                    game.save();
                    ui.showFloatText(document.body, "Рецепт: Кожаное седло", "#34d399");
                }
                if (action === 'start_q_lili_visit') {
                    this.addQuest('q_lili_visit', 'Приглашение Лили', 'Навестить Лили в Дворянском квартале.', {type: 'visit', target: 'noble-quarter', count: 1}, {gold: 0, xp: 50});
                }
                if (action === 'accept_hank_quest') {
                    if (!gameState.npcStates) gameState.npcStates = {};
                    gameState.npcStates.hankAmuletActive = true;
                    game.save();
                    ui.showFloatText(document.body, "Новый квест: Амулет Хэнка", "#fbbf24");
                }
                if (action === 'return_amulet') {
                    if (gameState.npcStates && gameState.npcStates.hankAmuletFound) {
                        gameState.npcStates.hankAmuletComplete = true;
                        gameState.npcStates.hankAmuletActive = false;
                        gameState.emeralds += 10;
                        game.addReputation(3, document.body);
                        game.save();
                        ui.updateStats();
                        ui.showFloatText(document.body, "+10 Изумрудов!", "#34d399");
                    }
                }
                if (action === 'accept_lily_quest') {
                    if (!gameState.npcStates) gameState.npcStates = {};
                    gameState.npcStates.lilyQuestActive = true;
                    game.save();
                    // Показываем задание на доске объявлений
                    const questEl = document.getElementById('lily-book-quest');
                    if (questEl) questEl.classList.remove('hidden');
                    // Показываем статус квеста
                    const statusEl = document.getElementById('lily-quest-status');
                    if (statusEl) statusEl.classList.remove('hidden');
                }
                if (action === 'return_book') {
                    if (gameState.lilyBook) {
                        gameState.lilyBook = false;
                        gameState.npcStates.lilyBookReturned = true;
                        gameState.npcStates.lilyQuestActive = false;
                        game.addReputation(5, document.body);
                        game.save();
                        ui.updateStats();
                        inventory.render();
                        ui.showFloatText(document.body, "+5 Репутация 💕", "#ec4899");
                        // Скрываем статус квеста
                        const statusEl = document.getElementById('lily-quest-status');
                        if (statusEl) statusEl.classList.add('hidden');
                    }
                }
                if (action === 'beggar_give_10') {
                    if (gameState.gold >= 10) {
                        gameState.gold -= 10;
                        game.addReputation(1, document.body);
                        game.save();
                        ui.updateStats();
                        ui.showFloatText(document.body, "-10 золота", "#fbbf24");
                    }
                }
                if (action === 'beggar_give_50') {
                    if (gameState.gold >= 50) {
                        gameState.gold -= 50;
                        game.addReputation(3, document.body);
                        game.save();
                        ui.updateStats();
                        ui.showFloatText(document.body, "-50 золота", "#fbbf24");
                    }
                }
                if (action === 'beggar_give_100') {
                    if (gameState.gold >= 100) {
                        gameState.gold -= 100;
                        game.addReputation(5, document.body);
                        game.save();
                        ui.updateStats();
                        ui.showFloatText(document.body, "-100 золота", "#fbbf24");
                    }
                }
                if (action === 'play_dice') {
                    if (gameState.gold >= 500) {
                        gameState.gold -= 500;
                        
                        // Player rolls
                        const playerDice1 = Math.floor(Math.random() * 6) + 1;
                        const playerDice2 = Math.floor(Math.random() * 6) + 1;
                        const playerTotal = playerDice1 + playerDice2;
                        
                        // Gambler rolls
                        const gamblerDice1 = Math.floor(Math.random() * 6) + 1;
                        const gamblerDice2 = Math.floor(Math.random() * 6) + 1;
                        const gamblerTotal = gamblerDice1 + gamblerDice2;
                        
                        game.save();
                        ui.updateStats();
                        
                        setTimeout(() => {
                            let resultText = `Вы: ${playerDice1} + ${playerDice2} = ${playerTotal}\nИгрок: ${gamblerDice1} + ${gamblerDice2} = ${gamblerTotal}\n\n`;
                            
                            if (playerTotal > gamblerTotal) {
                                gameState.gold += 1000;
                                resultText += "Вы выиграли 1000 золотых!";
                                game.save();
                                ui.updateStats();
                                alert(resultText);
                                ui.showFloatText(document.body, "+500 золота (выигрыш)", "#34d399");
                            } else if (playerTotal < gamblerTotal) {
                                resultText += "Вы проиграли... Игрок забирает банк.";
                                alert(resultText);
                                ui.showFloatText(document.body, "-500 золота (проигрыш)", "#ef4444");
                            } else {
                                gameState.gold += 500;
                                resultText += "Ничья! Ставка возвращена.";
                                game.save();
                                ui.updateStats();
                                alert(resultText);
                                ui.showFloatText(document.body, "Ставка возвращена", "#fbbf24");
                            }
                        }, 500);
                    }
                }
            },
            
            addQuest: function(id, title, desc, goals, reward) {
                if (!gameState.storyQuests) gameState.storyQuests = [];
                gameState.storyQuests.push({
                    id: id,
                    title: title,
                    desc: desc,
                    goals: goals, // Using 'sell' type logic for gathering just for tracking simplicity or create new type
                    current: 0,
                    reward: reward,
                    state: 'active'
                });
                game.save();
                ui.showFloatText(document.body, "Новое задание!", "#fbbf24");
            },
            
            // Helper to complete quest manually (dialogue driven)
            completeQuest: function(id) {
                // We rely on quests.claimStory logic but triggered manually without button
                quests.claimStory(id, true);
            }
        };

        // --- BLACKJACK GAME CONTROLLER ---
        const blackjack = {
            deck: [],
            playerHand: [],
            dealerHand: [],
            currentBet: 2000,
            gameInProgress: false,
            dealerRevealed: false,
            
            suits: ['♠', '♥', '♣', '♦'],
            ranks: ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'],
            
            open: function() {
                document.getElementById('modal-blackjack').classList.add('open');
                this.resetGame();
            },
            
            close: function() {
                document.getElementById('modal-blackjack').classList.remove('open');
            },
            
            setBet: function(amount, event) {
                if (this.gameInProgress) return;
                
                this.currentBet = amount;
                document.getElementById('current-bet').textContent = amount;
                
                // Update active bet button
                document.querySelectorAll('.bet-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                if (event && event.target) {
                    event.target.classList.add('active');
                }
            },
            
            createDeck: function() {
                this.deck = [];
                for (let suit of this.suits) {
                    for (let rank of this.ranks) {
                        this.deck.push({ rank, suit });
                    }
                }
                // Shuffle deck
                for (let i = this.deck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.deck[i], this.deck[j]] = [this.deck[j], this.deck[i]];
                }
            },
            
            getCardValue: function(card) {
                if (card.rank === 'A') return 11;
                if (['J', 'Q', 'K'].includes(card.rank)) return 10;
                return parseInt(card.rank);
            },
            
            calculateScore: function(hand) {
                let score = 0;
                let aces = 0;
                
                for (let card of hand) {
                    let value = this.getCardValue(card);
                    if (value === 11) aces++;
                    score += value;
                }
                
                // Adjust for aces
                while (score > 21 && aces > 0) {
                    score -= 10;
                    aces--;
                }
                
                return score;
            },
            
            createCardElement: function(card, hidden = false) {
                const cardDiv = document.createElement('div');
                
                if (hidden) {
                    cardDiv.className = 'bj-card back';
                } else {
                    const isRed = card.suit === '♥' || card.suit === '♦';
                    cardDiv.className = `bj-card ${isRed ? 'red' : 'black'}`;
                    
                    const rankTop = document.createElement('div');
                    rankTop.className = 'bj-card-rank';
                    rankTop.textContent = card.rank;
                    
                    const suitMiddle = document.createElement('div');
                    suitMiddle.className = 'bj-card-suit';
                    suitMiddle.textContent = card.suit;
                    
                    const rankBottom = document.createElement('div');
                    rankBottom.className = 'bj-card-corner';
                    rankBottom.textContent = card.rank + card.suit;
                    
                    cardDiv.appendChild(rankTop);
                    cardDiv.appendChild(suitMiddle);
                    cardDiv.appendChild(rankBottom);
                }
                
                return cardDiv;
            },
            
            updateDisplay: function() {
                try {
                    console.log('Blackjack: updateDisplay called');
                    
                    const playerCardsEl = document.getElementById('player-cards');
                    const dealerCardsEl = document.getElementById('dealer-cards');
                    
                    console.log('Blackjack: Elements found:', !!playerCardsEl, !!dealerCardsEl);
                    
                    if (!playerCardsEl || !dealerCardsEl) {
                        console.error('Blackjack: Card elements not found!');
                        return;
                    }
                    
                    // Clear existing cards
                    playerCardsEl.innerHTML = '';
                    dealerCardsEl.innerHTML = '';
                    
                    console.log('Blackjack: Cleared elements');
                    
                    // Display player cards
                    this.playerHand.forEach((card, index) => {
                        console.log('Blackjack: Adding player card', index, card);
                        playerCardsEl.appendChild(this.createCardElement(card));
                    });
                    
                    // Display dealer cards
                    this.dealerHand.forEach((card, index) => {
                        const hidden = !this.dealerRevealed && index === 1;
                        console.log('Blackjack: Adding dealer card', index, card, 'hidden:', hidden);
                        dealerCardsEl.appendChild(this.createCardElement(card, hidden));
                    });
                    
                    // Update scores
                    const playerScore = this.calculateScore(this.playerHand);
                    document.getElementById('player-score').textContent = playerScore;
                    
                    if (this.dealerRevealed) {
                        const dealerScore = this.calculateScore(this.dealerHand);
                        document.getElementById('dealer-score').textContent = dealerScore;
                    } else {
                        const firstCardValue = this.getCardValue(this.dealerHand[0]);
                        document.getElementById('dealer-score').textContent = firstCardValue + ' + ?';
                    }
                    
                    console.log('Blackjack: Display updated successfully');
                } catch (error) {
                    console.error('Blackjack error in updateDisplay:', error);
                }
            },
            
            showMessage: function(message, color = '#a78bfa') {
                const messageEl = document.getElementById('game-message');
                messageEl.innerHTML = `<p class="text-sm medieval-font" style="color: ${color};">${message}</p>`;
            },
            
            startGame: function() {
                try {
                    console.log('Blackjack: Starting game...');
                    
                    if (gameState.gold < this.currentBet) {
                        this.showMessage('❌ Недостаточно золота для ставки!', '#ef4444');
                        return;
                    }
                    
                    console.log('Blackjack: Gold check passed');
                    
                    // Deduct bet
                    gameState.gold -= this.currentBet;
                    game.save();
                    ui.updateStats();
                    
                    console.log('Blackjack: Bet deducted');
                    
                    // Initialize game
                    this.gameInProgress = true;
                    this.dealerRevealed = false;
                    this.createDeck();
                    
                    console.log('Blackjack: Deck created, size:', this.deck.length);
                    
                    this.playerHand = [];
                    this.dealerHand = [];
                    
                    // Deal initial cards
                    this.playerHand.push(this.deck.pop());
                    this.dealerHand.push(this.deck.pop());
                    this.playerHand.push(this.deck.pop());
                    this.dealerHand.push(this.deck.pop());
                    
                    console.log('Blackjack: Cards dealt. Player:', this.playerHand.length, 'Dealer:', this.dealerHand.length);
                    
                    this.updateDisplay();
                    
                    console.log('Blackjack: Display updated');
                    
                    this.showMessage('🎲 Игра началась! Возьмите карту или остановитесь.', '#a78bfa');
                    
                    // Switch controls
                    document.getElementById('bet-controls').classList.add('hidden');
                    document.getElementById('game-controls').classList.remove('hidden');
                    
                    console.log('Blackjack: Controls switched');
                    
                    // Check for blackjack
                    if (this.calculateScore(this.playerHand) === 21) {
                        setTimeout(() => this.checkWinner(), 500);
                    }
                    
                    console.log('Blackjack: Game started successfully');
                } catch (error) {
                    console.error('Blackjack error in startGame:', error);
                    this.showMessage('❌ Ошибка при запуске игры: ' + error.message, '#ef4444');
                    // Return bet
                    gameState.gold += this.currentBet;
                    game.save();
                    ui.updateStats();
                }
            },
            
            hit: function() {
                if (!this.gameInProgress || this.dealerRevealed) return;
                
                this.playerHand.push(this.deck.pop());
                this.updateDisplay();
                
                const playerScore = this.calculateScore(this.playerHand);
                
                if (playerScore > 21) {
                    this.showMessage('💥 Перебор! Вы проиграли.', '#ef4444');
                    this.endGame(false);
                } else if (playerScore === 21) {
                    this.stand();
                }
            },
            
            stand: function() {
                if (!this.gameInProgress || this.dealerRevealed) return;
                
                this.dealerRevealed = true;
                this.showMessage('🎴 Дилер открывает карты...', '#fbbf24');
                
                setTimeout(() => {
                    this.dealerPlay();
                }, 800);
            },
            
            dealerPlay: function() {
                let dealerScore = this.calculateScore(this.dealerHand);
                
                const dealStep = () => {
                    if (dealerScore < 17) {
                        this.dealerHand.push(this.deck.pop());
                        this.updateDisplay();
                        dealerScore = this.calculateScore(this.dealerHand);
                        
                        setTimeout(dealStep, 800);
                    } else {
                        setTimeout(() => this.checkWinner(), 500);
                    }
                };
                
                this.updateDisplay();
                setTimeout(dealStep, 800);
            },
            
            checkWinner: function() {
                const playerScore = this.calculateScore(this.playerHand);
                const dealerScore = this.calculateScore(this.dealerHand);
                
                this.dealerRevealed = true;
                this.updateDisplay();
                
                let message = '';
                let color = '';
                let winAmount = 0;
                
                if (playerScore > 21) {
                    message = `💥 Перебор! Вы проиграли ${this.currentBet} золота.`;
                    color = '#ef4444';
                } else if (dealerScore > 21) {
                    message = `🎉 У дилера перебор! Вы выиграли ${this.currentBet} золота!`;
                    color = '#34d399';
                    winAmount = this.currentBet * 2;
                } else if (playerScore > dealerScore) {
                    message = `🎉 Победа! Вы выиграли ${this.currentBet} золота!`;
                    color = '#34d399';
                    winAmount = this.currentBet * 2;
                } else if (playerScore < dealerScore) {
                    message = `😔 Поражение. Вы проиграли ${this.currentBet} золота.`;
                    color = '#ef4444';
                } else {
                    message = `🤝 Ничья! Ставка ${this.currentBet} золота возвращена.`;
                    color = '#fbbf24';
                    winAmount = this.currentBet;
                }
                
                // Add winnings
                if (winAmount > 0) {
                    gameState.gold += winAmount;
                    game.save();
                    ui.updateStats();
                }
                
                this.showMessage(message, color);
                this.endGame(winAmount > this.currentBet);
            },
            
            endGame: function(won) {
                this.gameInProgress = false;
                document.getElementById('btn-hit').disabled = true;
                document.getElementById('btn-stand').disabled = true;
                
                setTimeout(() => {
                    document.getElementById('btn-hit').disabled = false;
                    document.getElementById('btn-stand').disabled = false;
                }, 1000);
            },
            
            resetGame: function() {
                this.playerHand = [];
                this.dealerHand = [];
                this.gameInProgress = false;
                this.dealerRevealed = false;
                
                document.getElementById('player-cards').innerHTML = '<p class="text-gray-500 text-sm">Ожидание...</p>';
                document.getElementById('dealer-cards').innerHTML = '<p class="text-gray-500 text-sm">Ожидание...</p>';
                document.getElementById('player-score').textContent = '0';
                document.getElementById('dealer-score').textContent = '0';
                
                this.showMessage('💰 Сделайте ставку, чтобы начать игру', '#a78bfa');
                
                document.getElementById('bet-controls').classList.remove('hidden');
                document.getElementById('game-controls').classList.add('hidden');
            }
        };

        // --- TOURNAMENT BATTLE SYSTEM ---
        const tournamentBattle = {
            // Battle state
            player: null,
            opponent: null,
            currentRound: 1,
            maxRounds: 3,
            tournamentTier: 'beginner', // beginner, warrior, champion
            battleActive: false,
            playerTurn: true,
            
            // Opponent database with different tactics
            opponents: {
                beginner: [
                    {
                        name: 'Оруженосец Томас',
                        icon: 'fa-user',
                        hp: 80,
                        damage: 12,
                        armor: 5,
                        tactic: 'balanced',
                        personality: 'Молодой воин, все еще изучающий основы.',
                        aggression: 0.5
                    },
                    {
                        name: 'Фермер Уильям',
                        icon: 'fa-user-cowboy',
                        hp: 70,
                        damage: 15,
                        armor: 3,
                        tactic: 'aggressive',
                        personality: 'Сильный, но неопытный боец.',
                        aggression: 0.7
                    },
                    {
                        name: 'Стражник Роберт',
                        icon: 'fa-user-shield',
                        hp: 90,
                        damage: 10,
                        armor: 8,
                        tactic: 'defensive',
                        personality: 'Осторожный защитник.',
                        aggression: 0.3
                    }
                ],
                warrior: [
                    {
                        name: 'Рыцарь Бернард',
                        icon: 'fa-chess-knight',
                        hp: 120,
                        damage: 18,
                        armor: 12,
                        tactic: 'tactical',
                        personality: 'Опытный воин с продуманной стратегией.',
                        aggression: 0.5
                    },
                    {
                        name: 'Наемник Виктор',
                        icon: 'fa-user-ninja',
                        hp: 100,
                        damage: 22,
                        armor: 8,
                        tactic: 'aggressive',
                        personality: 'Безжалостный боец, атакующий без остановки.',
                        aggression: 0.8
                    },
                    {
                        name: 'Капитан Маркус',
                        icon: 'fa-shield-alt',
                        hp: 140,
                        damage: 15,
                        armor: 15,
                        tactic: 'counter_focused',
                        personality: 'Мастер контратак и парирования.',
                        aggression: 0.4
                    }
                ],
                champion: [
                    {
                        name: 'Чемпион Максимус',
                        icon: 'fa-crown',
                        hp: 150,
                        damage: 25,
                        armor: 18,
                        tactic: 'adaptive',
                        personality: 'Легендарный боец, адаптирующийся к вашему стилю.',
                        aggression: 0.6
                    },
                    {
                        name: 'Темный Рыцарь',
                        icon: 'fa-skull',
                        hp: 130,
                        damage: 30,
                        armor: 15,
                        tactic: 'berserker',
                        personality: 'Яростный воин, жертвующий защитой ради атаки.',
                        aggression: 0.9
                    },
                    {
                        name: 'Госпожа Изольда',
                        icon: 'fa-chess-queen',
                        hp: 140,
                        damage: 20,
                        armor: 20,
                        tactic: 'perfectionist',
                        personality: 'Совершенная техника боя и расчет.',
                        aggression: 0.5
                    }
                ]
            },
            
            // Start tournament
            startTournament: function(tier) {
                // Check requirements
                const requirements = {
                    beginner: { level: 5, gold: 0 },
                    warrior: { level: 10, gold: 0 },
                    champion: { level: 20, gold: 0 }
                };
                
                const req = requirements[tier];
                if (gameState.level < req.level) {
                    ui.showFloatText(document.body, `Требуется ${req.level} уровень!`, '#ef4444');
                    return;
                }
                
                this.tournamentTier = tier;
                this.currentRound = 1;
                this.maxRounds = 3;
                
                // Initialize player stats from game state
                this.player = {
                    name: gameState.playerName || 'Герой',
                    maxHp: gameState.maxHp || 100,
                    hp: gameState.hp || 100,
                    damage: this.calculatePlayerDamage(),
                    armor: this.calculatePlayerArmor(),
                    stamina: 3,
                    maxStamina: 3,
                    effects: [],
                    lastAction: null
                };
                
                this.selectOpponent();
                this.openBattleModal();
                this.startRound();
            },
            
            calculatePlayerDamage: function() {
                // Get damage directly from gameState (already calculated from equipment)
                return gameState.damage || 10;
            },
            
            calculatePlayerArmor: function() {
                // Get armor directly from gameState (already calculated from equipment)
                return gameState.armor || 0;
            },
            
            selectOpponent: function() {
                const pool = this.opponents[this.tournamentTier];
                const selected = pool[Math.floor(Math.random() * pool.length)];
                
                this.opponent = {
                    ...selected,
                    maxHp: selected.hp,
                    stamina: 3,
                    maxStamina: 3,
                    effects: [],
                    lastAction: null,
                    actionPattern: [] // For tracking AI behavior
                };
            },
            
            openBattleModal: function() {
                document.getElementById('modal-tournament-battle').classList.add('open');
                this.updateUI();
            },
            
            closeBattleModal: function() {
                document.getElementById('modal-tournament-battle').classList.remove('open');
                this.battleActive = false;
            },
            
            startRound: function() {
                this.battleActive = true;
                this.playerTurn = true;
                
                // Reset stamina for new round
                if (this.currentRound > 1) {
                    this.player.stamina = this.player.maxStamina;
                    this.opponent.stamina = this.opponent.maxStamina;
                }
                
                this.addLog(`⚔️ Раунд ${this.currentRound} начинается!`, 'amber');
                this.addLog(`💭 ${this.opponent.personality}`, 'gray');
                
                this.updateUI();
                this.enableActions();
            },
            
            // Player action handler
            playerAction: function(actionType) {
                if (!this.battleActive || !this.playerTurn) return;
                
                const actions = {
                    quick_strike: { name: 'Быструю атаку', stamina: 1 },
                    power_strike: { name: 'Мощную атаку', stamina: 2 },
                    defend: { name: 'Защиту', stamina: 1 },
                    counter: { name: 'Контратаку', stamina: 2 }
                };
                
                const action = actions[actionType];
                
                // Check stamina
                if (this.player.stamina < action.stamina) {
                    this.addLog('❌ Недостаточно выносливости!', 'red');
                    return;
                }
                
                this.player.stamina -= action.stamina;
                this.player.lastAction = actionType;
                this.playerTurn = false;
                this.disableActions();
                
                console.log('Player action:', actionType, 'Stamina left:', this.player.stamina);
                
                this.addLog(`🎯 Вы используете ${action.name}`, 'green');
                this.updateUI();
                
                // Now let opponent act (if they have stamina)
                setTimeout(() => {
                    if (this.opponent.stamina > 0) {
                        this.opponentAction();
                    } else {
                        this.addLog(`💤 У противника нет выносливости!`, 'amber');
                        this.opponent.lastAction = null;
                    }
                    
                    // Resolve combat after both have acted
                    setTimeout(() => {
                        this.resolveRound();
                    }, 600);
                }, 500);
            },
            
            // AI opponent decision
            opponentAction: function() {
                // Check if opponent has any stamina left
                if (this.opponent.stamina === 0) {
                    console.log('Opponent has no stamina, skipping action');
                    return;
                }
                
                console.log('Opponent taking action, stamina:', this.opponent.stamina);
                
                const tactic = this.opponent.tactic;
                let actionType;
                
                // AI decision based on tactic and game state
                const playerLastAction = this.player.lastAction;
                const opponentHpPercent = this.opponent.hp / this.opponent.maxHp;
                const playerHpPercent = this.player.hp / this.player.maxHp;
                
                if (tactic === 'aggressive') {
                    // Aggressive: Mostly attacks, rarely defends
                    if (opponentHpPercent < 0.3 && Math.random() < 0.3) {
                        actionType = 'defend';
                    } else if (this.opponent.stamina >= 2 && Math.random() < 0.7) {
                        actionType = 'power_strike';
                    } else {
                        actionType = 'quick_strike';
                    }
                } else if (tactic === 'defensive') {
                    // Defensive: Prioritizes blocking and counters
                    if (playerLastAction === 'power_strike' && this.opponent.stamina >= 2) {
                        actionType = 'counter';
                    } else if (Math.random() < 0.5) {
                        actionType = 'defend';
                    } else {
                        actionType = 'quick_strike';
                    }
                } else if (tactic === 'balanced') {
                    // Balanced: Mix of everything
                    const rand = Math.random();
                    if (rand < 0.35) {
                        actionType = 'quick_strike';
                    } else if (rand < 0.55 && this.opponent.stamina >= 2) {
                        actionType = 'power_strike';
                    } else if (rand < 0.75) {
                        actionType = 'defend';
                    } else if (this.opponent.stamina >= 2) {
                        actionType = 'counter';
                    } else {
                        actionType = 'quick_strike';
                    }
                } else if (tactic === 'counter_focused') {
                    // Counter-focused: Waits for player attacks
                    if (playerLastAction && playerLastAction !== 'defend' && this.opponent.stamina >= 2) {
                        actionType = Math.random() < 0.6 ? 'counter' : 'defend';
                    } else {
                        actionType = Math.random() < 0.5 ? 'defend' : 'quick_strike';
                    }
                } else if (tactic === 'tactical') {
                    // Tactical: Adapts to player's HP and stamina
                    if (playerHpPercent < 0.4 && this.opponent.stamina >= 2) {
                        actionType = 'power_strike'; // Finish them!
                    } else if (opponentHpPercent < 0.5) {
                        actionType = 'defend'; // Play safe
                    } else if (playerLastAction === 'power_strike') {
                        actionType = this.opponent.stamina >= 2 ? 'counter' : 'defend';
                    } else {
                        actionType = 'quick_strike';
                    }
                } else if (tactic === 'adaptive') {
                    // Adaptive: Learns from player patterns
                    const playerPattern = this.player.lastAction;
                    if (playerPattern === 'power_strike') {
                        actionType = this.opponent.stamina >= 2 ? 'counter' : 'defend';
                    } else if (playerPattern === 'quick_strike') {
                        actionType = Math.random() < 0.6 ? 'power_strike' : 'quick_strike';
                    } else if (playerPattern === 'defend') {
                        actionType = this.opponent.stamina >= 2 ? 'power_strike' : 'quick_strike';
                    } else {
                        actionType = 'balanced';
                    }
                } else if (tactic === 'berserker') {
                    // Berserker: Always attacks, never defends
                    actionType = this.opponent.stamina >= 2 && Math.random() < 0.8 ? 'power_strike' : 'quick_strike';
                } else if (tactic === 'perfectionist') {
                    // Perfectionist: Optimal play based on situation
                    if (playerHpPercent < 0.3 && this.opponent.stamina >= 2) {
                        actionType = 'power_strike';
                    } else if (opponentHpPercent < 0.3) {
                        actionType = 'defend';
                    } else if (playerLastAction === 'power_strike' && this.opponent.stamina >= 2) {
                        actionType = 'counter';
                    } else if (this.opponent.stamina === 1) {
                        actionType = 'quick_strike';
                    } else {
                        actionType = Math.random() < 0.5 ? 'power_strike' : 'defend';
                    }
                }
                
                // Ensure we have enough stamina
                const staminaCosts = { quick_strike: 1, power_strike: 2, defend: 1, counter: 2 };
                if (this.opponent.stamina < staminaCosts[actionType]) {
                    actionType = 'quick_strike'; // Fallback
                }
                
                this.opponent.stamina -= staminaCosts[actionType];
                this.opponent.lastAction = actionType;
                
                const actionNames = {
                    quick_strike: 'Быструю атаку',
                    power_strike: 'Мощную атаку',
                    defend: 'Защиту',
                    counter: 'Контратаку'
                };
                
                this.addLog(`🗡️ ${this.opponent.name} использует ${actionNames[actionType]}`, 'red');
            },
            
            // Resolve combat round
            resolveRound: function() {
                const pAction = this.player.lastAction;
                const oAction = this.opponent.lastAction;
                
                console.log('Resolving round - Player action:', pAction, 'Opponent action:', oAction);
                
                let playerDamageDealt = 0;
                let opponentDamageDealt = 0;
                
                // If opponent has no action (no stamina), player attacks freely
                if (!oAction && pAction && pAction !== 'defend' && pAction !== 'counter') {
                    if (pAction === 'quick_strike') {
                        playerDamageDealt = this.calculateDamage(this.player.damage, this.opponent.armor, 1.0);
                        this.addLog(`⚔️ Беспрепятственный удар!`, 'green');
                    } else if (pAction === 'power_strike') {
                        playerDamageDealt = this.calculateDamage(this.player.damage * 1.8, this.opponent.armor, 1.0);
                        this.addLog(`💥 Сокрушительный удар без защиты!`, 'green');
                    }
                }
                // If player has no action (no stamina), opponent attacks freely
                else if (!pAction && oAction && oAction !== 'defend' && oAction !== 'counter') {
                    if (oAction === 'quick_strike') {
                        opponentDamageDealt = this.calculateDamage(this.opponent.damage, this.player.armor, 1.0);
                    } else if (oAction === 'power_strike') {
                        opponentDamageDealt = this.calculateDamage(this.opponent.damage * 1.8, this.player.armor, 1.0);
                    }
                }
                // Both have actions - full combat resolution
                else if (pAction && oAction) {
                    // Player attack actions
                    if (pAction === 'quick_strike') {
                        if (oAction === 'defend') {
                            playerDamageDealt = this.calculateDamage(this.player.damage, this.opponent.armor, 0.3);
                            this.addLog(`⚔️ Ваш удар частично заблокирован щитом`, 'yellow');
                        } else if (oAction === 'counter') {
                            opponentDamageDealt = this.calculateDamage(this.opponent.damage * 2, this.player.armor, 1.0);
                            this.addLog(`💥 Противник парировал и нанес контрудар!`, 'red');
                        } else {
                            playerDamageDealt = this.calculateDamage(this.player.damage, this.opponent.armor, 1.0);
                            this.addLog(`⚔️ Ваш удар достиг цели!`, 'green');
                        }
                    } else if (pAction === 'power_strike') {
                        if (oAction === 'defend') {
                            playerDamageDealt = this.calculateDamage(this.player.damage * 1.8, this.opponent.armor, 0.5);
                            this.addLog(`💥 Мощный удар пробил защиту!`, 'green');
                        } else if (oAction === 'counter') {
                            opponentDamageDealt = this.calculateDamage(this.opponent.damage * 2.5, this.player.armor, 1.0);
                            this.addLog(`🎯 Противник идеально парировал мощный удар!`, 'red');
                        } else {
                            playerDamageDealt = this.calculateDamage(this.player.damage * 1.8, this.opponent.armor, 1.0);
                            this.addLog(`💥 Сокрушительный удар!`, 'green');
                        }
                    } else if (pAction === 'defend') {
                        if (this.player.stamina < this.player.maxStamina) {
                            this.player.stamina = Math.min(this.player.stamina + 1, this.player.maxStamina);
                            this.addLog(`💧 Вы восстановили 1 выносливость`, 'blue');
                        }
                    } else if (pAction === 'counter') {
                        if (oAction === 'quick_strike' || oAction === 'power_strike') {
                            const multiplier = oAction === 'power_strike' ? 2.5 : 2.0;
                            playerDamageDealt = this.calculateDamage(this.player.damage * multiplier, this.opponent.armor, 1.0);
                            this.addLog(`🎯 Идеальная контратака!`, 'green');
                        } else {
                            this.addLog(`❌ Контратака не сработала - противник не атаковал`, 'yellow');
                        }
                    }
                    
                    // Opponent attack actions (if not already handled)
                    if (oAction === 'quick_strike' && pAction !== 'counter') {
                        if (pAction === 'defend') {
                            opponentDamageDealt = this.calculateDamage(this.opponent.damage, this.player.armor, 0.2);
                            this.addLog(`🛡️ Вы заблокировали большую часть урона`, 'blue');
                        } else {
                            opponentDamageDealt = this.calculateDamage(this.opponent.damage, this.player.armor, 1.0);
                        }
                    } else if (oAction === 'power_strike' && pAction !== 'counter') {
                        if (pAction === 'defend') {
                            opponentDamageDealt = this.calculateDamage(this.opponent.damage * 1.8, this.player.armor, 0.4);
                            this.addLog(`🛡️ Защита ослабила мощный удар`, 'blue');
                        } else {
                            opponentDamageDealt = this.calculateDamage(this.opponent.damage * 1.8, this.player.armor, 1.0);
                        }
                    } else if (oAction === 'defend') {
                        if (this.opponent.stamina < this.opponent.maxStamina) {
                            this.opponent.stamina = Math.min(this.opponent.stamina + 1, this.opponent.maxStamina);
                        }
                    }
                }
                
                // Apply damage
                if (playerDamageDealt > 0) {
                    this.opponent.hp = Math.max(0, this.opponent.hp - playerDamageDealt);
                    this.addLog(`💔 ${this.opponent.name} получает ${playerDamageDealt} урона`, 'green');
                    this.animateDamage('opponent');
                }
                
                if (opponentDamageDealt > 0) {
                    this.player.hp = Math.max(0, this.player.hp - opponentDamageDealt);
                    this.addLog(`💔 Вы получаете ${opponentDamageDealt} урона`, 'red');
                    this.animateDamage('player');
                }
                
                this.updateUI();
                
                // Check for round end
                setTimeout(() => {
                    console.log('Checking round end - Player HP:', this.player.hp, 'Opponent HP:', this.opponent.hp);
                    console.log('Player stamina:', this.player.stamina, 'Opponent stamina:', this.opponent.stamina);
                    
                    if (this.player.hp <= 0 || this.opponent.hp <= 0) {
                        console.log('Round ending due to HP');
                        this.endRound();
                    } else if (this.player.stamina === 0 && this.opponent.stamina === 0) {
                        console.log('Round ending due to stamina depletion');
                        this.addLog(`💤 Выносливость исчерпана у обоих!`, 'amber');
                        setTimeout(() => this.endRound(), 800);
                    } else {
                        console.log('Round continues, player turn');
                        this.playerTurn = true;
                        this.enableActions();
                    }
                }, 1000);
            },
            
            calculateDamage: function(baseDamage, armor, multiplier) {
                const armorReduction = armor * 0.5;
                const finalDamage = Math.max(1, Math.round((baseDamage - armorReduction) * multiplier));
                return finalDamage;
            },
            
            endRound: function() {
                if (this.player.hp <= 0) {
                    this.addLog(`💀 Вы проиграли раунд ${this.currentRound}!`, 'red');
                    this.endTournament(false);
                } else if (this.opponent.hp <= 0) {
                    this.addLog(`🏆 Вы выиграли раунд ${this.currentRound}!`, 'green');
                    
                    if (this.currentRound >= this.maxRounds) {
                        this.endTournament(true);
                    } else {
                        this.currentRound++;
                        
                        // Heal player between rounds
                        this.player.hp = this.player.maxHp;
                        this.player.stamina = this.player.maxStamina;
                        this.addLog(`💚 Ваше здоровье восстановлено!`, 'green');
                        
                        setTimeout(() => {
                            this.selectOpponent();
                            this.startRound();
                        }, 2500);
                    }
                } else {
                    // Draw by stamina depletion - judge by HP
                    if (this.player.hp > this.opponent.hp) {
                        this.addLog(`🏆 Победа по очкам здоровья!`, 'green');
                        
                        if (this.currentRound >= this.maxRounds) {
                            this.endTournament(true);
                        } else {
                            this.currentRound++;
                            
                            // Heal player between rounds
                            this.player.hp = this.player.maxHp;
                            this.player.stamina = this.player.maxStamina;
                            this.addLog(`💚 Ваше здоровье восстановлено!`, 'green');
                            
                            setTimeout(() => {
                                this.selectOpponent();
                                this.startRound();
                            }, 2500);
                        }
                    } else {
                        this.addLog(`💀 Поражение по очкам здоровья!`, 'red');
                        this.endTournament(false);
                    }
                }
            },
            
            endTournament: function(victory) {
                this.battleActive = false;
                this.disableActions();
                
                const rewards = {
                    beginner: { gold: 500, xp: 50 },
                    warrior: { gold: 1500, xp: 150 },
                    champion: { gold: 5000, xp: 500 }
                };
                
                if (victory) {
                    const reward = rewards[this.tournamentTier];
                    gameState.gold += reward.gold;
                    gameState.xp += reward.xp;
                    game.save();
                    ui.updateStats();
                    
                    this.addLog(``, 'amber');
                    this.addLog(`🎉 ПОБЕДА В ТУРНИРЕ!`, 'green');
                    this.addLog(`💰 Получено: ${reward.gold} золота`, 'yellow');
                    this.addLog(`⭐ Получено: ${reward.xp} опыта`, 'yellow');
                    
                    // Track tournament wins
                    if (!gameState.tournamentWins) gameState.tournamentWins = { beginner: 0, warrior: 0, champion: 0 };
                    gameState.tournamentWins[this.tournamentTier]++;
                    game.save();
                    
                    setTimeout(() => {
                        this.closeBattleModal();
                        game.levelCheck();
                    }, 4000);
                } else {
                    this.addLog(``, 'amber');
                    this.addLog(`💀 ПОРАЖЕНИЕ...`, 'red');
                    this.addLog(`Тренируйтесь и возвращайтесь!`, 'gray');
                    
                    setTimeout(() => {
                        this.closeBattleModal();
                    }, 3000);
                }
            },
            
            forfeit: function() {
                if (!confirm('Вы уверены, что хотите сдаться? Прогресс не будет сохранен.')) {
                    return;
                }
                
                this.addLog(`🏳️ Вы сдались...`, 'gray');
                this.battleActive = false;
                
                setTimeout(() => {
                    this.closeBattleModal();
                }, 1500);
            },
            
            updateUI: function() {
                document.getElementById('battle-title').textContent = `Турнир ${this.tournamentTier === 'beginner' ? 'Новичков' : this.tournamentTier === 'warrior' ? 'Воинов' : 'Чемпионов'}`;
                document.getElementById('battle-subtitle').textContent = `Раунд ${this.currentRound} из ${this.maxRounds}`;
                
                document.getElementById('opponent-name').textContent = this.opponent.name;
                document.getElementById('opponent-tactic').textContent = `Тактика: ${this.getTacticName(this.opponent.tactic)}`;
                document.getElementById('opponent-icon').className = `fas ${this.opponent.icon} text-red-400 text-xl`;
                
                const oppHpPercent = (this.opponent.hp / this.opponent.maxHp) * 100;
                document.getElementById('opponent-hp-bar').style.width = oppHpPercent + '%';
                document.getElementById('opponent-hp-text').textContent = `${this.opponent.hp}/${this.opponent.maxHp}`;
                document.getElementById('opponent-damage').textContent = this.opponent.damage;
                document.getElementById('opponent-armor').textContent = this.opponent.armor;
                
                document.getElementById('player-battle-name').textContent = this.player.name;
                
                const playerHpPercent = (this.player.hp / this.player.maxHp) * 100;
                document.getElementById('player-hp-bar').style.width = playerHpPercent + '%';
                document.getElementById('player-hp-text').textContent = `${this.player.hp}/${this.player.maxHp}`;
                document.getElementById('player-damage').textContent = this.player.damage;
                document.getElementById('player-armor').textContent = this.player.armor;
                
                this.updateStaminaIndicator('player', this.player.stamina);
                this.updateStaminaIndicator('opponent', this.opponent.stamina);
            },
            
            updateStaminaIndicator: function(who, stamina) {
                const container = document.getElementById(`${who}-stamina-indicator`);
                container.innerHTML = '';
                
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'stamina-dot' + (i < stamina ? ' active' : '');
                    container.appendChild(dot);
                }
            },
            
            getTacticName: function(tactic) {
                const names = {
                    aggressive: 'Агрессивная',
                    defensive: 'Оборонительная',
                    balanced: 'Сбалансированная',
                    counter_focused: 'Контратакующая',
                    tactical: 'Тактическая',
                    adaptive: 'Адаптивная',
                    berserker: 'Берсерк',
                    perfectionist: 'Перфекционист'
                };
                return names[tactic] || tactic;
            },
            
            enableActions: function() {
                document.querySelectorAll('.battle-action-btn').forEach(btn => {
                    const stamina = parseInt(btn.getAttribute('data-stamina'));
                    btn.disabled = stamina > this.player.stamina;
                });
            },
            
            disableActions: function() {
                document.querySelectorAll('.battle-action-btn').forEach(btn => {
                    btn.disabled = true;
                });
            },
            
            addLog: function(message, color = 'white') {
                const log = document.getElementById('battle-log');
                const entry = document.createElement('p');
                
                const colors = {
                    green: '#86efac',
                    red: '#fca5a5',
                    blue: '#93c5fd',
                    yellow: '#fde047',
                    amber: '#fbbf24',
                    gray: '#9ca3af',
                    white: '#e5e7eb'
                };
                
                entry.className = 'text-xs';
                entry.style.color = colors[color] || color;
                entry.textContent = message;
                
                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;
            },
            
            animateDamage: function(target) {
                const element = document.querySelector(`#${target}-hp-bar`).parentElement.parentElement;
                element.classList.add('damage-shake');
                setTimeout(() => element.classList.remove('damage-shake'), 300);
            }
        };

        // --- QUESTS CONTROLLER ---
        const quests = {
            currentTab: 'daily',
            timerInterval: null,

            init: function() {
                this.checkDailyQuests();
                this.startTimer();
            },

            switchTab: function(tab) {
                this.currentTab = tab;
                document.querySelectorAll('#view-quests .sub-tab').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-quests-${tab}`).classList.add('active');
                this.render();
            },

            getMskDayKey: function(ts) {
                return Math.floor((ts + 3 * 60 * 60 * 1000) / 86400000);
            },

            getNextResetTs: function(nowTs = Date.now()) {
                const next = new Date(nowTs);
                next.setUTCHours(21, 0, 0, 0);
                if (nowTs >= next.getTime()) {
                    next.setUTCDate(next.getUTCDate() + 1);
                }
                return next.getTime();
            },

            checkDailyQuests: function() {
                const nowTs = Date.now();
                const lastTs = gameState.lastQuestGenTime || 0;

                const needRefresh =
                    !gameState.activeQuests ||
                    gameState.activeQuests.length === 0 ||
                    this.getMskDayKey(nowTs) !== this.getMskDayKey(lastTs);

                if (needRefresh) {
                    this.generateDailyQuests();
                    return true;
                }
                return false;
            },

            generateDailyQuests: function() {
                const newQuests = [];
                const tiers = [
                    { pool: this.questPool.easy,   reward: 2, xp: 50  },
                    { pool: this.questPool.medium, reward: 5, xp: 100 },
                    { pool: this.questPool.hard,   reward: 8, xp: 200 }
                ];
                const usedKeys = [];
                tiers.forEach((tier, i) => {
                    let attempts = 0;
                    let picked = null;
                    while (attempts < 50) {
                        const candidate = tier.pool[Math.floor(Math.random() * tier.pool.length)];
                        const key = candidate.type + '_' + candidate.target;
                        if (!usedKeys.includes(key)) {
                            picked = candidate;
                            usedKeys.push(key);
                            break;
                        }
                        attempts++;
                    }
                    if (!picked) picked = tier.pool[Math.floor(Math.random() * tier.pool.length)];
                    const goal = picked.goalRange[0] + Math.floor(Math.random() * (picked.goalRange[1] - picked.goalRange[0] + 1));
                    newQuests.push({
                        id: Date.now() + i,
                        text: picked.textFn(goal),
                        type: picked.type,
                        target: picked.target,
                        goal: goal,
                        current: 0,
                        reward: tier.reward,
                        xp: tier.xp,
                        claimed: false
                    });
                });
                gameState.activeQuests = newQuests;
                gameState.lastQuestGenTime = Date.now();
                game.save();
            },

            questPool: {
                easy: [
                    // Gather quests (basic resources)
                    { type:'gather', target:'fish',      goalRange:[3,6],   textFn: g => `Поймать ${g} рыбы` },
                    { type:'gather', target:'wood',      goalRange:[4,7],   textFn: g => `Собрать ${g} палок` },
                    { type:'gather', target:'stone',     goalRange:[3,6],   textFn: g => `Собрать ${g} камней` },
                    { type:'gather', target:'herbs',     goalRange:[3,5],   textFn: g => `Сорвать ${g} трав` },
                    { type:'gather', target:'mushrooms', goalRange:[2,4],   textFn: g => `Найти ${g} гриба` },
                    { type:'gather', target:'wheat',     goalRange:[3,5],   textFn: g => `Собрать ${g} пшеницы` },
                    
                    // Sell quests (basic)
                    { type:'sell',   target:'fish',      goalRange:[3,6],   textFn: g => `Продать ${g} рыбы` },
                    { type:'sell',   target:'wood',      goalRange:[3,5],   textFn: g => `Продать ${g} палок` },
                    { type:'sell',   target:'herbs',     goalRange:[2,4],   textFn: g => `Продать ${g} трав` },
                    { type:'sell',   target:'stone',     goalRange:[3,5],   textFn: g => `Продать ${g} камней` },
                    { type:'sell',   target:'mushrooms', goalRange:[2,3],   textFn: g => `Продать ${g} гриба торговцу` },
                    { type:'sell',   target:'wheat',     goalRange:[2,4],   textFn: g => `Продать ${g} пшеницы на рынке` },
                    
                    // Work quests (basic jobs)
                    { type:'work',   target:'port',      goalRange:[3,5],   textFn: g => `Заработать в порту ${g} раз` },
                    { type:'work',   target:'field',     goalRange:[2,4],   textFn: g => `Поработать на поле ${g} раза` },
                    { type:'work',   target:'port',      goalRange:[4,6],   textFn: g => `Порыбачить в порту ${g} раз` },
                    { type:'work',   target:'loader',    goalRange:[2,3],   textFn: g => `Разгрузить ${g} повозки` },
                    
                    // Mixed simple goals
                    { type:'gather', target:'fish',      goalRange:[4,7],   textFn: g => `Наловить ${g} рыбы для таверны` },
                    { type:'gather', target:'herbs',     goalRange:[3,6],   textFn: g => `Собрать ${g} лечебных трав` },
                    { type:'sell',   target:'fish',      goalRange:[4,6],   textFn: g => `Сбыть ${g} рыбы на площади` },
                    { type:'work',   target:'field',     goalRange:[3,5],   textFn: g => `Помочь с урожаем ${g} раз` },
                    // More easy gathering
                    { type:'gather', target:'wood',      goalRange:[3,6],   textFn: g => `Нарубить ${g} дров` },
                    { type:'gather', target:'stone',     goalRange:[4,6],   textFn: g => `Накопать ${g} булыжников` },
                    { type:'gather', target:'mushrooms', goalRange:[3,5],   textFn: g => `Набрать ${g} лесных грибов` },
                    { type:'sell',   target:'fish',      goalRange:[4,7],   textFn: g => `Реализовать ${g} рыб` },
                    { type:'sell',   target:'wood',      goalRange:[4,6],   textFn: g => `Сбыть ${g} вязанок дров` },
                    { type:'work',   target:'port',      goalRange:[4,6],   textFn: g => `Помочь рыбакам ${g} раз` },
                    { type:'work',   target:'field',     goalRange:[3,5],   textFn: g => `Заработать на жатве ${g} смен` },

                ],
                medium: [
                    // Gather quests (moderate amounts)
                    { type:'gather', target:'fish',      goalRange:[8,14],  textFn: g => `Поймать ${g} рыбы` },
                    { type:'gather', target:'wood',      goalRange:[10,16], textFn: g => `Собрать ${g} палок` },
                    { type:'gather', target:'stone',     goalRange:[8,14],  textFn: g => `Добыть ${g} камней` },
                    { type:'gather', target:'herbs',     goalRange:[6,10],  textFn: g => `Собрать ${g} трав` },
                    { type:'gather', target:'mushrooms', goalRange:[5,8],   textFn: g => `Найти ${g} грибов` },
                    { type:'gather', target:'wheat',     goalRange:[8,14],  textFn: g => `Собрать ${g} пшеницы` },
                    { type:'gather', target:'ore',       goalRange:[3,5],   textFn: g => `Добыть ${g} руды` },
                    
                    // Sell quests (moderate)
                    { type:'sell',   target:'fish',      goalRange:[8,14],  textFn: g => `Продать ${g} рыбы на рынке` },
                    { type:'sell',   target:'wheat',     goalRange:[6,12],  textFn: g => `Продать ${g} пшеницы` },
                    { type:'sell',   target:'wood',      goalRange:[8,12],  textFn: g => `Продать ${g} палок` },
                    { type:'sell',   target:'herbs',     goalRange:[5,9],   textFn: g => `Продать ${g} трав лекарю` },
                    { type:'sell',   target:'stone',     goalRange:[6,10],  textFn: g => `Продать ${g} камней` },
                    { type:'sell',   target:'mushrooms', goalRange:[4,7],   textFn: g => `Продать ${g} грибов` },
                    { type:'sell',   target:'ore',       goalRange:[2,4],   textFn: g => `Продать ${g} руды кузнецу` },
                    
                    // Work quests (moderate jobs)
                    { type:'work',   target:'port',      goalRange:[8,14],  textFn: g => `Работать в порту ${g} раз` },
                    { type:'work',   target:'field',     goalRange:[6,10],  textFn: g => `Работать на поле ${g} раз` },
                    { type:'work',   target:'mine',      goalRange:[4,7],   textFn: g => `Работать в руднике ${g} раз` },
                    { type:'work',   target:'loader',    goalRange:[5,8],   textFn: g => `Разгрузить ${g} партий товара` },
                    { type:'work',   target:'port',      goalRange:[9,13],  textFn: g => `Порыбачить ${g} раз` },
                    { type:'work',   target:'mine',      goalRange:[5,8],   textFn: g => `Добыть руду ${g} раз` },
                    
                    // Upgrade quests
                    { type:'upgrade', target:'rod',      goalRange:[1,1],   textFn: g => `Улучшить удочку` },
                    { type:'upgrade', target:'sickle',   goalRange:[1,1],   textFn: g => `Улучшить серп` },
                    { type:'upgrade', target:'pickaxe',  goalRange:[1,1],   textFn: g => `Улучшить кирку` },
                    
                    // Mixed medium goals
                    { type:'gather', target:'fish',      goalRange:[10,15], textFn: g => `Наловить ${g} свежей рыбы` },
                    { type:'gather', target:'wheat',     goalRange:[9,13],  textFn: g => `Заготовить ${g} пшеницы для мельника` },
                    { type:'sell',   target:'fish',      goalRange:[10,14], textFn: g => `Поставить ${g} рыбы в таверну` },
                    { type:'work',   target:'field',     goalRange:[7,11],  textFn: g => `Убрать урожай ${g} раз` },
                    { type:'gather', target:'stone',     goalRange:[9,13],  textFn: g => `Добыть ${g} камней для стройки` },
                    // More medium gathering  
                    { type:'gather', target:'fish',      goalRange:[10,15], textFn: g => `Выловить ${g} хорошей рыбы` },
                    { type:'gather', target:'stone',     goalRange:[9,15],  textFn: g => `Накопать ${g} крепких камней` },
                    { type:'sell',   target:'fish',      goalRange:[9,15],  textFn: g => `Сбыть улов (${g} рыб)` },
                    { type:'work',   target:'port',      goalRange:[9,15],  textFn: g => `Отработать у причала ${g} смен` },

                ],
                hard: [
                    // Gather quests (large amounts)
                    { type:'gather', target:'fish',      goalRange:[18,28], textFn: g => `Поймать ${g} рыбы` },
                    { type:'gather', target:'wood',      goalRange:[20,30], textFn: g => `Собрать ${g} палок` },
                    { type:'gather', target:'stone',     goalRange:[16,24], textFn: g => `Добыть ${g} камней` },
                    { type:'gather', target:'herbs',     goalRange:[12,18], textFn: g => `Собрать ${g} трав` },
                    { type:'gather', target:'mushrooms', goalRange:[8,14],  textFn: g => `Найти ${g} грибов` },
                    { type:'gather', target:'wheat',     goalRange:[16,24], textFn: g => `Собрать ${g} пшеницы` },
                    { type:'gather', target:'ore',       goalRange:[6,10],  textFn: g => `Добыть ${g} руды` },
                    { type:'gather', target:'leather',   goalRange:[3,5],   textFn: g => `Добыть ${g} кожи` },
                    
                    // Sell quests (large amounts)
                    { type:'sell',   target:'fish',      goalRange:[18,28], textFn: g => `Продать ${g} рыбы` },
                    { type:'sell',   target:'wheat',     goalRange:[16,24], textFn: g => `Продать ${g} пшеницы` },
                    { type:'sell',   target:'ore',       goalRange:[6,10],  textFn: g => `Продать ${g} руды` },
                    { type:'sell',   target:'leather',   goalRange:[3,5],   textFn: g => `Продать ${g} кожи` },
                    { type:'sell',   target:'wood',      goalRange:[16,24], textFn: g => `Продать ${g} палок` },
                    { type:'sell',   target:'stone',     goalRange:[14,20], textFn: g => `Продать ${g} камней` },
                    { type:'sell',   target:'herbs',     goalRange:[10,16], textFn: g => `Продать ${g} трав` },
                    { type:'sell',   target:'mushrooms', goalRange:[6,10],  textFn: g => `Продать ${g} грибов` },
                    
                    // Work quests (demanding jobs)
                    { type:'work',   target:'port',      goalRange:[16,24], textFn: g => `Работать в порту ${g} раз` },
                    { type:'work',   target:'field',     goalRange:[12,18], textFn: g => `Работать на поле ${g} раз` },
                    { type:'work',   target:'mine',      goalRange:[8,14],  textFn: g => `Работать в руднике ${g} раз` },

                    { type:'work',   target:'loader',    goalRange:[10,15], textFn: g => `Разгрузить ${g} партий` },
                    { type:'work',   target:'port',      goalRange:[17,25], textFn: g => `Порыбачить ${g} раз` },
                    { type:'work',   target:'mine',      goalRange:[9,15],  textFn: g => `Добыть руду ${g} раз` },

                    
                    // Upgrade quests
                    { type:'upgrade', target:'rod',      goalRange:[1,1],   textFn: g => `Улучшить удочку` },
                    { type:'upgrade', target:'sickle',   goalRange:[1,1],   textFn: g => `Улучшить серп` },
                    { type:'upgrade', target:'pickaxe',  goalRange:[1,1],   textFn: g => `Улучшить кирку` },
                    { type:'upgrade', target:'crossbow', goalRange:[1,1],   textFn: g => `Улучшить арбалет` },
                    
                    // Mixed hard goals
                    { type:'gather', target:'fish',      goalRange:[20,30], textFn: g => `Выловить ${g} крупной рыбы` },
                    { type:'gather', target:'wheat',     goalRange:[18,26], textFn: g => `Заготовить ${g} пшеницы на зиму` },
                    { type:'gather', target:'ore',       goalRange:[7,12],  textFn: g => `Раздобыть ${g} ценной руды` },
                    { type:'gather', target:'leather',   goalRange:[4,6],   textFn: g => `Добыть ${g} качественной кожи` },
                    { type:'sell',   target:'fish',      goalRange:[20,28], textFn: g => `Поставить ${g} рыбы на рынок` },
                    { type:'sell',   target:'wheat',     goalRange:[18,25], textFn: g => `Сбыть ${g} пшеницы торговцам` },
                    { type:'sell',   target:'ore',       goalRange:[7,11],  textFn: g => `Продать ${g} руды в кузницу` },
                    { type:'sell',   target:'wood',      goalRange:[18,26], textFn: g => `Продать ${g} дров на площади` },
                    { type:'work',   target:'field',     goalRange:[14,20], textFn: g => `Убрать весь урожай ${g} раз` },
                    { type:'work',   target:'mine',      goalRange:[10,16], textFn: g => `Отработать в шахте ${g} смен` },

                    // More hard challenges
                    { type:'gather', target:'fish',      goalRange:[20,32], textFn: g => `Наловить сеть (${g} рыб)` },
                    { type:'gather', target:'wood',      goalRange:[22,35], textFn: g => `Заготовить штабель (${g} дров)` },
                    { type:'sell',   target:'fish',      goalRange:[20,32], textFn: g => `Реализовать улов (${g} рыб)` },
                    { type:'work',   target:'port',      goalRange:[18,28], textFn: g => `Отработать рыбаком ${g} смен` },
                    { type:'upgrade', target:'sword',    goalRange:[1,1],   textFn: g => `Заточить клинок меча` },

                ],
            },

            onEvent: function(eventType, target, amount) {
                let updated = false;
                // Daily Quests
                (gameState.activeQuests || []).forEach(q => {
                    if (!q.claimed && q.type === eventType && q.target === target) {
                        q.current += amount;
                        if (q.current > q.goal) q.current = q.goal;
                        updated = true;
                    }
                });
                // Story Quests
                // Mapping actions to quest types.
                // Gathering/Selling logic in this game acts as 'acquire' for quest purposes usually
                // For this implementation, we map 'sell' events (which happen when you have resources)
                // OR 'work' events (getting resources) to quest progress.
                // Let's assume gathering/working adds to the counter.
                
                // For simplicity in this codebase structure: 
                // We'll update quests when you GAIN resources (via work/gather) or SELL resources.
                // The prompt implies 'Bring 3 fish' -> usually implies having them or collecting them.
                // Let's count "Gathered/Acquired" resources.
                
                if (eventType === 'work' || eventType === 'gather' || eventType === 'sell' || eventType === 'visit') {
                     (gameState.storyQuests || []).forEach(q => {
                        if (q.state === 'active' && q.goals.target === target) {
                            q.current += amount;
                            // Cap at goal for UI niceness, but keep logic open
                            if (q.current > q.goals.count) q.current = q.goals.count;
                            updated = true;
                        }
                    });
                }

                if (updated) {
                    game.save();
                    if (router.currentTab === 'quests') this.render();
                }
            },

            claim: function(id) {
                const q = (gameState.activeQuests || []).find(q => q.id === id);
                if (q && !q.claimed && q.current >= q.goal) {
                    q.claimed = true;
                    gameState.emeralds += q.reward;
                    if (q.xp) game.addXp(q.xp);
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(event.target, `+${q.reward} <i class="far fa-gem" style="color:#34d399"></i>  +${q.xp || 0} XP`, "#34d399");
                    this.render();
                }
            },

            claimStory: function(id, force = false) {
                const q = (gameState.storyQuests || []).find(q => q.id === id);
                if (q && q.state === 'active' && (force || q.current >= q.goals.count)) {
                    q.state = 'claimed';
                    // Force complete implies progress met just now
                    if (force) q.current = q.goals.count;

                    // Story flags
                    if (!gameState.npcStates) gameState.npcStates = {};
                    if (id === 'q_john_1') {
                        gameState.npcStates.campTrained = true; // training completed
                    }

                    gameState.gold += q.reward.gold;
                    game.addXp(q.reward.xp);
                    game.save();
                    ui.updateStats();
                    // If triggered from dialogue, event.target might not be valid or needed
                    const target = (typeof event !== 'undefined' && event && event.target) ? event.target : document.body;
                    ui.showFloatText(target, `+${q.reward.gold} Gold +${q.reward.xp} XP`, "#fbbf24");
                    game.addReputation(2, target);
                    this.render();
                }
            },

            startTimer: function() {
                if (this.timerInterval) return;

                this.timerInterval = setInterval(() => {
                    const refreshed = this.checkDailyQuests();

                    if (router.currentTab === 'quests' && this.currentTab === 'daily') {
                        if (refreshed) this.render();
                        else this.updateTimerDisplay();
                    }
                }, 1000);
            },

            updateTimerDisplay: function() {
                const el = document.getElementById('quest-timer');
                if (!el) return;

                const nowTs = Date.now();
                const nextTs = this.getNextResetTs(nowTs);
                let diff = Math.max(0, nextTs - nowTs);

                const h = Math.floor(diff / 3600000);
                diff %= 3600000;
                const m = Math.floor(diff / 60000);
                diff %= 60000;
                const s = Math.floor(diff / 1000);

                el.innerText = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            },

            render: function() {
                const list = document.getElementById('quests-list');
                list.innerHTML = '';

                if (this.currentTab === 'daily') {
                    if (!gameState.activeQuests || gameState.activeQuests.length === 0) {
                        list.innerHTML = '<div class="text-center text-[#a0a0a0] py-4">Нет активных заданий</div>';
                        return;
                    }

                    gameState.activeQuests.forEach(q => {
                        const progress = Math.min(100, (q.current / q.goal) * 100);
                        const isDone = q.current >= q.goal;

                        const el = document.createElement('div');
                        el.className = `quest-card panel p-3 rounded flex flex-col gap-2 ${q.claimed ? 'opacity-50' : ''}`;
                        el.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-base text-[#e0e0e0] font-bold medieval-font">${q.text}</div>
                                    <div class="text-xs text-[#a0a0a0]">${q.current} / ${q.goal}</div>
                                </div>
                                <div class="flex flex-col items-end gap-0.5">
                                    <div class="text-[10px] gem-price font-bold border border-emerald-900 bg-emerald-900/20 px-2 py-0.5 rounded">
                                        +${q.reward} <i class="far fa-gem gem-price"></i>
                                    </div>
                                    <div class="text-[9px] text-blue-400 font-bold">+${q.xp || 0} XP</div>
                                </div>
                            </div>
                            <div class="w-full h-1.5 bg-[#000] rounded-full overflow-hidden border border-[#333]">
                                <div class="h-full bg-[#c8aa6e] transition-all duration-300" style="width: ${progress}%"></div>
                            </div>
                            ${isDone && !q.claimed ?
                                `<button onclick="quests.claim(${q.id})" class="btn-medieval w-full py-1 text-xs rounded mt-1">Забрать награду</button>` :
                                ''}
                            ${q.claimed ? '<div class="text-center text-[10px] text-green-500 uppercase">Выполнено</div>' : ''}
                        `;
                        list.appendChild(el);
                    });

                    // Разделитель между ежедневными заданиями и заданием на подписку
                    const dividerWrap = document.createElement('div');
                    dividerWrap.className = "text-center text-[11px] text-[#555] mt-4 mb-3 flex items-center gap-2";
                    dividerWrap.innerHTML = `
                        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-[#555] to-transparent"></div>
                        <span class="text-[10px] uppercase tracking-wider">Особое задание</span>
                        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-[#555] to-transparent"></div>
                    `;
                    list.appendChild(dividerWrap);

                    // Задание на подписку на канал
                    if (!gameState.channelTaskCompleted) {
                        const channelTaskEl = document.createElement('div');
                        channelTaskEl.id = 'task-channel-sub';
                        channelTaskEl.className = 'quest-card panel p-3 rounded flex flex-col gap-2 border-l-2 border-blue-500';
                        channelTaskEl.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-base text-[#e0e0e0] font-bold medieval-font flex items-center gap-2">
                                        <i class="fab fa-telegram text-blue-400"></i>
                                        Подпишитесь на канал игры
                                    </div>
                                    <div class="text-xs text-[#a0a0a0] mt-1">Узнавайте новости первыми!</div>
                                </div>
                                <div class="flex flex-col items-end gap-0.5">
                                    <div class="text-[10px] gem-price font-bold border border-emerald-900 bg-emerald-900/20 px-2 py-0.5 rounded">
                                        +10 <i class="far fa-gem gem-price"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button onclick="channelTask.openChannel()" class="btn-medieval flex-1 py-2 text-xs rounded">
                                    <i class="fab fa-telegram mr-1"></i> Подписаться
                                </button>
                                <button id="btn-check-channel" onclick="channelTask.checkSubscription()" 
                                    class="btn-medieval flex-1 py-2 text-xs rounded">
                                    <i class="fas fa-check-circle mr-1"></i> Проверить подписку
                                </button>
                            </div>
                        `;
                        list.appendChild(channelTaskEl);
                    } else {
                        // Показываем выполненное задание
                        const channelTaskEl = document.createElement('div');
                        channelTaskEl.className = 'quest-card panel p-3 rounded flex flex-col gap-2 opacity-50 border-l-2 border-green-500';
                        channelTaskEl.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-base text-[#e0e0e0] font-bold medieval-font flex items-center gap-2">
                                        <i class="fab fa-telegram text-blue-400"></i>
                                        Подпишитесь на канал игры
                                    </div>
                                    <div class="text-xs text-[#a0a0a0] mt-1">Узнавайте новости первыми!</div>
                                </div>
                                <div class="flex flex-col items-end gap-0.5">
                                    <div class="text-[10px] gem-price font-bold border border-emerald-900 bg-emerald-900/20 px-2 py-0.5 rounded">
                                        +10 <i class="far fa-gem gem-price"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center text-[10px] text-green-500 uppercase mt-2">
                                <i class="fas fa-check-circle mr-1"></i> Выполнено
                            </div>
                        `;
                        list.appendChild(channelTaskEl);
                    }

                    // Countdown to next reset (00:00 MSK)
                    const timerWrap = document.createElement('div');
                    timerWrap.className = "text-center text-[11px] text-[#777] mt-4";
                    timerWrap.innerHTML = `До обновления (00:00 МСК): <span id="quest-timer" class="text-[#c8aa6e] font-mono">--:--:--</span>`;
                    list.appendChild(timerWrap);
                    this.updateTimerDisplay();

                } else {
                    if (!gameState.storyQuests || gameState.storyQuests.length === 0) {
                        list.innerHTML = `
                            <div class="panel p-4 rounded text-center opacity-70">
                                <i class="fas fa-user-secret text-4xl text-[#555] mb-2"></i>
                                <p class="text-sm text-[#a0a0a0]">Персонажи молчат...</p>
                                <p class="text-xs text-[#555]">Поговорите с жителями (Артур, Горн, Бен), чтобы получить задания.</p>
                            </div>
                        `;
                        return;
                    }

                    gameState.storyQuests.forEach(q => {
                        if (q.state === 'claimed') return; // Hide completed/claimed logic for now or move to separate list

                        const progress = Math.min(100, (q.current / q.goals.count) * 100);
                        const isDone = q.current >= q.goals.count;

                        const el = document.createElement('div');
                        el.className = "quest-card panel p-3 rounded flex flex-col gap-2 border-l-2 border-[#c8aa6e]";
                        el.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-sm text-[#c8aa6e] font-bold">${q.title}</div>
                                    <div class="text-[10px] text-[#a0a0a0] mb-1">${q.desc}</div>
                                    <div class="text-xs text-[#e0e0e0]">${q.current} / ${q.goals.count}</div>
                                </div>
                                <div class="text-right">
                                     <div class="text-[10px] text-yellow-500 font-bold">+${q.reward.gold} <i class="fas fa-coins"></i></div>
                                     <div class="text-[10px] text-blue-400 font-bold">+${q.reward.xp} XP</div>
                                </div>
                            </div>
                            <div class="w-full h-1.5 bg-[#000] rounded-full overflow-hidden border border-[#333]">
                                <div class="h-full bg-[#c8aa6e] transition-all duration-300" style="width: ${progress}%"></div>
                            </div>
                            ${isDone ?
                                `<button onclick="quests.claimStory('${q.id}')" class="btn-medieval w-full py-1 text-xs rounded mt-1">Завершить</button>` :
                                ''}
                        `;
                        list.appendChild(el);
                    });
                }
            }
,
            
            // Firebase Admin Functions
            allPlayersData: [],
            filteredPlayers: [],
            currentPage: 1,
            playersPerPage: 10,
            
            loadFirebasePlayers: function() {
                if (typeof db === 'undefined') {
                    document.getElementById('players-list').innerHTML = '<div class="text-center text-red-400 text-xs py-4">Firebase не подключен</div>';
                    return;
                }
                
                document.getElementById('players-list').innerHTML = '<div class="text-center text-xs text-gray-500 py-4">Загрузка игроков...</div>';
                
                db.collection('players').get()
                    .then(snapshot => {
                        this.allPlayersData = [];
                        snapshot.forEach(doc => {
                            this.allPlayersData.push({ id: doc.id, ...doc.data() });
                        });
                        
                        this.filteredPlayers = [...this.allPlayersData];
                        this.sortPlayers('level-desc');
                        this.updateStatistics();
                        this.renderTopPlayers();
                        this.renderPlayers();
                    })
                    .catch(err => {
                        console.error('Error loading players:', err);
                        document.getElementById('players-list').innerHTML = '<div class="text-center text-red-400 text-xs py-4">Ошибка загрузки: ' + err.message + '</div>';
                    });
            },
            
            refreshAllPlayers: function() {
                this.loadFirebasePlayers();
            },
            
            updateStatistics: function() {
                const total = this.allPlayersData.length;
                document.getElementById('stat-total-players').innerText = total;
                
                const now = Date.now();
                const oneDayAgo = now - 24 * 60 * 60 * 1000;
                const activeToday = this.allPlayersData.filter(p => p.lastSeen && p.lastSeen > oneDayAgo).length;
                document.getElementById('stat-active-today').innerText = activeToday;
                
                const avgLevel = total > 0 
                    ? Math.floor(this.allPlayersData.reduce((sum, p) => sum + (p.level || 1), 0) / total)
                    : 0;
                document.getElementById('stat-avg-level').innerText = avgLevel;
            },
            
            filterPlayers: function(searchText) {
                searchText = searchText.toLowerCase();
                this.filteredPlayers = this.allPlayersData.filter(p => {
                    const id = String(p.telegramId || p.id || '').toLowerCase();
                    const username = String(p.telegramUsername || p.playerName || '').toLowerCase();
                    return id.includes(searchText) || username.includes(searchText);
                });
                this.currentPage = 1;
                this.renderPlayers();
            },
            
            sortPlayers: function(sortType) {
                const [field, dir] = sortType.split('-');
                this.filteredPlayers.sort((a, b) => {
                    let valA = a[field] || 0;
                    let valB = b[field] || 0;
                    
                    if (dir === 'desc') return valB - valA;
                    else return valA - valB;
                });
                this.currentPage = 1;
                this.renderPlayers();
            },
            
            renderPlayers: function() {
                const start = (this.currentPage - 1) * this.playersPerPage;
                const end = start + this.playersPerPage;
                const pageData = this.filteredPlayers.slice(start, end);
                
                const totalPages = Math.ceil(this.filteredPlayers.length / this.playersPerPage);
                document.getElementById('current-page').innerText = this.currentPage;
                document.getElementById('total-pages').innerText = totalPages || 1;
                
                document.getElementById('btn-prev-page').disabled = this.currentPage <= 1;
                document.getElementById('btn-next-page').disabled = this.currentPage >= totalPages;
                
                if (pageData.length === 0) {
                    document.getElementById('players-list').innerHTML = '<div class="text-center text-xs text-gray-500 py-4">Игроки не найдены</div>';
                    return;
                }
                
                let html = '';
                pageData.forEach(player => {
                    const lastSeen = player.lastSeen ? this.formatTimestamp(player.lastSeen) : 'Никогда';
                    const isOnline = player.lastSeen && (Date.now() - player.lastSeen < 5 * 60 * 1000);
                    
                    html += `
                        <div class="bg-black/30 border border-[#333] rounded p-2 hover:border-[#c8aa6e] transition-colors">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        ${isOnline ? '<span class="w-2 h-2 bg-green-400 rounded-full"></span>' : '<span class="w-2 h-2 bg-gray-600 rounded-full"></span>'}
                                        <span class="text-xs font-bold text-white truncate">@${player.telegramUsername || player.playerName || 'Игрок'}</span>
                                    </div>
                                    <div class="text-[10px] text-gray-400">ID: ${player.telegramId || player.id}</div>
                                </div>
                                <div class="text-right mr-2">
                                    <div class="text-xs text-[#c8aa6e]">Ур ${player.level || 1}</div>
                                    <div class="text-[10px] text-yellow-500">${(player.gold || 0).toLocaleString()} 💰</div>
                                </div>
                                <button onclick="devPanel.viewPlayer('${player.id}')" class="text-blue-400 hover:text-blue-300 text-xs px-2">
                                    📝
                                </button>
                            </div>
                            <div class="text-[9px] text-gray-500 mt-1">Был: ${lastSeen}</div>
                        </div>
                    `;
                });
                
                document.getElementById('players-list').innerHTML = html;
            },
            
            renderTopPlayers: function() {
                const top10 = [...this.allPlayersData]
                    .sort((a, b) => (b.level || 1) - (a.level || 1))
                    .slice(0, 10);
                
                if (top10.length === 0) {
                    document.getElementById('top-players-list').innerHTML = '<div class="text-center text-xs text-gray-500 py-2">Нет данных</div>';
                    return;
                }
                
                let html = '';
                top10.forEach((player, index) => {
                    const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
                    html += `
                        <div class="flex items-center justify-between text-xs bg-black/20 rounded px-2 py-1">
                            <div class="flex items-center gap-2">
                                <span class="w-6">${medal}</span>
                                <span class="text-white truncate max-w-[120px]">@${player.telegramUsername || player.playerName || 'Игрок'}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-[#c8aa6e]">Ур ${player.level || 1}</span>
                                <span class="text-yellow-500">${(player.gold || 0).toLocaleString()}</span>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('top-players-list').innerHTML = html;
            },
            
            prevPage: function() {
                if (this.currentPage > 1) {
                    this.currentPage--;
                    this.renderPlayers();
                }
            },
            
            nextPage: function() {
                const totalPages = Math.ceil(this.filteredPlayers.length / this.playersPerPage);
                if (this.currentPage < totalPages) {
                    this.currentPage++;
                    this.renderPlayers();
                }
            },
            
            viewPlayer: function(playerId) {
                const player = this.allPlayersData.find(p => p.id === playerId);
                if (!player) return;
                
                alert(`Игрок: @${player.telegramUsername || player.playerName}\nID: ${player.telegramId}\nУровень: ${player.level}\nЗолото: ${player.gold}\nИзумруды: ${player.emeralds || 0}\n\n(Полное редактирование в разработке)`);
            },
            
            formatTimestamp: function(ts) {
                const diff = Date.now() - ts;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);
                
                if (minutes < 1) return 'Только что';
                if (minutes < 60) return `${minutes} мин назад`;
                if (hours < 24) return `${hours} ч назад`;
                return `${days} дн назад`;
            }        };

        // --- GAME LOGIC ---
        const game = {
            init: async function() {
                await this.load();
                this.calculateNextLevel();
                
                // Ensure playerId matches Telegram/local ID before any UI updates
                gameState.playerId = String(tgUserId);
                
                // Initialize resources if undefined (for backward-compatible saves)
                Object.keys(RESOURCE_NAMES).forEach(r => {
                    if (gameState[r] === undefined) gameState[r] = 0;
                });
                if (gameState.hp === undefined) gameState.hp = 100;
                if (gameState.maxHp === undefined) gameState.maxHp = 100;
                if (gameState.hunger === undefined) gameState.hunger = 100;
                if (gameState.maxHunger === undefined) gameState.maxHunger = 100;
                if (gameState.actionCount === undefined) gameState.actionCount = 0;
                if (gameState.lastHungerWarning === undefined) gameState.lastHungerWarning = 0;
                if (gameState.skillPoints === undefined) gameState.skillPoints = 0;
                if (gameState.luck === undefined) gameState.luck = 0;
                if (gameState.reputation === undefined) gameState.reputation = 0;
                if (gameState.craftingLevel === undefined) gameState.craftingLevel = 0;
                if (gameState.unconsciousUntil === undefined) gameState.unconsciousUntil = 0;
                if (gameState.lowHpWarnedAt === undefined) gameState.lowHpWarnedAt = 0;
                if (gameState.unconsciousUntil && gameState.unconsciousUntil > Date.now()) {
                    gameState.hp = 0;
                }
                
                quests.init();
                this.checkDailyReward();
                ui.updateAll();
                this.checkUnconscious();
                ui.updateUnconsciousUI();
                
                // Show Intro if not shown
                if (!gameState.introShown) {
                    setTimeout(() => document.getElementById('modal-intro').classList.add('open'), 500);
                }
                
                // Initialize new state fields if missing
                if(!gameState.recipes) gameState.recipes = { immortality: false, luck: false, saddle: false, bag: false };
                if(!gameState.effects) gameState.effects = { immortality: 0, luck: 0 };
                if (!gameState.npcStates) gameState.npcStates = {};
                if (gameState.hasPoorHouse === undefined) gameState.hasPoorHouse = false;
                if (gameState.hasNobleHouse === undefined) gameState.hasNobleHouse = false;
                if (gameState.bagLevel === undefined) gameState.bagLevel = 0;
                if (!gameState.playerName) {
                    gameState.playerName = "Странник";
                }
                if (!gameState.shoes) gameState.shoes = { peasant: false, quality: false, elite: false };
                if (gameState.treasuryPouchResolved === undefined) gameState.treasuryPouchResolved = false;
                if (gameState.bookhousePouchResolved === undefined) gameState.bookhousePouchResolved = false;
                
                if (gameState.npcStates.lili_waiting && gameState.npcStates.lili_wait_time) {
                    const elapsed = Date.now() - gameState.npcStates.lili_wait_time;
                    if (elapsed > 1000 * 60 * 3) {
                        gameState.npcStates.lili_waiting = true;
                    }
                }
                
                this.updateEffectsLoop();

                // Telegram Init
                if (window.Telegram && window.Telegram.WebApp) {
                    const tg = window.Telegram.WebApp;
                    tg.ready();
                    tg.expand();
                    tg.setHeaderColor('#141417');
                    tg.setBackgroundColor('#0f0f10');
                }
            },

            save: function() {
                // Update timestamp
                gameState.lastUpdate = new Date().toISOString();
                gameState.lastSeen = Date.now();
                
                // Save to localStorage (local backup)
                localStorage.setItem('medieval_rpg_save_v5', JSON.stringify(gameState));
                
                // Save to Firebase (cloud sync)
                if (typeof db !== 'undefined' && tgUserId) {
                    const playerData = {
                        ...gameState,
                        telegramId: tgUserId,
                        telegramUsername: tgUsername
                    };
                    
                    db.collection('players').doc(String(tgUserId)).set(playerData, { merge: true })
                        .catch(err => console.error('Firebase save error:', err));
                }
            },

            load: async function() {
                console.log('=== LOAD STARTED ===');
                console.log('tgUserId:', tgUserId);
                console.log('db available:', typeof db !== 'undefined');
                
                // First load from localStorage
                const localSaved = localStorage.getItem('medieval_rpg_save_v5');
                let localData = null;
                let localTimestamp = 0;
                
                console.log('localStorage data exists:', !!localSaved);
                
                if (localSaved) {
                    try {
                        localData = JSON.parse(localSaved);
                        localTimestamp = localData.lastUpdate ? new Date(localData.lastUpdate).getTime() : 0;
                        console.log('Local data parsed. Level:', localData.level, 'Gold:', localData.gold);
                        console.log('Local timestamp:', new Date(localTimestamp).toISOString());
                    } catch (e) {
                        console.error('Local load error:', e);
                    }
                }
                
                // Try to load from Firebase (cloud)
                if (typeof db !== 'undefined' && tgUserId) {
                    console.log('Attempting Firebase load...');
                    try {
                        const doc = await db.collection('players').doc(String(tgUserId)).get();
                        console.log('Firebase doc exists:', doc.exists);
                        
                        if (doc.exists) {
                            const cloudData = doc.data();
                            const cloudTimestamp = cloudData.lastUpdate ? new Date(cloudData.lastUpdate).getTime() : 0;
                            
                            console.log('Cloud data found. Level:', cloudData.level, 'Gold:', cloudData.gold);
                            console.log('Cloud timestamp:', new Date(cloudTimestamp).toISOString());
                            console.log('Comparing: cloud =', cloudTimestamp, 'vs local =', localTimestamp);
                            
                            // Compare timestamps
                            if (cloudTimestamp > localTimestamp) {
                                // Cloud is newer - use it
                                Object.assign(gameState, cloudData);
                                console.log('✅ Using Firebase data (newer). Level:', gameState.level, 'Gold:', gameState.gold);
                                // Update localStorage with cloud data
                                localStorage.setItem('medieval_rpg_save_v5', JSON.stringify(cloudData));
                            } else if (localData) {
                                // Local is newer or same - use local
                                Object.assign(gameState, localData);
                                console.log('✅ Using local data (newer or same). Level:', gameState.level, 'Gold:', gameState.gold);
                                // Update Firebase with local data
                                this.save();
                            } else {
                                // No local data, use cloud
                                Object.assign(gameState, cloudData);
                                console.log('✅ Using Firebase data (no local). Level:', gameState.level, 'Gold:', gameState.gold);
                            }
                        } else {
                            // No cloud save, use localStorage
                            if (localData) {
                                Object.assign(gameState, localData);
                                console.log('✅ Using local data (no cloud). Level:', gameState.level, 'Gold:', gameState.gold);
                            } else {
                                console.log('⚠️ No saved data found anywhere');
                            }
                        }
                    } catch (err) {
                        console.error('Firebase load error:', err);
                        // Fallback to localStorage on error
                        if (localData) {
                            Object.assign(gameState, localData);
                            console.log('✅ Using local data (Firebase error). Level:', gameState.level, 'Gold:', gameState.gold);
                        }
                    }
                } else {
                    // No Firebase, use localStorage
                    if (localData) {
                        Object.assign(gameState, localData);
                        console.log('✅ Using local data (no Firebase). Level:', gameState.level, 'Gold:', gameState.gold);
                    }
                }
                
                console.log('=== LOAD COMPLETED ===');
                console.log('Final gameState - Level:', gameState.level, 'Gold:', gameState.gold, 'XP:', gameState.xp);
            },
            
            loadFromLocal: function() {
                const saved = localStorage.getItem('medieval_rpg_save_v5');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        Object.assign(gameState, data);
                        console.log('Loaded from localStorage');
                    } catch (e) {
                        console.error('Load error:', e);
                    }
                }
            },
            
            closeIntro: function(goToMap) {
                document.getElementById('modal-intro').classList.remove('open');
                gameState.introShown = true;
                this.save();
                if (goToMap) {
                    router.navigate('town-square');
                }
            },
            
            getJobReward: function(jobType) {
                const job = JOBS_DB[jobType];
                const toolState = gameState.tools[job.tool];
                let amount = 1;
                if (toolState.owned && toolState.level > 1) {
                    amount += (toolState.level - 1);
                }
                // Return as 'gold' property to match UI usage, though it represents resource amount
                return { gold: amount }; 
            },

            calculateNextLevel: function() {
                if (gameState.level >= 60) {
                    gameState.xpToNextLevel = Infinity;
                } else {
                    gameState.xpToNextLevel = Math.floor(gameState.level * (gameState.level + 1) / 2 * 100);
                }
            },

            getLevelTitle: function(level) {
                if (level < 10) return 'Странник';
                if (level < 20) return 'Городской житель';
                if (level < 30) return 'Уважаемый человек';
                if (level < 40) return 'Элита города';
                if (level < 50) return 'Знаменитый рыцарь';
                return 'Королевский рыцарь';
            },

            getLevelTitleDescription: function(level) {
                if (level < 10) return 'Начинающий искатель приключений';
                if (level < 20) return 'Признанный член городского сообщества';
                if (level < 30) return 'Влиятельная личность в городе';
                if (level < 40) return 'Представитель высшего общества';
                if (level < 50) return 'Легендарный воин королевства';
                return 'Защитник короны и символ доблести';
            },

            addXp: function(amount) {
                // Apply XP boost if active
                if (gameState.activeEffects && gameState.activeEffects.xpBoost && gameState.activeEffects.xpBoost > Date.now()) {
                    amount *= 2;
                }
                
                // Apply XP amulet bonus (+50%)
                if (gameState.amulets && gameState.amulets.xp && gameState.amulets.xp.owned) {
                    amount = Math.floor(amount * 1.5);
                }
                
                gameState.xp += amount;
                if (gameState.xp >= gameState.xpToNextLevel) {
                    this.levelUp();
                }
                this.save();
                ui.updateStats();
            },

            levelUp: function() {
                if (gameState.level >= 60) return;
                gameState.xp -= gameState.xpToNextLevel;
                gameState.level++;

                const goldReward = (gameState.level - 1) * 100;
                gameState.gold += goldReward;
                gameState.skillPoints = (gameState.skillPoints || 0) + 1;

                this.calculateNextLevel();
                ui.updateJobs();
                ui.updateStats();
                
                // Update livestock farm button if on village screen
                if (router.currentTab === 'map') {
                    livestockFarm.updateButtonUI();
                }

                this.showLevelUpModal(goldReward);
                this.save();
            },

            showLevelUpModal: function(goldReward) {
                const modal = document.getElementById('modal-levelup');
                if (!modal) return;

                document.getElementById('levelup-new-level').innerText = gameState.level;
                document.getElementById('levelup-new-title').innerText = game.getLevelTitle(gameState.level);
                document.getElementById('levelup-gold').innerText = goldReward;

                let msg = "Ваш путь продолжается. Откройте вкладку Герой и улучшайте навыки.";
                if (gameState.level === 2) {
                    msg = "Открылся Книжный Дом на площади. Покупайте рецепты и развивайте героя.";
                } else if (gameState.level === 3) {
                    msg = "Появилась работа Грузчика в порту. Порыбачьте, чтобы встретить Алекса.";
                } else if (gameState.level === 5) {
                    msg = "Открыты Пшеничное поле и Темный лес. Нужны серп и осторожность.";
                } else if (gameState.level === 10) {
                    msg = "Открылся Скотный двор в деревне! Ухаживайте за животными и получайте ресурсы.";
                } else if (gameState.level === 15) {
                    msg = "Открыт Рудник и Учебный лагерь. Навестите Рыцаря Джона.";
                } else if (gameState.level === 30) {

                }

                document.getElementById('levelup-message').innerText = msg;
                modal.classList.add('open');

                if (window.navigator && window.navigator.vibrate) {
                    window.navigator.vibrate([120, 60, 120]);
                }
            },

            closeLevelUp: function() {
                const modal = document.getElementById('modal-levelup');
                if (modal) modal.classList.remove('open');
            },
            
            heal: function(amount, cost) {
                if(gameState.gold >= cost) {
                    if (gameState.hp >= gameState.maxHp) {
                        ui.showFloatText(event.target, "Здоровье полно", "#c8aa6e");
                        return;
                    }
                    gameState.gold -= cost;
                    gameState.hp = Math.min(gameState.maxHp, gameState.hp + amount);
                    ui.showFloatText(event.target, `+${amount} HP`, "#ef4444");
                    ui.updateStats();
                    this.save();
                } else {
                    ui.showFloatText(event.target, "Не хватает золота", "#ff5555");
                }
            },

            addReputation: function(amount, sourceElement = null) {
                const prev = gameState.reputation || 0;
                const next = Math.max(0, Math.min(100, prev + amount));
                if (next === prev) return;
                const actualChange = next - prev;
                gameState.reputation = next;
                this.save();
                ui.updateStats();

                // Show floating text as before
                if (sourceElement) {
                    const sign = actualChange > 0 ? '+' : '';
                    const color = actualChange > 0 ? '#34d399' : '#ef4444';
                    ui.showFloatText(sourceElement, `${sign}${actualChange} Репутации`, color);
                }

                // Show reputation change modal popup
                this.showRepChangeModal(prev, next, actualChange);
            },

            _repChangeTimeout: null,
            showRepChangeModal: function(prev, next, change) {
                const modal = document.getElementById('modal-rep-change');
                const card = document.getElementById('rep-change-card');
                const amountEl = document.getElementById('rep-change-amount');
                const fromEl = document.getElementById('rep-change-from');
                const toEl = document.getElementById('rep-change-to');
                const barEl = document.getElementById('rep-change-bar');
                const iconEl = document.getElementById('rep-change-icon');
                const topbar = document.getElementById('rep-change-topbar');
                if (!modal || !card) return;

                const isUp = change > 0;
                const color = isUp ? '#34d399' : '#ef4444';
                const sign = isUp ? '+' : '';

                amountEl.innerText = `${sign}${change}`;
                amountEl.style.color = color;
                fromEl.innerText = `было: ${prev}`;
                toEl.innerText = `стало: ${next}`;
                iconEl.style.color = color;
                iconEl.style.filter = `drop-shadow(0 0 10px ${color}66)`;
                topbar.style.background = `linear-gradient(to right, transparent, ${color}, transparent)`;
                barEl.style.width = `${next}%`;
                barEl.style.background = isUp ? 'linear-gradient(to right, #34d399, #10b981)' : 'linear-gradient(to right, #ef4444, #dc2626)';

                // Cancel previous timeout if modal already open
                if (this._repChangeTimeout) clearTimeout(this._repChangeTimeout);

                // Show
                modal.classList.add('open');
                setTimeout(() => { card.style.transform = 'scale(1)'; card.style.opacity = '1'; }, 30);

                // Auto-hide after 2.2s
                this._repChangeTimeout = setTimeout(() => {
                    card.style.transform = 'scale(0.85)';
                    card.style.opacity = '0';
                    setTimeout(() => { modal.classList.remove('open'); }, 320);
                }, 2200);
            }, function() {
                if (gameState.unconsciousUntil && gameState.unconsciousUntil > Date.now()) return;
                gameState.hp = 0;
                gameState.unconsciousUntil = Date.now() + 10 * 60 * 1000;
                this.save();
                ui.updateStats();
                ui.updateUnconsciousUI();
            },

            checkUnconscious: function() {
                const now = Date.now();
                
                // If timer is running
                if (gameState.unconsciousUntil && gameState.unconsciousUntil > now) {
                    // Force HP to 0 if it somehow isn't
                    if (gameState.hp !== 0) {
                        gameState.hp = 0;
                        this.save();
                        ui.updateStats();
                    }
                    // Ensure UI is showing unconscious state
                    if (!document.body.classList.contains('unconscious')) {
                        ui.updateUnconsciousUI();
                    }
                    return;
                }

                // If timer expired (wake up)
                if (gameState.unconsciousUntil && gameState.unconsciousUntil <= now) {
                    gameState.unconsciousUntil = 0;
                    gameState.hp = Math.max(gameState.hp, 15);
                    this.save();
                    ui.updateStats();
                    ui.updateUnconsciousUI();
                    ui.showFloatText(document.body, "Вы пришли в себя (+15 HP)", "#34d399");
                }
            },

            trackAction: function() {
                // Increment action count
                gameState.actionCount = (gameState.actionCount || 0) + 1;
                
                // Every 2 actions, decrease hunger by 1
                if (gameState.actionCount >= 2) {
                    gameState.actionCount = 0;
                    gameState.hunger = Math.max(0, gameState.hunger - 1);
                }
                
                this.save();
                ui.updateStats();
            },

            getHungerDamageMultiplier: function() {
                // Double damage when hunger is 0
                return gameState.hunger <= 0 ? 2 : 1;
            },

            checkDailyReward: function() {
                const today = new Date().toDateString();
                
                // First launch check
                if (!gameState.installDate) {
                    gameState.installDate = today;
                    gameState.lastLoginDate = today;
                    gameState.dailyStreak = 1;
                    this.save();
                    return; // Skip reward on first day
                }

                const last = gameState.lastLoginDate;
                
                if (last !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    if (last === yesterday.toDateString()) {
                        gameState.dailyStreak++;
                    } else {
                        // Reset streak if missed a day, but keep 1
                        gameState.dailyStreak = 1;
                    }
                    setTimeout(() => {
                        ui.showDailyModal();
                    }, 1000);
                }
            },

            claimDaily: function() {
                const streak = gameState.dailyStreak;
                let reward = 30;
                if (streak === 1) reward = 5;
                else if (streak === 2) reward = 10;
                else if (streak === 3) reward = 15;
                else if (streak === 4) reward = 20;
                
                gameState.emeralds += reward;
                gameState.lastLoginDate = new Date().toDateString();
                this.save();
                
                document.getElementById('modal-daily').classList.remove('open');
                ui.updateAll();
                ui.showFloatText(document.body, `+${reward} Изумрудов`, "#34d399");
            },

            work: function(jobType, event) {
                if (gameState.hp <= 0 || (gameState.unconsciousUntil && gameState.unconsciousUntil > Date.now())) {
                    ui.showFloatText(event.target, "Вы без сознания", "#ff5555");
                    return;
                }

                const job = JOBS_DB[jobType];
                
                // Check level requirement
                if (job.levelReq && gameState.level < job.levelReq) {
                    ui.showFloatText(event.target, `Нужен Уровень ${job.levelReq}`, "#ff5555");
                    return;
                }
                
                // Check if job requires Alex unlock
                if (job.requiresAlex && (!gameState.npcStates || !gameState.npcStates.alex_job_unlocked)) {
                    ui.showFloatText(event.target, "Работа недоступна", "#ff5555");
                    return;
                }
                
                // Check tool requirement (skip for loader job)
                const toolState = job.tool ? gameState.tools[job.tool] : null;
                const toolDef = job.tool ? TOOLS_DB[job.tool] : null;

                if (toolDef && !toolState.owned) {
                    if (jobType === 'port' && gameState.gold >= TOOLS_DB.rod.baseCost) {
                        ui.showFloatText(event.target, "Удочку можно купить на рынке", "#fbbf24");
                    } else {
                        ui.showFloatText(event.target, `Нужна ${toolDef.name}`, "#ff5555");
                    }
                    return;
                }
                
                // Track port work for old man event
                if (jobType === 'port') {
                    // Initialize threshold if not set
                    if (!gameState.oldManEventThreshold) {
                        gameState.oldManEventThreshold = Math.floor(Math.random() * 51) + 50; // 50-100
                    }
                    
                    gameState.portWorkCount = (gameState.portWorkCount || 0) + 1;
                    
                    // Trigger Alex meeting at level 3
                    if (!gameState.npcStates) gameState.npcStates = {};
                    if (!gameState.npcStates.alex_met && gameState.level >= 3) {
                        gameState.npcStates.alex_met = true;
                        this.save();
                        
                        setTimeout(() => {
                            dialogue.start('alex');
                        }, 500);
                        return; // Don't process the work this time
                    }
                    
                    // Trigger old man event
                    if (!gameState.oldManEventTriggered && gameState.portWorkCount >= gameState.oldManEventThreshold && gameState.gold > 0) {
                        gameState.oldManEventTriggered = true;
                        this.save();
                        
                        setTimeout(() => {
                            dialogue.start('oldman_port');
                        }, 500);
                        return; // Don't process the work this time
                    }
                }
                
                // Injury Chance (custom for loader job - 1%, others - 10%)
                const injuryChance = job.injuryChance !== undefined ? job.injuryChance : 0.1;
                if (Math.random() < injuryChance) {
                    let dmg = Math.floor(Math.random() * 7) + 6; // Урон от 6 до 12
                    // Apply hunger damage multiplier
                    dmg = Math.floor(dmg * this.getHungerDamageMultiplier());
                    gameState.hp = Math.max(0, gameState.hp - dmg);
                    ui.showFloatText(event.target, `-${dmg} HP (Травма!)`, "#ef4444");
                    ui.updateStats();
                    this.save();
                    return; 
                }

                let amount = 1;
                if (toolState && toolState.level > 1) {
                    amount += (toolState.level - 1);
                }

                // Chance for Emerald (only in Mine)
                const luckyDrop = (jobType === 'mine') && (Math.random() < 0.005);
                if (luckyDrop) {
                    gameState.emeralds += 1;
                    setTimeout(() => {
                        ui.showFloatText(event.target, `+1 ИЗУМРУД!`, "#34d399");
                    }, 200);
                }

                this.addXp(job.xp);

                // Handle loader job (gives gold directly)
                if (jobType === 'loader') {
                    const goldReward = job.price; // 6 gold
                    gameState.gold += goldReward;
                    ui.showFloatText(event.target, `+${goldReward} Золота`, "#c8aa6e");
                } else {
                    // Add Resource
                    const extraWeight = (RESOURCE_WEIGHTS[job.resource] || 0) * amount;
                    if (!this.hasWeightCapacity(extraWeight)) {
                        this.showWeightWarning(event.target);
                        return;
                    }
                    if (gameState[job.resource] === undefined) gameState[job.resource] = 0;
                    gameState[job.resource] += amount;
                    
                    const rName = RESOURCE_NAMES[job.resource].name;
                    ui.showFloatText(event.target, `+${amount} ${rName}`, "#e0e0e0");
                }
                
                // Quest Progress
                quests.onEvent('work', jobType, 1);
                // Also trigger gather event for story quests
                quests.onEvent('gather', job.resource, amount);

                // Track action for hunger system
                this.trackAction();

                ui.updateStats();
                if (window.navigator && window.navigator.vibrate) {
                    window.navigator.vibrate(10);
                }
                
                this.save();
                ui.updateStats(); 
                ui.updateJobs();
            },

            buyRecipe: function(type, cost) {
                if (!gameState.recipes) gameState.recipes = {};

                if (gameState.emeralds >= cost) {
                    gameState.emeralds -= cost;
                    gameState.recipes[type] = true;
                    this.save();
                    ui.updateAll();
                    ui.showFloatText(event.target, "Рецепт куплен!", "#34d399");

                    if (type === 'immortality' || type === 'luck') {
                        document.getElementById('healer-crafting-station').classList.remove('hidden');
                        if (type === 'immortality') document.getElementById('craft-action-immortality').classList.remove('hidden');
                        if (type === 'luck') document.getElementById('craft-action-luck').classList.remove('hidden');
                    }

                    if (type === 'bag') {
                        ui.showFloatText(event.target, "Рюкзак можно улучшить в крафте", "#fbbf24");
                    }
                } else {
                    ui.showFloatText(event.target, "Не хватает изумрудов", "#ff5555");
                }
            },

            getWeightCapacity: function() {
                const base = 100; // Стандартный инвентарь 100кг
                const bagLevel = gameState.bagLevel || 0;
                if (bagLevel === 0) {
                    return base;
                } else if (bagLevel === 1) {
                    return 200; // Улучшенный рюкзак дает 200кг
                } else {
                    // Для дальнейших улучшений можно добавить логику
                    return 200 + (bagLevel - 1) * 100;
                }
            },

            getCurrentWeight: function() {
                let total = 0;
                Object.keys(RESOURCE_WEIGHTS).forEach(key => {
                    const count = gameState[key] || 0;
                    if (count > 0) total += count * RESOURCE_WEIGHTS[key];
                });
                Object.keys(gameState.tools || {}).forEach(key => {
                    if (gameState.tools[key] && gameState.tools[key].owned) {
                        total += TOOL_WEIGHTS[key] || 0;
                    }
                });
                if (gameState.shoes) {
                    Object.keys(gameState.shoes).forEach(key => {
                        if (gameState.shoes[key]) total += SHOES_WEIGHTS[key] || 0;
                    });
                }
                return Math.round(total * 10) / 10;
            },

            hasWeightCapacity: function(extra = 0) {
                return (this.getCurrentWeight() + extra) <= this.getWeightCapacity();
            },

            showWeightWarning: function(anchor) {
                ui.showFloatText(anchor || document.body, "Рюкзак перегружен", "#ff5555");
            },

            activateEffect: function(effectType) {
                if (!gameState.effects) gameState.effects = { immortality: 0, luck: 0 };
                
                if (effectType === 'immortality') {
                    if (gameState.herbs >= 10) {
                        gameState.herbs -= 10;
                        gameState.effects.immortality = Date.now() + 2 * 60 * 1000;
                        ui.showFloatText(event.target, "Бессмертие активировано!", "#ef4444");
                    } else {
                        ui.showFloatText(event.target, "Нужно 10 трав", "#ff5555");
                        return;
                    }
                }
                if (effectType === 'luck') {
                    if (gameState.mushrooms >= 5) {
                        gameState.mushrooms -= 5;
                        gameState.effects.luck = Date.now() + 2 * 60 * 1000;
                        ui.showFloatText(event.target, "Удача x2 активирована!", "#34d399");
                    } else {
                        ui.showFloatText(event.target, "Нужно 5 грибов", "#ff5555");
                        return;
                    }
                }
                this.save();
                ui.updateAll();
            },

            updateEffectsLoop: function() {
                setInterval(() => {
                    if (!gameState.effects) return;

                    const now = Date.now();
                    const immActive = gameState.effects.immortality > now;
                    const luckActive = gameState.effects.luck > now;
                    const measlesActive = gameState.hasMeasles === true;

                    const effectsContainer = document.getElementById('active-effects-container');
                    const immEl = document.getElementById('effect-immortality');
                    const luckEl = document.getElementById('effect-luck');
                    const measlesEl = document.getElementById('effect-measles');

                    if (immActive || luckActive || measlesActive) effectsContainer.classList.remove('hidden');
                    else effectsContainer.classList.add('hidden');

                    if (immActive) {
                        immEl.classList.remove('hidden');
                        const remaining = Math.max(0, Math.floor((gameState.effects.immortality - now) / 1000));
                        document.getElementById('timer-immortality').innerText = `${Math.floor(remaining/60)}:${String(remaining%60).padStart(2,'0')}`;
                    } else {
                        immEl.classList.add('hidden');
                    }

                    if (luckActive) {
                        luckEl.classList.remove('hidden');
                        const remaining = Math.max(0, Math.floor((gameState.effects.luck - now) / 1000));
                        document.getElementById('timer-luck').innerText = `${Math.floor(remaining/60)}:${String(remaining%60).padStart(2,'0')}`;
                    } else {
                        luckEl.classList.add('hidden');
                    }

                    if (measlesActive) {
                        measlesEl.classList.remove('hidden');
                    } else {
                        measlesEl.classList.add('hidden');
                    }
                }, 1000);
            },

            completeQuest: function(id) {
                quests.claimStory(id, true);
            },

            buyClothes: function(type, cost) {
                market.buyClothes(type, cost);
            },

            gainReputationForClothes: function(type, sourceElement) {
                if (type === 'peasant') this.addReputation(2, sourceElement);
                if (type === 'rich') this.addReputation(5, sourceElement);
                if (type === 'noble') this.addReputation(8, sourceElement);
            }
        };

        // --- LOCATIONS CONTROLLER ---
        const locations = {
            guestHouseEat: function(type) {
                if (gameState.gold < 1000) {
                    ui.showFloatText(event.target, "Не хватает золота!", "#ef4444");
                    return;
                }
                gameState.gold -= 1000;
                gameState.hp = gameState.maxHp;
                gameState.hunger = gameState.maxHunger;
                game.save();
                ui.updateStats();
                
                const dishName = type === 'meatpie' ? "Пирог с Мясом" : "Жульен";
                ui.showFloatText(event.target, `${dishName} съеден!`, "#34d399");
                ui.showFloatText(document.getElementById('stat-gold'), "-1000", "#ef4444");
            },

            guestHousePlayCards: function() {
                blackjack.open();
            },
            beg: function(event) {
                // Check for Knight John encounter (random chance or first time after some progress)
                // Let's make it trigger if player has > 10 gold total earned or simply not met yet
                if (!gameState.npcStates) gameState.npcStates = {};
                
                if (!gameState.npcStates.john_met && Math.random() < 0.2) {
                     gameState.npcStates.john_met = true;
                     gameState.gold += 10; // The coin he throws
                     ui.showFloatText(event.target, "+10 Золота (Рыцарь!)", "#fbbf24");
                     ui.updateStats();
                     game.save();
                     
                     setTimeout(() => {
                         dialogue.start('john_intro');
                     }, 500);
                     return;
                }

                gameState.gold += 2;
                ui.showFloatText(event.target, "+2 Золота", "#c8aa6e");
                ui.updateStats();
                game.save();
            },

            treasuryDepositAll: function(event) {
                // Not used in HTML but kept for logic safety
                const anchor = (event && event.target) ? event.target : document.body;
                if (gameState.gold > 0) {
                    const amount = gameState.gold;
                    gameState.gold = 0;
                    gameState.bankedGold += amount;
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(anchor, `Депозит ${amount}`, "#c8aa6e");
                } else {
                    ui.showFloatText(anchor, "Нет золота", "#ff5555");
                }
            },

            treasuryWithdrawAll: function(event) {
                 // Not used in HTML but kept for logic safety
                const anchor = (event && event.target) ? event.target : document.body;
                if (gameState.bankedGold > 0) {
                    const amount = gameState.bankedGold;
                    gameState.bankedGold = 0;
                    gameState.gold += amount;
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(anchor, `Снято ${amount}`, "#c8aa6e");
                } else {
                    ui.showFloatText(anchor, "Сейф пуст", "#ff5555");
                }
            },
            
            treasurySetMax: function(type, event) {
                const input = document.getElementById('bank-amount-input');
                if (type === 'deposit') {
                    input.value = gameState.gold;
                } else {
                    input.value = gameState.bankedGold;
                }
            },
            
            treasuryDepositAmount: function(event) {
                const input = document.getElementById('bank-amount-input');
                const val = parseInt(input.value);
                if (!val || val <= 0) return;
                if (gameState.gold >= val) {
                    gameState.gold -= val;
                    gameState.bankedGold += val;
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(event.target, `Депозит ${val}`, "#c8aa6e");
                    input.value = '';
                } else {
                    ui.showFloatText(event.target, "Не хватает", "#ff5555");
                }
            },
            
            treasuryWithdrawAmount: function(event) {
                const input = document.getElementById('bank-amount-input');
                const val = parseInt(input.value);
                if (!val || val <= 0) return;
                if (gameState.bankedGold >= val) {
                    gameState.bankedGold -= val;
                    gameState.gold += val;
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(event.target, `Снято ${val}`, "#c8aa6e");
                    input.value = '';
                } else {
                    ui.showFloatText(event.target, "Не хватает", "#ff5555");
                }
            },

            treasuryExchange: function(event) {
                const anchor = (event && event.target) ? event.target : document.body;
                if (gameState.emeralds >= 1) {
                    gameState.emeralds -= 1;
                    gameState.gold += 1000;
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(anchor, "+1000 Золота", "#c8aa6e");
                } else {
                    ui.showFloatText(anchor, "Нет изумрудов", "#ff5555");
                }
            },

            tavernRent: function(event) {
                if (gameState.gold >= 1000) {
                    gameState.gold -= 1000;
                    if (!gameState.tavernRoom) gameState.tavernRoom = { rented: false, expiresAt: 0, chest: {} };
                    
                    const now = Date.now();
                    // If active, extend. If not, start new.
                    if (gameState.tavernRoom.rented && gameState.tavernRoom.expiresAt > now) {
                        gameState.tavernRoom.expiresAt += 24 * 60 * 60 * 1000;
                    } else {
                        gameState.tavernRoom.rented = true;
                        gameState.tavernRoom.expiresAt = now + 24 * 60 * 60 * 1000;
                    }
                    
                    ui.updateStats();
                    locations.updateTavernUI();
                    ui.showFloatText(event.target, "Комната оплачена!", "#34d399");
                    game.save();
                } else {
                    ui.showFloatText(event.target, "Нужно 1000 золота", "#ff5555");
                }
            },
            
            tavernExtendRent: function() {
                 this.tavernRent(event);
            },

            updateTavernUI: function() {
                if (!gameState.tavernRoom) gameState.tavernRoom = { rented: false, expiresAt: 0, chest: {} };
                
                const now = Date.now();
                const rentUI = document.getElementById('tavern-room-rent-ui');
                const activeUI = document.getElementById('tavern-room-active-ui');
                const timerEl = document.getElementById('room-timer');
                
                // Render Location Quest
                const questContainer = document.getElementById('tavern-quest-container');
                if (questContainer) {
                    if (gameState.locationQuests && gameState.locationQuests.tavern && !gameState.locationQuests.tavern.claimed) {
                        const q = gameState.locationQuests.tavern;
                        questContainer.innerHTML = `
                            <div class="panel p-2 rounded border border-yellow-600/50 mb-4">
                                <div class="text-xs text-[#c8aa6e] font-bold mb-1">Задание: ${q.text}</div>
                                <div class="flex justify-between items-center">
                                    <div class="text-[10px] text-[#a0a0a0]">${q.current}/${q.goal}</div>
                                    ${q.current >= q.goal ? 
                                        `<button onclick="quests.claimLocationQuest('tavern')" class="btn-medieval px-2 py-0.5 text-[10px] rounded">Забрать награду</button>` : 
                                        `<div class="text-[10px] text-blue-400">Награда: ${q.reward.gold ? q.reward.gold + ' монет' : ''}</div>`
                                    }
                                </div>
                            </div>
                        `;
                        questContainer.classList.remove('hidden');
                    } else {
                        questContainer.classList.add('hidden');
                    }
                }
                
                if (gameState.tavernRoom.rented && gameState.tavernRoom.expiresAt > now) {
                    if (rentUI) rentUI.classList.add('hidden');
                    if (activeUI) activeUI.classList.remove('hidden');
                    
                    const diff = gameState.tavernRoom.expiresAt - now;
                    const h = Math.floor(diff / 3600000);
                    const m = Math.floor((diff % 3600000) / 60000);
                    if (timerEl) timerEl.innerText = `${h}ч ${m}м`;
                } else {
                    gameState.tavernRoom.rented = false;
                    if (rentUI) rentUI.classList.remove('hidden');
                    if (activeUI) activeUI.classList.add('hidden');
                }
            },
            
            openTavernChest: function() {
                router.navigate('tavern-chest');
            },
            
            renderChest: function() {
                if (!gameState.tavernRoom) gameState.tavernRoom = { rented: false, expiresAt: 0, chest: {} };
                if (!gameState.tavernRoom.chest) gameState.tavernRoom.chest = {};
                
                // Inventory
                const invGrid = document.getElementById('chest-inventory-grid');
                if (invGrid) {
                    invGrid.innerHTML = '';
                    Object.keys(RESOURCE_NAMES).forEach(key => {
                        const count = gameState[key] || 0;
                        if (count > 0) {
                            const def = RESOURCE_NAMES[key];
                            const el = document.createElement('div');
                            el.className = 'aspect-square bg-[#222] border border-[#444] rounded flex flex-col items-center justify-center relative p-1 cursor-pointer hover:border-[#c8aa6e]';
                            el.innerHTML = `
                                ${ui.getIconHtml(def.icon, 'text-lg mb-1')}
                                <span class="text-[8px] uppercase text-gray-400 truncate w-full text-center">${def.name}</span>
                                <span class="absolute top-0 right-1 text-[8px] font-bold text-white">${count}</span>
                            `;
                            el.onclick = () => locations.moveItemToChest(key);
                            invGrid.appendChild(el);
                        }
                    });
                }
                
                // Chest
                const chestGrid = document.getElementById('chest-storage-grid');
                const weightEl = document.getElementById('chest-weight');
                let totalWeight = 0;
                
                if (chestGrid) {
                    chestGrid.innerHTML = '';
                    Object.keys(gameState.tavernRoom.chest).forEach(key => {
                        const count = gameState.tavernRoom.chest[key];
                        if (count > 0) {
                            const def = RESOURCE_NAMES[key];
                            const w = (RESOURCE_WEIGHTS[key] || 0) * count;
                            totalWeight += w;
                            
                            const el = document.createElement('div');
                            el.className = 'aspect-square bg-[#2d1810] border border-orange-900 rounded flex flex-col items-center justify-center relative p-1 cursor-pointer hover:border-orange-500';
                            el.innerHTML = `
                                ${ui.getIconHtml(def.icon, 'text-lg mb-1')}
                                <span class="text-[8px] uppercase text-gray-400 truncate w-full text-center">${def.name}</span>
                                <span class="absolute top-0 right-1 text-[8px] font-bold text-white">${count}</span>
                            `;
                            el.onclick = () => locations.moveItemFromChest(key);
                            chestGrid.appendChild(el);
                        }
                    });
                }
                
                if (weightEl) weightEl.innerText = totalWeight.toFixed(1);
            },
            
            moveItemToChest: function(key) {
                 if (!gameState.tavernRoom) return;
                 
                 if (gameState[key] > 0) {
                     const weight = RESOURCE_WEIGHTS[key] || 0;
                     let currentWeight = 0;
                     Object.keys(gameState.tavernRoom.chest || {}).forEach(k => {
                         currentWeight += (gameState.tavernRoom.chest[k] || 0) * (RESOURCE_WEIGHTS[k] || 0);
                     });
                     
                     if (currentWeight + weight > 200) {
                         ui.showFloatText(event.target, "Сундук полон!", "#ff5555");
                         return;
                     }
                     
                     gameState[key]--;
                     if (!gameState.tavernRoom.chest) gameState.tavernRoom.chest = {};
                     if (!gameState.tavernRoom.chest[key]) gameState.tavernRoom.chest[key] = 0;
                     gameState.tavernRoom.chest[key]++;
                     
                     game.save();
                     locations.renderChest();
                     ui.updateStats(); // Update inventory weight
                 }
            },
            
            moveItemFromChest: function(key) {
                if (!gameState.tavernRoom || !gameState.tavernRoom.chest[key]) return;
                
                if (game.hasWeightCapacity(RESOURCE_WEIGHTS[key] || 0)) {
                    gameState.tavernRoom.chest[key]--;
                    gameState[key]++;
                    if (gameState.tavernRoom.chest[key] <= 0) delete gameState.tavernRoom.chest[key];
                    
                    game.save();
                    locations.renderChest();
                    ui.updateStats();
                } else {
                     ui.showFloatText(event.target, "Перегруз!", "#ff5555");
                }
            },

            tavernBrawl: function(event) {
                if (gameState.hp < 20) {
                    ui.showFloatText(event.target, "Нужно 20+ HP", "#ff5555");
                    return;
                }
                const now = Date.now();
                const cooldown = 3600000; // 1 hour
                const last = gameState.lastBrawlTime || 0;
                
                if (now - last < cooldown) {
                    const left = Math.ceil((cooldown - (now - last)) / 60000);
                    ui.showFloatText(event.target, `Жди ${left} мин`, "#777");
                    return;
                }

                gameState.lastBrawlTime = now;
                
                // Fight logic
                // Chance to win increases with level
                const baseChance = 0.4;
                const levelBonus = (gameState.level * 0.02); // 2% per level
                const winChance = Math.min(0.8, baseChance + levelBonus);
                
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = "<i class='fas fa-fist-raised animate-bounce'></i> Бой...";
                
                setTimeout(() => {
                    const won = Math.random() < winChance;
                    
                    if (won) {
                        const gold = 50 + Math.floor(Math.random() * 100);
                        const rep = 1;
                        gameState.gold += gold;
                        game.addReputation(rep, btn);
                        ui.showFloatText(btn, `Победа! +${gold} монет`, "#fbbf24");
                    } else {
                        let dmg = 15 + Math.floor(Math.random() * 15);
                        dmg = Math.floor(dmg * game.getHungerDamageMultiplier());
                        gameState.hp = Math.max(1, gameState.hp - dmg);
                        ui.showFloatText(btn, `Поражение... -${dmg} HP`, "#ef4444");
                    }
                    
                    game.save();
                    ui.updateStats();
                    ui.updateLocations(); // Updates timer text
                }, 1000);
            },

            tavernSpin: function() {
                const btn = document.getElementById('btn-spin');
                if (gameState.emeralds < 1) {
                    ui.showFloatText(btn, "Нужен 1 Изумруд", "#ff5555");
                    return;
                }

                gameState.emeralds -= 1;
                ui.updateStats();
                
                btn.disabled = true;
                const wheel = document.getElementById('wheel');
                wheel.classList.add('spin-anim');
                
                // Determine Reward with new probabilities
                // 500 gold: 50%, 1000 gold: 30%, 5000 gold: 10%, 10 gems: 5%, 30 gems: 4%, 100 gems: 1%
                const rand = Math.random() * 100;
                let reward = { type: 'gold', val: 500, text: '500 Золота' };
                
                if (rand < 1) {
                    // 1% chance
                    reward = { type: 'gem', val: 100, text: '100 ИЗУМРУДОВ!' };
                } else if (rand < 5) {
                    // 4% chance (1-5)
                    reward = { type: 'gem', val: 30, text: '30 Изумрудов' };
                } else if (rand < 10) {
                    // 5% chance (5-10)
                    reward = { type: 'gem', val: 10, text: '10 Изумрудов' };
                } else if (rand < 20) {
                    // 10% chance (10-20)
                    reward = { type: 'gold', val: 5000, text: '5,000 Золота' };
                } else if (rand < 50) {
                    // 30% chance (20-50)
                    reward = { type: 'gold', val: 1000, text: '1,000 Золота' };
                }
                // else: 50% chance (50-100) - 500 gold (default)
                
                setTimeout(() => {
                    wheel.classList.remove('spin-anim');
                    btn.disabled = false;
                    
                    if (reward.type === 'gold') {
                        gameState.gold += reward.val;
                    } else {
                        gameState.emeralds += reward.val;
                    }
                    
                    game.save();
                    ui.updateStats();
                    
                    const color = reward.type === 'gem' ? '#34d399' : '#c8aa6e';
                    const icon = reward.type === 'gem' ? '💎' : '🪙';
                    ui.showFloatText(btn, `${icon} +${reward.text}`, color);
                }, 1500);
            },

            tavernEat: function(type) {
                if (gameState.gold >= 100) {
                    if (gameState.hp >= gameState.maxHp && gameState.hunger >= gameState.maxHunger) {
                        ui.showFloatText(event.target, "Вы сыты", "#c8aa6e");
                        return;
                    }
                    gameState.gold -= 100;
                    gameState.hp = gameState.maxHp;
                    gameState.hunger = gameState.maxHunger; // Восстанавливаем голод на 100%
                    ui.updateStats();
                    game.save();
                    ui.showFloatText(event.target, "HP и Голод восстановлены!", "#34d399");

                    // Thomas Event Trigger
                    if (!gameState.npcStates) gameState.npcStates = {};
                    if (!gameState.npcStates.thomas_met) {
                        setTimeout(() => {
                            dialogue.start('thomas_intro');
                        }, 1000);
                    }
                } else {
                    ui.showFloatText(event.target, "Не хватает золота", "#ff5555");
                }
            },

            forestGather: function(event) {
                const isImmortal = gameState.effects && gameState.effects.immortality > Date.now();
                if (!isImmortal && gameState.hp < 5) {
                    ui.showFloatText(event.target, "Мало здоровья", "#ff5555");
                    return;
                }
                if (!isImmortal) {
                    const dmg = Math.floor(5 * game.getHungerDamageMultiplier());
                    gameState.hp -= dmg;
                }
                
                game.addXp(3);
                
                const isLuckyEffect = gameState.effects && gameState.effects.luck > Date.now();
                const luckBonus = (gameState.luck || 0) * 0.05;
                
                let count = Math.floor(Math.random() * 3) + 1;
                if (Math.random() < luckBonus) count++;
                if (isLuckyEffect) count *= 2;
                
                const loot = [];
                for(let i=0; i<count; i++) {
                    const r = Math.random();
                    if(r < 0.4) loot.push('wood');       
                    else if(r < 0.7) loot.push('stone'); 
                    else if(r < 0.9) loot.push('herbs'); 
                    else loot.push('mushrooms');         
                }
                
                const gained = {};
                loot.forEach(item => {
                    let itemCount = 1;
                    // Apply gathering amulet bonus (+50% more resources)
                    if (gameState.amulets && gameState.amulets.gathering && gameState.amulets.gathering.owned) {
                        if (Math.random() < 0.5) {
                            itemCount = 2; // 50% chance to get double
                        }
                    }
                    gameState[item] = (gameState[item] || 0) + itemCount;
                    gained[item] = (gained[item] || 0) + itemCount;
                });
                
                let text = "";
                const names = {wood:'Палка', stone:'Камень', herbs:'Трава', mushrooms:'Гриб'};
                
                Object.keys(gained).forEach(k => {
                    text += `+${gained[k]} ${names[k]} `;
                });
                
                ui.showFloatText(event.target, text || "Пусто...", "#a855f7");

                Object.keys(gained).forEach(k => {
                    quests.onEvent('gather', k, gained[k]);
                });
                
                // Chance to get measles
                disease.tryInfect();
                
                // SECRET: Hank's Amulet (0.5% chance, only if quest is active and not found yet)
                if (gameState.npcStates && gameState.npcStates.hankAmuletActive && 
                    !gameState.npcStates.hankAmuletFound && Math.random() < 0.005) {
                    gameState.npcStates.hankAmuletFound = true;
                    setTimeout(() => {
                        ui.showFloatText(document.body, "✨ Золотой амулет!", "#ffd700");
                        ui.showFloatText(document.body, "Вернитесь к Хэнку!", "#c8aa6e");
                    }, 500);
                }
                
                // SECRET: Eigan's Totem (1% chance, only if quest is active and not found yet)
                if (gameState.npcStates && gameState.npcStates.eiganQuestActive && 
                    !gameState.npcStates.eiganTotemFound && Math.random() < 0.01) {
                    gameState.npcStates.eiganTotemFound = true;
                    game.save();
                    setTimeout(() => {
                        ui.showFloatText(document.body, "🗿 Древний тотем!", "#c8aa6e");
                        ui.showFloatText(document.body, "Вернитесь к Эйгану!", "#fbbf24");
                    }, 500);
                }
                
                game.save();
                ui.updateStats();
            },

            forestHunt: function(event) {
                // Require crossbow
                if (!gameState.tools || !gameState.tools.crossbow || !gameState.tools.crossbow.owned) {
                    ui.showFloatText(event.target, "Требуется арбалет", "#ff5555");
                    return;
                }
                if (gameState.hp < 20) {
                    ui.showFloatText(event.target, "Слишком опасно...", "#ff5555");
                    return;
                }
                const dmg = Math.floor(10 * game.getHungerDamageMultiplier());
                gameState.hp -= dmg;
                game.addXp(20);
                
                const roll = Math.random();
                if (roll < 0.2) {
                    // Nothing / Escaped
                    ui.showFloatText(event.target, "Зверь сбежал...", "#777");
                } else if (roll < 0.5) {
                    // Leather
                    const leather = Math.floor(Math.random() * 2) + 1;
                    gameState.leather = (gameState.leather || 0) + leather;
                    ui.showFloatText(event.target, `+${leather} Кожи`, "#8b4513");
                } else if (roll < 0.8) {
                    // Meat
                    const meat = Math.floor(Math.random() * 3) + 1;
                    gameState.meat = (gameState.meat || 0) + meat;
                    ui.showFloatText(event.target, `+${meat} Мяса`, "#ef4444");
                } else {
                    // Both
                    const leather = Math.floor(Math.random() * 2) + 1;
                    const meat = Math.floor(Math.random() * 2) + 1;
                    gameState.leather = (gameState.leather || 0) + leather;
                    gameState.meat = (gameState.meat || 0) + meat;
                    ui.showFloatText(event.target, `УДАЧА! +${leather} Кожи +${meat} Мяса`, "#fbbf24");
                }
                
                game.save();
                ui.updateStats();
            }
        };

        // --- MARKET CONTROLLER ---
        const market = {
            currentCategory: 'tools',
            toolMaxLevel: { rod: 5, sickle: 5, pickaxe: 3, crossbow: 3 },

            switchCategory: function(cat) {
                this.currentCategory = cat;
                document.querySelectorAll('#view-market .sub-tab').forEach(el => el.classList.remove('active'));
                const btn = document.getElementById(`tab-market-${cat}`);
                if(btn) btn.classList.add('active');

                document.getElementById('market-tools').classList.add('hidden');
                document.getElementById('market-weapons').classList.add('hidden');
                document.getElementById('market-armor').classList.add('hidden');
                document.getElementById('market-placeholder').classList.add('hidden');

                if (cat === 'tools') {
                    document.getElementById('market-tools').classList.remove('hidden');
                    // Hide sword for tools tab
                    const swordEl = document.getElementById('btn-buy-sword').parentElement;
                    if(swordEl) swordEl.style.display = 'none';
                    // Show others
                    ['rod','sickle','pickaxe','crossbow'].forEach(k => {
                        const el = document.getElementById(`btn-buy-${k}`).parentElement;
                        if(el) el.style.display = 'flex';
                    });
                    this.renderTools();
                } else if (cat === 'weapons') {
                    document.getElementById('market-weapons').classList.remove('hidden');
                    this.renderWeapons();
                } else if (cat === 'armor') {
                    document.getElementById('market-armor').classList.remove('hidden');
                    this.renderArmor();
                } else if (cat === 'horses') {
                    document.getElementById('market-placeholder').classList.remove('hidden');
                }
            },

            categoriesBuilt: false,

            buildTradeCategories: function() {
                ui.buildMarketCategories();
            },

            resourcePrices: {
                // Продажа (покупка = x2)
                fish: 3,
                meat: 10,
                mushrooms: 15,
                bread: 6,
                eggs: 4,
                milk: 6,

                ore: 25,
                bronze: 50,
                silver: 80,

                wheat: 8,
                wood: 2,
                stone: 2,
                herbs: 6,
                leather: 60,

                wool: 8,
                rope: 10,
                cloth: 12
            },

            getResourcePrice: function(resType) {
                return this.resourcePrices[resType] || 0;
            },

            getToolPrice: function(toolKey) {
                const toolState = gameState.tools[toolKey];
                const base = TOOLS_DB[toolKey].baseCost;
                if (!toolState || !toolState.owned) return base;
                const max = this.toolMaxLevel[toolKey] || 99;
                if (toolState.level >= max) return 0;
                return Math.floor(base * Math.pow(5, toolState.level));
            },

            renderTools: function() {
                ['rod', 'sickle', 'pickaxe', 'crossbow', 'sword'].forEach(key => {
                    const state = gameState.tools[key];
                    if (!state) return; // safety
                    const price = this.getToolPrice(key);
                    const btn = document.getElementById(`btn-buy-${key}`);
                    const lvlSpan = document.getElementById(`market-lvl-${key}`);
                    const priceSpan = document.getElementById(`price-${key}`);
                    const max = this.toolMaxLevel[key] || 99;
                    
                    if(lvlSpan) lvlSpan.innerText = state.owned ? `Ур: ${state.level}` : `Не куплено`;
                    
                    if(btn && priceSpan) {
                        if (state.owned && state.level >= max) {
                            btn.disabled = true;
                            btn.innerHTML = `Макс`;
                            if (priceSpan) priceSpan.innerText = '';
                            btn.style.opacity = '0.6';
                        } else {
                            priceSpan.innerText = price;
                            if (!state.owned) {
                                btn.disabled = false;
                                btn.innerHTML = `<span id="price-${key}">${price}</span> <i class="fas fa-coins text-[10px]"></i>`;
                            } else {
                                btn.disabled = false;
                                btn.innerHTML = `Улучшить <span id="price-${key}">${price}</span> <i class="fas fa-coins text-[10px]"></i>`;
                            }
                            if (gameState.gold < price) btn.style.opacity = '0.5';
                            else btn.style.opacity = '1';
                        }
                    }

                    // Update tool icon to ensure SVG/FA consistency
                    const toolContainer = btn.closest('.panel');
                    if (toolContainer) {
                        const iconContainer = toolContainer.querySelector('.w-12.h-12');
                        if (iconContainer) {
                            iconContainer.innerHTML = ui.getIconHtml(TOOLS_DB[key].icon, 'w-6 h-6');
                        }
                    }
                });
            },

            buyOrUpgradeTool: function(key) {
                const state = gameState.tools[key];
                const max = this.toolMaxLevel[key] || 99;
                if (state && state.owned && state.level >= max) {
                    ui.showFloatText(event.target, "Максимальный уровень", "#777");
                    return;
                }
                const price = this.getToolPrice(key);
                if (gameState.gold >= price) {
                    const nextWeight = !gameState.tools[key].owned ? (TOOL_WEIGHTS[key] || 0) : 0;
                    if (!game.hasWeightCapacity(nextWeight)) {
                        game.showWeightWarning(event.target);
                        return;
                    }
                    gameState.gold -= price;
                    if (!gameState.tools[key].owned) {
                        gameState.tools[key].owned = true;
                        gameState.tools[key].level = 1;
                        ui.showFloatText(event.target, "Куплено!", "#34d399");
                    } else {
                        gameState.tools[key].level++;
                        ui.showFloatText(event.target, "Улучшено!", "#34d399");
                    }
                    // Quest Progress
                    quests.onEvent('upgrade', key, 1);
                    
                    game.save();
                    ui.updateAll();
                } else {
                    ui.showFloatText(event.target, "Не хватает золота", "#ff5555");
                }
            },

            buySword: function(swordId) {
                const sword = SWORDS_DB[swordId];
                if (!sword) return;

                // Check if already owned
                if (!gameState.ownedSwords) gameState.ownedSwords = [];
                if (gameState.ownedSwords.includes(swordId)) {
                    ui.showFloatText(event.target, "Уже куплено!", "#777");
                    return;
                }

                // Check cost
                if (sword.costType === 'gold') {
                    if (gameState.gold < sword.cost) {
                        ui.showFloatText(event.target, "Не хватает золота", "#ff5555");
                        return;
                    }
                    gameState.gold -= sword.cost;
                } else {
                    if (gameState.emeralds < sword.cost) {
                        ui.showFloatText(event.target, "Не хватает изумрудов", "#ff5555");
                        return;
                    }
                    gameState.emeralds -= sword.cost;
                }

                gameState.ownedSwords.push(swordId);
                // Legacy compat
                gameState.currentSword = swordId;
                game.save();
                ui.updateStats();
                inventory.render();
                ui.showFloatText(event.target, `${sword.name} куплен! Экипируйте в инвентаре.`, "#34d399");
                market.renderWeapons();
            },

            buyArmor: function(armorId) {
                const armor = ARMOR_DB[armorId];
                if (!armor) return;

                // Check if already owned
                if (!gameState.ownedArmor) gameState.ownedArmor = [];
                if (gameState.ownedArmor.includes(armorId)) {
                    ui.showFloatText(event.target, "Уже куплено!", "#777");
                    return;
                }

                // Check cost
                if (armor.costType === 'gold') {
                    if (gameState.gold < armor.cost) {
                        ui.showFloatText(event.target, "Не хватает золота", "#ff5555");
                        return;
                    }
                    gameState.gold -= armor.cost;
                } else {
                    if (gameState.emeralds < armor.cost) {
                        ui.showFloatText(event.target, "Не хватает изумрудов", "#ff5555");
                        return;
                    }
                    gameState.emeralds -= armor.cost;
                }

                gameState.ownedArmor.push(armorId);
                // Legacy compat
                gameState.currentArmor = armorId;
                game.save();
                ui.updateStats();
                inventory.render();
                ui.showFloatText(event.target, `${armor.name} куплена! Экипируйте в инвентаре.`, "#34d399");
                market.renderArmor();
            },

            renderWeapons: function() {
                if (!gameState.ownedSwords) gameState.ownedSwords = [];
                document.querySelectorAll('#market-weapons [data-sword]').forEach(card => {
                    const id = card.dataset.sword;
                    const area = card.querySelector('.market-buy-area');
                    if (!area) return;
                    if (gameState.ownedSwords.includes(id)) {
                        area.innerHTML = '<span class="text-xs text-[#6c9fff] font-serif italic">Куплено</span>';
                    }
                });
            },

            renderArmor: function() {
                if (!gameState.ownedArmor) gameState.ownedArmor = [];
                document.querySelectorAll('#market-armor [data-armor]').forEach(card => {
                    const id = card.dataset.armor;
                    const area = card.querySelector('.market-buy-area');
                    if (!area) return;
                    if (gameState.ownedArmor.includes(id)) {
                        area.innerHTML = '<span class="text-xs text-[#6c9fff] font-serif italic">Куплено</span>';
                    }
                });
            },

            ensureWeightCapacity: function(extraWeight) {
                if (!game.hasWeightCapacity(extraWeight)) {
                    game.showWeightWarning(document.body);
                    return false;
                }
                return true;
            },

            ensureWeightCapacityForItem: function(itemKey, count = 1) {
                const extraWeight = (RESOURCE_WEIGHTS[itemKey] || 0) * count;
                return this.ensureWeightCapacity(extraWeight);
            },

            buyClothes: function(type, cost) {
                if (type === 'noble' && gameState.emeralds < cost) {
                    ui.showFloatText(event.target, "Не хватает изумрудов", "#ff5555");
                    return;
                }
                if (type !== 'noble' && gameState.gold < cost) {
                    ui.showFloatText(event.target, "Не хватает золота", "#ff5555");
                    return;
                }
                
                if (type === 'noble') {
                    gameState.emeralds -= cost;
                } else {
                    gameState.gold -= cost;
                }
                
                gameState.clothes = gameState.clothes || {};
                gameState.clothes[type] = true;
                game.save();
                ui.updateStats();
                ui.showFloatText(event.target, "Одежда куплена!", "#34d399");
                game.gainReputationForClothes(type, event.target);
            },

            tradeMode: 'sell',

            setMax: function(resType) {
                const count = gameState[resType] || 0;
                const input = document.getElementById(`trade-input-${resType}`);
                if(input) input.value = count > 0 ? count : 1;
            },

            sellFromInput: function(resType) {
                const input = document.getElementById(`trade-input-${resType}`);
                let amount = parseInt(input.value);
                if (isNaN(amount) || amount <= 0) return;
                this.sellResource(resType, amount);
            },

            buyFromInput: function(resType) {
                const input = document.getElementById(`trade-input-${resType}`);
                let amount = parseInt(input.value);
                if (isNaN(amount) || amount <= 0) return;
                this.buyResource(resType, amount);
            },

            getResourcePrice: function(resType) {
                return this.resourcePrices[resType] || 0;
            },

            buyResource: function(resType, amount) {
                const price = this.getResourcePrice(resType);
                if (price === 0) return;
                const totalCost = price * 2 * amount;
                if (amount <= 0) {
                    ui.showFloatText(event.target, "Введите количество", "#ff5555");
                    return;
                }
                if (gameState.gold >= totalCost) {
                    const extraWeight = (RESOURCE_WEIGHTS[resType] || 0) * amount;
                    if (!game.hasWeightCapacity(extraWeight)) {
                        game.showWeightWarning(event.target);
                        return;
                    }
                    gameState.gold -= totalCost;
                    gameState[resType] = (gameState[resType] || 0) + amount;
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(event.target, `-${totalCost} Золота`, "#ff5555");
                } else {
                    ui.showFloatText(event.target, "Не хватает золота", "#ff5555");
                }
            },

            canAddWeight: function(resType, amount) {
                const extraWeight = (RESOURCE_WEIGHTS[resType] || 0) * amount;
                return game.hasWeightCapacity(extraWeight);
            },

            canAddTool: function(toolKey) {
                return game.hasWeightCapacity(TOOL_WEIGHTS[toolKey] || 0);
            },

            canAddWeight: function(resType, amount) {
                const extraWeight = (RESOURCE_WEIGHTS[resType] || 0) * amount;
                return game.hasWeightCapacity(extraWeight);
            },

            canAddTool: function(toolKey) {
                return game.hasWeightCapacity(TOOL_WEIGHTS[toolKey] || 0);
            },

            switchTradeMode: function(mode) {
                this.tradeMode = mode;
                const sellTab = document.getElementById('market-trade-sell');
                const buyTab = document.getElementById('market-trade-buy');
                if (sellTab && buyTab) {
                    sellTab.classList.toggle('active', mode === 'sell');
                    buyTab.classList.toggle('active', mode === 'buy');
                }

                const resourceList = Object.keys(RESOURCE_NAMES);
                resourceList.forEach(resource => {
                    const btn = document.getElementById(`btn-trade-${resource}`);
                    if (btn) {
                        if (mode === 'sell') {
                            btn.innerText = 'Продать';
                            btn.onclick = () => this.sellFromInput(resource);
                        } else {
                            btn.innerText = 'Купить';
                            btn.onclick = () => this.buyFromInput(resource);
                        }
                    }
                });
                this.updateTradePrices();
            },

            updateTradePrices: function() {
                const resourceList = Object.keys(RESOURCE_NAMES);
                resourceList.forEach(resource => {
                    const priceEl = document.getElementById(`price-${resource}`);
                    if (priceEl) {
                        const base = this.getResourcePrice(resource);
                        const price = this.tradeMode === 'buy' ? base * 2 : base;
                        priceEl.innerText = price;
                    }
                });
            },

            sellResource: function(resType, amount) {
                const price = this.getResourcePrice(resType);
                if (price === 0) return;

                const current = gameState[resType] || 0;
                if (amount === -1) amount = current;

                if (amount <= 0) {
                     ui.showFloatText(event.target, "Нечего продавать", "#ff5555");
                     return;
                }

                if (current >= amount) {
                    gameState[resType] -= amount;
                    const totalGain = amount * price;
                    gameState.gold += totalGain;
                    
                    // Quest Progress
                    quests.onEvent('sell', resType, amount);

                    game.save();
                    ui.updateStats();
                    ui.showFloatText(event.target, `+${totalGain} Золота`, "#c8aa6e");
                } else {
                    ui.showFloatText(event.target, "Не хватает ресурсов", "#ff5555");
                }
            }
        };

        // --- HOUSING CONTROLLER ---
        const housing = {
            buyPoorHouse: function() {
                if (gameState.emeralds >= 500) {
                    gameState.emeralds -= 500;
                    gameState.hasPoorHouse = true;
                    game.save();
                    ui.updateStats();
                    this.updateUI();
                    ui.showFloatText(event.target, "Дом куплен!", "#fbbf24");
                } else {
                    ui.showFloatText(event.target, "Нужно 500 изумрудов", "#ff5555");
                }
            },
            
            buyNobleHouse: function() {
                if (gameState.emeralds >= 10000) {
                    gameState.emeralds -= 10000;
                    gameState.hasNobleHouse = true;
                    game.save();
                    ui.updateStats();
                    this.updateUI();
                    ui.showFloatText(event.target, "Особняк куплен!", "#fbbf24");
                } else {
                    ui.showFloatText(event.target, "Нужно 10,000 изумрудов", "#ff5555");
                }
            },
            
            updateUI: function() {
                // Poor House
                const poorBuy = document.getElementById('poor-house-buy');
                const poorOwned = document.getElementById('poor-house-owned');
                if (poorBuy && poorOwned) {
                    if (gameState.hasPoorHouse) {
                        poorBuy.classList.add('hidden');
                        poorOwned.classList.remove('hidden');
                    } else {
                        poorBuy.classList.remove('hidden');
                        poorOwned.classList.add('hidden');
                    }
                }
                
                // Noble House
                const nobleBuy = document.getElementById('noble-house-buy');
                const nobleOwned = document.getElementById('noble-house-owned');
                if (nobleBuy && nobleOwned) {
                    if (gameState.hasNobleHouse) {
                        nobleBuy.classList.add('hidden');
                        nobleOwned.classList.remove('hidden');
                    } else {
                        nobleBuy.classList.remove('hidden');
                        nobleOwned.classList.add('hidden');
                    }
                }
            }
        };

        // --- VILLAGE CONTROLLER ---
        const village = {
            buyHouse: function() {
                if (gameState.emeralds >= 1000) {
                    gameState.emeralds -= 1000;
                    gameState.hasHouse = true;
                    game.save();
                    ui.updateStats();
                    this.updateUI();
                    ui.showFloatText(event.target, "Дом куплен!", "#fbbf24");
                    game.addReputation(6, event.target);
                } else {
                    ui.showFloatText(event.target, "Нужно 1000 изумрудов", "#ff5555");
                }
            },

            updateUI: function() {
                const houseOwned = document.getElementById('house-owned');
                const houseNotOwned = document.getElementById('house-not-owned');
                const houseStatus = document.getElementById('house-status');
                const pigLevel = document.getElementById('pig-pen-level');
                const meatCount = document.getElementById('meat-count');
                const measlesWarning = document.getElementById('measles-warning');
                const cureSection = document.getElementById('cure-measles-section');
                
                // Stable elements
                const stableLevel = document.getElementById('stable-level');
                const stableEmpty = document.getElementById('stable-empty');
                const stableOccupied = document.getElementById('stable-occupied');
                const horseName = document.getElementById('horse-name');
                const horseIcon = document.getElementById('horse-icon');
                const horseDesc = document.getElementById('horse-desc');
                
                if (gameState.hasHouse) {
                    if(houseOwned) houseOwned.classList.remove('hidden');
                    if(houseNotOwned) houseNotOwned.classList.add('hidden');
                    if(houseStatus) houseStatus.innerText = "Ваш";
                    if(houseStatus) houseStatus.className = "text-[10px] text-green-400";
                } else {
                    if(houseOwned) houseOwned.classList.add('hidden');
                    if(houseNotOwned) houseNotOwned.classList.remove('hidden');
                    if(houseStatus) houseStatus.innerText = "Не куплен";
                    if(houseStatus) houseStatus.className = "text-[10px] text-red-400";
                }
                
                if(pigLevel) pigLevel.innerText = gameState.pigPenLevel || 0;
                if(meatCount) meatCount.innerText = gameState.meat || 0;
                
                // Stable Update
                if (stableLevel) stableLevel.innerText = gameState.stableLevel || 0;
                
                if (gameState.horse) {
                    if (stableEmpty) stableEmpty.classList.add('hidden');
                    if (stableOccupied) stableOccupied.classList.remove('hidden');
                    
                    const horse = HORSES_DB[gameState.horse];
                    if (horse) {
                        if (horseName) horseName.innerText = horse.name;
                        if (horseDesc) horseDesc.innerText = horse.desc;
                        if (horseIcon) horseIcon.className = `fas ${horse.icon}`;
                    }
                } else {
                    if (stableEmpty) stableEmpty.classList.remove('hidden');
                    if (stableOccupied) stableOccupied.classList.add('hidden');
                }

                if (gameState.hasMeasles) {
                    if(measlesWarning) measlesWarning.classList.remove('hidden');
                    if(cureSection) cureSection.classList.remove('hidden');
                } else {
                    if(measlesWarning) measlesWarning.classList.add('hidden');
                    if(cureSection) cureSection.classList.add('hidden');
                }
            },

            upgradePigPen: function() {
                const cost = (gameState.pigPenLevel + 1) * 100;
                if (gameState.gold >= cost) {
                    gameState.gold -= cost;
                    gameState.pigPenLevel++;
                    game.save();
                    ui.updateStats();
                    this.updateUI();
                    ui.showFloatText(event.target, "Свинарник улучшен!", "#ec4899");
                } else {
                    ui.showFloatText(event.target, "Не хватает золота", "#ff5555");
                }
            },
            
            upgradePigPen: function() {
                const cost = (gameState.pigPenLevel + 1) * 100;
                if (gameState.gold >= cost) {
                    gameState.gold -= cost;
                    gameState.pigPenLevel++;
                    game.save();
                    ui.updateStats();
                    this.updateUI();
                    ui.showFloatText(event.target, "Свинарник улучшен!", "#ec4899");
                } else {
                    ui.showFloatText(event.target, "Не хватает золота", "#ff5555");
                }
            },
            
            upgradeStable: function() {
                const currentLevel = gameState.stableLevel || 0;
                const cost = (currentLevel + 1) * 2000;
                
                if (gameState.gold >= cost) {
                    gameState.gold -= cost;
                    gameState.stableLevel = (gameState.stableLevel || 0) + 1;
                    game.save();
                    ui.updateStats();
                    this.updateUI();
                    ui.showFloatText(event.target, "Конюшня улучшена!", "#ec4899");
                } else {
                    ui.showFloatText(event.target, `Нужно ${cost} золота`, "#ff5555");
                }
            },

            collectMeat: function() {
                if (gameState.pigPenLevel < 1) {
                    ui.showFloatText(event.target, "Сначала постройте свинарник", "#ff5555");
                    return;
                }
                
                const now = Date.now();
                const timePassed = now - (gameState.lastMeatCollect || 0);
                const hoursPass = timePassed / 3600000;
                const meatGain = Math.floor(hoursPass * gameState.pigPenLevel);
                
                if (meatGain > 0) {
                    const extraWeight = (RESOURCE_WEIGHTS.meat || 0) * meatGain;
                    if (!game.hasWeightCapacity(extraWeight)) {
                        game.showWeightWarning(event.target);
                        return;
                    }
                    gameState.meat = (gameState.meat || 0) + meatGain;
                    gameState.lastMeatCollect = now;
                    game.save();
                    this.updateUI();
                    ui.showFloatText(event.target, `+${meatGain} Мяса`, "#ec4899");
                } else {
                    ui.showFloatText(event.target, "Подождите ещё", "#777");
                }
            },
            
            buyBread: function(event) {
                if (gameState.gold >= 20) {
                    gameState.gold -= 20;
                    const hungerRestore = Math.floor(gameState.maxHunger * 0.2); // 20% от максимального голода
                    gameState.hunger = Math.min(gameState.maxHunger, gameState.hunger + hungerRestore);
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(event.target, `+${hungerRestore} Сытость!`, "#fbbf24");
                } else {
                    ui.showFloatText(event.target, "Нужно 20 золота", "#ff5555");
                }
            },
            
            cureMeasles: function() {
                if (!gameState.hasMeasles) {
                    ui.showFloatText(event.target, "Вы здоровы", "#34d399");
                    return;
                }
                
                if (gameState.herbs >= 15 && gameState.mushrooms >= 10) {
                    gameState.herbs -= 15;
                    gameState.mushrooms -= 10;
                    gameState.hasMeasles = false;
                    game.save();
                    ui.updateStats();
                    this.updateUI();
                    ui.showFloatText(event.target, "Вы исцелены!", "#34d399");
                } else {
                    ui.showFloatText(event.target, "Нужно 15 трав и 10 грибов", "#ff5555");
                }
            },
            
            updateUI: function() {
                const houseOwned = document.getElementById('house-owned');
                const houseNotOwned = document.getElementById('house-not-owned');
                const houseStatus = document.getElementById('house-status');
                const pigLevel = document.getElementById('pig-pen-level');
                const meatCount = document.getElementById('meat-count');
                const measlesWarning = document.getElementById('measles-warning');
                const cureSection = document.getElementById('cure-measles-section');
                
                if (gameState.hasHouse) {
                    if(houseOwned) houseOwned.classList.remove('hidden');
                    if(houseNotOwned) houseNotOwned.classList.add('hidden');
                    if(houseStatus) houseStatus.innerText = "Ваш";
                    if(houseStatus) houseStatus.className = "text-[10px] text-green-400";
                } else {
                    if(houseOwned) houseOwned.classList.add('hidden');
                    if(houseNotOwned) houseNotOwned.classList.remove('hidden');
                    if(houseStatus) houseStatus.innerText = "Не куплен";
                    if(houseStatus) houseStatus.className = "text-[10px] text-red-400";
                }
                
                if(pigLevel) pigLevel.innerText = gameState.pigPenLevel || 0;
                if(meatCount) meatCount.innerText = gameState.meat || 0;
                
                if (gameState.hasMeasles) {
                    if(measlesWarning) measlesWarning.classList.remove('hidden');
                    if(cureSection) cureSection.classList.remove('hidden');
                } else {
                    if(measlesWarning) measlesWarning.classList.add('hidden');
                    if(cureSection) cureSection.classList.add('hidden');
                }
            }
        };

        // --- ARTHUR'S SHOP CONTROLLER ---
        const arthurShop = {
            buyPotion: function(type, event) {
                const cost = 100;
                if (gameState.emeralds < cost) {
                    ui.showFloatText(event.target, "Нужно 100 изумрудов", "#ff5555");
                    return;
                }
                
                gameState.emeralds -= cost;
                
                // Apply potion effect
                if (!gameState.activeEffects) gameState.activeEffects = {};
                const duration = 5 * 60 * 1000; // 5 minutes
                const expiresAt = Date.now() + duration;
                
                if (type === 'xp') {
                    gameState.activeEffects.xpBoost = expiresAt;
                    ui.showFloatText(event.target, "х2 Опыт на 5 минут!", "#3b82f6");
                } else if (type === 'strength') {
                    gameState.activeEffects.strengthBoost = expiresAt;
                    ui.showFloatText(event.target, "х2 Урон на 5 минут!", "#ef4444");
                }
                
                game.save();
                ui.updateStats();
                this.startEffectTimers();
            },
            
            completeHerbQuest: function(event) {
                if (gameState.herbs < 100) {
                    ui.showFloatText(event.target, "Нужно 100 трав", "#ff5555");
                    return;
                }
                
                gameState.herbs -= 100;
                
                // Permanently increase damage
                if (!gameState.permanentStats) gameState.permanentStats = {};
                gameState.permanentStats.bonusDamage = (gameState.permanentStats.bonusDamage || 0) + 5;
                
                // Mark quest as complete
                if (!gameState.npcStates) gameState.npcStates = {};
                gameState.npcStates.arthurHerbsComplete = true;
                
                game.save();
                ui.updateStats();
                ui.showFloatText(event.target, "+5 Урона навсегда!", "#10b981");
                
                // Update UI
                this.updateHerbQuestUI();
            },
            
            updateHerbQuestUI: function() {
                const countEl = document.getElementById('arthur-herbs-count');
                const btnEl = document.getElementById('btn-arthur-herbs');
                const questEl = document.getElementById('arthur-quest-herbs');
                
                if (!countEl || !btnEl || !questEl) return;
                
                // Check if quest is complete
                if (gameState.npcStates && gameState.npcStates.arthurHerbsComplete) {
                    questEl.innerHTML = `
                        <div class="text-center py-2">
                            <i class="fas fa-check-circle text-green-400 text-2xl mb-2"></i>
                            <div class="text-sm text-green-300">Задание выполнено!</div>
                            <div class="text-xs text-gray-400">+5 урона получено</div>
                        </div>
                    `;
                    return;
                }
                
                // Update count
                countEl.textContent = gameState.herbs || 0;
                
                // Update button
                if (gameState.herbs >= 100) {
                    btnEl.disabled = false;
                    btnEl.classList.remove('opacity-50');
                } else {
                    btnEl.disabled = true;
                    btnEl.classList.add('opacity-50');
                }
            },
            
            startEffectTimers: function() {
                if (this._effectInterval) return;
                
                this._effectInterval = setInterval(() => {
                    if (!gameState.activeEffects) return;
                    
                    const now = Date.now();
                    
                    // Remove expired effects
                    if (gameState.activeEffects.xpBoost && gameState.activeEffects.xpBoost <= now) {
                        delete gameState.activeEffects.xpBoost;
                        game.save();
                    }
                    if (gameState.activeEffects.strengthBoost && gameState.activeEffects.strengthBoost <= now) {
                        delete gameState.activeEffects.strengthBoost;
                        game.save();
                    }
                }, 1000);
            }
        };

        // --- LIVESTOCK FARM CONTROLLER ---
        const livestockFarm = {
            animals: {
                chicken: { feedCost: 5, cooldown: 4 * 60 * 60 * 1000, rewards: { gold: 15, items: ['eggs', 'meat'] } },
                cow: { feedCost: 10, cooldown: 4 * 60 * 60 * 1000, rewards: { gold: 30, items: ['milk', 'leather'] } },
                pig: { feedCost: 8, cooldown: 4 * 60 * 60 * 1000, rewards: { gold: 20, items: ['meat'] } },
                rabbit: { feedCost: 3, cooldown: 4 * 60 * 60 * 1000, rewards: { gold: 10, items: ['meat', 'leather'] } }
            },

            tryOpen: function() {
                if (gameState.level >= 10) {
                    router.navigate('livestock-farm');
                } else {
                    ui.showFloatText(document.body, `Требуется 10 уровень (сейчас ${gameState.level})`, "#ff5555");
                }
            },

            updateButtonUI: function() {
                const button = document.getElementById('livestock-farm-button');
                const icon = document.getElementById('livestock-farm-icon');
                const title = document.getElementById('livestock-farm-title');
                const subtitle = document.getElementById('livestock-farm-subtitle');
                const status = document.getElementById('livestock-farm-status');
                
                if (!button || !icon || !title || !subtitle || !status) return;
                
                if (gameState.level >= 10) {
                    // Unlocked state - green style like bulletin board
                    button.className = 'panel w-full p-4 rounded-lg flex items-center justify-between group hover:border-green-500 transition-colors bg-black/30 backdrop-blur-sm';
                    icon.className = 'w-14 h-14 rounded-full bg-gradient-to-br from-green-900/60 to-green-950 border-2 border-green-500/60 flex items-center justify-center shadow-[0_0_15px_rgba(34,197,94,0.3)]';
                    icon.querySelector('i').className = 'fas fa-cow text-green-400 text-2xl';
                    title.className = 'text-base font-bold text-green-300 medieval-font';
                    subtitle.className = 'text-xs text-green-600/80';
                    status.innerHTML = '<i class="fas fa-chevron-right text-gray-500 group-hover:text-green-500 text-xl"></i>';
                } else {
                    // Locked state - gray with lock
                    button.className = 'panel w-full p-4 rounded-lg flex items-center justify-between group transition-colors bg-black/30 backdrop-blur-sm opacity-60';
                    icon.className = 'w-14 h-14 rounded-full bg-gradient-to-br from-gray-800/60 to-gray-950 border-2 border-gray-600/60 flex items-center justify-center shadow-[0_0_15px_rgba(107,114,128,0.2)]';
                    icon.querySelector('i').className = 'fas fa-cow text-gray-500 text-2xl';
                    title.className = 'text-base font-bold text-gray-400 medieval-font';
                    subtitle.className = 'text-xs text-gray-600';
                    status.innerHTML = '<i class="fas fa-lock text-gray-500 mr-2"></i><span class="text-xs text-gray-500">Ур. 10</span>';
                }
            },

            feedAnimal: function(animalType, event) {
                if (!gameState.livestockFeeding) gameState.livestockFeeding = {};
                
                const animal = this.animals[animalType];
                const now = Date.now();
                const lastFed = gameState.livestockFeeding[animalType] || 0;
                
                // Check cooldown
                if (now - lastFed < animal.cooldown) {
                    const remaining = animal.cooldown - (now - lastFed);
                    const hours = Math.floor(remaining / 3600000);
                    const mins = Math.floor((remaining % 3600000) / 60000);
                    ui.showFloatText(event.target, `Подождите ${hours}ч ${mins}м`, "#ff5555");
                    return;
                }
                
                // Check if player has feed (using grain as feed)
                if (!gameState.feed || gameState.feed < animal.feedCost) {
                    ui.showFloatText(event.target, `Нужно ${animal.feedCost} корма`, "#ff5555");
                    return;
                }
                
                // Feed the animal
                gameState.feed -= animal.feedCost;
                gameState.livestockFeeding[animalType] = now;
                
                // Give rewards
                gameState.gold += animal.rewards.gold;
                
                let rewardText = `+${animal.rewards.gold} золота`;
                animal.rewards.items.forEach(item => {
                    const amount = Math.floor(Math.random() * 2) + 1; // 1-2 items
                    gameState[item] = (gameState[item] || 0) + amount;
                    rewardText += ` +${amount} ${RESOURCE_NAMES[item]?.name || item}`;
                });
                
                game.save();
                ui.updateStats();
                ui.showFloatText(event.target, rewardText, "#34d399");
                this.updateUI();
            },
            
            updateUI: function() {
                if (!gameState.livestockFeeding) gameState.livestockFeeding = {};
                const now = Date.now();
                
                Object.keys(this.animals).forEach(animalType => {
                    const lastFed = gameState.livestockFeeding[animalType] || 0;
                    const animal = this.animals[animalType];
                    const timerEl = document.getElementById(`${animalType}-feed-time`);
                    const btnEl = document.getElementById(`btn-feed-${animalType}`);
                    
                    if (!timerEl || !btnEl) return;
                    
                    const remaining = animal.cooldown - (now - lastFed);
                    
                    if (remaining > 0) {
                        const hours = Math.floor(remaining / 3600000);
                        const mins = Math.floor((remaining % 3600000) / 60000);
                        const secs = Math.floor((remaining % 60000) / 1000);
                        timerEl.textContent = `${String(hours).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
                        btnEl.disabled = true;
                        btnEl.classList.add('opacity-50');
                    } else {
                        timerEl.textContent = 'Готово!';
                        timerEl.classList.add('text-green-400');
                        btnEl.disabled = false;
                        btnEl.classList.remove('opacity-50');
                    }
                });
            },
            
            startTimers: function() {
                if (this._interval) return;
                this._interval = setInterval(() => {
                    this.updateUI();
                }, 1000);
            }
        };

        // Function to complete Hank's amulet quest
        function completeHankQuest() {
            if (gameState.npcStates && gameState.npcStates.hankAmuletFound && 
                !gameState.npcStates.hankAmuletComplete) {
                gameState.npcStates.hankAmuletComplete = true;
                gameState.emeralds += 10;
                game.save();
                ui.updateStats();
                ui.showFloatText(document.body, "+10 Изумрудов!", "#34d399");
                ui.showFloatText(document.body, "Квест завершён!", "#fbbf24");
            }
        }

        // --- POOR DISTRICT CONTROLLER ---
        const poorDistrict = {
            buyBread: function(event) {
                if (gameState.gold >= 20) {
                    gameState.gold -= 20;
                    const hungerRestore = Math.floor(gameState.maxHunger * 0.2); // 20% от максимального голода
                    gameState.hunger = Math.min(gameState.maxHunger, gameState.hunger + hungerRestore);
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(event.target, `+${hungerRestore} Сытость!`, "#fbbf24");
                } else {
                    ui.showFloatText(event.target, "Нужно 20 золота", "#ff5555");
                }
            },
            
            getMskDayKey: function(ts) {
                return Math.floor((ts + 3 * 60 * 60 * 1000) / 86400000);
            },
            
            getNextResetTs: function(nowTs = Date.now()) {
                const next = new Date(nowTs);
                next.setUTCHours(21, 0, 0, 0); // 00:00 MSK
                if (nowTs >= next.getTime()) {
                    next.setUTCDate(next.getUTCDate() + 1);
                }
                return next.getTime();
            },
            
            eatCanteen: function(event) {
                if (!gameState.npcStates) gameState.npcStates = {};
                const btn = document.getElementById('btn-poor-canteen');
                
                if (gameState.level > 7) {
                    ui.showFloatText(event.target, "Доступно до 7 уровня", "#ff5555");
                    return;
                }
                
                const today = this.getMskDayKey(Date.now());
                const lastDay = gameState.npcStates.poorCanteenDay || -1;
                if (lastDay === today) {
                    const leftMs = this.getNextResetTs() - Date.now();
                    const h = Math.floor(leftMs / 3600000);
                    const m = Math.floor((leftMs % 3600000) / 60000);
                    ui.showFloatText(event.target, `Уже поел. До следующего: ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`, "#777");
                    return;
                }
                
                const restore = Math.floor(gameState.maxHunger * 0.5);
                gameState.hunger = Math.min(gameState.maxHunger, gameState.hunger + restore);
                gameState.npcStates.poorCanteenDay = today;
                game.save();
                ui.updateStats();
                ui.showFloatText(event.target, `+${restore} Сытость!`, "#34d399");
                this.updateUI();
            },
            
            startCanteenTimer: function() {
                if (this._timerInterval) return;
                this._timerInterval = setInterval(() => {
                    const el = document.getElementById('poor-canteen-timer');
                    if (!el) return;
                    const nowTs = Date.now();
                    const nextTs = this.getNextResetTs(nowTs);
                    let diff = Math.max(0, nextTs - nowTs);
                    const h = Math.floor(diff / 3600000);
                    diff %= 3600000;
                    const m = Math.floor(diff / 60000);
                    diff %= 60000;
                    const s = Math.floor(diff / 1000);
                    el.innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                }, 1000);
            },
            
            updateUI: function() {
                const btn = document.getElementById('btn-poor-canteen');
                if (!btn) return;
                btn.disabled = false;
                btn.innerText = "Поесть";
                
                if (gameState.level > 7) {
                    btn.disabled = true;
                    btn.innerText = "Недоступно";
                } else if (gameState.npcStates && this.getMskDayKey(Date.now()) === (gameState.npcStates.poorCanteenDay || -1)) {
                    btn.disabled = true;
                    btn.innerText = "Уже сегодня";
                }
            }
        };

        // --- BULLETIN BOARD CONTROLLER ---
        const bulletin = {
            quests: {
                fish_delivery: { id: 'fish_delivery', title: 'Рыба для таверны', target: 'fish', count: 10, reward: { gold: 100, xp: 15 } },
                herbs_delivery: { id: 'herbs_delivery', title: 'Травы для лекаря', target: 'herbs', count: 8, reward: { gold: 80, xp: 10 } },
                ore_delivery: { id: 'ore_delivery', title: 'Руда для кузнеца', target: 'ore', count: 5, reward: { gold: 200, xp: 25 } }
            },
            
            acceptQuest: function(questId) {
                const quest = this.quests[questId];
                if (!quest) return;
                
                // Check if already have this quest
                if (hasStoryQuest('bulletin_' + questId)) {
                    ui.showFloatText(event.target, "Уже взято", "#ff5555");
                    return;
                }
                
                // Check if player has enough resources to complete immediately
                const hasResources = gameState[quest.target] >= quest.count;
                
                if (hasResources) {
                    // Complete immediately
                    gameState[quest.target] -= quest.count;
                    gameState.gold += quest.reward.gold;
                    game.addXp(quest.reward.xp);
                    game.save();
                    ui.updateStats();
                    ui.showFloatText(event.target, `+${quest.reward.gold} Золота +${quest.reward.xp} XP`, "#fbbf24");
                    game.addReputation(2, event.target);
                } else {
                    // Add as story quest
                    dialogue.addQuest(
                        'bulletin_' + questId,
                        quest.title,
                        `Принести ${quest.count} ${RESOURCE_NAMES[quest.target].name}`,
                        { type: 'gather', target: quest.target, count: quest.count },
                        quest.reward
                    );
                }
            },
            
            takeLilyBook: function() {
                // Проверяем что квест активен
                if (!gameState.npcStates || !gameState.npcStates.lilyQuestActive) {
                    ui.showFloatText(event.target, "Что это за книга?", "#777");
                    return;
                }
                
                // Проверяем что уже не взяли
                if (gameState.lilyBook) {
                    ui.showFloatText(event.target, "Уже есть", "#777");
                    return;
                }
                
                // Забираем 100 золота и даем книгу
                if (gameState.gold < 100) {
                    ui.showFloatText(event.target, "Нужно 100 золота", "#ff5555");
                    return;
                }
                
                gameState.gold -= 100;
                gameState.lilyBook = true;
                game.save();
                ui.updateStats();
                
                // Скрываем задание
                const questEl = document.getElementById('lily-book-quest');
                if (questEl) questEl.classList.add('hidden');
                
                ui.showFloatText(event.target, "Книга получена! Отнеси её Лили", "#ec4899");
            }
        };

        // --- DISEASE SYSTEM ---
        const disease = {
            startTick: function() {
                setInterval(() => {
                    if (gameState.hasMeasles && gameState.hp > 1) {
                        const now = Date.now();
                        if (now - (gameState.lastMeaslesTick || 0) >= 20000) {
                            gameState.hp = Math.max(1, gameState.hp - 1);
                            gameState.lastMeaslesTick = now;
                            game.save();
                            ui.updateStats();
                        }
                    }
                }, 1000);
            },
            
            tryInfect: function() {
                // 1% chance to get measles in the forest
                if (!gameState.hasMeasles && Math.random() < 0.01) {
                    gameState.hasMeasles = true;
                    gameState.lastMeaslesTick = Date.now();
                    game.save();
                    
                    // Show modal window
                    const modal = document.getElementById('modal-measles-infected');
                    if (modal) {
                        modal.classList.add('open');
                    }
                    
                    village.updateUI();
                }
            }
        };

        // --- SKILLS CONTROLLER ---
        const HORSES_DB = {
            'arabian': { name: 'Арабский скакун', price: 150000, speed: 1.5, carry: 20, desc: 'Быстрая и выносливая лошадь. Увеличивает скорость путешествий.', icon: 'fa-horse' },
            'thoroughbred': { name: 'Чистокровная', price: 120000, speed: 1.4, carry: 15, desc: 'Рождена для скачек. Очень быстрая.', icon: 'fa-horse-head' },
            'draft': { name: 'Тяжеловоз', price: 80000, speed: 0.8, carry: 100, desc: 'Мощная лошадь для перевозки грузов. Сильно увеличивает переносимый вес.', icon: 'fa-weight-hanging' },
            'pony': { name: 'Пони', price: 30000, speed: 1.0, carry: 10, desc: 'Маленькая лошадка. Недорогая и неприхотливая.', icon: 'fa-horse' },
            'mustang': { name: 'Мустанг', price: 90000, speed: 1.3, carry: 25, desc: 'Дикая и своенравная. Хороша в дальних переходах.', icon: 'fa-wind' },
            'warhorse': { name: 'Боевой конь', price: 250000, speed: 1.2, carry: 40, desc: 'Тренированная для битв. Повышает авторитет.', icon: 'fa-chess-knight' }
        };

        // --- HUNTER'S HUT CONTROLLER ---
        const hunterHut = {
            buyAmulet: function(type, event) {
                const prices = {
                    xp: 200,
                    gathering: 400
                };
                
                const names = {
                    xp: "Амулет опыта",
                    gathering: "Амулет добычи"
                };
                
                const bonuses = {
                    xp: "+50% к получаемому опыту",
                    gathering: "+50% к добыче материалов"
                };
                
                const price = prices[type];
                
                if (!gameState.amulets) gameState.amulets = {};
                
                // Check if already owned
                if (gameState.amulets[type] && gameState.amulets[type].owned) {
                    ui.showFloatText(event.target, "Уже куплен!", "#ff5555");
                    return;
                }
                
                // Check emeralds
                if (gameState.emeralds < price) {
                    ui.showFloatText(event.target, "Не хватает изумрудов", "#ff5555");
                    return;
                }
                
                // Purchase
                gameState.emeralds -= price;
                gameState.amulets[type] = {
                    owned: true,
                    name: names[type],
                    bonus: bonuses[type]
                };
                
                game.save();
                ui.updateStats();
                ui.showFloatText(event.target, `Куплен: ${names[type]}!`, "#10b981");
                
                // Update button
                event.target.textContent = "Куплен";
                event.target.disabled = true;
                event.target.classList.add('opacity-50');
            }
        };

        // --- REFUGEE CAMP CONTROLLER ---
        const refugeeCamp = {
            startEscort: function(event) {
                // Check if has any sword
                const hasSword = gameState.ownedSwords && gameState.ownedSwords.length > 0;
                if (!hasSword) {
                    ui.showFloatText(event.target, "Требуется меч!", "#ff5555");
                    return;
                }
                
                // Check cooldown (3 hours = 10800000 ms)
                const now = Date.now();
                const cooldown = 3 * 60 * 60 * 1000; // 3 hours
                if (gameState.lastEscortTime && (now - gameState.lastEscortTime) < cooldown) {
                    const remaining = cooldown - (now - gameState.lastEscortTime);
                    const hours = Math.floor(remaining / (60 * 60 * 1000));
                    const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
                    ui.showFloatText(event.target, `Подожди ${hours}ч ${minutes}м`, "#ff5555");
                    return;
                }
                
                // Start escort
                const modal = document.getElementById('modal-escort-progress');
                modal.classList.add('open');
                
                const progressBar = document.getElementById('escort-progress-bar');
                const progressText = document.getElementById('escort-progress-text');
                const timerEl = document.getElementById('escort-timer');
                
                const messages = [
                    "Собираете беженцев...",
                    "Проверяете документы...",
                    "Выдвигаетесь в путь...",
                    "Проходите через лес...",
                    "Обходите патруль...",
                    "Почти у границы...",
                    "Переправка завершается..."
                ];
                
                let progress = 0;
                let messageIndex = 0;
                let timeLeft = 60;
                
                const interval = setInterval(() => {
                    progress += 100/60;
                    timeLeft--;
                    
                    progressBar.style.width = `${Math.min(100, progress)}%`;
                    timerEl.textContent = timeLeft;
                    
                    if (timeLeft % 10 === 0 && messageIndex < messages.length) {
                        progressText.textContent = messages[messageIndex];
                        messageIndex++;
                    }
                    
                    if (timeLeft <= 0) {
                        clearInterval(interval);
                        this.completeEscort();
                    }
                }, 1000);
            },
            
            completeEscort: function() {
                // Close progress modal
                const progressModal = document.getElementById('modal-escort-progress');
                progressModal.classList.remove('open');
                
                // Calculate damage (40-80 HP)
                const damage = Math.floor(Math.random() * 41) + 40;
                gameState.hp = Math.max(1, gameState.hp - damage);
                
                // Add rewards
                gameState.emeralds += 8;
                game.addReputation(-5, document.body);
                
                // Set cooldown
                gameState.lastEscortTime = Date.now();
                
                game.save();
                ui.updateStats();
                
                // Show result modal
                const resultModal = document.getElementById('modal-escort-result');
                document.getElementById('escort-result-emeralds').textContent = '+8 изумрудов';
                document.getElementById('escort-result-rep').textContent = '-5';
                document.getElementById('escort-result-hp').textContent = `-${damage} ХП`;
                resultModal.classList.add('open');
                
                // Update button
                this.updateCooldownUI();
            },
            
            closeResult: function() {
                const modal = document.getElementById('modal-escort-result');
                modal.classList.remove('open');
            },
            
            updateCooldownUI: function() {
                const btn = document.getElementById('btn-escort-refugees');
                const cooldownEl = document.getElementById('escort-cooldown');
                
                if (!gameState.lastEscortTime) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');
                    cooldownEl.classList.add('hidden');
                    return;
                }
                
                const now = Date.now();
                const cooldown = 3 * 60 * 60 * 1000; // 3 hours
                const remaining = cooldown - (now - gameState.lastEscortTime);
                
                if (remaining > 0) {
                    btn.disabled = true;
                    btn.classList.add('opacity-50');
                    
                    const hours = Math.floor(remaining / (60 * 60 * 1000));
                    const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
                    cooldownEl.textContent = `Доступно через: ${hours}ч ${minutes}м`;
                    cooldownEl.classList.remove('hidden');
                    
                    // Update every minute
                    setTimeout(() => this.updateCooldownUI(), 60000);
                } else {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');
                    cooldownEl.classList.add('hidden');
                }
            }
        };

        const livestock = {
            animalPrices: {
                rabbit: 4000,
                chicken: 5000,
                pig: 10000,
                cow: 50000
            },
            feedPrices: {
                feed: 20
            },

            ensureHasHouse: function(anchor) {
                if (!gameState.hasHouse) {
                    ui.showFloatText(anchor || document.body, "Нужен дом с загоном", "#ff5555");
                    return false;
                }
                return true;
            },

            buyAnimal: function(animal) {
                const anchor = event && event.target ? event.target : document.body;
                if (!this.ensureHasHouse(anchor)) return;

                if (!gameState.livestock) gameState.livestock = { rabbit: false, chicken: false, pig: false, cow: false };
                if (gameState.livestock[animal]) {
                    ui.showFloatText(anchor, "У вас уже есть это животное", "#777");
                    return;
                }

                const price = this.animalPrices[animal];
                if (!price) return;

                if (gameState.gold < price) {
                    ui.showFloatText(anchor, "Не хватает золота", "#ff5555");
                    return;
                }

                gameState.gold -= price;
                gameState.livestock[animal] = true;
                game.save();
                ui.updateStats();
                ui.showFloatText(anchor, "Животное куплено!", "#34d399");
                game.addReputation(1, anchor);
            },

            buyHorse: function(key) {
                const anchor = event && event.target ? event.target : document.body;
                
                // Check if stable exists
                if (!gameState.stableLevel || gameState.stableLevel < 1) {
                    ui.showFloatText(anchor, "Нужна конюшня (в деревне)", "#ff5555");
                    return;
                }
                
                // Check if already have a horse
                if (gameState.horse) {
                    if (!confirm("У вас уже есть лошадь. Заменить её? Старая лошадь пропадет.")) return;
                }
                
                const horse = HORSES_DB[key];
                if (!horse) return;
                
                if (gameState.gold < horse.price) {
                    ui.showFloatText(anchor, "Не хватает золота", "#ff5555");
                    return;
                }
                
                gameState.gold -= horse.price;
                gameState.horse = key;
                game.save();
                ui.updateStats();
                village.updateUI();
                ui.showFloatText(anchor, `Куплено: ${horse.name}`, "#34d399");
                game.addReputation(5, anchor);
            },

            buyFeed: function(feed) {
                const anchor = event && event.target ? event.target : document.body;
                if (!this.ensureHasHouse(anchor)) return;
                const price = this.feedPrices[feed];
                if (!price) return;

                if (gameState.gold < price) {
                    ui.showFloatText(anchor, "Не хватает золота", "#ff5555");
                    return;
                }

                if (!game.hasWeightCapacity(RESOURCE_WEIGHTS[feed] || 0)) {
                    game.showWeightWarning(anchor);
                    return;
                }

                gameState.gold -= price;
                gameState[feed] = (gameState[feed] || 0) + 1;
                game.save();
                ui.updateStats();
                ui.showFloatText(anchor, `Куплено: ${RESOURCE_NAMES[feed].name}`, "#34d399");
            }
        };

        // --- SKILLS CONTROLLER ---
        const skills = {
            upgrade: function(type) {
                if (gameState.skillPoints < 1) {
                    ui.showFloatText(event.target, "Нет жетонов", "#ff5555");
                    return;
                }
                
                if (type === 'hp') {
                    gameState.skillPoints--;
                    gameState.maxHp += 20;
                    gameState.hp += 20;
                    ui.showFloatText(event.target, "+20 Max HP", "#ef4444");
                } else if (type === 'luck') {
                    gameState.skillPoints--;
                    gameState.luck = (gameState.luck || 0) + 1;
                    ui.showFloatText(event.target, "+1 Удача", "#34d399");
                } else if (type === 'agility') {
                    gameState.skillPoints--;
                    gameState.agility = (gameState.agility || 0) + 1;
                    ui.showFloatText(event.target, "+1 Ловкость", "#3b82f6");
                }
                
                game.save();
                ui.updateStats();
            }
        };

        // --- CRAFTING & INVENTORY ---
        const crafting = {
            mode: 'inventory', 
            currentCategory: 'potions',
            recipesDef: {
                potions: [
                    { id: 'immortality', title: 'Зелье Бессмертия', req: { herbs: 100, mushrooms: 20 }, effect: { key: 'immortality', inc: 1 } },
                    { id: 'luck', title: 'Зелье Удачи', req: { herbs: 50, mushrooms: 10 }, effect: { key: 'luck', inc: 1 } }
                ],
                charms: [
                    { id: 'saddle', title: 'Седло', req: { leather: 5, rope: 2 }, produce: { key: 'saddle', count: 1 } }
                ],
                food: [
                    { id: 'bread', title: 'Хлеб', req: { wheat: 3 }, produce: { key: 'bread', count: 1 } }
                ],
                tools: [],
                other: []
            },
            toggleMode: function() {
                const invUI = document.getElementById('ui-inventory');
                const craftUI = document.getElementById('ui-crafting');
                const btnText = document.getElementById('craft-btn-text');

                if (this.mode === 'inventory') {
                    this.mode = 'crafting';
                    invUI.classList.add('hidden');
                    craftUI.classList.remove('hidden');
                    btnText.innerText = 'Вернуться в рюкзак';
                } else {
                    this.mode = 'inventory';
                    invUI.classList.remove('hidden');
                    craftUI.classList.add('hidden');
                    btnText.innerText = 'Перейти к крафту';
                    inventory.render();
                }
            },
            switchCategory: function(cat) {
                document.querySelectorAll('#ui-crafting .sub-tab').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-craft-${cat}`).classList.add('active');
                this.currentCategory = cat;
                this.render();
            },
            upgradeBag: function(event) {
                if (!gameState.recipes || !gameState.recipes.bag) {
                    ui.showFloatText(event.target, "Нужен рецепт сумки", "#ff5555");
                    return;
                }
                const cost = 3;
                if ((gameState.leather || 0) < cost || (gameState.wood || 0) < 2) {
                    ui.showFloatText(event.target, "Нужно 3 кожи и 2 палки", "#ff5555");
                    return;
                }
                gameState.leather -= cost;
                gameState.wood -= 2;
                gameState.bagLevel = (gameState.bagLevel || 0) + 1;
                game.save();
                ui.updateStats();
                inventory.render();
                ui.showFloatText(event.target, "+8 слотов", "#34d399");
            },
            render: function() {
                const list = document.getElementById('crafting-list');
                if (!list) return;
                list.innerHTML = '';
                const cat = this.currentCategory;
                const defs = this.recipesDef[cat] || [];
                const owned = gameState.recipes || {};
                const filtered = defs.filter(d => {
                    if (cat === 'potions') return owned[d.id];
                    if (cat === 'charms') return owned[d.id];
                    if (cat === 'food') return owned['food'];
                    if (cat === 'tools') return owned['bag'];
                    if (cat === 'other') return owned[d.id];
                    return false;
                });
                if (filtered.length === 0) {
                    list.innerHTML = '<div class="text-center text-xs text-gray-500 py-4">Нет рецептов</div>';
                    return;
                }
                filtered.forEach(d => {
                    const card = document.createElement('div');
                    card.className = 'recipe-card rounded p-3 flex items-center justify-between';
                    const reqTexts = Object.keys(d.req).map(k => {
                        const have = gameState[k] || 0;
                        const need = d.req[k];
                        const def = RESOURCE_NAMES[k];
                        const ok = have >= need;
                        return `<span class="${ok ? 'text-green-400' : 'text-red-400'}">${def ? def.name : k}: ${have}/${need}</span>`;
                    }).join(' • ');
                    card.innerHTML = `
                        <div class="flex items-center gap-3">
                            <i class="fas fa-hammer text-[#c8aa6e] text-xl"></i>
                            <div>
                                <div class="text-sm font-bold text-[#e0e0e0]">${d.title}</div>
                                <div class="text-[10px] text-[#a0a0a0]">${reqTexts}</div>
                            </div>
                        </div>
                        <button class="btn-ghost px-3 py-1 rounded text-[10px]" data-id="${d.id}">Создать</button>
                    `;
                    const btn = card.querySelector('button');
                    btn.onclick = (e) => crafting.craft(d, e);
                    list.appendChild(card);
                });
            },
            craft: function(def, e) {
                const req = def.req;
                for (const k in req) {
                    if ((gameState[k] || 0) < req[k]) {
                        ui.showFloatText(e.target, "Не хватает материалов", "#ff5555");
                        return;
                    }
                }
                
                // Check weight capacity for produced items
                if (def.produce) {
                    const key = def.produce.key;
                    const count = def.produce.count;
                    const itemWeight = RESOURCE_WEIGHTS[key] || 0;
                    const extraWeight = itemWeight * count;
                    
                    if (!game.hasWeightCapacity(extraWeight)) {
                        ui.showFloatText(e.target, "Недостаточно места в рюкзаке", "#ff5555");
                        return;
                    }
                }
                
                for (const k in req) {
                    gameState[k] -= req[k];
                }
                if (def.produce) {
                    const key = def.produce.key;
                    const count = def.produce.count;
                    gameState[key] = (gameState[key] || 0) + count;
                }
                if (def.effect) {
                    const ek = def.effect.key;
                    const inc = def.effect.inc;
                    if (!gameState.effects) gameState.effects = {};
                    gameState.effects[ek] = (gameState.effects[ek] || 0) + inc;
                }
                game.save();
                ui.updateStats();
                this.render();
                ui.showFloatText(e.target, "Создано", "#34d399");
            }
        };

        const inventory = {
            currentCategory: 'tools',
            switchCategory: function(cat) {
                this.currentCategory = cat;
                document.querySelectorAll('#ui-inventory .sub-tab').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-inv-${cat}`).classList.add('active');
                this.render();
            },

            getCategoryItems: function() {
                // Returns array of { kind: 'tool'|'resource'|'shoes', key, name, icon, count, weight, desc, level? }
                const items = [];

                if (this.currentCategory === 'tools') {
                    Object.keys(TOOLS_DB).forEach(key => {
                        const state = gameState.tools[key];
                        if (state && state.owned) {
                            const db = TOOLS_DB[key];
                            const basePrice = TOOL_BASE_PRICES[key] || 0;
                            const buyPrice = basePrice + (state.level - 1) * basePrice; // Цена растет с уровнем
                            items.push({
                                kind: 'tool',
                                key,
                                name: db.name,
                                icon: db.icon,
                                level: state.level,
                                count: 1,
                                weight: TOOL_WEIGHTS[key] || 0,
                                desc: itemModal.getDescriptionForTool(key),
                                buyPrice: buyPrice
                            });
                        }
                    });
                }

                if (this.currentCategory === 'combat') {
                    // Мечи — все купленные
                    if (!gameState.ownedSwords) gameState.ownedSwords = [];
                    gameState.ownedSwords.forEach(swordId => {
                        const sw = SWORDS_DB[swordId];
                        if (!sw) return;
                        const isEquipped = gameState.equippedSword === swordId;
                        const sellGold = sw.costType === 'gold' ? Math.floor(sw.cost / 2) : 0;
                        const sellEmerald = sw.costType === 'emeralds' ? Math.floor(sw.cost / 2) : 0;
                        items.push({
                            kind: 'combat_sword',
                            key: swordId,
                            name: sw.name,
                            icon: sw.icon,
                            color: sw.color,
                            level: 1,
                            count: 1,
                            weight: 2.5,
                            isEquipped: isEquipped,
                            desc: `Урон: ${sw.damage}.${isEquipped ? ' Экипирован.' : ''}`,
                            damage: sw.damage,
                            sellGold: sellGold,
                            sellEmerald: sellEmerald,
                            costType: sw.costType,
                            cost: sw.cost
                        });
                    });
                    // Броня — все купленные
                    if (!gameState.ownedArmor) gameState.ownedArmor = [];
                    gameState.ownedArmor.forEach(armorId => {
                        const ar = ARMOR_DB[armorId];
                        if (!ar) return;
                        const isEquipped = gameState.equippedArmor === armorId;
                        const sellGold = ar.costType === 'gold' ? Math.floor(ar.cost / 2) : 0;
                        const sellEmerald = ar.costType === 'emeralds' ? Math.floor(ar.cost / 2) : 0;
                        items.push({
                            kind: 'combat_armor',
                            key: armorId,
                            name: ar.name,
                            icon: ar.icon,
                            color: ar.color,
                            level: 1,
                            count: 1,
                            weight: 4.0,
                            isEquipped: isEquipped,
                            desc: `Защита: ${ar.armor}.${isEquipped ? ' Экипирована.' : ''}`,
                            armorVal: ar.armor,
                            sellGold: sellGold,
                            sellEmerald: sellEmerald,
                            costType: ar.costType,
                            cost: ar.cost
                        });
                    });
                }

                if (this.currentCategory === 'weapons') {
                    // Старая категория weapons - для обратной совместимости
                    const key = 'sword';
                    const state = gameState.tools && gameState.tools[key];
                    if (state && state.owned) {
                        const db = TOOLS_DB[key];
                        items.push({
                            kind: 'tool',
                            key,
                            name: db.name,
                            icon: db.icon,
                            level: state.level,
                            count: 1,
                            weight: TOOL_WEIGHTS[key] || 0,
                            desc: itemModal.getDescriptionForTool(key)
                        });
                    }
                }

                if (this.currentCategory === 'other') {
                    const resList = Object.keys(RESOURCE_NAMES);
                    resList.forEach(key => {
                        const count = gameState[key] || 0;
                        if (count > 0) {
                            const def = RESOURCE_NAMES[key];
                            items.push({
                                kind: 'resource',
                                key,
                                name: def.name,
                                icon: def.icon,
                                count,
                                weight: (RESOURCE_WEIGHTS[key] || 0),
                                desc: itemModal.getDescriptionForResource(key)
                            });
                        }
                    });
                }

                if (this.currentCategory === 'armor') {
                    // Placeholder category (future)
                }

                if (this.currentCategory === 'potions') {
                    // Placeholder category (future)
                }

                if (this.currentCategory === 'amulets') {
                    if (gameState.amulets) {
                        Object.keys(gameState.amulets).forEach(key => {
                            const amulet = gameState.amulets[key];
                            if (amulet.owned) {
                                const icons = {
                                    xp: 'fa-star',
                                    gathering: 'fa-leaf',
                                    luck: 'fa-clover'
                                };
                                const colors = {
                                    xp: '#3b82f6',
                                    gathering: '#10b981',
                                    luck: '#c084fc'
                                };
                                items.push({
                                    kind: 'amulet',
                                    key,
                                    name: amulet.name,
                                    icon: icons[key] || 'fa-gem',
                                    color: colors[key] || '#c8aa6e',
                                    count: 1,
                                    weight: 0.1,
                                    desc: amulet.bonus
                                });
                            }
                        });
                    }
                }

                return items;
            },

            render: function() {
                const grid = document.getElementById('inventory-grid');
                grid.innerHTML = '';

                const items = this.getCategoryItems();

                items.forEach(item => {
                    const el = document.createElement('div');
                    let borderColor = 'border-[#c8aa6e]';
                    let iconColor = 'text-[#c8aa6e]';
                    if (item.kind === 'combat_sword') { borderColor = 'border-red-700'; iconColor = 'text-red-400'; }
                    if (item.kind === 'combat_armor') { borderColor = 'border-blue-700'; iconColor = 'text-blue-400'; }
                    if (item.kind === 'amulet') { 
                        borderColor = 'border-purple-700'; 
                        iconColor = 'text-purple-400'; 
                    }
                    // Equipped items get a gold glow border
                    if (item.isEquipped) { borderColor = 'border-[#c8aa6e]'; }
                    el.className = `inv-item aspect-square bg-[#1a1a1d] border ${borderColor} rounded flex flex-col items-center justify-center relative p-1`;
                    if (item.isEquipped) {
                        el.style.boxShadow = '0 0 8px rgba(200,170,110,0.5)';
                    }
                    if (item.kind === 'amulet') {
                        el.style.boxShadow = `0 0 10px ${item.color}40`;
                    }

                    let iconHtml;
                    if (item.kind === 'combat_sword' && item.color) {
                        iconHtml = `<svg class="icon-svg-fill text-xl mb-1 w-6 h-6" viewBox="0 0 512.001 512.001" style="color: ${item.color};"><use href="#icon-sword-generic"></use></svg>`;
                    } else if (item.kind === 'combat_armor' && item.color) {
                        iconHtml = `<svg class="icon-svg-fill text-xl mb-1 w-6 h-6" viewBox="0 0 512 512" style="color: ${item.color};"><use href="#icon-armor-generic"></use></svg>`;
                    } else if (item.kind === 'amulet' && item.color) {
                        iconHtml = `<i class="${item.icon} text-xl mb-1" style="color: ${item.color};"></i>`;
                    } else {
                        iconHtml = ui.getIconHtml(item.icon, `text-xl mb-1 w-6 h-6 ${iconColor}`);
                    }

                    let badge = '';
                    if (item.kind === 'tool') {
                        badge = `<span class="absolute top-0 right-1 text-[8px] text-white font-bold">${item.level}</span>`;
                    } else if (item.kind === 'combat_sword') {
                        const dmgVal = item.damage || (item.desc.match(/Урон: (\d+)/)?.[1] || '');
                        badge = `<span class="absolute top-0 right-1 text-[8px] text-red-300 font-bold">⚔${dmgVal}</span>`;
                    } else if (item.kind === 'combat_armor') {
                        const arVal = item.armorVal || (item.desc.match(/Защита: (\d+)/)?.[1] || '');
                        badge = `<span class="absolute top-0 right-1 text-[8px] text-blue-300 font-bold">🛡${arVal}</span>`;
                    } else {
                        badge = `<span class="absolute top-0 right-1 text-[8px] text-white font-bold">${item.count}</span>`;
                    }

                    // Equipped marker at bottom-left
                    let equippedBadge = '';
                    if (item.isEquipped) {
                        equippedBadge = `<span class="absolute bottom-0 left-0.5 text-[7px] text-[#c8aa6e] font-bold uppercase tracking-tight">✓ Экип.</span>`;
                    }

                    el.innerHTML = `
                        ${iconHtml}
                        <span class="text-[8px] uppercase text-center leading-tight text-gray-400">${item.name}</span>
                        ${badge}
                        ${equippedBadge}
                    `;
                    el.onclick = () => itemModal.open(item);
                    grid.appendChild(el);
                });

                // Capacity by bag slots
                const bagLevel = gameState.bagLevel || 0;
                const capacity = 8 + bagLevel * 8;
                const children = grid.children.length;
                for (let i = 0; i < Math.max(0, capacity - children); i++) {
                    grid.appendChild(this.createEmptySlot());
                }
            },

            createEmptySlot: function() {
                const el = document.createElement('div');
                el.className = 'aspect-square bg-[#111] border border-[#333] rounded';
                return el;
            }
        };

        // --- UI HANDLER ---
        const ui = {
            getIconHtml: function(iconName, extraClasses = '') {
                if (iconName && iconName.startsWith('icon-')) {
                    // Определяем viewBox в зависимости от иконки
                    let viewBox = '0 0 24 24';
                    if (iconName === 'icon-mushroom') viewBox = '0 0 330.18 330.18';
                    else if (iconName === 'icon-crossbow') viewBox = '0 0 512.001 512.001';
                    else if (iconName === 'icon-pickaxe') viewBox = '0 0 512 512';
                    else if (iconName === 'icon-leather') viewBox = '0 0 467.473 467.473';
                    else if (iconName === 'icon-cloth') viewBox = '0 0 512.001 512.001';
                    else if (iconName === 'icon-sword-generic') viewBox = '0 0 512.001 512.001';
                    
                    return `<svg class="icon-svg-fill ${extraClasses}" viewBox="${viewBox}"><use href="#${iconName}"></use></svg>`;
                }
                return `<i class="fas ${iconName} ${extraClasses}"></i>`;
            },

            openSettings: function() {
                ui.showFloatText(document.body, 'Скоро', '#777');
            },

            updateAll: function() {
                this.updateStats();
                this.updateJobs();
                this.updateLocations();
                this.updateUnconsciousUI();
                market.renderTools();
                ui.updateMarketCounts();
                if (document.getElementById('market-trade-sell')) {
                    market.switchTradeMode(market.tradeMode || 'sell');
                }
                market.updateTradePrices();
                if (crafting.mode === 'inventory' && !document.getElementById('view-character').classList.contains('hidden') && document.getElementById('ui-skills').classList.contains('hidden')) {
                    inventory.render();
                }
                crafting.render();
                if(router.currentTab === 'quests') quests.render();
            },

            updateMarketCounts: function() {
                Object.keys(RESOURCE_NAMES).forEach(key => {
                    const el = document.getElementById(`market-count-${key}`);
                    if (el) el.innerText = gameState[key] || 0;
                });
            },

            buildMarketCategories: function() {
                if (market.categoriesBuilt) return;
                const list = [
                    {
                        id: 'food',
                        title: 'Еда',
                        tone: 'amber',
                        items: ['fish', 'meat', 'mushrooms', 'bread', 'eggs', 'milk']
                    },
                    {
                        id: 'metals',
                        title: 'Металлы',
                        tone: 'slate',
                        items: ['ore', 'bronze', 'silver']
                    },
                    {
                        id: 'other',
                        title: 'Другое',
                        tone: 'emerald',
                        items: ['wheat', 'wood', 'stone', 'herbs', 'leather', 'wool', 'rope', 'cloth']
                    }
                ];

                const container = document.getElementById('market-trade-grid');
                if (!container) return;
                container.innerHTML = '';

                list.forEach(group => {
                    const section = document.createElement('div');
                    section.className = `col-span-2 panel p-3 rounded border-${group.tone}-900/30 bg-${group.tone}-900/10`;
                    section.innerHTML = `
                        <div class="flex items-center gap-2 text-[10px] text-[#c8aa6e] uppercase tracking-widest mb-2">
                            <i class="fas fa-layer-group"></i> ${group.title}
                        </div>
                        <div id="market-group-${group.id}" class="grid grid-cols-2 gap-3"></div>
                    `;
                    container.appendChild(section);

                    const groupGrid = section.querySelector(`#market-group-${group.id}`);
                    group.items.forEach(item => {
                        const def = RESOURCE_NAMES[item];
                        const card = document.createElement('div');
                        card.className = 'panel p-2 rounded flex flex-col items-center text-center border-[#333] bg-black/20';
                        card.innerHTML = `
                            <div class="w-6 h-6 flex items-center justify-center text-[#c8aa6e] mb-1">
                                ${ui.getIconHtml(def.icon, 'w-full h-full')}
                            </div>
                            <div class="text-xs text-[#e0e0e0]">${def.name}</div>
                            <div class="text-[10px] text-[#a0a0a0] mb-1"><span id="price-${item}">0</span> <i class="fas fa-coins"></i></div>
                            <div class="text-[10px] text-blue-300 mb-1">У вас: <span id="market-count-${item}">0</span></div>
                            <div class="flex gap-1 w-full mb-1">
                                <input id="trade-input-${item}" type="number" min="1" value="1" class="w-full bg-[#111] border border-[#333] text-center text-[10px] text-white rounded p-0 outline-none focus:border-[#c8aa6e]">
                                <button onclick="market.setMax('${item}')" class="w-auto px-2 border border-[#444] rounded text-[10px] text-gray-400 hover:text-white" >Max</button>
                            </div>
                            <button onclick="market.sellFromInput('${item}')" id="btn-trade-${item}" class="btn-ghost w-full rounded text-[10px] py-1 hover:bg-amber-900/20 transition-colors">Продать</button>
                        `;
                        groupGrid.appendChild(card);
                    });
                });
                market.categoriesBuilt = true;
                market.updateTradePrices();
                ui.updateMarketCounts();
                market.switchTradeMode(market.tradeMode || 'sell');
            },

            updateStats: function() {
                document.getElementById('gold-display').innerText = gameState.gold;
                document.getElementById('emerald-display').innerText = gameState.emeralds;
                document.getElementById('char-level').innerText = gameState.level;

                // Update character panel under portrait
                const charPanelTitle = document.getElementById('char-panel-title');
                if (charPanelTitle) charPanelTitle.innerText = game.getLevelTitle(gameState.level);
                const charPanelLevel = document.getElementById('char-panel-level');
                if (charPanelLevel) charPanelLevel.innerText = `Уровень ${gameState.level}`;
                
                // Update hero tab title and description
                const heroTitle = document.getElementById('hero-title');
                if (heroTitle) heroTitle.innerText = game.getLevelTitle(gameState.level);
                const heroTitleDesc = document.getElementById('hero-title-desc');
                if (heroTitleDesc) heroTitleDesc.innerText = game.getLevelTitleDescription(gameState.level);

                const playerIdEl = document.getElementById('player-id');
                if (playerIdEl) playerIdEl.innerText = gameState.playerId || "—";
                const playerNameEl = document.getElementById('player-name');
                if (playerNameEl) playerNameEl.innerText = gameState.playerName || "Странник";
                
                const bankDisplay = document.getElementById('bank-display');
                if(bankDisplay) bankDisplay.innerText = gameState.bankedGold;
                const bankMini = document.getElementById('bank-display-mini');
                if(bankMini) bankMini.innerText = gameState.bankedGold;
                const walletMini = document.getElementById('wallet-display');
                if(walletMini) walletMini.innerText = gameState.gold;
                
                document.getElementById('level-display-header').innerText = `Ур ${gameState.level}`;
                const percent = Math.min(100, (gameState.xp / gameState.xpToNextLevel) * 100);
                const charBar = document.getElementById('xp-bar');
                if (charBar) charBar.style.width = `${percent}%`;
                const headerBar = document.getElementById('header-xp-bar');
                if (headerBar) headerBar.style.width = `${percent}%`;
                const xpText = document.getElementById('xp-text');
                if (xpText) xpText.innerText = `${gameState.xp} / ${gameState.xpToNextLevel} XP`;
                const headerXpText = document.getElementById('header-xp-text');
                if (headerXpText) headerXpText.innerText = `${gameState.xp}/${gameState.xpToNextLevel}`;
                const remaining = Math.max(0, gameState.xpToNextLevel - gameState.xp);
                const xpRemElement = document.getElementById('xp-remaining');
                if(xpRemElement) xpRemElement.innerText = remaining;
                document.getElementById('header-hp-text').innerText = gameState.hp;
                const hpPercent = (gameState.hp / gameState.maxHp) * 100;
                document.getElementById('hp-bar').style.width = `${hpPercent}%`;
                document.getElementById('hp-text').innerText = `${gameState.hp} / ${gameState.maxHp}`;
                
                // Update hunger bar
                const hungerPercent = (gameState.hunger / gameState.maxHunger) * 100;
                const hungerBar = document.getElementById('hunger-bar');
                const hungerText = document.getElementById('hunger-text');
                if (hungerBar) hungerBar.style.width = `${hungerPercent}%`;
                if (hungerText) hungerText.innerText = `${gameState.hunger} / ${gameState.maxHunger}`;
                
                // Update Damage and Armor stats based on equipped items
                const equippedDamage = gameState.equippedSword && SWORDS_DB[gameState.equippedSword] ? SWORDS_DB[gameState.equippedSword].damage : 0;
                const equippedArmor = gameState.equippedArmor && ARMOR_DB[gameState.equippedArmor] ? ARMOR_DB[gameState.equippedArmor].armor : 0;
                const statDamageEl = document.getElementById('stat-damage');
                if (statDamageEl) statDamageEl.innerText = equippedDamage;
                const statArmorEl = document.getElementById('stat-armor');
                if (statArmorEl) statArmorEl.innerText = equippedArmor;
                // Also keep gameState in sync for combat
                gameState.damage = equippedDamage;
                gameState.armor = equippedArmor;

                // Update Equipment Slots UI
                equipment.updateUI();
                
                ui.updateMarketCounts();

                const weightText = document.getElementById('weight-text');
                const weightBar = document.getElementById('weight-bar');
                if (weightText && weightBar) {
                    const currentWeight = game.getCurrentWeight();
                    const capacity = game.getWeightCapacity();
                    weightText.innerText = `${currentWeight} / ${capacity} кг`;
                    weightBar.style.width = `${Math.min(100, (currentWeight / capacity) * 100)}%`;
                    weightBar.classList.toggle('bg-red-500', currentWeight >= capacity);
                }

                const repValue = Math.max(0, Math.min(100, gameState.reputation || 0));
                const repValueEl = document.getElementById('rep-value');
                const repBar = document.getElementById('rep-bar');
                const repRank = document.getElementById('rep-rank');
                if (repValueEl) repValueEl.innerText = repValue;
                if (repBar) repBar.style.width = `${repValue}%`;
                if (repRank) {
                    let rankText = 'Безымянный странник';
                    if (repValue >= 80) rankText = 'Герой королевства';
                    else if (repValue >= 60) rankText = 'Прославленный защитник';
                    else if (repValue >= 40) rankText = 'Почтенный гражданин';
                    else if (repValue >= 20) rankText = 'Добрый житель';
                    repRank.innerText = rankText;
                }

                if (gameState.hp <= 0) {
                    const now = Date.now();
                    if (gameState.unconsciousUntil && gameState.unconsciousUntil > now) {
                        // Already unconscious, keep timer running
                    } else if (gameState.unconsciousUntil && gameState.unconsciousUntil <= now) {
                        game.checkUnconscious();
                    } else {
                        game.knockOut();
                    }
                } else if (gameState.hp < 14) {
                    const cooldown = 2 * 60 * 1000;
                    const lastWarn = gameState.lowHpWarnedAt || 0;
                    if (Date.now() - lastWarn > cooldown) {
                        this.showLowHpWarning();
                    }
                } else {
                    const lowHpModal = document.getElementById('modal-lowhp');
                    if (lowHpModal && lowHpModal.classList.contains('open')) {
                        lowHpModal.classList.remove('open');
                    }
                }
                
                // Check hunger level
                if (gameState.hunger <= 0) {
                    const cooldown = 2 * 60 * 1000;
                    const lastWarn = gameState.lastHungerWarning || 0;
                    if (Date.now() - lastWarn > cooldown) {
                        this.showHungerWarning();
                    }
                } else {
                    const hungerModal = document.getElementById('modal-hunger');
                    if (hungerModal && hungerModal.classList.contains('open')) {
                        hungerModal.classList.remove('open');
                    }
                }
            },

            updateJobs: function() {
                const portReward = game.getJobReward('port');
                this.updateJobButton('port', 'rod', 0);
                document.getElementById('reward-port').innerText = `${portReward.gold} Рыбы`; 
                
                // Loader job visibility (unlocked by Alex)
                const loaderJob = document.getElementById('job-loader');
                if (loaderJob) {
                    if (gameState.npcStates && gameState.npcStates.alex_job_unlocked) {
                        loaderJob.classList.remove('hidden');
                    } else {
                        loaderJob.classList.add('hidden');
                    }
                }
                
                const fieldReward = game.getJobReward('field');
                this.updateJobButton('field', 'sickle', 5);
                document.getElementById('reward-field').innerText = `${fieldReward.gold} Пшеницы`;
                const mineReward = game.getJobReward('mine');
                this.updateJobButton('mine', 'pickaxe', 15);
                document.getElementById('reward-mine').innerText = `${mineReward.gold} Руды`;


                // Update Skills UI
                const spEl = document.getElementById('skill-points-display');
                if(spEl) spEl.innerText = gameState.skillPoints || 0;
                const bagLevelEl = document.getElementById('bag-level-display');
                if (bagLevelEl) bagLevelEl.innerText = gameState.bagLevel || 0;
                const luckEl = document.getElementById('luck-display');
                if(luckEl) luckEl.innerText = gameState.luck || 0;
                const agilityEl = document.getElementById('agility-display');
                if(agilityEl) agilityEl.innerText = gameState.agility || 0;
            },

            switchCharTab: function(tab) {
                document.getElementById('btn-tab-inv').className = "flex-1 bg-[#1a1a1d] border border-[#333] text-[#777] py-1 rounded text-xs uppercase font-serif transition-colors";
                document.getElementById('btn-tab-skills').className = "flex-1 bg-[#1a1a1d] border border-[#333] text-[#777] py-1 rounded text-xs uppercase font-serif transition-colors";
                
                document.getElementById(`btn-tab-${tab === 'inventory' ? 'inv' : 'skills'}`).className = "flex-1 bg-[#2c2c30] border border-[#c8aa6e] text-[#c8aa6e] py-1 rounded text-xs uppercase font-serif transition-colors";
                
                document.getElementById('ui-inventory').classList.add('hidden');
                document.getElementById('ui-crafting').classList.add('hidden');
                document.getElementById('ui-skills').classList.add('hidden');
                
                if (tab === 'inventory') {
                    // Reset crafting mode when switching tabs
                    crafting.mode = 'inventory';
                    document.getElementById('ui-inventory').classList.remove('hidden');
                    document.getElementById('craft-btn-text').innerText = 'Перейти к крафту';
                    inventory.render();
                } else {
                    document.getElementById('ui-skills').classList.remove('hidden');
                }
            },

            updateJobButton: function(jobId, toolId, lvlReq) {
                const btn = document.getElementById(`btn-work-${jobId}`);
                const info = document.getElementById(`job-info-${jobId}`);
                const container = document.getElementById(`job-${jobId}`);
                const toolOwned = gameState.tools[toolId].owned;
                const levelMet = gameState.level >= lvlReq;
                if (container) {
                     if (levelMet) container.classList.remove('opacity-50');
                     else container.classList.add('opacity-50');
                }
                if (!levelMet) {
                    btn.disabled = true;
                    btn.innerHTML = `<i class="fas fa-lock text-xs"></i> Требуется Уровень ${lvlReq}`;
                } else if (!toolOwned) {
                    btn.disabled = false;
                    btn.innerHTML = `<i class="fas fa-shopping-cart text-xs"></i> Требуется ${TOOLS_DB[toolId].name}`;
                } else {
                    btn.disabled = false;
                    let actionName = 'Работать';
                    let icon = 'fa-hammer';
                    if(jobId === 'port') { actionName = 'Рыбачить'; icon = 'fa-fish'; }
                    else if(jobId === 'field') { actionName = 'Собрать'; icon = 'fa-seedling'; }
                    else if(jobId === 'mine') { actionName = 'Добывать'; icon = 'fa-hammer'; }

                    btn.innerHTML = `<i class="fas ${icon} mr-2"></i> ${actionName}`;
                }
                if(info) {
                    if(toolOwned) info.innerHTML = `<span class="text-green-500"><i class="fas fa-check"></i> ${TOOLS_DB[toolId].name} (Ур ${gameState.tools[toolId].level})</span>`;
                    else info.innerHTML = `Требуется: ${TOOLS_DB[toolId].name}`;
                }
            },
            
            showFloatText: function(element, text, color) {
                const rect = element.getBoundingClientRect();
                const floatEl = document.createElement('div');
                floatEl.className = 'floating-text';
                floatEl.innerText = text;
                floatEl.style.color = color;
                floatEl.style.left = (rect.left + rect.width / 2) + 'px';
                floatEl.style.top = (rect.top) + 'px';
                document.body.appendChild(floatEl);
                setTimeout(() => { floatEl.remove(); }, 1000);
            },

            updateLocations: function() {
                // Tavern Brawl Timer
                const brawlTimerEl = document.getElementById('brawl-timer');
                const brawlBtn = document.getElementById('btn-brawl');
                if (brawlTimerEl && brawlBtn) {
                    const now = Date.now();
                    const last = gameState.lastBrawlTime || 0;
                    const cooldown = 3600000;
                    if (now - last < cooldown) {
                        const left = Math.ceil((cooldown - (now - last)) / 60000);
                        brawlTimerEl.innerText = `${left} мин`;
                        brawlTimerEl.className = "text-gray-500 font-mono";
                        brawlBtn.disabled = true;
                        brawlBtn.classList.add('opacity-50');
                        brawlBtn.innerText = "Отдых...";
                    } else {
                        brawlTimerEl.innerText = "Доступно";
                        brawlTimerEl.className = "text-[#c8aa6e] font-mono";
                        brawlBtn.disabled = false;
                        brawlBtn.classList.remove('opacity-50');
                        brawlBtn.innerHTML = "Выйти на бой";
                    }
                }

                // Rent Logic
                const statusEl = document.getElementById('rent-status');
                const btn = document.getElementById('btn-rent-room');
                if (gameState.rentExpiry > new Date().getTime()) {
                    // Logic here if needed
                }

                // Dark Forest Lock Logic
                const forestBtn = document.getElementById('btn-loc-forest');
                const forestDesc = document.getElementById('forest-desc');
                const forestIcon = document.getElementById('forest-lock-icon');
                
                if (forestBtn && forestDesc && forestIcon) {
                    if (gameState.level < 5) {
                        forestBtn.onclick = function() { ui.showFloatText(forestBtn, "Требуется Уровень 5", "#ff5555"); };
                        forestBtn.classList.add('opacity-50', 'grayscale');
                        forestBtn.classList.remove('hover:border-[#c8aa6e]');
                        forestDesc.innerText = "Требуется Уровень 5";
                        forestDesc.className = "text-xs text-red-400";
                        forestIcon.className = "fas fa-lock text-red-500 z-10";
                    } else {
                        forestBtn.onclick = function() { router.navigate('dark-forest'); };
                        forestBtn.classList.remove('opacity-50', 'grayscale');
                        forestBtn.classList.add('hover:border-[#c8aa6e]');
                        forestDesc.innerText = "Опасность и редкие травы";
                        forestDesc.className = "text-xs text-gray-300";
                        forestIcon.className = "fas fa-chevron-right text-gray-400 z-10";
                    }
                }

                // Training Camp Lock Logic
                const campBtn = document.getElementById('btn-loc-camp');
                const campDesc = document.getElementById('camp-desc');
                const campIcon = document.getElementById('camp-lock-icon');

                if (campBtn && campDesc && campIcon) {
                    if (gameState.level < 15) {
                         campBtn.onclick = function() { ui.showFloatText(campBtn, "Требуется Уровень 15", "#ff5555"); };
                         campBtn.classList.add('opacity-50', 'grayscale');
                         campBtn.classList.remove('hover:border-[#c8aa6e]');
                         campDesc.innerText = "Требуется Уровень 15";
                         campDesc.className = "text-xs text-red-400";
                         campIcon.className = "fas fa-lock text-red-500 z-10";
                    } else {
                         campBtn.onclick = function() { router.navigate('training-camp'); };
                         campBtn.classList.remove('opacity-50', 'grayscale');
                         campBtn.classList.add('hover:border-[#c8aa6e]');
                         campDesc.innerText = "Путь воина";
                         campDesc.className = "text-xs text-red-300";
                         campIcon.className = "fas fa-chevron-right text-gray-400 z-10";
                    }
                }

                // Military Fortress Logic
                const fortressBtn = document.getElementById('btn-loc-fortress');
                const fortressDesc = document.getElementById('fortress-desc');
                const fortressIcon = document.getElementById('fortress-lock-icon');
                const trained = !!(gameState.npcStates && gameState.npcStates.campTrained);

                if (fortressBtn && fortressDesc && fortressIcon) {
                    if (!trained) {
                        fortressBtn.onclick = function() {
                            dialogue.start('fortress_guard');
                        };
                        fortressBtn.classList.add('opacity-60');
                        fortressDesc.innerText = "Нужно пройти обучение";
                        fortressDesc.className = "text-[9px] text-slate-500 text-center mt-0.5";
                        fortressIcon.className = "fas fa-lock text-slate-500/70 text-[10px]";
                    } else {
                        fortressBtn.onclick = function() { router.navigate('military-fortress'); };
                        fortressBtn.classList.remove('opacity-60');
                        fortressDesc.innerText = "Казармы и приказы";
                        fortressDesc.className = "text-[9px] text-slate-300/60 text-center mt-0.5";
                        fortressIcon.className = "fas fa-chevron-right text-slate-300/70 text-[10px]";
                    }
                }

                // Refugee Camp Logic
                const refBtn = document.getElementById('btn-loc-refugee');
                const refDesc = document.getElementById('refugee-desc');
                const refIcon = document.getElementById('refugee-lock-icon');
                
                if (refBtn && refDesc && refIcon) {
                    if (gameState.npcStates && gameState.npcStates.thomas_met) {
                        refBtn.classList.remove('opacity-60');
                        refBtn.onclick = function() { router.navigate('refugee-camp'); };
                        refDesc.innerText = "Убежище изгоев";
                        refDesc.className = "text-xs text-gray-400";
                        refIcon.className = "fas fa-chevron-right text-gray-400 z-10";
                    } else {
                        refBtn.classList.add('opacity-60');
                        refBtn.onclick = function() { ui.showFloatText(refBtn, "Закрыто", "#777"); };
                        refDesc.innerText = "Тайное место";
                        refDesc.className = "text-xs text-gray-500";
                        refIcon.className = "fas fa-lock text-gray-600 z-10";
                    }
                }
            },

            showDailyModal: function() {
                const daysContainer = document.getElementById('daily-days-container');
                daysContainer.innerHTML = '';
                const streak = gameState.dailyStreak;
                const rewards = [5, 10, 15, 20, 30];
                rewards.forEach((amt, idx) => {
                    const dayNum = idx + 1;
                    const isCurrent = (streak > 5 && idx === 4) || (streak === dayNum);
                    const isPassed = streak > dayNum;
                    let bgClass = 'bg-[#111] border-gray-700 text-gray-500';
                    if (isPassed) bgClass = 'bg-emerald-900 border-emerald-700 text-emerald-400';
                    if (isCurrent) bgClass = 'bg-[#c8aa6e] border-yellow-500 text-black font-bold scale-110 shadow-lg';
                    const el = document.createElement('div');
                    el.className = `w-10 h-12 rounded border flex flex-col items-center justify-center text-[10px] ${bgClass}`;
                    el.innerHTML = `<span>Д${dayNum}</span><span class="${isCurrent ? 'text-black' : (isPassed ? 'text-emerald-400' : 'text-emerald-700')}">${amt}</span>`;
                    daysContainer.appendChild(el);
                });
                let todayReward = 30;
                if (streak <= 4) todayReward = rewards[streak-1];
                document.getElementById('daily-amount').innerText = todayReward;
                document.getElementById('modal-daily').classList.add('open');
            },

            updateUnconsciousUI: function() {
                const modal = document.getElementById('modal-unconscious');
                if (!modal) return;
                const now = Date.now();
                const active = gameState.unconsciousUntil && gameState.unconsciousUntil > now;

                if (active) {
                    modal.classList.add('open');
                    document.body.classList.add('unconscious');
                    this.updateTimerVisuals(); // Update immediately to prevent "10:00" flash
                } else {
                    modal.classList.remove('open');
                    document.body.classList.remove('unconscious');
                }
            },

            updateTimerVisuals: function() {
                if (gameState.unconsciousUntil && gameState.unconsciousUntil > Date.now()) {
                    const remaining = Math.max(0, Math.floor((gameState.unconsciousUntil - Date.now()) / 1000));
                    const minutes = Math.floor(remaining / 60);
                    const seconds = remaining % 60;
                    const timerEl = document.getElementById('unconscious-timer');
                    if (timerEl) {
                        timerEl.innerText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    }
                }
            },

            showLowHpWarning: function() {
                const modal = document.getElementById('modal-lowhp');
                if (!modal) return;
                if (gameState.unconsciousUntil && gameState.unconsciousUntil > Date.now()) return;
                if (modal.classList.contains('open')) return;
                modal.classList.add('open');
                gameState.lowHpWarnedAt = Date.now();
                game.save();
            },

            dismissLowHpWarning: function() {
                const modal = document.getElementById('modal-lowhp');
                if (modal) modal.classList.remove('open');
            },

            showHungerWarning: function() {
                const modal = document.getElementById('modal-hunger');
                if (!modal) return;
                if (modal.classList.contains('open')) return;
                modal.classList.add('open');
                gameState.lastHungerWarning = Date.now();
                game.save();
            },

            dismissHungerWarning: function() {
                const modal = document.getElementById('modal-hunger');
                if (modal) modal.classList.remove('open');
            },

            dismissMeaslesWarning: function() {
                const modal = document.getElementById('modal-measles-infected');
                if (modal) modal.classList.remove('open');
            },

            maybeTriggerTreasuryPouch: function() {
                if (gameState.treasuryPouchResolved) return;
                if (gameState.level < 3) return;
                if (gameState.npcStates && gameState.npcStates.treasuryPouchSeen) return;
                if (Math.random() < 0.35) {
                    if (!gameState.npcStates) gameState.npcStates = {};
                    gameState.npcStates.treasuryPouchSeen = true;
                    game.save();
                    setTimeout(() => {
                        ui.showTreasuryPouch();
                    }, 400);
                }
            },

            maybeTriggerBookhousePouch: function() {
                if (gameState.bookhousePouchResolved) return;
                if (gameState.level < 5) return;
                if (gameState.npcStates && gameState.npcStates.bookhousePouchSeen) return;
                if (Math.random() < 0.35) {
                    if (!gameState.npcStates) gameState.npcStates = {};
                    gameState.npcStates.bookhousePouchSeen = true;
                    game.save();
                    setTimeout(() => {
                        ui.showBookhousePouch();
                    }, 400);
                }
            },

            openRepInfo: function() {
                const modal = document.getElementById('modal-reputation');
                if (modal) modal.classList.add('open');
            },

            closeRepInfo: function() {
                const modal = document.getElementById('modal-reputation');
                if (modal) modal.classList.remove('open');
            },

            showTreasuryPouch: function() {
                const modal = document.getElementById('modal-treasury-pouch');
                if (modal) modal.classList.add('open');
            },

            resolveTreasuryPouch: function(choice) {
                const modal = document.getElementById('modal-treasury-pouch');
                if (modal) modal.classList.remove('open');
                if (gameState.treasuryPouchResolved) return;

                if (choice === 'return') {
                    game.addReputation(3, document.body);
                    ui.showFloatText(document.body, "+3 Репутации", "#34d399");
                } else {
                    gameState.gold += 1000;
                    game.addReputation(-5, document.body);
                    ui.showFloatText(document.body, "+1000 Золота", "#fbbf24");
                }

                gameState.treasuryPouchResolved = true;
                game.save();
                ui.updateStats();
            },

            showBookhousePouch: function() {
                const modal = document.getElementById('modal-bookhouse-pouch');
                if (modal) modal.classList.add('open');
            },

            resolveBookhousePouch: function(choice) {
                const modal = document.getElementById('modal-bookhouse-pouch');
                if (modal) modal.classList.remove('open');
                if (gameState.bookhousePouchResolved) return;

                if (choice === 'return') {
                    game.addReputation(3, document.body);
                    ui.showFloatText(document.body, "+3 Репутации", "#34d399");
                } else {
                    gameState.emeralds += 10;
                    game.addReputation(-5, document.body);
                    ui.showFloatText(document.body, "+10 Изумрудов", "#34d399");
                }

                gameState.bookhousePouchResolved = true;
                game.save();
                ui.updateStats();
            }
        };

        // --- EQUIPMENT SYSTEM ---
        const equipment = {
            equipSword: function(swordId) {
                if (!gameState.ownedSwords || !gameState.ownedSwords.includes(swordId)) return;
                gameState.equippedSword = swordId;
                game.save();
                ui.updateStats();
                inventory.render();
                ui.showFloatText(document.body, `⚔ ${SWORDS_DB[swordId].name} экипирован!`, "#34d399");
            },
            unequipSword: function() {
                if (!gameState.equippedSword) return;
                const name = SWORDS_DB[gameState.equippedSword]?.name || 'Меч';
                gameState.equippedSword = null;
                game.save();
                ui.updateStats();
                inventory.render();
                ui.showFloatText(document.body, `${name} снят`, "#a0a0a0");
            },
            equipArmor: function(armorId) {
                if (!gameState.ownedArmor || !gameState.ownedArmor.includes(armorId)) return;
                gameState.equippedArmor = armorId;
                game.save();
                ui.updateStats();
                inventory.render();
                ui.showFloatText(document.body, `🛡 ${ARMOR_DB[armorId].name} экипирована!`, "#34d399");
            },
            unequipArmor: function() {
                if (!gameState.equippedArmor) return;
                const name = ARMOR_DB[gameState.equippedArmor]?.name || 'Броня';
                gameState.equippedArmor = null;
                game.save();
                ui.updateStats();
                inventory.render();
                ui.showFloatText(document.body, `${name} снята`, "#a0a0a0");
            },
            sellSword: function(swordId) {
                const sw = SWORDS_DB[swordId];
                if (!sw) return;
                // Can't sell equipped item
                if (gameState.equippedSword === swordId) {
                    ui.showFloatText(document.body, "Сначала снимите экипировку", "#ff5555");
                    return;
                }
                const sellGold = sw.costType === 'gold' ? Math.floor(sw.cost / 2) : 0;
                const sellEmerald = sw.costType === 'emeralds' ? Math.floor(sw.cost / 2) : 0;
                const priceText = sellGold > 0 ? `${sellGold} золота` : `${sellEmerald} изумрудов`;
                if (!confirm(`Продать ${sw.name} за ${priceText}?`)) return;
                gameState.ownedSwords = gameState.ownedSwords.filter(id => id !== swordId);
                if (sellGold > 0) gameState.gold += sellGold;
                if (sellEmerald > 0) gameState.emeralds += sellEmerald;
                game.save();
                ui.updateStats();
                inventory.render();
                ui.showFloatText(document.body, `+${priceText}`, "#fbbf24");
                itemModal.close();
            },
            sellArmor: function(armorId) {
                const ar = ARMOR_DB[armorId];
                if (!ar) return;
                if (gameState.equippedArmor === armorId) {
                    ui.showFloatText(document.body, "Сначала снимите экипировку", "#ff5555");
                    return;
                }
                const sellGold = ar.costType === 'gold' ? Math.floor(ar.cost / 2) : 0;
                const sellEmerald = ar.costType === 'emeralds' ? Math.floor(ar.cost / 2) : 0;
                const priceText = sellGold > 0 ? `${sellGold} золота` : `${sellEmerald} изумрудов`;
                if (!confirm(`Продать ${ar.name} за ${priceText}?`)) return;
                gameState.ownedArmor = gameState.ownedArmor.filter(id => id !== armorId);
                if (sellGold > 0) gameState.gold += sellGold;
                if (sellEmerald > 0) gameState.emeralds += sellEmerald;
                game.save();
                ui.updateStats();
                inventory.render();
                ui.showFloatText(document.body, `+${priceText}`, "#fbbf24");
                itemModal.close();
            },
            openSlot: function(type) {
                // Navigate to character > inventory > combat tab
                router.switchTab('character');
                ui.switchCharTab('inventory');
                inventory.switchCategory('combat');
            },
            updateUI: function() {
                // Update Sword slot display
                const swordSlot = document.getElementById('slot-sword');
                if (swordSlot) {
                    const sw = gameState.equippedSword ? SWORDS_DB[gameState.equippedSword] : null;
                    const nameEl = swordSlot.querySelector('.slot-item-name');
                    const subEl = swordSlot.querySelector('.slot-item-sub');
                    const iconEl = swordSlot.querySelector('.slot-icon-wrap');
                    if (sw) {
                        if (nameEl) nameEl.innerText = sw.name;
                        if (subEl) subEl.innerText = `Урон: ${sw.damage}`;
                        if (iconEl) {
                            iconEl.innerHTML = `<svg class="w-6 h-6" viewBox="0 0 512.001 512.001" style="fill: ${sw.color};"><use href="#icon-sword-generic"></use></svg>`;
                        }
                    } else {
                        if (nameEl) nameEl.innerText = 'Меч';
                        if (subEl) subEl.innerText = 'Не экипирован';
                        if (iconEl) {
                            iconEl.innerHTML = `<i class="fas fa-khanda text-red-400 text-xl drop-shadow-lg"></i>`;
                        }
                    }
                }
                // Update Armor slot display
                const armorSlot = document.getElementById('slot-armor');
                if (armorSlot) {
                    const ar = gameState.equippedArmor ? ARMOR_DB[gameState.equippedArmor] : null;
                    const nameEl = armorSlot.querySelector('.slot-item-name');
                    const subEl = armorSlot.querySelector('.slot-item-sub');
                    if (ar) {
                        if (nameEl) nameEl.innerText = ar.name;
                        if (subEl) subEl.innerText = `Защита: ${ar.armor}`;
                    } else {
                        if (nameEl) nameEl.innerText = 'Броня';
                        if (subEl) subEl.innerText = 'Не экипирована';
                    }
                }
            }
        };

        const itemModal = {
            currentItem: null, // Сохраняем текущий предмет для выбрасывания
            
            open: function(item) {
                const modal = document.getElementById('modal-item');
                if (!modal) return;

                // Сохраняем ссылку на текущий предмет
                this.currentItem = item;

                const iconEl = document.getElementById('item-modal-icon');
                const nameEl = document.getElementById('item-modal-name');
                const descEl = document.getElementById('item-modal-desc');
                const weightEl = document.getElementById('item-modal-weight');
                const countEl = document.getElementById('item-modal-count');
                const discardBtn = document.getElementById('btn-discard-item');
                const sellBtn = document.getElementById('btn-sell-item');
                const sellPriceSpan = document.getElementById('sell-price');
                const equipBtn = document.getElementById('btn-equip-item');
                const unequipBtn = document.getElementById('btn-unequip-item');

                iconEl.className = 'w-16 h-16 flex items-center justify-center text-[#c8aa6e] mx-auto';

                // Скрываем все кнопки
                discardBtn.style.display = 'none';
                sellBtn.style.display = 'none';
                if (equipBtn) equipBtn.style.display = 'none';
                if (unequipBtn) unequipBtn.style.display = 'none';

                if (item.kind === 'combat_sword') {
                    // Colored sword icon in modal
                    iconEl.innerHTML = `<svg class="w-10 h-10" viewBox="0 0 512.001 512.001" style="fill: ${item.color || '#c8aa6e'};"><use href="#icon-sword-generic"></use></svg>`;
                    nameEl.innerText = item.name;
                    descEl.innerText = item.desc || '—';
                    countEl.innerText = `Урон: ${item.damage}`;
                    weightEl.innerText = `${(item.weight || 2.5).toFixed(1)} кг`;

                    // Sell button
                    const sellGold = item.sellGold || 0;
                    const sellEmerald = item.sellEmerald || 0;
                    if (sellGold > 0 || sellEmerald > 0) {
                        const priceText = sellGold > 0 ? `${sellGold} <i class="fas fa-coins text-xs"></i>` : `${sellEmerald} <i class="far fa-gem text-xs text-emerald-400"></i>`;
                        sellPriceSpan.innerHTML = priceText;
                        sellBtn.style.display = 'block';
                        sellBtn.onclick = () => equipment.sellSword(item.key);
                    }

                    // Equip / Unequip
                    if (item.isEquipped) {
                        if (unequipBtn) {
                            unequipBtn.style.display = 'block';
                            unequipBtn.onclick = () => { equipment.unequipSword(); itemModal.close(); };
                        }
                    } else {
                        if (equipBtn) {
                            equipBtn.style.display = 'block';
                            equipBtn.onclick = () => { equipment.equipSword(item.key); itemModal.close(); };
                        }
                    }
                } else if (item.kind === 'combat_armor') {
                    iconEl.innerHTML = item.color
                        ? `<svg class="w-10 h-10" viewBox="0 0 512 512" style="fill: ${item.color};"><use href="#icon-armor-generic"></use></svg>`
                        : ui.getIconHtml(item.icon, 'w-10 h-10 text-blue-400');
                    nameEl.innerText = item.name;
                    descEl.innerText = item.desc || '—';
                    countEl.innerText = `Защита: ${item.armorVal}`;
                    weightEl.innerText = `${(item.weight || 4.0).toFixed(1)} кг`;

                    // Sell button
                    const sellGold = item.sellGold || 0;
                    const sellEmerald = item.sellEmerald || 0;
                    if (sellGold > 0 || sellEmerald > 0) {
                        const priceText = sellGold > 0 ? `${sellGold} <i class="fas fa-coins text-xs"></i>` : `${sellEmerald} <i class="far fa-gem text-xs text-emerald-400"></i>`;
                        sellPriceSpan.innerHTML = priceText;
                        sellBtn.style.display = 'block';
                        sellBtn.onclick = () => equipment.sellArmor(item.key);
                    }

                    // Equip / Unequip
                    if (item.isEquipped) {
                        if (unequipBtn) {
                            unequipBtn.style.display = 'block';
                            unequipBtn.onclick = () => { equipment.unequipArmor(); itemModal.close(); };
                        }
                    } else {
                        if (equipBtn) {
                            equipBtn.style.display = 'block';
                            equipBtn.onclick = () => { equipment.equipArmor(item.key); itemModal.close(); };
                        }
                    }
                } else if (item.kind === 'tool' || item.kind === 'sword' || item.kind === 'armor') {
                    iconEl.innerHTML = ui.getIconHtml(item.icon, 'w-10 h-10');
                    nameEl.innerText = item.name;
                    descEl.innerText = item.desc || '—';
                    countEl.innerText = `Уровень: ${item.level}`;
                    weightEl.innerText = `${(item.weight || 0).toFixed(1)} кг`;
                    
                    const sellPrice = Math.floor((item.buyPrice || 0) / 2);
                    if (sellPrice > 0) {
                        sellPriceSpan.innerText = sellPrice;
                        sellBtn.style.display = 'block';
                        sellBtn.onclick = () => itemModal.sellItem();
                    }
                } else if (item.kind === 'resource') {
                    iconEl.innerHTML = ui.getIconHtml(item.icon, 'w-10 h-10');
                    nameEl.innerText = item.name;
                    descEl.innerText = item.desc || '—';
                    const totalW = (item.weight || 0) * (item.count || 0);
                    countEl.innerText = `Количество: ${item.count}`;
                    weightEl.innerText = `${(item.weight || 0).toFixed(1)} кг/шт • ${(totalW).toFixed(1)} кг всего`;
                    discardBtn.style.display = 'block';
                } else {
                    iconEl.innerHTML = ui.getIconHtml(item.icon || 'fa-question', 'w-10 h-10');
                    nameEl.innerText = item.name;
                    descEl.innerText = item.desc || '—';
                    const totalW = (item.weight || 0) * (item.count || 0);
                    countEl.innerText = `Количество: ${item.count}`;
                    weightEl.innerText = `${(item.weight || 0).toFixed(1)} кг/шт • ${(totalW).toFixed(1)} кг всего`;
                    discardBtn.style.display = 'block';
                }

                modal.classList.add('open');
            },

            close: function() {
                const modal = document.getElementById('modal-item');
                if (modal) modal.classList.remove('open');
                this.currentItem = null;
            },

            discardItem: function() {
                if (!this.currentItem) return;

                const item = this.currentItem;
                
                // Подтверждение выбрасывания
                if (!confirm(`Вы уверены, что хотите выбросить ${item.name} (${item.count} шт.)?`)) {
                    return;
                }

                // Проверяем тип предмета
                if (item.kind === 'resource') {
                    // Ресурсы хранятся напрямую в gameState
                    if (gameState[item.key] !== undefined) {
                        gameState[item.key] = 0; // Обнуляем количество ресурса
                        game.save();
                        ui.updateStats();
                        inventory.render(); // Обновляем отображение инвентаря
                        
                        // Показываем уведомление
                        ui.showFloatText(document.body, `${item.name} выброшен`, "#ff5555");
                        
                        // Закрываем модальное окно
                        this.close();
                    } else {
                        ui.showFloatText(document.body, `Ресурс не найден`, "#ff5555");
                    }
                } else {
                    // Для других предметов (зелья, обереги и т.д.) ищем в inventory
                    const index = gameState.inventory.findIndex(invItem => 
                        invItem.key === item.key && invItem.kind === item.kind
                    );

                    if (index !== -1) {
                        gameState.inventory.splice(index, 1);
                        game.save();
                        ui.updateStats();
                        inventory.render(); // Обновляем отображение инвентаря
                        
                        // Показываем уведомление
                        ui.showFloatText(document.body, `${item.name} выброшен`, "#ff5555");
                        
                        // Закрываем модальное окно
                        this.close();
                    } else {
                        ui.showFloatText(document.body, `Предмет не найден в инвентаре`, "#ff5555");
                    }
                }
            },

            getDescriptionForTool: function(key) {
                const map = {
                    rod: 'Удочка нужна для работы в порту. Чем выше уровень — тем больше добыча.',
                    sickle: 'Серп нужен для работы на пшеничном поле.',
                    pickaxe: 'Кирка нужна для добычи руды в шахте. В шахте есть шанс найти изумруд.',
                    crossbow: 'Арбалет нужен для охоты и добычи кожи.',
                    sword: 'Меч нужен для опасных дел и защиты. Некоторые люди не разговаривают без оружия.'
                };
                return map[key] || 'Инструмент для приключений.';
            },

            getDescriptionForResource: function(key) {
                const map = {
                    fish: 'Рыба — еда и товар. Можно продать на рынке или использовать в заданиях.',
                    meat: 'Мясо — питательная еда. Можно продать на рынке и использовать в рецептах.',
                    mushrooms: 'Грибы — редкий ингредиент для зелий и сделок.',
                    bread: 'Хлеб — простая еда. Легко продать или хранить в дорогу.',
                    eggs: 'Яйца — еда и товар. Нужны в хозяйстве и торговле.',
                    milk: 'Молоко — еда и товар. Тяжелее других продуктов.',
                    ore: 'Руда — металл для крафта и заказов кузнеца.',
                    bronze: 'Бронза — ценный металл. Покупают и продают на рынке.',
                    silver: 'Серебро — редкий металл высокой ценности.',
                    wheat: 'Пшеница — урожай с поля. Используется в торговле и быту.',
                    wood: 'Палки — простой материал для крафта.',
                    stone: 'Камни — материал для ремесла.',
                    herbs: 'Травы — важный ингредиент для лечения и зелий.',
                    leather: 'Кожа — ценный ресурс для брони и сумок.',
                    feed: 'Корм — универсальная еда для всех животных в хозяйстве.',
                    wool: 'Шерсть — полезный материал для ремесла и торговли. Мягкая, но ценится у портных.',
                    rope: 'Верёвка — универсальный расходник. Нужна в хозяйстве, крафте и для привязи.',
                    cloth: 'Ткань — основа одежды и сумок. Хорошо продаётся на рынке.'
                };
                return map[key] || 'Ресурс.';
            },

            sellItem: function() {
                if (!this.currentItem) return;

                const item = this.currentItem;
                
                // Проверяем что это инструмент, меч или броня
                if (item.kind !== 'tool' && item.kind !== 'sword' && item.kind !== 'armor') {
                    ui.showFloatText(document.body, "Этот предмет нельзя продать", "#ff5555");
                    return;
                }

                // Вычисляем цену продажи (половина от цены покупки)
                const sellPrice = Math.floor((item.buyPrice || 0) / 2);
                
                if (sellPrice <= 0) {
                    ui.showFloatText(document.body, "Этот предмет ничего не стоит", "#ff5555");
                    return;
                }

                // Подтверждение продажи
                if (!confirm(`Продать ${item.name} за ${sellPrice} золота?`)) {
                    return;
                }

                // Находим и удаляем предмет из инвентаря
                const index = gameState.inventory.findIndex(invItem => 
                    invItem.key === item.key && invItem.kind === item.kind
                );

                if (index !== -1) {
                    gameState.inventory.splice(index, 1);
                    gameState.gold += sellPrice;
                    game.save();
                    ui.updateStats();
                    inventory.render();
                    
                    ui.showFloatText(document.body, `+${sellPrice} золота`, "#fbbf24");
                    this.close();
                } else {
                    ui.showFloatText(document.body, "Предмет не найден", "#ff5555");
                }
            }
        };

        // --- ROUTER ---
        const router = {
            currentTab: 'map',
            switchTab: function(tabId) {
                this.currentTab = tabId;
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const activeNav = document.getElementById(`nav-${tabId}`);
                if(activeNav) activeNav.classList.add('active');
                document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                const view = document.getElementById(`view-${tabId}`);
                if(view) view.classList.remove('hidden');
                if (tabId === 'map') {
                    document.getElementById('view-jobs').classList.add('hidden');
                    document.getElementById('view-town-square').classList.add('hidden');
                    document.getElementById('view-tavern').classList.add('hidden');
                    document.getElementById('view-treasury').classList.add('hidden');
                    document.getElementById('view-dark-forest').classList.add('hidden');
                    document.getElementById('view-map').classList.remove('hidden');
                }
                if (tabId === 'market') {
                    market.switchCategory('tools');
                    market.buildTradeCategories();
                    ui.updateAll();
                }
                if (tabId === 'character') {
                    if (crafting.mode === 'inventory') inventory.render();
                }
                if (tabId === 'quests') {
                    quests.render();
                }
            },
            navigate: function(screenId) {
                // Track action for hunger system (only for location changes, not UI tabs)
                const locationScreens = ['jobs', 'town-square', 'tavern', 'treasury', 'dark-forest', 
                    'hunter-hut', 'training-camp', 'military-fortress', 'village', 'healer', 'bookhouse', 
                    'royal-castle', 'poor-district', 'noble-quarter', 'refugee-camp', 
                    'tailor', 'shoemaker', 'livestock-trader', 'bulletin', 'lily-house'];
                
                if (locationScreens.includes(screenId)) {
                    game.trackAction();
                }
                
                document.getElementById('view-map').classList.add('hidden');
                document.getElementById('view-jobs').classList.add('hidden');
                document.getElementById('view-town-square').classList.add('hidden');
                document.getElementById('view-tavern').classList.add('hidden');
                const tavernChest = document.getElementById('view-tavern-chest');
                if (tavernChest) tavernChest.classList.add('hidden');
                document.getElementById('view-treasury').classList.add('hidden');
                document.getElementById('view-dark-forest').classList.add('hidden');
                const hunterHutView = document.getElementById('view-hunter-hut');
                if (hunterHutView) hunterHutView.classList.add('hidden');
                const trainingCamp = document.getElementById('view-training-camp');
                if (trainingCamp) trainingCamp.classList.add('hidden');
                const fortressView = document.getElementById('view-military-fortress');
                if (fortressView) fortressView.classList.add('hidden');
                const villageView = document.getElementById('view-village');
                if (villageView) villageView.classList.add('hidden');
                const healerView = document.getElementById('view-healer');
                if (healerView) healerView.classList.add('hidden');
                const bookHouseView = document.getElementById('view-bookhouse');
                if (bookHouseView) bookHouseView.classList.add('hidden');
                const bulletinView = document.getElementById('view-bulletin');
                if (bulletinView) bulletinView.classList.add('hidden');
                const castleView = document.getElementById('view-royal-castle');
                if (castleView) castleView.classList.add('hidden');
                const poorView = document.getElementById('view-poor-district');
                if (poorView) poorView.classList.add('hidden');
                const nobleView = document.getElementById('view-noble-quarter');
                if (nobleView) nobleView.classList.add('hidden');
                const refugeeView = document.getElementById('view-refugee-camp');
                if (refugeeView) refugeeView.classList.add('hidden');
                const tailorView = document.getElementById('view-tailor');
                if (tailorView) tailorView.classList.add('hidden');
                const shoemakerView = document.getElementById('view-shoemaker');
                if (shoemakerView) shoemakerView.classList.add('hidden');
                const livestockView = document.getElementById('view-livestock-trader');
                if (livestockView) livestockView.classList.add('hidden');
                const lilyHouseView = document.getElementById('view-lily-house');
                if (lilyHouseView) lilyHouseView.classList.add('hidden');
                
                const target = document.getElementById(`view-${screenId}`);
                if (target) target.classList.remove('hidden');
                if(screenId === 'jobs') ui.updateJobs();
                if(screenId === 'market' || screenId === 'treasury' || screenId === 'healer' || screenId === 'bookhouse') {
                    ui.updateAll();
                    if (screenId === 'market') {
                        market.switchTradeMode(market.tradeMode || 'sell');
                    }
                }
                if (screenId === 'livestock-trader') {
                    ui.updateAll();
                }
                if(screenId === 'poor-district' || screenId === 'noble-quarter') housing.updateUI();
                if (screenId === 'poor-district') {
                    poorDistrict.updateUI();
                    poorDistrict.startCanteenTimer();
                    arthurShop.updateHerbQuestUI();
                    arthurShop.startEffectTimers();
                }
                if (screenId === 'noble-quarter') {
                    if (!gameState.clothes || !gameState.clothes.peasant) {
                        dialogue.start('noble_guard');
                        router.navigate('map');
                        ui.showFloatText(document.body, "Нужна одежда крестьянина", "#fbbf24");
                        return;
                    }
                    const lilyWrap = document.getElementById('lily-house-btn-wrap');
                    if (lilyWrap) {
                        lilyWrap.style.display = (gameState.npcStates && gameState.npcStates.lili_invited) ? 'block' : 'none';
                    }
                    quests.onEvent('visit', 'noble-quarter', 1);
                    // Trigger quest completion if active
                    quests.onEvent('visit', 'noble-quarter', 1);
                }
                if(screenId === 'village') {
                    village.updateUI();
                    livestockFarm.updateButtonUI();
                    
                    if (!gameState.npcStates) gameState.npcStates = {};
                    if (!gameState.npcStates.villageBanditsDone && Math.random() < 0.35) {
                        gameState.npcStates.villageBanditsTriggered = true;
                        setTimeout(() => {
                            dialogue.start('bandits_village');
                        }, 400);
                    }
                }

                if (screenId === 'livestock-farm') {
                    livestockFarm.updateUI();
                    livestockFarm.startTimers();
                }

                if (screenId === 'treasury') {
                    // Check if amulet was found and show option to return it
                    if (gameState.npcStates && gameState.npcStates.hankAmuletFound && 
                        !gameState.npcStates.hankAmuletComplete) {
                        const questStatus = document.getElementById('hank-quest-status');
                        const questText = document.getElementById('hank-quest-text');
                        if (questStatus && questText) {
                            questStatus.classList.remove('hidden');
                            questText.textContent = 'У вас есть амулет! Поговорите с Хэнком.';
                            questText.className = 'text-xs text-green-400';
                        }
                    }
                    ui.maybeTriggerTreasuryPouch();
                }
                if (screenId === 'bookhouse') {
                    ui.maybeTriggerBookhousePouch();
                }

                if (screenId === 'tavern') {
                    locations.updateTavernUI();
                }
                if (screenId === 'tavern-chest') {
                    locations.renderChest();
                }

                // Random Location Quests
                if (screenId === 'tavern' || screenId === 'poor-district') {
                    quests.tryGenerateLocationQuest(screenId);
                }
            }
        };
        
        // Developer Panel System
        const devPanel = {
            clickCount: 0,
            clickTimer: null,
            currentPlayerId: null,
            allPlayers: {},
            firebaseEnabled: (typeof db !== 'undefined'),
            
            init: function() {
                // This will be called when DOM is ready
            },
            
            handleSecretClick: function() {
                this.clickCount++;
                
                if (this.clickTimer) {
                    clearTimeout(this.clickTimer);
                }
                
                // Reset count after 2 seconds of inactivity
                this.clickTimer = setTimeout(() => {
                    this.clickCount = 0;
                }, 2000);
                
                // Open panel after 10 clicks
                if (this.clickCount >= 10) {
                    this.clickCount = 0;
                    this.open();
                }
            },
            
            open: function() {
                document.getElementById('dev-panel').classList.add('open');
                this.loadAllPlayers();
            },
            
            close: function() {
                document.getElementById('dev-panel').classList.remove('open');
                document.getElementById('dev-player-details').classList.add('hidden');
                document.getElementById('dev-search').value = '';
                this.currentPlayerId = null;
            },
            
            loadAllPlayers: async function() {
                try {
                    this.allPlayers = {};
                    // Load from Firebase if available
                    if (this.firebaseEnabled) {
                        try {
                            const snap = await db.collection('players').get();
                            snap.forEach(doc => {
                                const data = doc.data() || {};
                                const playerId = data.telegramId || data.id || doc.id;
                                this.allPlayers[playerId] = {
                                    ...data,
                                    telegramId: playerId,
                                    _docId: doc.id,
                                    username: data.telegramUsername || data.playerName || data.username || 'Игрок',
                                    gems: data.gems !== undefined ? data.gems : (data.emeralds !== undefined ? data.emeralds : (data.emerald || 0)),
                                    lastPlayed: data.lastSeen || data.lastPlayed || 0
                                };
                            });
                        } catch (e) {
                            console.error('Firebase load error:', e);
                        }
                    }
                    
                    // Check if there's a current game save
                    const currentSave = localStorage.getItem('medieval_rpg_save_v5');
                    if (currentSave) {
                        try {
                            const gameData = JSON.parse(currentSave);
                            // Get player ID from Telegram or generate one
                            let playerId = 'current_player';
                            if (window.Telegram && window.Telegram.WebApp && 
                                window.Telegram.WebApp.initDataUnsafe && 
                                window.Telegram.WebApp.initDataUnsafe.user) {
                                playerId = window.Telegram.WebApp.initDataUnsafe.user.id.toString();
                                gameData.username = window.Telegram.WebApp.initDataUnsafe.user.username || 
                                                   window.Telegram.WebApp.initDataUnsafe.user.first_name || 
                                                   'Игрок';
                            }
                            gameData.telegramId = playerId;
                            gameData.lastPlayed = Date.now();
                            this.allPlayers[playerId] = gameData;
                        } catch (e) {
                            console.error('Error parsing current save:', e);
                        }
                    }
                    
                    // Also scan for any player_* keys (legacy or multi-user support)
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('player_')) {
                            try {
                                const playerId = key.replace('player_', '');
                                const data = localStorage.getItem(key);
                                if (data) {
                                    const playerData = JSON.parse(data);
                                    playerData.telegramId = playerId;
                                    this.allPlayers[playerId] = playerData;
                                }
                            } catch (e) {
                                console.error('Error parsing player data:', key, e);
                            }
                        }
                    }
                    
                    if (window.UsersStore) {
                        try {
                            UsersStore.init();
                            const users = UsersStore.listUsers();
                            users.forEach(u => {
                                this.allPlayers[u.telegramId] = u;
                            });
                        } catch (e) {
                            console.error('UsersStore load error', e);
                        }
                    }
                    
                    const players = Object.values(this.allPlayers);
                    
                    if (players.length === 0) {
                        document.getElementById('dev-players-list').innerHTML = `
                            <div class="text-center text-gray-500 py-4">
                                <i class="fas fa-users text-3xl mb-2 opacity-30"></i>
                                <div>Нет сохраненных игроков</div>
                                <div class="text-xs mt-2 text-gray-600">Начните игру, чтобы увидеть данные</div>
                            </div>
                        `;
                    } else {
                        this.renderPlayersList(players);
                    }
                    
                    this.updateStats(players);
                } catch (error) {
                    console.error('Error loading players:', error);
                    document.getElementById('dev-players-list').innerHTML = `
                        <div class="text-center text-red-500 py-4">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <div>Ошибка загрузки данных</div>
                            <div class="text-xs mt-2">${error.message}</div>
                        </div>
                    `;
                }
            },
            
            updateStats: function(players) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayTimestamp = today.getTime();
                
                const playersToday = players.filter(p => {
                    if (!p.lastPlayed) return false;
                    return p.lastPlayed >= todayTimestamp;
                });
                
                const statsHtml = `
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="panel p-3 rounded text-center border border-purple-600/50">
                            <div class="text-2xl font-bold text-purple-400">${players.length}</div>
                            <div class="text-[10px] text-gray-500 uppercase">Всего игроков</div>
                        </div>
                        <div class="panel p-3 rounded text-center border border-green-600/50">
                            <div class="text-2xl font-bold text-green-400">${playersToday.length}</div>
                            <div class="text-[10px] text-gray-500 uppercase">Заходили сегодня</div>
                        </div>
                    </div>
                `;
                
                const searchDiv = document.getElementById('dev-search').parentElement;
                let statsDiv = document.getElementById('dev-stats');
                if (!statsDiv) {
                    statsDiv = document.createElement('div');
                    statsDiv.id = 'dev-stats';
                    searchDiv.parentElement.insertBefore(statsDiv, searchDiv);
                }
                statsDiv.innerHTML = statsHtml;
            },
            
            renderPlayersList: function(players) {
                const container = document.getElementById('dev-players-list');
                
                if (players.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-4">
                            <i class="fas fa-search text-3xl mb-2 opacity-30"></i>
                            <div>Игроки не найдены</div>
                        </div>
                    `;
                    return;
                }
                
                // Sort by last played
                players.sort((a, b) => (b.lastPlayed || 0) - (a.lastPlayed || 0));
                
                container.innerHTML = players.map(p => {
                    const lastPlayedText = p.lastPlayed 
                        ? new Date(p.lastPlayed).toLocaleString('ru-RU', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                          })
                        : 'неизвестно';
                    
                    return `
                        <div class="dev-player-card" onclick="devPanel.selectPlayer('${p.telegramId}')">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="font-bold" style="color: #c8aa6e;">
                                        <i class="fas fa-user mr-1"></i>
                                        ${p.username ? '@' + p.username : 'Аноним'}
                                    </div>
                                    <div class="text-xs text-gray-500">ID: ${p.telegramId}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm">⚔️ Ур. ${p.level || 1}</div>
                                    <div class="text-xs text-gray-500">💰 ${p.gold || 0} | 💎 ${p.gems || 0}</div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-600">
                                <i class="fas fa-clock mr-1"></i>
                                ${lastPlayedText}
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            search: function(query) {
                if (!query || query.trim() === '') {
                    const players = Object.values(this.allPlayers);
                    this.renderPlayersList(players);
                    return;
                }
                
                const searchTerm = query.toLowerCase().trim();
                
                const players = Object.values(this.allPlayers).filter(p => {
                    const matchesId = p.telegramId && p.telegramId.toString().includes(searchTerm);
                    const matchesUsername = p.username && p.username.toLowerCase().includes(searchTerm);
                    return matchesId || matchesUsername;
                });
                
                this.renderPlayersList(players);
            },
            
            selectPlayer: function(playerId) {
                try {
                    const playerData = this.allPlayers[playerId];
                    if (!playerData) {
                        alert('Не удалось загрузить данные игрока');
                        return;
                    }
                    
                    this.currentPlayerId = playerId;
                    
                    // Fill form
                    document.getElementById('dev-edit-id').value = playerData.telegramId || '';
                    document.getElementById('dev-edit-username').value = playerData.username || '';
                    document.getElementById('dev-edit-gold').value = playerData.gold || 0;
                    document.getElementById('dev-edit-gems').value = playerData.gems || playerData.emeralds || 0;
                    document.getElementById('dev-edit-level').value = playerData.level || 1;
                    document.getElementById('dev-edit-xp').value = playerData.xp || 0;
                    document.getElementById('dev-edit-hp').value = playerData.hp || 100;
                    document.getElementById('dev-edit-hunger').value = playerData.hunger || 100;
                    
                    // Show details section
                    document.getElementById('dev-player-details').classList.remove('hidden');
                    
                    // Scroll to details
                    setTimeout(() => {
                        document.getElementById('dev-player-details').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 100);
                } catch (error) {
                    console.error('Error selecting player:', error);
                    alert('Ошибка при загрузке игрока: ' + error.message);
                }
            },
            
            savePlayer: async function(evt) {
                if (!this.currentPlayerId) return;
                
                try {
                    const playerData = this.allPlayers[this.currentPlayerId];
                    if (!playerData) {
                        alert('Не удалось загрузить данные игрока');
                        return;
                    }
                    
                    // Update values
                    playerData.gold = parseInt(document.getElementById('dev-edit-gold').value) || 0;
                    playerData.gems = parseInt(document.getElementById('dev-edit-gems').value) || 0;
                    playerData.emeralds = playerData.gems;
                    playerData.level = parseInt(document.getElementById('dev-edit-level').value) || 1;
                    playerData.xp = parseInt(document.getElementById('dev-edit-xp').value) || 0;
                    playerData.hp = parseInt(document.getElementById('dev-edit-hp').value) || 100;
                    playerData.hunger = parseInt(document.getElementById('dev-edit-hunger').value) || 100;
                    
                    // Save to localStorage
                    if (this.currentPlayerId === 'current_player' || 
                        localStorage.getItem('medieval_rpg_save_v5')) {
                        // This is the current game save
                        localStorage.setItem('medieval_rpg_save_v5', JSON.stringify(playerData));
                    } else {
                        // This is a separate player save
                        localStorage.setItem(`player_${this.currentPlayerId}`, JSON.stringify(playerData));
                    }
                    
                    // Save to Firebase if available
                    if (this.firebaseEnabled && playerData._docId) {
                        try {
                            await db.collection('players').doc(playerData._docId).update({
                                gold: playerData.gold,
                                gems: playerData.gems,
                                emeralds: playerData.emeralds,
                                level: playerData.level,
                                xp: playerData.xp,
                                hp: playerData.hp,
                                hunger: playerData.hunger,
                                lastSeen: Date.now()
                            });
                        } catch (e) {
                            console.error('Firebase update error:', e);
                            alert('⚠️ Не удалось сохранить в Firebase: ' + e.message);
                        }
                    }
                    
                    // Update in memory
                    this.allPlayers[this.currentPlayerId] = playerData;
                    
                    if (window.UsersStore) {
                        try {
                            UsersStore.saveUser(this.currentPlayerId, playerData);
                        } catch (e) {
                            console.error('UsersStore save error', e);
                        }
                    }
                    
                    // Show success message
                    const btn = (evt && evt.target) || document.getElementById('dev-btn-save');
                    const originalText = btn.textContent;
                    btn.textContent = '✅ Сохранено!';
                    btn.style.background = 'linear-gradient(to bottom, #10b981, #059669)';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                    
                    // Refresh list
                    this.loadAllPlayers();
                    
                    // If this is current player, offer to reload
                    if (this.currentPlayerId === 'current_player' || 
                        (window.Telegram && window.Telegram.WebApp && 
                        window.Telegram.WebApp.initDataUnsafe && 
                        window.Telegram.WebApp.initDataUnsafe.user &&
                        window.Telegram.WebApp.initDataUnsafe.user.id == this.currentPlayerId)) {
                        
                        if (confirm('Это текущий игрок. Перезагрузить игру для применения изменений?')) {
                            location.reload();
                        }
                    }
                } catch (error) {
                    console.error('Error saving player:', error);
                    alert('❌ Ошибка при сохранении: ' + error.message);
                }
            },
            
            deletePlayer: async function(evt) {
                if (!this.currentPlayerId) return;
                
                const playerData = this.allPlayers[this.currentPlayerId];
                const username = playerData?.username || 'этого игрока';
                
                if (!confirm(`Вы уверены, что хотите удалить ${username} (ID: ${this.currentPlayerId})?\n\nЭто действие необратимо!`)) {
                    return;
                }
                
                try {
                    if (this.currentPlayerId === 'current_player' || 
                        localStorage.getItem('medieval_rpg_save_v5')) {
                        localStorage.removeItem('medieval_rpg_save_v5');
                    } else {
                        localStorage.removeItem(`player_${this.currentPlayerId}`);
                    }
                    delete this.allPlayers[this.currentPlayerId];
                    
                    // Delete from Firebase if available
                    if (this.firebaseEnabled && playerData && playerData._docId) {
                        try {
                            await db.collection('players').doc(playerData._docId).delete();
                        } catch (e) {
                            console.error('Firebase delete error', e);
                            alert('⚠️ Не удалось удалить в Firebase: ' + e.message);
                        }
                    }
                    
                    if (window.UsersStore) {
                        try {
                            UsersStore.deleteUser(this.currentPlayerId);
                        } catch (e) {
                            console.error('UsersStore delete error', e);
                        }
                    }
                    
                    // Show success message
                    const btn = (evt && evt.target) || document.getElementById('dev-btn-delete');
                    const originalText = btn.textContent;
                    btn.textContent = '🗑️ Удалено!';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        this.currentPlayerId = null;
                        document.getElementById('dev-player-details').classList.add('hidden');
                        this.loadAllPlayers();
                    }, 1500);
                } catch (error) {
                    console.error('Error deleting player:', error);
                    alert('❌ Ошибка при удалении: ' + error.message);
                }
            }
        };
        
        // --- CHANNEL SUBSCRIPTION TASK ---
        const channelTask = {
            CHANNEL_URL: 'https://t.me/MedievalLegacy',
            CLOUD_FUNCTION_URL: 'https://mlgame-tg.netlify.app/.netlify/functions/check-subscription',
            
            init: function() {
                this.updateUI();
            },
            
            updateUI: function() {
                const taskCard = document.getElementById('task-channel-sub');
                const subscribeBtn = document.getElementById('btn-subscribe-channel');
                const checkBtn = document.getElementById('btn-check-subscription');
                const completedMsg = document.getElementById('task-completed-message');
                const statusIcon = document.getElementById('task-status-icon');
                const buttonsContainer = document.getElementById('task-buttons-container');
                
                if (!taskCard) return;
                
                if (gameState.channelTaskCompleted) {
                    // Task completed
                    buttonsContainer.classList.add('hidden');
                    completedMsg.classList.remove('hidden');
                    statusIcon.innerHTML = '<i class="fas fa-check-circle text-emerald-400"></i>';
                    taskCard.style.opacity = '0.7';
                } else {
                    // Task not completed
                    completedMsg.classList.add('hidden');
                    buttonsContainer.classList.remove('hidden');
                    statusIcon.innerHTML = '';
                    taskCard.style.opacity = '1';
                }
            },
            
            openChannel: function() {
                console.log('Открытие канала:', this.CHANNEL_URL);
                
                // Open channel in Telegram
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.openTelegramLink(this.CHANNEL_URL);
                } else {
                    window.open(this.CHANNEL_URL, '_blank');
                }
                
                // Показываем кнопку проверки через 1 секунду
                setTimeout(() => {
                    const checkBtn = document.getElementById('btn-check-subscription');
                    if (checkBtn && !gameState.channelTaskCompleted) {
                        checkBtn.classList.remove('hidden');
                        console.log('✅ Кнопка "Проверить подписку" показана');
                    }
                }, 1000);
            },
            
            checkSubscription: async function() {
                console.log('=== START CHECK SUBSCRIPTION ===');
                
                // Проверяем, не выполнено ли уже задание
                if (gameState.channelTaskCompleted) {
                    alert('Вы уже выполнили это задание!');
                    return;
                }
                
                const checkBtn = document.getElementById('btn-check-channel');
                if (!checkBtn) {
                    console.error('❌ Кнопка не найдена!');
                    return;
                }
                
                console.log('✅ Кнопка найдена');
                
                // Блокируем кнопку и показываем загрузку
                checkBtn.disabled = true;
                const originalText = checkBtn.innerHTML;
                checkBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Проверка...';
                console.log('✅ Кнопка обновлена');
                
                try {
                    // Получаем ID пользователя
                    let userId = null;
                    let username = null;
                    
                    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
                        const user = window.Telegram.WebApp.initDataUnsafe.user;
                        if (user) {
                            userId = user.id;
                            username = user.username || null;
                        }
                    }
                    
                    console.log('👤 User ID:', userId);
                    console.log('👤 Username:', username);
                    
                    if (!userId) {
                        throw new Error('Не удалось получить ID пользователя из Telegram');
                    }
                    
                    console.log('🌐 URL:', this.CLOUD_FUNCTION_URL);
                    console.log('📤 Отправка запроса...');
                    
                    // Отправляем запрос
                    const response = await fetch(this.CLOUD_FUNCTION_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userId: userId,
                            username: username
                        })
                    });
                    
                    console.log('📥 Получен ответ. Статус:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('❌ Ошибка сервера:', errorText);
                        throw new Error('Сервер вернул ошибку: ' + response.status);
                    }
                    
                    const data = await response.json();
                    console.log('📦 Данные ответа:', data);
                    
                    if (data.subscribed === true) {
                        console.log('🎉 Пользователь подписан!');
                        
                        // Выдаем награду
                        gameState.channelTaskCompleted = true;
                        gameState.channelSubscribed = true;
                        gameState.emeralds += 10;
                        
                        console.log('💎 Изумруды добавлены. Новое количество:', gameState.emeralds);
                        
                        // Сохраняем
                        game.save();
                        console.log('💾 Игра сохранена');
                        
                        // Обновляем верхнюю панель с изумрудами
                        ui.update();
                        console.log('🎨 UI верхней панели обновлен');
                        
                        // Перерисовываем список заданий
                        if (typeof quests !== 'undefined' && quests.render) {
                            quests.render();
                            console.log('📋 Список заданий обновлен');
                        }
                        
                        // Показываем уведомление
                        setTimeout(() => {
                            alert('✅ Поздравляем! Вы получили 10 изумрудов!');
                        }, 100);
                        
                        console.log('=== ЗАДАНИЕ ВЫПОЛНЕНО ===');
                        
                    } else {
                        console.log('❌ Пользователь НЕ подписан');
                        alert('❌ Вы не подписаны на канал. Пожалуйста, подпишитесь и попробуйте снова.');
                        
                        // Разблокируем кнопку
                        checkBtn.disabled = false;
                        checkBtn.innerHTML = originalText;
                    }
                    
                } catch (error) {
                    console.error('💥 ОШИБКА:', error);
                    console.error('Тип ошибки:', error.name);
                    console.error('Сообщение:', error.message);
                    
                    alert('Ошибка: ' + error.message);
                    
                    // Разблокируем кнопку
                    checkBtn.disabled = false;
                    checkBtn.innerHTML = originalText;
                }
                
                console.log('=== END CHECK SUBSCRIPTION ===');
            },
            
            completeTask: function() {
                // Проверка, не выполнено ли уже
                if (gameState.channelTaskCompleted) {
                    return;
                }
                
                // Mark task as completed
                gameState.channelTaskCompleted = true;
                gameState.channelSubscribed = true;
                
                // Give reward
                gameState.emeralds += 10;
                
                // Save game
                game.save();
                
                // Update UI
                ui.update();
                
                // Обновить список заданий, чтобы показать выполненное задание
                if (typeof quests !== 'undefined' && quests.render) {
                    quests.render();
                }
                
                // Show success notification
                ui.showNotification('✅ Задание выполнено! Вы получили 10 изумрудов!', 'success');
                
                // Show floating text
                const taskCard = document.getElementById('task-channel-sub');
                if (taskCard) {
                    ui.floatText('+10', taskCard, 'gem-price');
                }
            },
            
            showError: function(message) {
                ui.showNotification(message, 'error');
            }
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const startApp = async () => {
                const HERO_HEADER_IMAGES = {
                    'jobs': 'https://i.postimg.cc/zvrrJHQg/IMG-4559.jpg',
                    'town-square': 'https://i.postimg.cc/BnPztnfV/IMG-4542.jpg',
                    'tavern': 'https://i.postimg.cc/kGckq181/IMG-4560.jpg',
                    'treasury': 'https://i.postimg.cc/hvS5yLws/IMG-4561.jpg',
                    'village': 'https://i.postimg.cc/P5BFss9w/IMG-4562.jpg',
                    'dark-forest': 'https://i.postimg.cc/kGXTFn6F/IMG-4563.jpg',
                    'hunter-hut': 'https://i.postimg.cc/kGXTFn6F/IMG-4563.jpg',
                    'healer': 'https://i.postimg.cc/rpXgZGRd/IMG-4564.jpg',
                    'noble-quarter': 'https://i.postimg.cc/hv51LVqc/IMG-4565.jpg',
                    'poor-district': 'https://i.postimg.cc/B6hT32bL/IMG-4566.jpg',
                    'royal-castle': 'https://i.postimg.cc/JnqyJXkK/IMG-4567.jpg',
                    'refugee-camp': 'https://i.postimg.cc/d3CV6T7L/IMG-4568.jpg',
                    'livestock-trader': 'https://i.postimg.cc/zvw13wHX/IMG-4569.jpg',
                    'training-camp': 'https://i.postimg.cc/C1D36CNf/IMG-4570.jpg',
                    'military-fortress': 'https://i.postimg.cc/Ss0582pT/IMG-4571.jpg',
                    'knight-tournament': 'https://i.postimg.cc/s2cXkKrW/IMG-4610.jpg'
                };
                const applyHeroHeaderImages = () => {
                    Object.entries(HERO_HEADER_IMAGES).forEach(([screenId, url]) => {
                        const sections = document.querySelectorAll(`#view-${screenId}`);
                        sections.forEach(section => {
                            const header = section.firstElementChild;
                            if (!header || !(header instanceof HTMLElement)) return;
                            header.classList.add('loc-hero');
                            header.style.setProperty('--hero-img', `url('${url}')`);
                        });
                    });
                };
                applyHeroHeaderImages();
                const originalSwitchTab = router.switchTab;
                router.switchTab = function(tabId) {
                    originalSwitchTab.call(router, tabId);
                    if (tabId === 'map') {
                        ui.updateLocations();
                    }
                };
                const originalLevelUp = game.levelUp;
                game.levelUp = function() {
                    originalLevelUp.call(game);
                    ui.updateLocations();
                };
                await game.init();
                router.switchTab('map');
                disease.startTick();
                refugeeCamp.updateCooldownUI();
                channelTask.init(); // Initialize channel subscription task
                
                // Добавляем обработчик для кнопки "Выбросить"
                const discardBtn = document.getElementById('btn-discard-item');
                if (discardBtn) {
                    discardBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        itemModal.discardItem();
                    });
                }
                
                // Sell button onclick is set dynamically in itemModal.open per item type
                
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        game.checkUnconscious();
                        ui.updateUnconsciousUI();
                    }
                });
                setInterval(() => {
                    game.checkUnconscious();
                    if (gameState.unconsciousUntil && gameState.unconsciousUntil > Date.now()) {
                        ui.updateTimerVisuals();
                    } else if (document.getElementById('modal-unconscious').classList.contains('open') && (!gameState.unconsciousUntil || gameState.unconsciousUntil <= Date.now())) {
                        ui.updateUnconsciousUI();
                    }
                }, 1000);
            };
            const loadingEl = document.getElementById('loading-screen');
            const barEl = document.getElementById('loading-bar-fill');
            if (loadingEl && barEl) {
                loadingEl.style.opacity = '1';
                loadingEl.style.transition = 'opacity 400ms';
                let p = 0;
                const appPromise = startApp();
                const timer = setInterval(() => {
                    p = Math.min(90, p + 3 + Math.random() * 6);
                    barEl.style.width = p + '%';
                }, 160);
                appPromise.then(() => {
                    clearInterval(timer);
                    barEl.style.width = '100%';
                    setTimeout(() => {
                        loadingEl.style.opacity = '0';
                        setTimeout(() => {
                            loadingEl.style.display = 'none';
                        }, 420);
                    }, 200);
                }).catch(() => {
                    clearInterval(timer);
                    loadingEl.style.opacity = '0';
                    setTimeout(() => {
                        loadingEl.style.display = 'none';
                    }, 420);
                });
            } else {
                startApp();
            }
        });

    </script>
</body>
</html>
